// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the Microsoft Software License Terms for the Azure Communications Services, Azure CPaaS, AZURE COMMUNICATION SERVICES VOICE AND VIDEO CALLING CLIENT LIBRARY
// See LICENSE file for license information.
!function(g,m){"object"==typeof exports&&"undefined"!=typeof module?m(exports,require("@azure/logger"),require("@azure/communication-common")):"function"==typeof define&&define.amd?define(["exports","@azure/logger","@azure/communication-common"],m):m((g="undefined"!=typeof globalThis?globalThis:g||self)["azure-communication-calling"]={},g.logger,g.communicationCommon)}(this,(function(g,m,S){"use strict";var v,C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(g){return g&&g.__esModule&&Object.prototype.hasOwnProperty.call(g,"default")?g.default:g}function createCommonjsModule(g,m,S){return g(S={path:m,exports:{},require:function(g,m){return commonjsRequire(g,null==m?S.path:m)}},S.exports),S.exports}function getAugmentedNamespace(g){if(g.__esModule)return g;var m=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(g).forEach((function(S){var v=Object.getOwnPropertyDescriptor(g,S);Object.defineProperty(m,S,v.get?v:{enumerable:!0,get:function(){return g[S]}})})),m}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}
/*! *****************************************************************************
	Copyright (C) Microsoft. All rights reserved.
	Licensed under the Apache License, Version 2.0 (the "License"); you may not use
	this file except in compliance with the License. You may obtain a copy of the
	License at http://www.apache.org/licenses/LICENSE-2.0

	THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
	KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
	WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
	MERCHANTABLITY OR NON-INFRINGEMENT.

	See the Apache Version 2.0 License for specific language governing permissions
	and limitations under the License.
	***************************************************************************** */!function(g){!function(m){var S="object"==typeof C?C:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),v=makeExporter(g);function makeExporter(g,m){return function(S,v){"function"!=typeof g[S]&&Object.defineProperty(g,S,{configurable:!0,writable:!0,value:v}),m&&m(S,v)}}void 0===S.Reflect?S.Reflect=g:v=makeExporter(S.Reflect,v),m(v)}((function(g){var m=Object.prototype.hasOwnProperty,S="function"==typeof Symbol,v=S&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",C=S&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",_="function"==typeof Object.create,E={__proto__:[]}instanceof Array,T=!_&&!E,I={create:_?function(){return MakeDictionary(Object.create(null))}:E?function(){return MakeDictionary({__proto__:null})}:function(){return MakeDictionary({})},has:T?function(g,S){return m.call(g,S)}:function(g,m){return m in g},get:T?function(g,S){return m.call(g,S)?g[S]:void 0}:function(g,m){return g[m]}},b=Object.getPrototypeOf(Function),A="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,R=A||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?CreateMapPolyfill():Map,P=A||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?CreateSetPolyfill():Set,M=new(A||"function"!=typeof WeakMap?CreateWeakMapPolyfill():WeakMap);function decorate(g,m,S,v){if(IsUndefined(S)){if(!IsArray(g))throw new TypeError;if(!IsConstructor(m))throw new TypeError;return DecorateConstructor(g,m)}if(!IsArray(g))throw new TypeError;if(!IsObject(m))throw new TypeError;if(!IsObject(v)&&!IsUndefined(v)&&!IsNull(v))throw new TypeError;return IsNull(v)&&(v=void 0),DecorateProperty(g,m,S=ToPropertyKey(S),v)}function metadata(g,m){function decorator(S,v){if(!IsObject(S))throw new TypeError;if(!IsUndefined(v)&&!IsPropertyKey(v))throw new TypeError;OrdinaryDefineOwnMetadata(g,m,S,v)}return decorator}function defineMetadata(g,m,S,v){if(!IsObject(S))throw new TypeError;return IsUndefined(v)||(v=ToPropertyKey(v)),OrdinaryDefineOwnMetadata(g,m,S,v)}function hasMetadata(g,m,S){if(!IsObject(m))throw new TypeError;return IsUndefined(S)||(S=ToPropertyKey(S)),OrdinaryHasMetadata(g,m,S)}function hasOwnMetadata(g,m,S){if(!IsObject(m))throw new TypeError;return IsUndefined(S)||(S=ToPropertyKey(S)),OrdinaryHasOwnMetadata(g,m,S)}function getMetadata(g,m,S){if(!IsObject(m))throw new TypeError;return IsUndefined(S)||(S=ToPropertyKey(S)),OrdinaryGetMetadata(g,m,S)}function getOwnMetadata(g,m,S){if(!IsObject(m))throw new TypeError;return IsUndefined(S)||(S=ToPropertyKey(S)),OrdinaryGetOwnMetadata(g,m,S)}function getMetadataKeys(g,m){if(!IsObject(g))throw new TypeError;return IsUndefined(m)||(m=ToPropertyKey(m)),OrdinaryMetadataKeys(g,m)}function getOwnMetadataKeys(g,m){if(!IsObject(g))throw new TypeError;return IsUndefined(m)||(m=ToPropertyKey(m)),OrdinaryOwnMetadataKeys(g,m)}function deleteMetadata(g,m,S){if(!IsObject(m))throw new TypeError;IsUndefined(S)||(S=ToPropertyKey(S));var v=GetOrCreateMetadataMap(m,S,!1);if(IsUndefined(v))return!1;if(!v.delete(g))return!1;if(v.size>0)return!0;var C=M.get(m);return C.delete(S),C.size>0||M.delete(m),!0}function DecorateConstructor(g,m){for(var S=g.length-1;S>=0;--S){var v=(0,g[S])(m);if(!IsUndefined(v)&&!IsNull(v)){if(!IsConstructor(v))throw new TypeError;m=v}}return m}function DecorateProperty(g,m,S,v){for(var C=g.length-1;C>=0;--C){var _=(0,g[C])(m,S,v);if(!IsUndefined(_)&&!IsNull(_)){if(!IsObject(_))throw new TypeError;v=_}}return v}function GetOrCreateMetadataMap(g,m,S){var v=M.get(g);if(IsUndefined(v)){if(!S)return;v=new R,M.set(g,v)}var C=v.get(m);if(IsUndefined(C)){if(!S)return;C=new R,v.set(m,C)}return C}function OrdinaryHasMetadata(g,m,S){if(OrdinaryHasOwnMetadata(g,m,S))return!0;var v=OrdinaryGetPrototypeOf(m);return!IsNull(v)&&OrdinaryHasMetadata(g,v,S)}function OrdinaryHasOwnMetadata(g,m,S){var v=GetOrCreateMetadataMap(m,S,!1);return!IsUndefined(v)&&ToBoolean(v.has(g))}function OrdinaryGetMetadata(g,m,S){if(OrdinaryHasOwnMetadata(g,m,S))return OrdinaryGetOwnMetadata(g,m,S);var v=OrdinaryGetPrototypeOf(m);return IsNull(v)?void 0:OrdinaryGetMetadata(g,v,S)}function OrdinaryGetOwnMetadata(g,m,S){var v=GetOrCreateMetadataMap(m,S,!1);if(!IsUndefined(v))return v.get(g)}function OrdinaryDefineOwnMetadata(g,m,S,v){GetOrCreateMetadataMap(S,v,!0).set(g,m)}function OrdinaryMetadataKeys(g,m){var S=OrdinaryOwnMetadataKeys(g,m),v=OrdinaryGetPrototypeOf(g);if(null===v)return S;var C=OrdinaryMetadataKeys(v,m);if(C.length<=0)return S;if(S.length<=0)return C;for(var _=new P,E=[],T=0,I=S;T<I.length;T++){var b=I[T];_.has(b)||(_.add(b),E.push(b))}for(var A=0,R=C;A<R.length;A++){b=R[A];_.has(b)||(_.add(b),E.push(b))}return E}function OrdinaryOwnMetadataKeys(g,m){var S=[],v=GetOrCreateMetadataMap(g,m,!1);if(IsUndefined(v))return S;for(var C=GetIterator(v.keys()),_=0;;){var E=IteratorStep(C);if(!E)return S.length=_,S;var T=IteratorValue(E);try{S[_]=T}catch(g){try{IteratorClose(C)}finally{throw g}}_++}}function Type(g){if(null===g)return 1;switch(typeof g){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===g?1:6;default:return 6}}function IsUndefined(g){return void 0===g}function IsNull(g){return null===g}function IsSymbol(g){return"symbol"==typeof g}function IsObject(g){return"object"==typeof g?null!==g:"function"==typeof g}function ToPrimitive(g,m){switch(Type(g)){case 0:case 1:case 2:case 3:case 4:case 5:return g}var S=3===m?"string":5===m?"number":"default",C=GetMethod(g,v);if(void 0!==C){var _=C.call(g,S);if(IsObject(_))throw new TypeError;return _}return OrdinaryToPrimitive(g,"default"===S?"number":S)}function OrdinaryToPrimitive(g,m){if("string"===m){var S=g.toString;if(IsCallable(S))if(!IsObject(C=S.call(g)))return C;if(IsCallable(v=g.valueOf))if(!IsObject(C=v.call(g)))return C}else{var v;if(IsCallable(v=g.valueOf))if(!IsObject(C=v.call(g)))return C;var C,_=g.toString;if(IsCallable(_))if(!IsObject(C=_.call(g)))return C}throw new TypeError}function ToBoolean(g){return!!g}function ToString(g){return""+g}function ToPropertyKey(g){var m=ToPrimitive(g,3);return IsSymbol(m)?m:ToString(m)}function IsArray(g){return Array.isArray?Array.isArray(g):g instanceof Object?g instanceof Array:"[object Array]"===Object.prototype.toString.call(g)}function IsCallable(g){return"function"==typeof g}function IsConstructor(g){return"function"==typeof g}function IsPropertyKey(g){switch(Type(g)){case 3:case 4:return!0;default:return!1}}function GetMethod(g,m){var S=g[m];if(null!=S){if(!IsCallable(S))throw new TypeError;return S}}function GetIterator(g){var m=GetMethod(g,C);if(!IsCallable(m))throw new TypeError;var S=m.call(g);if(!IsObject(S))throw new TypeError;return S}function IteratorValue(g){return g.value}function IteratorStep(g){var m=g.next();return!m.done&&m}function IteratorClose(g){var m=g.return;m&&m.call(g)}function OrdinaryGetPrototypeOf(g){var m=Object.getPrototypeOf(g);if("function"!=typeof g||g===b)return m;if(m!==b)return m;var S=g.prototype,v=S&&Object.getPrototypeOf(S);if(null==v||v===Object.prototype)return m;var C=v.constructor;return"function"!=typeof C||C===g?m:C}function CreateMapPolyfill(){var g={},m=[],S=function(){function MapIterator(g,m,S){this._index=0,this._keys=g,this._values=m,this._selector=S}return MapIterator.prototype["@@iterator"]=function(){return this},MapIterator.prototype[C]=function(){return this},MapIterator.prototype.next=function(){var g=this._index;if(g>=0&&g<this._keys.length){var S=this._selector(this._keys[g],this._values[g]);return g+1>=this._keys.length?(this._index=-1,this._keys=m,this._values=m):this._index++,{value:S,done:!1}}return{value:void 0,done:!0}},MapIterator.prototype.throw=function(g){throw this._index>=0&&(this._index=-1,this._keys=m,this._values=m),g},MapIterator.prototype.return=function(g){return this._index>=0&&(this._index=-1,this._keys=m,this._values=m),{value:g,done:!0}},MapIterator}();return function(){function Map(){this._keys=[],this._values=[],this._cacheKey=g,this._cacheIndex=-2}return Object.defineProperty(Map.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Map.prototype.has=function(g){return this._find(g,!1)>=0},Map.prototype.get=function(g){var m=this._find(g,!1);return m>=0?this._values[m]:void 0},Map.prototype.set=function(g,m){var S=this._find(g,!0);return this._values[S]=m,this},Map.prototype.delete=function(m){var S=this._find(m,!1);if(S>=0){for(var v=this._keys.length,C=S+1;C<v;C++)this._keys[C-1]=this._keys[C],this._values[C-1]=this._values[C];return this._keys.length--,this._values.length--,m===this._cacheKey&&(this._cacheKey=g,this._cacheIndex=-2),!0}return!1},Map.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=g,this._cacheIndex=-2},Map.prototype.keys=function(){return new S(this._keys,this._values,getKey)},Map.prototype.values=function(){return new S(this._keys,this._values,getValue)},Map.prototype.entries=function(){return new S(this._keys,this._values,getEntry)},Map.prototype["@@iterator"]=function(){return this.entries()},Map.prototype[C]=function(){return this.entries()},Map.prototype._find=function(g,m){return this._cacheKey!==g&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=g)),this._cacheIndex<0&&m&&(this._cacheIndex=this._keys.length,this._keys.push(g),this._values.push(void 0)),this._cacheIndex},Map}();function getKey(g,m){return g}function getValue(g,m){return m}function getEntry(g,m){return[g,m]}}function CreateSetPolyfill(){return function(){function Set(){this._map=new R}return Object.defineProperty(Set.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),Set.prototype.has=function(g){return this._map.has(g)},Set.prototype.add=function(g){return this._map.set(g,g),this},Set.prototype.delete=function(g){return this._map.delete(g)},Set.prototype.clear=function(){this._map.clear()},Set.prototype.keys=function(){return this._map.keys()},Set.prototype.values=function(){return this._map.values()},Set.prototype.entries=function(){return this._map.entries()},Set.prototype["@@iterator"]=function(){return this.keys()},Set.prototype[C]=function(){return this.keys()},Set}()}function CreateWeakMapPolyfill(){var g=16,S=I.create(),v=CreateUniqueKey();return function(){function WeakMap(){this._key=CreateUniqueKey()}return WeakMap.prototype.has=function(g){var m=GetOrCreateWeakMapTable(g,!1);return void 0!==m&&I.has(m,this._key)},WeakMap.prototype.get=function(g){var m=GetOrCreateWeakMapTable(g,!1);return void 0!==m?I.get(m,this._key):void 0},WeakMap.prototype.set=function(g,m){return GetOrCreateWeakMapTable(g,!0)[this._key]=m,this},WeakMap.prototype.delete=function(g){var m=GetOrCreateWeakMapTable(g,!1);return void 0!==m&&delete m[this._key]},WeakMap.prototype.clear=function(){this._key=CreateUniqueKey()},WeakMap}();function CreateUniqueKey(){var g;do{g="@@WeakMap@@"+CreateUUID()}while(I.has(S,g));return S[g]=!0,g}function GetOrCreateWeakMapTable(g,S){if(!m.call(g,v)){if(!S)return;Object.defineProperty(g,v,{value:I.create()})}return g[v]}function FillRandomBytes(g,m){for(var S=0;S<m;++S)g[S]=255*Math.random()|0;return g}function GenRandomBytes(g){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(g)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(g)):FillRandomBytes(new Uint8Array(g),g):FillRandomBytes(new Array(g),g)}function CreateUUID(){var m=GenRandomBytes(g);m[6]=79&m[6]|64,m[8]=191&m[8]|128;for(var S="",v=0;v<g;++v){var C=m[v];4!==v&&6!==v&&8!==v||(S+="-"),C<16&&(S+="0"),S+=C.toString(16).toLowerCase()}return S}}function MakeDictionary(g){return g.__=void 0,delete g.__,g}g("decorate",decorate),g("metadata",metadata),g("defineMetadata",defineMetadata),g("hasMetadata",hasMetadata),g("hasOwnMetadata",hasOwnMetadata),g("getMetadata",getMetadata),g("getOwnMetadata",getOwnMetadata),g("getMetadataKeys",getMetadataKeys),g("getOwnMetadataKeys",getOwnMetadataKeys),g("deleteMetadata",deleteMetadata)}))}(v||(v={}));var _=createCommonjsModule((function(g,m){function vsprintf(g,m){var S=0;return g.replace(/%[dixs%]/g,(function(g){var v=0;if("%"!==g[v++])return"";var C=g[v++];return"%"===C?"%":"s"===C||"d"===C||"i"===C?m[S++]:"x"===C?m[S++].toString(16):g}))}function sprintf(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];return vsprintf(g,m)}
/*!
	 *  AufLog.ts
	 *  AUF
	 *
	 *  Created by Johan Blumenberg on 2016-12-29
	 *  Copyright 2016 Microsoft. All rights reserved.
	 *
	 */
Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.Trace=10]="Trace",g[g.Debug6=16]="Debug6",g[g.Debug5=18]="Debug5",g[g.Debug4=20]="Debug4",g[g.Debug3=30]="Debug3",g[g.Debug2=40]="Debug2",g[g.Debug1=50]="Debug1",g[g.Warning=60]="Warning",g[g.Error=70]="Error",g[g.Fatal=80]="Fatal",g[g.MetaData=90]="MetaData"}(m.LogLevel||(m.LogLevel={})),function(g){g[g.UseDefault=0]="UseDefault",g[g.Compress=1]="Compress",g[g.Disabled=2]="Disabled"}(m.LogFileCompression||(m.LogFileCompression={})),function(g){g[g.Raw=0]="Raw",g[g.Base64=1]="Base64"}(m.LogFileEncoding||(m.LogFileEncoding={})),function(g){g[g.Unencrypted=0]="Unencrypted",g[g.Encrypted=1]="Encrypted"}(m.LogFileEncryption||(m.LogFileEncryption={})),function(g){g[g.PEM=0]="PEM",g[g.DER=1]="DER",g[g.BER=2]="BER"}(m.CertStoreFormat||(m.CertStoreFormat={})),function(g){g[g.InsertFront=8]="InsertFront"}(m.AppenderFlags||(m.AppenderFlags={})),m.vsprintf=vsprintf,m.sprintf=sprintf})),E=createCommonjsModule((function(g,m){
/*!
	 *  LogFactory.ts
	 *  AUF
	 *
	 *  Created by Johan Blumenberg on 2016-12-29
	 *  Copyright 2016 Microsoft. All rights reserved.
	 *
	 */
var S,v,E=C&&C.__extends||(S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m.hasOwnProperty(S)&&(g[S]=m[S])},function(g,m){function __(){this.constructor=g}S(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});function hash(g){if(null===g)return-1;for(var m=0,S=g.length-1;S>=0;S--)m=37*m+g.charCodeAt(S)|0;var v="__auf_literal:";for(S=v.length-1;S>=0;S--)m=37*m+v.charCodeAt(S)|0;return m}Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.Unsafe=0]="Unsafe",g[g.Safe=1]="Safe",g[g.Inherited_Unsafe=2]="Inherited_Unsafe",g[g.Inherited_Safe=3]="Inherited_Safe",g[g.Blacklisted_Unsafe=4]="Blacklisted_Unsafe"}(v||(v={}));var T,I=function(){function LogComponentImpl(g,m){this._level=_.LogLevel.Debug4,this._threshold=255,this._safe=v.Inherited_Unsafe,this._name=g,m&&(this._level=m.level(),this._safe=m.safe()?v.Inherited_Safe:v.Inherited_Unsafe,this._extendedInfo=m.extendedInfo())}return LogComponentImpl.prototype.name=function(){return this._name},LogComponentImpl.prototype.safe=function(){return this._safe===v.Safe||this._safe===v.Inherited_Safe},LogComponentImpl.prototype.safety=function(){return this._safe},LogComponentImpl.prototype.setSafety=function(g){this._safe=g},LogComponentImpl.prototype.description=function(){return this._desc},LogComponentImpl.prototype.setDescription=function(g){this._desc=g},LogComponentImpl.prototype.level=function(){return this._level},LogComponentImpl.prototype.setLevel=function(g){T.setLevel(this,g)},LogComponentImpl.prototype._setLevel=function(g){this._level=g},LogComponentImpl.prototype._setThreshold=function(g){this._threshold=g},LogComponentImpl.prototype.isEnabled=function(g){return this._threshold<=g},LogComponentImpl.prototype.setExtendedInfo=function(g){this._extendedInfo=g},LogComponentImpl.prototype.extendedInfo=function(){return this._extendedInfo},LogComponentImpl.prototype.trace=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Trace,hash(g),g].concat(m))},LogComponentImpl.prototype.debug6=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Debug6,hash(g),g].concat(m))},LogComponentImpl.prototype.debug5=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Debug5,hash(g),g].concat(m))},LogComponentImpl.prototype.debug4=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Debug4,hash(g),g].concat(m))},LogComponentImpl.prototype.debug3=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Debug3,hash(g),g].concat(m))},LogComponentImpl.prototype.debug2=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Debug2,hash(g),g].concat(m))},LogComponentImpl.prototype.debug1=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Debug1,hash(g),g].concat(m))},LogComponentImpl.prototype.warn=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Warning,hash(g),g].concat(m))},LogComponentImpl.prototype.error=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Error,hash(g),g].concat(m))},LogComponentImpl.prototype.fatal=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.Fatal,hash(g),g].concat(m))},LogComponentImpl.prototype.meta=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];T.log.apply(T,[this,_.LogLevel.MetaData,hash(g),g].concat(m))},LogComponentImpl}(),b=function(){function LogFactory(){}return LogFactory.instance=function(){return T},LogFactory.levelToString=function(g){return g<=_.LogLevel.Trace?"TRACE":g<=_.LogLevel.Debug6?"DEBUG6":g<=_.LogLevel.Debug5?"DEBUG5":g<=_.LogLevel.Debug4?"DEBUG4":g<=_.LogLevel.Debug3?"DEBUG3":g<=_.LogLevel.Debug2?"DEBUG2":g<=_.LogLevel.Debug1?"DEBUG1":g<=_.LogLevel.Warning?"WARN":g<=_.LogLevel.Error?"ERROR":g<=_.LogLevel.Fatal?"FATAL":(_.LogLevel.MetaData,"META")},LogFactory.levelFromString=function(g){return this._levelFromString[g]||parseInt(g,10)},LogFactory}();function findLevel(g,m){for(var S=m.name();S.length>0;){if(g[S])return g[S];var v=S.lastIndexOf(".");S=v<0?"":S.substr(0,v)}return g[""]?g[""]:_.LogLevel.Debug4}function findThreshold(g,m){var S=255;return m.forEach((function(m){var v=255;m.appender.levels()?v=Math.min(v,findLevel(m.appender.levels(),g)):m.appender.receiveAll()||(v=Math.min(v,g.level())),S=Math.min(S,v)})),S}function appenderMatches(g,m,S){return!!g.appender.receiveAll()||(g.appender.levels()?S>=findLevel(g.appender.levels(),m):S>=m.level())}b._levelFromString={TRACE:_.LogLevel.Trace,DEBUG6:_.LogLevel.Debug6,DEBUG5:_.LogLevel.Debug5,DEBUG4:_.LogLevel.Debug4,DEBUG3:_.LogLevel.Debug3,DEBUG2:_.LogLevel.Debug2,DEBUG1:_.LogLevel.Debug1,WARN:_.LogLevel.Warning,ERROR:_.LogLevel.Error,FATAL:_.LogLevel.Fatal,META:_.LogLevel.MetaData},m.LogFactory=b;var A=function(g){function LogFactoryImpl(){var m=g.call(this)||this;return m._nextId=0,m._appenders=[],m._components={},m._componentBlacklist=[],m._components[""]=new I("",null),m}return E(LogFactoryImpl,g),LogFactoryImpl.prototype.toHex=function(g){return(4294967296+g).toString(16).substr(-8)},LogFactoryImpl.prototype.addAppender=function(g,m){void 0===m&&(m=0);var S=this._nextId++;return m&_.AppenderFlags.InsertFront?this._appenders.unshift({appender:g,handle:S}):this._appenders.push({appender:g,handle:S}),this.recalcComponentThresholds(),S},LogFactoryImpl.prototype.removeAppender=function(g){for(var m=0;m<this._appenders.length;m++)if(this._appenders[m].handle===g){this._appenders.splice(m,1);break}this.recalcComponentThresholds()},LogFactoryImpl.prototype.log=function(g,m,S,v){for(var C=[],_=4;_<arguments.length;_++)C[_-4]=arguments[_];try{if(g.isEnabled(m)){var E={timestamp:(new Date).getTime(),component:g,level:m};this._appenders.forEach((function(_){appenderMatches(_,g,m)&&_.appender.log(E,S,v,C)}))}}catch(g){}},LogFactoryImpl.prototype.parent=function(g){for(;;){var m=g.lastIndexOf(".");if(g=m>=0?g.substr(0,m):"",this._components[g])return this._components[g]}},LogFactoryImpl.prototype.children=function(g){var m=[];for(var S in this._components)this.parent(S).name()===g&&m.push(this._components[S]);return m},LogFactoryImpl.prototype.component=function(g){if(this._components[g])return this._components[g];var m=new I(g,this.parent(g));this._components[g]=m;var S=findThreshold(m,this._appenders);return m._setThreshold(S),m},LogFactoryImpl.prototype.rootComponent=function(){return this.component("")},LogFactoryImpl.prototype.setSafetyRecursive=function(g,m){var S=this;this.children(g).forEach((function(g){g.safety()!==v.Inherited_Safe&&g.safety()!==v.Inherited_Unsafe||(g.setSafety(m),S.setSafetyRecursive(g.name(),m))}))},LogFactoryImpl.prototype.declareComponentSafe=function(g,m){var S=this.component(g);-1!==this._componentBlacklist.indexOf(S.name())?S.setSafety(v.Blacklisted_Unsafe):S.setSafety(m?v.Safe:v.Unsafe),this.setSafetyRecursive(g,m?v.Inherited_Safe:v.Inherited_Unsafe)},LogFactoryImpl.prototype.declareComponentDescription=function(g,m){this.component(g).setDescription(m)},LogFactoryImpl.prototype.setExtendedInfoRecursive=function(g,m){var S=this;this.children(g).forEach((function(g){void 0===g.extendedInfo()&&(g.setExtendedInfo(m),S.setExtendedInfoRecursive(g.name(),m))}))},LogFactoryImpl.prototype.declareComponentExtendedInfo=function(g,m){var S=this.component(g);S.setExtendedInfo(m),this.setExtendedInfoRecursive(S.name(),m)},LogFactoryImpl.prototype.recalcComponentThresholds=function(){for(var g in this._components){var m=this._components[g],S=findThreshold(m,this._appenders);m._setThreshold(S)}},LogFactoryImpl.prototype.setLevel=function(g,m){if(""===g.name())for(var S in this._components){(_=this._components[S])._setLevel(m);var v=findThreshold(_,this._appenders);_._setThreshold(v)}else{var C=g.name()+".";g._setLevel(m);v=findThreshold(g,this._appenders);for(var S in g._setThreshold(v),this._components){var _;if((_=this._components[S]).name().substr(0,C.length)===C){_._setLevel(m);var E=findThreshold(_,this._appenders);_._setThreshold(E)}}}},LogFactoryImpl.prototype.setComponentBlacklist=function(g){for(var m in this._componentBlacklist=g,this._components){var S=this._components[m];-1!==this._componentBlacklist.indexOf(S.name())&&S.setSafety(v.Blacklisted_Unsafe)}},LogFactoryImpl}(b);T=new A})),T=createCommonjsModule((function(g,m){function fromThenable(g){var m=Defer();return g.then((function(g){m.resolve(g)}),(function(g){m.reject(g)})),m.promise().thenAsync((function(g){return g}))}function isThenable(g){return null!=g&&"function"==typeof g.then}function isCancelable(g){return null!=g&&"function"==typeof g.cancel}function run(g,S){if(!m.config.catchExceptions)return g();try{return g()}catch(g){return S(g)}}Object.defineProperty(m,"__esModule",{value:!0}),m.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(g){throw g}},m.fromThenable=fromThenable;var S,v=[],C="undefined"!=typeof setImmediate;function asyncCallback(g){v.push(g),1===v.length&&(C?setImmediate(resolveAsyncCallbacks):setTimeout(resolveAsyncCallbacks,0))}function resolveAsyncCallbacks(){var g=v;v=[];for(var m=0;m<g.length;m++)g[m]()}function all(g){if(0===g.length)return Resolved([]);var m,v=Defer(),C=g.length,_=Array(g.length);v.onCancel((function(m){g.forEach((function(g){isCancelable(g)&&S.SyncTask.cancelOtherInternal(g,m)}))}));var checkFinish=function(){0==--C&&(void 0!==m?v.reject(m):v.resolve(_))};return g.forEach((function(g,S){isThenable(g)?g.then((function(g){_[S]=g,checkFinish()}),(function(g){void 0===m&&(m=void 0===g||g),checkFinish()})):(_[S]=g,checkFinish())})),v.promise()}function Defer(){return new S.SyncTask}function Resolved(g){return(new S.SyncTask).resolve(g).promise()}function Rejected(g){return(new S.SyncTask).reject(g).promise()}function race(g){var m=Defer(),v=!1;return m.onCancel((function(m){g.forEach((function(g){isCancelable(g)&&S.SyncTask.cancelOtherInternal(g,m)}))})),g.forEach((function(g){isThenable(g)?g.then((function(g){v||(v=!0,m.resolve(g))}),(function(g){v||(v=!0,m.reject(g))})):v||(v=!0,m.resolve(g))})),m.promise()}function raceTimer(g,m){var S=Defer(),v=setTimeout((function(){S.resolve({timedOut:!0})}),m);return race([g.then((function(g){return clearTimeout(v),{timedOut:!1,result:g}})),S.promise()])}m.asyncCallback=asyncCallback,function(g){var S=function(){function SyncTask(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return SyncTask.prototype._addCallbackSet=function(g,m){var S=this,v=new SyncTask;return v.onCancel((function(m){g.wasCanceled=!0,g.cancelContext=m,S._cancelInternal(m)})),g.task=v,this._storedCallbackSets.push(g),m?this._mustHandleError=!1:v._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),v.promise()},SyncTask.prototype.onCancel=function(g){return this._completedSuccess||this._completedFail||(this._wasCanceled?g(this._cancelContext):this._cancelCallbacks.push(g)),this},SyncTask.prototype.then=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m},!0)},SyncTask.prototype.thenAsync=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m,asyncCallback:!0},!0)},SyncTask.prototype.catch=function(g){return this._addCallbackSet({failFunc:g},!0)},SyncTask.prototype.always=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!0)},SyncTask.prototype.setTracingEnabled=function(g){return this._traceEnabled=g,this},SyncTask.prototype.finally=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!1),this},SyncTask.prototype.done=function(g){return this._addCallbackSet({successFunc:g},!1),this},SyncTask.prototype.fail=function(g){return this._addCallbackSet({failFunc:g},!1),this},SyncTask.prototype.resolve=function(g){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=g,this._cancelCallbacks=[],this._resolveSuccesses(),this},SyncTask.prototype.reject=function(g){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=g,this._cancelCallbacks=[],this._resolveFailures(),SyncTask._enforceErrorHandled(this),this},SyncTask.prototype._checkState=function(g){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var S="Failed to "+(g?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(S)}(m.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},SyncTask._enforceErrorHandled=function(g){g._mustHandleError&&(SyncTask._rejectedTasks.push(g),SyncTask._enforceErrorHandledTimer||(SyncTask._enforceErrorHandledTimer=setTimeout((function(){SyncTask._enforceErrorHandledTimer=void 0;var g=SyncTask._rejectedTasks;SyncTask._rejectedTasks=[],g.forEach((function(g,S){g._mustHandleError&&m.config.unhandledErrorHandler(g._storedErrResolution)}))}),0)))},SyncTask.prototype.cancel=function(g){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(g)},SyncTask.prototype._cancelInternal=function(g){var m=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=g;var S=this._cancelCallbacks;this._cancelCallbacks=[],S.length>0&&S.forEach((function(g){m._completedSuccess||m._completedFail||g(m._cancelContext)}))}},SyncTask.cancelOtherInternal=function(g,m){var S=g;S._storedCallbackSets&&S._cancelInternal?S._cancelInternal(m):g.cancel(m)},SyncTask.prototype.promise=function(){return this},SyncTask.prototype._resolveSuccesses=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveSuccessCallback(m)})):g._resolveSuccessCallback(m)}))}this._resolving=!1},SyncTask.prototype._resolveSuccessCallback=function(g){var m=this;g.successFunc?run((function(){var S=g.successFunc(m._storedResolution);isCancelable(S)&&(g.wasCanceled?SyncTask.cancelOtherInternal(S,g.cancelContext):g.task.onCancel((function(g){return SyncTask.cancelOtherInternal(S,g)}))),isThenable(S)?S.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(S)}),(function(S){m._handleException(S,"SyncTask caught exception in success block: "+S.toString()),g.task.reject(S)})):g.task.resolve(this._storedResolution)},SyncTask.prototype._resolveFailures=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveFailureCallback(m)})):g._resolveFailureCallback(m)}))}this._resolving=!1},SyncTask.prototype._resolveFailureCallback=function(g){var m=this;g.failFunc?run((function(){var S=g.failFunc(m._storedErrResolution);isCancelable(S)&&(g.wasCanceled?SyncTask.cancelOtherInternal(S,g.cancelContext):g.task.onCancel((function(g){return SyncTask.cancelOtherInternal(S,g)}))),isThenable(S)?S.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(S)}),(function(S){m._handleException(S,"SyncTask caught exception in failure block: "+S.toString()),g.task.reject(S)})):g.task.reject(this._storedErrResolution)},SyncTask.prototype._handleException=function(g,S){m.config.exceptionsToConsole&&console.error(S),m.config.exceptionHandler&&m.config.exceptionHandler(g)},SyncTask.prototype.toEs6Promise=function(){var g=this;return new Promise((function(m,S){return g.then(m,S)}))},SyncTask._rejectedTasks=[],SyncTask}();g.SyncTask=S}(S||(S={})),m.all=all,m.Defer=Defer,m.Resolved=Resolved,m.Rejected=Rejected,m.race=race,m.raceTimer=raceTimer})),I=createCommonjsModule((function(g,m){
/*!
	 *  Appenders.ts
	 *  AUF
	 *
	 *  Created by Johan Blumenberg on 2016-12-29
	 *  Copyright 2016 Microsoft. All rights reserved.
	 *
	 */
var S,v=C&&C.__extends||(S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m.hasOwnProperty(S)&&(g[S]=m[S])},function(g,m){function __(){this.constructor=g}S(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});Object.defineProperty(m,"__esModule",{value:!0});var T,I=function(){function AbstractLogAppender(g){this._formatter=g||new b}return AbstractLogAppender.prototype.formatter=function(){return this._formatter},AbstractLogAppender.prototype.receiveAll=function(){return!1},AbstractLogAppender.prototype.levels=function(){return null},AbstractLogAppender}();function toHex(g){return(4294967296+g).toString(16).substr(-8)}function pad(g,m){return(1e12+g).toString(10).substr(-m)}m.AbstractLogAppender=I,function(g){g[g.Timestamp=1]="Timestamp",g[g.Component=4]="Component",g[g.Level=8]="Level",g[g.FullDate=32]="FullDate",g[g.LogId=64]="LogId"}(T=m.SLF_Flags||(m.SLF_Flags={}));var b=function(){function StandardLogFormatter(g){void 0===g&&(g=4294967295),this._flags=g}return StandardLogFormatter.prototype.format=function(g,m,S,v){var C="";if(this._flags&T.FullDate)C+=new Date(g.timestamp).toISOString()+" ";else if(this._flags&T.Timestamp){var I=new Date(g.timestamp);C+=pad(I.getHours(),2)+":"+pad(I.getMinutes(),2)+":"+pad(I.getSeconds(),2)+"."+pad(I.getMilliseconds(),2)+" "}return this._flags&T.LogId&&(C+="[#"+toHex(m)+"-"+(g.component.safe()?"S":"u")+"] "),this._flags&T.Level&&(C+="["+E.LogFactory.levelToString(g.level)+"] "),this._flags&T.Component&&(C+="["+g.component.name()+"] "),S||""===S?C+_.vsprintf(S,v):C+toHex(m)+": "+v.join(" ")},StandardLogFormatter}();m.StandardLogFormatter=b;var A=console,R=console.log||function(){},P=console.info||R,M=console.warn||P,w=console.error||M,D=function(g){function ConsoleAppender(){return null!==g&&g.apply(this,arguments)||this}return v(ConsoleAppender,g),ConsoleAppender.prototype.log=function(g,m,S,v){v=v.slice(0);var C=g.level<=_.LogLevel.Debug3?R:g.level<=_.LogLevel.Debug1?P:g.level<=_.LogLevel.Warning?M:w;if(-1===m){var E=this.formatter().format(g,m,"",[]);"string"==typeof v[0]&&(E+=v.shift()),C.apply(A,[E].concat(v))}else{for(var T=void 0,I=[];T=S.match(/\s*%@\s*$/);)S=S.substr(0,S.length-T[0].length),I.unshift(v.pop());E=this.formatter().format(g,m,S,v);C.apply(A,[E].concat(I))}},ConsoleAppender}(I);m.ConsoleAppender=D;var O=function(){function ChainedLogAppender(g){this._chained=g}return ChainedLogAppender.prototype.log=function(g,m,S,v){this._chained.log(g,m,S,v)},ChainedLogAppender.prototype.receiveAll=function(){return this._chained.receiveAll()},ChainedLogAppender.prototype.levels=function(){return this._chained.levels()},ChainedLogAppender}();m.ChainedLogAppender=O;var N=function(g){function LevelWrappedAppender(m,S){var v=g.call(this,m)||this;return v._levels=S,v}return v(LevelWrappedAppender,g),LevelWrappedAppender.prototype.levels=function(){return this._levels},LevelWrappedAppender}(O);function wrapAppenderWithLogLevels(g,m){return new N(g,m)}m.wrapAppenderWithLogLevels=wrapAppenderWithLogLevels})),b=createCommonjsModule((function(g,m){
/*!
	 *  RootToolsManager.ts
	 *  AUF
	 *
	 *  Created by Johan Blumenberg on 2016-12-29
	 *  Copyright 2016 Microsoft. All rights reserved.
	 *
	 */
var S,v=C&&C.__extends||(S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m.hasOwnProperty(S)&&(g[S]=m[S])},function(g,m){function __(){this.constructor=g}S(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});Object.defineProperty(m,"__esModule",{value:!0});var b=E.LogFactory.instance().component("RootToolsManager");E.LogFactory.instance().declareComponentSafe("RootToolsManager",!0);var A,R="638b8ba2bae14e07aa5d73ddb5d5e5c5-297b8412-5df3-4a83-83c4-7b76c6c5d3f0-7104";!function(g){g[g.InternalBuild=0]="InternalBuild",g[g.PublicBuild=1]="PublicBuild"}(A=m.BuildType||(m.BuildType={}));var P=A.InternalBuild;function setBuildType(g){var m=P;return P=g,m}function toHex(g){return(4294967296+g).toString(16).substr(-8)}function map(g,m){var S=[];for(var v in g)S.push(m(v,g[v]));return S}function arrayEquals(g,m,S){if(null==g)return null==m||0===m.length;if(null==m)return null==g||0===g.length;if(g.length===m.length){for(var v=0;v<g.length;v++)if(!S(g[v],m[v]))return!1;return!0}return!1}function matcherEquals(g,m){return null==g?null==m:null==m?null==g:g.arg===m.arg&&g.op===m.op&&g.value===m.value}function conditionEquals(g,m){return null==g?null==m||0===m.logId:null==m?null==g||0===g.logId:g.logId===m.logId&&g.name===m.name&&arrayEquals(g.matchers,m.matchers,matcherEquals)}function filterEqualsToNativeFilter(g,m){return null==g?null==m:null==m?null==g:g.component===m.component&&g.parsedLevel===m.level}function filterEquals(g,m){return null==g?null==m:null==m?null==g:g.component===m.component&&g.level===m.level}function formatArgs(g){for(var m=[],S=0;S<g.length;S++)"string"==typeof g[S]||"number"==typeof g[S]?m.push(g[S]):m.push(JSON.stringify(g[S]));return m}m.setBuildType=setBuildType;var M=function(g){function Trigger(m,S,v){var C=g.call(this)||this;return C._unmetConditions=[],C._rtMan=m,C._triggerCallback=S,C._ecsConfig=v,C.resetConditions(),C}return v(Trigger,g),Trigger.prototype.config=function(){return this._ecsConfig},Trigger.prototype.configEquals=function(g){return this._ecsConfig.includeUnsafe===g.includeUnsafe&&this._ecsConfig.mutualSubmissionType===g.mutualSubmissionType&&this._ecsConfig.name===g.name&&this._ecsConfig.reenableAfterTriggering===g.reenableAfterTriggering&&this._ecsConfig.experimentTarget===g.experimentTarget&&conditionEquals(this._ecsConfig.resetCondition,g.resetCondition)&&arrayEquals(this._ecsConfig.conditions,g.conditions,conditionEquals)&&arrayEquals(this._ecsConfig.filters,g.filters,filterEquals)},Trigger.prototype.nativeConfigEquals=function(g){return this._ecsConfig.includeUnsafe===g.includeUnsafe&&this._ecsConfig.name===g.name&&this._ecsConfig.reenableAfterTriggering===g.reenableAfterTriggering&&conditionEquals(this._ecsConfig.resetCondition,g.resetCondition)&&arrayEquals(this._ecsConfig.conditions,g.conditions,conditionEquals)&&arrayEquals(this._ecsConfig.filters,g.filters,filterEqualsToNativeFilter)},Trigger.prototype.needReset=function(g){return!this.configEquals(g)},Trigger.prototype.resetConditions=function(){this._unmetConditions=[];for(var g=0;g<this._ecsConfig.conditions.length;g++)this._unmetConditions.push(g)},Trigger.prototype.matcherMatches=function(g,m){if(g.arg>=m.length)return!1;var S=m[g.arg],v="string"==typeof S?g.value:parseInt(g.value,10);return"="===g.op||"=="===g.op?S===v:"!="===g.op?S!==v:"<"===g.op?S<v:"<="===g.op?S<=v:">"===g.op?S>v:">="===g.op?S>=v:"CONTAINS"===g.op.toUpperCase()&&(""+S).indexOf(g.value)>=0},Trigger.prototype.conditionMatches=function(g,m,S){if(m!==g.logId)return!1;if(g.matchers)for(var v=0;v<g.matchers.length;v++)if(!this.matcherMatches(g.matchers[v],S))return!1;return!0},Trigger.prototype.log=function(g,m,S,v){if(0!==this._unmetConditions.length&&g.component!==b){var C=this._ecsConfig;C.resetCondition&&this.conditionMatches(C.resetCondition,m,v)&&(b.debug4("LogTrigger %s: resetCondition met",C.name),this.resetConditions());for(var _=0;_<this._unmetConditions.length;_++){var E=this._unmetConditions[_];if(this.conditionMatches(C.conditions[E],m,v)){b.debug4("LogTrigger %s: condition %s met",C.name,C.conditions[E].name),this._unmetConditions.splice(_,1);break}}0===this._unmetConditions.length&&(b.debug1("LogTrigger %s has triggered, trying to send the log",C.name),this._triggerCallback.call(this._rtMan,C),C.reenableAfterTriggering&&this.resetConditions())}},Trigger.prototype.receiveAll=function(){return!0},Trigger}(I.AbstractLogAppender),w=function(g){function CircularBuffer(m,S,v){var C=g.call(this)||this;return C._circularBuffer=[],C._circularBufferMaxSize=0,C._onBufferOverflow=null,C._circularBuffer=[],C._circularBufferMaxSize=S,C._includeUnsafe=m,C._onBufferOverflow=v||function(){return C._circularBuffer.shift()},C}return v(CircularBuffer,g),CircularBuffer.prototype.log=function(g,m,S,v){if((this._includeUnsafe||g.component.safe())&&!(this._circularBuffer.length>this._circularBufferMaxSize)){var C={md:g,logId:m,messages:formatArgs(v)};this._circularBuffer.push(C),this._circularBuffer.length>this._circularBufferMaxSize&&this._onBufferOverflow()}},CircularBuffer.prototype.visitReverseOrder=function(g){for(var m=this._circularBuffer.length-1;m>=0;m--){var S=this._circularBuffer[m];if(!g(S.md,S.logId,S.messages))return}},CircularBuffer.prototype.visitForwardOrder=function(g){for(var m=0;m<this._circularBuffer.length;m++){var S=this._circularBuffer[m];if(!g(S.md,S.logId,S.messages))return}},CircularBuffer.prototype.needReset=function(g,m){return g!==this._includeUnsafe||m!==this._circularBufferMaxSize},CircularBuffer.prototype.dumpLogBuffer=function(g,m,S){var v=this,C=new D(g.reverse),_=g.filter.map((function(g){return{component:"root"===g.component?"":g.component,parsedLevel:g.level}})),E=S||{matchedLines:0,totalLines:0};return(g.reverse?this.visitReverseOrder:this.visitForwardOrder).apply(this,[function(g,S,T){return E.totalLines++,v.filterMatches(g,S,T,_)&&(E.matchedLines++,C.log(g.component,g.timestamp,g.level,S,T)),!m||C._data.length<m}]),C.close(),C.data()},CircularBuffer.prototype.filterMatches=function(g,m,S,v){for(var C=0;C<v.length;C++)if((""===v[C].component||g.component.name()===v[C].component||g.component.name().substr(0,v[C].component.length)===v[C].component&&"."===g.component.name().charAt(v[C].component.length))&&g.level>=v[C].parsedLevel)return!0;return!1},CircularBuffer.prototype.clear=function(){this._circularBuffer=[]},CircularBuffer.prototype.size=function(){return this._circularBuffer.length},CircularBuffer.prototype.empty=function(){return 0===this.size()},CircularBuffer.prototype.capacity=function(){return this._circularBufferMaxSize},CircularBuffer}(I.AbstractLogAppender);m.CircularBuffer=w;var D=function(){function BinaryLogFormatter(g){this._reverse=g,this._first=!0,this._pending=[],this._components={},this._componentCount=0,this._lastts=0,this._base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this._data="ULOG2"+String.fromCharCode(33)+String.fromCharCode(32),this._data+=g?String.fromCharCode(34):String.fromCharCode(32),this._data+=String.fromCharCode(32)}return BinaryLogFormatter.prototype._add8=function(g){if(this._pending.push(255&g),3===this._pending.length){var m=(this._pending[0]<<16)+(this._pending[1]<<8)+(this._pending[2]<<0),S=this._base64chars[m>>18&63]+this._base64chars[m>>12&63]+this._base64chars[m>>6&63]+this._base64chars[m>>0&63];this._data+=S,this._pending=[]}},BinaryLogFormatter.prototype._add16=function(g){this._add8(g>>8&255),this._add8(g>>0&255)},BinaryLogFormatter.prototype._add32=function(g){this._add8(g>>24&255),this._add8(g>>16&255),this._add8(g>>8&255),this._add8(g>>0&255)},BinaryLogFormatter.prototype._add64=function(g){this._add32(g/4294967296|0),this._add32(0|g)},BinaryLogFormatter.prototype._addS=function(g){for(var m=0;m<g.length;m++)this._add8(g.charCodeAt(m));this._add8(0)},BinaryLogFormatter.prototype._close=function(){for(;this._pending.length;)this._add8(0)},BinaryLogFormatter.prototype.log=function(g,m,S,v,C){var _=this._components[g.name()];_||(_=++this._componentCount,this._components[g.name()]=_,this._add8(2),this._add16(_),this._addS(g.name()),this._addS(""),this._addS(""),this._add8(g.safe()?1:0));var E=128;this._first&&(E|=2);var T=m-this._lastts;this._lastts=m,T>-128&&T<128&&(E|=1),this._add8(E),1&E?this._add8(T):this._add64(1e3*m),this._first&&(this._add32(1),this._add8(0),this._add16(0)),this._add16(_),this._add8(S),this._add32(v),this._add8(C.length);for(var I=0;I<C.length;I++)this._add8(8),this._addS(""+C[I]);this._first=!1},BinaryLogFormatter.prototype.close=function(){this._add8(7),this._close()},BinaryLogFormatter.prototype.data=function(){return this._data},BinaryLogFormatter.prototype.empty=function(){return this._first},BinaryLogFormatter}(),O=function(g){function DumperBuffer(m,S,v,C){var _=g.call(this)||this;return _._capacity=m,_._onBufferOverflow=S,_._enableThrottling=v,_._maxVerbosityLevel=C,_._outputFormatter=new D(!1),_._linesStored=0,_._throttling=!1,_._linesThrottled=0,_}return v(DumperBuffer,g),DumperBuffer.prototype.log=function(g,m,S,v){this._maxVerbosityLevel&&g.level<this._maxVerbosityLevel||(this._throttling?this._linesThrottled++:(this._linesStored++,this._outputFormatter.log(g.component,g.timestamp,g.level,m,formatArgs(v))),this._linesStored>this._capacity&&(this._enableThrottling?this._throttling||(this._throttling=!0):this._onBufferOverflow()))},DumperBuffer.prototype.dumpAndReset=function(){if(this._outputFormatter.empty())return"";this._linesThrottled>0&&this._outputFormatter.log(b,(new Date).getTime(),_.LogLevel.Fatal,-1,["RooToolsManager: Log buffer overflow! "+this._linesThrottled+" lines thrown away"]),this._outputFormatter.close();var g=this._outputFormatter.data();return this.clearBuffer(),g},DumperBuffer.prototype.empty=function(){return this._outputFormatter.empty()},DumperBuffer.prototype.clearBuffer=function(){this._outputFormatter=new D(!1),this._linesStored=0,this._linesThrottled=0,this._throttling=!1},DumperBuffer.prototype.capacity=function(){return this._capacity},DumperBuffer.prototype.throttlingEnabled=function(){return this._enableThrottling},DumperBuffer.prototype.size=function(){return this._linesStored},DumperBuffer.prototype.maxVerbosityLevel=function(){return this._maxVerbosityLevel},DumperBuffer}(I.AbstractLogAppender);function validateExperimentTarget(g){return"Native"===g||"JavaScript"===g||"Mixed"===g}m.DumperBuffer=O;var N=function(){function RootToolsManagerImpl(){this._maxUploadSize=0,this._jsToNativeBuffer=null,this._jsToNativeBufferHandle=null,this._jsToNativeFlushTimer=null,this._jsToNativeFlushInterval=0,this._triggers={},this._defaultBuffers=[{size:2097152,level:_.LogLevel.Debug4}],this._defaultKillswitch={blacklist:[],whitelist:[]},this._defaultBlacklists={component:[],logline:[]},this._localLogLevels={},this._defaultExperimentTarget="Mixed",this._BRBCallback=null}return RootToolsManagerImpl.prototype.setDelegate=function(g){this._glue=g,this.registerListeners()},RootToolsManagerImpl.prototype.isDelegateSet=function(){return null!=this._glue},RootToolsManagerImpl.prototype.setNativeFunctions=function(g){this._native&&this._native.log_config.removeLogTriggerListener(this),this._native=g,this._native&&this._native.log_config.addLogTriggerListener(this)},RootToolsManagerImpl.prototype.applyLogLevels=function(){var g={};for(var m in this._localLogLevels)g[m]=this._localLogLevels[m];g[""]=g.root||_.LogLevel.Debug4,delete g.root;var S=map(g,(function(g,m){return{component:g,level:m}}));S.sort((function(g,m){return g.component.length-m.component.length})),S.forEach((function(g){return E.LogFactory.instance().component(g.component).setLevel(g.level)})),this._native&&this._native.log_config.setLogLevelConfig(S)},RootToolsManagerImpl.prototype.setLocalLogLevelConfig=function(g){this._localLogLevels=g,this.applyLogLevels()},RootToolsManagerImpl.prototype.parseMatcher=function(g){return null==g||null==g.arg||null==g.op||null==g.value?null:{arg:g.arg,op:g.op,value:g.value}},RootToolsManagerImpl.prototype.parseCondition=function(g){if(null==g||null==g.logId)return null;if(g.matchers&&!(g.matchers instanceof Array))return null;var m={name:g.name||toHex(g.logId),logId:g.logId,matchers:[]};if(g.matchers&&g.matchers.length)for(var S=0,v=g.matchers;S<v.length;S++){var C=v[S],_=this.parseMatcher(C);_&&m.matchers.push(_)}return m},RootToolsManagerImpl.prototype.parseFilter=function(g){return null==g||null==g.component||0===g.component.length?null:{component:g.component,level:g.level,parsedLevel:E.LogFactory.levelFromString(g.level)}},RootToolsManagerImpl.prototype.parseConfig=function(g,m,S){if(null==g)return null;if(!(g.conditions instanceof Array)||0==g.conditions.length)return null;if(!(g.filters instanceof Array)||0==g.filters.length)return null;if(g.resetCondition&&!this.parseCondition(g.resetCondition))return null;for(var v={name:g.name||m+"->"+S,ecsNs:m,reenableAfterTriggering:g.reenableAfterTriggering||!1,mutualSubmissionType:g.mutualSubmissionType||"",includeUnsafe:P!==A.PublicBuild&&(g.includeUnsafe||!1),experimentTarget:validateExperimentTarget(g.experimentTarget)&&g.experimentTarget||this._defaultExperimentTarget,conditions:[],resetCondition:null==g.resetCondition?g.resetCondition:this.parseCondition(g.resetCondition),filters:[]},C=0,_=g.conditions;C<_.length;C++){var E=_[C],T=this.parseCondition(E);T&&v.conditions.push(T)}for(var I=0,b=g.filters;I<b.length;I++){var R=b[I],M=this.parseFilter(R);M&&v.filters.push(M)}return 0===v.conditions.length?null:v},RootToolsManagerImpl.prototype.isExperimentListed=function(g,m,S,v){return!!g&&(!(!v||!g.some((function(g){return"*"===g.namespace})))||g.some((function(g){return g.namespace===m&&(g.experiment===S||"*"==g.experiment)})))},RootToolsManagerImpl.prototype.isExperimentAllowed=function(g,m,S){return!this.isExperimentListed(g.blacklist,m,S,!0)||this.isExperimentListed(g.whitelist,m,S,!1)},RootToolsManagerImpl.prototype.findTrigger=function(g,m){for(var S in g)if(g[S].configEquals(m))return S;return null},RootToolsManagerImpl.prototype.findTriggerByNativeConfig=function(g,m){for(var S in g)if(g[S].nativeConfigEquals(m))return S;return null},RootToolsManagerImpl.prototype.OnEcsChange=function(){var g=this;function forEachAsync(g,m,S){return m<g.length?S(g[m]).then((function(){return forEachAsync(g,m+1,S)})):T.Resolved()}return null==this._glue?T.Resolved():this._glue.fetchEcsConfig("SkypeRootTools","ULBaseline").then((function(m){b.debug4("Reloading ULBaseline config - new config: %@",m),m||(b.warn("No ULBaseline config"),m={}),g._maxUploadSize=m.logUpload&&m.logUpload.maxSize||1024;var S=[],v=g._triggers;g._triggers={};var C=(m.logUpload&&m.logUpload.maxSize||1024)/100,T=m.circularBuffer&&m.circularBuffer.enabled,A=m.circularBuffer&&m.circularBuffer.buffers||g._defaultBuffers,R=m.circularBuffer&&m.circularBuffer.storeUnsafe;g._defaultExperimentTarget=validateExperimentTarget(m.defaultExperimentTarget)&&m.defaultExperimentTarget||"Mixed";var P=m.killswitch||g._defaultKillswitch,D=m.blacklists||g._defaultBlacklists;D.component.length>0&&E.LogFactory.instance().setComponentBlacklist(D.component);var O={};(m.componentLevels||[]).forEach((function(g){return O[g.component]=g.level})),forEachAsync(m.configPaths||[],0,(function(m){return g._glue.fetchEcsConfig(m.ns,m.key).then((function(C){var _=C instanceof Array?C:[C];b.debug4("Reloading ECS config for %s->%s - new config: %@",m.ns,m.key,_);for(var E=0,I=_;E<I.length;E++){var A=I[E];if(null!=A){var M=g.parseConfig(A,m.ns,m.key);if(null!=M)if("JavaScript"===M.experimentTarget||"Mixed"===M.experimentTarget)if(b.debug2("Parsed ECS config for %s->%s - %@",m.ns,m.key,M),g.isExperimentAllowed(P,m.ns,M.name)){b.debug2("Allowing %s->%s:%s according to killswitch",m.ns,m.key,M.name),T=!0;var w=g.findTrigger(v,M);null!=w?(b.debug2("Triggers updated, keeping trigger %s",M.name),g._triggers[w]=v[w],delete v[w]):S.push(M),M.filters&&M.filters.forEach((function(g){return O[g.component]=Math.min(O[g.component]||255,g.parsedLevel)})),M.includeUnsafe&&(R=!0)}else b.debug2("Disallowing %s->%s according to killswitch",m.ns,m.key);else b.debug4("Skipping %s->%s, targeted for %s",m.ns,m.key,M);else b.error("Failed to parse ECS config for %s->%s",m.ns,m.key)}}}))})).always((function(){for(var m in g.applyLogLevels(),v)b.debug2("Triggers updated, removing trigger %s",v[m].config().name),E.LogFactory.instance().removeAppender(+m);if(S.forEach((function(m){b.debug2("Triggers updated, adding trigger %s",m.name);var S=new M(g,g._triggered,m),v=E.LogFactory.instance().addAppender(S);g._triggers[String(v)]=S})),O[""]=O.root||_.LogLevel.Debug4,delete O.root,!g._circularBuffer||T&&!g._circularBuffer.needReset(R,C)?g._circularBuffer&&(Object.keys(v).length>0||S.length>0?(b.debug2("Buffer updated, reapplying log levels, removing log levels wrapper"),E.LogFactory.instance().removeAppender(g._circularBufferHandle),g._circularBufferHandle=null):b.debug2("Buffer updated, no change")):(b.debug2("Buffer updated, removing existing buffer"),E.LogFactory.instance().removeAppender(g._circularBufferHandle),g._circularBuffer=null,g._circularBufferHandle=null),T&&(g._circularBuffer||(b.debug2("Buffer updated, adding new buffer (storeUnsafe=%d,maxSize=%s)",R,C),g._circularBuffer=new w(R,C)),null==g._circularBufferHandle&&(b.debug2("Creating log level wrapper"),g._circularBufferHandle=E.LogFactory.instance().addAppender(I.wrapAppenderWithLogLevels(g._circularBuffer,O),_.AppenderFlags.InsertFront))),g._native){var P=map(O,(function(g,m){return{component:g,level:m}}));P.sort((function(g,m){return g.component.length-m.component.length})),g._native.log_config.setLogBufferConfig(T,{storeUnsafe:R,buffers:A},P);var D=[];for(var N in g._triggers){var k=g._triggers[N].config();D.push({name:k.name,ecsNs:k.ecsNs,conditions:k.conditions,resetCondition:k.resetCondition,includeUnsafe:k.includeUnsafe,reenableAfterTriggering:k.reenableAfterTriggering,filters:k.filters.map((function(g){return{component:g.component,level:g.parsedLevel}})),dumpFile:!1,metadata:{}})}g._native.log_config.setLogTriggerConfig(D,{})}}))}))},RootToolsManagerImpl.prototype._send=function(g,m){null!=this._glue&&(this._glue.sendTelemetry(R,{logTriggerName:g.name,logEcsNs:g.ecsNs,logdata:m}),b.debug4("LogSender::send, sent %d bytes",m.length))},RootToolsManagerImpl.prototype.triggered=function(g,m){},RootToolsManagerImpl.prototype.triggeredPartially=function(g,m,S,v,C){var _=this.findTriggerByNativeConfig(this._triggers,g);if(_){var T={level:m.level,component:E.LogFactory.instance().component(m.component),timestamp:m.timestamp};this._triggers[_].log(T,S,v,C)}},RootToolsManagerImpl.prototype.reset=function(g){var m=this.findTriggerByNativeConfig(this._triggers,g);m&&this._triggers[m].resetConditions()},RootToolsManagerImpl.prototype.dumpLogBuffer=function(g,m){if(this._circularBuffer){var S={matchedLines:0,totalLines:0},v=this._circularBuffer.dumpLogBuffer(g,this._maxUploadSize,S);if(b.debug4("dumpLogBuffer: dumped %d of %d lines, size of payload: %d",S.matchedLines,S.totalLines,null!=v?v.length:0),this._native){var C=T.Defer();return this._native.log_config.mergeAndDumpLogBuffer(v,g,m,(function(g){return C.resolve(g)})),C.promise()}return T.Resolved(v)}return b.warn("dumpLogBuffer: no log buffer enabled"),T.Rejected()},RootToolsManagerImpl.prototype._triggered=function(g){var m=this,S={compression:_.LogFileCompression.Compress,encoding:_.LogFileEncoding.Base64,encryption:_.LogFileEncryption.Encrypted,maxRotations:0,maxSize:this._maxUploadSize,reverse:!0},v={includeUnsafe:g.includeUnsafe,filter:g.filters.map((function(g){return{component:g.component,level:g.parsedLevel}})),reverse:!0};this.dumpLogBuffer(v,S).then((function(S){return m._send(g,S)}))},RootToolsManagerImpl.prototype.sendBRBEvent=function(g,m){try{if(b.debug2("sendBRBEvent %s",JSON.stringify(g)),null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative){var S={eventType:"uploadBRB",mutualSubmissionType:"call",payload:g},v=void 0!==m?JSON.stringify({userIds:m}):"";this._glue.sendLoggingEventToNative(JSON.stringify(S),v)}}catch(g){b.error("sendBRBEvent %s: %s",g.name,g.message)}},RootToolsManagerImpl.prototype.setBRBCallback=function(g){b.debug2("setBRBCallback"),null!=this._glue?"function"==typeof this._glue.setNativeLoggingEventCallback?this._BRBCallback=g:b.warn("setBRBCallback: RootToolsManagerDelegate missing setNativeLoggingEventCallback method"):b.warn("setBRBCallback: RootToolsManagerDelegate is not set")},RootToolsManagerImpl.prototype.registerListeners=function(){var g=this;null!=this._glue&&"function"==typeof this._glue.setNativeLoggingEventCallback?this._glue.setNativeLoggingEventCallback((function(m,S){return g.handleNativeLoggingEvent(m,S)})):b.warn("registerListeners: RootToolsManagerDelegate missing setNativeLoggingEventCallback method")},RootToolsManagerImpl.prototype.handleNativeLoggingEvent=function(g,m){try{b.debug2("Native Log event message: %s aux: %s",g,m);var S=JSON.parse(g);if(S.eventType&&"uploadBRB"===S.eventType){if("function"!=typeof this._BRBCallback)return void b.warn("BRBCallback not set, ignoring native event");b.debug4("Sending BRB callback: %@",S.payload),this._BRBCallback(S.payload)}else S.eventType&&"jsLogFileConfiguration"===S.eventType&&this.handleLogFileConfigEvent(S)}catch(g){b.error("handleNativeLoggingEvent %s: %s",g.name,g.message)}},RootToolsManagerImpl.prototype.handleLogFileConfigEvent=function(g){if(g.payload){var m=g.payload;if(m.enabled){if(m.chunkSize&&m.flushInterval){var S={chunkSize:m.chunkSize,flushInterval:m.flushInterval,enableThrottling:m.enableThrottling,maxVerbosityLevel:m.maxVerbosityLevel};this.startJsToNativeLogging(S)}}else this.flushDisableJsToNativeLogging()}},RootToolsManagerImpl.prototype.logExternalForDDL=function(g,m){try{if(b.debug2("logExternalForDDL %s %s",g,m),null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative){var S={eventType:"logInSClog",payload:{message:g,parameters:m}};this._glue.sendLoggingEventToNative(JSON.stringify(S),"")}else b.warn("ignoring logExternalForDDL, delegate misconfigured")}catch(g){b.error("logExternalForDDL %s: %s",g.name,g.message)}},RootToolsManagerImpl.prototype.startJsToNativeLogging=function(g){var m=this,S=g.chunkSize,v=g.flushInterval,C=g.enableThrottling,_=this._getVerbosityLevelFromConfig(g.maxVerbosityLevel);if(this._jsToNativeBuffer){if(this._jsToNativeBuffer.capacity()===S&&this._jsToNativeFlushInterval===v&&this._jsToNativeBuffer.throttlingEnabled()===C&&this._jsToNativeBuffer.maxVerbosityLevel()===_)return void b.debug1("Same JS2Native settings received - doing nothing");b.debug1("Reapplying js to native settings"),this.flushDisableJsToNativeLogging()}this._jsToNativeBuffer=new O(S,(function(){m.onJsToNativeBufferReady(m._jsToNativeBuffer)}),C,_),this.setJsToNativeFlushTimeout(v),this._jsToNativeFlushInterval=v,this._jsToNativeBufferHandle=E.LogFactory.instance().addAppender(this._jsToNativeBuffer)},RootToolsManagerImpl.prototype._getVerbosityLevelFromConfig=function(g){return g?E.LogFactory.levelFromString(g):null},RootToolsManagerImpl.prototype.flushDisableJsToNativeLogging=function(){this._jsToNativeBuffer&&this.onJsToNativeBufferReady(this._jsToNativeBuffer),this.plainDisableJsToNativeLogging()},RootToolsManagerImpl.prototype.plainDisableJsToNativeLogging=function(){this.clearJsToNativeFlushTimeout(),this._jsToNativeBufferHandle&&(E.LogFactory.instance().removeAppender(this._jsToNativeBufferHandle),this._jsToNativeBufferHandle=0,this._jsToNativeBuffer=null,b.debug1("Disabling forwarding JS logs to native"))},RootToolsManagerImpl.prototype.onJsToNativeBufferReady=function(g){null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative?(this.clearJsToNativeFlushTimeout(),this.dumpJsToNativeBuffer(g),this.setJsToNativeFlushTimeout(this._jsToNativeFlushInterval)):this.plainDisableJsToNativeLogging()},RootToolsManagerImpl.prototype.dumpJsToNativeBuffer=function(g){if(!g.empty()){var m=g.dumpAndReset(),S={eventType:"writeLogData"};this._glue.sendLoggingEventToNative(JSON.stringify(S),m)}},RootToolsManagerImpl.prototype.clearJsToNativeFlushTimeout=function(){this._jsToNativeFlushTimer&&(clearTimeout(this._jsToNativeFlushTimer),this._jsToNativeFlushTimer=null)},RootToolsManagerImpl.prototype.setJsToNativeFlushTimeout=function(g){var m=this;!this._jsToNativeFlushTimer&&g&&(this._jsToNativeFlushTimer=setTimeout((function(){m._jsToNativeFlushTimer=null,m.onJsToNativeBufferReady(m._jsToNativeBuffer)}),g))},RootToolsManagerImpl.prototype.stopAsyncOperations=function(){this.flushDisableJsToNativeLogging()},RootToolsManagerImpl}();m.RootToolsManager=new N})),A=createCommonjsModule((function(g,m){
/*!
	 *  pii.ts
	 *  AUF
	 *
	 *  Created by Johan Blumenberg on 2017-01-16
	 *  Copyright 2017 Microsoft. All rights reserved.
	 *
	 */
Object.defineProperty(m,"__esModule",{value:!0});var DefaultTagger=function(g){return g},S=!0,v=DefaultTagger,C={},_=0;function addName(g){return C[g]="u"+ ++_}var E,T=/^([0-9][0-9]?):([^<>\*\{\}&'\"\/\\?^`|~\s]+)$/;!function(g){g[g.MSA=1]="MSA",g[g.S4B_Bridge=2]="S4B_Bridge",g[g.PSTN=4]="PSTN",g[g.SkypeId=8]="SkypeId",g[g.Thread=19]="Thread",g[g.LegacyShortCircuit=20]="LegacyShortCircuit",g[g.OneToOneTextMessage=21]="OneToOneTextMessage",g[g.GroupTextMessage=22]="GroupTextMessage",g[g.Bot=28]="Bot",g[g.InternalSkype=48]="InternalSkype"}(E||(E={}));var I=[E.Thread,E.InternalSkype,E.Bot];function enableAnonymization(g){S=g}function useTagger(g){v=g||DefaultTagger}m.enableAnonymization=enableAnonymization,m.useTagger=useTagger,function(g){function untaggedUserName(g){return S?g?C[g]||addName(g):null:g}function UserName(g){var m=untaggedUserName(g);return v(m)}function Mri(g){var m,S=g.match(T);if(S){var C=Number(S[1]),_=S[2];m=-1!=I.indexOf(C)?g:C+":"+untaggedUserName(_)}else m=untaggedUserName(g);return v(m)}function Omit(g){var m;return m=S?"number"==typeof g?19229:"string"==typeof g?g.charAt(0)+"...":null:g,v(m)}g.UserName=UserName,g.Mri=Mri,g.Omit=Omit}(m.pii||(m.pii={}))})),R=createCommonjsModule((function(g,m){
/*!
	 *  index.ts
	 *  AUF
	 *
	 *  Created by Johan Blumenberg on 2016-12-29
	 *  Copyright 2016 Microsoft. All rights reserved.
	 *
	 */
function __export(g){for(var S in g)m.hasOwnProperty(S)||(m[S]=g[S])}Object.defineProperty(m,"__esModule",{value:!0}),__export(_),__export(E),__export(b),__export(I),__export(A)})),P=createCommonjsModule((function(g,m){(function(){var S,v="4.17.21",_=200,E="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",T="Expected a function",I="Invalid `variable` option passed into `_.template`",b="__lodash_hash_undefined__",A=500,R="__lodash_placeholder__",P=1,M=2,w=4,D=1,O=2,N=1,k=2,L=4,F=8,x=16,U=32,V=64,B=128,H=256,$=512,G=30,j="...",q=800,W=16,z=1,K=2,J=3,Y=1/0,Q=9007199254740991,X=17976931348623157e292,Z=NaN,ee=4294967295,te=ee-1,ie=ee>>>1,ne=[["ary",B],["bind",N],["bindKey",k],["curry",F],["curryRight",x],["flip",$],["partial",U],["partialRight",V],["rearg",H]],re="[object Arguments]",se="[object Array]",ae="[object AsyncFunction]",oe="[object Boolean]",le="[object Date]",ce="[object DOMException]",de="[object Error]",he="[object Function]",ue="[object GeneratorFunction]",ge="[object Map]",pe="[object Number]",me="[object Null]",fe="[object Object]",Se="[object Promise]",ve="[object Proxy]",Ce="[object RegExp]",_e="[object Set]",ye="[object String]",Ee="[object Symbol]",Te="[object Undefined]",Ie="[object WeakMap]",be="[object WeakSet]",Ae="[object ArrayBuffer]",Re="[object DataView]",Pe="[object Float32Array]",Me="[object Float64Array]",we="[object Int8Array]",De="[object Int16Array]",Oe="[object Int32Array]",Ne="[object Uint8Array]",ke="[object Uint8ClampedArray]",Le="[object Uint16Array]",Fe="[object Uint32Array]",xe=/\b__p \+= '';/g,Ue=/\b(__p \+=) '' \+/g,Ve=/(__e\(.*?\)|\b__t\)) \+\n'';/g,Be=/&(?:amp|lt|gt|quot|#39);/g,He=/[&<>"']/g,$e=RegExp(Be.source),Ge=RegExp(He.source),je=/<%-([\s\S]+?)%>/g,qe=/<%([\s\S]+?)%>/g,We=/<%=([\s\S]+?)%>/g,ze=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ke=/^\w*$/,Je=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Ye=/[\\^$.*+?()[\]{}|]/g,Qe=RegExp(Ye.source),Xe=/^\s+/,Ze=/\s/,et=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,tt=/\{\n\/\* \[wrapped with (.+)\] \*/,it=/,? & /,nt=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,rt=/[()=,{}\[\]\/\s]/,st=/\\(\\)?/g,at=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,ot=/\w*$/,lt=/^[-+]0x[0-9a-f]+$/i,ct=/^0b[01]+$/i,dt=/^\[object .+?Constructor\]$/,ht=/^0o[0-7]+$/i,ut=/^(?:0|[1-9]\d*)$/,gt=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,pt=/($^)/,mt=/['\n\r\u2028\u2029\\]/g,ft="\\ud800-\\udfff",St="\\u0300-\\u036f"+"\\ufe20-\\ufe2f"+"\\u20d0-\\u20ff",vt="\\u2700-\\u27bf",Ct="a-z\\xdf-\\xf6\\xf8-\\xff",_t="A-Z\\xc0-\\xd6\\xd8-\\xde",yt="\\ufe0e\\ufe0f",Et="\\xac\\xb1\\xd7\\xf7"+"\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf"+"\\u2000-\\u206f"+" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Tt="['’]",It="["+ft+"]",bt="["+Et+"]",At="["+St+"]",Rt="\\d+",Pt="["+vt+"]",Mt="["+Ct+"]",wt="[^"+ft+Et+Rt+vt+Ct+_t+"]",Dt="\\ud83c[\\udffb-\\udfff]",Ot="[^"+ft+"]",Nt="(?:\\ud83c[\\udde6-\\uddff]){2}",kt="[\\ud800-\\udbff][\\udc00-\\udfff]",Lt="["+_t+"]",Ft="\\u200d",xt="(?:"+Mt+"|"+wt+")",Ut="(?:"+Lt+"|"+wt+")",Vt="(?:"+Tt+"(?:d|ll|m|re|s|t|ve))?",Bt="(?:"+Tt+"(?:D|LL|M|RE|S|T|VE))?",Ht="(?:"+At+"|"+Dt+")"+"?",$t="["+yt+"]?",Gt="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",jt="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",qt=$t+Ht+("(?:"+Ft+"(?:"+[Ot,Nt,kt].join("|")+")"+$t+Ht+")*"),Wt="(?:"+[Pt,Nt,kt].join("|")+")"+qt,zt="(?:"+[Ot+At+"?",At,Nt,kt,It].join("|")+")",Kt=RegExp(Tt,"g"),Jt=RegExp(At,"g"),Yt=RegExp(Dt+"(?="+Dt+")|"+zt+qt,"g"),Qt=RegExp([Lt+"?"+Mt+"+"+Vt+"(?="+[bt,Lt,"$"].join("|")+")",Ut+"+"+Bt+"(?="+[bt,Lt+xt,"$"].join("|")+")",Lt+"?"+xt+"+"+Vt,Lt+"+"+Bt,jt,Gt,Rt,Wt].join("|"),"g"),Xt=RegExp("["+Ft+ft+St+yt+"]"),Zt=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,ei=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],ti=-1,ii={};ii[Pe]=ii[Me]=ii[we]=ii[De]=ii[Oe]=ii[Ne]=ii[ke]=ii[Le]=ii[Fe]=!0,ii[re]=ii[se]=ii[Ae]=ii[oe]=ii[Re]=ii[le]=ii[de]=ii[he]=ii[ge]=ii[pe]=ii[fe]=ii[Ce]=ii[_e]=ii[ye]=ii[Ie]=!1;var ni={};ni[re]=ni[se]=ni[Ae]=ni[Re]=ni[oe]=ni[le]=ni[Pe]=ni[Me]=ni[we]=ni[De]=ni[Oe]=ni[ge]=ni[pe]=ni[fe]=ni[Ce]=ni[_e]=ni[ye]=ni[Ee]=ni[Ne]=ni[ke]=ni[Le]=ni[Fe]=!0,ni[de]=ni[he]=ni[Ie]=!1;var ri={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss","Ā":"A","Ă":"A","Ą":"A","ā":"a","ă":"a","ą":"a","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","ć":"c","ĉ":"c","ċ":"c","č":"c","Ď":"D","Đ":"D","ď":"d","đ":"d","Ē":"E","Ĕ":"E","Ė":"E","Ę":"E","Ě":"E","ē":"e","ĕ":"e","ė":"e","ę":"e","ě":"e","Ĝ":"G","Ğ":"G","Ġ":"G","Ģ":"G","ĝ":"g","ğ":"g","ġ":"g","ģ":"g","Ĥ":"H","Ħ":"H","ĥ":"h","ħ":"h","Ĩ":"I","Ī":"I","Ĭ":"I","Į":"I","İ":"I","ĩ":"i","ī":"i","ĭ":"i","į":"i","ı":"i","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","ĸ":"k","Ĺ":"L","Ļ":"L","Ľ":"L","Ŀ":"L","Ł":"L","ĺ":"l","ļ":"l","ľ":"l","ŀ":"l","ł":"l","Ń":"N","Ņ":"N","Ň":"N","Ŋ":"N","ń":"n","ņ":"n","ň":"n","ŋ":"n","Ō":"O","Ŏ":"O","Ő":"O","ō":"o","ŏ":"o","ő":"o","Ŕ":"R","Ŗ":"R","Ř":"R","ŕ":"r","ŗ":"r","ř":"r","Ś":"S","Ŝ":"S","Ş":"S","Š":"S","ś":"s","ŝ":"s","ş":"s","š":"s","Ţ":"T","Ť":"T","Ŧ":"T","ţ":"t","ť":"t","ŧ":"t","Ũ":"U","Ū":"U","Ŭ":"U","Ů":"U","Ű":"U","Ų":"U","ũ":"u","ū":"u","ŭ":"u","ů":"u","ű":"u","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","Ż":"Z","Ž":"Z","ź":"z","ż":"z","ž":"z","Ĳ":"IJ","ĳ":"ij","Œ":"Oe","œ":"oe","ŉ":"'n","ſ":"s"},si={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},ai={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},oi={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},li=parseFloat,ci=parseInt,di="object"==typeof C&&C&&C.Object===Object&&C,hi="object"==typeof self&&self&&self.Object===Object&&self,ui=di||hi||Function("return this")(),gi=m&&!m.nodeType&&m,pi=gi&&g&&!g.nodeType&&g,mi=pi&&pi.exports===gi,fi=mi&&di.process,Si=function(){try{var g=pi&&pi.require&&pi.require("util").types;return g||fi&&fi.binding&&fi.binding("util")}catch(g){}}(),vi=Si&&Si.isArrayBuffer,Ci=Si&&Si.isDate,_i=Si&&Si.isMap,yi=Si&&Si.isRegExp,Ei=Si&&Si.isSet,Ti=Si&&Si.isTypedArray;function apply(g,m,S){switch(S.length){case 0:return g.call(m);case 1:return g.call(m,S[0]);case 2:return g.call(m,S[0],S[1]);case 3:return g.call(m,S[0],S[1],S[2])}return g.apply(m,S)}function arrayAggregator(g,m,S,v){for(var C=-1,_=null==g?0:g.length;++C<_;){var E=g[C];m(v,E,S(E),g)}return v}function arrayEach(g,m){for(var S=-1,v=null==g?0:g.length;++S<v&&!1!==m(g[S],S,g););return g}function arrayEachRight(g,m){for(var S=null==g?0:g.length;S--&&!1!==m(g[S],S,g););return g}function arrayEvery(g,m){for(var S=-1,v=null==g?0:g.length;++S<v;)if(!m(g[S],S,g))return!1;return!0}function arrayFilter(g,m){for(var S=-1,v=null==g?0:g.length,C=0,_=[];++S<v;){var E=g[S];m(E,S,g)&&(_[C++]=E)}return _}function arrayIncludes(g,m){return!!(null==g?0:g.length)&&baseIndexOf(g,m,0)>-1}function arrayIncludesWith(g,m,S){for(var v=-1,C=null==g?0:g.length;++v<C;)if(S(m,g[v]))return!0;return!1}function arrayMap(g,m){for(var S=-1,v=null==g?0:g.length,C=Array(v);++S<v;)C[S]=m(g[S],S,g);return C}function arrayPush(g,m){for(var S=-1,v=m.length,C=g.length;++S<v;)g[C+S]=m[S];return g}function arrayReduce(g,m,S,v){var C=-1,_=null==g?0:g.length;for(v&&_&&(S=g[++C]);++C<_;)S=m(S,g[C],C,g);return S}function arrayReduceRight(g,m,S,v){var C=null==g?0:g.length;for(v&&C&&(S=g[--C]);C--;)S=m(S,g[C],C,g);return S}function arraySome(g,m){for(var S=-1,v=null==g?0:g.length;++S<v;)if(m(g[S],S,g))return!0;return!1}var Ii=baseProperty("length");function asciiToArray(g){return g.split("")}function asciiWords(g){return g.match(nt)||[]}function baseFindKey(g,m,S){var v;return S(g,(function(g,S,C){if(m(g,S,C))return v=S,!1})),v}function baseFindIndex(g,m,S,v){for(var C=g.length,_=S+(v?1:-1);v?_--:++_<C;)if(m(g[_],_,g))return _;return-1}function baseIndexOf(g,m,S){return m==m?strictIndexOf(g,m,S):baseFindIndex(g,baseIsNaN,S)}function baseIndexOfWith(g,m,S,v){for(var C=S-1,_=g.length;++C<_;)if(v(g[C],m))return C;return-1}function baseIsNaN(g){return g!=g}function baseMean(g,m){var S=null==g?0:g.length;return S?baseSum(g,m)/S:Z}function baseProperty(g){return function(m){return null==m?S:m[g]}}function basePropertyOf(g){return function(m){return null==g?S:g[m]}}function baseReduce(g,m,S,v,C){return C(g,(function(g,C,_){S=v?(v=!1,g):m(S,g,C,_)})),S}function baseSortBy(g,m){var S=g.length;for(g.sort(m);S--;)g[S]=g[S].value;return g}function baseSum(g,m){for(var v,C=-1,_=g.length;++C<_;){var E=m(g[C]);E!==S&&(v=v===S?E:v+E)}return v}function baseTimes(g,m){for(var S=-1,v=Array(g);++S<g;)v[S]=m(S);return v}function baseToPairs(g,m){return arrayMap(m,(function(m){return[m,g[m]]}))}function baseTrim(g){return g?g.slice(0,trimmedEndIndex(g)+1).replace(Xe,""):g}function baseUnary(g){return function(m){return g(m)}}function baseValues(g,m){return arrayMap(m,(function(m){return g[m]}))}function cacheHas(g,m){return g.has(m)}function charsStartIndex(g,m){for(var S=-1,v=g.length;++S<v&&baseIndexOf(m,g[S],0)>-1;);return S}function charsEndIndex(g,m){for(var S=g.length;S--&&baseIndexOf(m,g[S],0)>-1;);return S}function countHolders(g,m){for(var S=g.length,v=0;S--;)g[S]===m&&++v;return v}var bi=basePropertyOf(ri),Ai=basePropertyOf(si);function escapeStringChar(g){return"\\"+oi[g]}function getValue(g,m){return null==g?S:g[m]}function hasUnicode(g){return Xt.test(g)}function hasUnicodeWord(g){return Zt.test(g)}function iteratorToArray(g){for(var m,S=[];!(m=g.next()).done;)S.push(m.value);return S}function mapToArray(g){var m=-1,S=Array(g.size);return g.forEach((function(g,v){S[++m]=[v,g]})),S}function overArg(g,m){return function(S){return g(m(S))}}function replaceHolders(g,m){for(var S=-1,v=g.length,C=0,_=[];++S<v;){var E=g[S];E!==m&&E!==R||(g[S]=R,_[C++]=S)}return _}function setToArray(g){var m=-1,S=Array(g.size);return g.forEach((function(g){S[++m]=g})),S}function setToPairs(g){var m=-1,S=Array(g.size);return g.forEach((function(g){S[++m]=[g,g]})),S}function strictIndexOf(g,m,S){for(var v=S-1,C=g.length;++v<C;)if(g[v]===m)return v;return-1}function strictLastIndexOf(g,m,S){for(var v=S+1;v--;)if(g[v]===m)return v;return v}function stringSize(g){return hasUnicode(g)?unicodeSize(g):Ii(g)}function stringToArray(g){return hasUnicode(g)?unicodeToArray(g):asciiToArray(g)}function trimmedEndIndex(g){for(var m=g.length;m--&&Ze.test(g.charAt(m)););return m}var Ri=basePropertyOf(ai);function unicodeSize(g){for(var m=Yt.lastIndex=0;Yt.test(g);)++m;return m}function unicodeToArray(g){return g.match(Yt)||[]}function unicodeWords(g){return g.match(Qt)||[]}var Pi=function runInContext(g){var m,C=(g=null==g?ui:Mi.defaults(ui.Object(),g,Mi.pick(ui,ei))).Array,Ze=g.Date,nt=g.Error,ft=g.Function,St=g.Math,vt=g.Object,Ct=g.RegExp,_t=g.String,yt=g.TypeError,Et=C.prototype,Tt=ft.prototype,It=vt.prototype,bt=g["__core-js_shared__"],At=Tt.toString,Rt=It.hasOwnProperty,Pt=0,Mt=(m=/[^.]+$/.exec(bt&&bt.keys&&bt.keys.IE_PROTO||""))?"Symbol(src)_1."+m:"",wt=It.toString,Dt=At.call(vt),Ot=ui._,Nt=Ct("^"+At.call(Rt).replace(Ye,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),kt=mi?g.Buffer:S,Lt=g.Symbol,Ft=g.Uint8Array,xt=kt?kt.allocUnsafe:S,Ut=overArg(vt.getPrototypeOf,vt),Vt=vt.create,Bt=It.propertyIsEnumerable,Ht=Et.splice,$t=Lt?Lt.isConcatSpreadable:S,Gt=Lt?Lt.iterator:S,jt=Lt?Lt.toStringTag:S,qt=function(){try{var g=getNative(vt,"defineProperty");return g({},"",{}),g}catch(g){}}(),Wt=g.clearTimeout!==ui.clearTimeout&&g.clearTimeout,zt=Ze&&Ze.now!==ui.Date.now&&Ze.now,Yt=g.setTimeout!==ui.setTimeout&&g.setTimeout,Qt=St.ceil,Xt=St.floor,Zt=vt.getOwnPropertySymbols,ri=kt?kt.isBuffer:S,si=g.isFinite,ai=Et.join,oi=overArg(vt.keys,vt),di=St.max,hi=St.min,gi=Ze.now,pi=g.parseInt,fi=St.random,Si=Et.reverse,Ii=getNative(g,"DataView"),Pi=getNative(g,"Map"),wi=getNative(g,"Promise"),Di=getNative(g,"Set"),Oi=getNative(g,"WeakMap"),Ni=getNative(vt,"create"),ki=Oi&&new Oi,Li={},Fi=toSource(Ii),xi=toSource(Pi),Ui=toSource(wi),Vi=toSource(Di),Bi=toSource(Oi),Hi=Lt?Lt.prototype:S,$i=Hi?Hi.valueOf:S,Gi=Hi?Hi.toString:S;function lodash(g){if(isObjectLike(g)&&!Kn(g)&&!(g instanceof LazyWrapper)){if(g instanceof LodashWrapper)return g;if(Rt.call(g,"__wrapped__"))return wrapperClone(g)}return new LodashWrapper(g)}var ji=function(){function object(){}return function(g){if(!isObject(g))return{};if(Vt)return Vt(g);object.prototype=g;var m=new object;return object.prototype=S,m}}();function baseLodash(){}function LodashWrapper(g,m){this.__wrapped__=g,this.__actions__=[],this.__chain__=!!m,this.__index__=0,this.__values__=S}function LazyWrapper(g){this.__wrapped__=g,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=ee,this.__views__=[]}function lazyClone(){var g=new LazyWrapper(this.__wrapped__);return g.__actions__=copyArray(this.__actions__),g.__dir__=this.__dir__,g.__filtered__=this.__filtered__,g.__iteratees__=copyArray(this.__iteratees__),g.__takeCount__=this.__takeCount__,g.__views__=copyArray(this.__views__),g}function lazyReverse(){if(this.__filtered__){var g=new LazyWrapper(this);g.__dir__=-1,g.__filtered__=!0}else(g=this.clone()).__dir__*=-1;return g}function lazyValue(){var g=this.__wrapped__.value(),m=this.__dir__,S=Kn(g),v=m<0,C=S?g.length:0,_=getView(0,C,this.__views__),E=_.start,T=_.end,I=T-E,b=v?T:E-1,A=this.__iteratees__,R=A.length,P=0,M=hi(I,this.__takeCount__);if(!S||!v&&C==I&&M==I)return baseWrapperValue(g,this.__actions__);var w=[];e:for(;I--&&P<M;){for(var D=-1,O=g[b+=m];++D<R;){var N=A[D],k=N.iteratee,L=N.type,F=k(O);if(L==K)O=F;else if(!F){if(L==z)continue e;break e}}w[P++]=O}return w}function Hash(g){var m=-1,S=null==g?0:g.length;for(this.clear();++m<S;){var v=g[m];this.set(v[0],v[1])}}function hashClear(){this.__data__=Ni?Ni(null):{},this.size=0}function hashDelete(g){var m=this.has(g)&&delete this.__data__[g];return this.size-=m?1:0,m}function hashGet(g){var m=this.__data__;if(Ni){var v=m[g];return v===b?S:v}return Rt.call(m,g)?m[g]:S}function hashHas(g){var m=this.__data__;return Ni?m[g]!==S:Rt.call(m,g)}function hashSet(g,m){var v=this.__data__;return this.size+=this.has(g)?0:1,v[g]=Ni&&m===S?b:m,this}function ListCache(g){var m=-1,S=null==g?0:g.length;for(this.clear();++m<S;){var v=g[m];this.set(v[0],v[1])}}function listCacheClear(){this.__data__=[],this.size=0}function listCacheDelete(g){var m=this.__data__,S=assocIndexOf(m,g);return!(S<0)&&(S==m.length-1?m.pop():Ht.call(m,S,1),--this.size,!0)}function listCacheGet(g){var m=this.__data__,v=assocIndexOf(m,g);return v<0?S:m[v][1]}function listCacheHas(g){return assocIndexOf(this.__data__,g)>-1}function listCacheSet(g,m){var S=this.__data__,v=assocIndexOf(S,g);return v<0?(++this.size,S.push([g,m])):S[v][1]=m,this}function MapCache(g){var m=-1,S=null==g?0:g.length;for(this.clear();++m<S;){var v=g[m];this.set(v[0],v[1])}}function mapCacheClear(){this.size=0,this.__data__={hash:new Hash,map:new(Pi||ListCache),string:new Hash}}function mapCacheDelete(g){var m=getMapData(this,g).delete(g);return this.size-=m?1:0,m}function mapCacheGet(g){return getMapData(this,g).get(g)}function mapCacheHas(g){return getMapData(this,g).has(g)}function mapCacheSet(g,m){var S=getMapData(this,g),v=S.size;return S.set(g,m),this.size+=S.size==v?0:1,this}function SetCache(g){var m=-1,S=null==g?0:g.length;for(this.__data__=new MapCache;++m<S;)this.add(g[m])}function setCacheAdd(g){return this.__data__.set(g,b),this}function setCacheHas(g){return this.__data__.has(g)}function Stack(g){var m=this.__data__=new ListCache(g);this.size=m.size}function stackClear(){this.__data__=new ListCache,this.size=0}function stackDelete(g){var m=this.__data__,S=m.delete(g);return this.size=m.size,S}function stackGet(g){return this.__data__.get(g)}function stackHas(g){return this.__data__.has(g)}function stackSet(g,m){var S=this.__data__;if(S instanceof ListCache){var v=S.__data__;if(!Pi||v.length<_-1)return v.push([g,m]),this.size=++S.size,this;S=this.__data__=new MapCache(v)}return S.set(g,m),this.size=S.size,this}function arrayLikeKeys(g,m){var S=Kn(g),v=!S&&zn(g),C=!S&&!v&&Yn(g),_=!S&&!v&&!C&&tr(g),E=S||v||C||_,T=E?baseTimes(g.length,_t):[],I=T.length;for(var b in g)!m&&!Rt.call(g,b)||E&&("length"==b||C&&("offset"==b||"parent"==b)||_&&("buffer"==b||"byteLength"==b||"byteOffset"==b)||isIndex(b,I))||T.push(b);return T}function arraySample(g){var m=g.length;return m?g[baseRandom(0,m-1)]:S}function arraySampleSize(g,m){return shuffleSelf(copyArray(g),baseClamp(m,0,g.length))}function arrayShuffle(g){return shuffleSelf(copyArray(g))}function assignMergeValue(g,m,v){(v!==S&&!eq(g[m],v)||v===S&&!(m in g))&&baseAssignValue(g,m,v)}function assignValue(g,m,v){var C=g[m];Rt.call(g,m)&&eq(C,v)&&(v!==S||m in g)||baseAssignValue(g,m,v)}function assocIndexOf(g,m){for(var S=g.length;S--;)if(eq(g[S][0],m))return S;return-1}function baseAggregator(g,m,S,v){return qi(g,(function(g,C,_){m(v,g,S(g),_)})),v}function baseAssign(g,m){return g&&copyObject(m,keys(m),g)}function baseAssignIn(g,m){return g&&copyObject(m,keysIn(m),g)}function baseAssignValue(g,m,S){"__proto__"==m&&qt?qt(g,m,{configurable:!0,enumerable:!0,value:S,writable:!0}):g[m]=S}function baseAt(g,m){for(var v=-1,_=m.length,E=C(_),T=null==g;++v<_;)E[v]=T?S:get(g,m[v]);return E}function baseClamp(g,m,v){return g==g&&(v!==S&&(g=g<=v?g:v),m!==S&&(g=g>=m?g:m)),g}function baseClone(g,m,v,C,_,E){var T,I=m&P,b=m&M,A=m&w;if(v&&(T=_?v(g,C,_,E):v(g)),T!==S)return T;if(!isObject(g))return g;var R=Kn(g);if(R){if(T=initCloneArray(g),!I)return copyArray(g,T)}else{var D=rn(g),O=D==he||D==ue;if(Yn(g))return cloneBuffer(g,I);if(D==fe||D==re||O&&!_){if(T=b||O?{}:initCloneObject(g),!I)return b?copySymbolsIn(g,baseAssignIn(T,g)):copySymbols(g,baseAssign(T,g))}else{if(!ni[D])return _?g:{};T=initCloneByTag(g,D,I)}}E||(E=new Stack);var N=E.get(g);if(N)return N;E.set(g,T),er(g)?g.forEach((function(S){T.add(baseClone(S,m,v,S,g,E))})):Xn(g)&&g.forEach((function(S,C){T.set(C,baseClone(S,m,v,C,g,E))}));var k=R?S:(A?b?getAllKeysIn:getAllKeys:b?keysIn:keys)(g);return arrayEach(k||g,(function(S,C){k&&(S=g[C=S]),assignValue(T,C,baseClone(S,m,v,C,g,E))})),T}function baseConforms(g){var m=keys(g);return function(S){return baseConformsTo(S,g,m)}}function baseConformsTo(g,m,v){var C=v.length;if(null==g)return!C;for(g=vt(g);C--;){var _=v[C],E=m[_],T=g[_];if(T===S&&!(_ in g)||!E(T))return!1}return!0}function baseDelay(g,m,v){if("function"!=typeof g)throw new yt(T);return on((function(){g.apply(S,v)}),m)}function baseDifference(g,m,S,v){var C=-1,E=arrayIncludes,T=!0,I=g.length,b=[],A=m.length;if(!I)return b;S&&(m=arrayMap(m,baseUnary(S))),v?(E=arrayIncludesWith,T=!1):m.length>=_&&(E=cacheHas,T=!1,m=new SetCache(m));e:for(;++C<I;){var R=g[C],P=null==S?R:S(R);if(R=v||0!==R?R:0,T&&P==P){for(var M=A;M--;)if(m[M]===P)continue e;b.push(R)}else E(m,P,v)||b.push(R)}return b}lodash.templateSettings={escape:je,evaluate:qe,interpolate:We,variable:"",imports:{_:lodash}},lodash.prototype=baseLodash.prototype,lodash.prototype.constructor=lodash,LodashWrapper.prototype=ji(baseLodash.prototype),LodashWrapper.prototype.constructor=LodashWrapper,LazyWrapper.prototype=ji(baseLodash.prototype),LazyWrapper.prototype.constructor=LazyWrapper,Hash.prototype.clear=hashClear,Hash.prototype.delete=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet,ListCache.prototype.clear=listCacheClear,ListCache.prototype.delete=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet,MapCache.prototype.clear=mapCacheClear,MapCache.prototype.delete=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet,SetCache.prototype.add=SetCache.prototype.push=setCacheAdd,SetCache.prototype.has=setCacheHas,Stack.prototype.clear=stackClear,Stack.prototype.delete=stackDelete,Stack.prototype.get=stackGet,Stack.prototype.has=stackHas,Stack.prototype.set=stackSet;var qi=createBaseEach(baseForOwn),Wi=createBaseEach(baseForOwnRight,!0);function baseEvery(g,m){var S=!0;return qi(g,(function(g,v,C){return S=!!m(g,v,C)})),S}function baseExtremum(g,m,v){for(var C=-1,_=g.length;++C<_;){var E=g[C],T=m(E);if(null!=T&&(I===S?T==T&&!isSymbol(T):v(T,I)))var I=T,b=E}return b}function baseFill(g,m,v,C){var _=g.length;for((v=toInteger(v))<0&&(v=-v>_?0:_+v),(C=C===S||C>_?_:toInteger(C))<0&&(C+=_),C=v>C?0:toLength(C);v<C;)g[v++]=m;return g}function baseFilter(g,m){var S=[];return qi(g,(function(g,v,C){m(g,v,C)&&S.push(g)})),S}function baseFlatten(g,m,S,v,C){var _=-1,E=g.length;for(S||(S=isFlattenable),C||(C=[]);++_<E;){var T=g[_];m>0&&S(T)?m>1?baseFlatten(T,m-1,S,v,C):arrayPush(C,T):v||(C[C.length]=T)}return C}var zi=createBaseFor(),Ki=createBaseFor(!0);function baseForOwn(g,m){return g&&zi(g,m,keys)}function baseForOwnRight(g,m){return g&&Ki(g,m,keys)}function baseFunctions(g,m){return arrayFilter(m,(function(m){return isFunction(g[m])}))}function baseGet(g,m){for(var v=0,C=(m=castPath(m,g)).length;null!=g&&v<C;)g=g[toKey(m[v++])];return v&&v==C?g:S}function baseGetAllKeys(g,m,S){var v=m(g);return Kn(g)?v:arrayPush(v,S(g))}function baseGetTag(g){return null==g?g===S?Te:me:jt&&jt in vt(g)?getRawTag(g):objectToString(g)}function baseGt(g,m){return g>m}function baseHas(g,m){return null!=g&&Rt.call(g,m)}function baseHasIn(g,m){return null!=g&&m in vt(g)}function baseInRange(g,m,S){return g>=hi(m,S)&&g<di(m,S)}function baseIntersection(g,m,v){for(var _=v?arrayIncludesWith:arrayIncludes,E=g[0].length,T=g.length,I=T,b=C(T),A=1/0,R=[];I--;){var P=g[I];I&&m&&(P=arrayMap(P,baseUnary(m))),A=hi(P.length,A),b[I]=!v&&(m||E>=120&&P.length>=120)?new SetCache(I&&P):S}P=g[0];var M=-1,w=b[0];e:for(;++M<E&&R.length<A;){var D=P[M],O=m?m(D):D;if(D=v||0!==D?D:0,!(w?cacheHas(w,O):_(R,O,v))){for(I=T;--I;){var N=b[I];if(!(N?cacheHas(N,O):_(g[I],O,v)))continue e}w&&w.push(O),R.push(D)}}return R}function baseInverter(g,m,S,v){return baseForOwn(g,(function(g,C,_){m(v,S(g),C,_)})),v}function baseInvoke(g,m,v){var C=null==(g=parent(g,m=castPath(m,g)))?g:g[toKey(last(m))];return null==C?S:apply(C,g,v)}function baseIsArguments(g){return isObjectLike(g)&&baseGetTag(g)==re}function baseIsArrayBuffer(g){return isObjectLike(g)&&baseGetTag(g)==Ae}function baseIsDate(g){return isObjectLike(g)&&baseGetTag(g)==le}function baseIsEqual(g,m,S,v,C){return g===m||(null==g||null==m||!isObjectLike(g)&&!isObjectLike(m)?g!=g&&m!=m:baseIsEqualDeep(g,m,S,v,baseIsEqual,C))}function baseIsEqualDeep(g,m,S,v,C,_){var E=Kn(g),T=Kn(m),I=E?se:rn(g),b=T?se:rn(m),A=(I=I==re?fe:I)==fe,R=(b=b==re?fe:b)==fe,P=I==b;if(P&&Yn(g)){if(!Yn(m))return!1;E=!0,A=!1}if(P&&!A)return _||(_=new Stack),E||tr(g)?equalArrays(g,m,S,v,C,_):equalByTag(g,m,I,S,v,C,_);if(!(S&D)){var M=A&&Rt.call(g,"__wrapped__"),w=R&&Rt.call(m,"__wrapped__");if(M||w){var O=M?g.value():g,N=w?m.value():m;return _||(_=new Stack),C(O,N,S,v,_)}}return!!P&&(_||(_=new Stack),equalObjects(g,m,S,v,C,_))}function baseIsMap(g){return isObjectLike(g)&&rn(g)==ge}function baseIsMatch(g,m,v,C){var _=v.length,E=_,T=!C;if(null==g)return!E;for(g=vt(g);_--;){var I=v[_];if(T&&I[2]?I[1]!==g[I[0]]:!(I[0]in g))return!1}for(;++_<E;){var b=(I=v[_])[0],A=g[b],R=I[1];if(T&&I[2]){if(A===S&&!(b in g))return!1}else{var P=new Stack;if(C)var M=C(A,R,b,g,m,P);if(!(M===S?baseIsEqual(R,A,D|O,C,P):M))return!1}}return!0}function baseIsNative(g){return!(!isObject(g)||isMasked(g))&&(isFunction(g)?Nt:dt).test(toSource(g))}function baseIsRegExp(g){return isObjectLike(g)&&baseGetTag(g)==Ce}function baseIsSet(g){return isObjectLike(g)&&rn(g)==_e}function baseIsTypedArray(g){return isObjectLike(g)&&isLength(g.length)&&!!ii[baseGetTag(g)]}function baseIteratee(g){return"function"==typeof g?g:null==g?identity:"object"==typeof g?Kn(g)?baseMatchesProperty(g[0],g[1]):baseMatches(g):property(g)}function baseKeys(g){if(!isPrototype(g))return oi(g);var m=[];for(var S in vt(g))Rt.call(g,S)&&"constructor"!=S&&m.push(S);return m}function baseKeysIn(g){if(!isObject(g))return nativeKeysIn(g);var m=isPrototype(g),S=[];for(var v in g)("constructor"!=v||!m&&Rt.call(g,v))&&S.push(v);return S}function baseLt(g,m){return g<m}function baseMap(g,m){var S=-1,v=isArrayLike(g)?C(g.length):[];return qi(g,(function(g,C,_){v[++S]=m(g,C,_)})),v}function baseMatches(g){var m=getMatchData(g);return 1==m.length&&m[0][2]?matchesStrictComparable(m[0][0],m[0][1]):function(S){return S===g||baseIsMatch(S,g,m)}}function baseMatchesProperty(g,m){return isKey(g)&&isStrictComparable(m)?matchesStrictComparable(toKey(g),m):function(v){var C=get(v,g);return C===S&&C===m?hasIn(v,g):baseIsEqual(m,C,D|O)}}function baseMerge(g,m,v,C,_){g!==m&&zi(m,(function(E,T){if(_||(_=new Stack),isObject(E))baseMergeDeep(g,m,T,v,baseMerge,C,_);else{var I=C?C(safeGet(g,T),E,T+"",g,m,_):S;I===S&&(I=E),assignMergeValue(g,T,I)}}),keysIn)}function baseMergeDeep(g,m,v,C,_,E,T){var I=safeGet(g,v),b=safeGet(m,v),A=T.get(b);if(A)assignMergeValue(g,v,A);else{var R=E?E(I,b,v+"",g,m,T):S,P=R===S;if(P){var M=Kn(b),w=!M&&Yn(b),D=!M&&!w&&tr(b);R=b,M||w||D?Kn(I)?R=I:isArrayLikeObject(I)?R=copyArray(I):w?(P=!1,R=cloneBuffer(b,!0)):D?(P=!1,R=cloneTypedArray(b,!0)):R=[]:isPlainObject(b)||zn(b)?(R=I,zn(I)?R=toPlainObject(I):isObject(I)&&!isFunction(I)||(R=initCloneObject(b))):P=!1}P&&(T.set(b,R),_(R,b,C,E,T),T.delete(b)),assignMergeValue(g,v,R)}}function baseNth(g,m){var v=g.length;if(v)return isIndex(m+=m<0?v:0,v)?g[m]:S}function baseOrderBy(g,m,S){m=m.length?arrayMap(m,(function(g){return Kn(g)?function(m){return baseGet(m,1===g.length?g[0]:g)}:g})):[identity];var v=-1;m=arrayMap(m,baseUnary(getIteratee()));var C=baseMap(g,(function(g,S,C){var _=arrayMap(m,(function(m){return m(g)}));return{criteria:_,index:++v,value:g}}));return baseSortBy(C,(function(g,m){return compareMultiple(g,m,S)}))}function basePick(g,m){return basePickBy(g,m,(function(m,S){return hasIn(g,S)}))}function basePickBy(g,m,S){for(var v=-1,C=m.length,_={};++v<C;){var E=m[v],T=baseGet(g,E);S(T,E)&&baseSet(_,castPath(E,g),T)}return _}function basePropertyDeep(g){return function(m){return baseGet(m,g)}}function basePullAll(g,m,S,v){var C=v?baseIndexOfWith:baseIndexOf,_=-1,E=m.length,T=g;for(g===m&&(m=copyArray(m)),S&&(T=arrayMap(g,baseUnary(S)));++_<E;)for(var I=0,b=m[_],A=S?S(b):b;(I=C(T,A,I,v))>-1;)T!==g&&Ht.call(T,I,1),Ht.call(g,I,1);return g}function basePullAt(g,m){for(var S=g?m.length:0,v=S-1;S--;){var C=m[S];if(S==v||C!==_){var _=C;isIndex(C)?Ht.call(g,C,1):baseUnset(g,C)}}return g}function baseRandom(g,m){return g+Xt(fi()*(m-g+1))}function baseRange(g,m,S,v){for(var _=-1,E=di(Qt((m-g)/(S||1)),0),T=C(E);E--;)T[v?E:++_]=g,g+=S;return T}function baseRepeat(g,m){var S="";if(!g||m<1||m>Q)return S;do{m%2&&(S+=g),(m=Xt(m/2))&&(g+=g)}while(m);return S}function baseRest(g,m){return ln(overRest(g,m,identity),g+"")}function baseSample(g){return arraySample(values(g))}function baseSampleSize(g,m){var S=values(g);return shuffleSelf(S,baseClamp(m,0,S.length))}function baseSet(g,m,v,C){if(!isObject(g))return g;for(var _=-1,E=(m=castPath(m,g)).length,T=E-1,I=g;null!=I&&++_<E;){var b=toKey(m[_]),A=v;if("__proto__"===b||"constructor"===b||"prototype"===b)return g;if(_!=T){var R=I[b];(A=C?C(R,b,I):S)===S&&(A=isObject(R)?R:isIndex(m[_+1])?[]:{})}assignValue(I,b,A),I=I[b]}return g}var Ji=ki?function(g,m){return ki.set(g,m),g}:identity,Yi=qt?function(g,m){return qt(g,"toString",{configurable:!0,enumerable:!1,value:constant(m),writable:!0})}:identity;function baseShuffle(g){return shuffleSelf(values(g))}function baseSlice(g,m,S){var v=-1,_=g.length;m<0&&(m=-m>_?0:_+m),(S=S>_?_:S)<0&&(S+=_),_=m>S?0:S-m>>>0,m>>>=0;for(var E=C(_);++v<_;)E[v]=g[v+m];return E}function baseSome(g,m){var S;return qi(g,(function(g,v,C){return!(S=m(g,v,C))})),!!S}function baseSortedIndex(g,m,S){var v=0,C=null==g?v:g.length;if("number"==typeof m&&m==m&&C<=ie){for(;v<C;){var _=v+C>>>1,E=g[_];null!==E&&!isSymbol(E)&&(S?E<=m:E<m)?v=_+1:C=_}return C}return baseSortedIndexBy(g,m,identity,S)}function baseSortedIndexBy(g,m,v,C){var _=0,E=null==g?0:g.length;if(0===E)return 0;for(var T=(m=v(m))!=m,I=null===m,b=isSymbol(m),A=m===S;_<E;){var R=Xt((_+E)/2),P=v(g[R]),M=P!==S,w=null===P,D=P==P,O=isSymbol(P);if(T)var N=C||D;else N=A?D&&(C||M):I?D&&M&&(C||!w):b?D&&M&&!w&&(C||!O):!w&&!O&&(C?P<=m:P<m);N?_=R+1:E=R}return hi(E,te)}function baseSortedUniq(g,m){for(var S=-1,v=g.length,C=0,_=[];++S<v;){var E=g[S],T=m?m(E):E;if(!S||!eq(T,I)){var I=T;_[C++]=0===E?0:E}}return _}function baseToNumber(g){return"number"==typeof g?g:isSymbol(g)?Z:+g}function baseToString(g){if("string"==typeof g)return g;if(Kn(g))return arrayMap(g,baseToString)+"";if(isSymbol(g))return Gi?Gi.call(g):"";var m=g+"";return"0"==m&&1/g==-Y?"-0":m}function baseUniq(g,m,S){var v=-1,C=arrayIncludes,E=g.length,T=!0,I=[],b=I;if(S)T=!1,C=arrayIncludesWith;else if(E>=_){var A=m?null:Zi(g);if(A)return setToArray(A);T=!1,C=cacheHas,b=new SetCache}else b=m?[]:I;e:for(;++v<E;){var R=g[v],P=m?m(R):R;if(R=S||0!==R?R:0,T&&P==P){for(var M=b.length;M--;)if(b[M]===P)continue e;m&&b.push(P),I.push(R)}else C(b,P,S)||(b!==I&&b.push(P),I.push(R))}return I}function baseUnset(g,m){return null==(g=parent(g,m=castPath(m,g)))||delete g[toKey(last(m))]}function baseUpdate(g,m,S,v){return baseSet(g,m,S(baseGet(g,m)),v)}function baseWhile(g,m,S,v){for(var C=g.length,_=v?C:-1;(v?_--:++_<C)&&m(g[_],_,g););return S?baseSlice(g,v?0:_,v?_+1:C):baseSlice(g,v?_+1:0,v?C:_)}function baseWrapperValue(g,m){var S=g;return S instanceof LazyWrapper&&(S=S.value()),arrayReduce(m,(function(g,m){return m.func.apply(m.thisArg,arrayPush([g],m.args))}),S)}function baseXor(g,m,S){var v=g.length;if(v<2)return v?baseUniq(g[0]):[];for(var _=-1,E=C(v);++_<v;)for(var T=g[_],I=-1;++I<v;)I!=_&&(E[_]=baseDifference(E[_]||T,g[I],m,S));return baseUniq(baseFlatten(E,1),m,S)}function baseZipObject(g,m,v){for(var C=-1,_=g.length,E=m.length,T={};++C<_;){var I=C<E?m[C]:S;v(T,g[C],I)}return T}function castArrayLikeObject(g){return isArrayLikeObject(g)?g:[]}function castFunction(g){return"function"==typeof g?g:identity}function castPath(g,m){return Kn(g)?g:isKey(g,m)?[g]:cn(toString(g))}var Qi=baseRest;function castSlice(g,m,v){var C=g.length;return v=v===S?C:v,!m&&v>=C?g:baseSlice(g,m,v)}var Xi=Wt||function(g){return ui.clearTimeout(g)};function cloneBuffer(g,m){if(m)return g.slice();var S=g.length,v=xt?xt(S):new g.constructor(S);return g.copy(v),v}function cloneArrayBuffer(g){var m=new g.constructor(g.byteLength);return new Ft(m).set(new Ft(g)),m}function cloneDataView(g,m){var S=m?cloneArrayBuffer(g.buffer):g.buffer;return new g.constructor(S,g.byteOffset,g.byteLength)}function cloneRegExp(g){var m=new g.constructor(g.source,ot.exec(g));return m.lastIndex=g.lastIndex,m}function cloneSymbol(g){return $i?vt($i.call(g)):{}}function cloneTypedArray(g,m){var S=m?cloneArrayBuffer(g.buffer):g.buffer;return new g.constructor(S,g.byteOffset,g.length)}function compareAscending(g,m){if(g!==m){var v=g!==S,C=null===g,_=g==g,E=isSymbol(g),T=m!==S,I=null===m,b=m==m,A=isSymbol(m);if(!I&&!A&&!E&&g>m||E&&T&&b&&!I&&!A||C&&T&&b||!v&&b||!_)return 1;if(!C&&!E&&!A&&g<m||A&&v&&_&&!C&&!E||I&&v&&_||!T&&_||!b)return-1}return 0}function compareMultiple(g,m,S){for(var v=-1,C=g.criteria,_=m.criteria,E=C.length,T=S.length;++v<E;){var I=compareAscending(C[v],_[v]);if(I)return v>=T?I:I*("desc"==S[v]?-1:1)}return g.index-m.index}function composeArgs(g,m,S,v){for(var _=-1,E=g.length,T=S.length,I=-1,b=m.length,A=di(E-T,0),R=C(b+A),P=!v;++I<b;)R[I]=m[I];for(;++_<T;)(P||_<E)&&(R[S[_]]=g[_]);for(;A--;)R[I++]=g[_++];return R}function composeArgsRight(g,m,S,v){for(var _=-1,E=g.length,T=-1,I=S.length,b=-1,A=m.length,R=di(E-I,0),P=C(R+A),M=!v;++_<R;)P[_]=g[_];for(var w=_;++b<A;)P[w+b]=m[b];for(;++T<I;)(M||_<E)&&(P[w+S[T]]=g[_++]);return P}function copyArray(g,m){var S=-1,v=g.length;for(m||(m=C(v));++S<v;)m[S]=g[S];return m}function copyObject(g,m,v,C){var _=!v;v||(v={});for(var E=-1,T=m.length;++E<T;){var I=m[E],b=C?C(v[I],g[I],I,v,g):S;b===S&&(b=g[I]),_?baseAssignValue(v,I,b):assignValue(v,I,b)}return v}function copySymbols(g,m){return copyObject(g,tn(g),m)}function copySymbolsIn(g,m){return copyObject(g,nn(g),m)}function createAggregator(g,m){return function(S,v){var C=Kn(S)?arrayAggregator:baseAggregator,_=m?m():{};return C(S,g,getIteratee(v,2),_)}}function createAssigner(g){return baseRest((function(m,v){var C=-1,_=v.length,E=_>1?v[_-1]:S,T=_>2?v[2]:S;for(E=g.length>3&&"function"==typeof E?(_--,E):S,T&&isIterateeCall(v[0],v[1],T)&&(E=_<3?S:E,_=1),m=vt(m);++C<_;){var I=v[C];I&&g(m,I,C,E)}return m}))}function createBaseEach(g,m){return function(S,v){if(null==S)return S;if(!isArrayLike(S))return g(S,v);for(var C=S.length,_=m?C:-1,E=vt(S);(m?_--:++_<C)&&!1!==v(E[_],_,E););return S}}function createBaseFor(g){return function(m,S,v){for(var C=-1,_=vt(m),E=v(m),T=E.length;T--;){var I=E[g?T:++C];if(!1===S(_[I],I,_))break}return m}}function createBind(g,m,S){var v=m&N,C=createCtor(g);function wrapper(){return(this&&this!==ui&&this instanceof wrapper?C:g).apply(v?S:this,arguments)}return wrapper}function createCaseFirst(g){return function(m){var v=hasUnicode(m=toString(m))?stringToArray(m):S,C=v?v[0]:m.charAt(0),_=v?castSlice(v,1).join(""):m.slice(1);return C[g]()+_}}function createCompounder(g){return function(m){return arrayReduce(words(deburr(m).replace(Kt,"")),g,"")}}function createCtor(g){return function(){var m=arguments;switch(m.length){case 0:return new g;case 1:return new g(m[0]);case 2:return new g(m[0],m[1]);case 3:return new g(m[0],m[1],m[2]);case 4:return new g(m[0],m[1],m[2],m[3]);case 5:return new g(m[0],m[1],m[2],m[3],m[4]);case 6:return new g(m[0],m[1],m[2],m[3],m[4],m[5]);case 7:return new g(m[0],m[1],m[2],m[3],m[4],m[5],m[6])}var S=ji(g.prototype),v=g.apply(S,m);return isObject(v)?v:S}}function createCurry(g,m,v){var _=createCtor(g);function wrapper(){for(var E=arguments.length,T=C(E),I=E,b=getHolder(wrapper);I--;)T[I]=arguments[I];var A=E<3&&T[0]!==b&&T[E-1]!==b?[]:replaceHolders(T,b);return(E-=A.length)<v?createRecurry(g,m,createHybrid,wrapper.placeholder,S,T,A,S,S,v-E):apply(this&&this!==ui&&this instanceof wrapper?_:g,this,T)}return wrapper}function createFind(g){return function(m,v,C){var _=vt(m);if(!isArrayLike(m)){var E=getIteratee(v,3);m=keys(m),v=function(g){return E(_[g],g,_)}}var T=g(m,v,C);return T>-1?_[E?m[T]:T]:S}}function createFlow(g){return flatRest((function(m){var v=m.length,C=v,_=LodashWrapper.prototype.thru;for(g&&m.reverse();C--;){var E=m[C];if("function"!=typeof E)throw new yt(T);if(_&&!I&&"wrapper"==getFuncName(E))var I=new LodashWrapper([],!0)}for(C=I?C:v;++C<v;){var b=getFuncName(E=m[C]),A="wrapper"==b?en(E):S;I=A&&isLaziable(A[0])&&A[1]==(B|F|U|H)&&!A[4].length&&1==A[9]?I[getFuncName(A[0])].apply(I,A[3]):1==E.length&&isLaziable(E)?I[b]():I.thru(E)}return function(){var g=arguments,S=g[0];if(I&&1==g.length&&Kn(S))return I.plant(S).value();for(var C=0,_=v?m[C].apply(this,g):S;++C<v;)_=m[C].call(this,_);return _}}))}function createHybrid(g,m,v,_,E,T,I,b,A,R){var P=m&B,M=m&N,w=m&k,D=m&(F|x),O=m&$,L=w?S:createCtor(g);function wrapper(){for(var S=arguments.length,N=C(S),k=S;k--;)N[k]=arguments[k];if(D)var F=getHolder(wrapper),x=countHolders(N,F);if(_&&(N=composeArgs(N,_,E,D)),T&&(N=composeArgsRight(N,T,I,D)),S-=x,D&&S<R){var U=replaceHolders(N,F);return createRecurry(g,m,createHybrid,wrapper.placeholder,v,N,U,b,A,R-S)}var V=M?v:this,B=w?V[g]:g;return S=N.length,b?N=reorder(N,b):O&&S>1&&N.reverse(),P&&A<S&&(N.length=A),this&&this!==ui&&this instanceof wrapper&&(B=L||createCtor(B)),B.apply(V,N)}return wrapper}function createInverter(g,m){return function(S,v){return baseInverter(S,g,m(v),{})}}function createMathOperation(g,m){return function(v,C){var _;if(v===S&&C===S)return m;if(v!==S&&(_=v),C!==S){if(_===S)return C;"string"==typeof v||"string"==typeof C?(v=baseToString(v),C=baseToString(C)):(v=baseToNumber(v),C=baseToNumber(C)),_=g(v,C)}return _}}function createOver(g){return flatRest((function(m){return m=arrayMap(m,baseUnary(getIteratee())),baseRest((function(S){var v=this;return g(m,(function(g){return apply(g,v,S)}))}))}))}function createPadding(g,m){var v=(m=m===S?" ":baseToString(m)).length;if(v<2)return v?baseRepeat(m,g):m;var C=baseRepeat(m,Qt(g/stringSize(m)));return hasUnicode(m)?castSlice(stringToArray(C),0,g).join(""):C.slice(0,g)}function createPartial(g,m,S,v){var _=m&N,E=createCtor(g);function wrapper(){for(var m=-1,T=arguments.length,I=-1,b=v.length,A=C(b+T),R=this&&this!==ui&&this instanceof wrapper?E:g;++I<b;)A[I]=v[I];for(;T--;)A[I++]=arguments[++m];return apply(R,_?S:this,A)}return wrapper}function createRange(g){return function(m,v,C){return C&&"number"!=typeof C&&isIterateeCall(m,v,C)&&(v=C=S),m=toFinite(m),v===S?(v=m,m=0):v=toFinite(v),baseRange(m,v,C=C===S?m<v?1:-1:toFinite(C),g)}}function createRelationalOperation(g){return function(m,S){return"string"==typeof m&&"string"==typeof S||(m=toNumber(m),S=toNumber(S)),g(m,S)}}function createRecurry(g,m,v,C,_,E,T,I,b,A){var R=m&F;m|=R?U:V,(m&=~(R?V:U))&L||(m&=~(N|k));var P=[g,m,_,R?E:S,R?T:S,R?S:E,R?S:T,I,b,A],M=v.apply(S,P);return isLaziable(g)&&an(M,P),M.placeholder=C,setWrapToString(M,g,m)}function createRound(g){var m=St[g];return function(g,S){if(g=toNumber(g),(S=null==S?0:hi(toInteger(S),292))&&si(g)){var v=(toString(g)+"e").split("e");return+((v=(toString(m(v[0]+"e"+(+v[1]+S)))+"e").split("e"))[0]+"e"+(+v[1]-S))}return m(g)}}var Zi=Di&&1/setToArray(new Di([,-0]))[1]==Y?function(g){return new Di(g)}:noop;function createToPairs(g){return function(m){var S=rn(m);return S==ge?mapToArray(m):S==_e?setToPairs(m):baseToPairs(m,g(m))}}function createWrap(g,m,v,C,_,E,I,b){var A=m&k;if(!A&&"function"!=typeof g)throw new yt(T);var R=C?C.length:0;if(R||(m&=~(U|V),C=_=S),I=I===S?I:di(toInteger(I),0),b=b===S?b:toInteger(b),R-=_?_.length:0,m&V){var P=C,M=_;C=_=S}var w=A?S:en(g),D=[g,m,v,C,_,P,M,E,I,b];if(w&&mergeData(D,w),g=D[0],m=D[1],v=D[2],C=D[3],_=D[4],!(b=D[9]=D[9]===S?A?0:g.length:di(D[9]-R,0))&&m&(F|x)&&(m&=~(F|x)),m&&m!=N)O=m==F||m==x?createCurry(g,m,b):m!=U&&m!=(N|U)||_.length?createHybrid.apply(S,D):createPartial(g,m,v,C);else var O=createBind(g,m,v);return setWrapToString((w?Ji:an)(O,D),g,m)}function customDefaultsAssignIn(g,m,v,C){return g===S||eq(g,It[v])&&!Rt.call(C,v)?m:g}function customDefaultsMerge(g,m,v,C,_,E){return isObject(g)&&isObject(m)&&(E.set(m,g),baseMerge(g,m,S,customDefaultsMerge,E),E.delete(m)),g}function customOmitClone(g){return isPlainObject(g)?S:g}function equalArrays(g,m,v,C,_,E){var T=v&D,I=g.length,b=m.length;if(I!=b&&!(T&&b>I))return!1;var A=E.get(g),R=E.get(m);if(A&&R)return A==m&&R==g;var P=-1,M=!0,w=v&O?new SetCache:S;for(E.set(g,m),E.set(m,g);++P<I;){var N=g[P],k=m[P];if(C)var L=T?C(k,N,P,m,g,E):C(N,k,P,g,m,E);if(L!==S){if(L)continue;M=!1;break}if(w){if(!arraySome(m,(function(g,m){if(!cacheHas(w,m)&&(N===g||_(N,g,v,C,E)))return w.push(m)}))){M=!1;break}}else if(N!==k&&!_(N,k,v,C,E)){M=!1;break}}return E.delete(g),E.delete(m),M}function equalByTag(g,m,S,v,C,_,E){switch(S){case Re:if(g.byteLength!=m.byteLength||g.byteOffset!=m.byteOffset)return!1;g=g.buffer,m=m.buffer;case Ae:return!(g.byteLength!=m.byteLength||!_(new Ft(g),new Ft(m)));case oe:case le:case pe:return eq(+g,+m);case de:return g.name==m.name&&g.message==m.message;case Ce:case ye:return g==m+"";case ge:var T=mapToArray;case _e:var I=v&D;if(T||(T=setToArray),g.size!=m.size&&!I)return!1;var b=E.get(g);if(b)return b==m;v|=O,E.set(g,m);var A=equalArrays(T(g),T(m),v,C,_,E);return E.delete(g),A;case Ee:if($i)return $i.call(g)==$i.call(m)}return!1}function equalObjects(g,m,v,C,_,E){var T=v&D,I=getAllKeys(g),b=I.length;if(b!=getAllKeys(m).length&&!T)return!1;for(var A=b;A--;){var R=I[A];if(!(T?R in m:Rt.call(m,R)))return!1}var P=E.get(g),M=E.get(m);if(P&&M)return P==m&&M==g;var w=!0;E.set(g,m),E.set(m,g);for(var O=T;++A<b;){var N=g[R=I[A]],k=m[R];if(C)var L=T?C(k,N,R,m,g,E):C(N,k,R,g,m,E);if(!(L===S?N===k||_(N,k,v,C,E):L)){w=!1;break}O||(O="constructor"==R)}if(w&&!O){var F=g.constructor,x=m.constructor;F==x||!("constructor"in g)||!("constructor"in m)||"function"==typeof F&&F instanceof F&&"function"==typeof x&&x instanceof x||(w=!1)}return E.delete(g),E.delete(m),w}function flatRest(g){return ln(overRest(g,S,flatten),g+"")}function getAllKeys(g){return baseGetAllKeys(g,keys,tn)}function getAllKeysIn(g){return baseGetAllKeys(g,keysIn,nn)}var en=ki?function(g){return ki.get(g)}:noop;function getFuncName(g){for(var m=g.name+"",S=Li[m],v=Rt.call(Li,m)?S.length:0;v--;){var C=S[v],_=C.func;if(null==_||_==g)return C.name}return m}function getHolder(g){return(Rt.call(lodash,"placeholder")?lodash:g).placeholder}function getIteratee(){var g=lodash.iteratee||iteratee;return g=g===iteratee?baseIteratee:g,arguments.length?g(arguments[0],arguments[1]):g}function getMapData(g,m){var S=g.__data__;return isKeyable(m)?S["string"==typeof m?"string":"hash"]:S.map}function getMatchData(g){for(var m=keys(g),S=m.length;S--;){var v=m[S],C=g[v];m[S]=[v,C,isStrictComparable(C)]}return m}function getNative(g,m){var v=getValue(g,m);return baseIsNative(v)?v:S}function getRawTag(g){var m=Rt.call(g,jt),v=g[jt];try{g[jt]=S;var C=!0}catch(g){}var _=wt.call(g);return C&&(m?g[jt]=v:delete g[jt]),_}var tn=Zt?function(g){return null==g?[]:(g=vt(g),arrayFilter(Zt(g),(function(m){return Bt.call(g,m)})))}:stubArray,nn=Zt?function(g){for(var m=[];g;)arrayPush(m,tn(g)),g=Ut(g);return m}:stubArray,rn=baseGetTag;function getView(g,m,S){for(var v=-1,C=S.length;++v<C;){var _=S[v],E=_.size;switch(_.type){case"drop":g+=E;break;case"dropRight":m-=E;break;case"take":m=hi(m,g+E);break;case"takeRight":g=di(g,m-E)}}return{start:g,end:m}}function getWrapDetails(g){var m=g.match(tt);return m?m[1].split(it):[]}function hasPath(g,m,S){for(var v=-1,C=(m=castPath(m,g)).length,_=!1;++v<C;){var E=toKey(m[v]);if(!(_=null!=g&&S(g,E)))break;g=g[E]}return _||++v!=C?_:!!(C=null==g?0:g.length)&&isLength(C)&&isIndex(E,C)&&(Kn(g)||zn(g))}function initCloneArray(g){var m=g.length,S=new g.constructor(m);return m&&"string"==typeof g[0]&&Rt.call(g,"index")&&(S.index=g.index,S.input=g.input),S}function initCloneObject(g){return"function"!=typeof g.constructor||isPrototype(g)?{}:ji(Ut(g))}function initCloneByTag(g,m,S){var v=g.constructor;switch(m){case Ae:return cloneArrayBuffer(g);case oe:case le:return new v(+g);case Re:return cloneDataView(g,S);case Pe:case Me:case we:case De:case Oe:case Ne:case ke:case Le:case Fe:return cloneTypedArray(g,S);case ge:return new v;case pe:case ye:return new v(g);case Ce:return cloneRegExp(g);case _e:return new v;case Ee:return cloneSymbol(g)}}function insertWrapDetails(g,m){var S=m.length;if(!S)return g;var v=S-1;return m[v]=(S>1?"& ":"")+m[v],m=m.join(S>2?", ":" "),g.replace(et,"{\n/* [wrapped with "+m+"] */\n")}function isFlattenable(g){return Kn(g)||zn(g)||!!($t&&g&&g[$t])}function isIndex(g,m){var S=typeof g;return!!(m=null==m?Q:m)&&("number"==S||"symbol"!=S&&ut.test(g))&&g>-1&&g%1==0&&g<m}function isIterateeCall(g,m,S){if(!isObject(S))return!1;var v=typeof m;return!!("number"==v?isArrayLike(S)&&isIndex(m,S.length):"string"==v&&m in S)&&eq(S[m],g)}function isKey(g,m){if(Kn(g))return!1;var S=typeof g;return!("number"!=S&&"symbol"!=S&&"boolean"!=S&&null!=g&&!isSymbol(g))||(Ke.test(g)||!ze.test(g)||null!=m&&g in vt(m))}function isKeyable(g){var m=typeof g;return"string"==m||"number"==m||"symbol"==m||"boolean"==m?"__proto__"!==g:null===g}function isLaziable(g){var m=getFuncName(g),S=lodash[m];if("function"!=typeof S||!(m in LazyWrapper.prototype))return!1;if(g===S)return!0;var v=en(S);return!!v&&g===v[0]}function isMasked(g){return!!Mt&&Mt in g}(Ii&&rn(new Ii(new ArrayBuffer(1)))!=Re||Pi&&rn(new Pi)!=ge||wi&&rn(wi.resolve())!=Se||Di&&rn(new Di)!=_e||Oi&&rn(new Oi)!=Ie)&&(rn=function(g){var m=baseGetTag(g),v=m==fe?g.constructor:S,C=v?toSource(v):"";if(C)switch(C){case Fi:return Re;case xi:return ge;case Ui:return Se;case Vi:return _e;case Bi:return Ie}return m});var sn=bt?isFunction:stubFalse;function isPrototype(g){var m=g&&g.constructor;return g===("function"==typeof m&&m.prototype||It)}function isStrictComparable(g){return g==g&&!isObject(g)}function matchesStrictComparable(g,m){return function(v){return null!=v&&(v[g]===m&&(m!==S||g in vt(v)))}}function memoizeCapped(g){var m=memoize(g,(function(g){return S.size===A&&S.clear(),g})),S=m.cache;return m}function mergeData(g,m){var S=g[1],v=m[1],C=S|v,_=C<(N|k|B),E=v==B&&S==F||v==B&&S==H&&g[7].length<=m[8]||v==(B|H)&&m[7].length<=m[8]&&S==F;if(!_&&!E)return g;v&N&&(g[2]=m[2],C|=S&N?0:L);var T=m[3];if(T){var I=g[3];g[3]=I?composeArgs(I,T,m[4]):T,g[4]=I?replaceHolders(g[3],R):m[4]}return(T=m[5])&&(I=g[5],g[5]=I?composeArgsRight(I,T,m[6]):T,g[6]=I?replaceHolders(g[5],R):m[6]),(T=m[7])&&(g[7]=T),v&B&&(g[8]=null==g[8]?m[8]:hi(g[8],m[8])),null==g[9]&&(g[9]=m[9]),g[0]=m[0],g[1]=C,g}function nativeKeysIn(g){var m=[];if(null!=g)for(var S in vt(g))m.push(S);return m}function objectToString(g){return wt.call(g)}function overRest(g,m,v){return m=di(m===S?g.length-1:m,0),function(){for(var S=arguments,_=-1,E=di(S.length-m,0),T=C(E);++_<E;)T[_]=S[m+_];_=-1;for(var I=C(m+1);++_<m;)I[_]=S[_];return I[m]=v(T),apply(g,this,I)}}function parent(g,m){return m.length<2?g:baseGet(g,baseSlice(m,0,-1))}function reorder(g,m){for(var v=g.length,C=hi(m.length,v),_=copyArray(g);C--;){var E=m[C];g[C]=isIndex(E,v)?_[E]:S}return g}function safeGet(g,m){if(("constructor"!==m||"function"!=typeof g[m])&&"__proto__"!=m)return g[m]}var an=shortOut(Ji),on=Yt||function(g,m){return ui.setTimeout(g,m)},ln=shortOut(Yi);function setWrapToString(g,m,S){var v=m+"";return ln(g,insertWrapDetails(v,updateWrapDetails(getWrapDetails(v),S)))}function shortOut(g){var m=0,v=0;return function(){var C=gi(),_=W-(C-v);if(v=C,_>0){if(++m>=q)return arguments[0]}else m=0;return g.apply(S,arguments)}}function shuffleSelf(g,m){var v=-1,C=g.length,_=C-1;for(m=m===S?C:m;++v<m;){var E=baseRandom(v,_),T=g[E];g[E]=g[v],g[v]=T}return g.length=m,g}var cn=memoizeCapped((function(g){var m=[];return 46===g.charCodeAt(0)&&m.push(""),g.replace(Je,(function(g,S,v,C){m.push(v?C.replace(st,"$1"):S||g)})),m}));function toKey(g){if("string"==typeof g||isSymbol(g))return g;var m=g+"";return"0"==m&&1/g==-Y?"-0":m}function toSource(g){if(null!=g){try{return At.call(g)}catch(g){}try{return g+""}catch(g){}}return""}function updateWrapDetails(g,m){return arrayEach(ne,(function(S){var v="_."+S[0];m&S[1]&&!arrayIncludes(g,v)&&g.push(v)})),g.sort()}function wrapperClone(g){if(g instanceof LazyWrapper)return g.clone();var m=new LodashWrapper(g.__wrapped__,g.__chain__);return m.__actions__=copyArray(g.__actions__),m.__index__=g.__index__,m.__values__=g.__values__,m}function chunk(g,m,v){m=(v?isIterateeCall(g,m,v):m===S)?1:di(toInteger(m),0);var _=null==g?0:g.length;if(!_||m<1)return[];for(var E=0,T=0,I=C(Qt(_/m));E<_;)I[T++]=baseSlice(g,E,E+=m);return I}function compact(g){for(var m=-1,S=null==g?0:g.length,v=0,C=[];++m<S;){var _=g[m];_&&(C[v++]=_)}return C}function concat(){var g=arguments.length;if(!g)return[];for(var m=C(g-1),S=arguments[0],v=g;v--;)m[v-1]=arguments[v];return arrayPush(Kn(S)?copyArray(S):[S],baseFlatten(m,1))}var dn=baseRest((function(g,m){return isArrayLikeObject(g)?baseDifference(g,baseFlatten(m,1,isArrayLikeObject,!0)):[]})),hn=baseRest((function(g,m){var v=last(m);return isArrayLikeObject(v)&&(v=S),isArrayLikeObject(g)?baseDifference(g,baseFlatten(m,1,isArrayLikeObject,!0),getIteratee(v,2)):[]})),un=baseRest((function(g,m){var v=last(m);return isArrayLikeObject(v)&&(v=S),isArrayLikeObject(g)?baseDifference(g,baseFlatten(m,1,isArrayLikeObject,!0),S,v):[]}));function drop(g,m,v){var C=null==g?0:g.length;return C?baseSlice(g,(m=v||m===S?1:toInteger(m))<0?0:m,C):[]}function dropRight(g,m,v){var C=null==g?0:g.length;return C?baseSlice(g,0,(m=C-(m=v||m===S?1:toInteger(m)))<0?0:m):[]}function dropRightWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3),!0,!0):[]}function dropWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3),!0):[]}function fill(g,m,S,v){var C=null==g?0:g.length;return C?(S&&"number"!=typeof S&&isIterateeCall(g,m,S)&&(S=0,v=C),baseFill(g,m,S,v)):[]}function findIndex(g,m,S){var v=null==g?0:g.length;if(!v)return-1;var C=null==S?0:toInteger(S);return C<0&&(C=di(v+C,0)),baseFindIndex(g,getIteratee(m,3),C)}function findLastIndex(g,m,v){var C=null==g?0:g.length;if(!C)return-1;var _=C-1;return v!==S&&(_=toInteger(v),_=v<0?di(C+_,0):hi(_,C-1)),baseFindIndex(g,getIteratee(m,3),_,!0)}function flatten(g){return(null==g?0:g.length)?baseFlatten(g,1):[]}function flattenDeep(g){return(null==g?0:g.length)?baseFlatten(g,Y):[]}function flattenDepth(g,m){return(null==g?0:g.length)?baseFlatten(g,m=m===S?1:toInteger(m)):[]}function fromPairs(g){for(var m=-1,S=null==g?0:g.length,v={};++m<S;){var C=g[m];v[C[0]]=C[1]}return v}function head(g){return g&&g.length?g[0]:S}function indexOf(g,m,S){var v=null==g?0:g.length;if(!v)return-1;var C=null==S?0:toInteger(S);return C<0&&(C=di(v+C,0)),baseIndexOf(g,m,C)}function initial(g){return(null==g?0:g.length)?baseSlice(g,0,-1):[]}var gn=baseRest((function(g){var m=arrayMap(g,castArrayLikeObject);return m.length&&m[0]===g[0]?baseIntersection(m):[]})),pn=baseRest((function(g){var m=last(g),v=arrayMap(g,castArrayLikeObject);return m===last(v)?m=S:v.pop(),v.length&&v[0]===g[0]?baseIntersection(v,getIteratee(m,2)):[]})),mn=baseRest((function(g){var m=last(g),v=arrayMap(g,castArrayLikeObject);return(m="function"==typeof m?m:S)&&v.pop(),v.length&&v[0]===g[0]?baseIntersection(v,S,m):[]}));function join(g,m){return null==g?"":ai.call(g,m)}function last(g){var m=null==g?0:g.length;return m?g[m-1]:S}function lastIndexOf(g,m,v){var C=null==g?0:g.length;if(!C)return-1;var _=C;return v!==S&&(_=(_=toInteger(v))<0?di(C+_,0):hi(_,C-1)),m==m?strictLastIndexOf(g,m,_):baseFindIndex(g,baseIsNaN,_,!0)}function nth(g,m){return g&&g.length?baseNth(g,toInteger(m)):S}var fn=baseRest(pullAll);function pullAll(g,m){return g&&g.length&&m&&m.length?basePullAll(g,m):g}function pullAllBy(g,m,S){return g&&g.length&&m&&m.length?basePullAll(g,m,getIteratee(S,2)):g}function pullAllWith(g,m,v){return g&&g.length&&m&&m.length?basePullAll(g,m,S,v):g}var Sn=flatRest((function(g,m){var S=null==g?0:g.length,v=baseAt(g,m);return basePullAt(g,arrayMap(m,(function(g){return isIndex(g,S)?+g:g})).sort(compareAscending)),v}));function remove(g,m){var S=[];if(!g||!g.length)return S;var v=-1,C=[],_=g.length;for(m=getIteratee(m,3);++v<_;){var E=g[v];m(E,v,g)&&(S.push(E),C.push(v))}return basePullAt(g,C),S}function reverse(g){return null==g?g:Si.call(g)}function slice(g,m,v){var C=null==g?0:g.length;return C?(v&&"number"!=typeof v&&isIterateeCall(g,m,v)?(m=0,v=C):(m=null==m?0:toInteger(m),v=v===S?C:toInteger(v)),baseSlice(g,m,v)):[]}function sortedIndex(g,m){return baseSortedIndex(g,m)}function sortedIndexBy(g,m,S){return baseSortedIndexBy(g,m,getIteratee(S,2))}function sortedIndexOf(g,m){var S=null==g?0:g.length;if(S){var v=baseSortedIndex(g,m);if(v<S&&eq(g[v],m))return v}return-1}function sortedLastIndex(g,m){return baseSortedIndex(g,m,!0)}function sortedLastIndexBy(g,m,S){return baseSortedIndexBy(g,m,getIteratee(S,2),!0)}function sortedLastIndexOf(g,m){if(null==g?0:g.length){var S=baseSortedIndex(g,m,!0)-1;if(eq(g[S],m))return S}return-1}function sortedUniq(g){return g&&g.length?baseSortedUniq(g):[]}function sortedUniqBy(g,m){return g&&g.length?baseSortedUniq(g,getIteratee(m,2)):[]}function tail(g){var m=null==g?0:g.length;return m?baseSlice(g,1,m):[]}function take(g,m,v){return g&&g.length?baseSlice(g,0,(m=v||m===S?1:toInteger(m))<0?0:m):[]}function takeRight(g,m,v){var C=null==g?0:g.length;return C?baseSlice(g,(m=C-(m=v||m===S?1:toInteger(m)))<0?0:m,C):[]}function takeRightWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3),!1,!0):[]}function takeWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3)):[]}var vn=baseRest((function(g){return baseUniq(baseFlatten(g,1,isArrayLikeObject,!0))})),Cn=baseRest((function(g){var m=last(g);return isArrayLikeObject(m)&&(m=S),baseUniq(baseFlatten(g,1,isArrayLikeObject,!0),getIteratee(m,2))})),_n=baseRest((function(g){var m=last(g);return m="function"==typeof m?m:S,baseUniq(baseFlatten(g,1,isArrayLikeObject,!0),S,m)}));function uniq(g){return g&&g.length?baseUniq(g):[]}function uniqBy(g,m){return g&&g.length?baseUniq(g,getIteratee(m,2)):[]}function uniqWith(g,m){return m="function"==typeof m?m:S,g&&g.length?baseUniq(g,S,m):[]}function unzip(g){if(!g||!g.length)return[];var m=0;return g=arrayFilter(g,(function(g){if(isArrayLikeObject(g))return m=di(g.length,m),!0})),baseTimes(m,(function(m){return arrayMap(g,baseProperty(m))}))}function unzipWith(g,m){if(!g||!g.length)return[];var v=unzip(g);return null==m?v:arrayMap(v,(function(g){return apply(m,S,g)}))}var yn=baseRest((function(g,m){return isArrayLikeObject(g)?baseDifference(g,m):[]})),En=baseRest((function(g){return baseXor(arrayFilter(g,isArrayLikeObject))})),Tn=baseRest((function(g){var m=last(g);return isArrayLikeObject(m)&&(m=S),baseXor(arrayFilter(g,isArrayLikeObject),getIteratee(m,2))})),In=baseRest((function(g){var m=last(g);return m="function"==typeof m?m:S,baseXor(arrayFilter(g,isArrayLikeObject),S,m)})),bn=baseRest(unzip);function zipObject(g,m){return baseZipObject(g||[],m||[],assignValue)}function zipObjectDeep(g,m){return baseZipObject(g||[],m||[],baseSet)}var An=baseRest((function(g){var m=g.length,v=m>1?g[m-1]:S;return v="function"==typeof v?(g.pop(),v):S,unzipWith(g,v)}));function chain(g){var m=lodash(g);return m.__chain__=!0,m}function tap(g,m){return m(g),g}function thru(g,m){return m(g)}var Rn=flatRest((function(g){var m=g.length,v=m?g[0]:0,C=this.__wrapped__,interceptor=function(m){return baseAt(m,g)};return!(m>1||this.__actions__.length)&&C instanceof LazyWrapper&&isIndex(v)?((C=C.slice(v,+v+(m?1:0))).__actions__.push({func:thru,args:[interceptor],thisArg:S}),new LodashWrapper(C,this.__chain__).thru((function(g){return m&&!g.length&&g.push(S),g}))):this.thru(interceptor)}));function wrapperChain(){return chain(this)}function wrapperCommit(){return new LodashWrapper(this.value(),this.__chain__)}function wrapperNext(){this.__values__===S&&(this.__values__=toArray(this.value()));var g=this.__index__>=this.__values__.length;return{done:g,value:g?S:this.__values__[this.__index__++]}}function wrapperToIterator(){return this}function wrapperPlant(g){for(var m,v=this;v instanceof baseLodash;){var C=wrapperClone(v);C.__index__=0,C.__values__=S,m?_.__wrapped__=C:m=C;var _=C;v=v.__wrapped__}return _.__wrapped__=g,m}function wrapperReverse(){var g=this.__wrapped__;if(g instanceof LazyWrapper){var m=g;return this.__actions__.length&&(m=new LazyWrapper(this)),(m=m.reverse()).__actions__.push({func:thru,args:[reverse],thisArg:S}),new LodashWrapper(m,this.__chain__)}return this.thru(reverse)}function wrapperValue(){return baseWrapperValue(this.__wrapped__,this.__actions__)}var Pn=createAggregator((function(g,m,S){Rt.call(g,S)?++g[S]:baseAssignValue(g,S,1)}));function every(g,m,v){var C=Kn(g)?arrayEvery:baseEvery;return v&&isIterateeCall(g,m,v)&&(m=S),C(g,getIteratee(m,3))}function filter(g,m){return(Kn(g)?arrayFilter:baseFilter)(g,getIteratee(m,3))}var Mn=createFind(findIndex),wn=createFind(findLastIndex);function flatMap(g,m){return baseFlatten(map(g,m),1)}function flatMapDeep(g,m){return baseFlatten(map(g,m),Y)}function flatMapDepth(g,m,v){return v=v===S?1:toInteger(v),baseFlatten(map(g,m),v)}function forEach(g,m){return(Kn(g)?arrayEach:qi)(g,getIteratee(m,3))}function forEachRight(g,m){return(Kn(g)?arrayEachRight:Wi)(g,getIteratee(m,3))}var Dn=createAggregator((function(g,m,S){Rt.call(g,S)?g[S].push(m):baseAssignValue(g,S,[m])}));function includes(g,m,S,v){g=isArrayLike(g)?g:values(g),S=S&&!v?toInteger(S):0;var C=g.length;return S<0&&(S=di(C+S,0)),isString(g)?S<=C&&g.indexOf(m,S)>-1:!!C&&baseIndexOf(g,m,S)>-1}var On=baseRest((function(g,m,S){var v=-1,_="function"==typeof m,E=isArrayLike(g)?C(g.length):[];return qi(g,(function(g){E[++v]=_?apply(m,g,S):baseInvoke(g,m,S)})),E})),Nn=createAggregator((function(g,m,S){baseAssignValue(g,S,m)}));function map(g,m){return(Kn(g)?arrayMap:baseMap)(g,getIteratee(m,3))}function orderBy(g,m,v,C){return null==g?[]:(Kn(m)||(m=null==m?[]:[m]),Kn(v=C?S:v)||(v=null==v?[]:[v]),baseOrderBy(g,m,v))}var kn=createAggregator((function(g,m,S){g[S?0:1].push(m)}),(function(){return[[],[]]}));function reduce(g,m,S){var v=Kn(g)?arrayReduce:baseReduce,C=arguments.length<3;return v(g,getIteratee(m,4),S,C,qi)}function reduceRight(g,m,S){var v=Kn(g)?arrayReduceRight:baseReduce,C=arguments.length<3;return v(g,getIteratee(m,4),S,C,Wi)}function reject(g,m){return(Kn(g)?arrayFilter:baseFilter)(g,negate(getIteratee(m,3)))}function sample(g){return(Kn(g)?arraySample:baseSample)(g)}function sampleSize(g,m,v){return m=(v?isIterateeCall(g,m,v):m===S)?1:toInteger(m),(Kn(g)?arraySampleSize:baseSampleSize)(g,m)}function shuffle(g){return(Kn(g)?arrayShuffle:baseShuffle)(g)}function size(g){if(null==g)return 0;if(isArrayLike(g))return isString(g)?stringSize(g):g.length;var m=rn(g);return m==ge||m==_e?g.size:baseKeys(g).length}function some(g,m,v){var C=Kn(g)?arraySome:baseSome;return v&&isIterateeCall(g,m,v)&&(m=S),C(g,getIteratee(m,3))}var Ln=baseRest((function(g,m){if(null==g)return[];var S=m.length;return S>1&&isIterateeCall(g,m[0],m[1])?m=[]:S>2&&isIterateeCall(m[0],m[1],m[2])&&(m=[m[0]]),baseOrderBy(g,baseFlatten(m,1),[])})),Fn=zt||function(){return ui.Date.now()};function after(g,m){if("function"!=typeof m)throw new yt(T);return g=toInteger(g),function(){if(--g<1)return m.apply(this,arguments)}}function ary(g,m,v){return m=v?S:m,m=g&&null==m?g.length:m,createWrap(g,B,S,S,S,S,m)}function before(g,m){var v;if("function"!=typeof m)throw new yt(T);return g=toInteger(g),function(){return--g>0&&(v=m.apply(this,arguments)),g<=1&&(m=S),v}}var xn=baseRest((function(g,m,S){var v=N;if(S.length){var C=replaceHolders(S,getHolder(xn));v|=U}return createWrap(g,v,m,S,C)})),Un=baseRest((function(g,m,S){var v=N|k;if(S.length){var C=replaceHolders(S,getHolder(Un));v|=U}return createWrap(m,v,g,S,C)}));function curry(g,m,v){var C=createWrap(g,F,S,S,S,S,S,m=v?S:m);return C.placeholder=curry.placeholder,C}function curryRight(g,m,v){var C=createWrap(g,x,S,S,S,S,S,m=v?S:m);return C.placeholder=curryRight.placeholder,C}function debounce(g,m,v){var C,_,E,I,b,A,R=0,P=!1,M=!1,w=!0;if("function"!=typeof g)throw new yt(T);function invokeFunc(m){var v=C,E=_;return C=_=S,R=m,I=g.apply(E,v)}function leadingEdge(g){return R=g,b=on(timerExpired,m),P?invokeFunc(g):I}function remainingWait(g){var S=m-(g-A);return M?hi(S,E-(g-R)):S}function shouldInvoke(g){var v=g-A;return A===S||v>=m||v<0||M&&g-R>=E}function timerExpired(){var g=Fn();if(shouldInvoke(g))return trailingEdge(g);b=on(timerExpired,remainingWait(g))}function trailingEdge(g){return b=S,w&&C?invokeFunc(g):(C=_=S,I)}function cancel(){b!==S&&Xi(b),R=0,C=A=_=b=S}function flush(){return b===S?I:trailingEdge(Fn())}function debounced(){var g=Fn(),v=shouldInvoke(g);if(C=arguments,_=this,A=g,v){if(b===S)return leadingEdge(A);if(M)return Xi(b),b=on(timerExpired,m),invokeFunc(A)}return b===S&&(b=on(timerExpired,m)),I}return m=toNumber(m)||0,isObject(v)&&(P=!!v.leading,E=(M="maxWait"in v)?di(toNumber(v.maxWait)||0,m):E,w="trailing"in v?!!v.trailing:w),debounced.cancel=cancel,debounced.flush=flush,debounced}var Vn=baseRest((function(g,m){return baseDelay(g,1,m)})),Bn=baseRest((function(g,m,S){return baseDelay(g,toNumber(m)||0,S)}));function flip(g){return createWrap(g,$)}function memoize(g,m){if("function"!=typeof g||null!=m&&"function"!=typeof m)throw new yt(T);var memoized=function(){var S=arguments,v=m?m.apply(this,S):S[0],C=memoized.cache;if(C.has(v))return C.get(v);var _=g.apply(this,S);return memoized.cache=C.set(v,_)||C,_};return memoized.cache=new(memoize.Cache||MapCache),memoized}function negate(g){if("function"!=typeof g)throw new yt(T);return function(){var m=arguments;switch(m.length){case 0:return!g.call(this);case 1:return!g.call(this,m[0]);case 2:return!g.call(this,m[0],m[1]);case 3:return!g.call(this,m[0],m[1],m[2])}return!g.apply(this,m)}}function once(g){return before(2,g)}memoize.Cache=MapCache;var Hn=Qi((function(g,m){var S=(m=1==m.length&&Kn(m[0])?arrayMap(m[0],baseUnary(getIteratee())):arrayMap(baseFlatten(m,1),baseUnary(getIteratee()))).length;return baseRest((function(v){for(var C=-1,_=hi(v.length,S);++C<_;)v[C]=m[C].call(this,v[C]);return apply(g,this,v)}))})),$n=baseRest((function(g,m){var v=replaceHolders(m,getHolder($n));return createWrap(g,U,S,m,v)})),Gn=baseRest((function(g,m){var v=replaceHolders(m,getHolder(Gn));return createWrap(g,V,S,m,v)})),jn=flatRest((function(g,m){return createWrap(g,H,S,S,S,m)}));function rest(g,m){if("function"!=typeof g)throw new yt(T);return baseRest(g,m=m===S?m:toInteger(m))}function spread(g,m){if("function"!=typeof g)throw new yt(T);return m=null==m?0:di(toInteger(m),0),baseRest((function(S){var v=S[m],C=castSlice(S,0,m);return v&&arrayPush(C,v),apply(g,this,C)}))}function throttle(g,m,S){var v=!0,C=!0;if("function"!=typeof g)throw new yt(T);return isObject(S)&&(v="leading"in S?!!S.leading:v,C="trailing"in S?!!S.trailing:C),debounce(g,m,{leading:v,maxWait:m,trailing:C})}function unary(g){return ary(g,1)}function wrap(g,m){return $n(castFunction(m),g)}function castArray(){if(!arguments.length)return[];var g=arguments[0];return Kn(g)?g:[g]}function clone(g){return baseClone(g,w)}function cloneWith(g,m){return baseClone(g,w,m="function"==typeof m?m:S)}function cloneDeep(g){return baseClone(g,P|w)}function cloneDeepWith(g,m){return baseClone(g,P|w,m="function"==typeof m?m:S)}function conformsTo(g,m){return null==m||baseConformsTo(g,m,keys(m))}function eq(g,m){return g===m||g!=g&&m!=m}var qn=createRelationalOperation(baseGt),Wn=createRelationalOperation((function(g,m){return g>=m})),zn=baseIsArguments(function(){return arguments}())?baseIsArguments:function(g){return isObjectLike(g)&&Rt.call(g,"callee")&&!Bt.call(g,"callee")},Kn=C.isArray,Jn=vi?baseUnary(vi):baseIsArrayBuffer;function isArrayLike(g){return null!=g&&isLength(g.length)&&!isFunction(g)}function isArrayLikeObject(g){return isObjectLike(g)&&isArrayLike(g)}function isBoolean(g){return!0===g||!1===g||isObjectLike(g)&&baseGetTag(g)==oe}var Yn=ri||stubFalse,Qn=Ci?baseUnary(Ci):baseIsDate;function isElement(g){return isObjectLike(g)&&1===g.nodeType&&!isPlainObject(g)}function isEmpty(g){if(null==g)return!0;if(isArrayLike(g)&&(Kn(g)||"string"==typeof g||"function"==typeof g.splice||Yn(g)||tr(g)||zn(g)))return!g.length;var m=rn(g);if(m==ge||m==_e)return!g.size;if(isPrototype(g))return!baseKeys(g).length;for(var S in g)if(Rt.call(g,S))return!1;return!0}function isEqual(g,m){return baseIsEqual(g,m)}function isEqualWith(g,m,v){var C=(v="function"==typeof v?v:S)?v(g,m):S;return C===S?baseIsEqual(g,m,S,v):!!C}function isError(g){if(!isObjectLike(g))return!1;var m=baseGetTag(g);return m==de||m==ce||"string"==typeof g.message&&"string"==typeof g.name&&!isPlainObject(g)}function isFinite(g){return"number"==typeof g&&si(g)}function isFunction(g){if(!isObject(g))return!1;var m=baseGetTag(g);return m==he||m==ue||m==ae||m==ve}function isInteger(g){return"number"==typeof g&&g==toInteger(g)}function isLength(g){return"number"==typeof g&&g>-1&&g%1==0&&g<=Q}function isObject(g){var m=typeof g;return null!=g&&("object"==m||"function"==m)}function isObjectLike(g){return null!=g&&"object"==typeof g}var Xn=_i?baseUnary(_i):baseIsMap;function isMatch(g,m){return g===m||baseIsMatch(g,m,getMatchData(m))}function isMatchWith(g,m,v){return v="function"==typeof v?v:S,baseIsMatch(g,m,getMatchData(m),v)}function isNaN(g){return isNumber(g)&&g!=+g}function isNative(g){if(sn(g))throw new nt(E);return baseIsNative(g)}function isNull(g){return null===g}function isNil(g){return null==g}function isNumber(g){return"number"==typeof g||isObjectLike(g)&&baseGetTag(g)==pe}function isPlainObject(g){if(!isObjectLike(g)||baseGetTag(g)!=fe)return!1;var m=Ut(g);if(null===m)return!0;var S=Rt.call(m,"constructor")&&m.constructor;return"function"==typeof S&&S instanceof S&&At.call(S)==Dt}var Zn=yi?baseUnary(yi):baseIsRegExp;function isSafeInteger(g){return isInteger(g)&&g>=-Q&&g<=Q}var er=Ei?baseUnary(Ei):baseIsSet;function isString(g){return"string"==typeof g||!Kn(g)&&isObjectLike(g)&&baseGetTag(g)==ye}function isSymbol(g){return"symbol"==typeof g||isObjectLike(g)&&baseGetTag(g)==Ee}var tr=Ti?baseUnary(Ti):baseIsTypedArray;function isUndefined(g){return g===S}function isWeakMap(g){return isObjectLike(g)&&rn(g)==Ie}function isWeakSet(g){return isObjectLike(g)&&baseGetTag(g)==be}var ir=createRelationalOperation(baseLt),nr=createRelationalOperation((function(g,m){return g<=m}));function toArray(g){if(!g)return[];if(isArrayLike(g))return isString(g)?stringToArray(g):copyArray(g);if(Gt&&g[Gt])return iteratorToArray(g[Gt]());var m=rn(g);return(m==ge?mapToArray:m==_e?setToArray:values)(g)}function toFinite(g){return g?(g=toNumber(g))===Y||g===-Y?(g<0?-1:1)*X:g==g?g:0:0===g?g:0}function toInteger(g){var m=toFinite(g),S=m%1;return m==m?S?m-S:m:0}function toLength(g){return g?baseClamp(toInteger(g),0,ee):0}function toNumber(g){if("number"==typeof g)return g;if(isSymbol(g))return Z;if(isObject(g)){var m="function"==typeof g.valueOf?g.valueOf():g;g=isObject(m)?m+"":m}if("string"!=typeof g)return 0===g?g:+g;g=baseTrim(g);var S=ct.test(g);return S||ht.test(g)?ci(g.slice(2),S?2:8):lt.test(g)?Z:+g}function toPlainObject(g){return copyObject(g,keysIn(g))}function toSafeInteger(g){return g?baseClamp(toInteger(g),-Q,Q):0===g?g:0}function toString(g){return null==g?"":baseToString(g)}var rr=createAssigner((function(g,m){if(isPrototype(m)||isArrayLike(m))copyObject(m,keys(m),g);else for(var S in m)Rt.call(m,S)&&assignValue(g,S,m[S])})),sr=createAssigner((function(g,m){copyObject(m,keysIn(m),g)})),ar=createAssigner((function(g,m,S,v){copyObject(m,keysIn(m),g,v)})),or=createAssigner((function(g,m,S,v){copyObject(m,keys(m),g,v)})),lr=flatRest(baseAt);function create(g,m){var S=ji(g);return null==m?S:baseAssign(S,m)}var cr=baseRest((function(g,m){g=vt(g);var v=-1,C=m.length,_=C>2?m[2]:S;for(_&&isIterateeCall(m[0],m[1],_)&&(C=1);++v<C;)for(var E=m[v],T=keysIn(E),I=-1,b=T.length;++I<b;){var A=T[I],R=g[A];(R===S||eq(R,It[A])&&!Rt.call(g,A))&&(g[A]=E[A])}return g})),dr=baseRest((function(g){return g.push(S,customDefaultsMerge),apply(mr,S,g)}));function findKey(g,m){return baseFindKey(g,getIteratee(m,3),baseForOwn)}function findLastKey(g,m){return baseFindKey(g,getIteratee(m,3),baseForOwnRight)}function forIn(g,m){return null==g?g:zi(g,getIteratee(m,3),keysIn)}function forInRight(g,m){return null==g?g:Ki(g,getIteratee(m,3),keysIn)}function forOwn(g,m){return g&&baseForOwn(g,getIteratee(m,3))}function forOwnRight(g,m){return g&&baseForOwnRight(g,getIteratee(m,3))}function functions(g){return null==g?[]:baseFunctions(g,keys(g))}function functionsIn(g){return null==g?[]:baseFunctions(g,keysIn(g))}function get(g,m,v){var C=null==g?S:baseGet(g,m);return C===S?v:C}function has(g,m){return null!=g&&hasPath(g,m,baseHas)}function hasIn(g,m){return null!=g&&hasPath(g,m,baseHasIn)}var hr=createInverter((function(g,m,S){null!=m&&"function"!=typeof m.toString&&(m=wt.call(m)),g[m]=S}),constant(identity)),ur=createInverter((function(g,m,S){null!=m&&"function"!=typeof m.toString&&(m=wt.call(m)),Rt.call(g,m)?g[m].push(S):g[m]=[S]}),getIteratee),gr=baseRest(baseInvoke);function keys(g){return isArrayLike(g)?arrayLikeKeys(g):baseKeys(g)}function keysIn(g){return isArrayLike(g)?arrayLikeKeys(g,!0):baseKeysIn(g)}function mapKeys(g,m){var S={};return m=getIteratee(m,3),baseForOwn(g,(function(g,v,C){baseAssignValue(S,m(g,v,C),g)})),S}function mapValues(g,m){var S={};return m=getIteratee(m,3),baseForOwn(g,(function(g,v,C){baseAssignValue(S,v,m(g,v,C))})),S}var pr=createAssigner((function(g,m,S){baseMerge(g,m,S)})),mr=createAssigner((function(g,m,S,v){baseMerge(g,m,S,v)})),fr=flatRest((function(g,m){var S={};if(null==g)return S;var v=!1;m=arrayMap(m,(function(m){return m=castPath(m,g),v||(v=m.length>1),m})),copyObject(g,getAllKeysIn(g),S),v&&(S=baseClone(S,P|M|w,customOmitClone));for(var C=m.length;C--;)baseUnset(S,m[C]);return S}));function omitBy(g,m){return pickBy(g,negate(getIteratee(m)))}var Sr=flatRest((function(g,m){return null==g?{}:basePick(g,m)}));function pickBy(g,m){if(null==g)return{};var S=arrayMap(getAllKeysIn(g),(function(g){return[g]}));return m=getIteratee(m),basePickBy(g,S,(function(g,S){return m(g,S[0])}))}function result(g,m,v){var C=-1,_=(m=castPath(m,g)).length;for(_||(_=1,g=S);++C<_;){var E=null==g?S:g[toKey(m[C])];E===S&&(C=_,E=v),g=isFunction(E)?E.call(g):E}return g}function set(g,m,S){return null==g?g:baseSet(g,m,S)}function setWith(g,m,v,C){return C="function"==typeof C?C:S,null==g?g:baseSet(g,m,v,C)}var vr=createToPairs(keys),Cr=createToPairs(keysIn);function transform(g,m,S){var v=Kn(g),C=v||Yn(g)||tr(g);if(m=getIteratee(m,4),null==S){var _=g&&g.constructor;S=C?v?new _:[]:isObject(g)&&isFunction(_)?ji(Ut(g)):{}}return(C?arrayEach:baseForOwn)(g,(function(g,v,C){return m(S,g,v,C)})),S}function unset(g,m){return null==g||baseUnset(g,m)}function update(g,m,S){return null==g?g:baseUpdate(g,m,castFunction(S))}function updateWith(g,m,v,C){return C="function"==typeof C?C:S,null==g?g:baseUpdate(g,m,castFunction(v),C)}function values(g){return null==g?[]:baseValues(g,keys(g))}function valuesIn(g){return null==g?[]:baseValues(g,keysIn(g))}function clamp(g,m,v){return v===S&&(v=m,m=S),v!==S&&(v=(v=toNumber(v))==v?v:0),m!==S&&(m=(m=toNumber(m))==m?m:0),baseClamp(toNumber(g),m,v)}function inRange(g,m,v){return m=toFinite(m),v===S?(v=m,m=0):v=toFinite(v),baseInRange(g=toNumber(g),m,v)}function random(g,m,v){if(v&&"boolean"!=typeof v&&isIterateeCall(g,m,v)&&(m=v=S),v===S&&("boolean"==typeof m?(v=m,m=S):"boolean"==typeof g&&(v=g,g=S)),g===S&&m===S?(g=0,m=1):(g=toFinite(g),m===S?(m=g,g=0):m=toFinite(m)),g>m){var C=g;g=m,m=C}if(v||g%1||m%1){var _=fi();return hi(g+_*(m-g+li("1e-"+((_+"").length-1))),m)}return baseRandom(g,m)}var _r=createCompounder((function(g,m,S){return m=m.toLowerCase(),g+(S?capitalize(m):m)}));function capitalize(g){return Rr(toString(g).toLowerCase())}function deburr(g){return(g=toString(g))&&g.replace(gt,bi).replace(Jt,"")}function endsWith(g,m,v){g=toString(g),m=baseToString(m);var C=g.length,_=v=v===S?C:baseClamp(toInteger(v),0,C);return(v-=m.length)>=0&&g.slice(v,_)==m}function escape(g){return(g=toString(g))&&Ge.test(g)?g.replace(He,Ai):g}function escapeRegExp(g){return(g=toString(g))&&Qe.test(g)?g.replace(Ye,"\\$&"):g}var yr=createCompounder((function(g,m,S){return g+(S?"-":"")+m.toLowerCase()})),Er=createCompounder((function(g,m,S){return g+(S?" ":"")+m.toLowerCase()})),Tr=createCaseFirst("toLowerCase");function pad(g,m,S){g=toString(g);var v=(m=toInteger(m))?stringSize(g):0;if(!m||v>=m)return g;var C=(m-v)/2;return createPadding(Xt(C),S)+g+createPadding(Qt(C),S)}function padEnd(g,m,S){g=toString(g);var v=(m=toInteger(m))?stringSize(g):0;return m&&v<m?g+createPadding(m-v,S):g}function padStart(g,m,S){g=toString(g);var v=(m=toInteger(m))?stringSize(g):0;return m&&v<m?createPadding(m-v,S)+g:g}function parseInt(g,m,S){return S||null==m?m=0:m&&(m=+m),pi(toString(g).replace(Xe,""),m||0)}function repeat(g,m,v){return m=(v?isIterateeCall(g,m,v):m===S)?1:toInteger(m),baseRepeat(toString(g),m)}function replace(){var g=arguments,m=toString(g[0]);return g.length<3?m:m.replace(g[1],g[2])}var Ir=createCompounder((function(g,m,S){return g+(S?"_":"")+m.toLowerCase()}));function split(g,m,v){return v&&"number"!=typeof v&&isIterateeCall(g,m,v)&&(m=v=S),(v=v===S?ee:v>>>0)?(g=toString(g))&&("string"==typeof m||null!=m&&!Zn(m))&&!(m=baseToString(m))&&hasUnicode(g)?castSlice(stringToArray(g),0,v):g.split(m,v):[]}var br=createCompounder((function(g,m,S){return g+(S?" ":"")+Rr(m)}));function startsWith(g,m,S){return g=toString(g),S=null==S?0:baseClamp(toInteger(S),0,g.length),m=baseToString(m),g.slice(S,S+m.length)==m}function template(g,m,v){var C=lodash.templateSettings;v&&isIterateeCall(g,m,v)&&(m=S),g=toString(g),m=ar({},m,C,customDefaultsAssignIn);var _,E,T=ar({},m.imports,C.imports,customDefaultsAssignIn),b=keys(T),A=baseValues(T,b),R=0,P=m.interpolate||pt,M="__p += '",w=Ct((m.escape||pt).source+"|"+P.source+"|"+(P===We?at:pt).source+"|"+(m.evaluate||pt).source+"|$","g"),D="//# sourceURL="+(Rt.call(m,"sourceURL")?(m.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++ti+"]")+"\n";g.replace(w,(function(m,S,v,C,T,I){return v||(v=C),M+=g.slice(R,I).replace(mt,escapeStringChar),S&&(_=!0,M+="' +\n__e("+S+") +\n'"),T&&(E=!0,M+="';\n"+T+";\n__p += '"),v&&(M+="' +\n((__t = ("+v+")) == null ? '' : __t) +\n'"),R=I+m.length,m})),M+="';\n";var O=Rt.call(m,"variable")&&m.variable;if(O){if(rt.test(O))throw new nt(I)}else M="with (obj) {\n"+M+"\n}\n";M=(E?M.replace(xe,""):M).replace(Ue,"$1").replace(Ve,"$1;"),M="function("+(O||"obj")+") {\n"+(O?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(_?", __e = _.escape":"")+(E?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+M+"return __p\n}";var N=Pr((function(){return ft(b,D+"return "+M).apply(S,A)}));if(N.source=M,isError(N))throw N;return N}function toLower(g){return toString(g).toLowerCase()}function toUpper(g){return toString(g).toUpperCase()}function trim(g,m,v){if((g=toString(g))&&(v||m===S))return baseTrim(g);if(!g||!(m=baseToString(m)))return g;var C=stringToArray(g),_=stringToArray(m);return castSlice(C,charsStartIndex(C,_),charsEndIndex(C,_)+1).join("")}function trimEnd(g,m,v){if((g=toString(g))&&(v||m===S))return g.slice(0,trimmedEndIndex(g)+1);if(!g||!(m=baseToString(m)))return g;var C=stringToArray(g);return castSlice(C,0,charsEndIndex(C,stringToArray(m))+1).join("")}function trimStart(g,m,v){if((g=toString(g))&&(v||m===S))return g.replace(Xe,"");if(!g||!(m=baseToString(m)))return g;var C=stringToArray(g);return castSlice(C,charsStartIndex(C,stringToArray(m))).join("")}function truncate(g,m){var v=G,C=j;if(isObject(m)){var _="separator"in m?m.separator:_;v="length"in m?toInteger(m.length):v,C="omission"in m?baseToString(m.omission):C}var E=(g=toString(g)).length;if(hasUnicode(g)){var T=stringToArray(g);E=T.length}if(v>=E)return g;var I=v-stringSize(C);if(I<1)return C;var b=T?castSlice(T,0,I).join(""):g.slice(0,I);if(_===S)return b+C;if(T&&(I+=b.length-I),Zn(_)){if(g.slice(I).search(_)){var A,R=b;for(_.global||(_=Ct(_.source,toString(ot.exec(_))+"g")),_.lastIndex=0;A=_.exec(R);)var P=A.index;b=b.slice(0,P===S?I:P)}}else if(g.indexOf(baseToString(_),I)!=I){var M=b.lastIndexOf(_);M>-1&&(b=b.slice(0,M))}return b+C}function unescape(g){return(g=toString(g))&&$e.test(g)?g.replace(Be,Ri):g}var Ar=createCompounder((function(g,m,S){return g+(S?" ":"")+m.toUpperCase()})),Rr=createCaseFirst("toUpperCase");function words(g,m,v){return g=toString(g),(m=v?S:m)===S?hasUnicodeWord(g)?unicodeWords(g):asciiWords(g):g.match(m)||[]}var Pr=baseRest((function(g,m){try{return apply(g,S,m)}catch(g){return isError(g)?g:new nt(g)}})),Mr=flatRest((function(g,m){return arrayEach(m,(function(m){m=toKey(m),baseAssignValue(g,m,xn(g[m],g))})),g}));function cond(g){var m=null==g?0:g.length,S=getIteratee();return g=m?arrayMap(g,(function(g){if("function"!=typeof g[1])throw new yt(T);return[S(g[0]),g[1]]})):[],baseRest((function(S){for(var v=-1;++v<m;){var C=g[v];if(apply(C[0],this,S))return apply(C[1],this,S)}}))}function conforms(g){return baseConforms(baseClone(g,P))}function constant(g){return function(){return g}}function defaultTo(g,m){return null==g||g!=g?m:g}var wr=createFlow(),Dr=createFlow(!0);function identity(g){return g}function iteratee(g){return baseIteratee("function"==typeof g?g:baseClone(g,P))}function matches(g){return baseMatches(baseClone(g,P))}function matchesProperty(g,m){return baseMatchesProperty(g,baseClone(m,P))}var Or=baseRest((function(g,m){return function(S){return baseInvoke(S,g,m)}})),Nr=baseRest((function(g,m){return function(S){return baseInvoke(g,S,m)}}));function mixin(g,m,S){var v=keys(m),C=baseFunctions(m,v);null!=S||isObject(m)&&(C.length||!v.length)||(S=m,m=g,g=this,C=baseFunctions(m,keys(m)));var _=!(isObject(S)&&"chain"in S&&!S.chain),E=isFunction(g);return arrayEach(C,(function(S){var v=m[S];g[S]=v,E&&(g.prototype[S]=function(){var m=this.__chain__;if(_||m){var S=g(this.__wrapped__);return(S.__actions__=copyArray(this.__actions__)).push({func:v,args:arguments,thisArg:g}),S.__chain__=m,S}return v.apply(g,arrayPush([this.value()],arguments))})})),g}function noConflict(){return ui._===this&&(ui._=Ot),this}function noop(){}function nthArg(g){return g=toInteger(g),baseRest((function(m){return baseNth(m,g)}))}var kr=createOver(arrayMap),Lr=createOver(arrayEvery),Fr=createOver(arraySome);function property(g){return isKey(g)?baseProperty(toKey(g)):basePropertyDeep(g)}function propertyOf(g){return function(m){return null==g?S:baseGet(g,m)}}var xr=createRange(),Ur=createRange(!0);function stubArray(){return[]}function stubFalse(){return!1}function stubObject(){return{}}function stubString(){return""}function stubTrue(){return!0}function times(g,m){if((g=toInteger(g))<1||g>Q)return[];var S=ee,v=hi(g,ee);m=getIteratee(m),g-=ee;for(var C=baseTimes(v,m);++S<g;)m(S);return C}function toPath(g){return Kn(g)?arrayMap(g,toKey):isSymbol(g)?[g]:copyArray(cn(toString(g)))}function uniqueId(g){var m=++Pt;return toString(g)+m}var Vr=createMathOperation((function(g,m){return g+m}),0),Br=createRound("ceil"),Hr=createMathOperation((function(g,m){return g/m}),1),$r=createRound("floor");function max(g){return g&&g.length?baseExtremum(g,identity,baseGt):S}function maxBy(g,m){return g&&g.length?baseExtremum(g,getIteratee(m,2),baseGt):S}function mean(g){return baseMean(g,identity)}function meanBy(g,m){return baseMean(g,getIteratee(m,2))}function min(g){return g&&g.length?baseExtremum(g,identity,baseLt):S}function minBy(g,m){return g&&g.length?baseExtremum(g,getIteratee(m,2),baseLt):S}var Gr,jr=createMathOperation((function(g,m){return g*m}),1),qr=createRound("round"),Wr=createMathOperation((function(g,m){return g-m}),0);function sum(g){return g&&g.length?baseSum(g,identity):0}function sumBy(g,m){return g&&g.length?baseSum(g,getIteratee(m,2)):0}return lodash.after=after,lodash.ary=ary,lodash.assign=rr,lodash.assignIn=sr,lodash.assignInWith=ar,lodash.assignWith=or,lodash.at=lr,lodash.before=before,lodash.bind=xn,lodash.bindAll=Mr,lodash.bindKey=Un,lodash.castArray=castArray,lodash.chain=chain,lodash.chunk=chunk,lodash.compact=compact,lodash.concat=concat,lodash.cond=cond,lodash.conforms=conforms,lodash.constant=constant,lodash.countBy=Pn,lodash.create=create,lodash.curry=curry,lodash.curryRight=curryRight,lodash.debounce=debounce,lodash.defaults=cr,lodash.defaultsDeep=dr,lodash.defer=Vn,lodash.delay=Bn,lodash.difference=dn,lodash.differenceBy=hn,lodash.differenceWith=un,lodash.drop=drop,lodash.dropRight=dropRight,lodash.dropRightWhile=dropRightWhile,lodash.dropWhile=dropWhile,lodash.fill=fill,lodash.filter=filter,lodash.flatMap=flatMap,lodash.flatMapDeep=flatMapDeep,lodash.flatMapDepth=flatMapDepth,lodash.flatten=flatten,lodash.flattenDeep=flattenDeep,lodash.flattenDepth=flattenDepth,lodash.flip=flip,lodash.flow=wr,lodash.flowRight=Dr,lodash.fromPairs=fromPairs,lodash.functions=functions,lodash.functionsIn=functionsIn,lodash.groupBy=Dn,lodash.initial=initial,lodash.intersection=gn,lodash.intersectionBy=pn,lodash.intersectionWith=mn,lodash.invert=hr,lodash.invertBy=ur,lodash.invokeMap=On,lodash.iteratee=iteratee,lodash.keyBy=Nn,lodash.keys=keys,lodash.keysIn=keysIn,lodash.map=map,lodash.mapKeys=mapKeys,lodash.mapValues=mapValues,lodash.matches=matches,lodash.matchesProperty=matchesProperty,lodash.memoize=memoize,lodash.merge=pr,lodash.mergeWith=mr,lodash.method=Or,lodash.methodOf=Nr,lodash.mixin=mixin,lodash.negate=negate,lodash.nthArg=nthArg,lodash.omit=fr,lodash.omitBy=omitBy,lodash.once=once,lodash.orderBy=orderBy,lodash.over=kr,lodash.overArgs=Hn,lodash.overEvery=Lr,lodash.overSome=Fr,lodash.partial=$n,lodash.partialRight=Gn,lodash.partition=kn,lodash.pick=Sr,lodash.pickBy=pickBy,lodash.property=property,lodash.propertyOf=propertyOf,lodash.pull=fn,lodash.pullAll=pullAll,lodash.pullAllBy=pullAllBy,lodash.pullAllWith=pullAllWith,lodash.pullAt=Sn,lodash.range=xr,lodash.rangeRight=Ur,lodash.rearg=jn,lodash.reject=reject,lodash.remove=remove,lodash.rest=rest,lodash.reverse=reverse,lodash.sampleSize=sampleSize,lodash.set=set,lodash.setWith=setWith,lodash.shuffle=shuffle,lodash.slice=slice,lodash.sortBy=Ln,lodash.sortedUniq=sortedUniq,lodash.sortedUniqBy=sortedUniqBy,lodash.split=split,lodash.spread=spread,lodash.tail=tail,lodash.take=take,lodash.takeRight=takeRight,lodash.takeRightWhile=takeRightWhile,lodash.takeWhile=takeWhile,lodash.tap=tap,lodash.throttle=throttle,lodash.thru=thru,lodash.toArray=toArray,lodash.toPairs=vr,lodash.toPairsIn=Cr,lodash.toPath=toPath,lodash.toPlainObject=toPlainObject,lodash.transform=transform,lodash.unary=unary,lodash.union=vn,lodash.unionBy=Cn,lodash.unionWith=_n,lodash.uniq=uniq,lodash.uniqBy=uniqBy,lodash.uniqWith=uniqWith,lodash.unset=unset,lodash.unzip=unzip,lodash.unzipWith=unzipWith,lodash.update=update,lodash.updateWith=updateWith,lodash.values=values,lodash.valuesIn=valuesIn,lodash.without=yn,lodash.words=words,lodash.wrap=wrap,lodash.xor=En,lodash.xorBy=Tn,lodash.xorWith=In,lodash.zip=bn,lodash.zipObject=zipObject,lodash.zipObjectDeep=zipObjectDeep,lodash.zipWith=An,lodash.entries=vr,lodash.entriesIn=Cr,lodash.extend=sr,lodash.extendWith=ar,mixin(lodash,lodash),lodash.add=Vr,lodash.attempt=Pr,lodash.camelCase=_r,lodash.capitalize=capitalize,lodash.ceil=Br,lodash.clamp=clamp,lodash.clone=clone,lodash.cloneDeep=cloneDeep,lodash.cloneDeepWith=cloneDeepWith,lodash.cloneWith=cloneWith,lodash.conformsTo=conformsTo,lodash.deburr=deburr,lodash.defaultTo=defaultTo,lodash.divide=Hr,lodash.endsWith=endsWith,lodash.eq=eq,lodash.escape=escape,lodash.escapeRegExp=escapeRegExp,lodash.every=every,lodash.find=Mn,lodash.findIndex=findIndex,lodash.findKey=findKey,lodash.findLast=wn,lodash.findLastIndex=findLastIndex,lodash.findLastKey=findLastKey,lodash.floor=$r,lodash.forEach=forEach,lodash.forEachRight=forEachRight,lodash.forIn=forIn,lodash.forInRight=forInRight,lodash.forOwn=forOwn,lodash.forOwnRight=forOwnRight,lodash.get=get,lodash.gt=qn,lodash.gte=Wn,lodash.has=has,lodash.hasIn=hasIn,lodash.head=head,lodash.identity=identity,lodash.includes=includes,lodash.indexOf=indexOf,lodash.inRange=inRange,lodash.invoke=gr,lodash.isArguments=zn,lodash.isArray=Kn,lodash.isArrayBuffer=Jn,lodash.isArrayLike=isArrayLike,lodash.isArrayLikeObject=isArrayLikeObject,lodash.isBoolean=isBoolean,lodash.isBuffer=Yn,lodash.isDate=Qn,lodash.isElement=isElement,lodash.isEmpty=isEmpty,lodash.isEqual=isEqual,lodash.isEqualWith=isEqualWith,lodash.isError=isError,lodash.isFinite=isFinite,lodash.isFunction=isFunction,lodash.isInteger=isInteger,lodash.isLength=isLength,lodash.isMap=Xn,lodash.isMatch=isMatch,lodash.isMatchWith=isMatchWith,lodash.isNaN=isNaN,lodash.isNative=isNative,lodash.isNil=isNil,lodash.isNull=isNull,lodash.isNumber=isNumber,lodash.isObject=isObject,lodash.isObjectLike=isObjectLike,lodash.isPlainObject=isPlainObject,lodash.isRegExp=Zn,lodash.isSafeInteger=isSafeInteger,lodash.isSet=er,lodash.isString=isString,lodash.isSymbol=isSymbol,lodash.isTypedArray=tr,lodash.isUndefined=isUndefined,lodash.isWeakMap=isWeakMap,lodash.isWeakSet=isWeakSet,lodash.join=join,lodash.kebabCase=yr,lodash.last=last,lodash.lastIndexOf=lastIndexOf,lodash.lowerCase=Er,lodash.lowerFirst=Tr,lodash.lt=ir,lodash.lte=nr,lodash.max=max,lodash.maxBy=maxBy,lodash.mean=mean,lodash.meanBy=meanBy,lodash.min=min,lodash.minBy=minBy,lodash.stubArray=stubArray,lodash.stubFalse=stubFalse,lodash.stubObject=stubObject,lodash.stubString=stubString,lodash.stubTrue=stubTrue,lodash.multiply=jr,lodash.nth=nth,lodash.noConflict=noConflict,lodash.noop=noop,lodash.now=Fn,lodash.pad=pad,lodash.padEnd=padEnd,lodash.padStart=padStart,lodash.parseInt=parseInt,lodash.random=random,lodash.reduce=reduce,lodash.reduceRight=reduceRight,lodash.repeat=repeat,lodash.replace=replace,lodash.result=result,lodash.round=qr,lodash.runInContext=runInContext,lodash.sample=sample,lodash.size=size,lodash.snakeCase=Ir,lodash.some=some,lodash.sortedIndex=sortedIndex,lodash.sortedIndexBy=sortedIndexBy,lodash.sortedIndexOf=sortedIndexOf,lodash.sortedLastIndex=sortedLastIndex,lodash.sortedLastIndexBy=sortedLastIndexBy,lodash.sortedLastIndexOf=sortedLastIndexOf,lodash.startCase=br,lodash.startsWith=startsWith,lodash.subtract=Wr,lodash.sum=sum,lodash.sumBy=sumBy,lodash.template=template,lodash.times=times,lodash.toFinite=toFinite,lodash.toInteger=toInteger,lodash.toLength=toLength,lodash.toLower=toLower,lodash.toNumber=toNumber,lodash.toSafeInteger=toSafeInteger,lodash.toString=toString,lodash.toUpper=toUpper,lodash.trim=trim,lodash.trimEnd=trimEnd,lodash.trimStart=trimStart,lodash.truncate=truncate,lodash.unescape=unescape,lodash.uniqueId=uniqueId,lodash.upperCase=Ar,lodash.upperFirst=Rr,lodash.each=forEach,lodash.eachRight=forEachRight,lodash.first=head,mixin(lodash,(Gr={},baseForOwn(lodash,(function(g,m){Rt.call(lodash.prototype,m)||(Gr[m]=g)})),Gr),{chain:!1}),lodash.VERSION=v,arrayEach(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(g){lodash[g].placeholder=lodash})),arrayEach(["drop","take"],(function(g,m){LazyWrapper.prototype[g]=function(v){v=v===S?1:di(toInteger(v),0);var C=this.__filtered__&&!m?new LazyWrapper(this):this.clone();return C.__filtered__?C.__takeCount__=hi(v,C.__takeCount__):C.__views__.push({size:hi(v,ee),type:g+(C.__dir__<0?"Right":"")}),C},LazyWrapper.prototype[g+"Right"]=function(m){return this.reverse()[g](m).reverse()}})),arrayEach(["filter","map","takeWhile"],(function(g,m){var S=m+1,v=S==z||S==J;LazyWrapper.prototype[g]=function(g){var m=this.clone();return m.__iteratees__.push({iteratee:getIteratee(g,3),type:S}),m.__filtered__=m.__filtered__||v,m}})),arrayEach(["head","last"],(function(g,m){var S="take"+(m?"Right":"");LazyWrapper.prototype[g]=function(){return this[S](1).value()[0]}})),arrayEach(["initial","tail"],(function(g,m){var S="drop"+(m?"":"Right");LazyWrapper.prototype[g]=function(){return this.__filtered__?new LazyWrapper(this):this[S](1)}})),LazyWrapper.prototype.compact=function(){return this.filter(identity)},LazyWrapper.prototype.find=function(g){return this.filter(g).head()},LazyWrapper.prototype.findLast=function(g){return this.reverse().find(g)},LazyWrapper.prototype.invokeMap=baseRest((function(g,m){return"function"==typeof g?new LazyWrapper(this):this.map((function(S){return baseInvoke(S,g,m)}))})),LazyWrapper.prototype.reject=function(g){return this.filter(negate(getIteratee(g)))},LazyWrapper.prototype.slice=function(g,m){g=toInteger(g);var v=this;return v.__filtered__&&(g>0||m<0)?new LazyWrapper(v):(g<0?v=v.takeRight(-g):g&&(v=v.drop(g)),m!==S&&(v=(m=toInteger(m))<0?v.dropRight(-m):v.take(m-g)),v)},LazyWrapper.prototype.takeRightWhile=function(g){return this.reverse().takeWhile(g).reverse()},LazyWrapper.prototype.toArray=function(){return this.take(ee)},baseForOwn(LazyWrapper.prototype,(function(g,m){var v=/^(?:filter|find|map|reject)|While$/.test(m),C=/^(?:head|last)$/.test(m),_=lodash[C?"take"+("last"==m?"Right":""):m],E=C||/^find/.test(m);_&&(lodash.prototype[m]=function(){var m=this.__wrapped__,T=C?[1]:arguments,I=m instanceof LazyWrapper,b=T[0],A=I||Kn(m),interceptor=function(g){var m=_.apply(lodash,arrayPush([g],T));return C&&R?m[0]:m};A&&v&&"function"==typeof b&&1!=b.length&&(I=A=!1);var R=this.__chain__,P=!!this.__actions__.length,M=E&&!R,w=I&&!P;if(!E&&A){m=w?m:new LazyWrapper(this);var D=g.apply(m,T);return D.__actions__.push({func:thru,args:[interceptor],thisArg:S}),new LodashWrapper(D,R)}return M&&w?g.apply(this,T):(D=this.thru(interceptor),M?C?D.value()[0]:D.value():D)})})),arrayEach(["pop","push","shift","sort","splice","unshift"],(function(g){var m=Et[g],S=/^(?:push|sort|unshift)$/.test(g)?"tap":"thru",v=/^(?:pop|shift)$/.test(g);lodash.prototype[g]=function(){var g=arguments;if(v&&!this.__chain__){var C=this.value();return m.apply(Kn(C)?C:[],g)}return this[S]((function(S){return m.apply(Kn(S)?S:[],g)}))}})),baseForOwn(LazyWrapper.prototype,(function(g,m){var S=lodash[m];if(S){var v=S.name+"";Rt.call(Li,v)||(Li[v]=[]),Li[v].push({name:m,func:S})}})),Li[createHybrid(S,k).name]=[{name:"wrapper",func:S}],LazyWrapper.prototype.clone=lazyClone,LazyWrapper.prototype.reverse=lazyReverse,LazyWrapper.prototype.value=lazyValue,lodash.prototype.at=Rn,lodash.prototype.chain=wrapperChain,lodash.prototype.commit=wrapperCommit,lodash.prototype.next=wrapperNext,lodash.prototype.plant=wrapperPlant,lodash.prototype.reverse=wrapperReverse,lodash.prototype.toJSON=lodash.prototype.valueOf=lodash.prototype.value=wrapperValue,lodash.prototype.first=lodash.prototype.head,Gt&&(lodash.prototype[Gt]=wrapperToIterator),lodash},Mi=Pi();pi?((pi.exports=Mi)._=Mi,gi._=Mi):ui._=Mi}).call(C)})),M=createCommonjsModule((function(g,m){var S=window;!function(m,S){g.exports=S(R,P)}(0,((g,m)=>{var v={},C={exports:v},_=Object.create,E=Object.defineProperty,T=Object.getOwnPropertyDescriptor,I=Object.getOwnPropertyNames,b=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty,__commonJS=(g,m)=>function __require(){return m||(0,g[I(g)[0]])((m={exports:{}}).exports,m),m.exports},__export=(g,m)=>{for(var S in m)E(g,S,{get:m[S],enumerable:!0})},__copyProps=(g,m,S,v)=>{if(m&&"object"==typeof m||"function"==typeof m)for(let C of I(m))A.call(g,C)||C===S||E(g,C,{get:()=>m[C],enumerable:!(v=T(m,C))||v.enumerable});return g},__toESM=(g,m,S)=>(S=null!=g?_(b(g)):{},__copyProps(!m&&g&&g.__esModule?S:E(S,"default",{value:g,enumerable:!0}),g)),__toCommonJS=g=>__copyProps(E({},"__esModule",{value:!0}),g),__decorateClass=(g,m,S,v)=>{for(var C,_=v>1?void 0:v?T(m,S):m,I=g.length-1;I>=0;I--)(C=g[I])&&(_=(v?C(m,S,_):C(_))||_);return v&&_&&E(m,S,_),_},__decorateParam=(g,m)=>(S,v)=>m(S,v,g),M=__commonJS({"../node_modules/axios/lib/helpers/bind.js"(g,m){m.exports=function bind(g,m){return function wrap(){for(var S=new Array(arguments.length),v=0;v<S.length;v++)S[v]=arguments[v];return g.apply(m,S)}}}}),w=__commonJS({"../node_modules/axios/lib/utils.js"(g,m){var S=M(),v=Object.prototype.toString;function isArray4(g){return"[object Array]"===v.call(g)}function isUndefined7(g){return void 0===g}function isBuffer(g){return null!==g&&!isUndefined7(g)&&null!==g.constructor&&!isUndefined7(g.constructor)&&"function"==typeof g.constructor.isBuffer&&g.constructor.isBuffer(g)}function isArrayBuffer(g){return"[object ArrayBuffer]"===v.call(g)}function isFormData(g){return"undefined"!=typeof FormData&&g instanceof FormData}function isArrayBufferView(g){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(g):g&&g.buffer&&g.buffer instanceof ArrayBuffer}function isString3(g){return"string"==typeof g}function isNumber5(g){return"number"==typeof g}function isObject4(g){return null!==g&&"object"==typeof g}function isDate2(g){return"[object Date]"===v.call(g)}function isFile(g){return"[object File]"===v.call(g)}function isBlob(g){return"[object Blob]"===v.call(g)}function isFunction3(g){return"[object Function]"===v.call(g)}function isStream(g){return isObject4(g)&&isFunction3(g.pipe)}function isURLSearchParams(g){return"undefined"!=typeof URLSearchParams&&g instanceof URLSearchParams}function trim2(g){return g.replace(/^\s*/,"").replace(/\s*$/,"")}function isStandardBrowserEnv(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)}function forEach3(g,m){if(null!=g)if("object"!=typeof g&&(g=[g]),isArray4(g))for(var S=0,v=g.length;S<v;S++)m.call(null,g[S],S,g);else for(var C in g)Object.prototype.hasOwnProperty.call(g,C)&&m.call(null,g[C],C,g)}function merge5(){var g={};function assignValue(m,S){"object"==typeof g[S]&&"object"==typeof m?g[S]=merge5(g[S],m):g[S]=m}for(var m=0,S=arguments.length;m<S;m++)forEach3(arguments[m],assignValue);return g}function deepMerge(){var g={};function assignValue(m,S){"object"==typeof g[S]&&"object"==typeof m?g[S]=deepMerge(g[S],m):g[S]="object"==typeof m?deepMerge({},m):m}for(var m=0,S=arguments.length;m<S;m++)forEach3(arguments[m],assignValue);return g}function extend2(g,m,v){return forEach3(m,(function assignValue(m,C){g[C]=v&&"function"==typeof m?S(m,v):m})),g}m.exports={isArray:isArray4,isArrayBuffer:isArrayBuffer,isBuffer:isBuffer,isFormData:isFormData,isArrayBufferView:isArrayBufferView,isString:isString3,isNumber:isNumber5,isObject:isObject4,isUndefined:isUndefined7,isDate:isDate2,isFile:isFile,isBlob:isBlob,isFunction:isFunction3,isStream:isStream,isURLSearchParams:isURLSearchParams,isStandardBrowserEnv:isStandardBrowserEnv,forEach:forEach3,merge:merge5,deepMerge:deepMerge,extend:extend2,trim:trim2}}}),D=__commonJS({"../node_modules/axios/lib/helpers/buildURL.js"(g,m){var S=w();function encode(g){return encodeURIComponent(g).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}m.exports=function buildURL(g,m,v){if(!m)return g;var C;if(v)C=v(m);else if(S.isURLSearchParams(m))C=m.toString();else{var _=[];S.forEach(m,(function serialize(g,m){null!=g&&(S.isArray(g)?m+="[]":g=[g],S.forEach(g,(function parseValue(g){S.isDate(g)?g=g.toISOString():S.isObject(g)&&(g=JSON.stringify(g)),_.push(encode(m)+"="+encode(g))})))})),C=_.join("&")}if(C){var E=g.indexOf("#");-1!==E&&(g=g.slice(0,E)),g+=(-1===g.indexOf("?")?"?":"&")+C}return g}}}),O=__commonJS({"../node_modules/axios/lib/core/InterceptorManager.js"(g,m){var S=w();function InterceptorManager(){this.handlers=[]}InterceptorManager.prototype.use=function use(g,m){return this.handlers.push({fulfilled:g,rejected:m}),this.handlers.length-1},InterceptorManager.prototype.eject=function eject(g){this.handlers[g]&&(this.handlers[g]=null)},InterceptorManager.prototype.forEach=function forEach3(g){S.forEach(this.handlers,(function forEachHandler(m){null!==m&&g(m)}))},m.exports=InterceptorManager}}),N=__commonJS({"../node_modules/axios/lib/core/transformData.js"(g,m){var S=w();m.exports=function transformData(g,m,v){return S.forEach(v,(function transform(S){g=S(g,m)})),g}}}),k=__commonJS({"../node_modules/axios/lib/cancel/isCancel.js"(g,m){m.exports=function isCancel(g){return!(!g||!g.__CANCEL__)}}}),L=__commonJS({"../node_modules/axios/lib/helpers/normalizeHeaderName.js"(g,m){var S=w();m.exports=function normalizeHeaderName(g,m){S.forEach(g,(function processHeader(S,v){v!==m&&v.toUpperCase()===m.toUpperCase()&&(g[m]=S,delete g[v])}))}}}),F=__commonJS({"../node_modules/axios/lib/core/enhanceError.js"(g,m){m.exports=function enhanceError(g,m,S,v,C){return g.config=m,S&&(g.code=S),g.request=v,g.response=C,g.isAxiosError=!0,g.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},g}}}),x=__commonJS({"../node_modules/axios/lib/core/createError.js"(g,m){var S=F();m.exports=function createError(g,m,v,C,_){var E=new Error(g);return S(E,m,v,C,_)}}}),U=__commonJS({"../node_modules/axios/lib/core/settle.js"(g,m){var S=x();m.exports=function settle(g,m,v){var C=v.config.validateStatus;!C||C(v.status)?g(v):m(S("Request failed with status code "+v.status,v.config,null,v.request,v))}}}),V=__commonJS({"../node_modules/axios/lib/helpers/isAbsoluteURL.js"(g,m){m.exports=function isAbsoluteURL(g){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(g)}}}),B=__commonJS({"../node_modules/axios/lib/helpers/combineURLs.js"(g,m){m.exports=function combineURLs(g,m){return m?g.replace(/\/+$/,"")+"/"+m.replace(/^\/+/,""):g}}}),H=__commonJS({"../node_modules/axios/lib/core/buildFullPath.js"(g,m){var S=V(),v=B();m.exports=function buildFullPath(g,m){return g&&!S(m)?v(g,m):m}}}),$=__commonJS({"../node_modules/axios/lib/helpers/parseHeaders.js"(g,m){var S=w(),v=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];m.exports=function parseHeaders(g){var m,C,_,E={};return g?(S.forEach(g.split("\n"),(function parser(g){if(_=g.indexOf(":"),m=S.trim(g.substr(0,_)).toLowerCase(),C=S.trim(g.substr(_+1)),m){if(E[m]&&v.indexOf(m)>=0)return;E[m]="set-cookie"===m?(E[m]?E[m]:[]).concat([C]):E[m]?E[m]+", "+C:C}})),E):E}}}),G=__commonJS({"../node_modules/axios/lib/helpers/isValidXss.js"(g,m){m.exports=function isValidXss(g){return/(\b)(on\w+)=|javascript|(<\s*)(\/*)script/gi.test(g)}}}),j=__commonJS({"../node_modules/axios/lib/helpers/isURLSameOrigin.js"(g,m){var S=w(),v=G();m.exports=S.isStandardBrowserEnv()?function standardBrowserEnv(){var g,m=/(msie|trident)/i.test(navigator.userAgent),C=document.createElement("a");function resolveURL(g){var S=g;if(v(g))throw new Error("URL contains XSS injection attempt");return m&&(C.setAttribute("href",S),S=C.href),C.setAttribute("href",S),{href:C.href,protocol:C.protocol?C.protocol.replace(/:$/,""):"",host:C.host,search:C.search?C.search.replace(/^\?/,""):"",hash:C.hash?C.hash.replace(/^#/,""):"",hostname:C.hostname,port:C.port,pathname:"/"===C.pathname.charAt(0)?C.pathname:"/"+C.pathname}}return g=resolveURL(window.location.href),function isURLSameOrigin(m){var v=S.isString(m)?resolveURL(m):m;return v.protocol===g.protocol&&v.host===g.host}}():function nonStandardBrowserEnv(){return function isURLSameOrigin(){return!0}}()}}),q=__commonJS({"../node_modules/axios/lib/helpers/cookies.js"(g,m){var S=w();m.exports=S.isStandardBrowserEnv()?function standardBrowserEnv(){return{write:function write5(g,m,v,C,_,E){var T=[];T.push(g+"="+encodeURIComponent(m)),S.isNumber(v)&&T.push("expires="+new Date(v).toGMTString()),S.isString(C)&&T.push("path="+C),S.isString(_)&&T.push("domain="+_),!0===E&&T.push("secure"),document.cookie=T.join("; ")},read:function read(g){var m=document.cookie.match(new RegExp("(^|;\\s*)("+g+")=([^;]*)"));return m?decodeURIComponent(m[3]):null},remove:function remove6(g){this.write(g,"",Date.now()-864e5)}}}():function nonStandardBrowserEnv(){return{write:function write5(){},read:function read(){return null},remove:function remove6(){}}}()}}),W=__commonJS({"../node_modules/axios/lib/adapters/xhr.js"(g,m){var S=w(),v=U(),C=D(),_=H(),E=$(),T=j(),I=x();m.exports=function xhrAdapter(g){return new Promise((function dispatchXhrRequest(m,b){var A=g.data,R=g.headers;S.isFormData(A)&&delete R["Content-Type"];var P=new XMLHttpRequest;if(g.auth){var M=g.auth.username||"",w=g.auth.password||"";R.Authorization="Basic "+btoa(M+":"+w)}var D=_(g.baseURL,g.url);if(P.open(g.method.toUpperCase(),C(D,g.params,g.paramsSerializer),!0),P.timeout=g.timeout,P.onreadystatechange=function handleLoad(){if(P&&4===P.readyState&&(0!==P.status||P.responseURL&&0===P.responseURL.indexOf("file:"))){var S="getAllResponseHeaders"in P?E(P.getAllResponseHeaders()):null,C={data:g.responseType&&"text"!==g.responseType?P.response:P.responseText,status:P.status,statusText:P.statusText,headers:S,config:g,request:P};v(m,b,C),P=null}},P.onabort=function handleAbort(){P&&(b(I("Request aborted",g,"ECONNABORTED",P)),P=null)},P.onerror=function handleError(){b(I("Network Error",g,null,P)),P=null},P.ontimeout=function handleTimeout(){var m="timeout of "+g.timeout+"ms exceeded";g.timeoutErrorMessage&&(m=g.timeoutErrorMessage),b(I(m,g,"ECONNABORTED",P)),P=null},S.isStandardBrowserEnv()){var O=q(),N=(g.withCredentials||T(D))&&g.xsrfCookieName?O.read(g.xsrfCookieName):void 0;N&&(R[g.xsrfHeaderName]=N)}if("setRequestHeader"in P&&S.forEach(R,(function setRequestHeader(g,m){void 0===A&&"content-type"===m.toLowerCase()?delete R[m]:P.setRequestHeader(m,g)})),S.isUndefined(g.withCredentials)||(P.withCredentials=!!g.withCredentials),g.responseType)try{P.responseType=g.responseType}catch(m){if("json"!==g.responseType)throw m}"function"==typeof g.onDownloadProgress&&P.addEventListener("progress",g.onDownloadProgress),"function"==typeof g.onUploadProgress&&P.upload&&P.upload.addEventListener("progress",g.onUploadProgress),g.cancelToken&&g.cancelToken.promise.then((function onCanceled(g){P&&(P.abort(),b(g),P=null)})),void 0===A&&(A=null),P.send(A)}))}}}),z=__commonJS({"../node_modules/axios/lib/defaults.js"(g,m){var S=w(),v=L(),C={"Content-Type":"application/x-www-form-urlencoded"};function setContentTypeIfUnset(g,m){!S.isUndefined(g)&&S.isUndefined(g["Content-Type"])&&(g["Content-Type"]=m)}function getDefaultAdapter(){var g;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(g=W()),g}var _={adapter:getDefaultAdapter(),transformRequest:[function transformRequest(g,m){return v(m,"Accept"),v(m,"Content-Type"),S.isFormData(g)||S.isArrayBuffer(g)||S.isBuffer(g)||S.isStream(g)||S.isFile(g)||S.isBlob(g)?g:S.isArrayBufferView(g)?g.buffer:S.isURLSearchParams(g)?(setContentTypeIfUnset(m,"application/x-www-form-urlencoded;charset=utf-8"),g.toString()):S.isObject(g)?(setContentTypeIfUnset(m,"application/json;charset=utf-8"),JSON.stringify(g)):g}],transformResponse:[function transformResponse(g){if("string"==typeof g)try{g=JSON.parse(g)}catch(g){}return g}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function validateStatus(g){return g>=200&&g<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};S.forEach(["delete","get","head"],(function forEachMethodNoData(g){_.headers[g]={}})),S.forEach(["post","put","patch"],(function forEachMethodWithData(g){_.headers[g]=S.merge(C)})),m.exports=_}}),K=__commonJS({"../node_modules/axios/lib/core/dispatchRequest.js"(g,m){var S=w(),v=N(),C=k(),_=z();function throwIfCancellationRequested(g){g.cancelToken&&g.cancelToken.throwIfRequested()}m.exports=function dispatchRequest(g){return throwIfCancellationRequested(g),g.headers=g.headers||{},g.data=v(g.data,g.headers,g.transformRequest),g.headers=S.merge(g.headers.common||{},g.headers[g.method]||{},g.headers),S.forEach(["delete","get","head","post","put","patch","common"],(function cleanHeaderConfig(m){delete g.headers[m]})),(g.adapter||_.adapter)(g).then((function onAdapterResolution(m){return throwIfCancellationRequested(g),m.data=v(m.data,m.headers,g.transformResponse),m}),(function onAdapterRejection(m){return C(m)||(throwIfCancellationRequested(g),m&&m.response&&(m.response.data=v(m.response.data,m.response.headers,g.transformResponse))),Promise.reject(m)}))}}}),J=__commonJS({"../node_modules/axios/lib/core/mergeConfig.js"(g,m){var S=w();m.exports=function mergeConfig(g,m){m=m||{};var v={},C=["url","method","params","data"],_=["headers","auth","proxy"],E=["baseURL","url","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"];S.forEach(C,(function valueFromConfig2(g){void 0!==m[g]&&(v[g]=m[g])})),S.forEach(_,(function mergeDeepProperties(C){S.isObject(m[C])?v[C]=S.deepMerge(g[C],m[C]):void 0!==m[C]?v[C]=m[C]:S.isObject(g[C])?v[C]=S.deepMerge(g[C]):void 0!==g[C]&&(v[C]=g[C])})),S.forEach(E,(function defaultToConfig2(S){void 0!==m[S]?v[S]=m[S]:void 0!==g[S]&&(v[S]=g[S])}));var T=C.concat(_).concat(E),I=Object.keys(m).filter((function filterAxiosKeys(g){return-1===T.indexOf(g)}));return S.forEach(I,(function otherKeysDefaultToConfig2(S){void 0!==m[S]?v[S]=m[S]:void 0!==g[S]&&(v[S]=g[S])})),v}}}),Y=__commonJS({"../node_modules/axios/lib/core/Axios.js"(g,m){var S=w(),v=D(),C=O(),_=K(),E=J();function Axios(g){this.defaults=g,this.interceptors={request:new C,response:new C}}Axios.prototype.request=function request(g){"string"==typeof g?(g=arguments[1]||{}).url=arguments[0]:g=g||{},(g=E(this.defaults,g)).method?g.method=g.method.toLowerCase():this.defaults.method?g.method=this.defaults.method.toLowerCase():g.method="get";var m=[_,void 0],S=Promise.resolve(g);for(this.interceptors.request.forEach((function unshiftRequestInterceptors(g){m.unshift(g.fulfilled,g.rejected)})),this.interceptors.response.forEach((function pushResponseInterceptors(g){m.push(g.fulfilled,g.rejected)}));m.length;)S=S.then(m.shift(),m.shift());return S},Axios.prototype.getUri=function getUri(g){return g=E(this.defaults,g),v(g.url,g.params,g.paramsSerializer).replace(/^\?/,"")},S.forEach(["delete","get","head","options"],(function forEachMethodNoData(g){Axios.prototype[g]=function(m,v){return this.request(S.merge(v||{},{method:g,url:m}))}})),S.forEach(["post","put","patch"],(function forEachMethodWithData(g){Axios.prototype[g]=function(m,v,C){return this.request(S.merge(C||{},{method:g,url:m,data:v}))}})),m.exports=Axios}}),Q=__commonJS({"../node_modules/axios/lib/cancel/Cancel.js"(g,m){function Cancel(g){this.message=g}Cancel.prototype.toString=function toString(){return"Cancel"+(this.message?": "+this.message:"")},Cancel.prototype.__CANCEL__=!0,m.exports=Cancel}}),X=__commonJS({"../node_modules/axios/lib/cancel/CancelToken.js"(g,m){var S=Q();function CancelToken(g){if("function"!=typeof g)throw new TypeError("executor must be a function.");var m;this.promise=new Promise((function promiseExecutor(g){m=g}));var v=this;g((function cancel(g){v.reason||(v.reason=new S(g),m(v.reason))}))}CancelToken.prototype.throwIfRequested=function throwIfRequested(){if(this.reason)throw this.reason},CancelToken.source=function source(){var g;return{token:new CancelToken((function executor(m){g=m})),cancel:g}},m.exports=CancelToken}}),Z=__commonJS({"../node_modules/axios/lib/helpers/spread.js"(g,m){m.exports=function spread(g){return function wrap(m){return g.apply(null,m)}}}}),ee=__commonJS({"../node_modules/axios/lib/axios.js"(g,m){var S=w(),v=M(),C=Y(),_=J();function createInstance(g){var m=new C(g),_=v(C.prototype.request,m);return S.extend(_,C.prototype,m),S.extend(_,m),_}var E=createInstance(z());E.Axios=C,E.create=function create(g){return createInstance(_(E.defaults,g))},E.Cancel=Q(),E.CancelToken=X(),E.isCancel=k(),E.all=function all(g){return Promise.all(g)},E.spread=Z(),m.exports=E,m.exports.default=E}}),te=__commonJS({"../node_modules/axios/index.js"(g,m){m.exports=ee()}}),ie=__commonJS({"../node_modules/@skype/hydra_player_hls_sdk/hydra_player_hls_sdk_bundle.js"(g,m){var S,v;S=g,v=function(){return g={458:function(g,m,S){var v=this&&this.__assign||function(){return v=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},v.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.LiveStreamStatistic=void 0;var C=S(844),_=S(68),E=S(63),T=S(329),I=function(){function e3(g,m,S){this.name=g,this.stopCrash=m,this.start(S)}return e3.prototype.complete=function(){try{T.assert(this.startTime,"not started",this.stopCrash),T.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(g){if(this.name!==C.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==C.PlayerScenarioType.HlsKeyLoad)throw g}this.duration=Date.now()-this.startTime},e3.prototype.fail=function(g){this.failReason=g,this.complete()},e3.prototype.setDetail=function(g){this.details=g},e3.prototype.getTelemetryEvent=function(){T.assert(this.startTime,"not started",this.stopCrash);var g={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(g.failReason=this.failReason),this.details&&(g.details=this.details),g},e3.prototype.getName=function(){return this.name},e3.prototype.getDuration=function(){var g;return null!==(g=this.duration)&&void 0!==g?g:0},e3.prototype.getFailReason=function(){return this.failReason},e3.prototype.getDetails=function(){return this.details},e3.prototype.start=function(g){T.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),g&&(this.details=g)},e3.prototype.updateDetails=function(g,m){if(this.details&&"object"==typeof this.details)for(var S=0;S<g.length;S++)this.details[g[S]]=m[S]},e3}(),b=function(){function e3(g,m,S,v,C){this.config=g,this.logFn=m,this.playerDiagnosticsLog=S,this.playerMetadata=v,this.hydraInitResult=C,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.isCallRecovered=!1,this.isCallInErrorState=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=g.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=g.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=g.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=g.maxPlayerExperimentalEvents||100,T.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e3.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e3.prototype.registerStatsUpdated=function(g){var m=this;this.currentPlayerDiagnosticSnapshot=g,Object.keys(this.playerDiagnosticsLog).forEach((function(S){var v,C=S,_=null!==(v=m.playerDiagnosticsLog[S])&&void 0!==v?v:[];if(Array.isArray(_)){_.push(g[C]);var E="memoryLog"===C&&_.length>m.maxPlayerMemoryTraceLogCount,T="memoryLog"!==C&&_.length>m.maxPlayerDiagnosticsCount;(E||T)&&_.splice(0,1)}else m.playerDiagnosticsLog[S]=g[C]}))},e3.prototype.registerEventLoadAttempt=function(g,m){this.registerScenario(g,m)},e3.prototype.registerEventLoadFailed=function(g,m){this.completeScenario(g,m)},e3.prototype.registerEventLoadSucceeded=function(g,m){this.completeScenario(g,void 0,m),g===C.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e3.prototype.registerSdnPluginLoadAttempt=function(g){this.registerScenario(C.PlayerScenarioType.SdnPluginLoad,JSON.stringify(g))},e3.prototype.registerSdnPluginLoadFailed=function(g){this.completeScenario(C.PlayerScenarioType.SdnPluginLoad,g)},e3.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(C.PlayerScenarioType.SdnPluginLoad)},e3.prototype.registerStreamConnectionAttempt=function(g){this.registerScenario(C.PlayerScenarioType.StreamConnection,{streamUrl:g})},e3.prototype.registerStreamConnectionSucceeded=function(g){var m=this.getScenario(C.PlayerScenarioType.StreamConnection);null==m||m.updateDetails(["results"],[T.stringifyObject(g)]),this.completeScenario(C.PlayerScenarioType.StreamConnection)},e3.prototype.registerStreamConnectionFailed=function(g,m){var S=this.getScenario(C.PlayerScenarioType.StreamConnection);null==S||S.updateDetails(["results"],[T.stringifyObject(m)]),this.completeScenario(C.PlayerScenarioType.StreamConnection,g)},e3.prototype.registerSetSourceAttempt=function(g,m,S){var v=g||"";S&&(v={src:g||"",isPrimary:T.stringifyObject(m),reason:S}),this.registerScenario(C.PlayerScenarioType.SetSource,v)},e3.prototype.registerSetSourceSucceeded=function(g,m,S,v){var _=this.getScenario(C.PlayerScenarioType.SetSource);T.assert(_,"no SetSource scenario to update details",this.stopCrash),null==_||_.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[g,T.stringifyObject(m),T.stringifyObject(S),T.stringifyObject(v)]),this.completeScenario(C.PlayerScenarioType.SetSource)},e3.prototype.registerSetSourceFailed=function(g,m,S,v,_){var E=null!=m?m:"Failed to find stream url",I=this.getScenario(C.PlayerScenarioType.SetSource);T.assert(I,"no SetSource scenario to update details",this.stopCrash),null==I||I.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[E,T.stringifyObject(S),T.stringifyObject(v),T.stringifyObject(_)]),this.completeScenario(C.PlayerScenarioType.SetSource,g)},e3.prototype.registerPlayerDestroyed=function(g){this.callDropped=g===E.HydraPlayerDestroyedReason.PlaybackError,this.registerScenario(C.PlayerScenarioType.Destroyed,g),this.completeScenario(C.PlayerScenarioType.Destroyed)},e3.prototype.updateCallRecovered=function(g){this.isCallInErrorState&&g===_.HydraPlayerPlaybackState.Playing&&(this.isCallRecovered=!0,this.isCallInErrorState=!1)},e3.prototype.registerPlaybackStateChanged=function(g){g!==_.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?g!==_.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(C.TelemetryEventType.StateChanged,g),this.updateCallRecovered(g)},e3.prototype.registerHydraInputStateChanged=function(g,m){this.registerPlaybackEvent(C.TelemetryEventType.HydraInputStateChanged,g,m)},e3.prototype.registerHydraOutputStateChanged=function(g,m){this.registerPlaybackEvent(C.TelemetryEventType.HydraOutputStateChanged,g,m)},e3.prototype.registerPlaybackBuffering=function(g){this.registerPlaybackEvent(C.TelemetryEventType.Buffering,g)},e3.prototype.registerPlaybackError=function(g,m,S){this.registerPlaybackEvent(C.TelemetryEventType.Error,{errorType:g,details:m,errorSource:S})},e3.prototype.registerDownloadBitrateChanged=function(g){this.registerPlaybackEvent(C.TelemetryEventType.BitrateChangedDownload,g)},e3.prototype.registerStreamOptionsConfigured=function(g,m){this.registerPlaybackEvent(C.TelemetryEventType.StreamOptionsConfigured,g,m)},e3.prototype.registerPlaybackBitrateChanged=function(g){this.registerPlaybackEvent(C.TelemetryEventType.BitrateChangedPlayback,g)},e3.prototype.registerVolumeChange=function(g){this.registerPlaybackEvent(C.TelemetryEventType.Volume,g)},e3.prototype.getSnapshotReport=function(){var g,m,S=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),C=this.playbackEvents,_={};return this.currentPlayerDiagnosticSnapshot&&(_=this.filterAndPrepareTelemetry()),v(v(v(v(v(v(v(v(v(v(v(v(v({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(S,C)),this.getHydraInternalReport(C)),this.getPlaybackReport(C)),this.getBitrateReport(C)),this.getStreamConnectionReport(S)),this.getSdnReport(S)),this.getSetSourceReport(S)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),_)},e3.prototype.getReport=function(){var g,m,S=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),C=this.playbackEvents;return v(v(v(v(v(v(v(v(v(v(v(v(v({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(S,C)),this.getHydraInternalReport(C)),this.getPlaybackReport(C)),this.getBitrateReport(C)),this.getStreamConnectionReport(S)),this.getSdnReport(S)),this.getSetSourceReport(S)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),this.getPlayerDiagnosticLog())},e3.prototype.getHydraLoadEvent=function(){var g,m,S,v={name:C.PlayerScenarioType.LoadHydra,startTime:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initStartTime)||-1,duration:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initDuration)||0};(null===(S=this.hydraInitResult)||void 0===S?void 0:S.errorMsg)&&(v.failReason=this.hydraInitResult.errorMsg);var _=this.getHydraRuntimeDownloadDetails();return _&&(v.details=_),v},e3.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var g=[],m=0,S=this.hydraInitResult.runtimeDownloadResults;m<S.length;m++){var v=S[m],C={success:v.success,url:v.url,startTime:v.startTime,duration:v.duration,trackingReference:v.trackingReference,timeTakenToDownloadScript:v.timeTakenToDownloadScript};v.errorMsg&&(C.errorMsg=v.errorMsg),g.push(C)}return T.stringifyObject(g)}return null},e3.prototype.getTotalLoadEvent=function(){var g,m,S,v=this.playerEvents.find((function(g){return g.getName()===C.PlayerScenarioType.LoadPlayer})),_=(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initDuration)||0,E=(null==v?void 0:v.getDuration())||0,T=null==v?void 0:v.getFailReason(),I={name:C.PlayerScenarioType.Load,startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,duration:_+E};return(null===(S=this.hydraInitResult)||void 0===S?void 0:S.errorMsg)?I.failReason=this.hydraInitResult.errorMsg:T&&(I.failReason=T),I},e3.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e3.prototype.registerPlaybackEvent=function(g,m,S){var v=this.createTelemetryEvent(g,m,S);g===C.TelemetryEventType.Error&&(null==m?void 0:m.errorType)!==_.HydraPlayerPlaybackErrorType.PlaybackRetried&&(v.fatal=!0,this.isCallInErrorState=!0),this.playbackEvents.push(v),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(v)},e3.prototype.getPlayerDiagnosticLog=function(){var g=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var m=this.currentPlayerDiagnosticSnapshot,S=this.playerDiagnosticsLog,C=v(v({},m),S),_={};return Object.keys(C).forEach((function(m){_["player_".concat(m)]=g.prepareForTelemetry(C[m])})),_},e3.prototype.getHydraInitializationReport=function(){var g,m,S,v;return{hydraInit_succeeded:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initSucceeded)||!1,hydraInit_startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,hydraInit_errorMessage:(null===(S=this.hydraInitResult)||void 0===S?void 0:S.errorMsg)||"",hydraInit_duration:(null===(v=this.hydraInitResult)||void 0===v?void 0:v.initDuration)||0}},e3.prototype.getPlayerInitializationReport=function(g,m){var S=g.find((function(g){return g.name===C.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=S&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-S.startTime:-1)||-1,init_timeLoadToReady:(null!=S&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-S.startTime:-1)||-1,init_timeLoadToPlaying:(null!=S&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-S.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(g)}},e3.prototype.getHydraInternalReport=function(g){var m=g.filter((function(g){return g.eventType===C.TelemetryEventType.HydraInputStateChanged})),S=g.filter((function(g){return g.eventType===C.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(m),hydra_outputStateChangeEvents:this.prepareForTelemetry(S)}},e3.prototype.getPlaybackReport=function(g){var m=g.filter((function(g){return g.eventType===C.TelemetryEventType.StateChanged})),S=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.CanPlayThrough})),v=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.Play})),E=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.Start})),T=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.Playing})),I=null!=S&&null!=v?v.timestamp-S.timestamp:-1,b=null!=v&&null!=E?E.timestamp-v.timestamp:-1,A=null!=E&&null!=T?T.timestamp-E.timestamp:-1,R=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Seeked})),P=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Seeking})),M=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Pause})),w=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Waiting})),D=[C.TelemetryEventType.BitrateChangedDownload,C.TelemetryEventType.BitrateChangedPlayback,C.TelemetryEventType.Error,C.TelemetryEventType.Mute,C.TelemetryEventType.StateChanged,C.TelemetryEventType.Volume,C.TelemetryEventType.StreamOptionsConfigured],O=g.filter((function(g){return g.eventType===C.TelemetryEventType.Error})),N=g.filter((function(g){return g.eventType===C.TelemetryEventType.Volume||g.eventType===C.TelemetryEventType.Mute})),k=g.filter((function(g){return g.eventType===C.TelemetryEventType.StreamOptionsConfigured})),L=g.filter((function(g){return!D.includes(g.eventType)}));return{playback_timeReadyToPlay:I,playback_timePlayToStart:b,playback_timeStartToPlaying:A,playback_bufferingEvents:this.prepareForTelemetry(w),playback_errorEvents:this.prepareForTelemetry(O),playback_pauseEvents:this.prepareForTelemetry(M),playback_otherEvents:this.prepareForTelemetry(L),playback_seekedEvents:this.prepareForTelemetry(R),playback_seekingEvents:this.prepareForTelemetry(P),playback_stateChangeEvents:this.prepareForTelemetry(m),playback_volumeEvents:this.prepareForTelemetry(N),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(k)}},e3.prototype.getBitrateReport=function(g){var m,S,_,E,T=g.filter((function(g){return g.eventType===C.TelemetryEventType.BitrateChangedDownload})),I=T.sort((function(g){return Number(g.payload)})),b=T.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(T),bitrate_downloadChangeCount:T.length>0||-1,bitrate_downloadMin:(null===(m=I[0])||void 0===m?void 0:m.payload)||-1,bitrate_downloadMax:(null===(S=I[I.length-1])||void 0===S?void 0:S.payload)||-1}:{},A=g.filter((function(g){return g.eventType===C.TelemetryEventType.BitrateChangedPlayback})),R=A.sort((function(g){return Number(g.payload)})),P=A.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(A),bitrate_playbackChangeCount:A.length>0||-1,bitrate_playbackMin:(null===(_=R[0])||void 0===_?void 0:_.payload)||-1,bitrate_playbackMax:(null===(E=R[R.length-1])||void 0===E?void 0:E.payload)||-1}:{};return v(v({},b),P)},e3.prototype.addNetworkTypeEventListener=function(){var g,m,S,v,C=this;(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)&&(null===(v=null===(S=window.navigator)||void 0===S?void 0:S.connection)||void 0===v||v.addEventListener("change",(function(){C.updateClientNetworkType()})))},e3.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e3.prototype.getClientNetworkType=function(){var g,m,S,v;if(void 0===this.clientNetworkType){var C="Unknown";if(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)switch(null===(v=null===(S=window.navigator)||void 0===S?void 0:S.connection)||void 0===v?void 0:v.type){case"cellular":C="WWAN";break;case"ethernet":C="Wired";break;case"wifi":C="Wireless";break;default:C="Unknown"}this.clientNetworkType=C}return this.clientNetworkType},e3.prototype.getSdnReport=function(g){var m,S,v=g.filter((function(g){return g.name===C.PlayerScenarioType.SdnPluginLoad})),_=v.length>0?v[v.length-1]:void 0;return{sdn_loaded:!(null==_||void 0!==_.failReason),sdn_details:null!==(m=null==_?void 0:_.details)&&void 0!==m?m:"",sdn_error:null!==(S=null==_?void 0:_.failReason)&&void 0!==S?S:"",sdn_events:this.prepareForTelemetry(v)}},e3.prototype.getStreamConnectionReport=function(g){var m=g.filter((function(g){return g.name===C.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(m)}},e3.prototype.getSetSourceReport=function(g){var m=g.filter((function(g){return g.name===C.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(m)}},e3.prototype.registerScenario=function(g,m){var S=this.currentScenarioMap.get(g),v=new I(g,this.stopCrash,m);try{T.assert(null==S,"previous scenario:".concat(T.stringifyObject(S)," is not completed, new scenario:").concat(T.stringifyObject(v)),this.stopCrash)}catch(m){if(g!==C.PlayerScenarioType.LoadHlsFirstFragment&&g!==C.PlayerScenarioType.HlsKeyLoad)throw m}this.currentScenarioMap.set(g,v),this.playerEvents.push(v)},e3.prototype.completeScenario=function(g,m,S){var v=this.currentScenarioMap.get(g);try{T.assert(v,"no scenario to complete",this.stopCrash)}catch(m){if(g!==C.PlayerScenarioType.LoadHlsFirstFragment&&g!==C.PlayerScenarioType.HlsKeyLoad)throw m}m?null==v||v.fail(m):(g!==C.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),S&&(null==v||v.setDetail(S)),null==v||v.complete()),this.currentScenarioMap.delete(g)},e3.prototype.logTelemetryEvent=function(g){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(g))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e3.prototype.filterAndPrepareTelemetry=function(){var g=this,m=new Set;m.add("serviceLatencyCdg"),m.add("endToEndLatencyCdg"),m.add("videoEdgeLatencyCdg");var S={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(v){m.has(v)||(S["player_".concat(v)]=g.prepareForTelemetry(g.currentPlayerDiagnosticSnapshot[v]))})),S},e3.prototype.prepareForTelemetry=function(g){return"boolean"==typeof g?g:"string"==typeof g||void 0===g?g||"":"number"==typeof g?null!=g?g:-1:JSON.stringify(g)},e3.prototype.getScenario=function(g){return this.currentScenarioMap.get(g)},e3.prototype.createTelemetryEvent=function(g,m,S){var v,C,_={eventType:g,timestamp:Date.now(),currentPlayPosition:null!==(C=null===(v=this.currentPlayerDiagnosticSnapshot)||void 0===v?void 0:v.currentPlayPosition)&&void 0!==C?C:-1};return void 0!==m&&(_.payload=this.prepareForTelemetry(m)),_.message=S,_},e3.prototype.registerExperimentalEvent=function(g,m,S){var v=this.createTelemetryEvent(g,m,S);this.experimentalEvents.push(v),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(v)},e3.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e3}();m.LiveStreamStatistic=b},751:function(g,m){var S,v,C,_,E,T;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(T=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",T.HLS="MiddleLaneHttpLiveStreaming",T.Ums="MiddleLaneUltraLowLatency",(E=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",E.PlayerInitializationFailed="PlayerInitializationFailed",E.InvalidStream="InvalidStream",E.SetSourceFailed="SetSourceFailed",(_=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",_.LoadedData="loadeddata",_.LoadedMetadata="loadedmetadata",_.Start="start",_.CanPlayThrough="canplaythrough",_.Play="play",_.Playing="playing",_.Pause="pause",_.Waiting="waiting",_.Seeking="seeking",_.Seeked="seeked",_.Ended="ended",_.Error="error",_.Destroyed="destroyed",_.Initialized="initialized",_.Stalled="stalled",_.VolumeChange="volumechange",_.PlaybackBitrateChanged="playbackbitratechanged",_.DownloadBitrateChanged="downloadbitratechanged",_.HlsKeyLoading="hlsKeyLoading",_.HlsKeyLoaded="hlsKeyLoaded",_.HlsKeyLoadedFailed="hlsKeyLoadedFailed",_.HlsManifestLoading="hlsManifestLoading",_.HlsManifestLoaded="hlsManifestLoaded",_.HlsManifestLoadedFailed="hlsManifestLoadedFailed",_.HlsFirstFragmentLoading="hlsFragLoading",_.HlsFirstFragmentBuffered="hlsFragBuffered",_.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",_.Online="online",_.Offline="offline",_.NetworkChange="networkChange",(C=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",C.NetworkError="NetworkError",C.PlaybackRetried="PlaybackRetried",C.PlaybackError="PlaybackError",C.Unknown="Unknown",(v=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",v.Overflow="Overflow",v.TownHallBasic="TownHall_Basic",v.TownHallPremium="TownHall_Premium",v.TownHall="TownHall",(S=m.HydraPlayerType||(m.HydraPlayerType={}))[S.Hls=1]="Hls",S[S.Ums=2]="Ums"},855:function(g,m,S){var v=this&&this.__createBinding||(Object.create?function(g,m,S,v){void 0===v&&(v=S);var C=Object.getOwnPropertyDescriptor(m,S);C&&!("get"in C?!m.__esModule:C.writable||C.configurable)||(C={enumerable:!0,get:function(){return m[S]}}),Object.defineProperty(g,v,C)}:function(g,m,S,v){void 0===v&&(v=S),g[v]=m[S]}),C=this&&this.__exportStar||function(g,m){for(var S in g)"default"===S||Object.prototype.hasOwnProperty.call(m,S)||v(m,g,S)};Object.defineProperty(m,"__esModule",{value:!0}),C(S(952),m),C(S(751),m)},952:function(g,m,S){var v=this&&this.__assign||function(){return v=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},v.apply(this,arguments)},C=this&&this.__awaiter||function(g,m,S,v){return new(S||(S=Promise))((function(C,_){function o2(g){try{l2(v.next(g))}catch(g){_(g)}}function s2(g){try{l2(v.throw(g))}catch(g){_(g)}}function l2(g){var m;g.done?C(g.value):(m=g.value,m instanceof S?m:new S((function(g){g(m)}))).then(o2,s2)}l2((v=v.apply(g,m||[])).next())}))},_=this&&this.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function s2(T){return function(I){return function(T){if(S)throw new TypeError("Generator is already executing.");for(;_&&(_=0,T[0]&&(E=0)),E;)try{if(S=1,v&&(C=2&T[0]?v.return:T[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,T[1])).done)return C;switch(v=0,C&&(T=[2&T[0],C.value]),T[0]){case 0:case 1:C=T;break;case 4:return E.label++,{value:T[1],done:!1};case 5:E.label++,v=T[1],T=[0];continue;case 7:T=E.ops.pop(),E.trys.pop();continue;default:if(!((C=(C=E.trys).length>0&&C[C.length-1])||6!==T[0]&&2!==T[0])){E=0;continue}if(3===T[0]&&(!C||T[1]>C[0]&&T[1]<C[3])){E.label=T[1];break}if(6===T[0]&&E.label<C[1]){E.label=C[1],C=T;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(T);break}C[2]&&E.ops.pop(),E.trys.pop();continue}T=m.call(g,E)}catch(g){T=[6,g],v=0}finally{S=C=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}([T,I])}}},E=this&&this.__spreadArray||function(g,m,S){if(S||2===arguments.length)for(var v,C=0,_=m.length;C<_;C++)!v&&C in m||(v||(v=Array.prototype.slice.call(m,0,C)),v[C]=m[C]);return g.concat(v||Array.prototype.slice.call(m))};Object.defineProperty(m,"__esModule",{value:!0}),m.HlsHydraPlayer=m.getSdkVersion=void 0;var T=S(124),I=S(68),b=S(328),A=S(844),R=S(944),P=S(329),M=S(63),w=S(458);m.getSdkVersion=function(){return"4.2430.2"};var D=function(){function e3(g,m){this.playerSettings=g,this.eventHandler=m,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2430.2"}return Object.defineProperty(e3.prototype,"contextWindow",{get:function(){var g;return null===(g=this.container)||void 0===g?void 0:g.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e3.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var g=(0,P.getMajorFromVersion)("4.2430.2");return g&&this.playerSettings.playerRuntimeJsUrls[g]||[]}return this.playerSettings.playerRuntimeJsUrls},e3.prototype.initializeIFrame=function(g){return C(this,void 0,void 0,(function(){var m;return _(this,(function(S){switch(S.label){case 0:return this.container=g,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2430.2",', URLs: "').concat((0,P.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,P.createIFrame)(g,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(m=S.sent()).initResult.initSucceeded&&m.iframe&&(this.iframe=m.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,m.initResult]}}))}))},e3.prototype.setup=function(g){return C(this,void 0,void 0,(function(){var m;return _(this,(function(S){switch(S.label){case 0:return this.spinner=new P.Spinner(g),[4,this.initializeIFrame(g)];case 1:return m=S.sent(),this.telemetryReportHandler=new N(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),m,this.spinner),this.playerInternalEventHandler=new O(this.spinner,this.telemetryReportHandler),m.initSucceeded?[4,this.sendCommand("createHlsHydraPlayer",this.playerSettings,m)]:[3,3];case 2:return S.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(m.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e3.prototype.isIFrameCommunicationActive=function(){var g;return!!(null===(g=this.iframe)||void 0===g?void 0:g.contentWindow)&&!!this.contextWindow},e3.prototype.getFullTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getFullTelemetryReport())||{}},e3.prototype.getSnapshotTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getSnapshotTelemetryReport())||{}},e3.prototype.callPlayerApi=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];return C(this,void 0,void 0,(function(){return _(this,(function(S){switch(S.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,E([g],m,!1))]:[3,2];case 1:case 3:return[2,S.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e3.prototype.dispose=function(){var g;null===(g=this.telemetryReportHandler)||void 0===g||g.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e3.prototype.release=function(){var g;null===(g=this.spinner)||void 0===g||g.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e3.prototype.sendCommand=function(g){for(var m,S,v=[],E=1;E<arguments.length;E++)v[E-1]=arguments[E];return C(this,void 0,void 0,(function(){var C,E,I;return _(this,(function(_){switch(_.label){case 0:if(C={msgType:T.MessageType.Command,name:g,args:v},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(E=this.commandResultsMap.get(g.toString()))&&E.reject(new Error("function ".concat(g," is invoked again, before previous call is completed"))),I=R.defer(),this.commandResultsMap.set(g,I),null===(S=null===(m=this.iframe)||void 0===m?void 0:m.contentWindow)||void 0===S||S.postMessage(C,"*"),[4,I.promise];case 1:return[2,_.sent()]}}))}))},e3.prototype.onMessage=function(g){switch(g.data.msgType){case T.MessageType.PlayerEvent:this.processPlayerEvent(g.data);break;case T.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(g.data);break;case T.MessageType.CommandSuccessResult:this.processCommandSuccessResult(g.data);break;case T.MessageType.CommandFailureResult:this.processCommandFailureResult(g.data)}},e3.prototype.processCommandSuccessResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.resolve(g.result),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processCommandFailureResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.reject(g.error),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processPlayerEvent=function(g){this.eventHandler[g.name].apply(this.eventHandler,g.args)},e3.prototype.processInternalPlayerEvent=function(g){this.playerInternalEventHandler&&this.playerInternalEventHandler[g.name].apply(this,g.args)},e3}();m.HlsHydraPlayer=D;var O=function(){function e3(g,m){this.spinner=g,this.telemetryReportHandler=m}return e3.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e3.prototype.fullTelemetryReportUpdated=function(g){this.telemetryReportHandler.setFullTelemetryReport(g)},e3.prototype.snapshotTelemetryReportUpdated=function(g){this.telemetryReportHandler.setSnapshotTelemetryReport(g)},e3}(),N=function(){function e3(g,m,S,v){var C=this;this.logFn=m,this.spinner=v;var _=new w.LiveStreamStatistic(g,(function(g,m){C.logFn(g,m)}),{perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],statsInterval:[],serviceAvgLatency:[],endToEndAvgLatency:[]},{hydraPlayerSdkVersion:g.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:b.HydraPlayerType.Hls},S);this.fullTelemetryReport=_.getReport(),this.snapshotTelemetryReport=_.getSnapshotReport()}return e3.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e3.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e3.prototype.setFullTelemetryReport=function(g){var m,S,C;this.fullTelemetryReport=v(v({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(S=this.spinner.firstHideTimestamp)&&void 0!==S?S:-1,init_spinnerDuration:null!==(C=this.spinner.firstSpinnerDuration)&&void 0!==C?C:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.setSnapshotTelemetryReport=function(g){var m,S,C;this.snapshotTelemetryReport=v(v({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(S=this.spinner.firstHideTimestamp)&&void 0!==S?S:-1,init_spinnerDuration:null!==(C=this.spinner.firstSpinnerDuration)&&void 0!==C?C:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.addDisposeTelemetry=function(){var g=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=g,this.snapshotTelemetryReport.hydraDisposeTimestamp=g},e3.prototype.updateInitEventsWithDisposeEvent=function(g,m){var S=g.init_allEvents,v=JSON.parse(S);v[v.length-1].name!==A.PlayerScenarioType.Destroyed&&v.push({name:A.PlayerScenarioType.Destroyed,startTime:m,duration:0,details:M.HydraPlayerDestroyedReason.PlayerStopped}),g.init_allEvents=(0,P.stringifyObject)(v)},e3.prototype.updateStateChangeEventsWithDisposeEvent=function(g,m){var S=g.playback_stateChangeEvents,v=JSON.parse(S);v[v.length-1].payload!==I.HydraPlayerPlaybackState.Destroyed&&v.push({eventType:A.TelemetryEventType.StateChanged,timestamp:m,currentPlayPosition:-1,payload:I.HydraPlayerPlaybackState.Destroyed}),g.playback_stateChangeEvents=(0,P.stringifyObject)(v)},e3}()},124:function(g,m){var S;Object.defineProperty(m,"__esModule",{value:!0}),m.MessageType=void 0,(S=m.MessageType||(m.MessageType={})).Command="Command",S.CommandSuccessResult="CommandSuccessResult",S.CommandFailureResult="CommandFailureResult",S.PlayerEvent="PlayerEvent",S.InternalPlayerEvent="InternalPlayerEvent"},63:function(g,m){var S,v;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraSupportedSDN=m.HydraPlayerDestroyedReason=void 0,(v=m.HydraPlayerDestroyedReason||(m.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",v.PlaybackError="PlaybackError",(S=m.HydraSupportedSDN||(m.HydraSupportedSDN={})).Hive="hive",S.Kollective="kollective",S.Ramp="ramp",S.Peer5="peer5",S.Microsoft="microsoft"},844:function(g,m){var S,v;Object.defineProperty(m,"__esModule",{value:!0}),m.PlayerScenarioType=m.TelemetryEventType=void 0,(v=m.TelemetryEventType||(m.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",v.StreamOptionsConfigured="StreamOptionsConfigured",v.BitrateChangedPlayback="BitrateChangedPlayback",v.CaptionsToggled="CaptionsToggled",v.Error="Error",v.FullscreenChanged="FullscreenChanged",v.Mute="Mute",v.PotentialMediaFreeze="PotentialMediaFreeze",v.StateChanged="StateChanged",v.HydraInputStateChanged="HydraInputStateChanged",v.HydraOutputStateChanged="HydraOutputStateChanged",v.Volume="Volume",v.Buffering="Buffering",v.LowBufferReserve="LowBufferReserve",v.Online="Online",v.Offline="Offline",v.NetworkChange="NetworkChange",v.HlsEvents="HlsEvents",(S=m.PlayerScenarioType||(m.PlayerScenarioType={})).LoadHydra="LoadHydra",S.LoadHlsScript="LoadHlsScript",S.LoadPlayer="LoadPlayer",S.Load="Load",S.LoadHlsAuthCookie="LoadHlsAuthCookie",S.HlsManifestLoad="HlsManifestLoad",S.HlsKeyLoad="HlsKeyLoad",S.LoadHlsFirstFragment="LoadHlsFirstFragment",S.SetSource="SetSource",S.SdnPluginLoad="SdnPluginLoad",S.ThaPluginLoad="ThaPluginLoad",S.HydraPipelineInitialization="HydraPipelineInitialization",S.Destroyed="Destroyed",S.Setup="Setup",S.StreamConnection="StreamConnection"},328:function(g,m){var S,v;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=void 0,(v=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",v.Overflow="Overflow",v.TownHallBasic="TownHall_Basic",v.TownHallPremium="TownHall_Premium",v.TownHall="TownHall",(S=m.HydraPlayerType||(m.HydraPlayerType={}))[S.Hls=1]="Hls",S[S.Ums=2]="Ums"},68:function(g,m){var S,v,C,_;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(_=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",_.HLS="MiddleLaneHttpLiveStreaming",_.Ums="MiddleLaneUltraLowLatency",(C=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",C.PlayerInitializationFailed="PlayerInitializationFailed",C.InvalidStream="InvalidStream",C.SetSourceFailed="SetSourceFailed",(v=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",v.LoadedData="loadeddata",v.LoadedMetadata="loadedmetadata",v.Start="start",v.CanPlayThrough="canplaythrough",v.Play="play",v.Playing="playing",v.Pause="pause",v.Waiting="waiting",v.Seeking="seeking",v.Seeked="seeked",v.Ended="ended",v.Error="error",v.Destroyed="destroyed",v.Initialized="initialized",v.Stalled="stalled",v.VolumeChange="volumechange",v.PlaybackBitrateChanged="playbackbitratechanged",v.DownloadBitrateChanged="downloadbitratechanged",v.HlsKeyLoading="hlsKeyLoading",v.HlsKeyLoaded="hlsKeyLoaded",v.HlsKeyLoadedFailed="hlsKeyLoadedFailed",v.HlsManifestLoading="hlsManifestLoading",v.HlsManifestLoaded="hlsManifestLoaded",v.HlsManifestLoadedFailed="hlsManifestLoadedFailed",v.HlsFirstFragmentLoading="hlsFragLoading",v.HlsFirstFragmentBuffered="hlsFragBuffered",v.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",v.Online="online",v.Offline="offline",v.NetworkChange="networkChange",(S=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",S.NetworkError="NetworkError",S.PlaybackRetried="PlaybackRetried",S.PlaybackError="PlaybackError",S.Unknown="Unknown"},944:function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.defer=void 0,m.defer=function(){var g,m;return{promise:new Promise((function(S,v){g=S,m=v})),resolve:g,reject:m}}},329:function(g,m,S){var v=this&&this.__awaiter||function(g,m,S,v){return new(S||(S=Promise))((function(C,_){function o2(g){try{l2(v.next(g))}catch(g){_(g)}}function s2(g){try{l2(v.throw(g))}catch(g){_(g)}}function l2(g){var m;g.done?C(g.value):(m=g.value,m instanceof S?m:new S((function(g){g(m)}))).then(o2,s2)}l2((v=v.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function s2(T){return function(I){return function(T){if(S)throw new TypeError("Generator is already executing.");for(;_&&(_=0,T[0]&&(E=0)),E;)try{if(S=1,v&&(C=2&T[0]?v.return:T[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,T[1])).done)return C;switch(v=0,C&&(T=[2&T[0],C.value]),T[0]){case 0:case 1:C=T;break;case 4:return E.label++,{value:T[1],done:!1};case 5:E.label++,v=T[1],T=[0];continue;case 7:T=E.ops.pop(),E.trys.pop();continue;default:if(!((C=(C=E.trys).length>0&&C[C.length-1])||6!==T[0]&&2!==T[0])){E=0;continue}if(3===T[0]&&(!C||T[1]>C[0]&&T[1]<C[3])){E.label=T[1];break}if(6===T[0]&&E.label<C[1]){E.label=C[1],C=T;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(T);break}C[2]&&E.ops.pop(),E.trys.pop();continue}T=m.call(g,E)}catch(g){T=[6,g],v=0}finally{S=C=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}([T,I])}}};Object.defineProperty(m,"__esModule",{value:!0}),m.createVideoElement=m.createVideoElementDiv=m.showPlayerControls=m.getSdnStats=m.Spinner=m.repeatUntilCancel=m.wait=m.stringifyObject=m.getRandomHexString=m.getPlayerSetting=m.getECSSetting=m.assert=m.createIFrame=m.getMajorFromVersion=void 0;var _=S(63),E=S(328);function s(g,m,S,_,E){return v(this,void 0,void 0,(function(){var T,I,b,A,R=this;return C(this,(function(P){switch(P.label){case 0:return T=100,I=Date.now(),[4,c(S,b={trackingRef:"",timeTakenToDownloadScript:-1},E).catch((function(g){return v(R,void 0,void 0,(function(){var m;return C(this,(function(v){switch(v.label){case 0:return m="Failed to get IFrame source: ".concat(p(g)),_.push({success:!1,url:S,startTime:I,duration:Date.now()-I,trackingReference:b.trackingRef,timeTakenToDownloadScript:b.timeTakenToDownloadScript,errorMsg:m}),_.length>T&&_.shift(),[4,Promise.reject(new Error(m))];case 1:return[2,v.sent()]}}))}))}))];case 1:return A=P.sent(),m.srcdoc=A,g.appendChild(m),[4,new Promise((function(g,v){m.onload=function(){_.push({success:!0,url:S,startTime:I,duration:Date.now()-I,trackingReference:b.trackingRef,timeTakenToDownloadScript:b.timeTakenToDownloadScript}),_.length>T&&_.shift(),g()},m.onerror=function(g){var m="Failed to load HydraPlayer IFrame: ".concat(p(g));_.push({success:!1,url:S,startTime:I,duration:Date.now()-I,trackingReference:b.trackingRef,timeTakenToDownloadScript:b.timeTakenToDownloadScript,errorMsg:m}),_.length>T&&_.shift(),v(new Error(m))}}))];case 2:return P.sent(),[2]}}))}))}function l(g,m){return v(this,void 0,void 0,(function(){var S=this;return C(this,(function(_){switch(_.label){case 0:return[4,g(m).catch((function(_){return v(S,void 0,void 0,(function(){var S=this;return C(this,(function(E){switch(E.label){case 0:return 0!=--m?[3,2]:[4,Promise.reject(_)];case 1:case 3:return[2,E.sent()];case 2:return[4,new Promise((function(E){return setTimeout((function(){E(l(g,m).catch((function(g){return v(S,void 0,void 0,(function(){return C(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(new Error("".concat(p(_)).concat(", ",p(g))))];case 1:return[2,m.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return _.sent(),[2]}}))}))}function c(g,m,S){return v(this,void 0,void 0,(function(){var _,E,T,I=this;return C(this,(function(b){switch(b.label){case 0:return _=Date.now(),[4,d(g,m,S).catch((function(g){return v(I,void 0,void 0,(function(){return C(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(g)];case 1:return[2,m.sent()]}}))}))}))];case 1:return E=b.sent(),T="<script> ".concat(E,"<\/script>"),m.timeTakenToDownloadScript=Date.now()-_,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(T,"\n        </body>\n        </html>\n    ")]}}))}))}function d(g,m,S){return v(this,void 0,void 0,(function(){var _,E,T,I=this;return C(this,(function(b){switch(b.label){case 0:return _=function(g,m){var S,v;return m.includes("vz")?null!==(v=g.headers.get("uuid"))&&void 0!==v?v:"":null!==(S=g.headers.get("X-Azure-Ref"))&&void 0!==S?S:""},S?(E=new AbortController,T=setTimeout((function(){E.abort()}),S),[4,fetch(g,{signal:E.signal,cache:"no-cache"}).then((function(S){return v(I,void 0,void 0,(function(){return C(this,(function(v){switch(v.label){case 0:return clearTimeout(T),S.ok?[3,2]:[4,Promise.reject(new Error("".concat(S.status)))];case 1:return[2,v.sent()];case 2:return m.trackingRef=_(S,g),[2,S]}}))}))})).then((function(m){return v(I,void 0,void 0,(function(){var S=this;return C(this,(function(_){switch(_.label){case 0:return[4,m.text().then((function(_){return v(S,void 0,void 0,(function(){return C(this,(function(S){switch(S.label){case 0:return _?[2,_]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,S.sent()]}}))}))}))];case 1:return[2,_.sent()]}}))}))}))]):[3,2];case 1:case 3:return[2,b.sent()];case 2:return[4,fetch(g,{cache:"no-cache"}).then((function(S){return v(I,void 0,void 0,(function(){return C(this,(function(v){switch(v.label){case 0:return S.ok?[3,2]:[4,Promise.reject(new Error("".concat(S.status)))];case 1:return[2,v.sent()];case 2:return m.trackingRef=_(S,g),[2,S]}}))}))})).then((function(m){return v(I,void 0,void 0,(function(){var S=this;return C(this,(function(_){switch(_.label){case 0:return[4,m.text().then((function(_){return v(S,void 0,void 0,(function(){return C(this,(function(S){switch(S.label){case 0:return _?[2,_]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,S.sent()]}}))}))}))];case 1:return[2,_.sent()]}}))}))}))]}}))}))}function p(g){try{if(!g)return"".concat(g);if(g instanceof Map)return S={},g.forEach((function(g,m){S[m.toString()]=g})),JSON.stringify(S);var m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}catch(g){return""}var S}function y(g){return v(this,void 0,void 0,(function(){return C(this,(function(m){switch(m.label){case 0:return[4,new Promise((function(m){return setTimeout(m,g)}))];case 1:return m.sent(),[2]}}))}))}m.getMajorFromVersion=function(g){var m=g.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return m?m[1]:null},m.createIFrame=function(g,m,S,_,E){return void 0===_&&(_=!1),v(this,void 0,void 0,(function(){var T,I,b,A,R=this;return C(this,(function(P){switch(P.label){case 0:return T=[],I=Date.now(),(b=g.ownerDocument.createElement("iframe")).id="player-iframe",_||b.sandbox.add("allow-scripts"),b.allowFullscreen=!0,b.allow="camera; microphone; autoplay",b.style.height="100%",b.style.width="100%",b.style.border="none",A=function(g){return m[g%m.length]},[4,l((function(m){return v(R,void 0,void 0,(function(){var S;return C(this,(function(v){switch(v.label){case 0:return S=A(m),[4,s(g,b,S,T,E)];case 1:return v.sent(),[2]}}))}))}),S).then((function(){return{iframe:b,initResult:{initSucceeded:!0,initStartTime:I,initDuration:Date.now()-I,runtimeDownloadResults:T}}})).catch((function(g){return v(R,void 0,void 0,(function(){var S;return C(this,(function(v){return S="Failed to load Hydra player runtime scripts, src: ",m.forEach((function(g){return S=S.concat(g,", ")})),S+="errors: ".concat(p(g)),[2,{initResult:{initSucceeded:!1,initStartTime:I,initDuration:Date.now()-I,runtimeDownloadResults:T,errorMsg:S}}]}))}))}))];case 1:return[2,P.sent()]}}))}))},m.assert=function(g,m,S){if(void 0===S&&(S=!1),!g){if(!S)throw new Error("Assert failed".concat(void 0!==m?": ".concat(m):""));console.error("Assert failed".concat(void 0!==m?": ".concat(m):""))}},m.getECSSetting=function(g,m,S){var v,C=S,_=null===(v=g.ecsSettings)||void 0===v?void 0:v[m];return typeof _==typeof C&&(C=_),C},m.getPlayerSetting=function(g,m){var S;return void 0!==(null===(S=g.ecsSettings)||void 0===S?void 0:S[m])?g.ecsSettings[m]:g[m]},m.getRandomHexString=function(g){return Array.from(Array(g)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},m.stringifyObject=p,m.wait=y,m.repeatUntilCancel=function(g,m,S,_){var E=!1,T=_||console.log;return T("RepeatUntilCancel starting task: ".concat(g)),v(this,void 0,void 0,(function(){var v,_,I;return C(this,(function(C){switch(C.label){case 0:return E?[3,2]:(v=new Date,m(),_=(new Date).getTime()-v.getTime(),(I=S-_)<0&&(I=S+I%S,T("Skipping execution for ".concat(g,", last execution took: ").concat(_," ms, delayMs: ").concat(S),"warn")),[4,y(I)]);case 1:return C.sent(),[3,0];case 2:return[2]}}))})),function(){T("RepeatUntilCancel stopping task: ".concat(g)),E=!0}};var T=function(){function e3(g){this.container=g,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var m=this.container.ownerDocument.getElementById(this.spinnerId);if(m)return this.spinner=m,void this.show();var S=this.container.ownerDocument.createElement("style");S.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(S),this.container.style.position="relative";var v=this.container.ownerDocument.createElement("div");v.classList.add("ml-player-spinner-container"),this.container.appendChild(v),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,v.appendChild(this.spinner);var C=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");C.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(C);var _=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");_.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(_),this.show()}return Object.defineProperty(e3.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var g=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];g.hideTimestamp||(g.displayDuration=Date.now()-g.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e3.prototype.show=function(){var g=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=g),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:g,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e3.prototype.hide=function(){var g=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=g),this.spinnerInfoHistory.length>0){var m=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];m.hideTimestamp||(m.hideTimestamp=g,m.displayDuration=g-m.showTimestamp)}this.spinner.style.display="none"},e3.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e3}();m.Spinner=T,m.getSdnStats=function(g,m){(null==g?void 0:g.peer5)&&(m.sdnName=g.peer5?_.HydraSupportedSDN.Microsoft:"",m.sdnVersion=g.peer5?g.peer5.version:"","function"==typeof g.peer5.getStats&&(m.sdnStats=g.peer5.getStats(),m.isP2PSdnUsed=g.peer5.getStats().numOfPeers>0))},m.showPlayerControls=function(g){return void 0!==g.allowPlayerControls?g.allowPlayerControls:g.streamingEventType===E.HydraStreamingEventType.TLE},m.createVideoElementDiv=function(g,m,S){S("createVideoElementDiv started");var v=m.ownerDocument.createElement("div");return v.id=g,v.style.position="relative",v.style.width="100%",v.style.height="100%",m.appendChild(v),S("createVideoElementDiv done"),v},m.createVideoElement=function(g,m,S,v,C){C("createVideoElement started");var _=m.ownerDocument.createElement("video");_.controls=v,_.id=g,_.setAttribute("playsinline","");var E=S.videoLang;E&&(_.setAttribute("lang",E),C("createVideoElement: language set to ".concat(E)));for(var T=S.videoElementStyles,I=0;I<T.length;I++)_.classList.add(T[I]);return _.style.width="100%",_.style.height="100%",_.style.position="absolute",_.muted=S.muteVideo,_.addEventListener("contextmenu",(function(g){g.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(g){try{navigator.mediaSession.setActionHandler(g,(function(){}))}catch(g){}})),m.appendChild(_),C("createVideoElement done"),_}}},m={},function r(S){var v=m[S];if(void 0!==v)return v.exports;var C=m[S]={exports:{}};return g[S].call(C.exports,C,C.exports,r),C.exports}(855);var g,m},"object"==typeof g&&"object"==typeof m?m.exports=v():"object"==typeof g?g.hydra_player_hls_sdk=v():S.hydra_player_hls_sdk=v()}}),ne=__commonJS({"../node_modules/@skype/hydra_player_ums_sdk/hydra_player_ums_sdk_bundle.js"(g,m){var S,v;S=g,v=function(){return g={458:function(g,m,S){var v=this&&this.__assign||function(){return v=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},v.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.LiveStreamStatistic=void 0;var C=S(844),_=S(68),E=S(63),T=S(329),I=function(){function e3(g,m,S){this.name=g,this.stopCrash=m,this.start(S)}return e3.prototype.complete=function(){try{T.assert(this.startTime,"not started",this.stopCrash),T.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(g){if(this.name!==C.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==C.PlayerScenarioType.HlsKeyLoad)throw g}this.duration=Date.now()-this.startTime},e3.prototype.fail=function(g){this.failReason=g,this.complete()},e3.prototype.setDetail=function(g){this.details=g},e3.prototype.getTelemetryEvent=function(){T.assert(this.startTime,"not started",this.stopCrash);var g={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(g.failReason=this.failReason),this.details&&(g.details=this.details),g},e3.prototype.getName=function(){return this.name},e3.prototype.getDuration=function(){var g;return null!==(g=this.duration)&&void 0!==g?g:0},e3.prototype.getFailReason=function(){return this.failReason},e3.prototype.getDetails=function(){return this.details},e3.prototype.start=function(g){T.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),g&&(this.details=g)},e3.prototype.updateDetails=function(g,m){if(this.details&&"object"==typeof this.details)for(var S=0;S<g.length;S++)this.details[g[S]]=m[S]},e3}(),b=function(){function e3(g,m,S,v,C){this.config=g,this.logFn=m,this.playerDiagnosticsLog=S,this.playerMetadata=v,this.hydraInitResult=C,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.isCallRecovered=!1,this.isCallInErrorState=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=g.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=g.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=g.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=g.maxPlayerExperimentalEvents||100,T.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e3.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e3.prototype.registerStatsUpdated=function(g){var m=this;this.currentPlayerDiagnosticSnapshot=g,Object.keys(this.playerDiagnosticsLog).forEach((function(S){var v,C=S,_=null!==(v=m.playerDiagnosticsLog[S])&&void 0!==v?v:[];if(Array.isArray(_)){_.push(g[C]);var E="memoryLog"===C&&_.length>m.maxPlayerMemoryTraceLogCount,T="memoryLog"!==C&&_.length>m.maxPlayerDiagnosticsCount;(E||T)&&_.splice(0,1)}else m.playerDiagnosticsLog[S]=g[C]}))},e3.prototype.registerEventLoadAttempt=function(g,m){this.registerScenario(g,m)},e3.prototype.registerEventLoadFailed=function(g,m){this.completeScenario(g,m)},e3.prototype.registerEventLoadSucceeded=function(g,m){this.completeScenario(g,void 0,m),g===C.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e3.prototype.registerSdnPluginLoadAttempt=function(g){this.registerScenario(C.PlayerScenarioType.SdnPluginLoad,JSON.stringify(g))},e3.prototype.registerSdnPluginLoadFailed=function(g){this.completeScenario(C.PlayerScenarioType.SdnPluginLoad,g)},e3.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(C.PlayerScenarioType.SdnPluginLoad)},e3.prototype.registerStreamConnectionAttempt=function(g){this.registerScenario(C.PlayerScenarioType.StreamConnection,{streamUrl:g})},e3.prototype.registerStreamConnectionSucceeded=function(g){var m=this.getScenario(C.PlayerScenarioType.StreamConnection);null==m||m.updateDetails(["results"],[T.stringifyObject(g)]),this.completeScenario(C.PlayerScenarioType.StreamConnection)},e3.prototype.registerStreamConnectionFailed=function(g,m){var S=this.getScenario(C.PlayerScenarioType.StreamConnection);null==S||S.updateDetails(["results"],[T.stringifyObject(m)]),this.completeScenario(C.PlayerScenarioType.StreamConnection,g)},e3.prototype.registerSetSourceAttempt=function(g,m,S){var v=g||"";S&&(v={src:g||"",isPrimary:T.stringifyObject(m),reason:S}),this.registerScenario(C.PlayerScenarioType.SetSource,v)},e3.prototype.registerSetSourceSucceeded=function(g,m,S,v){var _=this.getScenario(C.PlayerScenarioType.SetSource);T.assert(_,"no SetSource scenario to update details",this.stopCrash),null==_||_.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[g,T.stringifyObject(m),T.stringifyObject(S),T.stringifyObject(v)]),this.completeScenario(C.PlayerScenarioType.SetSource)},e3.prototype.registerSetSourceFailed=function(g,m,S,v,_){var E=null!=m?m:"Failed to find stream url",I=this.getScenario(C.PlayerScenarioType.SetSource);T.assert(I,"no SetSource scenario to update details",this.stopCrash),null==I||I.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[E,T.stringifyObject(S),T.stringifyObject(v),T.stringifyObject(_)]),this.completeScenario(C.PlayerScenarioType.SetSource,g)},e3.prototype.registerPlayerDestroyed=function(g){this.callDropped=g===E.HydraPlayerDestroyedReason.PlaybackError,this.registerScenario(C.PlayerScenarioType.Destroyed,g),this.completeScenario(C.PlayerScenarioType.Destroyed)},e3.prototype.updateCallRecovered=function(g){this.isCallInErrorState&&g===_.HydraPlayerPlaybackState.Playing&&(this.isCallRecovered=!0,this.isCallInErrorState=!1)},e3.prototype.registerPlaybackStateChanged=function(g){g!==_.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?g!==_.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(C.TelemetryEventType.StateChanged,g),this.updateCallRecovered(g)},e3.prototype.registerHydraInputStateChanged=function(g,m){this.registerPlaybackEvent(C.TelemetryEventType.HydraInputStateChanged,g,m)},e3.prototype.registerHydraOutputStateChanged=function(g,m){this.registerPlaybackEvent(C.TelemetryEventType.HydraOutputStateChanged,g,m)},e3.prototype.registerPlaybackBuffering=function(g){this.registerPlaybackEvent(C.TelemetryEventType.Buffering,g)},e3.prototype.registerPlaybackError=function(g,m,S){this.registerPlaybackEvent(C.TelemetryEventType.Error,{errorType:g,details:m,errorSource:S})},e3.prototype.registerDownloadBitrateChanged=function(g){this.registerPlaybackEvent(C.TelemetryEventType.BitrateChangedDownload,g)},e3.prototype.registerStreamOptionsConfigured=function(g,m){this.registerPlaybackEvent(C.TelemetryEventType.StreamOptionsConfigured,g,m)},e3.prototype.registerPlaybackBitrateChanged=function(g){this.registerPlaybackEvent(C.TelemetryEventType.BitrateChangedPlayback,g)},e3.prototype.registerVolumeChange=function(g){this.registerPlaybackEvent(C.TelemetryEventType.Volume,g)},e3.prototype.getSnapshotReport=function(){var g,m,S=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),C=this.playbackEvents,_={};return this.currentPlayerDiagnosticSnapshot&&(_=this.filterAndPrepareTelemetry()),v(v(v(v(v(v(v(v(v(v(v(v(v({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(S,C)),this.getHydraInternalReport(C)),this.getPlaybackReport(C)),this.getBitrateReport(C)),this.getStreamConnectionReport(S)),this.getSdnReport(S)),this.getSetSourceReport(S)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),_)},e3.prototype.getReport=function(){var g,m,S=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),C=this.playbackEvents;return v(v(v(v(v(v(v(v(v(v(v(v(v({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(S,C)),this.getHydraInternalReport(C)),this.getPlaybackReport(C)),this.getBitrateReport(C)),this.getStreamConnectionReport(S)),this.getSdnReport(S)),this.getSetSourceReport(S)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),this.getPlayerDiagnosticLog())},e3.prototype.getHydraLoadEvent=function(){var g,m,S,v={name:C.PlayerScenarioType.LoadHydra,startTime:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initStartTime)||-1,duration:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initDuration)||0};(null===(S=this.hydraInitResult)||void 0===S?void 0:S.errorMsg)&&(v.failReason=this.hydraInitResult.errorMsg);var _=this.getHydraRuntimeDownloadDetails();return _&&(v.details=_),v},e3.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var g=[],m=0,S=this.hydraInitResult.runtimeDownloadResults;m<S.length;m++){var v=S[m],C={success:v.success,url:v.url,startTime:v.startTime,duration:v.duration,trackingReference:v.trackingReference,timeTakenToDownloadScript:v.timeTakenToDownloadScript};v.errorMsg&&(C.errorMsg=v.errorMsg),g.push(C)}return T.stringifyObject(g)}return null},e3.prototype.getTotalLoadEvent=function(){var g,m,S,v=this.playerEvents.find((function(g){return g.getName()===C.PlayerScenarioType.LoadPlayer})),_=(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initDuration)||0,E=(null==v?void 0:v.getDuration())||0,T=null==v?void 0:v.getFailReason(),I={name:C.PlayerScenarioType.Load,startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,duration:_+E};return(null===(S=this.hydraInitResult)||void 0===S?void 0:S.errorMsg)?I.failReason=this.hydraInitResult.errorMsg:T&&(I.failReason=T),I},e3.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e3.prototype.registerPlaybackEvent=function(g,m,S){var v=this.createTelemetryEvent(g,m,S);g===C.TelemetryEventType.Error&&(null==m?void 0:m.errorType)!==_.HydraPlayerPlaybackErrorType.PlaybackRetried&&(v.fatal=!0,this.isCallInErrorState=!0),this.playbackEvents.push(v),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(v)},e3.prototype.getPlayerDiagnosticLog=function(){var g=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var m=this.currentPlayerDiagnosticSnapshot,S=this.playerDiagnosticsLog,C=v(v({},m),S),_={};return Object.keys(C).forEach((function(m){_["player_".concat(m)]=g.prepareForTelemetry(C[m])})),_},e3.prototype.getHydraInitializationReport=function(){var g,m,S,v;return{hydraInit_succeeded:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initSucceeded)||!1,hydraInit_startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,hydraInit_errorMessage:(null===(S=this.hydraInitResult)||void 0===S?void 0:S.errorMsg)||"",hydraInit_duration:(null===(v=this.hydraInitResult)||void 0===v?void 0:v.initDuration)||0}},e3.prototype.getPlayerInitializationReport=function(g,m){var S=g.find((function(g){return g.name===C.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=S&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-S.startTime:-1)||-1,init_timeLoadToReady:(null!=S&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-S.startTime:-1)||-1,init_timeLoadToPlaying:(null!=S&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-S.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(g)}},e3.prototype.getHydraInternalReport=function(g){var m=g.filter((function(g){return g.eventType===C.TelemetryEventType.HydraInputStateChanged})),S=g.filter((function(g){return g.eventType===C.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(m),hydra_outputStateChangeEvents:this.prepareForTelemetry(S)}},e3.prototype.getPlaybackReport=function(g){var m=g.filter((function(g){return g.eventType===C.TelemetryEventType.StateChanged})),S=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.CanPlayThrough})),v=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.Play})),E=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.Start})),T=m.find((function(g){return g.payload===_.HydraPlayerPlaybackState.Playing})),I=null!=S&&null!=v?v.timestamp-S.timestamp:-1,b=null!=v&&null!=E?E.timestamp-v.timestamp:-1,A=null!=E&&null!=T?T.timestamp-E.timestamp:-1,R=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Seeked})),P=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Seeking})),M=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Pause})),w=m.filter((function(g){return g.payload===_.HydraPlayerPlaybackState.Waiting})),D=[C.TelemetryEventType.BitrateChangedDownload,C.TelemetryEventType.BitrateChangedPlayback,C.TelemetryEventType.Error,C.TelemetryEventType.Mute,C.TelemetryEventType.StateChanged,C.TelemetryEventType.Volume,C.TelemetryEventType.StreamOptionsConfigured],O=g.filter((function(g){return g.eventType===C.TelemetryEventType.Error})),N=g.filter((function(g){return g.eventType===C.TelemetryEventType.Volume||g.eventType===C.TelemetryEventType.Mute})),k=g.filter((function(g){return g.eventType===C.TelemetryEventType.StreamOptionsConfigured})),L=g.filter((function(g){return!D.includes(g.eventType)}));return{playback_timeReadyToPlay:I,playback_timePlayToStart:b,playback_timeStartToPlaying:A,playback_bufferingEvents:this.prepareForTelemetry(w),playback_errorEvents:this.prepareForTelemetry(O),playback_pauseEvents:this.prepareForTelemetry(M),playback_otherEvents:this.prepareForTelemetry(L),playback_seekedEvents:this.prepareForTelemetry(R),playback_seekingEvents:this.prepareForTelemetry(P),playback_stateChangeEvents:this.prepareForTelemetry(m),playback_volumeEvents:this.prepareForTelemetry(N),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(k)}},e3.prototype.getBitrateReport=function(g){var m,S,_,E,T=g.filter((function(g){return g.eventType===C.TelemetryEventType.BitrateChangedDownload})),I=T.sort((function(g){return Number(g.payload)})),b=T.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(T),bitrate_downloadChangeCount:T.length>0||-1,bitrate_downloadMin:(null===(m=I[0])||void 0===m?void 0:m.payload)||-1,bitrate_downloadMax:(null===(S=I[I.length-1])||void 0===S?void 0:S.payload)||-1}:{},A=g.filter((function(g){return g.eventType===C.TelemetryEventType.BitrateChangedPlayback})),R=A.sort((function(g){return Number(g.payload)})),P=A.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(A),bitrate_playbackChangeCount:A.length>0||-1,bitrate_playbackMin:(null===(_=R[0])||void 0===_?void 0:_.payload)||-1,bitrate_playbackMax:(null===(E=R[R.length-1])||void 0===E?void 0:E.payload)||-1}:{};return v(v({},b),P)},e3.prototype.addNetworkTypeEventListener=function(){var g,m,S,v,C=this;(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)&&(null===(v=null===(S=window.navigator)||void 0===S?void 0:S.connection)||void 0===v||v.addEventListener("change",(function(){C.updateClientNetworkType()})))},e3.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e3.prototype.getClientNetworkType=function(){var g,m,S,v;if(void 0===this.clientNetworkType){var C="Unknown";if(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)switch(null===(v=null===(S=window.navigator)||void 0===S?void 0:S.connection)||void 0===v?void 0:v.type){case"cellular":C="WWAN";break;case"ethernet":C="Wired";break;case"wifi":C="Wireless";break;default:C="Unknown"}this.clientNetworkType=C}return this.clientNetworkType},e3.prototype.getSdnReport=function(g){var m,S,v=g.filter((function(g){return g.name===C.PlayerScenarioType.SdnPluginLoad})),_=v.length>0?v[v.length-1]:void 0;return{sdn_loaded:!(null==_||void 0!==_.failReason),sdn_details:null!==(m=null==_?void 0:_.details)&&void 0!==m?m:"",sdn_error:null!==(S=null==_?void 0:_.failReason)&&void 0!==S?S:"",sdn_events:this.prepareForTelemetry(v)}},e3.prototype.getStreamConnectionReport=function(g){var m=g.filter((function(g){return g.name===C.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(m)}},e3.prototype.getSetSourceReport=function(g){var m=g.filter((function(g){return g.name===C.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(m)}},e3.prototype.registerScenario=function(g,m){var S=this.currentScenarioMap.get(g),v=new I(g,this.stopCrash,m);try{T.assert(null==S,"previous scenario:".concat(T.stringifyObject(S)," is not completed, new scenario:").concat(T.stringifyObject(v)),this.stopCrash)}catch(m){if(g!==C.PlayerScenarioType.LoadHlsFirstFragment&&g!==C.PlayerScenarioType.HlsKeyLoad)throw m}this.currentScenarioMap.set(g,v),this.playerEvents.push(v)},e3.prototype.completeScenario=function(g,m,S){var v=this.currentScenarioMap.get(g);try{T.assert(v,"no scenario to complete",this.stopCrash)}catch(m){if(g!==C.PlayerScenarioType.LoadHlsFirstFragment&&g!==C.PlayerScenarioType.HlsKeyLoad)throw m}m?null==v||v.fail(m):(g!==C.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),S&&(null==v||v.setDetail(S)),null==v||v.complete()),this.currentScenarioMap.delete(g)},e3.prototype.logTelemetryEvent=function(g){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(g))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e3.prototype.filterAndPrepareTelemetry=function(){var g=this,m=new Set;m.add("serviceLatencyCdg"),m.add("endToEndLatencyCdg"),m.add("videoEdgeLatencyCdg");var S={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(v){m.has(v)||(S["player_".concat(v)]=g.prepareForTelemetry(g.currentPlayerDiagnosticSnapshot[v]))})),S},e3.prototype.prepareForTelemetry=function(g){return"boolean"==typeof g?g:"string"==typeof g||void 0===g?g||"":"number"==typeof g?null!=g?g:-1:JSON.stringify(g)},e3.prototype.getScenario=function(g){return this.currentScenarioMap.get(g)},e3.prototype.createTelemetryEvent=function(g,m,S){var v,C,_={eventType:g,timestamp:Date.now(),currentPlayPosition:null!==(C=null===(v=this.currentPlayerDiagnosticSnapshot)||void 0===v?void 0:v.currentPlayPosition)&&void 0!==C?C:-1};return void 0!==m&&(_.payload=this.prepareForTelemetry(m)),_.message=S,_},e3.prototype.registerExperimentalEvent=function(g,m,S){var v=this.createTelemetryEvent(g,m,S);this.experimentalEvents.push(v),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(v)},e3.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e3}();m.LiveStreamStatistic=b},751:function(g,m){var S,v,C,_,E,T;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(T=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",T.HLS="MiddleLaneHttpLiveStreaming",T.Ums="MiddleLaneUltraLowLatency",(E=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",E.PlayerInitializationFailed="PlayerInitializationFailed",E.InvalidStream="InvalidStream",E.SetSourceFailed="SetSourceFailed",(_=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",_.LoadedData="loadeddata",_.LoadedMetadata="loadedmetadata",_.Start="start",_.CanPlayThrough="canplaythrough",_.Play="play",_.Playing="playing",_.Pause="pause",_.Waiting="waiting",_.Seeking="seeking",_.Seeked="seeked",_.Ended="ended",_.Error="error",_.Destroyed="destroyed",_.Initialized="initialized",_.Stalled="stalled",_.VolumeChange="volumechange",_.PlaybackBitrateChanged="playbackbitratechanged",_.DownloadBitrateChanged="downloadbitratechanged",_.HlsKeyLoading="hlsKeyLoading",_.HlsKeyLoaded="hlsKeyLoaded",_.HlsKeyLoadedFailed="hlsKeyLoadedFailed",_.HlsManifestLoading="hlsManifestLoading",_.HlsManifestLoaded="hlsManifestLoaded",_.HlsManifestLoadedFailed="hlsManifestLoadedFailed",_.HlsFirstFragmentLoading="hlsFragLoading",_.HlsFirstFragmentBuffered="hlsFragBuffered",_.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",_.Online="online",_.Offline="offline",_.NetworkChange="networkChange",(C=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",C.NetworkError="NetworkError",C.PlaybackRetried="PlaybackRetried",C.PlaybackError="PlaybackError",C.Unknown="Unknown",(v=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",v.Overflow="Overflow",v.TownHallBasic="TownHall_Basic",v.TownHallPremium="TownHall_Premium",v.TownHall="TownHall",(S=m.HydraPlayerType||(m.HydraPlayerType={}))[S.Hls=1]="Hls",S[S.Ums=2]="Ums"},979:function(g,m,S){var v=this&&this.__createBinding||(Object.create?function(g,m,S,v){void 0===v&&(v=S);var C=Object.getOwnPropertyDescriptor(m,S);C&&!("get"in C?!m.__esModule:C.writable||C.configurable)||(C={enumerable:!0,get:function(){return m[S]}}),Object.defineProperty(g,v,C)}:function(g,m,S,v){void 0===v&&(v=S),g[v]=m[S]}),C=this&&this.__exportStar||function(g,m){for(var S in g)"default"===S||Object.prototype.hasOwnProperty.call(m,S)||v(m,g,S)};Object.defineProperty(m,"__esModule",{value:!0}),C(S(165),m),C(S(751),m)},165:function(g,m,S){var v=this&&this.__assign||function(){return v=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},v.apply(this,arguments)},C=this&&this.__awaiter||function(g,m,S,v){return new(S||(S=Promise))((function(C,_){function o2(g){try{l2(v.next(g))}catch(g){_(g)}}function s2(g){try{l2(v.throw(g))}catch(g){_(g)}}function l2(g){var m;g.done?C(g.value):(m=g.value,m instanceof S?m:new S((function(g){g(m)}))).then(o2,s2)}l2((v=v.apply(g,m||[])).next())}))},_=this&&this.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function s2(T){return function(I){return function(T){if(S)throw new TypeError("Generator is already executing.");for(;_&&(_=0,T[0]&&(E=0)),E;)try{if(S=1,v&&(C=2&T[0]?v.return:T[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,T[1])).done)return C;switch(v=0,C&&(T=[2&T[0],C.value]),T[0]){case 0:case 1:C=T;break;case 4:return E.label++,{value:T[1],done:!1};case 5:E.label++,v=T[1],T=[0];continue;case 7:T=E.ops.pop(),E.trys.pop();continue;default:if(!((C=(C=E.trys).length>0&&C[C.length-1])||6!==T[0]&&2!==T[0])){E=0;continue}if(3===T[0]&&(!C||T[1]>C[0]&&T[1]<C[3])){E.label=T[1];break}if(6===T[0]&&E.label<C[1]){E.label=C[1],C=T;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(T);break}C[2]&&E.ops.pop(),E.trys.pop();continue}T=m.call(g,E)}catch(g){T=[6,g],v=0}finally{S=C=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}([T,I])}}},E=this&&this.__spreadArray||function(g,m,S){if(S||2===arguments.length)for(var v,C=0,_=m.length;C<_;C++)!v&&C in m||(v||(v=Array.prototype.slice.call(m,0,C)),v[C]=m[C]);return g.concat(v||Array.prototype.slice.call(m))};Object.defineProperty(m,"__esModule",{value:!0}),m.UmsHydraPlayer=m.getSdkVersion=void 0;var T=S(124),I=S(68),b=S(328),A=S(844),R=S(63),P=S(458),M=S(329),w=S(944);m.getSdkVersion=function(){return"4.2430.2"};var D=function(){function e3(g,m){this.playerSettings=g,this.eventHandler=m,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2430.2"}return Object.defineProperty(e3.prototype,"contextWindow",{get:function(){var g;return null===(g=this.container)||void 0===g?void 0:g.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e3.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var g=(0,M.getMajorFromVersion)("4.2430.2");return g&&this.playerSettings.playerRuntimeJsUrls[g]||[]}return this.playerSettings.playerRuntimeJsUrls},e3.prototype.initializeIFrame=function(g){return C(this,void 0,void 0,(function(){var m;return _(this,(function(S){switch(S.label){case 0:return this.container=g,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2430.2",', URLs: "').concat((0,M.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,M.createIFrame)(g,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(m=S.sent()).initResult.initSucceeded&&m.iframe&&(this.iframe=m.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,m.initResult]}}))}))},e3.prototype.setup=function(g){return C(this,void 0,void 0,(function(){var m;return _(this,(function(S){switch(S.label){case 0:return this.spinner=new M.Spinner(g),[4,this.initializeIFrame(g)];case 1:return m=S.sent(),this.telemetryReportHandler=new N(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),m,this.spinner),this.playerInternalEventHandler=new O(this.spinner,this.telemetryReportHandler),m.initSucceeded?[4,this.sendCommand("createUmsHydraPlayer",this.playerSettings,m)]:[3,3];case 2:return S.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(m.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e3.prototype.isIFrameCommunicationActive=function(){var g;return!!(null===(g=this.iframe)||void 0===g?void 0:g.contentWindow)&&!!this.contextWindow},e3.prototype.getFullTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getFullTelemetryReport())||{}},e3.prototype.getSnapshotTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getSnapshotTelemetryReport())||{}},e3.prototype.callPlayerApi=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];return C(this,void 0,void 0,(function(){return _(this,(function(S){switch(S.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,E([g],m,!1))]:[3,2];case 1:case 3:return[2,S.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e3.prototype.dispose=function(){var g;null===(g=this.telemetryReportHandler)||void 0===g||g.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e3.prototype.release=function(){var g;null===(g=this.spinner)||void 0===g||g.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e3.prototype.sendCommand=function(g){for(var m,S,v=[],E=1;E<arguments.length;E++)v[E-1]=arguments[E];return C(this,void 0,void 0,(function(){var C,E,I;return _(this,(function(_){switch(_.label){case 0:if(C={msgType:T.MessageType.Command,name:g,args:v},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(E=this.commandResultsMap.get(g.toString()))&&E.reject(new Error("function ".concat(g," is invoked again, before previous call is completed"))),I=w.defer(),this.commandResultsMap.set(g,I),null===(S=null===(m=this.iframe)||void 0===m?void 0:m.contentWindow)||void 0===S||S.postMessage(C,"*"),[4,I.promise];case 1:return[2,_.sent()]}}))}))},e3.prototype.onMessage=function(g){switch(g.data.msgType){case T.MessageType.PlayerEvent:this.processPlayerEvent(g.data);break;case T.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(g.data);break;case T.MessageType.CommandSuccessResult:this.processCommandSuccessResult(g.data);break;case T.MessageType.CommandFailureResult:this.processCommandFailureResult(g.data)}},e3.prototype.processCommandSuccessResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.resolve(g.result),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processCommandFailureResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.reject(g.error),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processPlayerEvent=function(g){this.eventHandler[g.name].apply(this.eventHandler,g.args)},e3.prototype.processInternalPlayerEvent=function(g){this.playerInternalEventHandler&&this.playerInternalEventHandler[g.name].apply(this,g.args)},e3}();m.UmsHydraPlayer=D;var O=function(){function e3(g,m){this.spinner=g,this.telemetryReportHandler=m}return e3.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e3.prototype.fullTelemetryReportUpdated=function(g){this.telemetryReportHandler.setFullTelemetryReport(g)},e3.prototype.snapshotTelemetryReportUpdated=function(g){this.telemetryReportHandler.setSnapshotTelemetryReport(g)},e3}(),N=function(){function e3(g,m,S,v){var C=this;this.logFn=m,this.spinner=v;var _=new P.LiveStreamStatistic(g,(function(g,m){C.logFn(g,m)}),{currentPlayPosition:[],playbackRate:[],statsInterval:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[]},{hydraPlayerSdkVersion:g.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:b.HydraPlayerType.Ums},S);this.fullTelemetryReport=_.getReport(),this.snapshotTelemetryReport=_.getSnapshotReport()}return e3.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e3.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e3.prototype.setFullTelemetryReport=function(g){var m,S,C;this.fullTelemetryReport=v(v({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(S=this.spinner.firstHideTimestamp)&&void 0!==S?S:-1,init_spinnerDuration:null!==(C=this.spinner.firstSpinnerDuration)&&void 0!==C?C:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.setSnapshotTelemetryReport=function(g){var m,S,C;this.snapshotTelemetryReport=v(v({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(S=this.spinner.firstHideTimestamp)&&void 0!==S?S:-1,init_spinnerDuration:null!==(C=this.spinner.firstSpinnerDuration)&&void 0!==C?C:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.addDisposeTelemetry=function(){var g=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=g,this.snapshotTelemetryReport.hydraDisposeTimestamp=g},e3.prototype.updateInitEventsWithDisposeEvent=function(g,m){var S=g.init_allEvents,v=JSON.parse(S);v[v.length-1].name!==A.PlayerScenarioType.Destroyed&&v.push({name:A.PlayerScenarioType.Destroyed,startTime:m,duration:0,details:R.HydraPlayerDestroyedReason.PlayerStopped}),g.init_allEvents=(0,M.stringifyObject)(v)},e3.prototype.updateStateChangeEventsWithDisposeEvent=function(g,m){var S=g.playback_stateChangeEvents,v=JSON.parse(S);v[v.length-1].payload!==I.HydraPlayerPlaybackState.Destroyed&&v.push({eventType:A.TelemetryEventType.StateChanged,timestamp:m,currentPlayPosition:-1,payload:I.HydraPlayerPlaybackState.Destroyed}),g.playback_stateChangeEvents=(0,M.stringifyObject)(v)},e3}()},124:function(g,m){var S;Object.defineProperty(m,"__esModule",{value:!0}),m.MessageType=void 0,(S=m.MessageType||(m.MessageType={})).Command="Command",S.CommandSuccessResult="CommandSuccessResult",S.CommandFailureResult="CommandFailureResult",S.PlayerEvent="PlayerEvent",S.InternalPlayerEvent="InternalPlayerEvent"},63:function(g,m){var S,v;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraSupportedSDN=m.HydraPlayerDestroyedReason=void 0,(v=m.HydraPlayerDestroyedReason||(m.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",v.PlaybackError="PlaybackError",(S=m.HydraSupportedSDN||(m.HydraSupportedSDN={})).Hive="hive",S.Kollective="kollective",S.Ramp="ramp",S.Peer5="peer5",S.Microsoft="microsoft"},844:function(g,m){var S,v;Object.defineProperty(m,"__esModule",{value:!0}),m.PlayerScenarioType=m.TelemetryEventType=void 0,(v=m.TelemetryEventType||(m.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",v.StreamOptionsConfigured="StreamOptionsConfigured",v.BitrateChangedPlayback="BitrateChangedPlayback",v.CaptionsToggled="CaptionsToggled",v.Error="Error",v.FullscreenChanged="FullscreenChanged",v.Mute="Mute",v.PotentialMediaFreeze="PotentialMediaFreeze",v.StateChanged="StateChanged",v.HydraInputStateChanged="HydraInputStateChanged",v.HydraOutputStateChanged="HydraOutputStateChanged",v.Volume="Volume",v.Buffering="Buffering",v.LowBufferReserve="LowBufferReserve",v.Online="Online",v.Offline="Offline",v.NetworkChange="NetworkChange",v.HlsEvents="HlsEvents",(S=m.PlayerScenarioType||(m.PlayerScenarioType={})).LoadHydra="LoadHydra",S.LoadHlsScript="LoadHlsScript",S.LoadPlayer="LoadPlayer",S.Load="Load",S.LoadHlsAuthCookie="LoadHlsAuthCookie",S.HlsManifestLoad="HlsManifestLoad",S.HlsKeyLoad="HlsKeyLoad",S.LoadHlsFirstFragment="LoadHlsFirstFragment",S.SetSource="SetSource",S.SdnPluginLoad="SdnPluginLoad",S.ThaPluginLoad="ThaPluginLoad",S.HydraPipelineInitialization="HydraPipelineInitialization",S.Destroyed="Destroyed",S.Setup="Setup",S.StreamConnection="StreamConnection"},328:function(g,m){var S,v;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=void 0,(v=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",v.Overflow="Overflow",v.TownHallBasic="TownHall_Basic",v.TownHallPremium="TownHall_Premium",v.TownHall="TownHall",(S=m.HydraPlayerType||(m.HydraPlayerType={}))[S.Hls=1]="Hls",S[S.Ums=2]="Ums"},68:function(g,m){var S,v,C,_;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(_=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",_.HLS="MiddleLaneHttpLiveStreaming",_.Ums="MiddleLaneUltraLowLatency",(C=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",C.PlayerInitializationFailed="PlayerInitializationFailed",C.InvalidStream="InvalidStream",C.SetSourceFailed="SetSourceFailed",(v=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",v.LoadedData="loadeddata",v.LoadedMetadata="loadedmetadata",v.Start="start",v.CanPlayThrough="canplaythrough",v.Play="play",v.Playing="playing",v.Pause="pause",v.Waiting="waiting",v.Seeking="seeking",v.Seeked="seeked",v.Ended="ended",v.Error="error",v.Destroyed="destroyed",v.Initialized="initialized",v.Stalled="stalled",v.VolumeChange="volumechange",v.PlaybackBitrateChanged="playbackbitratechanged",v.DownloadBitrateChanged="downloadbitratechanged",v.HlsKeyLoading="hlsKeyLoading",v.HlsKeyLoaded="hlsKeyLoaded",v.HlsKeyLoadedFailed="hlsKeyLoadedFailed",v.HlsManifestLoading="hlsManifestLoading",v.HlsManifestLoaded="hlsManifestLoaded",v.HlsManifestLoadedFailed="hlsManifestLoadedFailed",v.HlsFirstFragmentLoading="hlsFragLoading",v.HlsFirstFragmentBuffered="hlsFragBuffered",v.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",v.Online="online",v.Offline="offline",v.NetworkChange="networkChange",(S=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",S.NetworkError="NetworkError",S.PlaybackRetried="PlaybackRetried",S.PlaybackError="PlaybackError",S.Unknown="Unknown"},944:function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.defer=void 0,m.defer=function(){var g,m;return{promise:new Promise((function(S,v){g=S,m=v})),resolve:g,reject:m}}},329:function(g,m,S){var v=this&&this.__awaiter||function(g,m,S,v){return new(S||(S=Promise))((function(C,_){function o2(g){try{l2(v.next(g))}catch(g){_(g)}}function s2(g){try{l2(v.throw(g))}catch(g){_(g)}}function l2(g){var m;g.done?C(g.value):(m=g.value,m instanceof S?m:new S((function(g){g(m)}))).then(o2,s2)}l2((v=v.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function s2(T){return function(I){return function(T){if(S)throw new TypeError("Generator is already executing.");for(;_&&(_=0,T[0]&&(E=0)),E;)try{if(S=1,v&&(C=2&T[0]?v.return:T[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,T[1])).done)return C;switch(v=0,C&&(T=[2&T[0],C.value]),T[0]){case 0:case 1:C=T;break;case 4:return E.label++,{value:T[1],done:!1};case 5:E.label++,v=T[1],T=[0];continue;case 7:T=E.ops.pop(),E.trys.pop();continue;default:if(!((C=(C=E.trys).length>0&&C[C.length-1])||6!==T[0]&&2!==T[0])){E=0;continue}if(3===T[0]&&(!C||T[1]>C[0]&&T[1]<C[3])){E.label=T[1];break}if(6===T[0]&&E.label<C[1]){E.label=C[1],C=T;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(T);break}C[2]&&E.ops.pop(),E.trys.pop();continue}T=m.call(g,E)}catch(g){T=[6,g],v=0}finally{S=C=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}([T,I])}}};Object.defineProperty(m,"__esModule",{value:!0}),m.createVideoElement=m.createVideoElementDiv=m.showPlayerControls=m.getSdnStats=m.Spinner=m.repeatUntilCancel=m.wait=m.stringifyObject=m.getRandomHexString=m.getPlayerSetting=m.getECSSetting=m.assert=m.createIFrame=m.getMajorFromVersion=void 0;var _=S(63),E=S(328);function s(g,m,S,_,E){return v(this,void 0,void 0,(function(){var T,I,b,A,R=this;return C(this,(function(P){switch(P.label){case 0:return T=100,I=Date.now(),[4,c(S,b={trackingRef:"",timeTakenToDownloadScript:-1},E).catch((function(g){return v(R,void 0,void 0,(function(){var m;return C(this,(function(v){switch(v.label){case 0:return m="Failed to get IFrame source: ".concat(p(g)),_.push({success:!1,url:S,startTime:I,duration:Date.now()-I,trackingReference:b.trackingRef,timeTakenToDownloadScript:b.timeTakenToDownloadScript,errorMsg:m}),_.length>T&&_.shift(),[4,Promise.reject(new Error(m))];case 1:return[2,v.sent()]}}))}))}))];case 1:return A=P.sent(),m.srcdoc=A,g.appendChild(m),[4,new Promise((function(g,v){m.onload=function(){_.push({success:!0,url:S,startTime:I,duration:Date.now()-I,trackingReference:b.trackingRef,timeTakenToDownloadScript:b.timeTakenToDownloadScript}),_.length>T&&_.shift(),g()},m.onerror=function(g){var m="Failed to load HydraPlayer IFrame: ".concat(p(g));_.push({success:!1,url:S,startTime:I,duration:Date.now()-I,trackingReference:b.trackingRef,timeTakenToDownloadScript:b.timeTakenToDownloadScript,errorMsg:m}),_.length>T&&_.shift(),v(new Error(m))}}))];case 2:return P.sent(),[2]}}))}))}function l(g,m){return v(this,void 0,void 0,(function(){var S=this;return C(this,(function(_){switch(_.label){case 0:return[4,g(m).catch((function(_){return v(S,void 0,void 0,(function(){var S=this;return C(this,(function(E){switch(E.label){case 0:return 0!=--m?[3,2]:[4,Promise.reject(_)];case 1:case 3:return[2,E.sent()];case 2:return[4,new Promise((function(E){return setTimeout((function(){E(l(g,m).catch((function(g){return v(S,void 0,void 0,(function(){return C(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(new Error("".concat(p(_)).concat(", ",p(g))))];case 1:return[2,m.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return _.sent(),[2]}}))}))}function c(g,m,S){return v(this,void 0,void 0,(function(){var _,E,T,I=this;return C(this,(function(b){switch(b.label){case 0:return _=Date.now(),[4,d(g,m,S).catch((function(g){return v(I,void 0,void 0,(function(){return C(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(g)];case 1:return[2,m.sent()]}}))}))}))];case 1:return E=b.sent(),T="<script> ".concat(E,"<\/script>"),m.timeTakenToDownloadScript=Date.now()-_,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(T,"\n        </body>\n        </html>\n    ")]}}))}))}function d(g,m,S){return v(this,void 0,void 0,(function(){var _,E,T,I=this;return C(this,(function(b){switch(b.label){case 0:return _=function(g,m){var S,v;return m.includes("vz")?null!==(v=g.headers.get("uuid"))&&void 0!==v?v:"":null!==(S=g.headers.get("X-Azure-Ref"))&&void 0!==S?S:""},S?(E=new AbortController,T=setTimeout((function(){E.abort()}),S),[4,fetch(g,{signal:E.signal,cache:"no-cache"}).then((function(S){return v(I,void 0,void 0,(function(){return C(this,(function(v){switch(v.label){case 0:return clearTimeout(T),S.ok?[3,2]:[4,Promise.reject(new Error("".concat(S.status)))];case 1:return[2,v.sent()];case 2:return m.trackingRef=_(S,g),[2,S]}}))}))})).then((function(m){return v(I,void 0,void 0,(function(){var S=this;return C(this,(function(_){switch(_.label){case 0:return[4,m.text().then((function(_){return v(S,void 0,void 0,(function(){return C(this,(function(S){switch(S.label){case 0:return _?[2,_]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,S.sent()]}}))}))}))];case 1:return[2,_.sent()]}}))}))}))]):[3,2];case 1:case 3:return[2,b.sent()];case 2:return[4,fetch(g,{cache:"no-cache"}).then((function(S){return v(I,void 0,void 0,(function(){return C(this,(function(v){switch(v.label){case 0:return S.ok?[3,2]:[4,Promise.reject(new Error("".concat(S.status)))];case 1:return[2,v.sent()];case 2:return m.trackingRef=_(S,g),[2,S]}}))}))})).then((function(m){return v(I,void 0,void 0,(function(){var S=this;return C(this,(function(_){switch(_.label){case 0:return[4,m.text().then((function(_){return v(S,void 0,void 0,(function(){return C(this,(function(S){switch(S.label){case 0:return _?[2,_]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,S.sent()]}}))}))}))];case 1:return[2,_.sent()]}}))}))}))]}}))}))}function p(g){try{if(!g)return"".concat(g);if(g instanceof Map)return S={},g.forEach((function(g,m){S[m.toString()]=g})),JSON.stringify(S);var m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}catch(g){return""}var S}function y(g){return v(this,void 0,void 0,(function(){return C(this,(function(m){switch(m.label){case 0:return[4,new Promise((function(m){return setTimeout(m,g)}))];case 1:return m.sent(),[2]}}))}))}m.getMajorFromVersion=function(g){var m=g.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return m?m[1]:null},m.createIFrame=function(g,m,S,_,E){return void 0===_&&(_=!1),v(this,void 0,void 0,(function(){var T,I,b,A,R=this;return C(this,(function(P){switch(P.label){case 0:return T=[],I=Date.now(),(b=g.ownerDocument.createElement("iframe")).id="player-iframe",_||b.sandbox.add("allow-scripts"),b.allowFullscreen=!0,b.allow="camera; microphone; autoplay",b.style.height="100%",b.style.width="100%",b.style.border="none",A=function(g){return m[g%m.length]},[4,l((function(m){return v(R,void 0,void 0,(function(){var S;return C(this,(function(v){switch(v.label){case 0:return S=A(m),[4,s(g,b,S,T,E)];case 1:return v.sent(),[2]}}))}))}),S).then((function(){return{iframe:b,initResult:{initSucceeded:!0,initStartTime:I,initDuration:Date.now()-I,runtimeDownloadResults:T}}})).catch((function(g){return v(R,void 0,void 0,(function(){var S;return C(this,(function(v){return S="Failed to load Hydra player runtime scripts, src: ",m.forEach((function(g){return S=S.concat(g,", ")})),S+="errors: ".concat(p(g)),[2,{initResult:{initSucceeded:!1,initStartTime:I,initDuration:Date.now()-I,runtimeDownloadResults:T,errorMsg:S}}]}))}))}))];case 1:return[2,P.sent()]}}))}))},m.assert=function(g,m,S){if(void 0===S&&(S=!1),!g){if(!S)throw new Error("Assert failed".concat(void 0!==m?": ".concat(m):""));console.error("Assert failed".concat(void 0!==m?": ".concat(m):""))}},m.getECSSetting=function(g,m,S){var v,C=S,_=null===(v=g.ecsSettings)||void 0===v?void 0:v[m];return typeof _==typeof C&&(C=_),C},m.getPlayerSetting=function(g,m){var S;return void 0!==(null===(S=g.ecsSettings)||void 0===S?void 0:S[m])?g.ecsSettings[m]:g[m]},m.getRandomHexString=function(g){return Array.from(Array(g)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},m.stringifyObject=p,m.wait=y,m.repeatUntilCancel=function(g,m,S,_){var E=!1,T=_||console.log;return T("RepeatUntilCancel starting task: ".concat(g)),v(this,void 0,void 0,(function(){var v,_,I;return C(this,(function(C){switch(C.label){case 0:return E?[3,2]:(v=new Date,m(),_=(new Date).getTime()-v.getTime(),(I=S-_)<0&&(I=S+I%S,T("Skipping execution for ".concat(g,", last execution took: ").concat(_," ms, delayMs: ").concat(S),"warn")),[4,y(I)]);case 1:return C.sent(),[3,0];case 2:return[2]}}))})),function(){T("RepeatUntilCancel stopping task: ".concat(g)),E=!0}};var T=function(){function e3(g){this.container=g,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var m=this.container.ownerDocument.getElementById(this.spinnerId);if(m)return this.spinner=m,void this.show();var S=this.container.ownerDocument.createElement("style");S.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(S),this.container.style.position="relative";var v=this.container.ownerDocument.createElement("div");v.classList.add("ml-player-spinner-container"),this.container.appendChild(v),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,v.appendChild(this.spinner);var C=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");C.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(C);var _=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");_.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(_),this.show()}return Object.defineProperty(e3.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var g=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];g.hideTimestamp||(g.displayDuration=Date.now()-g.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e3.prototype.show=function(){var g=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=g),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:g,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e3.prototype.hide=function(){var g=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=g),this.spinnerInfoHistory.length>0){var m=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];m.hideTimestamp||(m.hideTimestamp=g,m.displayDuration=g-m.showTimestamp)}this.spinner.style.display="none"},e3.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e3}();m.Spinner=T,m.getSdnStats=function(g,m){(null==g?void 0:g.peer5)&&(m.sdnName=g.peer5?_.HydraSupportedSDN.Microsoft:"",m.sdnVersion=g.peer5?g.peer5.version:"","function"==typeof g.peer5.getStats&&(m.sdnStats=g.peer5.getStats(),m.isP2PSdnUsed=g.peer5.getStats().numOfPeers>0))},m.showPlayerControls=function(g){return void 0!==g.allowPlayerControls?g.allowPlayerControls:g.streamingEventType===E.HydraStreamingEventType.TLE},m.createVideoElementDiv=function(g,m,S){S("createVideoElementDiv started");var v=m.ownerDocument.createElement("div");return v.id=g,v.style.position="relative",v.style.width="100%",v.style.height="100%",m.appendChild(v),S("createVideoElementDiv done"),v},m.createVideoElement=function(g,m,S,v,C){C("createVideoElement started");var _=m.ownerDocument.createElement("video");_.controls=v,_.id=g,_.setAttribute("playsinline","");var E=S.videoLang;E&&(_.setAttribute("lang",E),C("createVideoElement: language set to ".concat(E)));for(var T=S.videoElementStyles,I=0;I<T.length;I++)_.classList.add(T[I]);return _.style.width="100%",_.style.height="100%",_.style.position="absolute",_.muted=S.muteVideo,_.addEventListener("contextmenu",(function(g){g.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(g){try{navigator.mediaSession.setActionHandler(g,(function(){}))}catch(g){}})),m.appendChild(_),C("createVideoElement done"),_}}},m={},function r(S){var v=m[S];if(void 0!==v)return v.exports;var C=m[S]={exports:{}};return g[S].call(C.exports,C,C.exports,r),C.exports}(979);var g,m},"object"==typeof g&&"object"==typeof m?m.exports=v():"object"==typeof g?g.hydra_player_ums_sdk=v():S.hydra_player_ums_sdk=v()}}),re=__commonJS({"../node_modules/pako/lib/utils/common.js"(g){var m="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function _has(g,m){return Object.prototype.hasOwnProperty.call(g,m)}g.assign=function(g){for(var m=Array.prototype.slice.call(arguments,1);m.length;){var S=m.shift();if(S){if("object"!=typeof S)throw new TypeError(S+"must be non-object");for(var v in S)_has(S,v)&&(g[v]=S[v])}}return g},g.shrinkBuf=function(g,m){return g.length===m?g:g.subarray?g.subarray(0,m):(g.length=m,g)};var S={arraySet:function(g,m,S,v,C){if(m.subarray&&g.subarray)g.set(m.subarray(S,S+v),C);else for(var _=0;_<v;_++)g[C+_]=m[S+_]},flattenChunks:function(g){var m,S,v,C,_,E;for(v=0,m=0,S=g.length;m<S;m++)v+=g[m].length;for(E=new Uint8Array(v),C=0,m=0,S=g.length;m<S;m++)_=g[m],E.set(_,C),C+=_.length;return E}},v={arraySet:function(g,m,S,v,C){for(var _=0;_<v;_++)g[C+_]=m[S+_]},flattenChunks:function(g){return[].concat.apply([],g)}};g.setTyped=function(m){m?(g.Buf8=Uint8Array,g.Buf16=Uint16Array,g.Buf32=Int32Array,g.assign(g,S)):(g.Buf8=Array,g.Buf16=Array,g.Buf32=Array,g.assign(g,v))},g.setTyped(m)}}),se=__commonJS({"../node_modules/pako/lib/zlib/trees.js"(g){var m=re(),S=4,v=0,C=1,_=2;function zero(g){for(var m=g.length;--m>=0;)g[m]=0}var E=0,T=1,I=2,b=3,A=258,R=29,P=256,M=P+1+R,w=30,D=19,O=2*M+1,N=15,k=16,L=7,F=256,x=16,U=17,V=18,B=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],H=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],$=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],j=512,q=new Array(2*(M+2));zero(q);var W=new Array(2*w);zero(W);var z=new Array(j);zero(z);var K=new Array(A-b+1);zero(K);var J=new Array(R);zero(J);var Y,Q,X,Z=new Array(w);function StaticTreeDesc(g,m,S,v,C){this.static_tree=g,this.extra_bits=m,this.extra_base=S,this.elems=v,this.max_length=C,this.has_stree=g&&g.length}function TreeDesc(g,m){this.dyn_tree=g,this.max_code=0,this.stat_desc=m}function d_code(g){return g<256?z[g]:z[256+(g>>>7)]}function put_short(g,m){g.pending_buf[g.pending++]=255&m,g.pending_buf[g.pending++]=m>>>8&255}function send_bits(g,m,S){g.bi_valid>k-S?(g.bi_buf|=m<<g.bi_valid&65535,put_short(g,g.bi_buf),g.bi_buf=m>>k-g.bi_valid,g.bi_valid+=S-k):(g.bi_buf|=m<<g.bi_valid&65535,g.bi_valid+=S)}function send_code(g,m,S){send_bits(g,S[2*m],S[2*m+1])}function bi_reverse(g,m){var S=0;do{S|=1&g,g>>>=1,S<<=1}while(--m>0);return S>>>1}function bi_flush(g){16===g.bi_valid?(put_short(g,g.bi_buf),g.bi_buf=0,g.bi_valid=0):g.bi_valid>=8&&(g.pending_buf[g.pending++]=255&g.bi_buf,g.bi_buf>>=8,g.bi_valid-=8)}function gen_bitlen(g,m){var S,v,C,_,E,T,I=m.dyn_tree,b=m.max_code,A=m.stat_desc.static_tree,R=m.stat_desc.has_stree,P=m.stat_desc.extra_bits,M=m.stat_desc.extra_base,w=m.stat_desc.max_length,D=0;for(_=0;_<=N;_++)g.bl_count[_]=0;for(I[2*g.heap[g.heap_max]+1]=0,S=g.heap_max+1;S<O;S++)(_=I[2*I[2*(v=g.heap[S])+1]+1]+1)>w&&(_=w,D++),I[2*v+1]=_,v>b||(g.bl_count[_]++,E=0,v>=M&&(E=P[v-M]),T=I[2*v],g.opt_len+=T*(_+E),R&&(g.static_len+=T*(A[2*v+1]+E)));if(0!==D){do{for(_=w-1;0===g.bl_count[_];)_--;g.bl_count[_]--,g.bl_count[_+1]+=2,g.bl_count[w]--,D-=2}while(D>0);for(_=w;0!==_;_--)for(v=g.bl_count[_];0!==v;)(C=g.heap[--S])>b||(I[2*C+1]!==_&&(g.opt_len+=(_-I[2*C+1])*I[2*C],I[2*C+1]=_),v--)}}function gen_codes(g,m,S){var v,C,_=new Array(N+1),E=0;for(v=1;v<=N;v++)_[v]=E=E+S[v-1]<<1;for(C=0;C<=m;C++){var T=g[2*C+1];0!==T&&(g[2*C]=bi_reverse(_[T]++,T))}}function tr_static_init(){var g,m,S,v,C,_=new Array(N+1);for(S=0,v=0;v<R-1;v++)for(J[v]=S,g=0;g<1<<B[v];g++)K[S++]=v;for(K[S-1]=v,C=0,v=0;v<16;v++)for(Z[v]=C,g=0;g<1<<H[v];g++)z[C++]=v;for(C>>=7;v<w;v++)for(Z[v]=C<<7,g=0;g<1<<H[v]-7;g++)z[256+C++]=v;for(m=0;m<=N;m++)_[m]=0;for(g=0;g<=143;)q[2*g+1]=8,g++,_[8]++;for(;g<=255;)q[2*g+1]=9,g++,_[9]++;for(;g<=279;)q[2*g+1]=7,g++,_[7]++;for(;g<=287;)q[2*g+1]=8,g++,_[8]++;for(gen_codes(q,M+1,_),g=0;g<w;g++)W[2*g+1]=5,W[2*g]=bi_reverse(g,5);Y=new StaticTreeDesc(q,B,P+1,M,N),Q=new StaticTreeDesc(W,H,0,w,N),X=new StaticTreeDesc(new Array(0),$,0,D,L)}function init_block(g){var m;for(m=0;m<M;m++)g.dyn_ltree[2*m]=0;for(m=0;m<w;m++)g.dyn_dtree[2*m]=0;for(m=0;m<D;m++)g.bl_tree[2*m]=0;g.dyn_ltree[2*F]=1,g.opt_len=g.static_len=0,g.last_lit=g.matches=0}function bi_windup(g){g.bi_valid>8?put_short(g,g.bi_buf):g.bi_valid>0&&(g.pending_buf[g.pending++]=g.bi_buf),g.bi_buf=0,g.bi_valid=0}function copy_block(g,S,v,C){bi_windup(g),C&&(put_short(g,v),put_short(g,~v)),m.arraySet(g.pending_buf,g.window,S,v,g.pending),g.pending+=v}function smaller(g,m,S,v){var C=2*m,_=2*S;return g[C]<g[_]||g[C]===g[_]&&v[m]<=v[S]}function pqdownheap(g,m,S){for(var v=g.heap[S],C=S<<1;C<=g.heap_len&&(C<g.heap_len&&smaller(m,g.heap[C+1],g.heap[C],g.depth)&&C++,!smaller(m,v,g.heap[C],g.depth));)g.heap[S]=g.heap[C],S=C,C<<=1;g.heap[S]=v}function compress_block(g,m,S){var v,C,_,E,T=0;if(0!==g.last_lit)do{v=g.pending_buf[g.d_buf+2*T]<<8|g.pending_buf[g.d_buf+2*T+1],C=g.pending_buf[g.l_buf+T],T++,0===v?send_code(g,C,m):(send_code(g,(_=K[C])+P+1,m),0!==(E=B[_])&&send_bits(g,C-=J[_],E),send_code(g,_=d_code(--v),S),0!==(E=H[_])&&send_bits(g,v-=Z[_],E))}while(T<g.last_lit);send_code(g,F,m)}function build_tree(g,m){var S,v,C,_=m.dyn_tree,E=m.stat_desc.static_tree,T=m.stat_desc.has_stree,I=m.stat_desc.elems,b=-1;for(g.heap_len=0,g.heap_max=O,S=0;S<I;S++)0!==_[2*S]?(g.heap[++g.heap_len]=b=S,g.depth[S]=0):_[2*S+1]=0;for(;g.heap_len<2;)_[2*(C=g.heap[++g.heap_len]=b<2?++b:0)]=1,g.depth[C]=0,g.opt_len--,T&&(g.static_len-=E[2*C+1]);for(m.max_code=b,S=g.heap_len>>1;S>=1;S--)pqdownheap(g,_,S);C=I;do{S=g.heap[1],g.heap[1]=g.heap[g.heap_len--],pqdownheap(g,_,1),v=g.heap[1],g.heap[--g.heap_max]=S,g.heap[--g.heap_max]=v,_[2*C]=_[2*S]+_[2*v],g.depth[C]=(g.depth[S]>=g.depth[v]?g.depth[S]:g.depth[v])+1,_[2*S+1]=_[2*v+1]=C,g.heap[1]=C++,pqdownheap(g,_,1)}while(g.heap_len>=2);g.heap[--g.heap_max]=g.heap[1],gen_bitlen(g,m),gen_codes(_,b,g.bl_count)}function scan_tree(g,m,S){var v,C,_=-1,E=m[1],T=0,I=7,b=4;for(0===E&&(I=138,b=3),m[2*(S+1)+1]=65535,v=0;v<=S;v++)C=E,E=m[2*(v+1)+1],++T<I&&C===E||(T<b?g.bl_tree[2*C]+=T:0!==C?(C!==_&&g.bl_tree[2*C]++,g.bl_tree[2*x]++):T<=10?g.bl_tree[2*U]++:g.bl_tree[2*V]++,T=0,_=C,0===E?(I=138,b=3):C===E?(I=6,b=3):(I=7,b=4))}function send_tree(g,m,S){var v,C,_=-1,E=m[1],T=0,I=7,b=4;for(0===E&&(I=138,b=3),v=0;v<=S;v++)if(C=E,E=m[2*(v+1)+1],!(++T<I&&C===E)){if(T<b)do{send_code(g,C,g.bl_tree)}while(0!=--T);else 0!==C?(C!==_&&(send_code(g,C,g.bl_tree),T--),send_code(g,x,g.bl_tree),send_bits(g,T-3,2)):T<=10?(send_code(g,U,g.bl_tree),send_bits(g,T-3,3)):(send_code(g,V,g.bl_tree),send_bits(g,T-11,7));T=0,_=C,0===E?(I=138,b=3):C===E?(I=6,b=3):(I=7,b=4)}}function build_bl_tree(g){var m;for(scan_tree(g,g.dyn_ltree,g.l_desc.max_code),scan_tree(g,g.dyn_dtree,g.d_desc.max_code),build_tree(g,g.bl_desc),m=D-1;m>=3&&0===g.bl_tree[2*G[m]+1];m--);return g.opt_len+=3*(m+1)+5+5+4,m}function send_all_trees(g,m,S,v){var C;for(send_bits(g,m-257,5),send_bits(g,S-1,5),send_bits(g,v-4,4),C=0;C<v;C++)send_bits(g,g.bl_tree[2*G[C]+1],3);send_tree(g,g.dyn_ltree,m-1),send_tree(g,g.dyn_dtree,S-1)}function detect_data_type(g){var m,S=4093624447;for(m=0;m<=31;m++,S>>>=1)if(1&S&&0!==g.dyn_ltree[2*m])return v;if(0!==g.dyn_ltree[18]||0!==g.dyn_ltree[20]||0!==g.dyn_ltree[26])return C;for(m=32;m<P;m++)if(0!==g.dyn_ltree[2*m])return C;return v}zero(Z);var ee=!1;function _tr_init(g){ee||(tr_static_init(),ee=!0),g.l_desc=new TreeDesc(g.dyn_ltree,Y),g.d_desc=new TreeDesc(g.dyn_dtree,Q),g.bl_desc=new TreeDesc(g.bl_tree,X),g.bi_buf=0,g.bi_valid=0,init_block(g)}function _tr_stored_block(g,m,S,v){send_bits(g,(E<<1)+(v?1:0),3),copy_block(g,m,S,!0)}function _tr_align(g){send_bits(g,T<<1,3),send_code(g,F,q),bi_flush(g)}function _tr_flush_block(g,m,v,C){var E,b,A=0;g.level>0?(g.strm.data_type===_&&(g.strm.data_type=detect_data_type(g)),build_tree(g,g.l_desc),build_tree(g,g.d_desc),A=build_bl_tree(g),E=g.opt_len+3+7>>>3,(b=g.static_len+3+7>>>3)<=E&&(E=b)):E=b=v+5,v+4<=E&&-1!==m?_tr_stored_block(g,m,v,C):g.strategy===S||b===E?(send_bits(g,(T<<1)+(C?1:0),3),compress_block(g,q,W)):(send_bits(g,(I<<1)+(C?1:0),3),send_all_trees(g,g.l_desc.max_code+1,g.d_desc.max_code+1,A+1),compress_block(g,g.dyn_ltree,g.dyn_dtree)),init_block(g),C&&bi_windup(g)}function _tr_tally(g,m,S){return g.pending_buf[g.d_buf+2*g.last_lit]=m>>>8&255,g.pending_buf[g.d_buf+2*g.last_lit+1]=255&m,g.pending_buf[g.l_buf+g.last_lit]=255&S,g.last_lit++,0===m?g.dyn_ltree[2*S]++:(g.matches++,m--,g.dyn_ltree[2*(K[S]+P+1)]++,g.dyn_dtree[2*d_code(m)]++),g.last_lit===g.lit_bufsize-1}g._tr_init=_tr_init,g._tr_stored_block=_tr_stored_block,g._tr_flush_block=_tr_flush_block,g._tr_tally=_tr_tally,g._tr_align=_tr_align}}),ae=__commonJS({"../node_modules/pako/lib/zlib/adler32.js"(g,m){function adler32(g,m,S,v){for(var C=65535&g|0,_=g>>>16&65535|0,E=0;0!==S;){S-=E=S>2e3?2e3:S;do{_=_+(C=C+m[v++]|0)|0}while(--E);C%=65521,_%=65521}return C|_<<16|0}m.exports=adler32}}),oe=__commonJS({"../node_modules/pako/lib/zlib/crc32.js"(g,m){function makeTable(){for(var g,m=[],S=0;S<256;S++){g=S;for(var v=0;v<8;v++)g=1&g?3988292384^g>>>1:g>>>1;m[S]=g}return m}var S=makeTable();function crc32(g,m,v,C){var _=S,E=C+v;g^=-1;for(var T=C;T<E;T++)g=g>>>8^_[255&(g^m[T])];return-1^g}m.exports=crc32}}),le=__commonJS({"../node_modules/pako/lib/zlib/messages.js"(g,m){m.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}}}),ce=__commonJS({"../node_modules/pako/lib/zlib/deflate.js"(g){var m,S=re(),v=se(),C=ae(),_=oe(),E=le(),T=0,I=1,b=3,A=4,R=5,P=0,M=1,w=-2,D=-3,O=-5,N=-1,k=1,L=2,F=3,x=4,U=0,V=2,B=8,H=9,$=15,G=8,j=256+1+29,q=30,W=19,z=2*j+1,K=15,J=3,Y=258,Q=Y+J+1,X=32,Z=42,ee=69,te=73,ie=91,ne=103,ce=113,de=666,he=1,ue=2,ge=3,pe=4,me=3;function err(g,m){return g.msg=E[m],m}function rank(g){return(g<<1)-(g>4?9:0)}function zero(g){for(var m=g.length;--m>=0;)g[m]=0}function flush_pending(g){var m=g.state,v=m.pending;v>g.avail_out&&(v=g.avail_out),0!==v&&(S.arraySet(g.output,m.pending_buf,m.pending_out,v,g.next_out),g.next_out+=v,m.pending_out+=v,g.total_out+=v,g.avail_out-=v,m.pending-=v,0===m.pending&&(m.pending_out=0))}function flush_block_only(g,m){v._tr_flush_block(g,g.block_start>=0?g.block_start:-1,g.strstart-g.block_start,m),g.block_start=g.strstart,flush_pending(g.strm)}function put_byte(g,m){g.pending_buf[g.pending++]=m}function putShortMSB(g,m){g.pending_buf[g.pending++]=m>>>8&255,g.pending_buf[g.pending++]=255&m}function read_buf(g,m,v,E){var T=g.avail_in;return T>E&&(T=E),0===T?0:(g.avail_in-=T,S.arraySet(m,g.input,g.next_in,T,v),1===g.state.wrap?g.adler=C(g.adler,m,T,v):2===g.state.wrap&&(g.adler=_(g.adler,m,T,v)),g.next_in+=T,g.total_in+=T,T)}function longest_match(g,m){var S,v,C=g.max_chain_length,_=g.strstart,E=g.prev_length,T=g.nice_match,I=g.strstart>g.w_size-Q?g.strstart-(g.w_size-Q):0,b=g.window,A=g.w_mask,R=g.prev,P=g.strstart+Y,M=b[_+E-1],w=b[_+E];g.prev_length>=g.good_match&&(C>>=2),T>g.lookahead&&(T=g.lookahead);do{if(b[(S=m)+E]===w&&b[S+E-1]===M&&b[S]===b[_]&&b[++S]===b[_+1]){_+=2,S++;do{}while(b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&_<P);if(v=Y-(P-_),_=P-Y,v>E){if(g.match_start=m,E=v,v>=T)break;M=b[_+E-1],w=b[_+E]}}}while((m=R[m&A])>I&&0!=--C);return E<=g.lookahead?E:g.lookahead}function fill_window(g){var m,v,C,_,E,T=g.w_size;do{if(_=g.window_size-g.lookahead-g.strstart,g.strstart>=T+(T-Q)){S.arraySet(g.window,g.window,T,T,0),g.match_start-=T,g.strstart-=T,g.block_start-=T,m=v=g.hash_size;do{C=g.head[--m],g.head[m]=C>=T?C-T:0}while(--v);m=v=T;do{C=g.prev[--m],g.prev[m]=C>=T?C-T:0}while(--v);_+=T}if(0===g.strm.avail_in)break;if(v=read_buf(g.strm,g.window,g.strstart+g.lookahead,_),g.lookahead+=v,g.lookahead+g.insert>=J)for(E=g.strstart-g.insert,g.ins_h=g.window[E],g.ins_h=(g.ins_h<<g.hash_shift^g.window[E+1])&g.hash_mask;g.insert&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[E+J-1])&g.hash_mask,g.prev[E&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=E,E++,g.insert--,!(g.lookahead+g.insert<J)););}while(g.lookahead<Q&&0!==g.strm.avail_in)}function deflate_stored(g,m){var S=65535;for(S>g.pending_buf_size-5&&(S=g.pending_buf_size-5);;){if(g.lookahead<=1){if(fill_window(g),0===g.lookahead&&m===T)return he;if(0===g.lookahead)break}g.strstart+=g.lookahead,g.lookahead=0;var v=g.block_start+S;if((0===g.strstart||g.strstart>=v)&&(g.lookahead=g.strstart-v,g.strstart=v,flush_block_only(g,!1),0===g.strm.avail_out))return he;if(g.strstart-g.block_start>=g.w_size-Q&&(flush_block_only(g,!1),0===g.strm.avail_out))return he}return g.insert=0,m===A?(flush_block_only(g,!0),0===g.strm.avail_out?ge:pe):(g.strstart>g.block_start&&(flush_block_only(g,!1),g.strm.avail_out),he)}function deflate_fast(g,m){for(var S,C;;){if(g.lookahead<Q){if(fill_window(g),g.lookahead<Q&&m===T)return he;if(0===g.lookahead)break}if(S=0,g.lookahead>=J&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+J-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),0!==S&&g.strstart-S<=g.w_size-Q&&(g.match_length=longest_match(g,S)),g.match_length>=J)if(C=v._tr_tally(g,g.strstart-g.match_start,g.match_length-J),g.lookahead-=g.match_length,g.match_length<=g.max_lazy_match&&g.lookahead>=J){g.match_length--;do{g.strstart++,g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+J-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart}while(0!=--g.match_length);g.strstart++}else g.strstart+=g.match_length,g.match_length=0,g.ins_h=g.window[g.strstart],g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+1])&g.hash_mask;else C=v._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++;if(C&&(flush_block_only(g,!1),0===g.strm.avail_out))return he}return g.insert=g.strstart<J-1?g.strstart:J-1,m===A?(flush_block_only(g,!0),0===g.strm.avail_out?ge:pe):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?he:ue}function deflate_slow(g,m){for(var S,C,_;;){if(g.lookahead<Q){if(fill_window(g),g.lookahead<Q&&m===T)return he;if(0===g.lookahead)break}if(S=0,g.lookahead>=J&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+J-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),g.prev_length=g.match_length,g.prev_match=g.match_start,g.match_length=J-1,0!==S&&g.prev_length<g.max_lazy_match&&g.strstart-S<=g.w_size-Q&&(g.match_length=longest_match(g,S),g.match_length<=5&&(g.strategy===k||g.match_length===J&&g.strstart-g.match_start>4096)&&(g.match_length=J-1)),g.prev_length>=J&&g.match_length<=g.prev_length){_=g.strstart+g.lookahead-J,C=v._tr_tally(g,g.strstart-1-g.prev_match,g.prev_length-J),g.lookahead-=g.prev_length-1,g.prev_length-=2;do{++g.strstart<=_&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+J-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart)}while(0!=--g.prev_length);if(g.match_available=0,g.match_length=J-1,g.strstart++,C&&(flush_block_only(g,!1),0===g.strm.avail_out))return he}else if(g.match_available){if((C=v._tr_tally(g,0,g.window[g.strstart-1]))&&flush_block_only(g,!1),g.strstart++,g.lookahead--,0===g.strm.avail_out)return he}else g.match_available=1,g.strstart++,g.lookahead--}return g.match_available&&(C=v._tr_tally(g,0,g.window[g.strstart-1]),g.match_available=0),g.insert=g.strstart<J-1?g.strstart:J-1,m===A?(flush_block_only(g,!0),0===g.strm.avail_out?ge:pe):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?he:ue}function deflate_rle(g,m){for(var S,C,_,E,I=g.window;;){if(g.lookahead<=Y){if(fill_window(g),g.lookahead<=Y&&m===T)return he;if(0===g.lookahead)break}if(g.match_length=0,g.lookahead>=J&&g.strstart>0&&(C=I[_=g.strstart-1])===I[++_]&&C===I[++_]&&C===I[++_]){E=g.strstart+Y;do{}while(C===I[++_]&&C===I[++_]&&C===I[++_]&&C===I[++_]&&C===I[++_]&&C===I[++_]&&C===I[++_]&&C===I[++_]&&_<E);g.match_length=Y-(E-_),g.match_length>g.lookahead&&(g.match_length=g.lookahead)}if(g.match_length>=J?(S=v._tr_tally(g,1,g.match_length-J),g.lookahead-=g.match_length,g.strstart+=g.match_length,g.match_length=0):(S=v._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++),S&&(flush_block_only(g,!1),0===g.strm.avail_out))return he}return g.insert=0,m===A?(flush_block_only(g,!0),0===g.strm.avail_out?ge:pe):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?he:ue}function deflate_huff(g,m){for(var S;;){if(0===g.lookahead&&(fill_window(g),0===g.lookahead)){if(m===T)return he;break}if(g.match_length=0,S=v._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++,S&&(flush_block_only(g,!1),0===g.strm.avail_out))return he}return g.insert=0,m===A?(flush_block_only(g,!0),0===g.strm.avail_out?ge:pe):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?he:ue}function Config(g,m,S,v,C){this.good_length=g,this.max_lazy=m,this.nice_length=S,this.max_chain=v,this.func=C}function lm_init(g){g.window_size=2*g.w_size,zero(g.head),g.max_lazy_match=m[g.level].max_lazy,g.good_match=m[g.level].good_length,g.nice_match=m[g.level].nice_length,g.max_chain_length=m[g.level].max_chain,g.strstart=0,g.block_start=0,g.lookahead=0,g.insert=0,g.match_length=g.prev_length=J-1,g.match_available=0,g.ins_h=0}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=B,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new S.Buf16(2*z),this.dyn_dtree=new S.Buf16(2*(2*q+1)),this.bl_tree=new S.Buf16(2*(2*W+1)),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new S.Buf16(K+1),this.heap=new S.Buf16(2*j+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new S.Buf16(2*j+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(g){var m;return g&&g.state?(g.total_in=g.total_out=0,g.data_type=V,(m=g.state).pending=0,m.pending_out=0,m.wrap<0&&(m.wrap=-m.wrap),m.status=m.wrap?Z:ce,g.adler=2===m.wrap?0:1,m.last_flush=T,v._tr_init(m),P):err(g,w)}function deflateReset(g){var m=deflateResetKeep(g);return m===P&&lm_init(g.state),m}function deflateSetHeader(g,m){return g&&g.state?2!==g.state.wrap?w:(g.state.gzhead=m,P):w}function deflateInit2(g,m,v,C,_,E){if(!g)return w;var T=1;if(m===N&&(m=6),C<0?(T=0,C=-C):C>15&&(T=2,C-=16),_<1||_>H||v!==B||C<8||C>15||m<0||m>9||E<0||E>x)return err(g,w);8===C&&(C=9);var I=new DeflateState;return g.state=I,I.strm=g,I.wrap=T,I.gzhead=null,I.w_bits=C,I.w_size=1<<I.w_bits,I.w_mask=I.w_size-1,I.hash_bits=_+7,I.hash_size=1<<I.hash_bits,I.hash_mask=I.hash_size-1,I.hash_shift=~~((I.hash_bits+J-1)/J),I.window=new S.Buf8(2*I.w_size),I.head=new S.Buf16(I.hash_size),I.prev=new S.Buf16(I.w_size),I.lit_bufsize=1<<_+6,I.pending_buf_size=4*I.lit_bufsize,I.pending_buf=new S.Buf8(I.pending_buf_size),I.d_buf=1*I.lit_bufsize,I.l_buf=3*I.lit_bufsize,I.level=m,I.strategy=E,I.method=v,deflateReset(g)}function deflateInit(g,m){return deflateInit2(g,m,B,$,G,U)}function deflate(g,S){var C,E,D,N;if(!g||!g.state||S>R||S<0)return g?err(g,w):w;if(E=g.state,!g.output||!g.input&&0!==g.avail_in||E.status===de&&S!==A)return err(g,0===g.avail_out?O:w);if(E.strm=g,C=E.last_flush,E.last_flush=S,E.status===Z)if(2===E.wrap)g.adler=0,put_byte(E,31),put_byte(E,139),put_byte(E,8),E.gzhead?(put_byte(E,(E.gzhead.text?1:0)+(E.gzhead.hcrc?2:0)+(E.gzhead.extra?4:0)+(E.gzhead.name?8:0)+(E.gzhead.comment?16:0)),put_byte(E,255&E.gzhead.time),put_byte(E,E.gzhead.time>>8&255),put_byte(E,E.gzhead.time>>16&255),put_byte(E,E.gzhead.time>>24&255),put_byte(E,9===E.level?2:E.strategy>=L||E.level<2?4:0),put_byte(E,255&E.gzhead.os),E.gzhead.extra&&E.gzhead.extra.length&&(put_byte(E,255&E.gzhead.extra.length),put_byte(E,E.gzhead.extra.length>>8&255)),E.gzhead.hcrc&&(g.adler=_(g.adler,E.pending_buf,E.pending,0)),E.gzindex=0,E.status=ee):(put_byte(E,0),put_byte(E,0),put_byte(E,0),put_byte(E,0),put_byte(E,0),put_byte(E,9===E.level?2:E.strategy>=L||E.level<2?4:0),put_byte(E,me),E.status=ce);else{var k=B+(E.w_bits-8<<4)<<8;k|=(E.strategy>=L||E.level<2?0:E.level<6?1:6===E.level?2:3)<<6,0!==E.strstart&&(k|=X),k+=31-k%31,E.status=ce,putShortMSB(E,k),0!==E.strstart&&(putShortMSB(E,g.adler>>>16),putShortMSB(E,65535&g.adler)),g.adler=1}if(E.status===ee)if(E.gzhead.extra){for(D=E.pending;E.gzindex<(65535&E.gzhead.extra.length)&&(E.pending!==E.pending_buf_size||(E.gzhead.hcrc&&E.pending>D&&(g.adler=_(g.adler,E.pending_buf,E.pending-D,D)),flush_pending(g),D=E.pending,E.pending!==E.pending_buf_size));)put_byte(E,255&E.gzhead.extra[E.gzindex]),E.gzindex++;E.gzhead.hcrc&&E.pending>D&&(g.adler=_(g.adler,E.pending_buf,E.pending-D,D)),E.gzindex===E.gzhead.extra.length&&(E.gzindex=0,E.status=te)}else E.status=te;if(E.status===te)if(E.gzhead.name){D=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>D&&(g.adler=_(g.adler,E.pending_buf,E.pending-D,D)),flush_pending(g),D=E.pending,E.pending===E.pending_buf_size)){N=1;break}N=E.gzindex<E.gzhead.name.length?255&E.gzhead.name.charCodeAt(E.gzindex++):0,put_byte(E,N)}while(0!==N);E.gzhead.hcrc&&E.pending>D&&(g.adler=_(g.adler,E.pending_buf,E.pending-D,D)),0===N&&(E.gzindex=0,E.status=ie)}else E.status=ie;if(E.status===ie)if(E.gzhead.comment){D=E.pending;do{if(E.pending===E.pending_buf_size&&(E.gzhead.hcrc&&E.pending>D&&(g.adler=_(g.adler,E.pending_buf,E.pending-D,D)),flush_pending(g),D=E.pending,E.pending===E.pending_buf_size)){N=1;break}N=E.gzindex<E.gzhead.comment.length?255&E.gzhead.comment.charCodeAt(E.gzindex++):0,put_byte(E,N)}while(0!==N);E.gzhead.hcrc&&E.pending>D&&(g.adler=_(g.adler,E.pending_buf,E.pending-D,D)),0===N&&(E.status=ne)}else E.status=ne;if(E.status===ne&&(E.gzhead.hcrc?(E.pending+2>E.pending_buf_size&&flush_pending(g),E.pending+2<=E.pending_buf_size&&(put_byte(E,255&g.adler),put_byte(E,g.adler>>8&255),g.adler=0,E.status=ce)):E.status=ce),0!==E.pending){if(flush_pending(g),0===g.avail_out)return E.last_flush=-1,P}else if(0===g.avail_in&&rank(S)<=rank(C)&&S!==A)return err(g,O);if(E.status===de&&0!==g.avail_in)return err(g,O);if(0!==g.avail_in||0!==E.lookahead||S!==T&&E.status!==de){var x=E.strategy===L?deflate_huff(E,S):E.strategy===F?deflate_rle(E,S):m[E.level].func(E,S);if(x!==ge&&x!==pe||(E.status=de),x===he||x===ge)return 0===g.avail_out&&(E.last_flush=-1),P;if(x===ue&&(S===I?v._tr_align(E):S!==R&&(v._tr_stored_block(E,0,0,!1),S===b&&(zero(E.head),0===E.lookahead&&(E.strstart=0,E.block_start=0,E.insert=0))),flush_pending(g),0===g.avail_out))return E.last_flush=-1,P}return S!==A?P:E.wrap<=0?M:(2===E.wrap?(put_byte(E,255&g.adler),put_byte(E,g.adler>>8&255),put_byte(E,g.adler>>16&255),put_byte(E,g.adler>>24&255),put_byte(E,255&g.total_in),put_byte(E,g.total_in>>8&255),put_byte(E,g.total_in>>16&255),put_byte(E,g.total_in>>24&255)):(putShortMSB(E,g.adler>>>16),putShortMSB(E,65535&g.adler)),flush_pending(g),E.wrap>0&&(E.wrap=-E.wrap),0!==E.pending?P:M)}function deflateEnd(g){var m;return g&&g.state?(m=g.state.status)!==Z&&m!==ee&&m!==te&&m!==ie&&m!==ne&&m!==ce&&m!==de?err(g,w):(g.state=null,m===ce?err(g,D):P):w}function deflateSetDictionary(g,m){var v,_,E,T,I,b,A,R,M=m.length;if(!g||!g.state)return w;if(2===(T=(v=g.state).wrap)||1===T&&v.status!==Z||v.lookahead)return w;for(1===T&&(g.adler=C(g.adler,m,M,0)),v.wrap=0,M>=v.w_size&&(0===T&&(zero(v.head),v.strstart=0,v.block_start=0,v.insert=0),R=new S.Buf8(v.w_size),S.arraySet(R,m,M-v.w_size,v.w_size,0),m=R,M=v.w_size),I=g.avail_in,b=g.next_in,A=g.input,g.avail_in=M,g.next_in=0,g.input=m,fill_window(v);v.lookahead>=J;){_=v.strstart,E=v.lookahead-(J-1);do{v.ins_h=(v.ins_h<<v.hash_shift^v.window[_+J-1])&v.hash_mask,v.prev[_&v.w_mask]=v.head[v.ins_h],v.head[v.ins_h]=_,_++}while(--E);v.strstart=_,v.lookahead=J-1,fill_window(v)}return v.strstart+=v.lookahead,v.block_start=v.strstart,v.insert=v.lookahead,v.lookahead=0,v.match_length=v.prev_length=J-1,v.match_available=0,g.next_in=b,g.input=A,g.avail_in=I,v.wrap=T,P}m=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],g.deflateInit=deflateInit,g.deflateInit2=deflateInit2,g.deflateReset=deflateReset,g.deflateResetKeep=deflateResetKeep,g.deflateSetHeader=deflateSetHeader,g.deflate=deflate,g.deflateEnd=deflateEnd,g.deflateSetDictionary=deflateSetDictionary,g.deflateInfo="pako deflate (from Nodeca project)"}}),de=__commonJS({"../node_modules/pako/lib/utils/strings.js"(g){var m=re(),S=!0,v=!0;try{String.fromCharCode.apply(null,[0])}catch(g){S=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(g){v=!1}var C,_=new m.Buf8(256);for(C=0;C<256;C++)_[C]=C>=252?6:C>=248?5:C>=240?4:C>=224?3:C>=192?2:1;function buf2binstring(g,C){if(C<65534&&(g.subarray&&v||!g.subarray&&S))return String.fromCharCode.apply(null,m.shrinkBuf(g,C));for(var _="",E=0;E<C;E++)_+=String.fromCharCode(g[E]);return _}_[254]=_[254]=1,g.string2buf=function(g){var S,v,C,_,E,T=g.length,I=0;for(_=0;_<T;_++)55296==(64512&(v=g.charCodeAt(_)))&&_+1<T&&56320==(64512&(C=g.charCodeAt(_+1)))&&(v=65536+(v-55296<<10)+(C-56320),_++),I+=v<128?1:v<2048?2:v<65536?3:4;for(S=new m.Buf8(I),E=0,_=0;E<I;_++)55296==(64512&(v=g.charCodeAt(_)))&&_+1<T&&56320==(64512&(C=g.charCodeAt(_+1)))&&(v=65536+(v-55296<<10)+(C-56320),_++),v<128?S[E++]=v:v<2048?(S[E++]=192|v>>>6,S[E++]=128|63&v):v<65536?(S[E++]=224|v>>>12,S[E++]=128|v>>>6&63,S[E++]=128|63&v):(S[E++]=240|v>>>18,S[E++]=128|v>>>12&63,S[E++]=128|v>>>6&63,S[E++]=128|63&v);return S},g.buf2binstring=function(g){return buf2binstring(g,g.length)},g.binstring2buf=function(g){for(var S=new m.Buf8(g.length),v=0,C=S.length;v<C;v++)S[v]=g.charCodeAt(v);return S},g.buf2string=function(g,m){var S,v,C,E,T=m||g.length,I=new Array(2*T);for(v=0,S=0;S<T;)if((C=g[S++])<128)I[v++]=C;else if((E=_[C])>4)I[v++]=65533,S+=E-1;else{for(C&=2===E?31:3===E?15:7;E>1&&S<T;)C=C<<6|63&g[S++],E--;E>1?I[v++]=65533:C<65536?I[v++]=C:(C-=65536,I[v++]=55296|C>>10&1023,I[v++]=56320|1023&C)}return buf2binstring(I,v)},g.utf8border=function(g,m){var S;for((m=m||g.length)>g.length&&(m=g.length),S=m-1;S>=0&&128==(192&g[S]);)S--;return S<0||0===S?m:S+_[g[S]]>m?S:m}}}),he=__commonJS({"../node_modules/pako/lib/zlib/zstream.js"(g,m){function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}m.exports=ZStream}}),ue=__commonJS({"../node_modules/pako/lib/deflate.js"(g){var m=ce(),S=re(),v=de(),C=le(),_=he(),E=Object.prototype.toString,T=0,I=4,b=0,A=1,R=2,P=-1,M=0,w=8;function Deflate(g){if(!(this instanceof Deflate))return new Deflate(g);this.options=S.assign({level:P,method:w,chunkSize:16384,windowBits:15,memLevel:8,strategy:M,to:""},g||{});var T=this.options;T.raw&&T.windowBits>0?T.windowBits=-T.windowBits:T.gzip&&T.windowBits>0&&T.windowBits<16&&(T.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new _,this.strm.avail_out=0;var I=m.deflateInit2(this.strm,T.level,T.method,T.windowBits,T.memLevel,T.strategy);if(I!==b)throw new Error(C[I]);if(T.header&&m.deflateSetHeader(this.strm,T.header),T.dictionary){var A;if(A="string"==typeof T.dictionary?v.string2buf(T.dictionary):"[object ArrayBuffer]"===E.call(T.dictionary)?new Uint8Array(T.dictionary):T.dictionary,(I=m.deflateSetDictionary(this.strm,A))!==b)throw new Error(C[I]);this._dict_set=!0}}function deflate(g,m){var S=new Deflate(m);if(S.push(g,!0),S.err)throw S.msg||C[S.err];return S.result}function deflateRaw(g,m){return(m=m||{}).raw=!0,deflate(g,m)}function gzip(g,m){return(m=m||{}).gzip=!0,deflate(g,m)}Deflate.prototype.push=function(g,C){var _,P,M=this.strm,w=this.options.chunkSize;if(this.ended)return!1;P=C===~~C?C:!0===C?I:T,"string"==typeof g?M.input=v.string2buf(g):"[object ArrayBuffer]"===E.call(g)?M.input=new Uint8Array(g):M.input=g,M.next_in=0,M.avail_in=M.input.length;do{if(0===M.avail_out&&(M.output=new S.Buf8(w),M.next_out=0,M.avail_out=w),(_=m.deflate(M,P))!==A&&_!==b)return this.onEnd(_),this.ended=!0,!1;0!==M.avail_out&&(0!==M.avail_in||P!==I&&P!==R)||("string"===this.options.to?this.onData(v.buf2binstring(S.shrinkBuf(M.output,M.next_out))):this.onData(S.shrinkBuf(M.output,M.next_out)))}while((M.avail_in>0||0===M.avail_out)&&_!==A);return P===I?(_=m.deflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===b):P!==R||(this.onEnd(b),M.avail_out=0,!0)},Deflate.prototype.onData=function(g){this.chunks.push(g)},Deflate.prototype.onEnd=function(g){g===b&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=S.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},g.Deflate=Deflate,g.deflate=deflate,g.deflateRaw=deflateRaw,g.gzip=gzip}}),ge=__commonJS({"../node_modules/pako/lib/zlib/inffast.js"(g,m){var S=30,v=12;m.exports=function inflate_fast(g,m){var C,_,E,T,I,b,A,R,P,M,w,D,O,N,k,L,F,x,U,V,B,H,$,G,j;C=g.state,_=g.next_in,G=g.input,E=_+(g.avail_in-5),T=g.next_out,j=g.output,I=T-(m-g.avail_out),b=T+(g.avail_out-257),A=C.dmax,R=C.wsize,P=C.whave,M=C.wnext,w=C.window,D=C.hold,O=C.bits,N=C.lencode,k=C.distcode,L=(1<<C.lenbits)-1,F=(1<<C.distbits)-1;e:do{O<15&&(D+=G[_++]<<O,O+=8,D+=G[_++]<<O,O+=8),x=N[D&L];t:for(;;){if(D>>>=U=x>>>24,O-=U,0===(U=x>>>16&255))j[T++]=65535&x;else{if(!(16&U)){if(0==(64&U)){x=N[(65535&x)+(D&(1<<U)-1)];continue t}if(32&U){C.mode=v;break e}g.msg="invalid literal/length code",C.mode=S;break e}V=65535&x,(U&=15)&&(O<U&&(D+=G[_++]<<O,O+=8),V+=D&(1<<U)-1,D>>>=U,O-=U),O<15&&(D+=G[_++]<<O,O+=8,D+=G[_++]<<O,O+=8),x=k[D&F];i:for(;;){if(D>>>=U=x>>>24,O-=U,!(16&(U=x>>>16&255))){if(0==(64&U)){x=k[(65535&x)+(D&(1<<U)-1)];continue i}g.msg="invalid distance code",C.mode=S;break e}if(B=65535&x,O<(U&=15)&&(D+=G[_++]<<O,(O+=8)<U&&(D+=G[_++]<<O,O+=8)),(B+=D&(1<<U)-1)>A){g.msg="invalid distance too far back",C.mode=S;break e}if(D>>>=U,O-=U,B>(U=T-I)){if((U=B-U)>P&&C.sane){g.msg="invalid distance too far back",C.mode=S;break e}if(H=0,$=w,0===M){if(H+=R-U,U<V){V-=U;do{j[T++]=w[H++]}while(--U);H=T-B,$=j}}else if(M<U){if(H+=R+M-U,(U-=M)<V){V-=U;do{j[T++]=w[H++]}while(--U);if(H=0,M<V){V-=U=M;do{j[T++]=w[H++]}while(--U);H=T-B,$=j}}}else if(H+=M-U,U<V){V-=U;do{j[T++]=w[H++]}while(--U);H=T-B,$=j}for(;V>2;)j[T++]=$[H++],j[T++]=$[H++],j[T++]=$[H++],V-=3;V&&(j[T++]=$[H++],V>1&&(j[T++]=$[H++]))}else{H=T-B;do{j[T++]=j[H++],j[T++]=j[H++],j[T++]=j[H++],V-=3}while(V>2);V&&(j[T++]=j[H++],V>1&&(j[T++]=j[H++]))}break}}break}}while(_<E&&T<b);_-=V=O>>3,D&=(1<<(O-=V<<3))-1,g.next_in=_,g.next_out=T,g.avail_in=_<E?E-_+5:5-(_-E),g.avail_out=T<b?b-T+257:257-(T-b),C.hold=D,C.bits=O}}}),pe=__commonJS({"../node_modules/pako/lib/zlib/inftrees.js"(g,m){var S=re(),v=15,C=852,_=592,E=0,T=1,I=2,b=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],A=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],R=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],P=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];m.exports=function inflate_table(g,m,M,w,D,O,N,k){var L,F,x,U,V,B,H,$,G,j=k.bits,q=0,W=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=null,ie=0,ne=new S.Buf16(v+1),re=new S.Buf16(v+1),se=null,ae=0;for(q=0;q<=v;q++)ne[q]=0;for(W=0;W<w;W++)ne[m[M+W]]++;for(J=j,K=v;K>=1&&0===ne[K];K--);if(J>K&&(J=K),0===K)return D[O++]=20971520,D[O++]=20971520,k.bits=1,0;for(z=1;z<K&&0===ne[z];z++);for(J<z&&(J=z),X=1,q=1;q<=v;q++)if(X<<=1,(X-=ne[q])<0)return-1;if(X>0&&(g===E||1!==K))return-1;for(re[1]=0,q=1;q<v;q++)re[q+1]=re[q]+ne[q];for(W=0;W<w;W++)0!==m[M+W]&&(N[re[m[M+W]]++]=W);if(g===E?(te=se=N,B=19):g===T?(te=b,ie-=257,se=A,ae-=257,B=256):(te=R,se=P,B=-1),ee=0,W=0,q=z,V=O,Y=J,Q=0,x=-1,U=(Z=1<<J)-1,g===T&&Z>C||g===I&&Z>_)return 1;for(;;){H=q-Q,N[W]<B?($=0,G=N[W]):N[W]>B?($=se[ae+N[W]],G=te[ie+N[W]]):($=96,G=0),L=1<<q-Q,z=F=1<<Y;do{D[V+(ee>>Q)+(F-=L)]=H<<24|$<<16|G|0}while(0!==F);for(L=1<<q-1;ee&L;)L>>=1;if(0!==L?(ee&=L-1,ee+=L):ee=0,W++,0==--ne[q]){if(q===K)break;q=m[M+N[W]]}if(q>J&&(ee&U)!==x){for(0===Q&&(Q=J),V+=z,X=1<<(Y=q-Q);Y+Q<K&&!((X-=ne[Y+Q])<=0);)Y++,X<<=1;if(Z+=1<<Y,g===T&&Z>C||g===I&&Z>_)return 1;D[x=ee&U]=J<<24|Y<<16|V-O|0}}return 0!==ee&&(D[V+ee]=q-Q<<24|64<<16|0),k.bits=J,0}}}),me=__commonJS({"../node_modules/pako/lib/zlib/inflate.js"(g){var m=re(),S=ae(),v=oe(),C=ge(),_=pe(),E=0,T=1,I=2,b=4,A=5,R=6,P=0,M=1,w=2,D=-2,O=-3,N=-4,k=-5,L=8,F=1,x=2,U=3,V=4,B=5,H=6,$=7,G=8,j=9,q=10,W=11,z=12,K=13,J=14,Y=15,Q=16,X=17,Z=18,ee=19,te=20,ie=21,ne=22,se=23,le=24,ce=25,de=26,he=27,ue=28,me=29,fe=30,Se=31,ve=852,Ce=592,_e=15;function zswap32(g){return(g>>>24&255)+(g>>>8&65280)+((65280&g)<<8)+((255&g)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new m.Buf16(320),this.work=new m.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(g){var S;return g&&g.state?(S=g.state,g.total_in=g.total_out=S.total=0,g.msg="",S.wrap&&(g.adler=1&S.wrap),S.mode=F,S.last=0,S.havedict=0,S.dmax=32768,S.head=null,S.hold=0,S.bits=0,S.lencode=S.lendyn=new m.Buf32(ve),S.distcode=S.distdyn=new m.Buf32(Ce),S.sane=1,S.back=-1,P):D}function inflateReset(g){var m;return g&&g.state?((m=g.state).wsize=0,m.whave=0,m.wnext=0,inflateResetKeep(g)):D}function inflateReset2(g,m){var S,v;return g&&g.state?(v=g.state,m<0?(S=0,m=-m):(S=1+(m>>4),m<48&&(m&=15)),m&&(m<8||m>15)?D:(null!==v.window&&v.wbits!==m&&(v.window=null),v.wrap=S,v.wbits=m,inflateReset(g))):D}function inflateInit2(g,m){var S,v;return g?(v=new InflateState,g.state=v,v.window=null,(S=inflateReset2(g,m))!==P&&(g.state=null),S):D}function inflateInit(g){return inflateInit2(g,_e)}var ye,Ee,Te=!0;function fixedtables(g){if(Te){var S;for(ye=new m.Buf32(512),Ee=new m.Buf32(32),S=0;S<144;)g.lens[S++]=8;for(;S<256;)g.lens[S++]=9;for(;S<280;)g.lens[S++]=7;for(;S<288;)g.lens[S++]=8;for(_(T,g.lens,0,288,ye,0,g.work,{bits:9}),S=0;S<32;)g.lens[S++]=5;_(I,g.lens,0,32,Ee,0,g.work,{bits:5}),Te=!1}g.lencode=ye,g.lenbits=9,g.distcode=Ee,g.distbits=5}function updatewindow(g,S,v,C){var _,E=g.state;return null===E.window&&(E.wsize=1<<E.wbits,E.wnext=0,E.whave=0,E.window=new m.Buf8(E.wsize)),C>=E.wsize?(m.arraySet(E.window,S,v-E.wsize,E.wsize,0),E.wnext=0,E.whave=E.wsize):((_=E.wsize-E.wnext)>C&&(_=C),m.arraySet(E.window,S,v-C,_,E.wnext),(C-=_)?(m.arraySet(E.window,S,v-C,C,0),E.wnext=C,E.whave=E.wsize):(E.wnext+=_,E.wnext===E.wsize&&(E.wnext=0),E.whave<E.wsize&&(E.whave+=_))),0}function inflate3(g,re){var ae,oe,ge,pe,ve,Ce,_e,ye,Ee,Te,Ie,be,Ae,Re,Pe,Me,we,De,Oe,Ne,ke,Le,Fe,xe,Ue=0,Ve=new m.Buf8(4),Be=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!g||!g.state||!g.output||!g.input&&0!==g.avail_in)return D;(ae=g.state).mode===z&&(ae.mode=K),ve=g.next_out,ge=g.output,_e=g.avail_out,pe=g.next_in,oe=g.input,Ce=g.avail_in,ye=ae.hold,Ee=ae.bits,Te=Ce,Ie=_e,Le=P;e:for(;;)switch(ae.mode){case F:if(0===ae.wrap){ae.mode=K;break}for(;Ee<16;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(2&ae.wrap&&35615===ye){ae.check=0,Ve[0]=255&ye,Ve[1]=ye>>>8&255,ae.check=v(ae.check,Ve,2,0),ye=0,Ee=0,ae.mode=x;break}if(ae.flags=0,ae.head&&(ae.head.done=!1),!(1&ae.wrap)||(((255&ye)<<8)+(ye>>8))%31){g.msg="incorrect header check",ae.mode=fe;break}if((15&ye)!==L){g.msg="unknown compression method",ae.mode=fe;break}if(Ee-=4,ke=8+(15&(ye>>>=4)),0===ae.wbits)ae.wbits=ke;else if(ke>ae.wbits){g.msg="invalid window size",ae.mode=fe;break}ae.dmax=1<<ke,g.adler=ae.check=1,ae.mode=512&ye?q:z,ye=0,Ee=0;break;case x:for(;Ee<16;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(ae.flags=ye,(255&ae.flags)!==L){g.msg="unknown compression method",ae.mode=fe;break}if(57344&ae.flags){g.msg="unknown header flags set",ae.mode=fe;break}ae.head&&(ae.head.text=ye>>8&1),512&ae.flags&&(Ve[0]=255&ye,Ve[1]=ye>>>8&255,ae.check=v(ae.check,Ve,2,0)),ye=0,Ee=0,ae.mode=U;case U:for(;Ee<32;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ae.head&&(ae.head.time=ye),512&ae.flags&&(Ve[0]=255&ye,Ve[1]=ye>>>8&255,Ve[2]=ye>>>16&255,Ve[3]=ye>>>24&255,ae.check=v(ae.check,Ve,4,0)),ye=0,Ee=0,ae.mode=V;case V:for(;Ee<16;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ae.head&&(ae.head.xflags=255&ye,ae.head.os=ye>>8),512&ae.flags&&(Ve[0]=255&ye,Ve[1]=ye>>>8&255,ae.check=v(ae.check,Ve,2,0)),ye=0,Ee=0,ae.mode=B;case B:if(1024&ae.flags){for(;Ee<16;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ae.length=ye,ae.head&&(ae.head.extra_len=ye),512&ae.flags&&(Ve[0]=255&ye,Ve[1]=ye>>>8&255,ae.check=v(ae.check,Ve,2,0)),ye=0,Ee=0}else ae.head&&(ae.head.extra=null);ae.mode=H;case H:if(1024&ae.flags&&((be=ae.length)>Ce&&(be=Ce),be&&(ae.head&&(ke=ae.head.extra_len-ae.length,ae.head.extra||(ae.head.extra=new Array(ae.head.extra_len)),m.arraySet(ae.head.extra,oe,pe,be,ke)),512&ae.flags&&(ae.check=v(ae.check,oe,be,pe)),Ce-=be,pe+=be,ae.length-=be),ae.length))break e;ae.length=0,ae.mode=$;case $:if(2048&ae.flags){if(0===Ce)break e;be=0;do{ke=oe[pe+be++],ae.head&&ke&&ae.length<65536&&(ae.head.name+=String.fromCharCode(ke))}while(ke&&be<Ce);if(512&ae.flags&&(ae.check=v(ae.check,oe,be,pe)),Ce-=be,pe+=be,ke)break e}else ae.head&&(ae.head.name=null);ae.length=0,ae.mode=G;case G:if(4096&ae.flags){if(0===Ce)break e;be=0;do{ke=oe[pe+be++],ae.head&&ke&&ae.length<65536&&(ae.head.comment+=String.fromCharCode(ke))}while(ke&&be<Ce);if(512&ae.flags&&(ae.check=v(ae.check,oe,be,pe)),Ce-=be,pe+=be,ke)break e}else ae.head&&(ae.head.comment=null);ae.mode=j;case j:if(512&ae.flags){for(;Ee<16;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(ye!==(65535&ae.check)){g.msg="header crc mismatch",ae.mode=fe;break}ye=0,Ee=0}ae.head&&(ae.head.hcrc=ae.flags>>9&1,ae.head.done=!0),g.adler=ae.check=0,ae.mode=z;break;case q:for(;Ee<32;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}g.adler=ae.check=zswap32(ye),ye=0,Ee=0,ae.mode=W;case W:if(0===ae.havedict)return g.next_out=ve,g.avail_out=_e,g.next_in=pe,g.avail_in=Ce,ae.hold=ye,ae.bits=Ee,w;g.adler=ae.check=1,ae.mode=z;case z:if(re===A||re===R)break e;case K:if(ae.last){ye>>>=7&Ee,Ee-=7&Ee,ae.mode=he;break}for(;Ee<3;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}switch(ae.last=1&ye,Ee-=1,3&(ye>>>=1)){case 0:ae.mode=J;break;case 1:if(fixedtables(ae),ae.mode=te,re===R){ye>>>=2,Ee-=2;break e}break;case 2:ae.mode=X;break;case 3:g.msg="invalid block type",ae.mode=fe}ye>>>=2,Ee-=2;break;case J:for(ye>>>=7&Ee,Ee-=7&Ee;Ee<32;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if((65535&ye)!=(ye>>>16^65535)){g.msg="invalid stored block lengths",ae.mode=fe;break}if(ae.length=65535&ye,ye=0,Ee=0,ae.mode=Y,re===R)break e;case Y:ae.mode=Q;case Q:if(be=ae.length){if(be>Ce&&(be=Ce),be>_e&&(be=_e),0===be)break e;m.arraySet(ge,oe,pe,be,ve),Ce-=be,pe+=be,_e-=be,ve+=be,ae.length-=be;break}ae.mode=z;break;case X:for(;Ee<14;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(ae.nlen=257+(31&ye),ye>>>=5,Ee-=5,ae.ndist=1+(31&ye),ye>>>=5,Ee-=5,ae.ncode=4+(15&ye),ye>>>=4,Ee-=4,ae.nlen>286||ae.ndist>30){g.msg="too many length or distance symbols",ae.mode=fe;break}ae.have=0,ae.mode=Z;case Z:for(;ae.have<ae.ncode;){for(;Ee<3;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ae.lens[Be[ae.have++]]=7&ye,ye>>>=3,Ee-=3}for(;ae.have<19;)ae.lens[Be[ae.have++]]=0;if(ae.lencode=ae.lendyn,ae.lenbits=7,Fe={bits:ae.lenbits},Le=_(E,ae.lens,0,19,ae.lencode,0,ae.work,Fe),ae.lenbits=Fe.bits,Le){g.msg="invalid code lengths set",ae.mode=fe;break}ae.have=0,ae.mode=ee;case ee:for(;ae.have<ae.nlen+ae.ndist;){for(;Me=(Ue=ae.lencode[ye&(1<<ae.lenbits)-1])>>>16&255,we=65535&Ue,!((Pe=Ue>>>24)<=Ee);){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(we<16)ye>>>=Pe,Ee-=Pe,ae.lens[ae.have++]=we;else{if(16===we){for(xe=Pe+2;Ee<xe;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(ye>>>=Pe,Ee-=Pe,0===ae.have){g.msg="invalid bit length repeat",ae.mode=fe;break}ke=ae.lens[ae.have-1],be=3+(3&ye),ye>>>=2,Ee-=2}else if(17===we){for(xe=Pe+3;Ee<xe;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}Ee-=Pe,ke=0,be=3+(7&(ye>>>=Pe)),ye>>>=3,Ee-=3}else{for(xe=Pe+7;Ee<xe;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}Ee-=Pe,ke=0,be=11+(127&(ye>>>=Pe)),ye>>>=7,Ee-=7}if(ae.have+be>ae.nlen+ae.ndist){g.msg="invalid bit length repeat",ae.mode=fe;break}for(;be--;)ae.lens[ae.have++]=ke}}if(ae.mode===fe)break;if(0===ae.lens[256]){g.msg="invalid code -- missing end-of-block",ae.mode=fe;break}if(ae.lenbits=9,Fe={bits:ae.lenbits},Le=_(T,ae.lens,0,ae.nlen,ae.lencode,0,ae.work,Fe),ae.lenbits=Fe.bits,Le){g.msg="invalid literal/lengths set",ae.mode=fe;break}if(ae.distbits=6,ae.distcode=ae.distdyn,Fe={bits:ae.distbits},Le=_(I,ae.lens,ae.nlen,ae.ndist,ae.distcode,0,ae.work,Fe),ae.distbits=Fe.bits,Le){g.msg="invalid distances set",ae.mode=fe;break}if(ae.mode=te,re===R)break e;case te:ae.mode=ie;case ie:if(Ce>=6&&_e>=258){g.next_out=ve,g.avail_out=_e,g.next_in=pe,g.avail_in=Ce,ae.hold=ye,ae.bits=Ee,C(g,Ie),ve=g.next_out,ge=g.output,_e=g.avail_out,pe=g.next_in,oe=g.input,Ce=g.avail_in,ye=ae.hold,Ee=ae.bits,ae.mode===z&&(ae.back=-1);break}for(ae.back=0;Me=(Ue=ae.lencode[ye&(1<<ae.lenbits)-1])>>>16&255,we=65535&Ue,!((Pe=Ue>>>24)<=Ee);){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(Me&&0==(240&Me)){for(De=Pe,Oe=Me,Ne=we;Me=(Ue=ae.lencode[Ne+((ye&(1<<De+Oe)-1)>>De)])>>>16&255,we=65535&Ue,!(De+(Pe=Ue>>>24)<=Ee);){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ye>>>=De,Ee-=De,ae.back+=De}if(ye>>>=Pe,Ee-=Pe,ae.back+=Pe,ae.length=we,0===Me){ae.mode=de;break}if(32&Me){ae.back=-1,ae.mode=z;break}if(64&Me){g.msg="invalid literal/length code",ae.mode=fe;break}ae.extra=15&Me,ae.mode=ne;case ne:if(ae.extra){for(xe=ae.extra;Ee<xe;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ae.length+=ye&(1<<ae.extra)-1,ye>>>=ae.extra,Ee-=ae.extra,ae.back+=ae.extra}ae.was=ae.length,ae.mode=se;case se:for(;Me=(Ue=ae.distcode[ye&(1<<ae.distbits)-1])>>>16&255,we=65535&Ue,!((Pe=Ue>>>24)<=Ee);){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(0==(240&Me)){for(De=Pe,Oe=Me,Ne=we;Me=(Ue=ae.distcode[Ne+((ye&(1<<De+Oe)-1)>>De)])>>>16&255,we=65535&Ue,!(De+(Pe=Ue>>>24)<=Ee);){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ye>>>=De,Ee-=De,ae.back+=De}if(ye>>>=Pe,Ee-=Pe,ae.back+=Pe,64&Me){g.msg="invalid distance code",ae.mode=fe;break}ae.offset=we,ae.extra=15&Me,ae.mode=le;case le:if(ae.extra){for(xe=ae.extra;Ee<xe;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}ae.offset+=ye&(1<<ae.extra)-1,ye>>>=ae.extra,Ee-=ae.extra,ae.back+=ae.extra}if(ae.offset>ae.dmax){g.msg="invalid distance too far back",ae.mode=fe;break}ae.mode=ce;case ce:if(0===_e)break e;if(be=Ie-_e,ae.offset>be){if((be=ae.offset-be)>ae.whave&&ae.sane){g.msg="invalid distance too far back",ae.mode=fe;break}be>ae.wnext?(be-=ae.wnext,Ae=ae.wsize-be):Ae=ae.wnext-be,be>ae.length&&(be=ae.length),Re=ae.window}else Re=ge,Ae=ve-ae.offset,be=ae.length;be>_e&&(be=_e),_e-=be,ae.length-=be;do{ge[ve++]=Re[Ae++]}while(--be);0===ae.length&&(ae.mode=ie);break;case de:if(0===_e)break e;ge[ve++]=ae.length,_e--,ae.mode=ie;break;case he:if(ae.wrap){for(;Ee<32;){if(0===Ce)break e;Ce--,ye|=oe[pe++]<<Ee,Ee+=8}if(Ie-=_e,g.total_out+=Ie,ae.total+=Ie,Ie&&(g.adler=ae.check=ae.flags?v(ae.check,ge,Ie,ve-Ie):S(ae.check,ge,Ie,ve-Ie)),Ie=_e,(ae.flags?ye:zswap32(ye))!==ae.check){g.msg="incorrect data check",ae.mode=fe;break}ye=0,Ee=0}ae.mode=ue;case ue:if(ae.wrap&&ae.flags){for(;Ee<32;){if(0===Ce)break e;Ce--,ye+=oe[pe++]<<Ee,Ee+=8}if(ye!==(4294967295&ae.total)){g.msg="incorrect length check",ae.mode=fe;break}ye=0,Ee=0}ae.mode=me;case me:Le=M;break e;case fe:Le=O;break e;case Se:return N;default:return D}return g.next_out=ve,g.avail_out=_e,g.next_in=pe,g.avail_in=Ce,ae.hold=ye,ae.bits=Ee,(ae.wsize||Ie!==g.avail_out&&ae.mode<fe&&(ae.mode<he||re!==b))&&updatewindow(g,g.output,g.next_out,Ie-g.avail_out),Te-=g.avail_in,Ie-=g.avail_out,g.total_in+=Te,g.total_out+=Ie,ae.total+=Ie,ae.wrap&&Ie&&(g.adler=ae.check=ae.flags?v(ae.check,ge,Ie,g.next_out-Ie):S(ae.check,ge,Ie,g.next_out-Ie)),g.data_type=ae.bits+(ae.last?64:0)+(ae.mode===z?128:0)+(ae.mode===te||ae.mode===Y?256:0),(0===Te&&0===Ie||re===b)&&Le===P&&(Le=k),Le}function inflateEnd(g){if(!g||!g.state)return D;var m=g.state;return m.window&&(m.window=null),g.state=null,P}function inflateGetHeader(g,m){var S;return g&&g.state?0==(2&(S=g.state).wrap)?D:(S.head=m,m.done=!1,P):D}function inflateSetDictionary(g,m){var v,C=m.length;return g&&g.state?0!==(v=g.state).wrap&&v.mode!==W?D:v.mode===W&&S(1,m,C,0)!==v.check?O:updatewindow(g,m,C,C)?(v.mode=Se,N):(v.havedict=1,P):D}g.inflateReset=inflateReset,g.inflateReset2=inflateReset2,g.inflateResetKeep=inflateResetKeep,g.inflateInit=inflateInit,g.inflateInit2=inflateInit2,g.inflate=inflate3,g.inflateEnd=inflateEnd,g.inflateGetHeader=inflateGetHeader,g.inflateSetDictionary=inflateSetDictionary,g.inflateInfo="pako inflate (from Nodeca project)"}}),fe=__commonJS({"../node_modules/pako/lib/zlib/constants.js"(g,m){m.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}}}),Se=__commonJS({"../node_modules/pako/lib/zlib/gzheader.js"(g,m){function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}m.exports=GZheader}}),ve=__commonJS({"../node_modules/pako/lib/inflate.js"(g){var m=me(),S=re(),v=de(),C=fe(),_=le(),E=he(),T=Se(),I=Object.prototype.toString;function Inflate(g){if(!(this instanceof Inflate))return new Inflate(g);this.options=S.assign({chunkSize:16384,windowBits:0,to:""},g||{});var b=this.options;b.raw&&b.windowBits>=0&&b.windowBits<16&&(b.windowBits=-b.windowBits,0===b.windowBits&&(b.windowBits=-15)),!(b.windowBits>=0&&b.windowBits<16)||g&&g.windowBits||(b.windowBits+=32),b.windowBits>15&&b.windowBits<48&&0==(15&b.windowBits)&&(b.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new E,this.strm.avail_out=0;var A=m.inflateInit2(this.strm,b.windowBits);if(A!==C.Z_OK)throw new Error(_[A]);if(this.header=new T,m.inflateGetHeader(this.strm,this.header),b.dictionary&&("string"==typeof b.dictionary?b.dictionary=v.string2buf(b.dictionary):"[object ArrayBuffer]"===I.call(b.dictionary)&&(b.dictionary=new Uint8Array(b.dictionary)),b.raw&&(A=m.inflateSetDictionary(this.strm,b.dictionary))!==C.Z_OK))throw new Error(_[A])}function inflate3(g,m){var S=new Inflate(m);if(S.push(g,!0),S.err)throw S.msg||_[S.err];return S.result}function inflateRaw(g,m){return(m=m||{}).raw=!0,inflate3(g,m)}Inflate.prototype.push=function(g,_){var E,T,b,A,R,P=this.strm,M=this.options.chunkSize,w=this.options.dictionary,D=!1;if(this.ended)return!1;T=_===~~_?_:!0===_?C.Z_FINISH:C.Z_NO_FLUSH,"string"==typeof g?P.input=v.binstring2buf(g):"[object ArrayBuffer]"===I.call(g)?P.input=new Uint8Array(g):P.input=g,P.next_in=0,P.avail_in=P.input.length;do{if(0===P.avail_out&&(P.output=new S.Buf8(M),P.next_out=0,P.avail_out=M),(E=m.inflate(P,C.Z_NO_FLUSH))===C.Z_NEED_DICT&&w&&(E=m.inflateSetDictionary(this.strm,w)),E===C.Z_BUF_ERROR&&!0===D&&(E=C.Z_OK,D=!1),E!==C.Z_STREAM_END&&E!==C.Z_OK)return this.onEnd(E),this.ended=!0,!1;P.next_out&&(0!==P.avail_out&&E!==C.Z_STREAM_END&&(0!==P.avail_in||T!==C.Z_FINISH&&T!==C.Z_SYNC_FLUSH)||("string"===this.options.to?(b=v.utf8border(P.output,P.next_out),A=P.next_out-b,R=v.buf2string(P.output,b),P.next_out=A,P.avail_out=M-A,A&&S.arraySet(P.output,P.output,b,A,0),this.onData(R)):this.onData(S.shrinkBuf(P.output,P.next_out)))),0===P.avail_in&&0===P.avail_out&&(D=!0)}while((P.avail_in>0||0===P.avail_out)&&E!==C.Z_STREAM_END);return E===C.Z_STREAM_END&&(T=C.Z_FINISH),T===C.Z_FINISH?(E=m.inflateEnd(this.strm),this.onEnd(E),this.ended=!0,E===C.Z_OK):T!==C.Z_SYNC_FLUSH||(this.onEnd(C.Z_OK),P.avail_out=0,!0)},Inflate.prototype.onData=function(g){this.chunks.push(g)},Inflate.prototype.onEnd=function(g){g===C.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=S.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},g.Inflate=Inflate,g.inflate=inflate3,g.inflateRaw=inflateRaw,g.ungzip=inflate3}}),Ce=__commonJS({"../node_modules/pako/index.js"(g,m){var S={};(0,re().assign)(S,ue(),ve(),fe()),m.exports=S}}),_e=__commonJS({"../signaling-agent/node_modules/sdp-transform/lib/grammar.js"(g,m){var S=m.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\S*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(g){return g.encoding?"rtpmap:%d %s/%s/%s":g.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(g){return null!=g.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(g){return"rtcp-fb:"+("*"===g.payload?"%s":"%d")+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(g){return null!=g.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(g){return"extmap:%d"+(g.direction?"/%s":"%v")+(g["encrypt-uri"]?" %s":"%v")+" %s"+(g.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(g){return null!=g.sessionConfig?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(g){return null!=g.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(g){var m="candidate:%s %d %s %d %s %d typ %s";return m+=null!=g.raddr?" raddr %s rport %d":"%v%v",m+=null!=g.tcptype?" tcptype %s":"%v",null!=g.generation&&(m+=" generation %d"),m+=null!=g["network-id"]?" network-id %d":"%v",m+=null!=g["network-cost"]?" network-cost %d":"%v"}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(g){var m="candidate:%s %d %s %d %s %d typ %s";return m+=null!=g.raddr?" raddr %s rport %d":"%v%v",m+=null!=g.tcptype?" tcptype %s":"%v",null!=g.generation&&(m+=" generation %d"),m}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(g){var m="ssrc:%d";return null!=g.attribute&&(m+=" %s",null!=g.value&&(m+=":%s")),m}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(g){return null!=g.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(g){return g.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(g){return"imageattr:%s %s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(g){return"simulcast:%s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(g){return"ts-refclk:%s"+(null!=g.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(g){var m="mediaclk:";return m+=null!=g.id?"id=%s %s":"%v%s",m+=null!=g.mediaClockValue?"=%s":"",m+=null!=g.rateNumerator?" rate=%s":"",m+=null!=g.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(g){return"x-signaling-fb:"+("*"===g.payload?"%s":"%d")+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{name:"xDataProtocol",reg:/^x-data-protocol:\s?(.*)/,format:"x-data-protocol:%s"},{push:"invalid",names:["value"]}]};Object.keys(S).forEach((function(g){S[g].forEach((function(g){g.reg||(g.reg=/(.*)/),g.format||(g.format="%s")}))}))}}),ye=__commonJS({"../signaling-agent/node_modules/sdp-transform/lib/parser.js"(g){var toIntIfInt=function(g){return String(Number(g))===g?Number(g):g},attachProperties=function(g,m,S,v){if(v&&!S)m[v]=toIntIfInt(g[1]);else for(var C=0;C<S.length;C+=1)null!=g[C+1]&&(m[S[C]]=toIntIfInt(g[C+1]))},parseReg=function(g,m,S){var v=g.name&&g.names;g.push&&!m[g.push]?m[g.push]=[]:v&&!m[g.name]&&(m[g.name]={});var C=g.push?{}:v?m[g.name]:m;attachProperties(S.match(g.reg),C,g.names,g.name),g.push&&m[g.push].push(C)},m=_e(),S=RegExp.prototype.test.bind(/^([a-z])=(.*)/);g.parse=function(g){var v={},C=[],_=v;return g.split(/(\r\n|\r|\n)/).filter(S).forEach((function(g){var S=g[0],v=g.slice(2);"m"===S&&(C.push({rtp:[],fmtp:[]}),_=C[C.length-1]);for(var E=0;E<(m[S]||[]).length;E+=1){var T=m[S][E];if(T.reg.test(v))return parseReg(T,_,v)}})),v.media=C,v};var paramReducer=function(g,m){var S=m.split(/=(.+)/,2);return 2===S.length?g[S[0]]=toIntIfInt(S[1]):1===S.length&&m.length>1&&(g[S[0]]=void 0),g};g.parseParams=function(g){return g.split(/;\s?/).reduce(paramReducer,{})},g.parseFmtpConfig=g.parseParams,g.parsePayloads=function(g){return g.toString().split(" ").map(Number)},g.parseRemoteCandidates=function(g){for(var m=[],S=g.split(" ").map(toIntIfInt),v=0;v<S.length;v+=3)m.push({component:S[v],ip:S[v+1],port:S[v+2]});return m},g.parseImageAttributes=function(g){return g.split(" ").map((function(g){return g.substring(1,g.length-1).split(",").reduce(paramReducer,{})}))},g.parseSimulcastStreamList=function(g){return g.split(";").map((function(g){return g.split(",").map((function(g){var m,S=!1;return"~"!==g[0]?m=toIntIfInt(g):(m=toIntIfInt(g.substring(1,g.length)),S=!0),{scid:m,paused:S}}))}))}}}),Ee=__commonJS({"../signaling-agent/node_modules/sdp-transform/lib/writer.js"(g,m){var S=_e(),v=/%[sdv%]/g,format=function(g){var m=1,S=arguments,C=S.length;return g.replace(v,(function(g){if(m>=C)return g;var v=S[m];switch(m+=1,g){case"%%":return"%";case"%s":return String(v);case"%d":return Number(v);case"%v":return""}}))},makeLine=function(g,m,S){var v=[g+"="+(m.format instanceof Function?m.format(m.push?S:S[m.name]):m.format)];if(m.names)for(var C=0;C<m.names.length;C+=1){var _=m.names[C];m.name?v.push(S[m.name][_]):v.push(S[m.names[C]])}else v.push(S[m.name]);return format.apply(null,v)},C=["v","o","s","i","u","e","p","c","b","t","r","z","a"],_=["i","c","b","a"];m.exports=function(g,m){m=m||{},null==g.version&&(g.version=0),null==g.name&&(g.name=" "),g.media.forEach((function(g){null==g.payloads&&(g.payloads="")}));var v=m.outerOrder||C,E=m.innerOrder||_,T=[];return v.forEach((function(m){S[m].forEach((function(S){S.name in g&&null!=g[S.name]?T.push(makeLine(m,S,g)):S.push in g&&null!=g[S.push]&&g[S.push].forEach((function(g){T.push(makeLine(m,S,g))}))}))})),g.media.forEach((function(g){T.push(makeLine("m",S.m[0],g)),E.forEach((function(m){S[m].forEach((function(S){S.name in g&&null!=g[S.name]?T.push(makeLine(m,S,g)):S.push in g&&null!=g[S.push]&&g[S.push].forEach((function(g){T.push(makeLine(m,S,g))}))}))}))})),T.join("\r\n")+"\r\n"}}}),Te=__commonJS({"../signaling-agent/node_modules/sdp-transform/lib/index.js"(g){var m=ye(),S=Ee();g.write=S,g.parse=m.parse,g.parseParams=m.parseParams,g.parseFmtpConfig=m.parseFmtpConfig,g.parsePayloads=m.parsePayloads,g.parseRemoteCandidates=m.parseRemoteCandidates,g.parseImageAttributes=m.parseImageAttributes,g.parseSimulcastStreamList=m.parseSimulcastStreamList}}),Ie=__commonJS({"../skype-calling-utilities/dist/skype-calling-utilities.bundle.js"(g,m){!function webpackUniversalModuleDefinition(S,v){"object"==typeof g&&"object"==typeof m?m.exports=v(P):"object"==typeof g?g["skype-calling-utilities"]=v(P):S["skype-calling-utilities"]=v(S.lodash)}(window,(function(g){return function(){var m={826:function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.EventSourceImpl=void 0;var v=S(467),C=S(582),_=function(){function EventSourceImpl3(g){this.eventLogger=g,this.subscriptions=[]}return EventSourceImpl3.prototype.subscribe=function(g){return new E(this.subscriptions,g)},EventSourceImpl3.prototype.dispose=function(g){this.subscriptions=[]},EventSourceImpl3.prototype.raiseEvents=function(g){var m=this;this.subscriptions.slice().forEach((function(S){var v,_;try{void 0!==S.eventHandler&&g(S.eventHandler)}catch(g){null===(_=null===(v=m.eventLogger)||void 0===v?void 0:v.warn)||void 0===_||_.call(v,"Event handler exception caught!",(0,C.stringifyObject)(g))}}))},EventSourceImpl3}();m.EventSourceImpl=_;var E=function(){function EventSubscriptionImpl3(g,m){this.subscriptions=g,this.eventHandler=m,this.subscriptions.push(this)}return EventSubscriptionImpl3.prototype.dispose=function(){var g=this;(0,v.remove)(this.subscriptions,(function(m){return m===g})),this.eventHandler=void 0},EventSubscriptionImpl3}()},105:function(g,m,S){var v=this&&this.__extends||function(){var extendStatics=function(g,m){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)Object.prototype.hasOwnProperty.call(m,S)&&(g[S]=m[S])})(g,m)};return function(g,m){if("function"!=typeof m&&null!==m)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");function __(){this.constructor=g}extendStatics(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}}(),C=this&&this.__spreadArray||function(g,m,S){if(S||2===arguments.length)for(var v,C=0,_=m.length;C<_;C++)!v&&C in m||(v||(v=Array.prototype.slice.call(m,0,C)),v[C]=m[C]);return g.concat(v||Array.prototype.slice.call(m))};Object.defineProperty(m,"__esModule",{value:!0});var _=function(g){function ObservableBase3(m){return g.call(this,m)||this}return v(ObservableBase3,g),ObservableBase3.prototype.changed=function(g,m){return this.subscribe({changed:{skipEventConfig:m,handler:g},on:void 0})},ObservableBase3.prototype.on=function(g,m){return this.subscribe({changed:void 0,on:{name:String(g),handler:this._toEventCallback(m)}})},ObservableBase3.prototype.once=function(g,m,S){var v,C=this,onceSubscription=function(){for(var g=[],_=0;_<arguments.length;_++)g[_]=arguments[_];v.dispose(S),C._toEventCallback(m).apply(void 0,g)};return v=this.on(g,this._fromEventCallback(onceSubscription))},ObservableBase3.prototype.raiseChanged=function(g){var m=this;this.raiseEvents((function(S){if(S.changed){var v=S.changed,C=v.skipEventConfig,_=v.handler;!m.getShouldSkipChangedEvent(g,C)&&_()}}))},ObservableBase3.prototype.event=function(g){var m=this;return{raise:this._fromEventCallback((function(){for(var S=[],v=0;v<arguments.length;v++)S[v]=arguments[v];return m._raiseEventImpl.apply(m,C([String(g)],S,!1))}))}},ObservableBase3.prototype._raiseEventImpl=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];this.raiseEvents((function(S){var v;return S.on&&S.on.name===g&&(v=S.on).handler.apply(v,m)}))},ObservableBase3.prototype._toEventCallback=function(g){return g},ObservableBase3.prototype._fromEventCallback=function(g){return g},ObservableBase3.prototype.getShouldSkipChangedEvent=function(g,m){return(null==g?void 0:g.skipDominantSpeakerUpdatesOnCall)?!!(null==m?void 0:m.skipDominantSpeakerUpdatesOnCall):!!(null==g?void 0:g.skipParticipantsUpdatesOnCall)&&!!(null==m?void 0:m.skipParticipantsUpdatesOnCall)},ObservableBase3}(S(826).EventSourceImpl);m.default=_},869:function(g,m){var S;Object.defineProperty(m,"__esModule",{value:!0}),m.ScreenSharingControlProtocol=void 0,function(g){var m=7,S=3;function encodeMouseEvent(g){if(!g)return new Uint8Array(0);g.buttonType||(g.buttonType=0),g.xPos||(g.xPos=0),g.yPos||(g.yPos=0),g.wheelRotation||(g.wheelRotation=0);var S=new ArrayBuffer(m),v=new DataView(S),C=(3&g.type)<<0,_=(7&g.buttonType)<<2,E=(g.buttonDown?1:0)<<5,T=(g.wheelButtonDown?1:0)<<6,I=0;return v.setUint8(0,1),v.setUint8(1,C|_|E|T|I),v.setUint16(2,g.xPos,!0),v.setUint16(4,g.yPos,!0),v.setUint8(6,g.wheelRotation),new Uint8Array(S)}function encodeKeyboardEvent(g){var m=new ArrayBuffer(S),v=new DataView(m),C=(3&g.codeType)<<0,_=0,E=(g.keyUp?1:0)<<4,T=(g.repeat?1:0)<<5,I=0,b=0;return v.setUint8(0,0),v.setUint8(1,C|_|E|T|I|b),v.setUint8(2,g.code),new Uint8Array(m)}function decodeEventType(g){return g[0]}function decodeMouseEvent(g){if(1!==g[0]||g.length!==m)return null;var S=new DataView(g.buffer),v=S.getUint8(1);return{type:3&v,buttonType:v>>2&7,buttonDown:!!(v>>5&1),wheelButtonDown:!!(v>>6&1),xPos:S.getUint16(2,!0),yPos:S.getUint16(4,!0),wheelRotation:S.getUint8(6)}}function decodeKeyboardEvent(g){if(0!==g[0]||g.length!==S)return null;var m=new DataView(g.buffer),v=m.getUint8(1);return{codeType:3&v,code:m.getUint8(2),repeat:!!(v>>5&1),keyUp:!!(v>>4&1)}}g.encodeMouseEvent=encodeMouseEvent,g.encodeKeyboardEvent=encodeKeyboardEvent,g.decodeEventType=decodeEventType,g.decodeMouseEvent=decodeMouseEvent,g.decodeKeyboardEvent=decodeKeyboardEvent}(S||(m.ScreenSharingControlProtocol=S={}))},582:function(g,m){function getRandomizedTimeout2(g){var m=Math.floor(11*Math.random())+10;return Math.floor(g*(1-m/100))}function isStringBase642(g){if(!g)return!1;try{return atob(g),!0}catch(g){return!1}}function isPromiseLike2(g){return!!g&&"function"==typeof g.then}function stringifyObject2(g){if(!g)return"".concat(g);if(g instanceof Map)return mapToString2(g);var m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}function mapToString2(g){var m={};return g.forEach((function(g,S){m[S.toString()]=g})),JSON.stringify(m)}function stringToBuffer2(g){for(var m=new ArrayBuffer(g.length),S=new Uint8Array(m),v=0;v<g.length;v++)S[v]=g.charCodeAt(v);return S}Object.defineProperty(m,"__esModule",{value:!0}),m.stringToBuffer=m.stringifyObject=m.isPromiseLike=m.isStringBase64=m.getRandomizedTimeout=void 0,m.getRandomizedTimeout=getRandomizedTimeout2,m.isStringBase64=isStringBase642,m.isPromiseLike=isPromiseLike2,m.stringifyObject=stringifyObject2,m.stringToBuffer=stringToBuffer2},289:function(g,m,S){var v=this&&this.__extends||function(){var extendStatics=function(g,m){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)Object.prototype.hasOwnProperty.call(m,S)&&(g[S]=m[S])})(g,m)};return function(g,m){if("function"!=typeof m&&null!==m)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");function __(){this.constructor=g}extendStatics(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}}();Object.defineProperty(m,"__esModule",{value:!0}),m.SlimCoreElectronControlCapturer=void 0;var C=S(105),_=S(869),E=65535,T=3e3,I=250,b=18,A=17,R=16,P=91,M=50,w=30,D=function(g){function SlimCoreElectronControlCapturer3(m,S,v,C){var _,E;void 0===v&&(v=!0),void 0===C&&(C=1);var T=g.call(this)||this;return T._logger=m,T._element=S,T._captureRegionPreserveAspectRatio=v,T._mouseMoveCount=0,T._mouseMoveStartTime=0,T._isMouseDown=!1,T._isMouseOnRenderer=!1,T._captureMode=0,T._pollTimerID=0,T._resizeTimerID=0,T._mouseMoveThrottlingEnabled=!1,T._handleResizeEvents=function(){clearTimeout(T._resizeTimerID),T._resizeTimerID=window.setTimeout((function(){T.updateCaptureRegion()}),I)},T._handleMouseLeave=function(g){!T._isOnScreenContent(g)&&T._isMouseOnRenderer&&(T._raiseCaptureEvent(2),T._logger.info("Mouse leaving render region")),T._isMouseOnRenderer=!1},T._handleMouseEnter=function(g){T._isOnScreenContent(g)&&(T._isMouseOnRenderer=!0,T._raiseCaptureEvent(1),T._logger.info("Mouse entering render region"))},T._handleLosingFocus=function(){T._syncKeyStates(!0)},T._handleClick=function(g){T._isOnScreenContent(g)&&(T._raiseCaptureEvent(0),T._logger.info("Mouse clicked"))},T._handleMouseMove=function(g){if(!T._isOnScreenContent(g)&&T._isMouseOnRenderer)return T._raiseCaptureEvent(2),T._isMouseOnRenderer=!1,void T._logger.info("Mouse leaving render region");if(T._isOnScreenContent(g)&&!T._isMouseOnRenderer&&(T._raiseCaptureEvent(1),T._isMouseOnRenderer=!0,T._logger.info("Mouse entering render region")),2===T._captureMode||3===T._captureMode){if(T._mouseMoveCount++,T._mouseMoveThrottlingEnabled){if(!T._isOnScreenContent(g)||!T._shouldMoveMouse())return}else if(!T._isOnScreenContent(g)||T._mouseMoveCount%2==0)return;var m={type:0};T._normalizeMousePosition(g,m),T._raiseMouseEvent(m)}},T._handleMouseDown=function(g){if((2===T._captureMode||3===T._captureMode)&&T._isOnScreenContent(g)){var m={type:2,buttonType:convertButton(g.button),buttonDown:!0};T._isMouseDown=!0,T._normalizeMousePosition(g,m),T._raiseMouseEvent(m)}},T._handleMouseUp=function(g){if((2===T._captureMode||3===T._captureMode)&&T._isOnScreenContent(g)){var m={type:2,buttonType:convertButton(g.button),buttonDown:!1};T._isMouseDown=!1,T._normalizeMousePosition(g,m),T._raiseMouseEvent(m)}},T._handleKeyDown=function(g){T._raiseKeyboardEvent({codeType:1,code:g.keyCode,repeat:g.repeat,keyUp:!1}),g.stopPropagation(),g.preventDefault()},T._handleKeyUp=function(g){T._raiseKeyboardEvent({codeType:1,code:g.keyCode,repeat:g.repeat,keyUp:!0}),g.stopPropagation(),g.preventDefault()},T._handleWheel=function(g){T._raiseMouseEvent({type:1,wheelRotation:g.deltaY>0?-120:120})},T._handleContextMenu=function(g){g.preventDefault()},T._ensureCanReceiveKeyboardInput(),null===(E=null===(_=T._element.ownerDocument)||void 0===_?void 0:_.defaultView)||void 0===E||E.addEventListener("resize",T._handleResizeEvents,!1),T._captureRegion={left:0,top:0,width:T._element.clientWidth,height:T._element.clientHeight},T._videoSize={width:Math.floor(S.clientHeight*C),height:S.clientHeight},T._origElementSize={width:0,height:0},T._checkElementSize(),T._mouseMoveStartTime=new Date(0).getTime(),T}return v(SlimCoreElectronControlCapturer3,g),Object.defineProperty(SlimCoreElectronControlCapturer3.prototype,"captureMode",{get:function(){return this._captureMode},enumerable:!1,configurable:!0}),Object.defineProperty(SlimCoreElectronControlCapturer3.prototype,"captureRegion",{get:function(){return this._captureRegion},enumerable:!1,configurable:!0}),SlimCoreElectronControlCapturer3.prototype.setMouseMoveThrottlingFeatureFlag=function(g){this._mouseMoveThrottlingEnabled=g},SlimCoreElectronControlCapturer3.prototype.dispose=function(m){var S,v;this._logger.info("dispose causeId: ".concat(m)),window.clearTimeout(this._pollTimerID),null===(v=null===(S=this._element.ownerDocument)||void 0===S?void 0:S.defaultView)||void 0===v||v.removeEventListener("resize",this._handleResizeEvents,!1),g.prototype.dispose.call(this,m)},SlimCoreElectronControlCapturer3.prototype.updateVideoSize=function(g,m){this._videoSize.width=g,this._videoSize.height=m,this.updateCaptureRegion()},SlimCoreElectronControlCapturer3.prototype.updateCaptureRegion=function(){this._captureRegionPreserveAspectRatio?(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientWidth*this._videoSize.height/this._videoSize.width,this._captureRegion.height>this._element.clientHeight?(this._captureRegion.width=this._element.clientHeight*this._videoSize.width/this._videoSize.height,this._captureRegion.height=this._element.clientHeight,this._captureRegion.left=(this._element.clientWidth-this._captureRegion.width)/2,this._captureRegion.top=0):(this._captureRegion.left=0,this._captureRegion.top=(this._element.clientHeight-this._captureRegion.height)/2)):(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientHeight,this._captureRegion.top=0,this._captureRegion.left=0)},SlimCoreElectronControlCapturer3.prototype.setCaptureMode=function(g){3===this._captureMode&&3!==g&&this._syncKeyStates(!0),this._captureMode=g,0!==g?("none"===this._element.style.pointerEvents&&this._logger.warn("Element pointer-events is 'none', event handlers will not work"),this._element.addEventListener("click",this._handleClick),this._element.addEventListener("pointermove",this._handleMouseMove),this._element.addEventListener("pointerdown",this._handleMouseDown),this._element.addEventListener("pointerup",this._handleMouseUp),this._element.addEventListener("pointerenter",this._handleMouseEnter),this._element.addEventListener("pointerleave",this._handleMouseLeave),3===g?(this._element.addEventListener("wheel",this._handleWheel),this._element.addEventListener("keydown",this._handleKeyDown),this._element.addEventListener("keyup",this._handleKeyUp),this._element.addEventListener("contextmenu",this._handleContextMenu),this._element.addEventListener("blur",this._handleLosingFocus)):(this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))):(this._element.removeEventListener("pointermove",this._handleMouseMove),this._element.removeEventListener("pointerdown",this._handleMouseDown),this._element.removeEventListener("pointerup",this._handleMouseUp),this._element.removeEventListener("pointerenter",this._handleMouseEnter),this._element.removeEventListener("pointerleave",this._handleMouseLeave),this._element.removeEventListener("click",this._handleClick),this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))},SlimCoreElectronControlCapturer3.prototype._ensureCanReceiveKeyboardInput=function(){this._element.tabIndex=this._element.tabIndex},SlimCoreElectronControlCapturer3.prototype._checkElementSize=function(){var g=this;this._origElementSize.width===this._element.clientWidth&&this._origElementSize.height===this._element.clientHeight||(this.updateCaptureRegion(),this._origElementSize.width=this._element.clientWidth,this._origElementSize.height=this._element.clientHeight),this._pollTimerID=window.setTimeout((function(){g._checkElementSize()}),T)},SlimCoreElectronControlCapturer3.prototype._raiseMouseEvent=function(g){this.event("mouseControlEvent").raise(g)},SlimCoreElectronControlCapturer3.prototype._raiseKeyboardEvent=function(g){this.event("keyboardControlEvent").raise(g)},SlimCoreElectronControlCapturer3.prototype._raiseCaptureEvent=function(g){this.event("ctrlCaptureEvent").raise(g)},SlimCoreElectronControlCapturer3.prototype._normalizeMousePosition=function(g,m){m.xPos=(g.offsetX-this._captureRegion.left)/this._captureRegion.width*E,m.yPos=(g.offsetY-this._captureRegion.top)/this._captureRegion.height*E},SlimCoreElectronControlCapturer3.prototype._isOnScreenContent=function(g){var m=this._captureRegion.left,S=this._captureRegion.left+this._captureRegion.width,v=this._captureRegion.top,C=this._captureRegion.top+this._captureRegion.height;return m<=g.offsetX&&g.offsetX<S&&v<=g.offsetY&&g.offsetY<C},SlimCoreElectronControlCapturer3.prototype._shouldMoveMouse=function(){if(this._mouseMoveStartTime){var g=(new Date).getTime(),m=g-this._mouseMoveStartTime;if(this._isMouseDown&&m>=w||!this._isMouseDown&&m>=M)return this._mouseMoveStartTime=g,!0}else this._mouseMoveStartTime=(new Date).getTime();return!1},SlimCoreElectronControlCapturer3.prototype._syncKeyStates=function(g){this._raiseKeyboardEvent({codeType:1,code:A,repeat:!1,keyUp:g}),this._raiseKeyboardEvent({codeType:1,code:R,repeat:!1,keyUp:g}),this._raiseKeyboardEvent({codeType:1,code:b,repeat:!1,keyUp:g}),this._raiseKeyboardEvent({codeType:1,code:P,repeat:!1,keyUp:g}),this._logger.info("Synced Key states.")},SlimCoreElectronControlCapturer3.formatMouseEvent=function(g){return _.ScreenSharingControlProtocol.encodeMouseEvent(g)},SlimCoreElectronControlCapturer3.formatKeyboardEvent=function(g){return _.ScreenSharingControlProtocol.encodeKeyboardEvent(g)},SlimCoreElectronControlCapturer3}(C.default);function convertButton(g){switch(g){case 0:return 0;case 2:return 1;case 1:return 2;default:return}}m.SlimCoreElectronControlCapturer=D},467:function(m){m.exports=g}},S={};function __webpack_require__(g){var v=S[g];if(void 0!==v)return v.exports;var C=S[g]={exports:{}};return m[g].call(C.exports,C,C.exports,__webpack_require__),C.exports}return __webpack_require__(289)}()}))}}),be=__commonJS({"../node_modules/synctasks/dist/SyncTasks.js"(g){function fromThenable(g){var m=Defer();return g.then((function(g){m.resolve(g)}),(function(g){m.reject(g)})),m.promise().thenAsync((function(g){return g}))}function isThenable(g){return null!=g&&"function"==typeof g.then}function isCancelable(g){return null!=g&&"function"==typeof g.cancel}function run(m,S){if(!g.config.catchExceptions)return m();try{return m()}catch(g){return S(g)}}Object.defineProperty(g,"__esModule",{value:!0}),g.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(g){throw g}},g.fromThenable=fromThenable;var m,S,v,C=[],_="undefined"!=typeof setImmediate;function asyncCallback(g){C.push(g),1===C.length&&(_?setImmediate(resolveAsyncCallbacks):setTimeout(resolveAsyncCallbacks,0))}function resolveAsyncCallbacks(){var g=C;C=[];for(var m=0;m<g.length;m++)g[m]()}function all(g){if(0===g.length)return Resolved2([]);var S,v=Defer(),C=g.length,_=Array(g.length);v.onCancel((function(S){g.forEach((function(g){isCancelable(g)&&m.SyncTask.cancelOtherInternal(g,S)}))}));var checkFinish=function(){0==--C&&(void 0!==S?v.reject(S):v.resolve(_))};return g.forEach((function(g,m){isThenable(g)?g.then((function(g){_[m]=g,checkFinish()}),(function(g){void 0===S&&(S=void 0===g||g),checkFinish()})):(_[m]=g,checkFinish())})),v.promise()}function Defer(){return new m.SyncTask}function Resolved2(g){return(new m.SyncTask).resolve(g).promise()}function Rejected(g){return(new m.SyncTask).reject(g).promise()}function race(g){var S=Defer(),v=!1;return S.onCancel((function(S){g.forEach((function(g){isCancelable(g)&&m.SyncTask.cancelOtherInternal(g,S)}))})),g.forEach((function(g){isThenable(g)?g.then((function(g){v||(v=!0,S.resolve(g))}),(function(g){v||(v=!0,S.reject(g))})):v||(v=!0,S.resolve(g))})),S.promise()}function raceTimer(g,m){var S=Defer(),v=setTimeout((function(){S.resolve({timedOut:!0})}),m);return race([g.then((function(g){return clearTimeout(v),{timedOut:!1,result:g}})),S.promise()])}g.asyncCallback=asyncCallback,S=m||(m={}),v=function(){function SyncTask2(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return SyncTask2.prototype._addCallbackSet=function(g,m){var S=this,v=new SyncTask2;return v.onCancel((function(m){g.wasCanceled=!0,g.cancelContext=m,S._cancelInternal(m)})),g.task=v,this._storedCallbackSets.push(g),m?this._mustHandleError=!1:v._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),v.promise()},SyncTask2.prototype.onCancel=function(g){return this._completedSuccess||this._completedFail||(this._wasCanceled?g(this._cancelContext):this._cancelCallbacks.push(g)),this},SyncTask2.prototype.then=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m},!0)},SyncTask2.prototype.thenAsync=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m,asyncCallback:!0},!0)},SyncTask2.prototype.catch=function(g){return this._addCallbackSet({failFunc:g},!0)},SyncTask2.prototype.always=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!0)},SyncTask2.prototype.setTracingEnabled=function(g){return this._traceEnabled=g,this},SyncTask2.prototype.finally=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!1),this},SyncTask2.prototype.done=function(g){return this._addCallbackSet({successFunc:g},!1),this},SyncTask2.prototype.fail=function(g){return this._addCallbackSet({failFunc:g},!1),this},SyncTask2.prototype.resolve=function(g){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=g,this._cancelCallbacks=[],this._resolveSuccesses(),this},SyncTask2.prototype.reject=function(g){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=g,this._cancelCallbacks=[],this._resolveFailures(),SyncTask2._enforceErrorHandled(this),this},SyncTask2.prototype._checkState=function(m){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var S="Failed to "+(m?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(S)}(g.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},SyncTask2._enforceErrorHandled=function(m){m._mustHandleError&&(SyncTask2._rejectedTasks.push(m),SyncTask2._enforceErrorHandledTimer||(SyncTask2._enforceErrorHandledTimer=setTimeout((function(){SyncTask2._enforceErrorHandledTimer=void 0;var m=SyncTask2._rejectedTasks;SyncTask2._rejectedTasks=[],m.forEach((function(m,S){m._mustHandleError&&g.config.unhandledErrorHandler(m._storedErrResolution)}))}),0)))},SyncTask2.prototype.cancel=function(g){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(g)},SyncTask2.prototype._cancelInternal=function(g){var m=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=g;var S=this._cancelCallbacks;this._cancelCallbacks=[],S.length>0&&S.forEach((function(g){m._completedSuccess||m._completedFail||g(m._cancelContext)}))}},SyncTask2.cancelOtherInternal=function(g,m){var S=g;S._storedCallbackSets&&S._cancelInternal?S._cancelInternal(m):g.cancel(m)},SyncTask2.prototype.promise=function(){return this},SyncTask2.prototype._resolveSuccesses=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveSuccessCallback(m)})):g._resolveSuccessCallback(m)}))}this._resolving=!1},SyncTask2.prototype._resolveSuccessCallback=function(g){var m=this;g.successFunc?run((function(){var S=g.successFunc(m._storedResolution);isCancelable(S)&&(g.wasCanceled?SyncTask2.cancelOtherInternal(S,g.cancelContext):g.task.onCancel((function(g){return SyncTask2.cancelOtherInternal(S,g)}))),isThenable(S)?S.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(S)}),(function(S){m._handleException(S,"SyncTask caught exception in success block: "+S.toString()),g.task.reject(S)})):g.task.resolve(this._storedResolution)},SyncTask2.prototype._resolveFailures=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveFailureCallback(m)})):g._resolveFailureCallback(m)}))}this._resolving=!1},SyncTask2.prototype._resolveFailureCallback=function(g){var m=this;g.failFunc?run((function(){var S=g.failFunc(m._storedErrResolution);isCancelable(S)&&(g.wasCanceled?SyncTask2.cancelOtherInternal(S,g.cancelContext):g.task.onCancel((function(g){return SyncTask2.cancelOtherInternal(S,g)}))),isThenable(S)?S.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(S)}),(function(S){m._handleException(S,"SyncTask caught exception in failure block: "+S.toString()),g.task.reject(S)})):g.task.reject(this._storedErrResolution)},SyncTask2.prototype._handleException=function(m,S){g.config.exceptionsToConsole&&console.error(S),g.config.exceptionHandler&&g.config.exceptionHandler(m)},SyncTask2.prototype.toEs6Promise=function(){var g=this;return new Promise((function(m,S){return g.then(m,S)}))},SyncTask2._rejectedTasks=[],SyncTask2}(),S.SyncTask=v,g.all=all,g.Defer=Defer,g.Resolved=Resolved2,g.Rejected=Rejected,g.race=race,g.raceTimer=raceTimer}}),Ae=__commonJS({"../node_modules/sdp-transform/lib/grammar.js"(g,m){var S=m.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\S*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(g){return g.encoding?"rtpmap:%d %s/%s/%s":g.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(g){return null!=g.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(g){return"rtcp-fb:"+("*"===g.payload?"%s":"%d")+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(g){return null!=g.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(g){return"extmap:%d"+(g.direction?"/%s":"%v")+(g["encrypt-uri"]?" %s":"%v")+" %s"+(g.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(g){return null!=g.sessionConfig?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(g){return null!=g.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(g){var m="candidate:%s %d %s %d %s %d typ %s";return m+=null!=g.raddr?" raddr %s rport %d":"%v%v",m+=null!=g.tcptype?" tcptype %s":"%v",null!=g.generation&&(m+=" generation %d"),m+=null!=g["network-id"]?" network-id %d":"%v",m+=null!=g["network-cost"]?" network-cost %d":"%v"}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(g){var m="candidate:%s %d %s %d %s %d typ %s";return m+=null!=g.raddr?" raddr %s rport %d":"%v%v",m+=null!=g.tcptype?" tcptype %s":"%v",null!=g.generation&&(m+=" generation %d"),m}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(g){var m="ssrc:%d";return null!=g.attribute&&(m+=" %s",null!=g.value&&(m+=":%s")),m}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(g){return null!=g.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(g){return g.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(g){return"imageattr:%s %s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(g){return"simulcast:%s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(g){return"ts-refclk:%s"+(null!=g.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(g){var m="mediaclk:";return m+=null!=g.id?"id=%s %s":"%v%s",m+=null!=g.mediaClockValue?"=%s":"",m+=null!=g.rateNumerator?" rate=%s":"",m+=null!=g.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(g){return"x-signaling-fb:"+("*"===g.payload?"%s":"%d")+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{name:"xDataProtocol",reg:/^x-data-protocol:\s?(.*)/,format:"x-data-protocol:%s"},{name:"xMultiStream",reg:/^x-multi-stream:(\d*) (\d*) (\d*) (\d*)/,names:["numberOfStreams","startSsrc","ssrcRange","ssrcGroupRange"],format:"x-multi-stream:%d %d %d %d"},{push:"invalid",names:["value"]}]};Object.keys(S).forEach((function(g){S[g].forEach((function(g){g.reg||(g.reg=/(.*)/),g.format||(g.format="%s")}))}))}}),Re=__commonJS({"../node_modules/sdp-transform/lib/parser.js"(g){var toIntIfInt=function(g){return String(Number(g))===g?Number(g):g},attachProperties=function(g,m,S,v){if(v&&!S)m[v]=toIntIfInt(g[1]);else for(var C=0;C<S.length;C+=1)null!=g[C+1]&&(m[S[C]]=toIntIfInt(g[C+1]))},parseReg=function(g,m,S){var v=g.name&&g.names;g.push&&!m[g.push]?m[g.push]=[]:v&&!m[g.name]&&(m[g.name]={});var C=g.push?{}:v?m[g.name]:m;attachProperties(S.match(g.reg),C,g.names,g.name),g.push&&m[g.push].push(C)},m=Ae(),S=RegExp.prototype.test.bind(/^([a-z])=(.*)/);g.parse=function(g){var v={},C=[],_=v;return g.split(/(\r\n|\r|\n)/).filter(S).forEach((function(g){var S=g[0],v=g.slice(2);"m"===S&&(C.push({rtp:[],fmtp:[]}),_=C[C.length-1]);for(var E=0;E<(m[S]||[]).length;E+=1){var T=m[S][E];if(T.reg.test(v))return parseReg(T,_,v)}})),v.media=C,v};var paramReducer=function(g,m){var S=m.split(/=(.+)/,2);return 2===S.length?g[S[0]]=toIntIfInt(S[1]):1===S.length&&m.length>1&&(g[S[0]]=void 0),g};g.parseParams=function(g){return g.split(/;\s?/).reduce(paramReducer,{})},g.parseFmtpConfig=g.parseParams,g.parsePayloads=function(g){return g.toString().split(" ").map(Number)},g.parseRemoteCandidates=function(g){for(var m=[],S=g.split(" ").map(toIntIfInt),v=0;v<S.length;v+=3)m.push({component:S[v],ip:S[v+1],port:S[v+2]});return m},g.parseImageAttributes=function(g){return g.split(" ").map((function(g){return g.substring(1,g.length-1).split(",").reduce(paramReducer,{})}))},g.parseSimulcastStreamList=function(g){return g.split(";").map((function(g){return g.split(",").map((function(g){var m,S=!1;return"~"!==g[0]?m=toIntIfInt(g):(m=toIntIfInt(g.substring(1,g.length)),S=!0),{scid:m,paused:S}}))}))}}}),Pe=__commonJS({"../node_modules/sdp-transform/lib/writer.js"(g,m){var S=Ae(),v=/%[sdv%]/g,format=function(g){var m=1,S=arguments,C=S.length;return g.replace(v,(function(g){if(m>=C)return g;var v=S[m];switch(m+=1,g){case"%%":return"%";case"%s":return String(v);case"%d":return Number(v);case"%v":return""}}))},makeLine=function(g,m,S){var v=[g+"="+(m.format instanceof Function?m.format(m.push?S:S[m.name]):m.format)];if(m.names)for(var C=0;C<m.names.length;C+=1){var _=m.names[C];m.name?v.push(S[m.name][_]):v.push(S[m.names[C]])}else v.push(S[m.name]);return format.apply(null,v)},C=["v","o","s","i","u","e","p","c","b","t","r","z","a"],_=["i","c","b","a"];m.exports=function(g,m){m=m||{},null==g.version&&(g.version=0),null==g.name&&(g.name=" "),g.media.forEach((function(g){null==g.payloads&&(g.payloads="")}));var v=m.outerOrder||C,E=m.innerOrder||_,T=[];return v.forEach((function(m){S[m].forEach((function(S){S.name in g&&null!=g[S.name]?T.push(makeLine(m,S,g)):S.push in g&&null!=g[S.push]&&g[S.push].forEach((function(g){T.push(makeLine(m,S,g))}))}))})),g.media.forEach((function(g){T.push(makeLine("m",S.m[0],g)),E.forEach((function(m){S[m].forEach((function(S){S.name in g&&null!=g[S.name]?T.push(makeLine(m,S,g)):S.push in g&&null!=g[S.push]&&g[S.push].forEach((function(g){T.push(makeLine(m,S,g))}))}))}))})),T.join("\r\n")+"\r\n"}}}),Me=__commonJS({"../node_modules/sdp-transform/lib/index.js"(g){var m=Re(),S=Pe();g.write=S,g.parse=m.parse,g.parseParams=m.parseParams,g.parseFmtpConfig=m.parseFmtpConfig,g.parsePayloads=m.parsePayloads,g.parseRemoteCandidates=m.parseRemoteCandidates,g.parseImageAttributes=m.parseImageAttributes,g.parseSimulcastStreamList=m.parseSimulcastStreamList}}),we={};__export(we,{HttpRequestDispatcherImplementation:()=>Ue,generateCauseId:()=>generateCauseId,getOvb:()=>getOvb,getVersion:()=>getTsCallingVersion,pluginlessStackFactory:()=>ZT}),C.exports=__toCommonJS(we);var De=__toESM(te()),Oe=8;function generateCauseId(){const g="abcdef0123456789",m=g.length;let S="";for(let v=0;v<Oe;v++)S+=g.charAt(Math.floor(Math.random()*m));return S}function validateCauseId(g){return new RegExp("^[a-f0-9]{8}$").test(g)&&g.length===Oe}var Ne=R,ke=P,Le=class _TsCallingLogger{constructor(g,m,S=""){this.ulLogComponent=g,this.ulSafeComponent=m,this._getPrefix=(0,ke.isFunction)(S)?S:()=>S,this.logComponent=Ne.LogFactory.instance().component(this.ulLogComponent),Ne.LogFactory.instance().declareComponentSafe(this.ulLogComponent,m)}createChild(g){const m=(0,ke.isFunction)(g)?g:()=>g;return new _TsCallingLogger(this.ulLogComponent,this.ulSafeComponent,(()=>this._getPrefix()?`${this._getPrefix()}/${m()}`:m()))}log(...g){this._apply((g=>this.logComponent.debug2(null,g)),g)}debug(...g){this._apply((g=>this.logComponent.debug4(null,g)),g)}info(...g){this._apply((g=>this.logComponent.debug1(null,g)),g)}warn(...g){this._apply((g=>this.logComponent.warn(null,g)),g)}error(...g){this._apply((g=>this.logComponent.error(null,g)),g)}_apply(g,m=[]){this._addPrefix(m);g(m.map((g=>g instanceof DOMException?g.toString():g)).map((g=>(0,ke.isObject)(g)?JSON.stringify(g):g)).join(", "))}_addPrefix(g){if(g&&g[0]){const m=`${this._getPrefix()} ${g[0]}`;g[0]=m}}},Fe=R;function scrubMriOrOmit(g){return"string"==typeof g?Fe.pii.Mri(g):Fe.pii.Omit(g)}function scrubMriOrOmitList(g){return g.forEach(scrubMriOrOmit)}function mriOrId(g){return g&&Fe.pii.Mri(g)}function getLoggableThreadId(g){const m=_scrubThreadId(g);return m&&m.substr(0,8)}function _scrubThreadId(g){const m="99:";return g&&g.substr(0,3)===m?Fe.pii.Omit(g):g}var xe=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","phrase","subCode","reason"];function getPIISafeObject(g){try{return JSON.parse(JSON.stringify(g,xe,4))}catch(g){return{error:"failed to parse object"}}}var processStackTrace=g=>{try{return g.split("\n")[0]}catch(g){return"invalid stack"}};function getPrintableObject(g,m=!1){if(null==g)return"void";if(g instanceof Error)return g.toString();if(g instanceof String||g instanceof Number||g instanceof Boolean)return g.toString();try{return g.stack&&(g.stack=processStackTrace(g.stack)),(m?JSON.stringify(g):JSON.stringify(g,xe,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(m){return`failed to get error information:${g&&"function"==typeof g.toString&&g.toString()} ${g?.response&&JSON.stringify(g.response)}`}}function safeJsonStringify(g){try{return JSON.stringify(g,null,2)}catch(m){return`failed to stringify obj ${g}`}}function truncate(g,m){try{return g.substring(0,length)}catch(m){return g}}function hasValue(g){return g||!1===g||""===g||0===g}function getPIISafeCallInitOptions(g){const m={mediaPeerType:g.mediaPeerType,threadId:getLoggableThreadId(g.threadId)};return hasValue(g.messageId)&&(m.messageId=g.messageId),hasValue(g.enableGroupCallMeetupGeneration)&&(m.enableGroupCallMeetupGeneration=g.enableGroupCallMeetupGeneration),hasValue(g.endpointMetadata)&&(m.endpointMetadata=g.endpointMetadata),hasValue(g.onBehalfOf)&&(m.onBehalfOf=scrubMriOrOmit(g.onBehalfOf)),hasValue(g.onBehalfOfUserDisplayName)&&(m.onBehalfOfUserDisplayName=g.onBehalfOfUserDisplayName),hasValue(g.emergencyContent)&&(m.emergencyContent=g.emergencyContent),hasValue(g.isEmergency)&&(m.isEmergency=g.isEmergency),hasValue(g.broadcastContext)&&(m.broadcastContext=g.broadcastContext),g.meetingInfo&&(m.meetingInfo={tenantId:g.meetingInfo.tenantId,organizerId:scrubMriOrOmit(g.meetingInfo.organizerId)},hasValue(g.meetingInfo.meetingType)&&(m.meetingInfo.meetingType=g.meetingInfo.meetingType),hasValue(g.meetingInfo.replyChainMessageId)&&(m.meetingInfo.replyChainMessageId=g.meetingInfo.replyChainMessageId)),g.transferContext&&(m.transferContext={transferorMri:scrubMriOrOmit(g.transferContext.transferorMri),targetMri:scrubMriOrOmit(g.transferContext.targetMri),context:g.transferContext.context},hasValue(g.transferContext.transferType)&&(m.transferContext.transferType=g.transferContext.transferType)),m}function getRandomizedTimeout(g){const m=Math.floor(11*Math.random())+10;return Math.floor(g*(1-m/100))}function isStringBase64(g){if(!g)return!1;try{return atob(g),!0}catch(g){return!1}}function isPromiseLike(g){return!!g&&"function"==typeof g.then}function stringifyObject(g){if(!g)return`${g}`;if(g instanceof Map)return mapToString(g);const m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}function mapToString(g){const m={};return g.forEach(((g,S)=>{m[S.toString()]=g})),JSON.stringify(m)}function stringToBuffer(g){const m=new ArrayBuffer(g.length),S=new Uint8Array(m);for(let m=0;m<g.length;m++)S[m]=g.charCodeAt(m);return S}var Ue=class{constructor(g){g&&"function"==typeof g.createChild?this.logger=g.createChild("RequestDispatcher"):this.logger=new Le("JS.TsCalling.RequestDispatcher",!1)}getRequestOptions(g,m,S,v,C){return{headers:m||{},timeout:v,payload:S||null,responseType:C}}getAsync(g,m){return this.sendRequest(g,m,"GET")}postAsync(g,m){return this.sendRequest(g,m,"POST")}putAsync(g,m){return this.sendRequest(g,m,"PUT")}removeAsync(g,m){return this.sendRequest(g,m,"DELETE")}async sendRequest(g,m={headers:{}},S){const v=this.logger.createChild(`[${m.causeId||generateCauseId()}][Request]`);v.info(`sending, ${S}-${g}`);const C=Date.now();let _;m.headers=m.headers||{},m.headers["content-type"]||(m.headers["content-type"]=m.contentType||"application/json");try{const E=De.default.request({url:g,method:S,headers:m.headers||{},timeout:"number"==typeof m.timeout?m.timeout:45e3,data:m.payload||"",responseType:m.responseType||m.dataType||"json",withCredentials:valueOrDefault(m.withCredentials,!1),cancelToken:new De.default.CancelToken((g=>{_=g}))});isPromiseLike(m.timeout)&&m.timeout.then((()=>{v.info("Aborting pending request"),_()}),(()=>{v.info("Timeout promise rejected, ignoring")}));const T=await E;return v.info(`success, status=${T.status}`),{response:T.data,request:T.request,duration:Date.now()-C}}catch(g){if(v.info("failed"),De.default.isCancel(g))throw v.info(`response=${safeJsonStringify(g.response)}`),{aborted:!0};throw g.response?v.info(`response=${safeJsonStringify(g.response)}`):g.request?v.info(`no response, request=${safeJsonStringify(g.request)}`):v.info(`request not made, error=${safeJsonStringify(g)}`),g||new Error("Request failed")}}};function valueOrDefault(g,m){return void 0!==g?g:m}var Ve=P,Be=P,He=class{constructor(g){this.eventLogger=g,this.subscriptions=[]}subscribe(g){return new $e(this.subscriptions,g)}dispose(g){this.subscriptions=[]}raiseEvents(g){this.subscriptions.slice().forEach((m=>{try{void 0!==m.eventHandler&&g(m.eventHandler)}catch(g){this.eventLogger?.warn?.("Event handler exception caught!",stringifyObject(g))}}))}},$e=class{constructor(g,m){this.subscriptions=g,this.eventHandler=m,this.subscriptions.push(this)}dispose(){(0,Be.remove)(this.subscriptions,(g=>g===this)),this.eventHandler=void 0}},Ge=class extends He{constructor(g){super(g)}changed(g,m){return this.subscribe({changed:{skipEventConfig:m,handler:g},on:void 0})}on(g,m){return this.subscribe({changed:void 0,on:{name:String(g),handler:this._toEventCallback(m)}})}once(g,m,S){let v;const onceSubscription=(...g)=>{v.dispose(S),this._toEventCallback(m)(...g)};return v=this.on(g,this._fromEventCallback(onceSubscription)),v}raiseChanged(g){this.raiseEvents((m=>{if(!m.changed)return;const{skipEventConfig:S,handler:v}=m.changed;!this.getShouldSkipChangedEvent(g,S)&&v()}))}event(g){return{raise:this._fromEventCallback(((...m)=>this._raiseEventImpl(String(g),...m)))}}_raiseEventImpl(g,...m){this.raiseEvents((S=>S.on&&S.on.name===g&&S.on.handler(...m)))}_toEventCallback(g){return g}_fromEventCallback(g){return g}getShouldSkipChangedEvent(g,m){return g?.skipDominantSpeakerUpdatesOnCall?!!m?.skipDominantSpeakerUpdatesOnCall:!!g?.skipParticipantsUpdatesOnCall&&!!m?.skipParticipantsUpdatesOnCall}},je=Ge,qe="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",We="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",ze="http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00",Ke={MEDIA_STATE:{send:"sendonly",receive:"recvonly",sendReceive:"sendrecv",inactive:"inactive"},MEDIA_DIRECTION:{SEND:"send",RECV:"recv"},MEDIA_DEVICE_KIND:{audioInput:"audioinput",audioOutput:"audiooutput",videoInput:"videoinput",compositeAudio:"compositeAudio",virtualDevice:"virtualDevice"},MEDIA_DEVICE:{camera:"camera",microphone:"microphone",speaker:"speaker",compositeAudio:"compositeAudio",defaultId:"default",communicationsId:"communications",defaultDeviceLabel:"Default",audioIngestDevice:"audioIngestDevice",virtualDevice:"virtualDevice"},MEDIA_ERROR:{constraintNotSatisfiedError:"ConstraintNotSatisfiedError",iceConnectionError:"iceConnectionError",srtpError:"srtpError",permissionDeniedError:"permissionDeniedError",internalError:"internalError",sourceUnavailableError:"SourceUnavailableError",devicesNotFoundError:"DevicesNotFoundError",noDeviceSelected:"noDeviceSelected",noNetworkError:"noNetworkError",incompatibleOffer:"IncompatibleOffer",mediaStreamRequestError:"MediaStreamRequestError",extensionNotFoundError:"ExtensionNotFoundError",sharingCancelledError:"SharingCancelledError",permissionDeniedBySystemError:"PermissionsDeniedBySystem",chromeRuntimeNotDefinedError:"ChromeRuntimeNotDefinedError",mediaStreamRequestTimedOut:"MediaStreamRequestTimedout",unsupportedStream:"UnsupportedStream",webGlRendererError:"WebGlRendererError",audioPlaybackError:"audioPlaybackError",unexpectedClose:"unexpectedClose",incompatibleOriginator:"incompatibleOriginator"},HISTOGRAM_BATCH:{seconds1to3:2,seconds3to5:4,seconds5to8:7,seconds8to15:14,seconds15to60:59,seconds60toMax:1e6},RENEGOTIATION_ERROR:{local:"local",glare:"glare",signaling:"signaling",media:"media",escalation:"escalation"},MSI:{unsubscribe:-1,subscribeAny:-2},MEDIA_LABEL:{audio:"main-audio",video:"main-video",sharing:"applicationsharing-video",data:"data"},MEDIA_TYPE:{audio:"audio",video:"video",sharing:"sharing",data:"x-data",dataChannel:"application"},MODALITY:{audio:"audio",video:"video",sharing:"sharing",data:"data"},TRACK_KIND:{audio:"audio",video:"video"},ICE_TRANSPORT_POLICY:{all:"all",relay:"relay"},RENDERER_TYPE:{video:"video",sharing:"sharing"},CONTENT_TYPE:{SDP:"application/sdp"},ALLOWED_CONTENT_TYPES:{SDP_ONLY:["application/sdp"],SDP_NGC:["application/sdp","application/sdp-ngc-0.5","application/sdp-ngc-1.0"]},STREAMING_STATE:{created:"created",started:"started",active:"active",inactive:"inactive",stopped:"stopped",removed:"removed",failed:"failed"},TIME_INTERVAL:{SEC_1:1},DISPLAY_SOURCE_ID:"display",EMPTY_DEVICE_ID:"0",SYSTEM_AUDIO_SOURCE_ID:"system",MULTIPLE_RECV_STREAMS:"multipleVideoStreams",PROFILES:{udpTlsRtpSavpf:"UDP/TLS/RTP/SAVPF",rtpSavpf:"RTP/SAVPF",rtpSavp:"RTP/SAVP",udpDtlsSctp:"UDP/DTLS/SCTP"},REPORTING_PROFILE:{RT_PROFILE:"REAL_TIME",BE_PROFILE:"BEST_EFFORT",NRT_PROFILE:"NEAR_REAL_TIME"},PAYLOAD_TYPE:{DATA_CHANNEL:"webrtc-datachannel",X_DATA:"127 126",MSRTC_RED:97,MSRTC_CNFB:120},VIDEO_CAPABILITIES:{MAX_FS_PATH:"max-fs",MAX_MBPS_PATH:"max-mbps",MAX_FPS_PATH:"max-fps",MAX_BR_PATH:"max-br",SSRC_PATH:"ssrc",RID_PATH:"rid",KEYFRAME_PATH:"KeyFrame",MAX_WIDTH:"max-width",MAX_HEIGHT:"max-height",VLA_DEBUG:"vla-debug"},TRANSPORT_CC:{EXT_URI:qe,MSSDP_ENCODED_URI:qe.replace(/\//g,"\\"),ATTRIBUTE:"transport-cc"},ABS_SEND_TIME:{EXT_URI:We,MSSDP_ENCODED_URI:We.replace(/\//g,"\\")},VLA:{EXT_URI:ze,EXT_URI_NON_ADV:ze+"-non-advertised",DEFAULT_VALUE:10},AUDIO_DECODER:{MUCHv2:{CODEC:{NAME:"x-much2",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:113},SatinFB:{CODEC:{NAME:"SATINFB",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:109}},MACROBLOCK_SIZE:16,MEDIA_EVENT_FIELDS:{Extensions:["IceConnectionState","IceConnectionStatePrevious","SignalingState","SignalingStatePrevious"],metrics:["ReconnectInProgress","IceConnectedStateTime","ErrorType","ErrorDetail","InitialNegotiationType","InitialNegotiationCompleted"]},RES_TABLE:{SEND:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:416,h:234,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}],RECV:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:426,h:240,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}]}};function forOwn(g,m){for(const S in g)g.hasOwnProperty(S)&&m(g[S],S)}function forOwnRec(g,m){for(const S in g)g.hasOwnProperty(S)&&("object"==typeof g[S]?forOwnRec(g[S],m):m(g[S],S,g))}function isDefined(g){return null!=g&&!Number.isNaN(g)}function getMinDefined(g,m){return isDefined(m)?isDefined(g)?Math.min(g,m):m:g}function average(g){let m=0;return g.forEach((g=>m+=g)),m/=g.length,m}function remove2(g,m){let S=!1;for(let v=g.length;v-- >0;)m(g[v],v,g)&&(g.splice(v,1),S=!0);return S}function compareArraysBy(g,m,S){const v=[];return g.forEach((g=>{m.some((m=>S(g,m)))||v.push(g)})),0===v.length&&g.length===m.length}function values(g){const m=[];for(const S in g)g.hasOwnProperty(S)&&m.push(g[S]);return m}function assign(g,m){for(const S in m)m.hasOwnProperty(S)&&(g[S]=m[S])}function isEmpty(g){return!Object.keys(g).length}function keys(g){return Object.keys(g)}function shallowClone(g){const m={};return forOwn(g,((g,S)=>{m[S]=g})),m}function deepClone(g){let m;if(!g||"object"!=typeof g)return g;if(g instanceof Date)return m=new Date,m.setTime(g.getTime()),m;if(g instanceof Array){m=[];for(let S=0,v=g.length;S<v;S++)m[S]=deepClone(g[S]);return m}if(g instanceof Object)return m={},forOwn(g,(function(g,S){m[S]=deepClone(g)})),m;throw new Error("Unable to copy: "+stringifyObject(g))}function removeUndefinedFields(g){return Object.keys(g).forEach((m=>{void 0===g[m]&&delete g[m]})),g}function uniqueId(){const segment=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return segment()+segment()+segment()+"4"+segment().substring(1)+"b"+segment().substring(1)+segment()+segment()+segment()}function deepEqual(g,m){let S;const v=typeof g;if(g===m)return!0;if(v!==typeof m||"object"!==v&&"function"!==v)return!1;if(null===g||null===m)return g===m;if(g instanceof Date&&m instanceof Date)return+g==+m;if(g instanceof Map&&m instanceof Map)return compareMaps(g,m);for(S in g)if(!(S in m)||!deepEqual(g[S],m[S]))return!1;for(S in m)if(!(S in g)||!deepEqual(g[S],m[S]))return!1;return!0}function compareMaps(g,m){let S;if(g.size!==m.size)return!1;let v=!0;return g.forEach(((g,C)=>{S=m.get(C),(S!==g||void 0===S&&!m.has(C))&&(v=!1)})),v}function getMaxSubstring(g,m){return m.reduce(((m,S)=>{const v=g.includes(S)?S.length:0;return m.length<v?S:m}),"")}function throwIfNotSupported(g,m){if(-1===m.indexOf(g))throw{detail:`${g} mediaContent.contentType is not supported`,type:Ke.MEDIA_ERROR.incompatibleOffer}}function throwIfFeatureNotSupported(g,m){g.forEach((g=>{if(""!==g&&-1!==m.findIndex((m=>m===g)))throw{detail:`Required feature '${g}' is not acceptable.`,type:Ke.MEDIA_ERROR.incompatibleOffer}}))}function getClosestValue(g,m,S,v=0){for(let C=1;C<g.length;C++)if(g[C-1]+v<m&&m<=g[C]+v)return S?g[C]:g[C-1];return g[0]}function isInRange(g,m,S){return m<=g&&g<=S}function getFrom(g,...m){for(const S of m)if(S.hasOwnProperty(g))return S[g]}function subtractFrom(g,m){return g.filter((g=>!m.some((m=>m===g))))}function getLongestCommonContiguousSubstring(g,m){if(g===m)return g;let S=0,v=0,C="";for(let _=0;_<g.length&&!(C.length>g.length-_);_++){let E=_;v-S>C.length&&(C=g.substring(S,v),_=v-1),S=_,v=_;for(let T=0;T<m.length;T++)E<g.length&&m[T]===g[E++]?v=E:(E=_,v-S>C.length&&(C=g.substring(S,v),_=v-1),S=_,v=_)}return C}function levenshteinDistance(g,m){const S=new Array(g.length+1);for(let v=0;v<g.length+1;v++){S[v]=new Array(m.length+1);for(let g=0;g<m.length+1;g++)S[v][g]=0}for(let m=1;m<g.length+1;m++)S[m][0]=m;for(let g=1;g<m.length+1;g++)S[0][g]=g;for(let v=1;v<g.length+1;v++)for(let C=1;C<m.length+1;C++){let _=1;g[v-1]===m[C-1]&&(_=0),S[v][C]=Math.min(S[v-1][C]+1,S[v][C-1]+1,S[v-1][C-1]+_)}return S[g.length][m.length]}function getAverage(g){return 0===g.length?0:g.reduce(((g,m)=>g+m),0)/g.length}function round(g,m=3){return g&&parseFloat(g.toFixed(m))}function scrubDeviceLabelPii(g,m){if(!g)return"";if(g.length<3)return g;const S=[],v=g.match(/\(([0-9a-zA-Z]+:[0-9a-zA-Z]+)\)/);v&&S.push(v[1]);try{if(m?.length){const v=new RegExp(`(${m.join("|")})`,"gi");let C=v.exec(g);for(;C;)S.push(C[1]),C=v.exec(g)}else S.push("no_keywords")}catch(g){S.push(`Error: ${stringifyObject(g)}`)}return 0===S.length?"unknown":S.join(" ")}function limitArraySize(g,m,S=0){return g&&void 0!==m&&m>-1&&g.length>m&&g.splice(S,g.length-m),g}function arrayLimitedPush(g,m,S,v=0){limitArraySize(g,0===S?0:S-1,v),0!==S&&g.push(m)}function addGetterFields(g,m){const S={};for(const g in m)S[g]={get:m[g],configurable:!1,enumerable:!0};Object.defineProperties(g,S)}function getLast(g){return g?.length>0?g[g.length-1]:void 0}var Je=window?.performance?.now&&window?.performance?.timeOrigin?()=>window.performance.now():()=>Date.now();function rebaseTime(g,m,S){if(g?.length>0){const v=[];for(const C of g){const g=deepClone(C);g[m]=g[m]&&g[m]-S,v.push(g)}return v}return g}function rebaseHistogramTimestamps(g,m){if(!g)return;const S={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]};for(const[v,C]of Object.entries(g))for(const g of C)S[v].push(g-m);return S}function sampleseries(g,m,S=!1){const v=g?.map(m).filter((g=>void 0!==g&&!isNaN(g)&&null!==g&&""!==g&&(!1===S||0!==g)));return v?.length?v.join(","):void 0}function sampleseriesArr(g,m,S){const v=g?.map(m).filter((g=>void 0!==g&&!isNaN(g)&&null!==g&&""!==g)).splice(-S);return v?.length?v:void 0}function clearObj(g,m){const S=[];for(const v of Object.keys(g))m.has(v)||S.push(v);for(const m of S)delete g[m]}function clearMap(g,m){const S=[];for(const v of g.keys())m.has(v)||S.push(v);for(const m of S)g.delete(m)}function convertContextProperty(g){return"object"==typeof g?stringifyObject(g):g}function getPercentilesProviderFromSampleFreqs(g){const m=Object.keys(g).map(Number).sort(((g,m)=>g-m)),S=m.reduce(((m,S)=>m+(g[S]??0)),0);return{getPercentile:v=>{const C=S*v;let _=0;for(const S of m)if(_+=g[S],_>=C)return S}}}var Ye=P,Qe={numVideoChannelsGvc:({current:g,constraints:m})=>getMaxIncomingStreams(g,m),specCompliantSimulcast:({current:g,constraints:m})=>getMaxSimulcastLayers(g,m),multiviewResolutionLimits:({current:g,constraints:m,logger:S})=>getMaxParticipantResolutions(g,m,S),enableVla:({current:g,settings:m,constraints:S,settingsSuffix:v})=>getVlaEnabledStatus(g,m,S,v),allowRemoteVla:({current:g,settings:m,constraints:S,settingsSuffix:v})=>getVlaEnabledStatus(g,m,S,v),enableNonAdvVla:({current:g,settings:m,constraints:S,settingsSuffix:v})=>getVlaEnabledStatus(g,m,S,v),outgoingVideoLimit:({current:g,constraints:m})=>getOutgoingVideoLimit(g,m)},convertCallConstraintsToSettings=(g,m,S)=>({...buildSettings(g,m,S),...buildSettings(g,m,S,"1on1"),...buildSettings(g,m,S,"Multiparty")}),buildSettings=(g,m,S,v)=>{const C={};for(const _ of Object.keys(Qe)){const E=`${_}${v??""}`;v&&!isDefined(m[E])||(C[E]=Qe[_]({current:m[E],settings:m,constraints:S,settingsSuffix:v,logger:g}))}return C},getMaxIncomingStreams=(g,m)=>getMinDefined(g,m.maxIncomingStreams),getMaxParticipantResolutions=(g,m,S)=>{const v=m.maxParticipantResolutions;if(!v)return g;const C={more:g.more};if(Number.isInteger(v))Object.keys(g).forEach((m=>{C[m]=getMinDefined(v,g[m])}));else{const m=Object.keys(v);if(!m.length)return S.warn(`ignoring invalid value provided for maxParticipantResolutions: ${v}}`),g;m.forEach((m=>{C[m]=getMinDefined(v[m],g[m]||g.more)}))}return C},getMaxSimulcastLayers=(g,m)=>void 0!==m.maxSimulcastLayers||g.allowOverride?{...g,video:getConstrainedSimulcastConfig(g.video,m),sharing:getConstrainedSimulcastConfig(g.sharing,m)}:g,getConstrainedSimulcastConfig=(g,m)=>{const S=g?.layerScaleFactors?.filter((g=>g<=m.maxSimulcastLayers));return S?.length>1?{...g,layerScaleFactors:S}:{...g,enableLocally:!1,allowEnableRemotely:!1}},getOutgoingVideoLimit=(g,m)=>{const{outgoingVideoLimit:S,maxOutgoingResolution:v}=m,C=(0,Ye.isNumber)(S),_=getMinDefined(C?S:S?.maxResolution,v),E=getMinDefined(g?.maxResolution,_),T=getMinDefined(g?.maxBitrate,C?void 0:S?.maxBitrate),I=getMinDefined(g?.maxFramerate,C?void 0:S?.maxFramerate);return{...g,maxResolution:E,maxBitrate:T,maxFramerate:I}},getVlaEnabledStatus=(g,m,S,v)=>!((m.specCompliantSimulcast.constraintsDisableVla||m[`specCompliantSimulcast${v}`]?.constraintsDisableVla)&&S.maxSimulcastLayers<2)&&g,Xe=class extends je{constructor(g){super(g),this.logger=g,this._constraints={},this._callConstraintsTelemetry=[]}get constraints(){return this._constraints}get callConstraintsTelemetry(){return this._callConstraintsTelemetry}addCallConstraintsTelemetryEvent(g,m){const S={timestamp:(new Date).getTime(),type:m,value:g};this._callConstraintsTelemetry.push(S)}setConstraints(g){this.logger.debug("Setting new platform call constraints",JSON.stringify(g)),this._constraints=g,this.addCallConstraintsTelemetryEvent(g,"requested"),this.raiseChanged()}getSettings(g){return convertCallConstraintsToSettings(this.logger,g,this._constraints)}},Ze=class _InternalLogger{constructor(g){this._callingLogger=g,this._maybeLog=(g,...m)=>{try{this._callingLogger[g](...m)}catch(g){this._callingLogger.info("[failed to log]",getPrintableObject(g))}}}getPrefix(g,m){let S="";return m&&(S+=`[${m}]`),g&&(S+=`[${g}]`),S}createChild(g,m){return new _InternalLogger(this._callingLogger.createChild(g,m))}createFnLogger(g,m,...S){return new _InternalLogger(this._callingLogger.createChild(this.getPrefix(g,m)+S.join(""),!1))}logSuccess(g){this._maybeLog("info",`success=${g}}`)}logFailure(g){const m=getPrintableObject(g);this._maybeLog("info",`failed=${m}}`)}log(...g){this._maybeLog("log",...g)}debug(...g){this._maybeLog("debug",...g)}info(...g){this._maybeLog("info",...g)}warn(...g){this._maybeLog("warn",...g)}error(...g){this._maybeLog("error",...g)}};function getTsCallingVersion(){return"2024.08.01.25"}function getOvb(){return"d50d43eab56aa05fd87acc4728c2461e484a7983"}var et=P,tt="0.0";function getBrowserVersion(g,m){let S=[];if(m.some((m=>(S=g.match(m),!!S))),!S||S.length<2)return tt;const v=S[1]?.replace(/_/g,".");return v||tt}function getFormFactor(g){const m="136";if(getOsSkuInfo()===m)return"Hololens";if(/hostAudio-Processing/i.test(g))return"RoomAudioProcessing";return/iPhone|iPad|iPod|Android|Mobi/i.test(g)?"Mobile":"Desktop"}function getOsSkuInfo(){const g="os-sku",m=window.external;return m?.getHostEnvironmentValue?JSON.parse(m.getHostEnvironmentValue(g))[g]:"-1"}function getBrowserInfo(){const g="((\\d+\\.?){2,4})",m={name:"Unknown",engine:"Unknown",version:tt,formFactor:"Unknown"},S=[{name:"WebView2",engine:"Chromium",key:"maglev",masks:[new RegExp(`maglev/${g}`)]},{name:"Edge",engine:"Edge",key:"Edge",masks:[new RegExp(`Edge/${g}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"EdgA",masks:[new RegExp(`Chrome/${g}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"Edg",masks:[new RegExp(`Edg/${g}`)]},{name:"Chromium",engine:"Chromium",key:"Chromium",masks:[new RegExp(`Chromium/${g}`)]},{name:"Opera",engine:"Chromium",key:"OPR",masks:[new RegExp(`Chrome/${g}`)]},{name:"YandexBrowser",engine:"Chromium",key:"YaBrowser",masks:[new RegExp(`Chrome/${g}`)]},{name:"Electron",engine:"Chromium",key:"Electron",masks:[new RegExp(`Electron/${g}`)]},{name:"CiscoOS",engine:"Chromium",key:"Cisco",masks:[new RegExp(`Chrome/${g}`)]},{name:"ZoomRoom",engine:"Chromium",key:"ZoomRoom",masks:[new RegExp(`Chrome/${g}`)]},{name:"SamsungTV",engine:"Chromium",key:"TeamsSamsungTVBrowser",masks:[new RegExp(`Chrome/${g}`)]},{name:"Chrome",engine:"Chromium",key:"Chrome",masks:[new RegExp(`Chrome/${g}`)]},{name:"Firefox",engine:"Firefox",key:"Firefox",masks:[new RegExp(`Firefox/${g}`)]},{name:"Safari",engine:"Safari",key:"Safari",masks:[new RegExp(`Version/${g}.*?Safari/`)]},{name:"AppleWebView",engine:"Safari",key:"Mac OS X",masks:[new RegExp("(\\d+_\\d+(_\\d+)?).*Mac OS X"),new RegExp("(\\d+_\\d+(_\\d+)?).*")]},{name:"MSIE",engine:"MSIE",key:"Trident",masks:[new RegExp(`MSIE ${g}`),new RegExp(`rv:${g}`)]}],v=navigator.userAgent;let C=m;return S.some((g=>{if(-1!==v.indexOf(g.key)){const m=window.navigator.mediaDevices?.isRemote;return C={name:g.name,engine:m?"ChromiumAVD":g.engine,version:getBrowserVersion(v,g.masks),formFactor:getFormFactor(v)},!0}return!1})),C}var it={src:["//amp.azure.net/libs/amp/2.3.8.4/azuremediaplayer.min.js","https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.js"],css:["https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.css","https://statics.teams.cdn.office.net/evergreen-assets/broadcast/video-player.css?v=2"],styles:["azuremediaplayer","amp-stream-skin","amp-big-play-centered"],lang:"en-us",disableFullscreenButton:!1,playerType:0},nt={src:["https://azuremdncdnhlsendpoint.azureedge.net/hlsjsv115/hls.js","https://vzmdncdnendpoint.azureedge.net/hlsjsv115/hls.js"],css:[],styles:[],lang:"en-us",disableFullscreenButton:!1,muteVideo:!1,playerType:1,hydraPlayerWebSdkUrls:["https://afdhls.playerscript.prod.ml.cdn.office.net/hlsrt2023-1208-2/hydra_player_hls_bundle.js","https://vzhls.playerscript.prod.ml.cdn.office.net/hlsrt2023-1208-2/hydra_player_hls_bundle.js"]},rt={src:[],css:[],styles:[],playerType:2,hydraPlayerWebSdkUrls:["https://afdhls.playerscript.prod.ml.cdn.office.net/umsrt2023-1207-3/hydra_player_ums_bundle.js","https://vzhls.playerscript.prod.ml.cdn.office.net/umsrt2023-1207-3/hydra_player_ums_bundle.js"]},st=class{constructor(g,m,S,v){this.configIds=S,this.logger=v,this.defaultSettings=getSettings(),this.logger.info(`client settings: ${JSON.stringify(m)}`),this.defaultSettings.debug=m?.debug||!1,this.defaultSettings.playerType=m?.playerConfig?.playerType||this.defaultSettings.playerType,m?.playerConfig&&(0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration=m.playerConfig:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration=m.playerConfig:2===this.defaultSettings.playerType&&(this.defaultSettings.umsSettings.liveStreamPlayerConfiguration=m.playerConfig)),(0,et.mergeWith)(this.defaultSettings,g,arrayMergeCustomizer),this.logger.info(`applied settings: ${JSON.stringify(this.defaultSettings)}`)}get playerConfig(){return 0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration:2===this.defaultSettings.playerType?this.defaultSettings.umsSettings.liveStreamPlayerConfiguration:null}get config(){return this.defaultSettings}},at=class{constructor(){this.defaultSettings={allowSdnPlugins:!0,capturePlayerLogs:!0,playerType:0,loadType:1,maxPlayerDiagnosticsCount:50,maxPlayerMemoryTraceLogCount:1e3,maxPlayerPlaybackEventCount:50,maxRetryCount:10,playerTelemetryTickMs:1e3,removeEmptyDefaultTextTrack:!0,sendSnapshotTelemetry:!1,sendSnapshotTelemetryEveryMs:1e4,sendInitialTelemetryAfterMs:6e4,sendTelemetry:!0,textTrackKind:"subtitles",maxRetryCountForLoadingResources:5,maxVideoTrackHistoryLogCount:100,ampSettings:{errorCodesEligibleForStreamingUrlSwitch:[4194309,2097564,2097556,2097752,2097753,5242884],liveStreamPlayerConfiguration:it,sourceResetTimeoutInMs:1e3,streamingUrlSwitchMaxCount:2,resetStreamingUrlSwitchCount:!1,useBrowserWindowSizeForBitRate:!0,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,collectUserInitiatedSeekEventsTelemetry:!0,maxUserInitiatedSeekEventCount:100},hlsSettings:{liveStreamPlayerConfiguration:nt,timeoutForSwitchingUrl:9e3,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,playlistInitialSequenceNumber:1,skipNonce:!1,maxStreamConnectionResultsLogCount:100,logHlsJsEvents:!1,logHlsJsEventsEveryMs:5e3,maxPlayerExperimentalEvents:100},umsSettings:{liveStreamPlayerConfiguration:rt,timeoutForSwitchingUrl:9e3,maxStreamConnectionResultsLogCount:100,minTargetEdgeLatency:.2,maxEdgeLatencyHistoryLength:300,latencyCompensationThreshold:.5,maxPlayerExperimentalEvents:100}}}getSettings(){return this.defaultSettings}},ot=class extends at{constructor(){super(),this.settings=super.getSettings(),this.settings.loadType=0,this.settings.allowSdnPlugins=!1,this.settings.umsSettings.minTargetEdgeLatency=.6,this.settings.umsSettings.latencyCompensationThreshold=.9}getSettings(){return this.settings}};function getSettings(){let g;if("Safari"===getBrowserInfo().engine)g=new ot;else g=new at;return g.getSettings()}function arrayMergeCustomizer(g,m){if((0,et.isArray)(g))return m.slice()}function isStreamValid(g){return!!g&&!!g.url&&!!g.decryptionToken}function assert(g,m,S){if(!g&&!S)throw new Error("Assert failed"+(void 0!==m?`: ${m}`:""))}var lt=class{constructor(g,m,S){this.name=g,this.stopCrash=m,this.start(S)}complete(){assert(this.startTime,"not started",this.stopCrash),assert(void 0===this.duration,"already completed",this.stopCrash),this.duration=Date.now()-this.startTime}updateDetails(g,m){if(this.details&&"object"==typeof this.details)for(let S=0;S<g.length;S++)this.details[g[S]]=m[S]}fail(g){this.failReason=g,this.complete()}set detail(g){this.details=g}getTelemetryEvent(){assert(this.startTime,"not started",this.stopCrash);try{assert(void 0!==this.duration,"not completed",this.stopCrash)}catch(g){if("SetSource"!==this.name&&"Load"!==this.name)throw g}const g={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(g.failReason=this.failReason),this.details&&(g.details=this.details),g}start(g){assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),this.details=g}},ct=class{constructor(g,m,S){this.config=g,this.logger=m,this.playerDiagnosticsLog=S,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.userInitiatedSeekEvents=[],this.experimentalEvents=[],this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=g.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=g.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=g.maxPlayerMemoryTraceLogCount||100,this.maxUserInitiatedSeekEventCount=g.ampSettings?.maxUserInitiatedSeekEventCount||100,this.stopCrash=g.stopCrash||!1,this.config.debug&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}getPlayerDiagnosticSnapshot(){return this.currentPlayerDiagnosticSnapshot}registerStatsUpdated(g){this.currentPlayerDiagnosticSnapshot=g,Object.keys(this.playerDiagnosticsLog).forEach((m=>{const S=m,v=this.playerDiagnosticsLog[m];if(Array.isArray(v)){v.push(g[S]);const m="memoryLog"===S&&v.length>this.maxPlayerMemoryTraceLogCount,C="memoryLog"!==S&&v.length>this.maxPlayerDiagnosticsCount;(m||C)&&v.splice(0,1)}else this.playerDiagnosticsLog[m]=g[S]}))}registerEventLoadAttempt(g,m){this.registerScenario(g,m)}registerEventLoadFailed(g,m){this.completeScenario(g,m)}registerEventLoadSucceeded(g,m){this.completeScenario(g,void 0,m)}registerPlayerLoadAttempt(){this.registerScenario("Load")}registerPlayerLoadSucceeded(g){this.completeScenario("Load",void 0,g)}registerPlayerLoadFailed(g){this.completeScenario("Load",g)}registerPlayerSetupAttempt(){this.registerScenario("Setup")}registerPlayerSetupSucceeded(){this.completeScenario("Setup")}registerPlayerSetupFailed(g){this.completeScenario("Setup",g)}registerStreamConnectionAttempt(g){this.registerScenario("StreamConnection")}registerStreamConnectionSucceeded(){this.completeScenario("StreamConnection")}registerStreamConnectionFailed(g){this.completeScenario("StreamConnection",g)}registerSetSourceAttempt(g,m){let S=g;m&&(S={src:g,reason:m}),this.registerScenario("SetSource",S)}registerSetSourceSucceeded(g){this.getScenario("SetSource").updateDetails(["src"],[g]),this.completeScenario("SetSource")}registerSetSourcedFailed(g,m){this.getScenario("SetSource").updateDetails(["src"],[m]),this.completeScenario("SetSource",g)}registerSdnPluginLoad(g,m,S){this.registerScenario("SdnPluginLoad",g);const v=m?void 0:S;this.completeScenario("SdnPluginLoad",v)}registerPlayerDestroyed(g){this.registerScenario("Destroyed",g),this.completeScenario("Destroyed")}registerPlaybackStateChanged(g,m){let S;if("Ready"!==g||this.firstReadyStateTimestamp?"Playing"!==g||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),m&&"Buffering"===g){m?S=m.message:this.logger.debug(`Unexpected buffering payload: ${JSON.stringify(m)}`)}this.registerPlaybackEvent("StateChanged",g,S)}registerPlaybackError(g,m){this.registerPlaybackEvent("Error",{errorType:g,details:m})}registerDownloadBitratechanged(g){this.registerPlaybackEvent("BitrateChangedDownload",g)}registerStreamOptionsConfigured(g,m){this.registerPlaybackEvent("StreamOptionsConfigured",this.generateCleanedStreamOption(g),m)}registerPlaybackBitratechanged(g){this.registerPlaybackEvent("BitrateChangedPlayback",g)}registerPotentialMediaFreeze(g){this.registerPlaybackEvent("PotentialMediaFreeze",g)}registerCaptionToggle(g,m,S){const v={isEnabled:g,culture:m,playerTime:S};this.registerPlaybackEvent("CaptionsToggled",v)}registerFullScreenChange(g){this.registerPlaybackEvent("FullscreenChanged",g)}registerMute(g){this.registerPlaybackEvent("Mute",g)}registerVolumeChange(g){this.registerPlaybackEvent("Volume",g)}getExperimentalEvents(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}}getUserInitiatedSeekEvents(){return{playback_userInitiatedSeekEvents:this.prepareForTelemetry(this.userInitiatedSeekEvents)}}getSnapshotReport(g={}){const m=this.playerEvents.map((g=>g.getTelemetryEvent())),S=this.playbackEvents;let v={};return this.currentPlayerDiagnosticSnapshot&&(v=this.filterAndPrepareTelemetry()),{isFullReport:!1,configIds:g.configIds||"",playerId:g.playerId||"",correlationId:g.correlationId||"",traceId:g.correlationId?g.correlationId.replace(/-/g,""):"",eTag:g.eTag||"",isFinal:g.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:g.disableFullscreenButton??!1,threadId:g.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:getTsCallingVersion(),...this.getInitializationReport(m,S),...this.getPlaybackReport(S),...this.getBitrateReport(S),...this.getSdnReport(m),...this.getSetSourceReport(m),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(m),callDropped:this.getCallDropped(S),...v}}getReport(g={}){const m=this.playerEvents.map((g=>g.getTelemetryEvent())),S=this.playbackEvents;return{callendReason:g.callendReason,isFullReport:!0,configIds:g.configIds||"",playerId:g.playerId||"",correlationId:g.correlationId||"",traceId:g.correlationId?g.correlationId.replace(/-/g,""):"",eTag:g.eTag||"",isFinal:g.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:g.disableFullscreenButton??!1,threadId:g.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:getTsCallingVersion(),...this.getInitializationReport(m,S),...this.getPlaybackReport(S),...this.getBitrateReport(S),...this.getSdnReport(m),...this.getSetSourceReport(m),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(m),callDropped:this.getCallDropped(S),...this.getPlayerDiagnosticLog()}}registerExperimentalEvent(g,m,S){const v=this.createTelemetryEvent(g,m,S);this.experimentalEvents.push(v),this.logTelemetryEvent(v)}registerUserInitiatedSeek(g){const m=(this.currentPlayerDiagnosticSnapshot?.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1)<g.newCurrentPlayPosition,S={...g,seekForward:m},v=this.createTelemetryEvent("UserInitiatedSeek",S);this.userInitiatedSeekEvents.push(v),this.userInitiatedSeekEvents.length>this.maxUserInitiatedSeekEventCount&&this.userInitiatedSeekEvents.splice(0,1)}createTelemetryEvent(g,m,S){const v={eventType:g,timestamp:Date.now(),currentPlayPosition:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1};return void 0!==m&&(v.payload=this.prepareForTelemetry(m)),v.message=S,v}registerPlaybackEvent(g,m,S){const v=this.createTelemetryEvent(g,m,S);"Error"===g&&"PlaybackRetried"!==m?.errorType&&(v.fatal=!0),this.playbackEvents.push(v),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(v)}getPlayerDiagnosticLog(){if(!this.currentPlayerDiagnosticSnapshot)return{};const g={...this.currentPlayerDiagnosticSnapshot,...this.playerDiagnosticsLog},m={};return Object.keys(g).forEach((S=>{m[`player_${S}`]=this.prepareForTelemetry(g[S])})),m}getCallSetupSucceeded(g){const m=g.find((g=>"Load"===g.name));return!!m&&!m.failReason}getCallDropped(g){return!!g.filter((g=>"Error"===g.eventType)).find((g=>g.fatal))}getInitializationReport(g,m){const S=g.find((g=>"Load"===g.name));return{init_timeLoadToStreamConnectionEstablished:(S&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-S.startTime:-1)||-1,init_timeLoadToReady:(S&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-S.startTime:-1)||-1,init_timeLoadToPlaying:(S&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-S.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(g)}}getPlaybackReport(g){const m=g.filter((g=>"StateChanged"===g.eventType)),S=m.find((g=>"Ready"===g.payload)),v=m.find((g=>"Play"===g.payload)),C=m.find((g=>"Start"===g.payload)),_=m.find((g=>"Playing"===g.payload)),E=S&&v?v.timestamp-S.timestamp:-1,T=v&&C?C.timestamp-v.timestamp:-1,I=C&&_?_.timestamp-C.timestamp:-1,b=m.filter((g=>"Seeked"===g.payload)),A=m.filter((g=>"Seeking"===g.payload)),R=m.filter((g=>"Paused"===g.payload)),P=m.filter((g=>"Resume"===g.payload)),M=m.filter((g=>"Buffering"===g.payload)),w=["BitrateChangedDownload","BitrateChangedPlayback","Error","Mute","StateChanged","Volume","StreamOptionsConfigured"],D=g.filter((g=>"Error"===g.eventType)),O=g.filter((g=>"Volume"===g.eventType||"Mute"===g.eventType)),N=g.filter((g=>"StreamOptionsConfigured"===g.eventType)),k=g.filter((g=>!w.includes(g.eventType)));return{playback_timeReadyToPlay:E,playback_timePlayToStart:T,playback_timeStartToPlaying:I,playback_bufferingEvents:this.prepareForTelemetry(M),playback_errorEvents:this.prepareForTelemetry(D),playback_pauseEvents:this.prepareForTelemetry(R),playback_resumeEvents:this.prepareForTelemetry(P),playback_otherEvents:this.prepareForTelemetry(k),playback_seekedEvents:this.prepareForTelemetry(b),playback_seekingEvents:this.prepareForTelemetry(A),playback_stateChangeEvents:this.prepareForTelemetry(m),playback_volumeEvents:this.prepareForTelemetry(O),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(N)}}generateCleanedStreamOption(g){return{...g,stream:{...g?.stream,decryptionToken:g?.stream?.decryptionToken?"valid":"empty",sdnContext:g?.stream?.sdnContext?"valid":"empty",keyAuthorizationToken:g?.stream?.keyAuthorizationToken?"valid":"empty"},altStream:g?.altStream?{...g?.altStream,decryptionToken:g?.altStream?.decryptionToken?"valid":"empty",sdnContext:g?.altStream?.sdnContext?"valid":"empty",keyAuthorizationToken:g?.stream?.keyAuthorizationToken?"valid":"empty"}:void 0}}getBitrateReport(g){const m=g.filter((g=>"BitrateChangedDownload"===g.eventType)),S=m.sort((g=>Number(g.payload))),v=m.length?{bitrate_downloadChanges:this.prepareForTelemetry(m),bitrate_downloadChangeCount:m.length||-1,bitrate_downloadMin:S[0].payload||-1,bitrate_downloadMax:S[S.length-1].payload||-1}:{},C=g.filter((g=>"BitrateChangedPlayback"===g.eventType)),_=C.sort((g=>Number(g.payload)));return{...v,...C.length?{bitrate_playbackChanges:this.prepareForTelemetry(C),bitrate_playbackChangeCount:C.length||-1,bitrate_playbackMin:_[0].payload||-1,bitrate_playbackMax:_[_.length-1].payload||-1}:{}}}addNetworkTypeEventListener(){window.navigator?.connection?.type&&window.navigator?.connection?.addEventListener("change",(()=>this.updateClientNetworkType()))}updateClientNetworkType(){this.clientNetworkType=void 0,this.getClientNetworkType()}getClientNetworkType(){if(void 0===this.clientNetworkType){let g="Unknown";if(window.navigator?.connection?.type){const m=window.navigator?.connection?.type;switch(m){case"cellular":g="WWAN";break;case"ethernet":g="Wired";break;case"wifi":g="Wireless";break;default:g="Unknown"}}this.clientNetworkType=g}return this.clientNetworkType}getSdnReport(g){const m=g.filter((g=>"SdnPluginLoad"===g.name)),S=m.length?m[m.length-1]:void 0;return{sdn_loaded:!(!S||void 0!==S.failReason),sdn_details:S&&S.details||"",sdn_error:S&&S.failReason||"",sdn_events:this.prepareForTelemetry(m)}}getSetSourceReport(g){const m=g.filter((g=>"SetSource"===g.name));return{set_source_events:this.prepareForTelemetry(m)}}registerScenario(g,m){const S=this.currentScenarioMap.get(g),v=new lt(g,this.stopCrash,m);assert(!S,`previous scenario:${stringifyObject(S)} is not completed, new scenario:${stringifyObject(v)}`,this.stopCrash),this.currentScenarioMap.set(g,v),this.playerEvents.push(v)}getScenario(g){return this.currentScenarioMap.get(g)}completeScenario(g,m,S){const v=this.currentScenarioMap.get(g);assert(v,"no scenario to complete",this.stopCrash),m?v.fail(m):("StreamConnection"!==g||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),S&&(v.detail=S),v.complete()),this.currentScenarioMap.delete(g)}logTelemetryEvent(g){this.config.debug&&(this.logger.debug(`PlayerTelemetryEvent: ${JSON.stringify(g)}`),this.logger.debug(`PlayerDiagnosticData: ${JSON.stringify(this.currentPlayerDiagnosticSnapshot)}`))}filterAndPrepareTelemetry(){const g=new Set;g.add("serviceLatencyCdg"),g.add("endToEndLatencyCdg"),g.add("videoEdgeLatencyCdg");const m={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((S=>{g.has(S)||(m[`player_${S}`]=this.prepareForTelemetry(this.currentPlayerDiagnosticSnapshot[S]))})),m}prepareForTelemetry(g){return"boolean"==typeof g?g:"string"==typeof g||void 0===g?g||"":"number"==typeof g?g??-1:JSON.stringify(g)}},dt=P;function asap(g){return new Promise((m=>{m(g())}))}function defer(){let g,m;return{promise:new Promise(((S,v)=>{g=S,m=v})),resolve:g,reject:m}}function delay(g){return new Promise((m=>setTimeout(m,g)))}function AmpPlayerF(){const g=AmpDiagnosticProviderF(),m=CaptionsControlToggleProviderF();let S;return(S||(S={})).CaptionFunctionalityNotSupported="CaptionFunctionalityNotSupported",class{constructor(g,m){this.container=g,this.eventsHandler=m,this.videoElementEvents=[],this.playerEvents=[],this.maxMemoryTraceLogCount=1e4,this.videoSourceType="application/dash+xml",this.sdnPluginLoaded=!1,this.statsTimer=-1,this.statsInterval=1e3,this.videoSourceSetAttemptCount=0,this.totalBufferingTime=0,this.isBuffering=!1,this.totalPlayingTime=0,this.isPlaying=!1,this.videoTrackTotalDurations=[]}get contextWindow(){return this.container.ownerDocument.defaultView}configure(g,m,S){this.liveStreamOptions=g,this.playerId=S,m&&(this.configProvider=m,this.statsInterval=m.config.playerTelemetryTickMs||this.statsInterval,this.maxMemoryTraceLogCount=m.config.maxPlayerMemoryTraceLogCount||this.maxMemoryTraceLogCount)}getIceCandidates(){let g=[];try{const m=this.liveStreamOptions.stream.sdnContext||this.liveStreamOptions.altStream?.sdnContext||"",S=JSON.parse(m),v=JSON.parse(S.sdnConfig);if(!v.RTCIceCandidates)throw new Error("RTCIceCandidates not present in SDN Context");g=v.RTCIceCandidates}catch(g){this.log(`getIceCandidates failed: ${JSON.stringify(g.message)}`,"error")}return this.log(`getIceCandidates: ${JSON.stringify(g)}`,"debug"),g}loadPlayerScript(){let g=Promise.resolve("");const m=this.configProvider.playerConfig.nonce,S=this.configProvider.playerConfig.css;for(let v=0;v<S.length;v++)g=g.then((()=>this.retry((()=>this.loadCss(this.container.ownerDocument,S[v],m)))));return g=g.then((()=>this.loadAmpScript())),g}loadAmpScript(){this.log("loadPlayerScript started");let g=Promise.resolve("");const m=this.configProvider.playerConfig?.nonce,S=this.configProvider.playerConfig?.src||[],v=Math.max(2,this.configProvider.config.maxRetryCountForLoadingResources);if(0===S.length)return Promise.reject("AMP Player Src is empty");for(let C=0;C<S.length;++C)g=g.then((()=>this.loadScriptPromise(S,C,m,v)));return g}loadScriptPromise(g,m,S,v,C=""){return this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,g[m],S)),v).then((S=>`${g[m]}: ${S} `.concat(C))).catch((_=>this.retry((()=>this.setScriptByBlob(this.container.ownerDocument,g[m],S)),v).then((S=>`${g[m]}: ${S}`.concat(` ${_} `,` ${C} `))).catch((E=>this.retry((()=>this.setScriptByInnerHtml(this.container.ownerDocument,g[m],S)),1).then((S=>`${g[m]}: ${S}`.concat(` ${_} `,`${E} `,` ${C} `))).catch((_=>{let T=C;return m<g.length&&(T=T.concat(`Failed to load script, nonce: ${S}, src: ${g[m]} index: ${m} `),T=T.concat(`${v} attempts LoadFailure `,`${v} attempts BlobFetchFailure: `,E,", 1 attempt InnerHtmlFailure: ",`${_} `)),Promise.reject(T)}))))))}retry(g,m=this.configProvider.config.maxRetryCountForLoadingResources,S=1,v=200){return g(m).then((g=>`${g}, succeeded on load number: ${S} `)).catch((C=>(this.log(`Error loading resource: ${C} -- ${m} retriesLeft`),0==--m?Promise.reject(`${C}`):new Promise((_=>setTimeout((()=>_(this.retry(g,m,S+1).then((g=>"string"==typeof g?`${g}, succeeded on load number: ${S}`:g)).catch((g=>Promise.reject(`${C}`.concat(", ",g)))))),v))))))}setScriptByLoad(g,m,S){const v=g.createElement("script"),C=this.getElementLoadPromise(v,m);return v.src=m,S&&(v.nonce=S),g.head.appendChild(v),C.then((()=>Promise.resolve("Success: setScriptByLoad")))}setScriptByBlob(g,m,S){return this.safeResponse(m).then((m=>m.blob().then((v=>{if(v){const m=URL.createObjectURL(v);return this.setScriptByLoad(g,m,S).then((()=>Promise.resolve("Success: setScriptByBlob")))}return Promise.reject(`${m.status}, blob is null`)}))))}setScriptByInnerHtml(g,m,S){return this.safeResponse(m).then((m=>m.text().then((v=>{if(v){const m=document.createElement("script");return m.innerHTML=v,S&&!this.configProvider.config.hlsSettings.skipNonce&&(m.nonce=S),g.head.appendChild(m),Promise.resolve("Success: setScriptByInnerHtml")}return Promise.reject(`status code:${m.status}, text is null`)}))))}safeResponse(g){return fetch(g).then((g=>g.ok?g:Promise.reject(`${g.status}`)))}tryLoadSdnPlugin(){return this.sdnPluginLoaded||!this.liveStreamOptions.sdn?Promise.resolve():this.configProvider.config.allowSdnPlugins?(this.log("tryLoadSdnPlugin started"),this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,this.liveStreamOptions.sdn.url,this.configProvider.playerConfig.nonce))).then((()=>{this.log("SDN script loaded"),this.sdnPluginLoaded=!0,this.log("tryLoadSdnPlugin done")}))):(this.log("Loading SDN plugins is not allowed"),Promise.reject("Loading SDN plugins is not allowed"))}createAmp(){this.log("createAmp started"),this.createVideoElement();const S=this.getAmpOptions();if(this.playerInstance=this.contextWindow.amp(this.video.id,S),!this.playerInstance)throw this.log("createAmp failed","error"),new Error("playerInstance is null");"html5"===this.playerInstance.currentTechName()?.toLowerCase()&&this.configProvider.config.ampSettings.estimateAbsoluteTime&&this.isControlsDisabled()?(this.absoluteTimeOffsetEstimator=new ut(this.log.bind(this)),this.diagnosticProvider=new g(this.playerInstance,this.contextWindow,new Date,this.configProvider,this.absoluteTimeOffsetEstimator),this.absoluteTimeOffsetEstimator.setEstimationResultCallback(this.onAbsoluteTimeOffsetEstimation.bind(this))):this.diagnosticProvider=new g(this.playerInstance,this.contextWindow,new Date,this.configProvider);const v={controlsEnabled:!this.isControlsDisabled(),logFn:this.log.bind(this),removeEmptyDefaultTextTrack:this.configProvider.config.removeEmptyDefaultTextTrack};this.diagnosticProvider.setValue("streamingEventType",this.liveStreamOptions.streamingEventType),this.diagnosticProvider.setValue("playerControlsEnabled",!this.isControlsDisabled()),this.captionsControl=new m(this.playerInstance,this,v,this.diagnosticProvider),this.registerPlayerEvents(),this.log("createAmp done")}isControlsDisabled(){return void 0!==this.liveStreamOptions.allowPlayerControls?!this.liveStreamOptions.allowPlayerControls:"Overflow"===this.liveStreamOptions.streamingEventType||"TownHall_Basic"===this.liveStreamOptions.streamingEventType||"TownHall_Premium"===this.liveStreamOptions.streamingEventType||"TownHall"===this.liveStreamOptions.streamingEventType}onAbsoluteTimeOffsetEstimation(g){if(this.diagnosticProvider.appendAbsoluteTimeOffsetEstimation(g),!g.isSuccess){const g=this.addEvent("CaptionFunctionalityNotSupported",{detail:{data:{fatal:!0,details:"absolute time offset estimation failed - captions will fail"}}});this.video.dispatchEvent(g)}}addEvent(g,m){let S={};return m?.detail&&(S={detail:m.detail}),new CustomEvent(g,S)}setSource(g){if(this.log("setSource started"),!this.playerInstance)throw this.log("setSource failed: playerInstance is null","error"),new Error("playerInstance is null");this.videoSourceSetAttemptCount++,this.videoSourceSetAttemptCount>0&&this.diagnosticProvider.setValue("retryCount",this.videoSourceSetAttemptCount-1);const m={src:g.url,type:this.videoSourceType,protectionInfo:g.decryptionToken?[{type:"AES",authenticationToken:g.decryptionToken}]:null};this.configureSdnSource(m,g),this.diagnosticProvider.setValue("streamUrl",g.url),this.diagnosticProvider.setValue("streamId",this.getStreamIdFromStreamUrl(g.url)),this.diagnosticProvider.setValue("streamDeliveryPipeline",g.streamDeliveryPipeline||""),this.playerInstance.src([m],this.getTextTracks()),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.setManifestFileURL(g.url+"(format=m3u8-aapl-v4)"),this.log("setSource done")}getStreamIdFromStreamUrl(g){try{const m=new URL(g).pathname;if(m){const g=m.split("/");if(g?.length>1)return g[1]}return this.log(`unable to parse stream ID from stream URL: ${g}`,"warn"),""}catch{return this.log(`cannot parse stream ID from invalid stream URL: ${g}`,"warn"),""}}setPlayTime(g){g&&(this.log(`setPlayerTime: ${g}`),this.playerInstance.currentTime(g))}dispose(){this.log("dispose started"),this.diagnosticProvider&&(this.stopStatsCollection(),this.diagnosticProvider.dispose(),this.diagnosticProvider=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.removePlayerEventListeners(),this.playerInstance.getMemoryLog(!0),this.playerInstance.dispose(),this.playerInstance=null),this.eventsHandler.ampDisposed(),this.video&&(this.removeVideoEventListeners(),this.video.parentNode&&this.video.parentNode.removeChild(this.video),this.video=null),this.absoluteTimeOffsetEstimator&&(this.absoluteTimeOffsetEstimator.stopStreamAbsoluteTimeOffsetRetrieval(),this.absoluteTimeOffsetEstimator=null),this.log("dispose done"),this.eventsHandler=null}updatePlaybackDiagnostics(){this.updateTotalPlayingTimeStatistic(),this.updateBufferingRateStatistic(),this.updateVideoTrackHistoryStatistic()}handlePlaybackStopped(){this.isBuffering=!1,this.isPlaying=!1,this.currentVideoPlaybackBitrate=null}showCaptions(g){this.log(`showCaptions: ${g}`),this.captionsControl.showCaptions(g)}addCues(g){g=g.filter((g=>g.text&&0!==g.text.trim().length)),this.captionsControl.addCues(g)}clearCues(){this.captionsControl.clearCues()}captionsToggled(g,m,S){this.log(`captionsToggled: ${g} for culture ${m} at ${S}`),this.eventsHandler.message("captionsToggled").send(g,m,S)}createVideoElement(){this.log("createVideoElement started"),this.video=this.container.ownerDocument.createElement("video"),this.video.id="amp-player",this.video.setAttribute("playsinline","");const g=this.configProvider.playerConfig.lang;g&&(this.video.setAttribute("lang",g),this.log(`createVideoElement: language set to ${g}`));const m=this.configProvider.playerConfig.styles;for(let g=0;g<m.length;g++)this.video.classList.add(m[g]);this.container.appendChild(this.video),this.log("createVideoElement done")}getAmpOptions(){const g=[];this.configProvider.config.debug?g.push({target:"memory",maxMemoryTraceCount:this.maxMemoryTraceLogCount}):g.push({target:"console"});const m={TraceTargets:g,maxLogLevel:this.configProvider.config.debug?3:2},S={techOrder:["azureHtml5JS","html5"],nativeControlsForTouch:!1,autoplay:!0,preload:"auto",controls:!this.isControlsDisabled(),logo:{enabled:!1},height:"100%",width:"100%",traceConfig:m,disableFullscreenButton:this.configProvider.playerConfig?.disableFullscreenButton,staleDataTimeLimitInSec:30,heuristicProfile:this.contextWindow.amp.Player.HeuristicProfile.HighQuality,customPlayerSettings:{customHeuristicSettings:{bandwidthTestWithTimeThresholdDuringLive:!1,windowSizeHeuristics:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useBrowserWindowForWindowSizeRule:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useVariableFragmentSizeMode:!0}},plugins:{}};return this.initializePluginOptions(S),S}isStreamValid(g){return g&&!!g.url&&!!g.decryptionToken}initializePluginOptions(g){if(!this.sdnPluginLoaded||!this.liveStreamOptions.sdn)return;const m=this.isStreamValid(this.liveStreamOptions.stream)?this.liveStreamOptions.stream:this.liveStreamOptions.altStream;this.log(`initializePluginOptions, receivedSDNContext: ${JSON.stringify(m?.sdnContext)}`,"info");try{switch(this.liveStreamOptions.sdn.name){case"hive":if(g.plugins={hive:{debugLevel:this.configProvider.config.debug?"debug":"notice",telemetryId:this.playerId}},m&&m.sdnContext)try{const S=JSON.parse(m.sdnContext);if(S.sdnConfig){const m=JSON.parse(S.sdnConfig);m.candidateTopicName="RequestIceCandidates",delete m.RTCIceCandidates,Object.assign(g.plugins.hive,m)}}catch(g){this.log(`initializePluginOptions, failed to parse Hive sdnConfig Json from sdnContext Json, error: ${g}`,"warn")}break;case"kollective":if(m&&m.sdnContext){let S=null,v=null,C=null;try{S=this.parseJson(m.sdnContext,"kollective sdn context")}catch(g){this.log(`initializePluginOptions, failed to parse Kollective sdnContext Json, error: ${g}`,"error")}if(S){try{v=this.parseJson(S.playbackinfo,"kollective sdn playback info")}catch(g){this.log(`initializePluginOptions, failed to parse Kollective sdnContext playbackinfo Json, error: ${g}`,"error")}try{C=this.parseJson(S.sdnConfig,"kollective sdn config")}catch(g){this.log(`initializePluginOptions, failed to parse Kollective sdnContext sdnConfig Json, error: ${g}`,"error")}}g.plugins={kollectiveSDN:{playbackInfo:v,sdnConfig:C,reportSessionId:this.playerId}}}break;case"ramp":m&&m.sdnContext&&(g.plugins={RampMOPlugin:this.parseJson(m.sdnContext,"ramp sdn context")},this.configProvider.config.debug&&(g.plugins.RampMOPlugin.verbose=!0));break;case"peer5":m.sdnContext&&(g.plugins={peer5:this.parseJson(m.sdnContext,"peer5 sdn context")})}}catch(g){this.log(`initializePluginOptions failed, error: ${g.message}`,"error")}this.log(`initializePluginOptions, configured plugin options: ${JSON.stringify(g.plugins)}`,"info")}getTextTracks(){const g=[];if(this.isControlsDisabled())g.push({id:"amp-player_default",kind:"captions",label:"default-text-track",src:"",srclang:"en"});else if(this.liveStreamOptions.supportedSubtitleLanguages){const m=this.liveStreamOptions.supportedSubtitleLanguages;for(let S=0;S<m.length;S++)g.push({id:`amp-player_${m[S].culture}`,kind:this.configProvider.config.textTrackKind,label:m[S].name||m[S].culture,src:"",srclang:m[S].culture.substr(0,2)})}return g}configureSdnSource(g,m){if(!this.sdnPluginLoaded||!this.liveStreamOptions.sdn)return;switch(this.liveStreamOptions.sdn.name){case"hive":if(!m.sdnContext){g.sdnList=[];break}try{const S=JSON.parse(m.sdnContext);S.playbackinfo&&(g.sdnList=[{sdnName:"hive",sdnUrl:S.playbackinfo}])}catch(S){g.sdnList=[{sdnName:"hive",sdnUrl:m.sdnContext}]}break;case"kollective":if(!m.sdnContext){g.sdnList=[];break}try{const S=this.parseJson(m.sdnContext,"kollective sdn list context"),v=this.parseJson(S.playbackinfo,"kollective sdn list playback info"),C=this.parseJson(S.sdnConfig,"kollective sdn list sdn config");g.sdnList=[{sdnName:"kollectiveSDN",playbackInfo:v,sdnConfig:C}]}catch(m){return g.sdnList=[],void this.log(`configureSdnSource failed, error: ${m}`,"error")}break;case"ramp":case"peer5":g.sdnList=[];break;default:return}this.log(`configureSdnSource, configured source context: ${JSON.stringify(g)}`,"info")}registerPlayerEvents(){this.registerPlayerEvent(this.contextWindow.amp.eventName.error,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.error)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.canplaythrough,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.canplaythrough)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.play,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.play)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playing,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playing)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.pause,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.pause)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.resume,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.resume)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.start,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.start)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.ended,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.ended)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeking,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeking)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeked,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeked)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadedmetadata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadedmetadata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.waiting,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.waiting)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playbackbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playbackbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.downloadbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.downloadbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.fullscreenchange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.fullscreenchange)})),this.registerPlayerEvent("potentialMediaFreeze",(()=>{this.onAmpEvent("potentialMediaFreeze")})),this.registerPlayerEvent(this.contextWindow.amp.eventName.mute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.mute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.unmute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.unmute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.volumechange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.volumechange)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadeddata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadeddata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadstart,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadstart)})),Object.values(S).forEach((g=>{this.registerVideoEvent(g,(m=>{this.handleUserExperienceErrorEvent(g,m.detail.data.details,m.detail.data.fatal)}))})),this.configProvider.config.ampSettings.collectUserInitiatedSeekEventsTelemetry&&(this.playerEvents.push("currentTimeChanging"),this.playerInstance.addEventListener("currentTimeChanging",((g,m)=>this.onAmpCurrentTimeChangingEvent(g,m))))}onAmpCurrentTimeChangingEvent(g,m){if("currentTimeChanging"!==g.type||!m.time)return;const S={newCurrentPlayPosition:m.time};this.eventsHandler.message("stateChanged").send("UserInitiatedSeek",S)}registerPlayerEvent(g,m){this.playerEvents.push(g),this.playerInstance.addEventListener(g,m)}registerVideoEvent(g,m){this.videoElementEvents.push({name:g,callback:m}),this.video.addEventListener(g,m)}removePlayerEventListeners(){this.playerEvents.forEach((g=>{this.playerInstance.removeEventListener(g)}))}removeVideoEventListeners(){this.videoElementEvents.forEach((g=>{this.video.removeEventListener(g.name,g.callback)}))}onAmpEvent(g){let m,S;switch(g){case this.contextWindow.amp.eventName.error:S=this.playerInstance.error(),m={currentTime:this.playerInstance.currentTime(),errorCode:S?S.code:0,message:S?S.message:""};break;case this.contextWindow.amp.eventName.canplaythrough:this.initializeStatsColletion();break;case this.contextWindow.amp.eventName.loadedmetadata:this.captionsControl.initialize(),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.restartStreamAbsoluteTimeOffsetRetrieval();break;case this.contextWindow.amp.eventName.fullscreenchange:m={isFullscreen:this.playerInstance.isFullscreen()};break;case this.contextWindow.amp.eventName.playbackbitratechanged:m={bitrate:this.playerInstance.currentPlaybackBitrate()};break;case this.contextWindow.amp.eventName.downloadbitratechanged:m={bitrate:this.playerInstance.currentDownloadBitrate()};break;case this.contextWindow.amp.eventName.seeked:m={captionsTimestamp:this.isControlsDisabled()?this.playerInstance.currentMediaTime():this.playerInstance.currentTime()};break;case this.contextWindow.amp.eventName.volumechange:m={value:this.playerInstance.volume()}}this.updatePlaybackDiagnostics(),this.updatePlayerState(g),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(g,m)}updatePlayerState(g){this.updatePlayingState(g),this.updateBufferingState(g),this.updateCurrentVideoTrackBitrate(g),g!==this.contextWindow.amp.eventName.ended&&g!==this.contextWindow.amp.eventName.error||this.handlePlaybackStopped()}handleUserExperienceErrorEvent(g,m,S){const v={currentTime:this.video?this.video.currentTime:0,message:m,type:g,errorCode:0,fatal:S};this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(this.contextWindow.amp.eventName.error,v)}updatePlayingState(g){this.isPlaying?g!==this.contextWindow.amp.eventName.pause&&g!==this.contextWindow.amp.eventName.seeking&&g!==this.contextWindow.amp.eventName.ended&&g!==this.contextWindow.amp.eventName.error&&g!==this.contextWindow.amp.eventName.waiting||(this.isPlaying=!1):g===this.contextWindow.amp.eventName.playing&&(this.isPlaying=!0)}updateBufferingState(g){this.isBuffering?(g===this.contextWindow.amp.eventName.pause&&"html5"===this.playerInstance.currentTechName()?.toLowerCase()||g===this.contextWindow.amp.eventName.seeking||g===this.contextWindow.amp.eventName.ended||g===this.contextWindow.amp.eventName.error||g===this.contextWindow.amp.eventName.playing)&&(this.isBuffering=!1):g===this.contextWindow.amp.eventName.waiting&&(this.isBuffering=!0)}updateCurrentVideoTrackBitrate(g){g===this.contextWindow.amp.eventName.playbackbitratechanged&&this.playerInstance.currentPlaybackBitrate()!==this.currentVideoPlaybackBitrate&&(this.currentVideoPlaybackBitrate=this.playerInstance.currentPlaybackBitrate(),this.updateVideoTrackHistoryStatistic())}initializeStatsColletion(){this.diagnosticProvider.initialize(),this.statsTimer=window.setInterval((()=>{this.eventsHandler&&(this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()))}),this.statsInterval)}stopStatsCollection(){this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),-1!==this.statsTimer&&window.clearInterval(this.statsTimer),this.statsTimer=-1}updateVideoTrackHistoryStatistic(){const g=new Date;if(this.currentVideoPlaybackBitrate){const m=this.diagnosticProvider.getValue("videoTrackHistory"),S=this.diagnosticProvider.getValue("videoTrackTotalDurations");if(m.length>0&&this.currentVideoPlaybackBitrate===m[m.length-1].trackPlaybackBitrate){if(this.videoTrackHistoryUpdatedTimestamp){this.latestVideoTrackDuration+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,m[m.length-1].durationInSeconds=Number(this.latestVideoTrackDuration.toFixed(0));const v=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate)),C=S.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));v&&C&&(v.totalDurationInSeconds+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,C.totalDurationInSeconds=Number(v.totalDurationInSeconds.toFixed(0)))}}else{const v=this.playerInstance.videoBufferData();let C=null;v&&v.perceivedBandwidth&&(C=v.perceivedBandwidth),m.push({trackPlaybackBitrate:this.currentVideoPlaybackBitrate,trackSwitchTimestamp:g.getTime(),trackSwitchMeasuredBandwidth:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredBandwidth():null,trackSwitchMeasuredByteSize:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredVideoDownloadSize():null,trackSwitchPerceivedBandwidth:C,durationInSeconds:0}),this.latestVideoTrackDuration=0,m.length>this.configProvider.config.maxVideoTrackHistoryLogCount&&m.splice(0,1);const _=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));if(!_){const g={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0},m={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0};this.videoTrackTotalDurations.push(g),S.push(m)}}}this.videoTrackHistoryUpdatedTimestamp=g}updateTotalPlayingTimeStatistic(){const g=new Date;this.isPlaying&&this.totalPlayingTimeUpdatedTimestamp&&(this.totalPlayingTime+=g.getTime()-this.totalPlayingTimeUpdatedTimestamp.getTime()),this.totalPlayingTimeUpdatedTimestamp=g,this.diagnosticProvider.setValue("totalPlayingTimeInSeconds",Number((this.totalPlayingTime/1e3).toFixed(0)))}updateBufferingRateStatistic(){const g=new Date;this.isBuffering&&this.bufferingRateStatUpdatedTimestamp&&(this.totalBufferingTime+=g.getTime()-this.bufferingRateStatUpdatedTimestamp.getTime()),this.bufferingRateStatUpdatedTimestamp=g;const m=this.totalPlayingTime>0||this.totalBufferingTime>0?this.totalBufferingTime/(this.totalPlayingTime+this.totalBufferingTime):0;this.diagnosticProvider.setValue("bufferingRate",Number(m.toFixed(3)))}getPlayerDiagnostics(){const g=this.diagnosticProvider.getPlayerDiagnosticSnapshot();return g.statsInterval=this.statsInterval,this.configProvider.config.debug&&(g.memoryLog=this.playerInstance.getMemoryLog(!0)),g}log(g,m="info"){const S=`${`[AmpPlayer${1===this.configProvider.config.loadType?"IFrame":""}]`}: ${g}`;this.configProvider.config.debug&&console.log(S),this.eventsHandler.message("log").send(m,S)}getElementLoadPromise(g,m){return new Promise(((S,v)=>{g.onload=()=>{S("Element Load success")},g.onerror=()=>{v(`Failed to load script: ${m}`)}}))}loadCss(g,m,S){const v=g.createElement("link"),C=this.getElementLoadPromise(v,m);return v.href=m,v.rel="stylesheet",S&&(v.nonce=S),g.head.appendChild(v),C}parseJson(g,m){try{return JSON.parse(g)}catch(g){throw this.log(`Error parsing JSON for ${m}, error: ${JSON.stringify(g)}`),g}}}}AmpPlayerF();function AmpCommunicationHandlerF(){const g=AmpPlayerF();return class{constructor(m,S){this.pipe=m,this.amp=new g(S,this)}processMessage(g){if("Command"===g.msgType){Promise.resolve().then((()=>this.amp[g.cmd].apply(this.amp,g.args))).then((m=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:g.cmd,result:JSON.stringify(m)})})).catch((m=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:g.cmd,error:m})}))}}message(g){return{send:this.fromMessage(((...m)=>{this.sendMessageImpl(g,m)}))}}ampDisposed(){this.pipe.dispose(),this.pipe=null,this.amp=null}fromMessage(g){return g}sendMessageImpl(g,m){this.pipe.sendMsg({msgType:"PlayerNotification",name:g,args:m})}}}var ht=AmpCommunicationHandlerF();function IFrameMessageHandlerF(){function isCmdResult(g){return"CommandResult"===g.msgType}function getErrorString(g){let m="unknown";try{m="string"==typeof g?g:"toString"in g&&0!==g.toString().indexOf("[object")?g.toString():JSON.stringify(g)}catch(m){console.error("Failed to stringify error",g)}return m}return class{constructor(){this.processMsg=this.processMsg.bind(this),window.addEventListener("message",this.processMsg)}sendMsg(g){try{let m=g;isCmdResult(g)&&g.error instanceof Event&&(console.debug("Stringifying error Event before trying to postMessage:",g),m={msgType:g.msgType,cmd:g.cmd,error:`Event: ${getErrorString(g.error)}`}),this.postMessage(m)}catch(m){console.error("Unexpected exception caught from postMessage.\n","message:",g,"\n","exception:",m);const S={msgType:"PlayerNotification",name:"log",args:["error",`Unexpected error with postMessage: ${getErrorString(m)}`]};throw this.postMessage(S),m}}registerObserver(g){this.observer=g}dispose(){window.removeEventListener("message",this.processMsg),this.observer=null}processMsg(g){this.observer.processMessage(g.data)}postMessage(g){window.parent.postMessage(g,"*")}}}function HlsAbsoluteTimeOffsetEstimatorF(){const g=HlsFileParserF();return class{constructor(m){this.playlistFileDownloadPromise=Promise.resolve(),this.playlistFileDownloadRetryWaitTime=250,this.playlistFileDownloadMaxRetryCount=20,this.playlistFileDownloadCancellationFlag=!1,this.logFn=(g,S)=>m(`[HlsAbsoluteTimeOffsetEstimator]: ${g}`,S),this.hlsFileParser=new g(m)}get absoluteTimeOffset(){return this.estimatedAbsoluteTimeOffset}setEstimationResultCallback(g){this.onAbsoluteTimeOffsetEstimation=g}restartStreamAbsoluteTimeOffsetRetrieval(){this.stopStreamAbsoluteTimeOffsetRetrieval().then((()=>this.startStreamAbsoluteTimeOffsetRetrieval()))}setManifestFileURL(g){this.cachedManifestUrl=g}startStreamAbsoluteTimeOffsetRetrieval(){this.playlistFileDownloadPromise=this.retryPlaylistFileDownload((()=>this.estimateStreamTimeFromPlaylist(this.currentManifestUrl))).then((()=>{this.logFn(`Succeeded in downloading playlist files to estimate\n                    absolute stream time offset as: ${this.estimatedAbsoluteTimeOffset}`)})).catch((g=>{this.logFn(`Failed to download playlist files to estimate absolute stream time offset: ${g.message}`,"error")}))}stopStreamAbsoluteTimeOffsetRetrieval(){return this.playlistFileDownloadCancellationFlag=!0,this.playlistFileDownloadPromise.then((()=>{this.playlistFileDownloadCancellationFlag=!1,this.currentManifestUrl=this.cachedManifestUrl,this.cachedManifestUrl=null}))}retryPlaylistFileDownload(g,m=0){let S=Promise.resolve();return S=g().then((()=>(this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:m,isSuccess:!0,absoluteTimeOffsetEstimation:this.absoluteTimeOffset}),Promise.resolve()))).catch((S=>(m++,this.logFn(`Error loading playlist file: ${S} -- attempt ${m}`),this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:m,isSuccess:!1,error:S.message}),m===this.playlistFileDownloadMaxRetryCount?Promise.reject(new Error(`${S} after ${m} attempts`)):this.playlistFileDownloadCancellationFlag?Promise.reject(new Error("cancelling playlist file download")):new Promise((S=>setTimeout((()=>S(this.retryPlaylistFileDownload(g,m))),this.playlistFileDownloadRetryWaitTime)))))),S}estimateStreamTimeFromPlaylist(g){return this.hlsFileParser.getStreamRenditionsUrlsFromManifest(g).then((m=>{if(0===m.audioRenditions.length&&0===m.videoRenditions.length)throw new Error(`Unable to retrieve renditions URLs from manifest: ${g}`);return Promise.all([m.videoRenditions.length>0?this.hlsFileParser.getTextFileContent(m.videoRenditions[0]):Promise.resolve(null),m.audioRenditions.length>0?this.hlsFileParser.getTextFileContent(m.audioRenditions[0]):Promise.resolve(null)])})).then((g=>{let m;for(let S=0;S<g.length;S++){const v=g[S];if(v){this.logFn("Using segment duration and sequence number to calculate absolute time offset","debug");const g=this.hlsFileParser.getHlsFieldByName("SequenceNumber",v);if(0==g.length)throw new Error("Unable to retrieve sequence number from playlist file");const S=this.hlsFileParser.getHlsFieldByName("SegmentDuration",v,10);if(0==S.length)throw new Error("Unable to retrieve segment durations from playlist file");const C=S.map(Number);C.sort(((g,m)=>g-m));const _=C[Math.floor(C.length/2)],E=Number(g[0])*Number(_);m=m?Math.max(m,E):E}}this.estimatedAbsoluteTimeOffset=m}))}}}var ut=HlsAbsoluteTimeOffsetEstimatorF();function HlsFileParserF(){return class{constructor(g){this.fieldNameRegexMap={BaseUrl:/(.*)\/.*/,AudioManifestFile:/#EXT-X-MEDIA:TYPE=AUDIO.*URI=\"(.*)\"/,SequenceNumber:/#EXT-X-MEDIA-SEQUENCE:(\d+)/,SegmentDuration:/#EXTINF:(\d+(\.\d+)?)/},this.logFn=(m,S)=>g(`[HlsFileParser]: ${m}`,S)}getHlsFieldByName(g,m,S=1){const v=[];for(let C=1;C<=S;C++){const S=this.fieldNameRegexMap[g].exec(m);if(!(S&&S.length>0))break;v.push(S[1]),m=m.substring(S.index+S[0].length)}return v}getStreamRenditionsUrlsFromManifest(g){return g?this.getTextFileContent(g).then((m=>{const S={audioRenditions:[],videoRenditions:[]},v=m.split("\n"),C=this.getHlsFieldByName("BaseUrl",g);for(let g=0;g<v.length;g++)if(v[g].includes("#EXT-X-STREAM-INF")){const m=v[g+1];m.includes("http")?S.videoRenditions.push(m):C.length>0&&S.videoRenditions.push(`${C[0]}/${m}`)}else if(v[g].includes("EXT-X-MEDIA:TYPE")){const m=this.getHlsFieldByName("AudioManifestFile",v[g]);if(m.length>0){const g=m[0];g.includes("http")?S.audioRenditions.push(g):C.length>0&&S.audioRenditions.push(`${C[0]}/${g}`)}}return S})).catch((g=>(this.logFn(`Failed to extract stream renditions from manifest, error: ${g.message}`,"error"),{audioRenditions:[],videoRenditions:[]}))):(this.logFn("No manifest URL provided to parse"),Promise.resolve({audioRenditions:[],videoRenditions:[]}))}getTextFileContent(g){const m=fetch(g).then((m=>{if(!m.ok)throw new Error(`http-error ${m.status} when downloading: ${g}`);return m.text()})).catch((g=>(this.logFn(`Error downloading resource: ${g}`,"error"),Promise.reject(g))));return m}}}function AmpDiagnosticProviderF(){return class{constructor(g,m,S,v,C){this.playerInstance=g,this.contextWindow=m,this.streamingStartedTimestamp=S,this.configProvider=v,this.absoluteTimeOffsetEstimator=C,this.currentDiagnosticSnapshot={playerType:0,currentPlayPosition:null,tech:null,perceivedBandwidth:null,playerHeight:null,playerWidth:null,mediaHeight:null,mediaWidth:null,windowHeight:null,windowWidth:null,videoStream:null,audioStream:null,totalDurationInSeconds:null,avgVideoDownloadLatency:null,avgAudioDownloadLatency:null,avgVideoDownloadBytes:null,avgAudioDownloadBytes:null,avgAudioDownloadBandwidth:null,avgVideoDownloadBandwidth:null,maxVideoDownloadBytes:null,minVideoDownloadBytes:null,videoDownloadSuccessCount:null,audioDownloadSuccessCount:null,videoDownloadFailureCount:null,audioDownloadFailureCount:null,videoBufferLength:null,videoCachedLength:null,audioBufferLength:null,audioCachedLength:null,videoEdgeLatency:null,audioEdgeLatency:null,playbackRate:null,playbackBitrate:null,downloadBitrate:null,audioDownloadBitrate:null,audioPlaybackBitrate:null,isFullscreen:null,streamType:null,playerVersion:null,isP2PSdnUsed:null,sdnName:null,livePosition:null,muted:null,volume:null,errorCode:null,currentMediaTime:null,currentAbsoluteTime:null,absoluteTimeOffsetEstimationResults:null,estimatedAbsoluteTimeOffset:null,videoDownloadFailures:null,audioDownloadFailures:null,heuristicProfile:null,encryption:null,retryFrequency:null,averageDownloadBitrate:null,totalDownloadedBytes:0,streamId:null,streamUrl:null,streamingEventType:null,playerControlsEnabled:null,streamDeliveryPipeline:null,retryCount:0,totalPlayingTimeInSeconds:0,bufferingRate:0,videoTrackHistory:[],videoTrackTotalDurations:[],memoryLog:null,statsInterval:null},this.videoDownloadLatencies=[],this.audioDownloadLatencies=[],this.audioDownloadBytes=[],this.videoDownloadBytes=[],this.audioDownloadBandwidths=[],this.videoDownloadBandwidths=[],this.videoDownloadSuccessCount=0,this.audioDownloadSuccessCount=0,this.videoDownloadFailureCount=0,this.audioDownloadFailureCount=0,this.audioDownloadFailures=[],this.videoDownloadFailures=[],this.totalDownloadedBytes=0,this.slidingWindowLengthForLatency=5,this.slidingWindowLengthForDownloadBytes=30,this.slidingWindowLengthForDownloadBandwidth=10,this.absoluteTimeOffsetEstimationResults=[],this.downloadFailuresLimit=10,this.onAudioDownloadCompleted=this.onAudioDownloadCompleted.bind(this),this.onAudioDownloadError=this.onAudioDownloadError.bind(this),this.onVideoDownloadCompleted=this.onVideoDownloadCompleted.bind(this),this.onVideoDownloadError=this.onVideoDownloadError.bind(this)}initialize(){this.playerVideoBuffer=this.playerInstance.videoBufferData(),this.playerAudioBuffer=this.playerInstance.audioBufferData(),this.registerForPlayerBufferEvents()}setValue(g,m){this.currentDiagnosticSnapshot[g]=m}getValue(g){return this.currentDiagnosticSnapshot[g]}appendAbsoluteTimeOffsetEstimation(g){this.absoluteTimeOffsetEstimationResults.push(g),this.absoluteTimeOffsetEstimationResults.length>this.configProvider.config.ampSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount&&this.absoluteTimeOffsetEstimationResults.splice(0,1)}getPlayerDiagnosticSnapshot(){if(!this.playerInstance)return null;const g=window.screen,m=this.playerInstance.error(),mean3=g=>{const m=g.slice().sort();return m[Math.floor(m.length/2)]};this.currentDiagnosticSnapshot.errorCode=m&&m.code||0,this.currentDiagnosticSnapshot.currentPlayPosition=this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentMediaTime=this.playerInstance.currentMediaTime()??this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentAbsoluteTime=this.getCurrentAbsoluteTime(),this.currentDiagnosticSnapshot.absoluteTimeOffsetEstimationResults=this.absoluteTimeOffsetEstimationResults,this.currentDiagnosticSnapshot.estimatedAbsoluteTimeOffset=this.getCurrentAbsoluteTimeOffset(),this.currentDiagnosticSnapshot.playbackBitrate=this.playerInstance.currentPlaybackBitrate(),this.currentDiagnosticSnapshot.downloadBitrate=this.playerInstance.currentDownloadBitrate(),this.currentDiagnosticSnapshot.audioDownloadBitrate=this.lastAudioDownloadBitrate,this.currentDiagnosticSnapshot.perceivedBandwidth=this.playerVideoBuffer?this.playerVideoBuffer.perceivedBandwidth:0,this.currentDiagnosticSnapshot.tech=this.playerInstance.currentTechName(),this.currentDiagnosticSnapshot.playerVersion=this.playerInstance.getAmpVersion(),this.currentDiagnosticSnapshot.isP2PSdnUsed=this.isP2PSdnUsed(),this.currentDiagnosticSnapshot.sdnName=this.sdnName(),this.currentDiagnosticSnapshot.heuristicProfile=this.playerInstance.currentHeuristicProfile(),this.currentDiagnosticSnapshot.encryption=this.playerInstance.currentProtectionInfo()?this.playerInstance.currentProtectionInfo().type:"",this.currentDiagnosticSnapshot.streamType=this.getStreamType(this.currentDiagnosticSnapshot.streamType),this.currentDiagnosticSnapshot.totalDurationInSeconds=this.getTotalDurationInSeconds(),this.currentDiagnosticSnapshot.audioStream=this.getAudioStreamData(),this.currentDiagnosticSnapshot.videoStream=this.getVideoStreamData(),this.currentDiagnosticSnapshot.muted=this.playerInstance.muted(),this.currentDiagnosticSnapshot.volume=this.playerInstance.volume(),this.currentDiagnosticSnapshot.playbackRate=this.playerInstance.playbackRate();const S=this.getPlayerCachedLength(),v=this.getPlayerEdgeLatency();this.currentDiagnosticSnapshot.audioBufferLength=this.playerAudioBuffer?this.playerAudioBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.audioCachedLength=S,this.currentDiagnosticSnapshot.audioEdgeLatency=v,this.currentDiagnosticSnapshot.videoBufferLength=this.playerVideoBuffer?this.playerVideoBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.videoCachedLength=S,this.currentDiagnosticSnapshot.videoEdgeLatency=v,this.currentDiagnosticSnapshot.livePosition=this.getLivePosition(),this.currentDiagnosticSnapshot.mediaHeight=this.playerInstance.videoHeight(),this.currentDiagnosticSnapshot.mediaWidth=this.playerInstance.videoWidth(),this.currentDiagnosticSnapshot.playerHeight=this.playerInstance.height(),this.currentDiagnosticSnapshot.playerWidth=this.playerInstance.width(),this.currentDiagnosticSnapshot.windowHeight=g?g.height:0,this.currentDiagnosticSnapshot.windowWidth=g?g.width:0,this.currentDiagnosticSnapshot.isFullscreen=this.playerInstance.isFullscreen(),this.currentDiagnosticSnapshot.avgAudioDownloadLatency=mean3(this.audioDownloadLatencies),this.currentDiagnosticSnapshot.avgVideoDownloadLatency=mean3(this.videoDownloadLatencies),this.currentDiagnosticSnapshot.avgAudioDownloadBytes=mean3(this.audioDownloadBytes),this.currentDiagnosticSnapshot.avgVideoDownloadBytes=mean3(this.videoDownloadBytes),this.currentDiagnosticSnapshot.maxVideoDownloadBytes=Math.max.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.minVideoDownloadBytes=Math.min.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.avgAudioDownloadBandwidth=mean3(this.audioDownloadBandwidths),this.currentDiagnosticSnapshot.avgVideoDownloadBandwidth=mean3(this.videoDownloadBandwidths),this.currentDiagnosticSnapshot.audioDownloadFailureCount=this.audioDownloadFailureCount,this.currentDiagnosticSnapshot.audioDownloadSuccessCount=this.audioDownloadSuccessCount,this.currentDiagnosticSnapshot.videoDownloadFailureCount=this.videoDownloadFailureCount,this.currentDiagnosticSnapshot.videoDownloadSuccessCount=this.videoDownloadSuccessCount,this.currentDiagnosticSnapshot.audioDownloadFailures=this.audioDownloadFailures,this.currentDiagnosticSnapshot.videoDownloadFailures=this.videoDownloadFailures,this.currentDiagnosticSnapshot.totalDownloadedBytes=this.totalDownloadedBytes,this.currentDiagnosticSnapshot.retryFrequency=this.getRetryFrequency(),this.currentDiagnosticSnapshot.averageDownloadBitrate=this.getAverageDownloadBitrate();const C=this.getDiagnosticWritableField();return Object.keys(C).forEach((g=>{this.currentDiagnosticSnapshot[g]=C[g]})),this.currentDiagnosticSnapshot}getDiagnosticWritableField(){return{streamUrl:this.currentDiagnosticSnapshot.streamUrl,streamId:this.currentDiagnosticSnapshot.streamId,streamingEventType:this.currentDiagnosticSnapshot.streamingEventType,playerControlsEnabled:this.currentDiagnosticSnapshot.playerControlsEnabled,streamDeliveryPipeline:this.currentDiagnosticSnapshot.streamDeliveryPipeline,retryCount:this.currentDiagnosticSnapshot.retryCount,totalPlayingTimeInSeconds:this.currentDiagnosticSnapshot.totalPlayingTimeInSeconds,bufferingRate:this.currentDiagnosticSnapshot.bufferingRate,videoTrackHistory:this.currentDiagnosticSnapshot.videoTrackHistory,videoTrackTotalDurations:this.currentDiagnosticSnapshot.videoTrackTotalDurations}}dispose(){this.unsubscribeFromPlayerBufferEvents()}registerForPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}unsubscribeFromPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}isP2PSdnUsed(){return!!this.sdnName()}sdnName(){const g="options_";return this.playerInstance[g]&&this.playerInstance[g].sdn&&this.playerInstance[g].sdn.name}getStreamType(g){let m="";return this.playerInstance&&(m=this.playerInstance.isLive()?"LIVE":"DVR"),""===m||"LIVE"===g&&m!==g?g||"":m}getCurrentAbsoluteTime(){return this.absoluteTimeOffsetEstimator?this.absoluteTimeOffsetEstimator.absoluteTimeOffset?this.absoluteTimeOffsetEstimator.absoluteTimeOffset+this.playerInstance.currentTime():this.playerInstance.currentTime():this.playerInstance.currentAbsoluteTime()??this.playerInstance.currentTime()}getCurrentAbsoluteTimeOffset(){return this.getCurrentAbsoluteTime()-this.playerInstance.currentTime()}getTotalDurationInSeconds(){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;return Number(g.toFixed(0))}onVideoDownloadCompleted(){this.videoDownloadSuccessCount++,this.addToList(this.videoDownloadLatencies,this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.videoDownloadBytes,this.playerVideoBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.videoDownloadBandwidths,8*this.playerVideoBuffer.downloadCompleted.totalBytes*1e3/this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerVideoBuffer.downloadCompleted.totalBytes}onAudioDownloadCompleted(){this.audioDownloadSuccessCount++,this.addToList(this.audioDownloadLatencies,this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.audioDownloadBytes,this.playerAudioBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.audioDownloadBandwidths,8*this.playerAudioBuffer.downloadCompleted.totalBytes*1e3/this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerAudioBuffer.downloadCompleted.totalBytes;const g=this.playerAudioBuffer.downloadCompleted.mediaDownload.bitrate;g!==this.lastAudioDownloadBitrate&&(this.lastAudioDownloadBitrate=g)}addToList(g,m,S){g.push(m),g.length>S&&g.shift()}onVideoDownloadError(){this.videoDownloadFailureCount++,this.addDownloadFailureInfo(this.playerVideoBuffer.downloadFailed,this.videoDownloadFailures)}onAudioDownloadError(){this.audioDownloadFailureCount++,this.addDownloadFailureInfo(this.playerAudioBuffer.downloadFailed,this.audioDownloadFailures)}addDownloadFailureInfo(g,m){const S={bitrate:g.mediaDownload.bitrate,errorCode:g.code,mediaTime:g.mediaDownload.mediaTime,message:g.message,timestamp:Date.now()};this.addToList(m,S,this.downloadFailuresLimit)}getAudioStreamData(){const g=this.playerInstance.currentAudioStreamList();if(g)try{const m=g.streams[g.enabledIndices[0]];return{bitrate:m.bitrate,codec:m.codec,enabled:m.enabled,name:m.name,language:m.language}}catch(g){return}}getVideoStreamData(){const g=this.playerInstance.currentVideoStreamList();if(g)try{const m=g.streams[g.selectedIndex],S=this.playerInstance.currentPlaybackBitrate(),mapTrackData=g=>({bitrate:g.bitrate,height:g.height,id:g.id,selectable:g.selectable,width:g.width}),v=m.tracks?m.tracks.map(mapTrackData).find((g=>g.bitrate===S)):null;return{codec:m.codec,name:m.name,currentTrack:v}}catch(g){return}}getLivePosition(){const g=this.playerInstance.buffered();if(0===g.length)return 0;let m=g.end(0);for(let S=1;S<g.length;S++)m=Math.max(m,g.end(S));return m}getAverageDownloadBitrate(){if(this.streamingStartedTimestamp&&this.totalDownloadedBytes){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;if(g>0)return 8*this.totalDownloadedBytes/g}return 0}getRetryFrequency(){const g=this.currentDiagnosticSnapshot.retryCount;if(this.streamingStartedTimestamp&&g){const m=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/6e4;if(m>0)return g/m}return 0}getAverageMeasuredBandwidth(){if(0===this.videoDownloadBandwidths.length)return null;let g=0;for(let m=0;m<this.videoDownloadBandwidths.length;m++)g+=this.videoDownloadBandwidths[m];return g/this.videoDownloadBandwidths.length}getAverageMeasuredVideoDownloadSize(){if(0===this.videoDownloadBytes.length)return null;let g=0;for(let m=0;m<this.videoDownloadBytes.length;m++)g+=this.videoDownloadBytes[m];return g/this.videoDownloadBytes.length}getPlayerCachedLength(){const g=this.playerInstance.buffered();let m=0;for(let S=0;S<g.length;S++)m+=g.end(S)-g.start(S);return m}getPlayerEdgeLatency(){const g=this.playerInstance.buffered();if(0===g.length)return 0;let m=g.end(0);for(let S=1;S<g.length;S++)m=Math.max(m,g.end(S));return m-this.playerInstance.currentTime()}}}function CaptionsControlToggleProviderF(){return class{constructor(g,m,S,v){this.player=g,this.toggleListener=m,this.config=S,this.diagnosticProvider=v,this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.isHtml5Tech="html5"===this.player.currentTechName()?.toLowerCase()}dispose(){this.unsubscribeFromTrackEvents(),this.player=null,this.toggleListener=null}initialize(){const g=this.getPlayerTextTracksAsArray();if(!this.config.controlsEnabled&&g.length>0)g[0].mode="showing";else for(let m=0;m<g.length;m++)g[m].mode="disabled";this.subscribeOnTrackEvents()}addCues(g){const m=this.player.getCurrentTextTrack();if(!m)return;const S=this.getCurrentAbsoluteTime()||1,v=this.getCurrentTime(),C=this.config.controlsEnabled?S-v:Math.max(S-v,0),_=this.isHtml5Tech?window.VTTCue:window.vttjs&&window.vttjs.VTTCue||window.VTTCue;for(let S=0;S<g.length;S++){const{start:v,end:E,text:T}=g[S],I=2,b=new _(Number((v-C).toFixed(I)),Number((E-C).toFixed(I)),T);b.size=100,!this.containsCue(m,b)&&m.addCue(b)}}clearCues(){const g=this.player.getCurrentTextTrack();if(g)try{if(g.activeCues&&g.removeCue)for(;g.activeCues.length>0;)g.removeCue(g.activeCues[0]);const m="setCues_";if(g.cues[m]){g.cues_&&(g.cues_.length=0),g.cues[m]([]);const S=Object.getOwnPropertyNames(g.cues);for(let m=0;m<S.length;m++)"length"!==S[m]&&"length_"!==S[m]&&"cues_"!==S[m]&&delete g.cues[S[m]]}}catch(g){this.config.logFn(`[clearCues]: ${g}`,"warn")}}showCaptions(g){this.config.logFn(`[CaptionsControl]: showCaptions(${g})`),g?this.show():this.hide()}hide(){this.previouslyVisibleTextTrack=this.player.getCurrentTextTrack(),this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="disabled"),this.player.captionToggle&&this.player.captionToggle.hide&&this.player.captionToggle.hide(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.hide&&this.player.MoreOptionscaptionSubtitleButton.hide(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.hide&&this.player.MoreOptionscaptionSettingsButton.hide()}show(){this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="showing"),this.player.captionToggle&&this.player.captionToggle.show&&this.player.captionToggle.show(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.show&&this.player.MoreOptionscaptionSubtitleButton.show(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.show&&this.player.MoreOptionscaptionSettingsButton.show()}subscribeOnTrackEvents(){const g=this.player.textTracks(),m="addEventListener";g&&g[m]&&(this.config.controlsEnabled&&g[m]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&g[m]("addtrack",this.onAddTrack.bind(this)))}unsubscribeFromTrackEvents(){const g=this.player.textTracks(),m="removeEventListener";g&&g[m]&&(this.config.controlsEnabled&&g[m]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&g[m]("addtrack",this.onAddTrack.bind(this)))}onTextTrackChanged(){const g=this.player.getCurrentTextTrack();if(!g||!this.currentTextTrack||this.currentTextTrack.label!==g.label||this.currentTextTrack.mode!==g.mode){if(g||this.currentTextTrack){const m=!!g&&"showing"===g.mode,S=this.getCulture(g||this.currentTextTrack),v=this.getCurrentTime();this.toggleListener.captionsToggled(m,S,v),this.config.logFn(`[CaptionsControl]: track changed: culture '${S}', timestamp '${v}'`)}this.currentTextTrack=g}}onAddTrack(g){const m=g?.track;"captions"===m?.kind&&!m.label&&!m.id&&(this.player?.textTracks_?.removeTrack_(m),this.config.logFn("[CaptionsControl]: removing default empty text track"))}getCurrentTime(){return this.isHtml5Tech?this.player.currentTime():(this.config.controlsEnabled?this.player.currentTime():this.player.currentMediaTime())||1}getCurrentAbsoluteTime(){return this.diagnosticProvider.getCurrentAbsoluteTime()}getCulture(g){if(!g)return"";if(g.id){const m=g.id.split("_")[1];if(m)return m}return""}getPlayerTextTracksAsArray(){const g=this.player.textTracks();return g&&g["tracks_"]||[]}containsCue(g,m){return Array.from(g?.cues||[]).some((g=>this.areCueEquals(g,m)))}areCueEquals(g,m){function getCueField(g){return{start:g.start?g.start:g.startTime,end:g.end?g.end:g.endTime,text:g.text}}const S=getCueField(g),v=getCueField(m);return S.start===v.start&&S.end===v.end&&S.text===v.text}}}function initIFrame(){const g=IFrameMessageHandlerF(),m=AmpCommunicationHandlerF(),S=new g,v=new m(S,document.body);S.registerObserver(v)}function buildAmpEmbeddedSrc(){let g=`(${initIFrame.toString()})();`;return g+=AmpPlayerF.toString()+";",g+=IFrameMessageHandlerF.toString()+";",g+=AmpCommunicationHandlerF.toString()+";",g+=CaptionsControlToggleProviderF.toString()+";",g+=AmpDiagnosticProviderF.toString()+";",g+=HlsAbsoluteTimeOffsetEstimatorF.toString()+";",g+=HlsFileParserF.toString()+";",g+="//# sourceURL=TsCallingAmpPlayer.js",g}var gt=class{sendMsg(g){this.peer.onMsg(g)}registerObserver(g){this.observer=g}onMsg(g){this.observer&&this.observer.processMessage(g)}connect(g){this.peer=g}dispose(){this.peer=null,this.observer=null}},pt=class{constructor(g){this.container=g}get contextWindow(){return this.container.ownerDocument.defaultView}sendMsg(g){this.iframe?.contentWindow?.postMessage(g,"*")}registerObserver(g){this.observer=g}dispose(){this.contextWindow&&this.contextWindow.removeEventListener("message",this.processMsg),this.iframe&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe),this.iframe=null}initializeAmpIframe(g){const m=this.initializeIframe();return this.setAmpIframeContent(g),this.finalizeIframe(m)}initializeIframe(){const g=defer();return this.iframe=this.container.ownerDocument.createElement("iframe"),this.iframe.id="player-iframe",this.iframe.sandbox.add("allow-scripts"),this.iframe.allowFullscreen=!0,this.iframe.allow="camera; microphone; autoplay",this.iframe.style.height="100%",this.iframe.style.width="100%",this.iframe.style.border="none",this.iframe.onload=()=>{g.resolve()},this.iframe.onerror=()=>{g.reject("iframe load failed")},g}finalizeIframe(g){return this.container.appendChild(this.iframe),this.processMsg=this.processMsg.bind(this),this.contextWindow.addEventListener("message",this.processMsg),g.promise}processMsg(g){if("null"===g.origin&&g.source===this.iframe.contentWindow&&this.observer)if("RequestIceCandidates"===g.data)this.observer.processMessage({msgType:"Command",cmd:"getIceCandidates",args:[]});else this.observer.processMessage(g.data)}setAmpIframeContent(g){const m=buildAmpEmbeddedSrc(),S=`\n            <html class style='height: 100%; width: 100%; overflow: hidden'>\n            <head></head>\n            <body class style='height: 100%; width: 100%; margin: 0px'>\n                ${g?`<script nonce='${g}'> ${m}<\/script>`:`<script> ${m}<\/script>`}\n            </body>\n            </html>\n        `;this.iframe.srcdoc=S}};async function setupAmpAndBuildPipe(g,m,S){if(0===m){const m=new gt,S=new gt;return m.connect(S),S.connect(m),S.registerObserver(new ht(S,g)),m}if(1===m){const m=new pt(g);return await m.initializeAmpIframe(S),m}throw new Error(`Unsupported communication type ${m}`)}var mt=class extends Ge{constructor(g){super(g),this.logger=g,this.resultsMap=new Map,this.on("log",((g,m)=>{this.logger[g](m)}))}async initialize(g,m,S,v){const C={config:S.config,playerConfig:S.playerConfig},_=S.playerConfig?.nonce||"";this.pipe=await setupAmpAndBuildPipe(g,S.config.loadType,_),this.pipe.registerObserver(this),await this.message("configure").send(m,C,v)}message(g){return{send:this.fromMessage(((...m)=>this.sendMessageImpl(g,...m)))}}dispose(){super.dispose(),this.pipe.sendMsg(this.buildMsg("dispose")),this.pipe.dispose()}processMessage(g){let m;switch(g.msgType){case"CommandResult":m=this.getDeferred(g.cmd.toString()),m&&(g.error?(m.reject(g.error),this.logger.warn(`remote command failed: ${String(g.cmd)}, ${g.error}`)):g.result?m.resolve(g.result):m.resolve(),this.processCommandResult(g),this.resultsMap.delete(g.cmd.toString()));break;case"PlayerNotification":{const m=this.event(g.name);m.raise.apply(m,g.args);break}case"Command":this.processCommand(g).catch((m=>this.logger.warn(`error while processing command: ${JSON.stringify(g)}: ${m}`)));break;default:this.logger.warn(`unexpected message received: ${JSON.stringify(g)}`)}}async processCommand(g){if("getIceCandidates"===g.cmd.toString())await this.message("getIceCandidates").send();else this.logger.warn(`unsupported command received: ${JSON.stringify(g)}`)}processCommandResult(g){if("getIceCandidates"===g.cmd.toString())this.pipe.sendMsg({topic:"RequestIceCandidates",candidates:g.result});else this.logger.debug(`ignoring command result for: ${JSON.stringify(g)}`)}fromMessage(g){return g}sendMessageImpl(g,...m){return this.pipe.sendMsg(this.buildMsg(g,m)),this.waitForCompletion(g.toString())}buildMsg(g,m){return{msgType:"Command",cmd:g,args:m}}getDeferred(g){return this.resultsMap.get(g)}waitForCompletion(g){const m=this.getDeferred(g);m&&m.reject(new Error(`function ${g} is invoked again, before previous call is completed`));const S=defer();return this.resultsMap.set(g,S),S.promise}},ft=class extends Ge{constructor(g,m){super(),this.player=g,this.logger=m,this.playerSubs=[],this.subscribeForPlayerEvents()}get isRendering(){return!!this.player&&this.player.isRendering()}get streamSize(){return this.player?this.player.getStreamSize():{width:0,height:0}}get rendererType(){return 0}get frameType(){return-1}dispose(){this.stopPlayer(),super.dispose()}captions(){return this.player.getCaptionsControl()}getStats(){throw new Error("Method not implemented.")}setScalingMode(g,m){throw new Error("Method not implemented.")}captureFrame(g,m){throw new Error("Method not implemented.")}stopPlayer(){const g=this.player;this.player=null,g&&(this.logger.info("stopPlayer"),this.unsubscribeFromPlayerEvents(),g.stop())}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("fullscreenToggled",(g=>this.onFullScreenToggled(g)))),this.playerSubs.push(this.player.on("captionsToggled",((g,m,S)=>this.onCaptionsToggled(g,m,S))))}unsubscribeFromPlayerEvents(){for(const g of this.playerSubs)g.dispose();this.playerSubs=[]}onFullScreenToggled(g){this.event("fullScreenToggled").raise(g)}onCaptionsToggled(g,m,S){this.logger.info(`Turned captions ${g?"ON":"OFF"} for culture [${m}] at player time [${S}]`),this.event("captionsToggled").raise(g,m,S)}},St=class{constructor(g,m){this.player=g,this.availableCultures=m,this.selectedCulture="",this.disposable=this.player.on("captionsToggled",((g,m,S)=>{this.selectedCulture=g?m:""}))}async addCues(g){await this.player.message("addCues").send(g)}async clearCues(){await this.player.message("clearCues").send()}async showCaptions(g){await this.player.message("showCaptions").send(g)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.disposable.dispose(),this.player=null}};function generateGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(g=>{const m=16*Math.random()|0;return("x"===g?m:3&m|8).toString(16)}))}var vt=[2097152,2097552,2097556,2097557,2097564,2097652,2097654,2097655,2097656,2097752,3145728,4194305,4194306,4194307,4194308,4194309,5242880,5242881,5242882,5242884,5242885,5242886],Ct=2097753,_t=class extends Ge{constructor(g,m,S){super(),this.logger=g,this.liveStreamStatistic=m,this.configProvider=S,this.playerState="Destroyed",this.retryCount=0,this.captionsTimestamp=0,this.isSwitchStreamingUrlOngoing=!1,this.streamingUrlSwitchCount=0,this.isPlaybackUnsupported=!1,this.id=generateGuid(),this.logger.info(`AmpLiveStreamPlayer created: ID: ${this.id}`)}get playerId(){return this.id}async configure(g){if(!isStreamValid(g.stream)&&!isStreamValid(g.altStream))return void this.logger.error("Invalid Live Stream configuration provided: no valid primary or alternative stream");this.logger.info("Live Stream configuration provided"),this.liveStreamOptions=g;const m=isStreamValid(g.stream)?g.stream:g.altStream;if(this.playerInstance&&!this.isPlaybackUnsupported){try{await this.playerInstance.message("configure").send(g)}catch(g){const m=stringifyObject(g);this.logger.error(`configure failed: ${m}`)}await this.handleStreamInfoUpdate(m)}else this.selectedStreamDetails=m}async loadPlayer(g){if(this.playerInstance)return this.logger.error("playerLoadFailed: cannot load a player while current one is still active"),{setupSucceeded:!1,playerSetupError:{errorType:"MultiplePlayerLoad",errorMessage:"cannot load a player while current one is still active"}};if(!this.liveStreamOptions||!this.selectedStreamDetails||!isStreamValid(this.selectedStreamDetails))return this.logger.error("playerLoadFailed: empty/invalid primary and alternate stream info configured"),{setupSucceeded:!1,playerSetupError:{errorType:"InvalidStream",errorMessage:"empty/invalid primary and alternate stream info configured"}};let m;this.playerInstance=new mt(this.logger.createChild("AmpPlayerWrapper")),this.playerInstance.on("stateChanged",((g,m)=>this.ampStateChanged(g,m))),this.playerInstance.on("captionsToggled",((g,m,S)=>this.captionsToggled(g,m,S))),this.playerInstance.on("statsUpdated",(g=>this.liveStreamStatistic.registerStatsUpdated(g))),await this.playerInstance.initialize(g,this.liveStreamOptions,this.configProvider,this.id),this.liveStreamStatistic.registerPlayerLoadAttempt(),this.loadSucceeded=!1,this.liveStreamStatistic.registerEventLoadAttempt("LoadScript"),this.srcLoadPromise||(this.srcLoadPromise=this.playerInstance.message("loadPlayerScript").send());try{m=await this.srcLoadPromise}catch(g){const S=stringifyObject(g);return this.logger.error(`playerLoadFailed: player scripts load failed: ${S}`),this.liveStreamStatistic.registerEventLoadFailed("LoadScript",`Load Script failed: ${g}`),this.liveStreamStatistic.registerPlayerLoadFailed(`script load failed: ${m}`),this.srcLoadPromise=null,{setupSucceeded:!1,playerSetupError:{errorType:"PlayerScriptLoadFailed",errorMessage:S}}}this.liveStreamStatistic.registerEventLoadSucceeded("LoadScript"),await this.tryLoadSdnPlugin(),this.liveStreamStatistic.registerEventLoadAttempt("CreateAmp");try{await this.playerInstance.message("createAmp").send()}catch(g){const S=stringifyObject(g);return this.logger.error(`playerLoadFailed: createAmp failed: ${S}`),this.liveStreamStatistic.registerEventLoadFailed("CreateAmp",`createAmp failed: ${g}`),this.liveStreamStatistic.registerPlayerLoadFailed(`create amp failed ${S}, script load: ${m}`),{setupSucceeded:!1,playerSetupError:{errorType:"PlayerInitializationFailed",errorMessage:S}}}this.liveStreamStatistic.registerEventLoadSucceeded("CreateAmp");try{return await this.setPlayerSource(this.selectedStreamDetails),this.loadSucceeded=!0,this.logger.info(`loadPlayer succeeded: ${this.loadSucceeded}`),this.liveStreamStatistic.registerPlayerLoadSucceeded(m),this.playerState="Initialized",{setupSucceeded:this.loadSucceeded}}catch(g){const S=stringifyObject(g);return this.loadSucceeded=!1,this.logger.error(`loadPlayer succeeded: ${this.loadSucceeded}: setSource failed: ${S}`),this.liveStreamStatistic.registerPlayerLoadFailed(`setPlayerSource failed; script load: ${m}`),{setupSucceeded:this.loadSucceeded,playerSetupError:{errorType:"SetSourceFailed",errorMessage:S}}}}getRenderer(){return!this.renderer&&this.playerInstance&&(this.renderer=new ft(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}stop(){this.destroy("PlayerStopped")}getPlaybackState(){return this.playerState}getCaptionsTimestamp(){return this.captionsTimestamp}getCaptionsControl(){if(!this.captionsControl&&this.playerInstance){const g=this.liveStreamOptions.supportedSubtitleLanguages?this.liveStreamOptions.supportedSubtitleLanguages.map((g=>g.culture)):[];this.captionsControl=new St(this.playerInstance,g)}return this.captionsControl}getStreamSize(){const g=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return g?{width:g.mediaWidth,height:g.mediaHeight}:{width:0,height:0}}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}ampStateChanged(g,m){switch(g){case"error":return this.handlePlaybackError(m);case"canplaythrough":return this.onCanplaythrough();case"play":return this.onPlay();case"playing":return this.onPlaying();case"pause":return this.onPause();case"resume":return this.onResume();case"start":return this.onStart();case"ended":return this.onEnded();case"seeking":return this.onSeeking();case"seeked":return this.onSeeked(m);case"loadedmetadata":return this.onMetadataLoaded();case"waiting":return this.onWaiting();case"playbackbitratechanged":return this.onPlaybackBitrateChanged(m);case"downloadbitratechanged":return this.onDownloadBitrateChanged(m);case"fullscreenchange":return this.onFullscreenChange(m);case"potentialMediaFreeze":return this.onPotentialMediaFreeze();case"mute":return this.onMute();case"unmute":return this.onUnmute();case"volumechange":return this.onVolumeChange(m);case"loadstart":return this.onLoadStart();case"loadeddata":return this.onLoadedData();case"UserInitiatedSeek":return this.onUserInitiatedSeek(m);default:this.logger.warn(`Unknown amp event ${g}`)}}onUserInitiatedSeek(g){this.liveStreamStatistic.registerUserInitiatedSeek(g)}captionsToggled(g,m,S){this.event("captionsToggled").raise(g,m,S),this.liveStreamStatistic.registerCaptionToggle(g,m,S)}async tryLoadSdnPlugin(){if(this.sdnPluginLoadPromise)return void this.raiseSdnPluginSkippedEvent("SDN plugin already loaded");if(!this.liveStreamOptions.sdn)return void this.raiseSdnPluginSkippedEvent("No SDNs configured in liveStreamOptions");if(!this.configProvider.config.allowSdnPlugins)return void this.raiseSdnPluginSkippedEvent("Client configured to not allow SDN plugins");switch(this.liveStreamOptions.sdn.name){case"hive":case"kollective":case"ramp":case"peer5":break;default:return this.logger.warn(`unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`),void this.liveStreamStatistic.registerSdnPluginLoad(this.liveStreamOptions.sdn.name,!1,`Unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`)}let g;this.liveStreamStatistic.registerEventLoadAttempt("SdnPluginLoad");try{this.sdnPluginLoadPromise=this.playerInstance.message("tryLoadSdnPlugin").send(),await this.sdnPluginLoadPromise}catch(m){g=stringifyObject(m),this.sdnPluginLoadPromise=void 0,this.logger.error(`loadSdnPlugin failed: ${g}`),this.liveStreamStatistic.registerEventLoadFailed("SdnPluginLoad",g),this.event("sdnPluginLoadFailed").raise(g)}this.liveStreamStatistic.registerEventLoadSucceeded("SdnPluginLoad",this.liveStreamOptions.sdn.name)}raiseSdnPluginSkippedEvent(g){this.logger.warn(`skipping SDN plugin load: ${g}`),this.event("sdnPluginLoadSkipped").raise(g)}async setPlayerSource(g){if(!g)throw this.logger.error("setPlayerSource: streamDetails is undefined"),new Error("setPlayerSource: streamDetails is undefined");if(!this.playerInstance)throw this.logger.error("setPlayerSource: playerInstance is null"),new Error("playerInstance is null");this.logger.info(`setPlayerSource: AMP source set to: [${g.url}]`),this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;try{this.logger.info("setPlayerSource: src changed"),this.selectedStreamDetails=g,this.liveStreamStatistic.registerSetSourceAttempt(g.url),await this.playerInstance.message("setSource").send(g),this.liveStreamStatistic.registerSetSourceSucceeded()}catch(g){const m=stringifyObject(g);throw this.logger.error(`setPlayerSource: failed with error [${m}]`),this.liveStreamStatistic.registerSetSourcedFailed(m),g}}async handleStreamInfoUpdate(g){this.loadSucceeded&&g.url!==this.selectedStreamDetails.url?await this.setPlayerSource(g):this.loadSucceeded&&this.playerInstance&&this.getCurrentTime()>0&&this.setPlaybackState("Start")}async switchStreamingUrl(g,m){if(this.streamingUrlSwitchCount>=this.configProvider.config.ampSettings.streamingUrlSwitchMaxCount||!(0,dt.includes)(this.configProvider.config.ampSettings.errorCodesEligibleForStreamingUrlSwitch,g)&&!m)return!1;const S=this.selectedStreamDetails.url===this.liveStreamOptions.stream?.url,v=S?this.liveStreamOptions.altStream:this.liveStreamOptions.stream;return isStreamValid(v)?(this.isSwitchStreamingUrlOngoing=!0,this.streamingUrlSwitchCount++,this.setPlayerSource(v).then((()=>!0)).catch((()=>!1))):(this.logger.error(`Stream to switch (${S?"alternative":"primary"}) is not valid`),!1)}destroy(g){this.srcLoadPromise=null,this.sdnPluginLoadPromise=null,this.renderer&&(this.renderer.dispose(),this.renderer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.liveStreamStatistic.registerPlayerDestroyed(g),this.playerInstance.dispose(),this.playerInstance=null,this.setPlaybackState("Destroyed"))}getCurrentTime(){const g=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return g&&g.currentPlayPosition||0}onCanplaythrough(){this.setPlaybackState("Ready")}onPlay(){(this.retryCount>0||this.lastKnownPlayTime)&&(this.logger.info(`Playing after retry count ${this.retryCount}, Setting current time to ${this.lastKnownPlayTime}`),this.playerInstance.message("setPlayTime").send(this.lastKnownPlayTime),this.retryCount=0,this.lastKnownPlayTime=void 0),this.setPlaybackState("Play")}onPlaying(){this.setPlaybackState("Playing")}onPause(){this.setPlaybackState("Paused")}onResume(){this.setPlaybackState("Resume")}onStart(){this.logger.info(`Playback started, retry count: ${this.retryCount}`),this.setPlaybackState("Start"),this.isSwitchStreamingUrlOngoing&&(this.logger.info(`Playback started, switch count: ${this.streamingUrlSwitchCount}`),this.event("urlSwitched").raise(this.selectedStreamDetails===this.liveStreamOptions.altStream),this.isSwitchStreamingUrlOngoing=!1)}onEnded(){this.setPlaybackState("Ended")}onSeeking(){this.setPlaybackState("Seeking")}onSeeked(g){this.captionsTimestamp=g.captionsTimestamp,this.setPlaybackState("Seeked")}onMetadataLoaded(){this.setPlaybackState("LoadedMetadata")}onWaiting(){this.setPlaybackState("Buffering")}onLoadedData(){this.setPlaybackState("LoadedData")}onLoadStart(){this.setPlaybackState("LoadStart")}setPlaybackState(g){this.playerState=g,this.logger.debug(`playback state changed: ${g}`),this.liveStreamStatistic.registerPlaybackStateChanged(g),this.event("playbackStateChanged").raise()}onPlaybackBitrateChanged(g){this.liveStreamStatistic.registerPlaybackBitratechanged(g.bitrate)}onDownloadBitrateChanged(g){this.liveStreamStatistic.registerDownloadBitratechanged(g.bitrate)}onFullscreenChange(g){this.logger.debug(`fullscreenchange, isFullscreen=${g.isFullscreen}`),this.event("fullscreenToggled").raise(g.isFullscreen),this.liveStreamStatistic.registerFullScreenChange(g.isFullscreen)}onPotentialMediaFreeze(){this.logger.warn("Player detected a potential media freeze"),this.liveStreamStatistic.registerPotentialMediaFreeze()}onMute(){this.liveStreamStatistic.registerMute(!0)}onUnmute(){this.liveStreamStatistic.registerMute(!1)}onVolumeChange(g){this.liveStreamStatistic.registerVolumeChange(g.value)}stringifyPlayerError(g){return JSON.stringify(g,(function(g,m){return"errorCode"===g?m.toString(16):m}))}async handlePlaybackError(g){const m=4194307;this.playerState="Error";const S=this.stringifyPlayerError(g);if(this.logger.info(`Playback error ${S}`),!g.errorCode&&null==g.fatal)return void this.logger.error("onError: error details are not available");if((g.errorCode&m)===m)return this.isPlaybackUnsupported=!0,this.raisePlaybackError("UnsupportedPlatform",S),void this.destroy("PlaybackError");this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;const v=g.errorCode,C=268435455&v;if(this.logger.error(`onError: errorCode: 0x${v.toString(16)}, errorCodeExcludingTech: 0x${C.toString(16)}, message: ${g.message}`),this.retryCount<this.configProvider.config.maxRetryCount&&(!1===g.fatal||-1!==(0,dt.indexOf)(vt,C)))setTimeout((async()=>{this.logger.info(`Retry loading stream because of error code: 0x${v.toString(16)}`),this.retryCount++,this.raisePlaybackError("PlaybackRetried",S),this.setPlayerSource(this.selectedStreamDetails)}),this.configProvider.config.ampSettings.sourceResetTimeoutInMs);else{await this.switchStreamingUrl(C,g.fatal)?this.configProvider.config.ampSettings.resetStreamingUrlSwitchCount&&(this.streamingUrlSwitchCount=0):(C===Ct||g.message?.includes(Ct.toString(16))?this.raisePlaybackError("NetworkError",S):this.raisePlaybackError("PlaybackError",S),this.destroy("PlaybackError"))}}raisePlaybackError(g,m){this.liveStreamStatistic.registerPlaybackError(g,m),this.event("playbackError").raise(g,m)}},yt=class extends Ge{constructor(g,m){super(),this.logger=g,this.telemetryLogger=m,this.playbackState="Destroyed",this.playerSubs=[],this.isFinalTelemetrySent=!1,this.captionsTimestamp=0}initialize(g,m,S,v){this.getTelemetryReportFn=g,this.getSnapshotTelemetryReportFn=m,this.disposePlayerFn=S,this.releaseFn=v}startTelemetryGathering(){this.statsSub=window.setTimeout((async()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs);let g,m;1===this.configProvider.playerConfig.playerType?(g=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetry||this.configProvider.config.sendSnapshotTelemetry,m=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs||this.configProvider.config.sendSnapshotTelemetryEveryMs):(g=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetry||this.configProvider.config.sendSnapshotTelemetry,m=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs||this.configProvider.config.sendSnapshotTelemetryEveryMs),g&&(this.diagSub=window.setInterval((async()=>{this.sendSnapshotTelemetry()}),m))}stop(){this.clearPlayerEventSubscribers(),this.destroyPlayer()}destroyPlayer(){this.renderer&&(this.renderer.dispose(),this.renderer=null),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.disposePlayerFn(),this.sendFinalTelemetry(),this.releaseFn()}getPlaybackState(){return this.playbackState}getCaptionsTimestamp(){return this.captionsTimestamp}sendFinalTelemetry(){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0))}sendTelemetry(g){if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const m={...this.getTelemetryReportFn(),isFinal:g,threadId:this.threadId,tsCallingVersion:getTsCallingVersion(),correlationId:this.streamOptions.correlationId};this.logger.debug("generated live stream report: ",m),this.telemetryLogger.sendEvent({eventName:"live_events",props:m})}else this.logger.info("telemetry not sent")}sendSnapshotTelemetry(){if(this.telemetryLogger){const g={...this.getSnapshotTelemetryReportFn(),isFinal:!1,threadId:this.threadId,tsCallingVersion:getTsCallingVersion(),correlationId:this.streamOptions.correlationId};this.logger.debug("sending snapshot telemetry: ",g),this.telemetryLogger.sendEvent({eventName:"live_events",props:g})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set")}clearPlayerEventSubscribers(){for(const g of this.playerSubs)g.dispose();this.playerSubs=[]}onPlaybackSeeked(g){this.captionsTimestamp=g}onUrlSwitched(g){this.event("urlSwitched").raise(g)}onSdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}onSdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}onPlaybackStarted(){this.event("playbackStarted").raise()}},Et=__toESM(ie()),Tt=class extends yt{constructor(g,m,S){super(g,S),this.eventHandler=new It,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=m;const v=this.createHydraPlayerSettings(m);this.hydraPlayer=new Et.HlsHydraPlayer(v,this.eventHandler)}async configure(g){if(this.streamOptions=g,this.threadId=g.threadId,this.playerLoaded){const m=this.createHydraStreamOptions(g);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",m)}}async loadPlayer(g){if(!await this.hydraPlayer.setup(g))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const g=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",g)}else this.logger.warn("No stream options configured before Hydra player loaded");const m=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return m.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(m)}onCaptionsToggled(g,m,S){this.captionsControl&&this.captionsControl.toggleCaptions(g,m),this.event("captionsToggled").raise(g,m,S)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){if(!this.captionsControl&&this.hydraPlayer){const g=this.streamOptions?.supportedSubtitleLanguages?this.streamOptions.supportedSubtitleLanguages.map((g=>g.culture)):["en","es"];this.captionsControl=new bt(this.hydraPlayer,g)}return this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(g=>{this.onPlaybackStateChanged(g)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((g,m)=>{this.onPlaybackError(g,m)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(g=>{this.onPlaybackSeeked(g)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(g=>{this.onUrlSwitched(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(g=>{this.onSdnPluginLoadSkipped(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(g=>{this.onSdnPluginLoadFailed(g)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("captionsToggled",((g,m,S)=>{this.onCaptionsToggled(g,m,S)}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(g=>{this.onStatsUpdated(g)}))),this.playerSubs.push(this.eventHandler.on("log",((g,m)=>{this.onLog(g,m)})))}createHydraPlayerSettings(g){return{hlsJsSources:g.playerConfig?.src,hydraRuntimeFetchTimeout:g.playerConfig?.hydraRuntimeFetchTimeout,capturePlayerLogs:g.config.capturePlayerLogs,allowSdnPlugins:g.config.allowSdnPlugins,debugLogging:g.config.debug??!1,muteVideo:g.playerConfig?.muteVideo??!1,videoLang:g.playerConfig?.lang,videoElementStyles:g.playerConfig?.styles,maxPlayerDiagnosticsCount:g.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:g.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:g.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:g.config.hlsSettings.maxPlayerExperimentalEvents,maxRetryCount:g.config.maxRetryCount,playerTelemetryTickMs:g.config.playerTelemetryTickMs,removeEmptyDefaultTextTrack:g.config.removeEmptyDefaultTextTrack,maxRetryCountForLoadingResources:g.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:g.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:g.config.hlsSettings.maxStreamConnectionResultsLogCount,maxAbsoluteTimeOffsetEstimationResultsLogCount:g.config.hlsSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount,skipNonce:g.config.hlsSettings.skipNonce,configIds:g.configIds,estimateAbsoluteTime:g.config.hlsSettings.estimateAbsoluteTime,playlistInitialSequenceNumber:g.config.hlsSettings.playlistInitialSequenceNumber,timeoutForSwitchingUrl:g.config.hlsSettings.timeoutForSwitchingUrl,hlsConfig:g.config.hlsSettings.hlsConfig,logHlsJsEvents:g.config.hlsSettings.logHlsJsEvents,logHlsJsEventsEveryMs:g.config.hlsSettings.logHlsJsEventsEveryMs,switchingPolicy:g.config.hydraPlayerHlsSettings?.ecsSettings?.switchingPolicy,enableUuidTrace:g.config.hlsSettings.enableUuidTrace,thaScript:g.config.hlsSettings.thaScript,enableOffsetComputeBasedOfStreamTime:g.config.hlsSettings.enableOffsetComputeBasedOfStreamTime,stopCrash:g.config.stopCrash,stopTerminating:g.config.hlsSettings.stopTerminating,stallDetectionPolicy:g.config.hydraPlayerHlsSettings?.ecsSettings?.stallDetectionPolicy,playerRuntimeJsUrls:g.config.hydraPlayerHlsSettings?.runtimeUrls??g.playerConfig.hydraPlayerWebSdkUrls,disableSandbox:g.config.hlsSettings.disableSandbox,ecsSettings:g.config.hydraPlayerHlsSettings?.ecsSettings}}createHydraStreamOptions(g){let m=Et.HydraStreamingEventType.TLE;return m=g.streamingEventType?this.convertStreamingEventType(g.streamingEventType):g.overflow?Et.HydraStreamingEventType.Overflow:Et.HydraStreamingEventType.TLE,{stream:{urls:g.stream.hlsUrls?g.stream.hlsUrls:[g.stream.url],keyAuthorizationToken:g.stream.keyAuthorizationToken,keyDeliveryUrl:g.stream.keyDeliveryUrl,sdnContext:g.stream.sdnContext,streamDeliveryPipeline:g.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.stream.streamDeliveryPipeline):void 0},altStream:g.altStream?{urls:g.altStream.hlsUrls?g.altStream.hlsUrls:[g.altStream.url],keyAuthorizationToken:g.altStream.keyAuthorizationToken,keyDeliveryUrl:g.altStream.keyDeliveryUrl,sdnContext:g.altStream.sdnContext,streamDeliveryPipeline:g.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.altStream.streamDeliveryPipeline):void 0}:void 0,supportedSubtitleLanguages:g.supportedSubtitleLanguages,streamingEventType:m,allowPlayerControls:g.allowPlayerControls,sdn:g.sdn?{name:g.sdn.name,url:g.sdn.url,plugin:g.sdn.plugin}:void 0,thaContext:g.thaContext?{eventId:g.thaContext.eventId,organizer:{userId:g.thaContext.organizer?.userId,tenantId:g.thaContext.organizer?.tenantId},attendee:{userId:g.thaContext.attendee?.userId,tenantId:g.thaContext.attendee?.tenantId},coOrganizers:g.thaContext.coOrganizers}:void 0}}convertStreamDeliveryPipeline(g){switch(g){case"AMS":return Et.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return Et.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return Et.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${g} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(g){switch(g){case"TLE":return Et.HydraStreamingEventType.TLE;case"Overflow":return Et.HydraStreamingEventType.Overflow;case"TownHall_Basic":return Et.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return Et.HydraStreamingEventType.TownHallPremium;case"TownHall":return Et.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${g} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(g){return{setupSucceeded:g.setupSucceeded,playerSetupError:g.playerSetupError?{errorType:this.convertHydraPlayerSetupError(g.playerSetupError.errorType),errorMessage:g.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(g){switch(g){case Et.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case Et.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case Et.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case Et.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new ft(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(g){this.playerStats=g}getStats(){return this.playerStats}onLog(g,m){this.logger[g](m)}onPlaybackStateChanged(g){try{this.playbackState=this.convertHydraPlaybackState(g),this.event("playbackStateChanged").raise()}catch(g){this.logger.warn(`Not handling playback state changed event: ${stringifyObject(g)}`)}}convertHydraPlaybackState(g){switch(g){case Et.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case Et.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case Et.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case Et.HydraPlayerPlaybackState.Start:return"Start";case Et.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case Et.HydraPlayerPlaybackState.Play:return"Play";case Et.HydraPlayerPlaybackState.Playing:return"Playing";case Et.HydraPlayerPlaybackState.Pause:return"Paused";case Et.HydraPlayerPlaybackState.Waiting:return"Buffering";case Et.HydraPlayerPlaybackState.Seeking:return"Seeking";case Et.HydraPlayerPlaybackState.Seeked:return"Seeked";case Et.HydraPlayerPlaybackState.Ended:return"Ended";case Et.HydraPlayerPlaybackState.Error:return"Error";case Et.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case Et.HydraPlayerPlaybackState.Initialized:return"Initialized";case Et.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${g} to PlaybackState`)}}onPlaybackError(g,m){try{const S=this.convertHydraPlaybackErrorType(g);this.event("playbackError").raise(S,m)}catch(g){this.logger.warn(`Not handling playback error event: ${stringifyObject(g)}`)}}convertHydraPlaybackErrorType(g){switch(g){case Et.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case Et.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case Et.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case Et.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case Et.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${g} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null)}},It=class extends Ge{constructor(){super()}playbackStateChanged(g){this.event("playbackStateChanged").raise(g)}playbackSeeked(g){this.event("playbackSeeked").raise(g)}log(g,m){this.event("log").raise(g,m)}playbackError(g,m){this.event("playbackError").raise(g,m)}captionsToggled(g,m,S){this.event("captionsToggled").raise(g,m,S)}urlSwitched(g){this.event("urlSwitched").raise(g)}sdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}sdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}statsUpdated(g){this.event("statsUpdated").raise(g)}playbackStarted(){this.event("playbackStarted").raise()}},bt=class{constructor(g,m){this.hydraPlayer=g,this.availableCultures=m,this.selectedCulture=""}async addCues(g){const m=this.convertCues(g);await this.hydraPlayer.callPlayerApi("addHydraPlayerCues",m)}convertCues(g){const m=[];return g.forEach((g=>{m.push({start:g.start,end:g.end,text:g.text})})),m}async clearCues(){await this.hydraPlayer.callPlayerApi("clearHydraPlayerCues")}async showCaptions(g){await this.hydraPlayer.callPlayerApi("showHydraPlayerCaptions",g)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.hydraPlayer=null}toggleCaptions(g,m){this.selectedCulture=g?m:""}},At=__toESM(ne()),Rt=class extends yt{constructor(g,m,S){super(g,S),this.eventHandler=new Mt,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=m;const v=this.createHydraPlayerSettings(m);this.hydraPlayer=new At.UmsHydraPlayer(v,this.eventHandler)}get tracks(){return this.trackInfo}async configure(g){if(this.streamOptions=g,this.threadId=g.threadId,this.playerLoaded){const m=this.createHydraStreamOptions(g);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",m)}}async loadPlayer(g){if(!await this.hydraPlayer.setup(g))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const g=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",g)}else this.logger.warn("No stream options configured before Hydra player loaded");const m=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return m.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(m)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){return!this.captionsControl&&this.hydraPlayer&&(this.captionsControl=new Pt(this.hydraPlayer,this.logger.createChild("CaptionsControl"))),this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(g=>{this.onPlaybackStateChanged(g)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((g,m)=>{this.onPlaybackError(g,m)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(g=>{this.onPlaybackSeeked(g)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(g=>{this.onUrlSwitched(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(g=>{this.onSdnPluginLoadSkipped(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(g=>{this.onSdnPluginLoadFailed(g)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(g=>{this.onStatsUpdated(g)}))),this.playerSubs.push(this.eventHandler.on("trackListUpdated",(g=>{this.onTrackListUpdated(g)}))),this.playerSubs.push(this.eventHandler.on("trackSelected",(g=>{this.onTrackSelected(g)}))),this.playerSubs.push(this.eventHandler.on("log",((g,m)=>{this.onLog(g,m)})))}onTrackListUpdated(g){this.trackInfo=g;const m=stringifyObject(g);this.logger.info(`[onTrackListUpdated]: Track list updated to: ${m}`)}onTrackSelected(g){const m=stringifyObject(g);this.logger.info(`[onTrackSelected]: Track selected: ${m}`)}createHydraPlayerSettings(g){return{hydraRuntimeFetchTimeout:g.playerConfig?.hydraRuntimeFetchTimeout,allowSdnPlugins:g.config.allowSdnPlugins,debugLogging:g.config.debug??!1,muteVideo:g.playerConfig?.muteVideo??!1,videoLang:g.playerConfig?.lang,videoElementStyles:g.playerConfig?.styles,maxPlayerDiagnosticsCount:g.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:g.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:g.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:g.config.umsSettings.maxPlayerExperimentalEvents,maxRetryCount:g.config.maxRetryCount,playerTelemetryTickMs:g.config.playerTelemetryTickMs,maxRetryCountForLoadingResources:g.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:g.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:g.config.umsSettings.maxStreamConnectionResultsLogCount,configIds:g.configIds,timeoutForSwitchingUrl:g.config.umsSettings.timeoutForSwitchingUrl,minTargetEdgeLatency:g.config.umsSettings.minTargetEdgeLatency,latencyCompensationThreshold:g.config.umsSettings.latencyCompensationThreshold,maxEdgeLatencyHistoryLength:g.config.umsSettings.maxEdgeLatencyHistoryLength,switchingPolicy:g.config.hydraPlayerUmsSettings?.ecsSettings?.switchingPolicy,enableUuidTrace:g.config.umsSettings.enableUuidTrace,thaScript:g.config.umsSettings.thaScript,stopCrash:g.config.stopCrash,stopTerminating:g.config.umsSettings.stopTerminating,stallDetectionPolicy:g.config.hydraPlayerUmsSettings?.ecsSettings?.stallDetectionPolicy,playerRuntimeJsUrls:g.config.hydraPlayerUmsSettings?.runtimeUrls??g.playerConfig.hydraPlayerWebSdkUrls,disableSandbox:g.config.hlsSettings.disableSandbox,ecsSettings:g.config.hydraPlayerUmsSettings?.ecsSettings}}createHydraStreamOptions(g){let m=At.HydraStreamingEventType.TLE;return m=g.streamingEventType?this.convertStreamingEventType(g.streamingEventType):g.overflow?At.HydraStreamingEventType.Overflow:At.HydraStreamingEventType.TLE,{stream:{urls:[g.stream.url],decryptionKey:g.stream.decryptionKey,sdnContext:g.stream.sdnContext,streamDeliveryPipeline:g.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.stream.streamDeliveryPipeline):void 0},altStream:g.altStream?{urls:[g.altStream.url],decryptionKey:g.altStream.decryptionKey,sdnContext:g.altStream.sdnContext,streamDeliveryPipeline:g.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.altStream.streamDeliveryPipeline):void 0}:void 0,streamingEventType:m,allowPlayerControls:g.allowPlayerControls,sdn:g.sdn?{name:g.sdn.name,url:g.sdn.url,plugin:g.sdn.plugin}:void 0,thaContext:g.thaContext?{eventId:g.thaContext.eventId,organizer:{userId:g.thaContext.organizer?.userId,tenantId:g.thaContext.organizer?.tenantId},attendee:{userId:g.thaContext.attendee?.userId,tenantId:g.thaContext.attendee?.tenantId},coOrganizers:g.thaContext.coOrganizers}:void 0}}convertStreamDeliveryPipeline(g){switch(g){case"AMS":return At.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return At.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return At.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${g} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(g){switch(g){case"TLE":return At.HydraStreamingEventType.TLE;case"Overflow":return At.HydraStreamingEventType.Overflow;case"TownHall_Basic":return At.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return At.HydraStreamingEventType.TownHallPremium;case"TownHall":return At.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${g} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(g){return{setupSucceeded:g.setupSucceeded,playerSetupError:g.playerSetupError?{errorType:this.convertHydraPlayerSetupError(g.playerSetupError.errorType),errorMessage:g.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(g){switch(g){case At.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case At.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case At.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case At.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new ft(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(g){this.playerStats=g}getStats(){return this.playerStats}onLog(g,m){this.logger[g](m)}onPlaybackStateChanged(g){try{this.playbackState=this.convertHydraPlaybackState(g),this.event("playbackStateChanged").raise()}catch(g){this.logger.warn(`Not handling playback state changed event: ${stringifyObject(g)}`)}}convertHydraPlaybackState(g){switch(g){case At.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case At.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case At.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case At.HydraPlayerPlaybackState.Start:return"Start";case At.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case At.HydraPlayerPlaybackState.Play:return"Play";case At.HydraPlayerPlaybackState.Playing:return"Playing";case At.HydraPlayerPlaybackState.Pause:return"Paused";case At.HydraPlayerPlaybackState.Waiting:return"Buffering";case At.HydraPlayerPlaybackState.Seeking:return"Seeking";case At.HydraPlayerPlaybackState.Seeked:return"Seeked";case At.HydraPlayerPlaybackState.Ended:return"Ended";case At.HydraPlayerPlaybackState.Error:return"Error";case At.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case At.HydraPlayerPlaybackState.Initialized:return"Initialized";case At.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${g} to PlaybackState`)}}onPlaybackError(g,m){try{const S=this.convertHydraPlaybackErrorType(g);this.event("playbackError").raise(S,m)}catch(g){this.logger.warn(`Not handling playback error event: ${stringifyObject(g)}`)}}convertHydraPlaybackErrorType(g){switch(g){case At.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case At.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case At.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case At.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case At.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${g} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null)}},Pt=class{constructor(g,m){this.hydraPlayer=g,this.logger=m}async addCues(g){this.logger.warn("[addCues]: not implemented for UMS player")}async clearCues(){this.logger.warn("[clearCues]: not implemented for UMS player")}async showCaptions(g){await this.hydraPlayer.callPlayerApi("toggleHydraPlayerCaptions",g)}getSelectedCulture(){return this.logger.warn("[getSelectedCulture]: not implemented for UMS player"),""}getAvailableCultures(){return this.logger.warn("[getAvailableCultures]: not implemented for UMS player"),[]}dispose(){this.hydraPlayer=null}async selectTextTrack(g){await this.hydraPlayer.callPlayerApi("selectHydraPlayerTextTrack",g)}},Mt=class extends Ge{constructor(){super()}playbackStateChanged(g){this.event("playbackStateChanged").raise(g)}playbackSeeked(g){this.event("playbackSeeked").raise(g)}log(g,m){this.event("log").raise(g,m)}playbackError(g,m){this.event("playbackError").raise(g,m)}trackListUpdated(g){this.event("trackListUpdated").raise(g)}trackSelected(g){this.event("trackSelected").raise(g)}urlSwitched(g){this.event("urlSwitched").raise(g)}sdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}sdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}statsUpdated(g){this.event("statsUpdated").raise(g)}playbackStarted(){this.event("playbackStarted").raise()}},wt=class extends Ge{constructor(g,m,S){super(),this.configProvider=g,this.logger=m,this.getTelemetryLogger=S,this.isAvailable=!0,this._isStreaming=!1,this.playerSubs=[],this.isFinalTelemetrySent=!1,this.telemetryLogger=this.getTelemetryLogger(),1===this.configProvider.playerConfig.playerType?this.player=new Tt(this.logger.createChild("HlsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):2===this.configProvider.playerConfig.playerType?this.player=new Rt(this.logger.createChild("UmsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):(this.initializeAmpTelemetry(),this.player=new _t(this.logger.createChild("AmpLiveStreamPlayer"),this.liveStreamStatistic,this.configProvider)),this.subscribeForPlayerEvents()}get isStreaming(){return this._isStreaming}isActive(){return this.isAvailable&&this.isStreaming}async start(g,m){await this.setOptions(m),this.isFinalTelemetrySent=!1;const S=await this.player.loadPlayer(g);if(!S.setupSucceeded){this.player.stop(),this.logger.error("playerLoadFailed");const g=JSON.stringify(S.playerSetupError);throw this.sendFinalTelemetry(g),new Error(g)}return this._isStreaming=!0,this.liveStreamStatistic&&(this.statsSub=window.setTimeout((()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs),this.configProvider.config.sendSnapshotTelemetry&&(this.diagSub=window.setInterval((()=>{this.sendSnapshotTelemetry()}),this.configProvider.config.sendSnapshotTelemetryEveryMs))),this.player.getRenderer()}initializeAmpTelemetry(){const g={perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],currentMediaTime:[],statsInterval:[]};this.liveStreamStatistic=new ct(this.configProvider.config,this.logger.createChild("LiveStreamStatistic"),g)}async stop(){}async setOptions(g){return void 0!==g.overflow&&(g.streamingEventType||(g.streamingEventType=g.overflow?"Overflow":"TLE"),delete g.overflow),this.options=g,this.player.configure(g)}getStats(){return this.liveStreamStatistic?this.liveStreamStatistic.getPlayerDiagnosticSnapshot():this.player?.getStats?.()}dispose(){this.unsubscribeFromPlayerEvents(),this.player.stop(),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.logger.debug("stopping live event"),this.sendFinalTelemetry("graceful disposed"),super.dispose()}sendFinalTelemetry(g){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0,g))}sendTelemetry(g,m){if(this.liveStreamStatistic)if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const S={configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:g,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton,callendReason:m},v=this.liveStreamStatistic?.getReport(S);this.logger.debug("generated live stream report",v),this.telemetryLogger.sendEvent({eventName:"live_events",props:v})}else this.logger.info("telemetry not sent");else this.logger.info("telemetry not tracked in ILiveStream object")}sendSnapshotTelemetry(){if(this.liveStreamStatistic)if(this.telemetryLogger){const g=this.liveStreamStatistic.getSnapshotReport({configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:!1,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton});this.logger.debug("sending snapshot telemetry: ",g),this.telemetryLogger.sendEvent({eventName:"live_events",props:g})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set");else this.logger.info("telemetry not tracked in ILiveStream object")}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("playbackStateChanged",(()=>{this.onPlaybackStateChanged()}))),this.playerSubs.push(this.player.on("playbackError",((g,m)=>{this.onPlaybackError(g,m)}))),this.playerSubs.push(this.player.on("urlSwitched",(g=>{this.onUrlSwitched(g)}))),this.playerSubs.push(this.player.on("sdnPluginLoadSkipped",(g=>{this.onSdnPluginLoadSkipped(g)}))),this.playerSubs.push(this.player.on("sdnPluginLoadFailed",(g=>{this.onSdnPluginLoadFailed(g)}))),this.playerSubs.push(this.player.on("playbackStarted",(()=>{this.onPlaybackStarted()})))}unsubscribeFromPlayerEvents(){for(const g of this.playerSubs)g.dispose();this.playerSubs=[]}onPlaybackStarted(){this.event("playbackStarted").raise()}onPlaybackStateChanged(){const g=this.player.getPlaybackState();switch(g){case"Start":this.event("playbackStarted").raise();break;case"Ended":this.event("playbackNotLive").raise(),this.sendFinalTelemetry("playback ended");break;case"Seeked":this.event("playbackSeeked").raise(this.player.getCaptionsTimestamp());break;default:this.logger.debug(`playbackStateChanged: ${g}`)}this.event("playbackStateChanged").raise(this.player.getPlaybackState())}onPlaybackError(g,m){this.event("error").raise(g,m)}onUrlSwitched(g){this.event("urlSwitched").raise(g)}onSdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}onSdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}},Dt=class{constructor(g,m,S){this.ecsConfig=g,this.logger=m,this.getTelemetryLogger=S}configure(g){this.configuration=g}async initialize(){const g="MDN_MIDDLELANE_TEAMS",m="liveStream",S=this.ecsConfig.getString(g,m);let v={};try{v=JSON.parse(S)}catch(S){this.logger.warn(`failed to parse ECS configuration for ${g}/${m}`)}const C=this.ecsConfig.getString("ConfigIDs",g);this._configProvider=new st(v,this.configuration,C,this.logger.createChild("LiveStreamConfigProvider"))}createLiveStream(){return new wt(this._configProvider,this.logger.createChild("LiveStream"),this.getTelemetryLogger)}dispose(){}},Ot=class extends Ge{constructor(){super(...arguments),this.isAudioOutputSelectionSupported=!1}createAudioPlayer(){return null}createAudioRenderer(){return null}getRawDeviceMediaStream(g){return null}askDevicePermission(){return Promise.resolve({audio:!1,video:!1})}getPermissionState(g){return"granted"}enumerateDevicesAsync(){return Promise.resolve([])}getPreferredCamera(){return null}selectDevices(){}getSelectedDevices(){return{}}createPreview(){return Promise.resolve(new Nt)}createPreviewRenderer(){return Promise.resolve(new Nt)}createScreenSharingPreviewRenderer(){return Promise.resolve(new Nt)}getDeviceNameAsync(){return Promise.resolve("")}setDeviceEffectsAsync(){return Promise.resolve()}getDeviceEffectsCapabilityAsync(){return Promise.resolve(0)}setBackgroundImageAsync(){return Promise.resolve()}getImagePropertyAsync(){return Promise.resolve({width:0,height:0,uri:" "})}getMicrophoneGeometryArrayInfoAsync(g){return Promise.resolve({})}transformImageAsync(){return Promise.resolve(!1)}sendMessageDeviceVideoEffectsAsync(){return Promise.resolve({code:0})}sendMessageDeviceVideoExtensibilityAsync(){return Promise.resolve({code:0,type:"Error",response:{details:"The API has not been implemented."}})}setVideoCaptureConfigAsync(){return Promise.resolve()}captureVideoFrameWithoutEffectsAsync(){return Promise.resolve(new ImageData(0,0))}setAudioProcessingFlags(g){}getSpeakerVolume(){return Promise.resolve(0)}getSpeakerSystemVolume(){return Promise.resolve(0)}setSpeakerVolume(g){return Promise.resolve()}setSpeakerSystemVolume(g){return Promise.resolve()}unmuteMicrophone(){return Promise.resolve()}unmuteSpeaker(){return Promise.resolve()}getNrgLevelsForDeviceTuner(g){return Promise.resolve(0)}setAudioEffectsAsync(){return Promise.resolve()}getAudioFeatureCapability(g){return Promise.resolve(0)}getMicrophoneVolume(){return Promise.resolve(0)}setMicrophoneVolume(g){return Promise.resolve()}setDeviceTelemetryData(g,m,S,v=0){return Promise.resolve()}getSpeakerDeviceDomIdAsync(g,m){return Promise.reject()}getSourceFormats(g){return Promise.resolve([])}enableShellSharing(){return Promise.resolve()}disableShellSharing(){return Promise.resolve()}enableParticipantCameras(){return Promise.resolve()}startAudioLoopbackDevice(g){return Promise.resolve()}async dispose(g){return Promise.resolve()}},Nt=class extends Ge{constructor(){super(...arguments),this.isRendering=!1,this.streamSize={width:0,height:0},this.rendererType=-1,this.frameType=-1}captureFrame(){return Promise.resolve(new kt)}getStats(){return Promise.resolve({framesDropped:0,framesTotal:0})}setScalingMode(){return Promise.resolve()}cameraAutoControl(g){return Promise.resolve(!1)}getCameraManualControlStates(g){return Promise.resolve([])}setCameraManualControlStates(g){return Promise.resolve([])}enumerateCameraManualControls(){return Promise.resolve([])}dispose(){}},kt=class extends Ge{getSize(){return{width:0,height:0}}isMirrored(){return!1}},Lt='"rtcmedia"';function getRelayCredentials(g){return{expires:g.expires,username:g.username,password:g.password,realm:g.realm}}var Ft=class{constructor(){this.reports={}}watch(g){const m={time:Date.now(),duration:-1};return this.reports[g]&&(g=`${g}_last`),this.reports[g]=m,{end:g=>{g?m.error=g:m.duration=Date.now()-m.time}}}getReports(){return this.reports}},xt="configFetch",Ut="skypeTokenFetch",Vt="trapTokenFetch",Bt=class{constructor(g){this.updateRelaysPromise=null,this.trapTokens={},this.relaysOverride=[],this.timers=new Ft,this.context=g,this.logger=g.logger.createChild("RM"),this.request=g.request}initialize(g){this.configProvider=g,this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync(!0))}setRelayOverride(g){this.relaysOverride=g}setDefaultRelayConfig(g){this.config??(this.config=g)}async queryRelaysAsync(g={}){if(this.logger.info("query relays"),this.relaysOverride.length>0)return this.relaysOverride;this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync());const m=await this.updateRelaysPromise;return m?"turn"===g.relayType?m.Turn:g.isRemoteClientLync?m.Lync:m.Skype:[]}getStats(){return this.timers.getReports()}updateRelaysFromConfigAsync(g=!1){const m=this.getConfigAsync().then((()=>this.updateRelaysAsync())).then((g=>(this.updateRelaysPromise=m,g))).catch((m=>(this.updateRelaysPromise=null,g?this.logger.warn("failed to retrieve relays",stringifyObject(m)):this.logger.error("failed to retrieve relays",stringifyObject(m)),null)));return m}refreshRelaysFromConfig(){this.request.isOnline()?this.updateRelaysFromConfigAsync():(this.updateRelaysPromise=null,this.logger.warn("not refreshing relays due to no network connection"))}updateRelaysAsync(){const g=this.config.Service.tokenUrl;let m;const fetchTrapTokenThroughProvider=async()=>(m=this.timers.watch(Vt),this.context.trapTokenCredentialsProvider()),fetchTrapTokenDirectly=async()=>{const S=this.timers.watch(Ut);let v="";try{v=this.configProvider?.config.useNewTokenApi?await this.context.newTokenProvider():await this.context.tokenProvider(),this.logger.info(`skypeToken fetched with newApi=${this.configProvider?.config.useNewTokenApi}`)}catch(g){throw S.end(stringifyObject(g)),g}S.end(),m=this.timers.watch(Vt);return(await this.request.get(g,{headers:{"X-Skypetoken":v,"api-version":2}})).response},S=this.context.trapTokenCredentialsProvider?fetchTrapTokenThroughProvider:fetchTrapTokenDirectly;return this.logger.info("Fetch TRAP token "+(this.context.trapTokenCredentialsProvider?"with provider":"directly")),S().then((g=>{m.end();let S=0;const v=this.config.Token.earlyRefreshMinutes,C=this.config.Token.earlyRefreshPercentage;this.storeTrapTokens(g),S=Math.max(g.expires-60*v,g.expires*C/100),setTimeout(this.refreshRelaysFromConfig.bind(this),1e3*S);const _=this.config.Relay.Turn.realm?this.config.Relay.Turn.realm:Lt,E=getRelayCredentials(this.getTrapToken(_)),T={Skype:[{addresses:this.config.Relay.Skype.addresses,fqdns:this.config.Relay.Skype.fqdns,tcpPort:this.config.Relay.Skype.tcpPort,udpPort:this.config.Relay.Skype.udpPort,type:"msturn",...E}],Lync:[{addresses:this.config.Relay.Lync.addresses,fqdns:this.config.Relay.Lync.fqdns,tcpPort:this.config.Relay.Lync.tcpPort,udpPort:this.config.Relay.Lync.udpPort,type:"msturn",...E}],Turn:[{addresses:this.config.Relay.Turn.addresses,fqdns:this.config.Relay.Turn.fqdns,tcpPort:this.config.Relay.Turn.tcpPort,udpPort:this.config.Relay.Turn.udpPort,tlsPort:this.config.Relay.Turn.tlsPort,type:"turn",...E}]};return this.logger.info("relays from trap",T),T})).catch((g=>{throw m&&m.end(stringifyObject(g)),g}))}storeTrapTokens(g){if(!g||!g.tokens)return void this.logger.error("failed to get tokens from trap response");const m={};g.tokens.forEach((S=>{m[S.realm]={expires:g.expires,username:S.username,password:S.password,realm:S.realm}})),this.trapTokens=m}getTrapToken(g){if("string"==typeof g){const m=g.replace(/^"|"$/g,""),S=`"${m}"`,v=this.trapTokens[S]||this.trapTokens[m];if(v)return v}throw new Error(`token for relay not found, realm: ${g}`)}async getConfigAsync(){this.logger.info("retrieving configuration");const g=this.timers.watch(xt);try{const m=await this.context.configProvider();g.end(),this.logger.info("retrieved configuration:",m),m&&(this.config=m),this.logger.info("applied configuration:",this.config)}catch(m){this.logger.warn("failed to retrieve configuration",stringifyObject(m)),g.end(stringifyObject(m))}}};function build(g){return new Bt(g)}var Ht={CALL_SETUP_NATIVE:"skypecosi_concore_native_ts_calling_call_setup_session",CALL_IN_CALL_NATIVE:"skypecosi_concore_native_ts_calling_in_call_session",REGISTRY_WEB:"skypecosi_concore_web_ts_calling_registry",REGISTRY_NATIVE:"skypecosi_concore_native_ts_calling_registry"},$t={PARK:"*11",SHARED_LINE:"*12",SERVER_HOLD:"*13",CALL_PARK:"*14"},Gt={totalParticipants:0,preheatedParticipants:0,lobbyParticipants:0,totalPresenters:0,requestingAttentionPresenters:0,totalAttendees:0,requestingAttentionAttendees:0,overflowAttendees:0},jt=R,qt=150,Wt=30,zt=class{constructor(g,m,S,v,C){this.eventName=g,this.eventStartTime=m,this.type=S,this.causeId=v,this.status="Pending",this.eventStartTimestamp=(new Date).getTime(),this.data=[],"Event"===this.type&&delete this.status,C&&this.data.push(C)}set variant(g){this.eventVariant=g}recordSuccess(g,m){this.recordResult("Success",g,m)}recordFailure(g,m){this.recordResult("Failure",g,m)}recordTimeout(g,m){this.recordResult("Timeout",g,m)}addData(g){this.data.push(g)}isPending(){return"Pending"===this.status}getEvent(){const g={start:this.eventStartTime,duration:this.duration,status:this.status,result:this.result,causeId:this.causeId,resultCauseId:this.resultCauseId,variant:this.eventVariant,data:this.data.map((g=>this.prepareData(g,!0))).filter((g=>!!g))};return"Event"===this.type&&delete g.status,g.data.length||delete g.data,g.causeId||delete g.causeId,g.resultCauseId||delete g.resultCauseId,g.result||delete g.result,g.variant||delete g.variant,{[this.eventName]:g}}recordResult(g,m,S){this.status=g,this.result=this.prepareData(m),this.causeId!==S&&(this.resultCauseId=S),this.duration=(new Date).getTime()-this.eventStartTimestamp}prepareData(g,m=!1){if(null==g)return"";if("string"==typeof g)return scrubMriOrOmit(g);if("number"==typeof g||"boolean"==typeof g)return String(g);if("function"==typeof g)return"";if(g instanceof Error)return g.toString();try{return Object.keys(g).length?m?g:getPIISafeObject(g):""}catch(g){return"invalid"}}},Kt=class{constructor(g,m,S,v){this.logger=g,this.startTime=m,this.maxEventsExceeded=S,this.perfModule=v,this.recordedEvents=[],this.ipcStats=[],this.ongoingOperations={}}recordEvent(g,m,S=generateCauseId()){this.logger.debug("Event:",g,jt.pii.Omit(m));const v=new zt(g,this.getEventStartTime(),"Event",S,m);return this.pushToRecordedEvents(v),v}recordOperationSuccess(g,m=null,S,v,C){this.logger.info("Event success:",v,g,jt.pii.Omit(S),jt.pii.Omit(m)),this.recordOperationResult(g,m,"Success",S,v,C)}recordOperationFailure(g,m,S,v,C){this.logger.info("Event failure:",g,jt.pii.Omit(S),m),this.recordOperationResult(g,m,"Failure",S,v,C)}recordOperationTimeout(g,m,S,v,C){this.logger.info("Event timeout:",g,jt.pii.Omit(S),m),this.recordOperationResult(g,m,"Timeout",S,v,C)}maybeRecordOperationSuccess(g,m=null,S,v,C){this.hasOngoingEvent(g,S)&&this.recordOperationSuccess(g,m,S,v,C)}maybeRecordOperationFailure(g,m,S,v,C){this.hasOngoingEvent(g,S)&&this.recordOperationFailure(g,m,S,v,C)}maybeRecordOperationTimeout(g,m,S,v,C){this.hasOngoingEvent(g,S)&&this.recordOperationTimeout(g,m,S,v,C)}recordOperationResult(g,m,S,v,C,_){this.hasOngoingEvent(g,v)||this.recordOperation(g,C,v);let E=this.ongoingOperations[g];switch(v&&(E=E[v]),_&&E.addData(_),S){case"Success":E.recordSuccess(m,C);break;case"Failure":E.recordFailure(m,C);break;case"Timeout":E.recordTimeout(m,C);break;default:this.logger.error("Unknown operation record state in record operation result.")}v?delete this.ongoingOperations[g][v]:delete this.ongoingOperations[g]}recordOperation(g,m,S,v){this.logger.debug("Event create:",m,g,jt.pii.Omit(S),v);const C=new zt(g,this.getEventStartTime(),"Operation",m,v);return this.ongoingOperations[g]||(this.ongoingOperations[g]={}),S?this.ongoingOperations[g][S]=C:this.ongoingOperations[g]=C,this.pushToRecordedEvents(C),C}setOperationVariant(g,m,S){let v;v=S?this.ongoingOperations[g][S]:this.ongoingOperations[g],v?v.variant=m:this.logger.error(`Could not find operation ${g} to set variant ${m}`)}updateOperationData(g,m,S,v){try{if(!this.ongoingOperations[g])return void this.recordEvent(g,m,S);v?this.ongoingOperations[g][v]&&this.ongoingOperations[g][v].addData(m):this.ongoingOperations[g].addData(m)}catch(m){return void this.logger.info(`Unable to update operation: ${g} data`)}}pushToRecordedEvents(g){if(this.maxEventsExceeded&&this.maxEventsExceeded()&&this.recordedEvents.shift(),this.recordedEvents.push(g),this.perfModule&&this.ipcStats.length<=Wt){const g=this.perfModule.getIpcStats();g&&this.ipcStats.push({ingestionTime:this.getEventStartTime(),stats:g})}}hasOngoingEvent(g,m){return this.ongoingOperations[g]?!(m&&!this.ongoingOperations[g][m])||(this.logger.warn(`Unable to find event for name\\id ${g}\\${jt.pii.Omit(m)}`),!1):(this.logger.warn(`Unable to find event for name ${g}`),!1)}getEventStartTime(){return(new Date).getTime()-this.startTime}getEventTimestampBag(g,m){const S=m?[m.getEvent()]:this.recordedEvents.filter((m=>!g||!m.isPending())).map((g=>g.getEvent())),v=JSON.stringify({eventStart:this.startTime,events:S});return this.logger.info(`Call eventTimestampBag ${jt.pii.Omit(v)}`),v}getIPCStats(){return 0!==this.ipcStats.length?JSON.stringify(this.ipcStats):""}removeRecordedEvent(g){const m=this.recordedEvents.indexOf(g);m>-1&&this.recordedEvents.splice(m,1)}},Jt=class extends Kt{constructor(g,m){super(g,m,(()=>this.recordedEvents.length>qt)),this.getHostName=()=>{try{return"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>"}catch(g){return"unknown"}},this.tsCallingVersion=getTsCallingVersion(),this.logger=g.createChild("CallRegistryTelemetry")}setClientType(g){this.clientType=g}setEndpointId(g){this.endpointId=g}setSkypeId(g){this.skypeId=scrubMriOrOmit(g)}setApplicationType(g){this.applicationType=g}setRing(g){this.ring=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}setAcsResourceId(g){this.acsResourceId=g}setRegion(g){this.region=g}setPartition(g){this.partition=g}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{EndpointId:getValue2(this.endpointId),SkypeId:getValue2(this.skypeId),ApplicationType:getValue2(this.applicationType),Ring:getValue2(this.ring),TenantId:getValue2(this.tenantId),userHexCID:getValue2(this.userHexCID),AcsResourceId:getValue2(this.acsResourceId),Region:getValue2(this.region),Partition:getValue2(this.partition),TsCallingVersion:getValue2(this.tsCallingVersion),HostName:this.getHostName(),EventTimestampBag:this.getEventTimestampBag(g,m),DiagnosticInfo:this.callEndDiagnosticInfo,ClientType:getValue2(this.clientType)}}removeNonPendingOperations(){this.recordedEvents=this.recordedEvents.filter((g=>g.isPending()))}},Yt=class extends Kt{constructor(g,m,S){super(g,m,(()=>this.inCallMode&&this.recordedEvents.length>qt),S),this.inCallMode=!1,this.tsCallingVersion=getTsCallingVersion(),this.logger=g.createChild("CallTelemetry")}setClientType(g){this.clientType=g}setCallId(g){this.currentCallId&&(this.previousCallId=this.currentCallId),this.currentCallId=g}setConsultativeCallId(g){this.consultativeCallId=g}setEndpointId(g){this.endpointId=g}setParticipantId(g){this.participantId=g}setPreheatFlags(g){this.preheatFlags=g}setCallOrigin(g){this.origin=g}setGroupId(g){this.groupId=g}setThreadId(g){this.threadId=g}setBackroomThreadId(g){this.backroomThreadId=g}setComplianceRecordingContentLength(g){this.complianceRecordingContentLength=g}setMesageId(g){this.messageId=g}setSkypeId(g){this.skypeId=scrubMriOrOmit(g)}setApplicationType(g){this.applicationType=g}setRing(g){this.ring=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}setAcsResourceId(g){this.acsResourceId=g}setRegion(g){this.region=g}setPartition(g){this.partition=g}setFailureType(g){this.failureType=g}setIsCast(g){this.isCast=g?"True":"False"}setIsHuddleGroupCall(g){this.isHuddleGroupCall=g?"True":"False"}setIsEmergency(g){this.isEmergency=g?"True":"False"}setRole(g){this.isAnonymous="admin"===g?"False":"True"}setCallType(g){this.callType=g}setConversationType(g){this.conversationType=g}setDirection(g){this.direction=g}setSelfParticipantRole(g){this.selfParticipantRole=g}setTerminationState(g){this.terminationState=g}setTerminationReason(g){this.terminationReason=g}setCallEndDiagnosticInfo(g){this.callEndDiagnosticInfo=g}setStackConfig(g){this.stackConfig=g}setJoinedFrom(g){this.joinedFrom=g}setMeetingCode(g){this.meetingCode=g}setMeetingUrl(g){this.meetingUrl=g}setHasMeetingRegistrationId(g){this.hasMeetingRegistrationId=g?"True":"False"}setHasParticipantPin(g){this.hasParticipantPin=g?"True":"False"}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{CorrelationId:getValue2(this.currentCallId),PreviousCorrelationId:getValue2(this.previousCallId),ConsultativeCallId:getValue2(this.consultativeCallId),EndpointId:getValue2(this.endpointId),SkypeId:getValue2(this.skypeId),ParticipantId:getValue2(this.participantId),PreheatFlags:getValue2(this.preheatFlags),CallType:getValue2(this.callType),ConversationType:getValue2(this.conversationType),Direction:getValue2(this.direction),Origin:getValue2(this.origin),SelfParticipantRole:getValue2(this.selfParticipantRole),IsAnonymous:getValue2(this.isAnonymous),GroupId:scrubMriOrOmit(getValue2(this.groupId)),ThreadId:getLoggableThreadId(getValue2(this.threadId)),MessageId:getValue2(this.messageId),ApplicationType:getValue2(this.applicationType),Ring:getValue2(this.ring),TenantId:getValue2(this.tenantId),userHexCID:getValue2(this.userHexCID),AcsResourceId:getValue2(this.acsResourceId),Region:getValue2(this.region),Partition:getValue2(this.partition),FailureType:getValue2(this.failureType),IsCast:getValue2(this.isCast),IsHuddleGroupCall:getValue2(this.isHuddleGroupCall),IsEmergency:getValue2(this.isEmergency),TsCallingVersion:getValue2(this.tsCallingVersion),TerminationState:getValue2(this.terminationState),TerminationReason:getValue2(this.terminationReason),StackConfig:getValue2(this.stackConfig),EventTimestampBag:this.getEventTimestampBag(g,m),HostName:this.getHostName(),DiagnosticInfo:this.callEndDiagnosticInfo,JoinedFrom:this.joinedFrom,MeetingCode:this.meetingCode,MeetingUrl:this.meetingUrl,HasMeetingRegistrationId:this.hasMeetingRegistrationId,HasParticipantPin:this.hasParticipantPin,IPCStats:this.getIPCStats(),ComplianceRecordingContentLength:getValue2(this.complianceRecordingContentLength),BackroomThreadId:getLoggableThreadId(getValue2(this.backroomThreadId)),ClientType:getValue2(this.clientType)}}switchToInCallTelemetry(){this.recordedEvents=this.recordedEvents.filter((g=>g.isPending())),this.inCallMode=!0}getHostName(){try{return location.host}catch(g){return"unknown"}}},getEndpointInformationForTelemetry=g=>Array.isArray(g)?g.map((g=>({endpointId:g.endpointId,participantId:g.participantId}))):null,calculateJoinedFromForTelemetry=(g,m,S,v,C)=>{if(g){if(g.meetingUrl)return"MeetingUrl";if(g.meetingCode)return"MeetingCode"}return m||S?"ThreadContext":v?"GroupId":C?"Awareness":""};function sanitizeMeetingCode(g,m,S){if(!g)return S.info(`sanitizeMeetingCode[${m}] empty / undefined meeting code parameter`),g;let v=g.replace(/\s/g,"");return v=v.replace(/-/g,""),S.info(`sanitizeMeetingCode[${m}] meetingCode: ${g}, sanitizedMeetingCode: ${v}`),v}function getMeetingCodeFromMeetingUrl(g,m,S){if(!g)return S.info(`getMeetingCodeFromMeetingUrl[${m}] empty / undefined meeting Url parameter`),g;const v=new URL(g);let C="";if(v&&v.pathname&&v.pathname.split("/").length>=2){const g=v.pathname.split("/");"meet"===g[g.length-2]&&(C=g[g.length-1])}return S.info(`getMeetingCodeFromMeetingUrl[${m}] meetingUrl: ${g}, meetingUrlObject: ${safeJsonStringify(v)}, meetingCode: ${C}`),C}function compareMeetingData(g,m,S,v){const C=sanitizeMeetingCode(g&&g.meetingCode||"",S,v),_=sanitizeMeetingCode(m&&m.meetingCode||"",S,v),definedAndEqual=(g,m)=>!!g&&!!m&&g===m;if(definedAndEqual(C,_))return!0;let E=getMeetingCodeFromMeetingUrl(g&&g.meetingUrl||"",S,v);E=sanitizeMeetingCode(E,S,v);let T=getMeetingCodeFromMeetingUrl(m&&m.meetingUrl||"",S,v);if(T=sanitizeMeetingCode(T,S,v),definedAndEqual(E,T))return!0;if(definedAndEqual(E,_)||definedAndEqual(T,C))return!0;if(g&&g.meetingUrl&&m&&m.meetingUrl){const S=new URL(g.meetingUrl),v=new URL(m.meetingUrl);if(S.hostname===v.hostname&&S.pathname===v.pathname)return!0}return!1}function noop(){}var Qt={CODE:{SUCCESS:0,MEDIA_ERROR:410,CLIENT_ERROR_CODE:499,UNKNOWN_ERROR:497},SUB_CODE:{VDI_DISCONNECTED:3e3,ACTION_NOT_ALLOWED:3548,ABANDONED:4990,ENDED_BY_REMOTE_ENDPOINT:5028,BEACON:4521,UNKNOWN_FAILURE:3545}},Xt=4294967294,Zt="_operationIdValue_",ei="_causeIdValue_",ti="_callStartOptionsValue_",ii="_clientReasonValue_";function callOperation(g,m){return operationDecorator(0,g,m)}function participantOperation(g,m){return operationDecorator(1,g,m)}var operationId=(g,m,S)=>{if(g[m][Zt])throw new Error("can not specify more than one operation id");g[m][Zt]=S},causeId=(g,m,S)=>{if(g[m][ei])throw new Error("can not specify more than one cause id");g[m][ei]=S},callStartOptions=(g,m,S)=>{if(g[m][ti])throw new Error("can not specify options more than once");g[m][ti]=S},reason=(g,m,S)=>{if(g[m][ii])throw new Error("can not specify reason more than once");g[m][ii]=S},operationDecorator=(g,m,S)=>(v,C,_)=>{const E=_.value,T=v[C]?.[Zt],I=v[C]?.[ei],b=v[C]?.[ti],A=v[C]?.[ii],R=S?.type||"Async";return _.value=function(...v){const C=this;let _=generateCauseId();void 0!==I&&(v[I]&&validateCauseId(v[I])?_=v[I]:v[I]=_);let P,M=void 0!==T?v[T]:void 0;if(void 0!==M)if(Array.isArray(M))try{const g=M.map((g=>g.toString())).sort().concat().toString();M=getStringHash(g).toString()}catch{const g=`[${M}]${m} failed in array parsing in operationDecorator`,S={terminatedReason:32,terminatedReasonCode:Qt.CODE.UNKNOWN_ERROR,terminatedReasonSubCode:Qt.SUB_CODE.UNKNOWN_FAILURE,errorMessage:g};return Promise.reject(S)}else if(M&&"object"==typeof M)try{let g=JSON.stringify(M);S&&S.operationIdKey&&M.hasOwnProperty(S.operationIdKey)&&(g=M[S.operationIdKey]),M=g}catch{const g=`[${M}]${m} failed in object parsing in operationDecorator`,S={terminatedReason:32,terminatedReasonCode:Qt.CODE.UNKNOWN_ERROR,terminatedReasonSubCode:Qt.SUB_CODE.UNKNOWN_FAILURE,errorMessage:g};return Promise.reject(S)}void 0!==A&&v[A]&&(P=v[A]);const w=getOperationHandler(C,g);if(w.logOperation(_,m),S&&S.singular&&w.hasPendingOperation(m))return w.logOperation(_,m,"Not allowed, pending operation exists"),Promise.reject(60);if(S&&S.idempotencyLevel&&w.getRecord(m)>0)switch(w.logOperation(_,m,`Called multiple times, handling operation according to specified policy: idempotency=${S.idempotencyLevel}`),S.idempotencyLevel){case"NoOp":return Promise.resolve();case"Error":return Promise.reject(60)}try{void 0!==b&&v[b]&&C.processCallStartOptions(v[b],_)}catch{const g=`${m} failed in processCallStartOptions`,S={terminatedReason:32,terminatedReasonCode:Qt.CODE.UNKNOWN_ERROR,terminatedReasonSubCode:Qt.SUB_CODE.UNKNOWN_FAILURE,errorMessage:g};return Promise.reject(S)}const D=!(!S||!S.convertError),execute=()=>"Chained"===R?w.executeChained(E.bind(this,...v),m,M,_,D,P,S):"Sync"===R?w.executeSync(E.bind(this,...v),m,M,_,D,P):w.execute(E.bind(this,...v),m,M,_,D,P,S);if("StartCall"!==m&&"JoinCall"!==m||w.hasPendingOperation("_CallStartOrJoinInitiated")||w.createPendingOperation("_CallStartOrJoinInitiated").catch(noop),S&&S.triggerAttach&&(w.hasPendingOperation("_ElectronSlimcoreReady")||w.createPendingOperation("_ElectronSlimcoreReady").catch(noop)),S&&"Sync"!==S.type){const g=S&&S.waitFor;if(Array.isArray(g))return Promise.all(g.map((g=>g&&w.hasPendingOperation(g)&&w.waitForOperation(g,void 0,_)))).then(execute,execute);if(g&&w.hasPendingOperation(g))return w.waitForOperation(g,void 0,_).then(execute,execute)}return execute()},_},getOperationHandler=(g,m)=>{if(0===m)return g._callOperationHandler;if(1===m)return g._participantOperationHandler;throw new Error("Unsupported operation handler type!")};function getStringHash(g){let m=0;for(let S=0;S<g.length;S++){m=(m<<5)-m+g.charCodeAt(S),m|=0}return m}var ni=class{constructor(g){this._disposed=!1,this._logger=g.createChild("[ASYNC]"),this._endOperationDeferred=defer(),this._endOperationDeferred.promise.catch((g=>{this._logger.info("Rejected all operations")})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._deferredOperationsWithCauseId={},this._logger=g}registerPromise(g,m){let S=!1;const always=()=>{S=!0};m.then(always,always);const v=this._endOperationDeferred.promise.catch((m=>{if(!S)throw new Error(`Operation ${g} did not complete, reason:${m}`)}));return Promise.race([v,m])}updateOperationId(g,m){this._logger.info(`updateOperationId ${g} ${m}`),Object.keys(this._deferredOperationsWithOperationId).forEach((S=>{S&&this._deferredOperationsWithOperationId[S]&&(this._logger.info(`_deferredOperationsWithOperationId ${S}`),Object.keys(this._deferredOperationsWithOperationId[S]).forEach((v=>{v&&this._deferredOperationsWithOperationId[S][v]&&(this._logger.info(`_deferredOperationsWithOperationId ${v} ${m}`),v===g&&(this._deferredOperationsWithOperationId[S][m]=this._deferredOperationsWithOperationId[S][v],delete this._deferredOperationsWithOperationId[S][v]))})))})),Object.keys(this._deferredOperationsWithCauseId).forEach((S=>{S&&this._deferredOperationsWithCauseId[S]&&(this._logger.info(`_deferredOperationsWithCauseId ${S}`),Object.keys(this._deferredOperationsWithCauseId[S]).forEach((v=>{v&&this._deferredOperationsWithCauseId[S][v]&&(this._logger.info(`_deferredOperationsWithCauseId ${v} ${m}`),v===g&&(this._deferredOperationsWithOperationId[S][m]=this._deferredOperationsWithOperationId[S][v],delete this._deferredOperationsWithOperationId[S][v]))})))}))}createPendingOperation(g,m,S=generateCauseId(),v={}){const C=defer();C.promise.catch(noop);const _=this.getOperationInfoForLogging(S,g,m);let E;if(this._logger.info(`${_}[creating...]`),this._disposed)return this._logger.info(`${_}[create failed, call is disposed]`),Promise.reject(60);if(m){if(this._deferredOperationsWithOperationId[g]||(this._deferredOperationsWithOperationId[g]={}),this._deferredOperationsWithOperationId[g][m])return this._logger.warn(`${_} Deferred operation with given name and operation id is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${g}/${scrubMriOrOmit(m)}`));this._deferredOperationsWithOperationId[g][m]={deferred:C,causeId:S},this._deferredOperationsWithCauseId[S]||(this._deferredOperationsWithCauseId[S]={}),this._deferredOperationsWithCauseId[S][m]={deferred:C,options:v,operationName:g},E=this._endOperationDeferred.promise.catch((S=>{if(this.hasPendingOperationWithOperationId(g,m))throw new Error(`Operation ${g} ${m} did not complete, reason:${S}`)}))}else{if(this._deferredOperations[g])return this._logger.warn(`${_} Deferred operation with given name is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${g}`));this._deferredOperationsWithCauseId[S]||(this._deferredOperationsWithCauseId[S]={}),this._deferredOperationsWithCauseId[S][""]={deferred:C,options:v,operationName:g},this._deferredOperations[g]={deferred:C,causeId:S},E=this._endOperationDeferred.promise.catch((m=>{if(this.hasPendingOperation(g))throw new Error(`Operation ${g} did not complete, reason:${m}`)}))}return Promise.race([E,C.promise])}hasPendingOperation(g){return!!this._deferredOperations[g]}hasAtleastOneOfPendingOperation(g){for(const m of g)if(this.hasPendingOperation(m))return!0;return!1}hasPendingOperationWithOperationId(g,m){return!(!m||!this._deferredOperationsWithOperationId[g])&&!!this._deferredOperationsWithOperationId[g][m]}hasPendingOperationWithCauseId(g,m){const S=m||"";return this._deferredOperationsWithCauseId[g]&&!!this._deferredOperationsWithCauseId[g][S]}getPendingOperationWithCauseId(g,m){return this.hasPendingOperationWithCauseId(g,m)?this._deferredOperationsWithCauseId[g][m].deferred.promise:Promise.reject(`[${g}][${m}]: getPendingOperationWithCauseId for given causeId, operationId`)}resolveOperationWithCauseId(g,m,S){const v=m||"";if(this.hasPendingOperationWithCauseId(g,v)){const m=this._deferredOperationsWithCauseId[g][v],C=m.deferred.promise;return m.deferred.resolve(S),this._logger.info(`[${g}][${v}] resolved, result=${getPrintableObject(S)||"void"}`),delete this._deferredOperationsWithCauseId[g][v],C}return Promise.reject(`[${g}][${v}] resolveOperationWithCauseId failed, operation not found`)}rejectOperationWithCauseId(g,m,S){const v=m||"";if(this.hasPendingOperationWithCauseId(g,v)){const m=this._deferredOperationsWithCauseId[g][v],C=m.deferred.promise;return C.catch(noop),m.deferred.reject(S),this._logger.info(`[${g}][${v}] rejected, result=${getPrintableObject(S)||"void"}`),delete this._deferredOperationsWithCauseId[g][v],C}return Promise.reject(`[${g}][${v}] rejectOperationWithCauseId failed, operation not found`)}maybeResolveOperationWithCauseId(g,m,S){this.hasPendingOperationWithCauseId(g,m)?this.resolveOperationWithCauseId(g,m,S).catch((m=>{this._logger.info(`${g}maybeResolveOperationWithCauseId failed, reason=${getPrintableObject(m)}`)})):this._logger.info(`${g}maybeResolveOperationWithCauseId ignored, operation does not exist`)}maybeRejectOperationWithCauseId(g,m,S){this.hasPendingOperationWithCauseId(g,m)?this.rejectOperationWithCauseId(g,m,S).catch(noop):this._logger.info(`${g}maybeRejectOperationWithCauseId ignored, operation does not exist`)}getPendingOperation(g,m,S=generateCauseId()){return!m&&this._deferredOperations[g]?this._deferredOperations[g].deferred.promise:m&&this._deferredOperationsWithOperationId[g]&&this._deferredOperationsWithOperationId[g][m]?this._deferredOperationsWithOperationId[g][m].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(S,g,m)}: Deferred operation with given name and operation does not exist`)}waitForOperation(g,m,S=generateCauseId()){return m&&this.hasPendingOperationWithOperationId(g,m)?this._deferredOperationsWithOperationId[g][m].deferred.promise:this.hasPendingOperation(g)?this._deferredOperations[g].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(S,g,m)}failed=wait failed, operation not found`)}resolveOperation(g,m,S,v=generateCauseId(),C=!1){if(!g)return Promise.reject("Unable to resolve deferred operation with empty name");if(S&&this.hasPendingOperationWithOperationId(g,S)){const v=this._deferredOperationsWithOperationId[g][S],_=v.deferred.promise;return v.deferred.resolve(m),this._logger.info(`${this.getOperationInfoForLogging(v.causeId,g,S)}resolved, result=${getPrintableObject(m)||"void"}`),C||delete this._deferredOperationsWithOperationId[g][S],_}if(this.hasPendingOperation(g)){const v=this._deferredOperations[g],_=this._deferredOperations[g].deferred.promise;return this._deferredOperations[g].deferred.resolve(m),this._logger.info(`${this.getOperationInfoForLogging(v.causeId,g,S)}resolved, result=${getPrintableObject(m)||"void"}`),C||delete this._deferredOperations[g],_}return Promise.reject(`${this.getOperationInfoForLogging(v,g,S)}failed=resolve failed, operation not found`)}rejectOperation(g,m,S,v=generateCauseId()){if(!g)return Promise.reject("Unable to reject deferred operation with empty name");if(S&&this.hasPendingOperationWithOperationId(g,S)){const v=this._deferredOperationsWithOperationId[g][S],C=v.deferred.promise;return C.catch(noop),v.deferred.reject(m),this._logger.info(`${this.getOperationInfoForLogging(v.causeId,g,S)}rejected, reason=${getPrintableObject(m)||"void"}`),delete this._deferredOperationsWithOperationId[g][S],C}if(this.hasPendingOperation(g)){const v=this._deferredOperations[g],C=v.deferred.promise;return C.catch(noop),v.deferred.reject(m),this._logger.info(`${this.getOperationInfoForLogging(v.causeId,g,S)}rejected, reason=${getPrintableObject(m)||"void"}`),delete this._deferredOperations[g],C}return Promise.reject(`${this.getOperationInfoForLogging(v,g,S)}failed=reject failed, operation not found`)}maybeResolveOperation(g,m,S,v=generateCauseId()){const C=this.getOperationInfoForLogging(v,g,S);S&&this.hasPendingOperationWithOperationId(g,S)||this.hasPendingOperation(g)?this.resolveOperation(g,m,S,v).catch((g=>{this._logger.info(`${C}maybeResolveOperation failed, reason=${getPrintableObject(g)}`)})):this._logger.info(`${C}maybeResolveOperation ignored, operation does not exist`)}maybeResolveOperations(g,m,S,v=generateCauseId()){for(const C of g)this.maybeResolveOperation(C,m,S,v)}maybeRejectOperation(g,m,S,v=generateCauseId()){const C=this.getOperationInfoForLogging(v,g,S);S&&this.hasPendingOperationWithOperationId(g,S)||this.hasPendingOperation(g)?this.rejectOperation(g,m,S,v).catch(noop):this._logger.info(`${C}maybeRejectOperation ignored, operation does not exist`)}maybeRejectOperations(g,m,S,v=generateCauseId()){for(const C of g)this.maybeRejectOperation(C,m,S,v)}rejectPendingOperations(g,m=generateCauseId()){this._disposed=!0,this._logger.info(`[${m}]rejectPendingOperations=${JSON.stringify(g)}`),Object.keys(this._deferredOperations).forEach((S=>{this.maybeRejectOperation(S,g,void 0,m),this._deferredOperationsWithOperationId[m]&&delete this._deferredOperationsWithOperationId[m][""]})),Object.keys(this._deferredOperationsWithOperationId).forEach((S=>{Object.keys(this._deferredOperationsWithOperationId[S]).forEach((v=>{this.maybeRejectOperation(S,g,v,m),this._deferredOperationsWithOperationId[m]&&delete this._deferredOperationsWithOperationId[m][v]}))})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._endOperationDeferred.reject(g)}maybeRejectPendingOperationsWithPredicate(g,m=generateCauseId(),S){this._logger.info(`[${m}]rejectPendingOperationsWithPredicate`),Object.keys(this._deferredOperationsWithCauseId).forEach((m=>{Object.keys(this._deferredOperationsWithCauseId[m]).forEach((v=>{const C=this._deferredOperationsWithCauseId[m][v];C&&S(C.operationName,C.options)&&(this.maybeRejectOperation(C.operationName,g,v),this.maybeRejectOperationWithCauseId(m,v,g))}))}))}getOperationInfoForLogging(g,m,S=""){return`[${g}][${m}]${S?`[${scrubMriOrOmit(S)}]`:""}`}},ri=P,si=class{constructor(g){this._logger=g,this._promise=Promise.resolve(void 0),this._actionQueue=[]}chainPromise(g,m,S=generateCauseId(),v=!1){const C=Date.now(),_=(("function"==typeof m?m():m)||"").toString();this._actionQueue.push(_),this._logger.info(`[${S}][${_}]enqueueing, queue=[${this._actionQueue}], reset=${v}`);const removeFromQueue=()=>{this._actionQueue=this._actionQueue.filter((g=>g!==_))};return v&&this.reset(S),this._promise=this._promise.catch(ri.noop).then((()=>{const m=Date.now()-C;return this._logger.info(`[${S}][${_}]begin, delayMs=${m}`),g()})),this._promise.then((()=>{removeFromQueue();const g=Date.now()-C;this._logger.info(`[${S}][${_}]success, durationMs=${g}`)}),(g=>{removeFromQueue();const m=Date.now()-C;this._logger.warn(`[${S}][${_}]failed=${safeJsonStringify(g)}, durationMs=${m}`)})),this._promise}reset(g){this._logger.info(`[${g}] resetting`),this._promise=Promise.resolve(void 0)}};function isTransactionEnd(g){return!(!g||!g.code)}function getRejectTransactionEnd(g,m){let S;return S=isTransactionEnd(g)?g:{code:499,subCode:void 0!==m?m:0,phrase:"string"==typeof g?g:getPrintableObject(g)},S}function getSuccessTransactionEnd(){return{code:0}}var ai=class{constructor(){this.msElapsed=0,this.isPaused=!1,this._startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this._startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this._startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this._startTime,this.durationInMinutes=()=>{const g=this.duration()/6e4;return Math.ceil(g)},this.durationInSeconds=()=>{const g=this.duration()/1e3;return Math.ceil(g)}}get startTime(){return this._startTime}};function build2(){return new ai}var oi=class extends ni{constructor(g,m,S,v,C){super(g),this.callTelemetry=m,this._ecsConfig=S,this._publishCallback=v,this._preconditionFunction=C,this._record={},this.logSuccess=(g,m,S)=>{this._logger.info(`${g} execution succeeded, result=${m?this.stringifyForLogging(m):"void"}, time=${S.duration()}`)},this.logFailure=(g,m,S)=>{this._logger.info(`${g} execution failed, reason=${this.stringifyForLogging(m)}, time=${S.duration()}`)},this.logTimeout=(g,m,S)=>{this._logger.info(`${g} execution timed out, reason=${this.stringifyForLogging(m)}, time=${S.duration()}`)},this.stringifyForLogging=g=>{let m;if(g instanceof Error)m=g.toString()||"Unknown Error";else try{m=JSON.stringify(g)}catch(g){m="Unable to stringify data"}return m},this.convertToTransactionEndIfErrorOrString=(g,m,S)=>{if(this._logger.info(`ecsEnableErrorConversion in operationHandler is: ${this._ecsConfig&&this._ecsConfig.enableErrorConversion}`),m&&this._ecsConfig&&this._ecsConfig.enableErrorConversion&&("string"==typeof g||g instanceof Error)){const m=getRejectTransactionEnd(g);return this._logger.info(`${S} Error converted from ${g} to ${getPrintableObject(m)}`),m}return g},this._logger=g.createChild("[Operation]"),this._chainedPromise=new si(this._logger.createChild("[Chained]"))}resetOperationChain(g){this._chainedPromise.reset(g)}executeSync(g,m,S,v=generateCauseId(),C,_){const E=this.getOperationInfoForLogging(v,m,S),T=build2();this._logger.info(`${E}API calledSync`);const I=this.callTelemetry.recordOperation(m,v,S,_);let b;try{this._setRecord(m),b=g(),I.recordSuccess(b,v),this.logSuccess(E,b,T)}catch(g){const m=this.convertToTransactionEndIfErrorOrString(g,C,E);I.recordFailure(m,v),this.logFailure(E,m,T)}return b}async executeChained(g,m,S,v=generateCauseId(),C,_,E){return this.checkPendingOperationAndExecute(g,!0,m,S,v,C,_,E)}async execute(g,m,S,v=generateCauseId(),C,_,E){return this.checkPendingOperationAndExecute(g,!1,m,S,v,C,_,E)}logOperation(g,m,...S){const v=S.length&&S.map((g=>this.stringifyForLogging(scrubMriOrOmit(g))));this._logger.info(`[${g}][${m}]API called, ${v?`with args=${v}`:""}`)}rejectPendingOperations(g,m=generateCauseId(),S){if(S){for(const g of Object.keys(this._deferredOperations))this.callTelemetry.maybeRecordOperationFailure(g,S,void 0,m);for(const g of Object.keys(this._deferredOperationsWithOperationId))for(const v of Object.keys(this._deferredOperationsWithOperationId[g]))this.callTelemetry.maybeRecordOperationFailure(g,S,v,m)}super.rejectPendingOperations(g,m)}maybeRejectOperations(g,m,S,v=generateCauseId(),C){if(C)for(const m of g)this.callTelemetry.maybeRecordOperationFailure(m,C,void 0,v);super.maybeRejectOperations(g,m,S,v)}checkPendingOperationAndExecute(g,m,S,v,C=generateCauseId(),_,E,T){const I=this.getOperationInfoForLogging(C,S,v);let b=null,A=null;return this.hasPendingOperationWithOperationId(S,v)||this.hasPendingOperation(S)?(this._logger.info(`${I}already pending, returning existing operation`),b=this.waitForOperation(S,v,C)):A=this.createPendingOperation(S,v,C,T),m?(this._logger.info(`${I}chained`),this._chainedPromise.chainPromise((()=>b||this.executeInternal(A,C,g,S,v,_,E,T)),S,C)):b||this.executeInternal(A,C,g,S,v,_,E,T)}_setRecord(g){this._record.hasOwnProperty(g)||(this._record[g]=0),this._record[g]+=1}getRecord(g){return this._record[g]}_recordTelemetryTimeoutAndPublish(g,m,S,v,C,_,E){const T=g||60;return window.setTimeout((()=>{if(!this._publishCallback)return void this._logger.warn(`${C} is marked to publish telemetry but no publish callback is defined.`);if(!this.hasPendingOperationWithOperationId(v,E)&&!this.hasPendingOperation(v))return;const g=new Error(`${C} execution did not complete before telemetry timeout of ${T}s.`);this.logTimeout(C,g,_),this.callTelemetry.maybeRecordOperationTimeout(v,g,E,S),this._publishCallback(m),this.callTelemetry.removeRecordedEvent(m)}),1e3*T)}_instantTelemetryPublish(g,m){this._publishCallback?(this._publishCallback(m),this.callTelemetry.removeRecordedEvent(m)):this._logger.warn(`${g} is marked to publish telemetry but no publish callback is defined.`)}parseInstantTelemetryParameters(g){let m,S=!1;return g&&(S=g.enableInstantTelemetry,m=g.telemetryTimeout),[S,m]}async executeInternal(g,m,S,v,C,_,E,T){const I=this.getOperationInfoForLogging(m,v,C);this._logger.info(`${I} executing operation...`);const b=build2(),A=this.callTelemetry.recordOperation(v,m,C,E),[R,P]=this.parseInstantTelemetryParameters(T);try{let g;this._setRecord(v),R&&(g=this._recordTelemetryTimeoutAndPublish(P,A,m,v,I,b,C)),T?.preconditionTags?.length&&this._preconditionFunction&&this._preconditionFunction(v,T.preconditionTags);const _=await S();g&&clearTimeout(g),this.callTelemetry.maybeRecordOperationSuccess(v,_,C),this.logSuccess(I,_,b),this.maybeResolveOperation(v,_,C,m)}catch(g){const S=this.convertToTransactionEndIfErrorOrString(g,_,I);this.callTelemetry.maybeRecordOperationFailure(v,S,C),this.logFailure(I,S,b),this.maybeRejectOperation(v,S,C,m)}return R&&this._instantTelemetryPublish(I,A),g}getEcsConfig(){return this._ecsConfig}},li={Cancel:487,Reject:603,NoNgcEndpoint:480,Forbidden:403,PreconditionFailed:412,Success:0,CallRedirected:302,BadRequest:400,NotFound:404,NotAcceptable:406,Timeout:408,Conflict:409,MediaError:410,ConfParticipantCountLimitReached:413,CallAccepted:450,CallForwarded:451,CallForwardedToVoicemail:452,P2pRejectCall:453,P2pFallbackForScreensharing:460,P2pFallbackDueToGroupCall:461,CallLegEndedOnService:470,CallDoesNotExist:481,NotAcceptableHere:488,NetworkError:490,GlareError:491,SkypeTokenError:495,LocalHttpStackError:496,UnknownError:497,LocalError:498,InternalServerError:500,CallModalityFailure:580,ServiceUnavailable:503},ci={Success:0,CallRedirectedSuccess:3020,InsufficientCapabilities:5204,PolicyRestriction:5448,UserBlocked:10005,MaxLobbyParticipantLimitReached:5807,MaxParticipantLimitReached:5808,MaxParticipantLimitReached2:5817,SharingStolenError:10029,DowngradeToStreamingClient:3099,MediaDropDuringConnect:3100,MediaDropAfterConnect:3101,MediaAnswerProcessingError:3102,MediaFinalAnswerProcessingError:3103,MediaOfferTimeout:3104,MediaFinalAnswerTimeout:3105,MediaOfferNull:3106,MediaAudioDeviceError:3107,MediaRenegotiationError:3108,MediaPermissionError:3109,MediaUnknownError:3110,MediaOfferProcessingError:3111,MediaWhiteListingIssue:3112,MediaMuteMicrophoneError:3113,MediaMuteSpeakerError:3114,MediaUnmuteMicrophoneError:3115,MediaUnmuteSpeakerError:3115,AttachActionFailed:4103,AttachFailed:4105,PreheatedCallTimedout:4113,RemovedFromConversation:5e3,DeniedInLobby:5854,RemovedFromCall:5300,TimedOutInLobby:5855,AnonymousJoinDisabledByPolicy:5723,B2bJoinDisabledByPolicy:5724,NoLobbyForBroadcastJoin:5354,NotAllowedDueToInformationBarrier:5810,TeamParkPolicyDisabled:10193,BroadcastLimitReached:800100},di={[li.Success]:1,[li.Cancel]:12,[li.Reject]:10,[li.NoNgcEndpoint]:2,[li.Timeout]:6,[li.CallAccepted]:30,[li.CallRedirected]:75,[li.NotFound]:24,[li.CallDoesNotExist]:46,[li.NotAcceptable]:5,[li.BadRequest]:5,[li.MediaError]:4,[li.ConfParticipantCountLimitReached]:59,[li.CallModalityFailure]:4,[li.NetworkError]:3,[li.LocalHttpStackError]:31,[li.LocalError]:25,[li.CallForwarded]:27,[li.CallForwardedToVoicemail]:28,[li.SkypeTokenError]:29,[li.InternalServerError]:7,[li.Conflict]:7,[li.GlareError]:7,[li.CallLegEndedOnService]:7,[li.NotAcceptableHere]:26,[li.UnknownError]:32,[li.Forbidden]:8,[li.PreconditionFailed]:65},hi={9401:33,9422:33,6102:1,6423:14,9402:14,9432:14,6519:3,9403:15,9410:36,9411:37,1e3:2,9407:17,13430:18,6009:19,10484:19,10604:19,10404:19,10420:19,10403:20,17401:20,10408:9,10486:11,10600:11,10686:11,10487:21,10500:3,10501:3,10502:3,10503:3,10504:3,10480:22,10482:22,10603:10,13406:23,13416:23},ui={500:39,403:41,404:42,480:40},gi={INCOMING_SKYPE_NGC_CALL:107,INCOMING_SKYPE_NGC_GVC_CALL:109,INCOMING_PSTN_NGC_CALL:111,INCOMING_SCREENSHARE_WITH_CHAT:119,INCOMING_TFL_TFW_CALL:126},pi={SHARED_LINE_CALL_RECORD:121,SHARED_LINE_V2_CALL_RECORD:123,MEETING_STARTED_NOTIFICATION:128},mi={LOG_UPLOAD_EVENT:120},fi={Unknown:"CallEndReasonUnknown",MediaError:"CallEndReasonMediaError",MediaOfferTimeout:"CallEndReasonMediaOfferTimeout",MediaFinalAnswerTimeout:"CallEndReasonMediaFinalAnswerTimeout",MediaAnswerError:"CallEndReasonMediaAnswerError",MediaFinalAnswerError:"CallEndReasonFinalAnswerError",MediaPermissionError:"CallEndReasonMediaPermissionError",MediaRenegotiationError:"CallEndReasonRenegotiationError",MediaDropDuringConnect:"CallEndReasonMediaDropDuringConnectError",MediaDropAfterConnect:"CallEndReasonMediaDropAfterConnectError",MediaOfferProcessingError:"CallEndReasonMediaOfferProcessingError",DowngradeToStreamingClient:"DowngradeToStreamingClient",IncompatibleOffer:"CallEndReasonIncompatibleOffer",MediaWhiteListingIssue:"MediaWhitelistingIssue",AudioDeviceError:"CallEndReasonAudioDeviceError",AttachFailed:"CallEndReasonAttachFailed",BadNotificationPayload:"CallEndReasonBadNotificationPayload",RetargetNotSupported:"RetargetNotSupported",CallEndReasonLocalUserInitiated:"CallEndReasonLocalUserInitiated",EndedByRemoteEndpoint:"EndedByRemoteEndpoint",CallEndReasonRedirected:"CallEndReasonRedirected",CallEndReasonVDIdisconnect:"CallEndReasonVDIdisconnect"},Si=(g=>(g.GetSignalingMediaTypes="GetSignalingMediaTypes",g.CallStart="CallStart",g.WaitForAnswer="WaitForAnswer",g.WaitForConnect="WaitForConnect",g.Accept="Accept",g))(Si||{}),vi=(g=>(g.InitializeMediaSession="InitializeMediaSession",g.UpdateMediaModalities="UpdateMediaModalities",g.CreateOffer="CreateOffer",g.CreateAnswer="CreateAnswer",g.ProcessAnswer="ProcessAnswer",g.GetSignalingMediaTypes="GetSignalingMediaTypes",g.MuteUnmute="MuteUnmute",g.MuteUnmuteSpeakers="MuteUnmuteSpeakers",g.StartVideoSafe="StartVideoSafe",g.CompleteNegotiation="CompleteNegotiation",g.MuteInput="MuteInput",g.MuteOutput="MuteOutput",g.UnmuteInput="UnmuteInput",g.UnmuteOutput="UnmuteOutput",g.handleEndpointStatesForAccept="handleEndpointStatesForAccept",g))(vi||{}),Ci=(g=>(g.InitializeMediaSession="InitializeMediaSession",g.ProcessOffer="ProcessOffer",g.ProcessOfferedModalities="ProcessOfferedModalities",g.TrySendingProvisionalAnswer="TrySendingProvisionalAnswer",g))(Ci||{}),_i=P,yi=__toESM(P),Ei=__toESM(P),Ti=__toESM(Ce()),Ii={Success:"Success",ExpectedError:"ExpectedError",UnexpectedClientError:"UnexpectedClientError",UnexpectedServerError:"UnexpectedServerError"},bi={INCOMING_MESSAGE_ORIGIN:{TROUTER:"Trouter",BROKER:"Broker"},INVITATION_TYPE:{NUDGE:"nudge"},KNOWN_PAYLOAD_ENCODINGS:{GZIP:!0},WEBRTC_NOTIFICATION_TYPE:{CONTROL_VIDEO_STREAMING:"ControlVideoStreaming",DOMINANT_SPEAKER_INFO:"DominantSpeakerInfo",CSRC_INFO:"CsrcInfo"},PARTICIPANT_AUDIO_STATE:{CONNECTING:"Connecting",RINGING:"Ringing",CONNECTED:"Connected",OTHER:"Other"},HEADERS:{MESSAGE_ID:"X-Microsoft-Skype-Message-ID",ORIGINAL_MESSAGE_ID:"X-Microsoft-Skype-Original-Message-ID",CONTENT_ENCODING:"X-Microsoft-Skype-Content-Encoding",CORRELATION_ID:"X-Microsoft-Skype-Chain-ID",CONTENT_SHARING_CORRELATION_ID:"X-Microsoft-Skype-ContentSharing-Chain-ID",CLIENT_USER_AGENT:"X-Microsoft-Skype-Client",SKYPE_TOKEN:"X-Skypetoken",AUTHORIZATION:"Authorization",BEARER_KEYWORD:"Bearer",AAD_KEYWORD:"Aad",CAE_KEYWORD:"Cae",SKYPE_KEYWORD:"Skype",CACHE_SKYPE_TOKEN:"X-CacheSkypeToken",AUTHENTICATE:"www-authenticate",TOKEN_MIGRATION:"X-MS-Migration",BROKER_USE_BATCHING_HEADER_NAME:"X-UseBatching",PARTICIPANT_ID:"X-Microsoft-Skype-Participant-ID",CONTENT_TYPE:"Content-Type",RING:"MS-Teams-Ring",REGION:"MS-Teams-Region",PARTITION:"MS-Teams-Partition"},KNOWN_BOTS:{VOICEMAIL_BOT_ID:"28:14524421-25b4-403a-a0f7-e62d4379cabc"},HTTP_STACK_ERROR:{NONE:0,CANNOT_CONNECT:7,REQUEST_TIMEOUT:10,ATTEMPT_TIMEOUT:30,REQUEST_ABORTED:16,ATTEMPT_ABORTED:31,ABORTED_OTHER_ATTEMPT_SUCCESSFUL:32},HTTP_STATUS_CODES:{UNKNOWN:0,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404,FORBIDDEN:403,PRECONDITION_FAILED:412,UNPROCESSABLE_ENTITY:422,NETWORK_ERROR:490,SKYPE_TOKEN_ERROR:495,OFFLINE:496,TIMEOUT:498,ABORTED:498,OTHER:499,INTERNAL_SERVER_ERROR:500,CONFLICT:409,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504},CALL_END_SKYPE_TOKEN_ERROR:{code:495,subCode:4507,phrase:"CallEndReasonSkypeTokenFetchError",resultCategories:[Ii.UnexpectedClientError]},CALL_END_TOKEN_TIMEOUT_ERROR:{code:499,subCode:3119,phrase:"CallEndReasonTokenFetchTimeout",resultCategories:[Ii.UnexpectedClientError]},CALL_END_UNSUPPORTED_TOKEN_ERROR:{code:499,subCode:3126,phrase:"CallEndReasonUnsupportedTokenError",resultCategories:[Ii.UnexpectedClientError]},CALL_END_TOKEN_ERROR:{code:499,subCode:3127,phrase:"CallEndReasonTokenFetchError",resultCategories:[Ii.UnexpectedClientError]},CALL_END_LOCAL_HTTP_STACK_ERROR:{code:496,subCode:4520,phrase:"LocalHTTPStackError",resultCategories:[Ii.UnexpectedClientError]},CALL_END_UNKNOWN_ERROR:{code:497,subCode:3121,phrase:"CallEndReasonUnknownError",resultCategories:[Ii.UnexpectedClientError]},CALL_END_NETWORK_ERROR:{code:490,subCode:4502,phrase:"CallEndReasonNetworkError",resultCategories:[Ii.UnexpectedClientError]},CALL_END_LOCAL_DECLINE:{code:486,subCode:4508,phrase:"LocalDecline",resultCategories:[Ii.Success]},RESOURCE_NOT_FOUND_ERROR:{code:404,subCode:404,phrase:"ResourceNotFound",resultCategories:[Ii.ExpectedError]},CALL_STATUS:{IDLE:"Idle",RINGING:"Ringing",CONNECTING:"Connecting",CONNECTED:"Connected",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly",LOCAL_TERMINATED:"LocalTerminated",REMOTE_TERMINATED:"RemoteTerminated"},MEDIA_TYPES:{AUDIO:"Audio",VIDEO:"Video",SCREEN_SHARER:"ScreenSharer",SCREEN_VIEWER:"ScreenViewer"},MUTE_SCOPE:{MYSELF:"Myself",EVERYONE_ELSE:"EveryoneElse",SPECIFIED_PARTICIPANTS:"SpecifiedParticipants"},URL_BASE:{CALLAGENT:"callAgent"},LINKS:{HANGUP:"hangup",MEDIA_REJECTION:"mediaRejection",MEDIA_ANSWER:"mediaAnswer",MEDIA_RENEGOTIATION:"mediaRenegotiation",ACCEPT:"accept",ATTACH:"attach",REJECT:"reject",REDIRECT:"redirect",REPLACE:"replace",TRANSFER:"transfer",NEW_OFFER:"newOffer",TRANSFER_ACCEPTANCE:"transferAcceptance",TRANSFER_COMPLETION:"transferCompletion",CONVERSATION_CONTROLLER:"conversationController",ADD_PARTICIPANT:"addParticipant",ADD_PARTICIPANTS_AND_MODALITY:"addParticipantsAndModality",LEAVE:"leave",NOTIFICATION_LINKS:"notificationLinks",REMOVE_PARTICIPANT:"removeParticipant",KEEPALIVE:"keepAlive",ADD_MODALITY:"AddModality",REMOVE_MODALITY:"RemoveModality",CONTENT_SHARING_CONTROLLER:"contentSharingController",CONTENT_SHARING_TAKE_CONTROL:"contentSharingTakeControl",CONTENT_SHARING_UPDATE_SESSION_STATE:"contentSharingUpdateSessionState",CONTENT_SHARING_UPDATE_PARTICIPANT_STATE:"contentSharingUpdateParticipantState",CONTENT_SHARING_NOTIFICATION_LINKS:"contentSharingNotificationLinks",CONTENT_SHARING_LEAVE:"contentSharingLeave",MUTE:"mute",UNMUTE:"unmute",ADMIT:"admit",ADMIT_ALL:"admitAll",CONTROL_VIDEO_STREAMING:"controlVideoStreaming",APPLY_CHANNEL_PARAMETERS:"applyChannelParameters",UPDATE_ENDPOINT_STATE:"updateEndpointState",UPDATE_ENDPOINT_METADATA:"updateEndpointMetadata",LMC_NOTIFICATION_LINKS:"lmcNotificationLinks",UPDATE_PARTICIPANT_ROLE:"updateParticipantRole",PUBLISH_STATE:"publishState",REMOVE_STATE:"removeState",UPDATE_MEETING_SETTINGS:"updateMeetingSettings",SEARCH_PARTICIPANTS:"searchParticipants",GET_ALL_PARTICIPANTS:"getAllParticipants",PARK:"park",UNPARK:"unpark",UPDATE_MEETING_LIVE_STATE:"updateMeetingLiveState",UPDATE_MEETING_GROUPS:"updateMeetingGroups",SET_MEETING_LAYOUT:"setMeetingLayout",UPDATE_PARTICIPANT_INTERPRETATION_STATE:"updateParticipantInterpretationState",JOIN_MEETING_GROUP:"joinMeetingGroup",LEAVE_MEETING_GROUP:"leaveMeetingGroup",SEND_MESSAGE:"sendMessage",UPDATE_PARTICIPANTS_PROPERTIES:"updateParticipantsProperties",UPDATE_MEDIA_DESCRIPTIONS:"updateMediaDescriptions",UPDATE_MEETING_STATES:"updateMeetingStates"},CONTENT_TYPE:{JSON:"application/json",SDP:"application/sdp"},TROUTER_EVENT_TYPE:{SKYPE_SKYPE_CALL:107,LYNC_SKYPE_CALL:105},MISC:{CONVERSATION:"conversation",LOBBY_CALL_CONTROLLER:"lobby",LOBBY_PARTICIPANT_STATE:"lobby"},SIGNALING_FSM_STATE:{IDLE:"Idle",INCOMING:"Incoming",WAITING_CALL_ACCEPTANCE_ACK:"WaitingCallAcceptanceAck",OUTGOING:"Outgoing",CONNECTED:"Connected",OUTGOING_FOR_ROSTER_ONLY:"OutgoingForRosterOnly",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly"},MEDIA_RENEGOTIATION_FSM_STATE:{IDLE:"Idle",CALL_CONNECTED:"Connected",INCOMING_RENEGOTIATION:"IncomingRenegotiation",OUTGOING_RENEGOTIATION:"OutgoingRenegotiation",RENEGOTIATION_GLARE:"RenegotiationGlare"},CONTENT_SHARING_FSM_STATE:{IDLE:"Idle",CONTENT_SHARING_START_INITIATED:"ContentSharingStartInitiated",CONTENT_SHARING_JOIN_INITIATED:"ContentSharingJoinInitiated",CONTENT_SHARING_LEAVE_INITIATED:"ContentSharingLeaveInitiated",CONTENT_SHARING_DELETE_INITIATED:"ContentSharingDeleteInitiated",CONTENT_SHARING_CONNECTED:"ContentSharingConnected"},TIMEOUT_OPERATIONS:{ADD_PARTICIPANT:"AddParticipant",NUDGE_PARTICIPANT:"NudgeParticipant",REMOVE_PARTICIPANT:"RemoveParticipant",ADMIT_PARTICIPANT:"AdmitParticipant",ADMIT:"Admit",CALL_REDIRECT:"CallRedirect",CALL_ME_BACK:"CallMeBack",INCOMING_CALL_ESTABLISHMENT:"IncomingCallEstablishment",OUTGOING_CALL_ESTABLISHMENT:"OutgoingCallEstablishment",MEDIA_ANSWER:"MediaAnswer",MEDIA_ANSWER_ACKNOWLEDGEMENT:"MediaAnswerAcknowledgement",ADD_MODALITY:"AddModality",UNMUTE:"Unmute",UPDATE_MEETING_ROLE:"UpdateMeetingRole",MAX_PREAHEATED_TIMEOUT:"MaxPreheateadTimeout",PARK_COMPLETION:"ParkCompletion",UNPARK_COMPLETION:"UnparkCompletion",UPDATE_MEETING_LIVE_STATE_COMPLETION:"UpdateMeetingLiveStateCompletion",UPDATE_MEETING_GROUPS_COMPLETION:"UpgradeMeetingGroupsCompletion",UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION:"UpdateParticipantInterpretationStateCompletion",UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION:"UpdateParticipantsPropertiesCompletion",JOIN_MEETING_GROUP_COMPLETION:"JoinMeetingGroupCompletion",LEAVE_MEETING_GROUP_COMPLETION:"LeaveMeetingGroupCompletion",SET_MEETING_LAYOUT_COMPLETION:"SetMeetingLayoutCompletion",SEND_MESSAGE_COMPLETION:"SendMessageCompletion",DISABLE_PREHEAT_ASYNC_TIMEOUT:"DisablePreheatAsyncTimeout",UPDATE_MEETING_STATES_COMPLETION:"UpdateMeetingStatesCompletion"},TIMEOUT_VALUES_IN_SECONDS:{ADD_PARTICIPANT_TIMEOUT:130,REMOVE_PARTICIPANT_TIMEOUT:60,INCOMING_CALL_ESTABLISHMENT_TIMEOUT:75,OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:90,LONGER_OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:185,MEDIA_ANSWER_TIMEOUT:35,MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT:15,ADD_MODALITY_TIMEOUT:65,UNMUTE_TIMEOUT:35,ADMIT_PARTICIPANT_TIMEOUT:120,ADMIT_TIMEOUT:60,UPDATE_MEETING_ROLE_TIMEOUT:15,NUDGE_PARTICIPANT_TIMEOUT:60,CALL_ME_BACK_TIMEOUT:120,MAX_PREAHEATED_TIMEOUT:90,PARK_COMPLETION_TIMEOUT:45,UNPARK_COMPLETION_TIMEOUT:45,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:45,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:45,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT:45,JOIN_MEETING_GROUP_COMPLETION_TIMEOUT:45,LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT:45,CONVERSATION_KEEP_ALIVE_TIMEOUT:2700,TOKEN_REQUIRED_TIMEOUT:20,SEND_MESSAGE_COMPLETION_TIMEOUT:15,DISABLE_PREHEAT_TIMEOUT:45,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:45},CALL_END_CODE:{REJECT:603,SUCCESS:0,CALL_REDIRECTED:302,CANCEL:487,TIMEOUT:408,SERVICE_UNAVAILABLE:500,BAD_REQUEST:406,NO_NGC_ENDPOINT:480,P2P_FALLBACK_FOR_SCREENSHARING:460,CONFLICT:409,MEDIA_ERROR:410,CONF_PARTICIPANT_COUNT_LIMIT_REACHED:413,CALL_DOES_NOT_EXIST:481,CALL_ACCEPTED:450,CALL_FORWARDED:451,CALL_FORWARDED_TO_VOICEMAIL:452,P2P_REJECT_CALL:453,P2P_FALLBACK_DUE_TO_GROUPCALL:461,CALL_LEG_ENDED_ON_SERVICE:470,NOT_ACCEPTABLE_HERE:488,NETWORK_ERROR:490,UNKNOWN_ERROR:497,LOCAL_ERROR:498,CALL_MODALITY_FAILURE:580,ATC_CONTROLLER_FAILURE:581,CVA_CONTROLLER_FAILURE:586,GLARE_ERROR:491,NOT_FOUND:404,SKYPE_TOKEN_ERROR:495,LOCAL_HTTP_STACK_ERROR:496,HTTP_OTHER_ERROR:499,DECODING_FAILED:407,NOT_AUTHORIZED:403,BAD_SERVICE_RESPONSE:400},CALL_END_SUB_CODE:{SUCCESS:0,CALL_REDIRECTED_SUCCESS:3020,DOWNGRADE_TO_STREAMING_CLIENT:3099,MEDIA_DROP_DURING_CONNECT:3100,MEDIA_DROP_AFTER_CONNECT:3101,MEDIA_ANSWER_PROCESSING_ERROR:3102,MEDIA_FINAL_ANSWER_PROCESSING_ERROR:3103,MEDIA_OFFER_TIMEOUT:3104,MEDIA_FINAL_ANSWER_TIMEOUT:3105,MEDIA_OFFER_NULL:3106,MEDIA_AUDIO_DEVICE_ERROR:3107,MEDIA_RENEGOTIATION_ERROR:3108,MEDIA_PERMISSION_ERROR:3109,MEDIA_UNKNOWN_ERROR:3110,MEDIA_OFFER_PROCESSING_ERROR:3111,MEDIA_WHITELISTING_ISSUE:3112,MEDIA_MUTE_MICROPHONE_ERROR:3114,MEDIA_MUTE_SPEAKER_ERROR:3115,MEDIA_UNMUTE_MICROPHONE_ERROR:3116,MEDIA_UNMUTE_SPEAKER_ERROR:3117,MEDIA_GLARE_ERROR:3118,CONVERSATION_TERMINATION_UNKNOWN_ERROR:3121,CONVERSATION_NOTIFICATION_TIMEOUT:3125,CALL_NOT_ATTEMPTED:4500,CONV_URL_NOT_SET:4501,FAILED_TO_REACH_SERVICE:4502,PLACE_CALL_FAILED:4503,ATTACH_CALL_FAILED:4504,BAD_NOTIFICATION_PAYLOAD:4505,CALL_ESTABLISHMENT_TIMEOUT:4506,SKYPE_TOKEN_ERROR:4507,CONVERSATION_RESOLUTION_CONFLICT:5704,CALL_PARTICIPANT_REMOVAL_TIMEOUT:4507,UNMUTE_REQUEST_TIMEOUT:4509,UNMUTE_REQUEST_REJECTED:4510,CONFLICT_IN_NG:4090,CONFLICT_WITH_P2P:4091,CONVERSATION_END_RECEIVED_FROM_SERVICE:4100,TRANSFER_COMPLETE_TIMEOUT:4101,ATTACH_TO_NON_EXISTENT_CALL:4102,ATTACH_ACTION_FAILED:4103,ATTACH_FAILED:4105,CONVERSATION_ESTABLISHMENT_FAILED:4106,BEFORE_CONNECT:4107,AFTER_CONNECT:4108,AFTER_ACCEPT:4109,TROUTER_CONNECTION_DROPPED:4111,DUE_TO_CALL_ASSIMILATION:4112,PREHEATED_CALL_TIMEDOUT:4113,UNPARK_COMPLETION_TIMEOUT:4114,PARK_COMPLETION_TIMEOUT:4115,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:4116,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:4117,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:4118,UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:4119,JOIN_MEETING_GROUP_TIMEOUT:4120,LEAVE_MEETING_GROUP_TIMEOUT:4121,UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:4122,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:4123,MISSING_REQUEST_URI:4511,LOCAL_HTTP_STACK_ERROR:4520,BEACON:4521,CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:5014,UNABLE_TO_GENERATE_MEETUP_ID:5015,UPDATE_MEETING_ROLE_REJECTED:5651,UPDATE_MEETING_ROLE_TIMEOUT:5652,PUBLISH_STATE_LINK_MISSING:5653,PUBLISH_STATE_INVALID_CONTENT:5654,PUBLISH_STATE_INVALID_SERVICE_RESPONSE:5655,REMOVE_STATE_LINK_MISSING:5656,REMOVE_STATE_MISSING_ARGUMENTS:5657,UPDATE_MEETING_SETTINGS_LINK_MISSING:5658,UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS:5659,ADMIT_ALL_LINK_MISSING:5660,ADMIT_TIMEOUT:5661,CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE:5670,ROSTER_HANDLING_INVALID_SERVICE_RESPONSE:5671,SEARCH_PARTICIPANTS_LINK_MISSING:5672,SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5673,GET_ALL_PARTICIPANTS_LINK_MISSING:5674,GET_ALL_PARTICIPANTS_INVALID_SCOPE:5675,GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5676,PARK_UNPARK_TYPE_MISSING:5680,PARK_UNPARK_V2_DISABLED:5682,UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING:5683,DISABLE_PREHEAT_TIMEOUT:5684,CALL_ENDED_BY_PLATFORM_AGENT:7e3},CALL_END_PHRASE:{UNKNOWN:"CallEndReasonUnknown",MEDIA_ERROR:"CallEndReasonMediaError",MEDIA_OFFER_TIMEOUT:"CallEndReasonMediaOfferTimeout",MEDIA_FINAL_ANSWER_TIMEOUT:"CallEndReasonMediaFinalAnswerTimeout",MEDIA_ANSWER_ERROR:"CallEndReasonMediaAnswerError",MEDIA_FINAL_ANSWER_ERROR:"CallEndReasonFinalAnswerError",MEDIA_PERMISSION_ERROR:"CallEndReasonMediaPermissionError",MEDIA_RENEGOTIATION_ERROR:"CallEndReasonRenegotiationError",MEDIA_DROP_DURING_CONNECT:"CallEndReasonMediaDropDuringConnectError",MEDIA_DROP_AFTER_CONNECT:"CallEndReasonMediaDropAfterConnectError",MEDIA_OFFER_PROCESSING_ERROR:"CallEndReasonMediaOfferProcessingError",MEDIA_WHITELISTING_ISSUE:"MediaWhitelistingIssue",AUDIO_ERROR:"CallEndReasonAudioDeviceError",CONVERSATION_NOTIFICATION_TIMEOUT:"ConversationNotificationTimeout",BAD_NOTIFICATION_PAYLOAD:"BadCallNotificationPayload",NETWORK_ERROR:"CallEndReasonNetworkError",LOCAL_USER_INITIATED:"CallEndReasonLocalUserInitiated",REMOTE_USER_INITIATED:"CallEndReasonRemoteUserInitiated",ESTABLISHMENT_TIMEOUT:"CallEndReasonEstablishmentTimeout",PARTICIPANT_REMOVAL_TIMEOUT:"CallParticipantRemovalTimeout",LOCAL_ERROR:"CallEndReasonLocalError",CALL_UPDATE_ERROR:"CallEndReasonCallUpdateError",CALL_REDIRECT_IS_NOT_ALLOWED:"CallRedirectisNotAllowed",P2P_FORK_CONNECTED:"CallEndReasonP2pForkConnected",P2P_FORK_FORWARDED:"CallEndReasonP2pForkForwarded",P2P_FORK_FORWARDED_TO_VOICEMAIL:"CallEndReasonP2pForkForwardedToVoiceMail",P2P_FALLBACK_FOR_SCREENSHARING:"CallEndReasonP2pFallbackForScreensharing",P2P_FALLBACK_FOR_GROUPCALL:"CallEndReasonP2pFallbackForGroupCall",P2P_FALLBACK_FOR_CALL_ASSIMILATION:"CallEndReasonP2pFallbackForCallAssimilation",P2P_FALLBACK_FOR_TRANSLATION:"CallEndReasonP2pFallbackForCallTranslation",P2P_FORK_REJECTED:"CallEndReasonP2pForkRejected",TROUTER_CONNECTION_DROPPED:"CallEndReasonTrouterConnectionDropped",REMOVED_FROM_CALL:"CallEndReasonRemovedFromCall",TRANSFER_COMPLETION_TIMEOUT:"CallEndReasonTransferCompletionTimeout",CALL_DOES_NOT_EXIST:"CallEndReasonCallDoesNotExist",ATTACH_ACTION_FAILED:"CallEndReasonAttachActionFailed",ATTACH_FAILED:"CallEndReasonAttachFailed",CONVERSATION_ESTABLISHMENT_FAILED:"CallEndReasonConversationEstablishmentFailed",CONV_END_FROM_SERVICE:"CallEndReasonConversationEndReceivedFromService",CONV_END_FROM_SERVICE_WITH_ERROR:"CallEndReasonConversationEndReceivedFromServiceWithError",SERVICE_ERROR:"CallEndReasonServiceError",CONFLICT:"CallEndReasonConflict",CALL_ALREADY_IN_P2P:"CallEndReasonCallAlreadyExistsInP2p",CONV_END_NO_MODALITY:"ConversationEndNoModalityConnected",CONV_END_FOR_ALL_INITIATED:"ConversationEndForAllInitiated",RENEGOTIATION_IN_PROGRESS:"NegotiationIsInProgress",ADD_PARTICIPANT_URL_MISSING:"AddParticipantUrlMissing",ADMIT_PARTICIPANT_URL_MISSING:"AdmitParticipantUrlMissing",ADMIT_ALL_URL_MISSING:"AdmitAllUrlMissing",UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING:"UpdateParticipantInterpretationStateUrlMissing",UPDATE_PARTICIPANTS_PROPERTIES_URL_MISSING:"UpdateParticipantsPropertiesUrlMissing",ADMIT_TIMEOUT:"AdmitTimeout",UNABLE_TO_GENERATE_MEETUP_ID:"Unable to generate GroupChat meetup id.",ENDED_BY_PMA:"Call ended by media agent.",OWNERSHIP_RESOLUTION_CONFLICT:"Conversation cannot be created due to a failure to resolve ownership.",CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:"This conversation has ended since we were unable to determine a potential host for the group call.",UNMUTE_REQUEST_TIMEOUT:"UnmuteRequestTimeout",UNMUTE_REQUEST_REJECTED:"UnmuteRequestRejected",UPDATE_MEETING_ROLE_TIMEOUT:"UpdateMeetingRoleTimeout",UPDATE_MEETING_ROLE_REJECTED:"Update meeting role operation failed due to insufficient privileges.",PARK_REQUEST_FAILED:"Park Request Failed",PARK_COMPLETION_TIMEOUT:"ParkCompletionTimeout",PARK_COMPLETION_FAILED:"ParkCompletionFailed",UNPARK_REQUEST_FAILED:"UnparkFailed",UNPARK_COMPLETION_TIMEOUT:"UnparkCompletionTimeout",UNPARK_COMPLETION_FAILED:"UnparkCompletionFailed",BAD_SERVICE_RESPONSE:"BadServiceResponse",UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:"UpdateMeetingLiveStateCompletionTimeout",UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:"UpdateMeetingGroupsCompletionTimeout",SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:"SetMeetingLayoutCompletionTimeout",UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:"UpdateParticipantInterpretationTimeout",JOIN_MEETING_GROUP_TIMEOUT:"JoinMeetingGroupTimeout",LEAVE_MEETING_GROUP_TIMEOUT:"LeaveMeetingGroupTimeout",DOWNGRADE_TO_STREAMING_CLIENT:"DowngradeToStreamingClient",MESSAGE_STATUS_WITH_FAILURE_COUNT:"NotZeroFailureCount",UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:"UpdateParticipantsPropertiesTimeout",DISABLE_PREHEAT_TIMEOUT:"DisablePreheatTimeout",UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:"UpdateMeetingStatesCompletionTimeout"},TRANSACTION_END_CODE:{SUCCESS:0},URL_DEFAULTS:{UPLOAD_LOG_URL:"https://api.cc.skype.com/cc/v1/uploadlog/"},SUCCESS_TRANSACTION_END:{code:0,resultCategories:[Ii.Success]},VALIDATION:{VALIDATION_FAILED:6e3,NULL_OR_EMPTY:6001}},Ai={REQUEST_TIMEOUT:{status:bi.HTTP_STATUS_CODES.TIMEOUT,statusText:"Request timed out",readyState:0,response:bi.HTTP_STACK_ERROR.REQUEST_TIMEOUT},ATTEMPT_TIMEOUT:{status:bi.HTTP_STATUS_CODES.TIMEOUT,statusText:"Attempt timed out",readyState:0,response:bi.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT},REQUEST_ABORTED:{status:bi.HTTP_STATUS_CODES.ABORTED,statusText:"Request Aborted",readyState:0,response:bi.HTTP_STACK_ERROR.REQUEST_ABORTED},ATTEMPT_ABORTED:{status:bi.HTTP_STATUS_CODES.ABORTED,statusText:"Attempt Aborted",readyState:0,response:bi.HTTP_STACK_ERROR.ATTEMPT_ABORTED}},Ri={MEDIA_ACKNOWLEDGEMENT:"/call/mediaAcknowledgement/",MEDIA_REJECTION:"/call/rejection/",ACKNOWLEDGEMENT:"/call/acknowledgement/",MEDIA_RENEGOTIATION:"/call/mediaRenegotiation/",REPLACE:"/call/replacement/",PROGRESS:"/call/progress/",MEDIA_ANSWER:"/call/mediaAnswer/",NEW_MEDIA_OFFER:"/call/newMediaOffer/",REDIRECTION:"/call/redirection/",BALANCE_UPDATE:"/call/balanceUpdate/",ACCEPT:"/call/acceptance/",CONTROL_VIDEO_STREAMING:"/call/controlVideoStreaming/",DOMINANT_SPEAKER_INFO:"/call/dominantSpeakerInfo/",CSRC_INFO:"/call/csrcInfo/",END:"/call/end/",RETARGET_COMPLETION:"/call/retargetCompletion/",TRANSFER:"/call/transfer/",TRANSFER_ACCEPTANCE:"/call/transferAcceptance/",TRANSFER_COMPLETION:"/call/transferCompletion/",PARK_COMPLETION:"/call/holdCompletion/",UNPARK_COMPLETION:"/call/resumeCompletion/",UPDATE_MEDIA_DESCRIPTIONS:"/call/updateMediaDescriptions"},Pi={CONV_END:"/conversation/conversationEnd/",CONV_UPDATE:"/conversation/conversationUpdate/",CONV_LOCAL_PARTICIPANT_UPDATE:"/conversation/localParticipantUpdate/",CONV_ROSTER_UPDATE:"/conversation/rosterUpdate/",CONV_ADD_PARTICIPANT_SUCCESS:"/conversation/addParticipantSuccess/",CONV_ADD_PARTICIPANT_FAILURE:"/conversation/addParticipantFailure/",CONV_NUDGE_PARTICIPANT_SUCCESS:"/conversation/nudgeParticipantSuccess/",CONV_NUDGE_PARTICIPANT_FAILURE:"/conversation/nudgeParticipantFailure/",CONV_ADMIT_PARTICIPANT_SUCCESS:"/conversation/admitParticipantSuccess/",CONV_ADMIT_PARTICIPANT_FAILURE:"/conversation/admitParticipantFailure/",CONV_ADMIT_ALL_STATUS:"/conversation/admitAllStatus/",CONV_REMOVE_PARTICIPANT_SUCCESS:"/conversation/removeParticipantSuccess/",CONV_REMOVE_PARTICIPANT_FAILURE:"/conversation/removeParticipantFailure/",CONV_ADD_MODALITY_SUCCESS:"/conversation/addModalitySuccess/",CONV_ADD_MODALITY_FAILURE:"/conversation/addModalityFailure/",CONV_CONTENT_SHARING_UPDATE:"/conversation/contentSharingUpdate/",CONV_CONTENT_SHARING_END:"/conversation/contentSharingEnd/",CONV_BROADCAST_UPDATE:"/conversation/broadcastUpdate/",CONV_CONFIRM_UNMUTE:"/conversation/confirmUnmute/",CONV_UNMUTE_SUCCESS:"/conversation/unmuteSuccess/",CONV_UNMUTE_FAILURE:"/conversation/unmuteFailure/",UPDATE_MEETING_LIVE_STATE_STATUS:"/conversation/updateMeetingLiveStateStatus/",UPDATE_MEETING_GROUPS_STATUS:"/conversation/updateMeetingGroupsStatus/",SET_MEETING_LAYOUT_STATUS:"/conversation/setMeetingLayoutStatus/",UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS:"/conversation/updateParticipantInterpretationStateStatus/",UPDATE_PARTICIPANT_PROPERTIES_STATUS:"/conversation/updateParticipantPropertiesStatus/",JOIN_MEETING_GROUP_STATUS:"/conversation/joinMeetingGroupStatus/",LEAVE_MEETING_GROUP_STATUS:"/conversation/leaveMeetingGroupStatus/",RECEIVE_MESSAGE:"/conversation/receiveMessage/",SEND_MESSAGE_STATUS:"/conversation/sendMessageStatus/",DISABLE_PREHEAT_ASYNC_STATUS:"/conversation/disablePreheatAsyncStatus/",UPDATE_MEETING_STATES_STATUS:"/conversation/updateMeetingStatesStatus/"},Mi={...Ri,...Pi},wi={CALL_NOTIFICATION:"callNotification",MEDIA_ANSWER:"mediaAnswer",MEDIA_ACKNOWLEDGEMENT:"mediaAcknowledgement",CALL_ACCEPTANCE:"callAcceptance",CALL_END:"callEnd",CALL_PROGRESS:"callProgress",CALL_ACCEPTANCE_ACKNOWLEDGEMENT:"callAcceptanceAcknowledgement",MEDIA_NEGOTIATION:"mediaNegotiation",MEDIA_NEGOTIATION_FAILURE:"mediaNegotiationFailure",BALANCE_UPDATE:"balanceUpdate",RETARGET_COMPLETED:"retargetCompleted",CALL_TRANSFER:"callTransfer",TRANSFER_COMPLETION:"transferCompletion",TRANSFER_ACCEPTANCE:"transferAcceptance",PARK_COMPLETION:"holdCompletion",UNPARK_COMPLETION:"resumeCompletion",UPDATE_MEETING_LIVE_STATE_RESPONSE:"updateMeetingLiveStateResponse",UPDATE_MEETING_GROUPS_RESPONSE:"updateMeetingGroupsResponse",SET_MEETING_LAYOUT_RESPONSE:"setMeetingLayoutResponse",UPDATE_MEETING_STATES_RESPONSE:"updateMeetingStatesResponse"},Di=bi,Oi=__toESM(P),Ni=class _HttpHeaderImpl{constructor(g){this.headers={},g&&Object.keys(g).forEach((m=>{this.headers[this.getLowerCaseName(m)]=g[m]}))}isEmpty(){return Oi.isEmpty(this.headers)}set(g,m){this.headers[this.getLowerCaseName(g)]=m}get(g,m){return m?_HttpHeaderImpl.getHeaderValue(this.headers,g)||m:_HttpHeaderImpl.getHeaderValue(this.headers,g)}delete(g){delete this.headers[g],delete this.headers[g.toLowerCase()]}hasOwnPropertyCaseInsensitive(g){return Object.keys(this.headers).filter((function(m){return m.toUpperCase()===g.toUpperCase()})).length>0}getAll(){return this.headers}getLowerCaseName(g){return _HttpHeaderImpl.useLowerCaseHeaders?g.toLowerCase():g}static getHeaderValue(g,m){return g.hasOwnProperty(m)?g[m]:g.hasOwnProperty(m.toLowerCase())?g[m.toLowerCase()]:void 0}};function get(g,m,S=causeId2()){return assertNotNullOrEmpty(m,"trailingPath cannot be null"),assertNotNull(g,"signalingSession cannot be null"),assertNotNull(g.baseMessagingChannelUrl,"messaging channel url is not set"),`${g.baseMessagingChannelUrl}${Di.URL_BASE.CALLAGENT}/${g.sessionId}/${S}${m}`}function getIdFromUrl(g){const m=g.match(new RegExp(`/${escapeRegExp(Di.URL_BASE.CALLAGENT)}/+([^/]+)`,"i"));return m?m[1]:null}function clientSupportedTokenTypes(g){let m=1;return g.callingServiceSupportsAADTokens&&(m|=4),g.callingServiceSupportsCAETokens&&(m|=8),m}function parseServiceTokenTypes(g){const m=g.toLowerCase(),S='token_types="',v=m.indexOf(S);if(-1===v)return[];const C=m.indexOf('"',v+S.length);if(-1===C)return[];const _=m.substring(v+S.length,C).trim();if(""===_)return[];return _.split(" ")}function is1to1Mri(g){return!!g.match(/^8:/)}function stripMri(g){return g.replace(/^\d+:/,"")}function causeId2(){return newGuid().substr(0,8)}function newMessageId(g){return g&&/^[a-z0-9]{8}$/.test(g)?g+newGuid().substr(8):newGuid()}function newGuid(){const g="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",m="0123456789abcdef";let S="",v=0,C=0;for(;C<36;){const _=g[C];switch(v=C%8==0?4294967295*Math.random()|0:v>>4,_){case"x":S+=m[15&v];break;case"y":S+=m[3&v|8];break;case"4":case"-":S+=_}C++}return S}function assert2(g,m){if(!g)throw new Error("Assert failed"+(void 0!==m?`:${m}`:""))}function assertNotNullOrEmpty(g,m){if(!g||g instanceof String&&""===g||g instanceof Array&&0===g.length)throw new Error("AssertNotNullOrEmpty failed. "+(void 0!==m?`: ${m}`:""))}function assertNotNull(g,m){if(!g)throw new Error("AssertNotNull failed. "+(void 0!==m?`: ${m}`:""))}function assertCallEndReason(g){if(assertNotNullOrEmpty(g,"callEndReason cannot be null or empty"),void 0===g.code||void 0===g.subCode||void 0===g.phrase||g.code<0||g.subCode<0||" "===g.phrase)throw new Error(`callEndReason must specify code, subCode and phrase. Invalid reason : ${getPrintableObject(g)}`)}function getMediaTypes(g){assertNotNull(g,"MediaTypes passed cannot be null");const m=[],S=Di.MEDIA_TYPES;for(const v of Object.keys(S))arrayContains(g,S[v])&&m.push(S[v]);return m}function getLinksPayload(g,m){const S={};for(const v of Object.values(m)){const m=v.split("/");S[m[m.length-2]]=get(g,v)}return S}function stringEndsWith(g,m){return g.length>=m.length&&g.indexOf(m,g.length-m.length)>-1}function arrayContains(g,m){const S=m.toString().toLowerCase();return g.map((g=>g.toString().toLowerCase())).indexOf(S)>-1}function tryAddNewKeyToHashTable(g,m,S){return!g.hasOwnProperty(m)&&(g[m]=S,!0)}function tryRemoveKeyFromHashTable(g,m){return!!g.hasOwnProperty(m)&&(delete g[m],!0)}function escapeRegExp(g){return g.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function tryParse(g){let m=null;try{return m=JSON.parse(g),"object"==typeof m?m:null}catch(g){return null}}function getErrorForXHRFailure(g,m){if(!g)return{telemetryEndSubCode:Di.CALL_END_CODE.UNKNOWN_ERROR,error:Di.CALL_END_UNKNOWN_ERROR};let S;if("object"==typeof g.response)S=g.response;else try{S=JSON.parse(g.response)}catch(g){}if(g.skypeTokenError)return{telemetryEndSubCode:Di.CALL_END_CODE.SKYPE_TOKEN_ERROR,error:Di.CALL_END_SKYPE_TOKEN_ERROR};if(g.tokenTimeoutError)return{telemetryEndSubCode:Di.CALL_END_CODE.HTTP_OTHER_ERROR,error:Di.CALL_END_TOKEN_TIMEOUT_ERROR};if(g.tokenError)return{telemetryEndSubCode:Di.CALL_END_CODE.HTTP_OTHER_ERROR,error:Di.CALL_END_TOKEN_ERROR};if(S&&(S.operationFailure||S.broadcastOperationFailure)){const g=S.operationFailure||S.broadcastOperationFailure;return{telemetryEndSubCode:g.code,error:g}}return S?.code?{telemetryEndSubCode:S.code,error:S}:isNaN(g.status)||g.status!==Di.CALL_END_CODE.NOT_FOUND?!isNaN(g.status)&&g.status?{telemetryEndSubCode:g.status,error:{code:g.status,subCode:isNaN(g.response)?0:g.response,phrase:g.statusText,resultCategories:[Ii.UnexpectedClientError]}}:!isNaN(g.response)&&g.response?{telemetryEndSubCode:0,error:{code:0,subCode:g.response,phrase:g.statusText,resultCategories:[Ii.UnexpectedClientError]}}:{telemetryEndSubCode:Di.CALL_END_CODE.NETWORK_ERROR,error:Di.CALL_END_NETWORK_ERROR}:{telemetryEndSubCode:Di.CALL_END_CODE.NOT_FOUND,error:Di.RESOURCE_NOT_FOUND_ERROR}}function isDuplicateMessage(g,m){if(g&&!g.isEmpty()&&m){const S=g.get(Di.HEADERS.ORIGINAL_MESSAGE_ID),v=g.get(Di.HEADERS.MESSAGE_ID);if(v&&arrayContains(m,v)||S&&arrayContains(m,S))return!0;m.length>9&&m.shift(),m.push(S||v)}return!1}function extractMessageIdFromMessage(g){const m="unknown";return g.headers?g.headers.get(Di.HEADERS.ORIGINAL_MESSAGE_ID,m):m}function extractCauseIdFromMessage(g){try{return g.headers.get(Di.HEADERS.ORIGINAL_MESSAGE_ID).replace("-","").substr(0,8)}catch(g){return causeId2()}}function cacheMessageResult(g,m,S){if(g&&m){const v=g.get(Di.HEADERS.ORIGINAL_MESSAGE_ID)||g.get(Di.HEADERS.MESSAGE_ID)||null;v&&(m[v]=S)}}function getMessageResultFromCache(g,m){if(g){return m[g.get(Di.HEADERS.ORIGINAL_MESSAGE_ID)||g.get(Di.HEADERS.MESSAGE_ID)||null]||null}return null}function isEncodedMessage(g){return g&&g.hasOwnPropertyCaseInsensitive(Di.HEADERS.CONTENT_ENCODING)}function isMessageEncodingSupported(g){return g&&Di.KNOWN_PAYLOAD_ENCODINGS.hasOwnProperty(g.get(Di.HEADERS.CONTENT_ENCODING).toUpperCase())}function parseRawHttpMessage(g){const m=g.split(/\r?\n\r?\n/),S=m[0].split(/\r?\n/),v=m[1].split(/\r?\n/),C=S.shift().split(" "),_=C[0],E=C[1]||"",T=new Ni;for(const g of S)try{const[m,S]=g.split(":").map((g=>Ei.trim(g)));T.set(m,S)}catch(m){throw new Error(`Malformed header: ${g+m}`)}return{url:E,headers:T,method:_,body:v.join("")}}function decodeMessage(g){const m=atob(g);return Ti.inflate(m,{to:"string"})}function defer2(){let g,m,S=!0;return{isPending:()=>S,promise:new Promise(((S,v)=>{g=S,m=v})),resolve:m=>{S&&(g(m),S=!1)},reject:g=>{S&&(m(g),S=!1)}}}function isTrouterAndNavigatorConnected(g){let m=!1;try{if(m=g&&2===g.state(),navigator.onLine&&m)return 3;if(!navigator.onLine&&m)return 2;if(navigator.onLine&&!m)return 1}catch{}return 0}function isRetryable(g){return[Di.HTTP_STATUS_CODES.UNKNOWN,Di.HTTP_STATUS_CODES.UNAUTHORIZED,Di.HTTP_STATUS_CODES.NETWORK_ERROR,Di.HTTP_STATUS_CODES.OFFLINE,Di.HTTP_STATUS_CODES.TIMEOUT,Di.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,Di.HTTP_STATUS_CODES.BAD_GATEWAY,Di.HTTP_STATUS_CODES.SERVICE_UNAVAILABLE,Di.HTTP_STATUS_CODES.GATEWAY_TIMEOUT].indexOf(g)>=0}function convertStringToTokenType(g,m){switch(g){case Di.HEADERS.CAE_KEYWORD.toLowerCase():return 8;case Di.HEADERS.AAD_KEYWORD.toLowerCase():return 4;case Di.HEADERS.SKYPE_KEYWORD.toLowerCase():return 1;default:return m?.info("unexpected: unrecognized token type ${tokenType}"),null}}function getAuthHeadersTokenTypes(g,m,S,v,C){if(!m)return 1;const{callingServiceSupportsAADTokens:_,callingServiceSupportsCAETokens:E,supportMissingTokenTypesInResponse:T,useSkypeTokenWhenNoAuthenticateHeader:I}=g,b=C?.authenticationHeaders;v?.info(`[getAuthHeadersTokenTypes] UnauthorizedResponse=${S} and authHeaders=${b}`);let A=null;if(!b&&S)I?(v?.info("[getAuthHeadersTokenTypes] no www-authenticate header received, fallback to skype token"),A=1):(v?.info("[getAuthHeadersTokenTypes] Service has not provided www-authenticate headers. use client supported tokens"),A=clientSupportedTokenTypes(g));else if(b||S){if(b&&S)for(const m of b){const S=parseServiceTokenTypes(m);if(T&&0===S.length)v?.info("[getAuthHeadersTokenTypes] Service has www-authenticate header, but no token types. Use client supported tokens"),A=clientSupportedTokenTypes(g);else for(const g of S){const m=convertStringToTokenType(g.toLowerCase(),v);E&&8===m&&(A|=8),_&&4===m&&(A|=4),1===m&&(A|=1)}}}else v?.info("[getAuthHeadersTokenTypes] first time requesting token, request client supported token types"),A=clientSupportedTokenTypes(g);return A}function getRequestTypeAsString(g){switch(g){case 0:return"GET";case 1:return"POST";case 2:return"PUT";case 3:return"DELETE"}}function extractWwwauthenticateHeaders(g){let m={};if(g){const S=Ni.getHeaderValue(g,Di.HEADERS.AUTHENTICATE);S&&(m={authenticationHeaders:[S]})}return m}function getTokenMetadata(g,m,S,v,C=!1,_,E){E?.createChild("[utils.ts]");const T={verb:getRequestTypeAsString(S),path:v.url},I=JSON.stringify(T),b=extractWwwauthenticateHeaders(_),A=getAuthHeadersTokenTypes(g,m,C,E,b);return E?.info(`[getTokenMetadata] return token type=${A}, factoJson=${I}, headers=${b?.authenticationHeaders}`),{tokenType:A,factorsJson:I,requestMetadataJson:b,isUnauthorized:C}}function epochTimeInSecRoundedDown(){return Math.floor(Date.now()/1e3)}function millieSecondsToSeconds(g){return g/1e3}function secondsToMillieSeconds(g){return 1e3*g}function getRequestToken(g){const m=Ni.getHeaderValue(g,Di.HEADERS.SKYPE_TOKEN);if(m)return m;const S=Ni.getHeaderValue(g,Di.HEADERS.AUTHORIZATION);if(S){const g=S.split(" ");if(2===g.length)return g[1]}}function getParkTypeName(g){switch(g){case"none":return"None";case"teamPark":return"TeamPark";case"callPark":return"CallParkV2";case"serverHold":return"ServerHold";case"serverHoldV2":return"MusicOnHoldV2";case"sharedLinePark":return"SharedLinePark";case"sharedLineParkV2":return"SharedLineAppearanceV2";default:return"UnknownType"}}function getPluginlessStateTypeFromWire(g){switch(g){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishType to PublishStateType."}}function getPluginlessStateType(g){switch(g){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishStateType to PublishType."}}var ki=class _Participant{static isInLobby(g,m){for(const S of g)if(S.endpointId===m&&S.isLobby)return!0;return!1}static isParticipantServerMuted(g){for(const m of g)if(m.mediaStreams&&!m.mappedTo)for(const g of m.mediaStreams)if("audio"===g.type&&!0===g.serverMuted)return!0;return!1}static fromWireParticipant(g){return assertNotNull(g,"invalid wireParticipant"),assertNotNullOrEmpty(g.id,"participant must have valid Id"),new _Participant({id:g.id,displayName:g.displayName,languageId:g.languageId,acceptedBy:g.acceptedBy})}static getPluginlessStateTypeFromWire(g){return getPluginlessStateTypeFromWire(g)}static findOrCreateTypeState(g,m){let S=m.typeStates.findIndex((m=>m.type===g));if(-1===S){const v={participantStates:[],type:g};m.typeStates.push(v),S=m.typeStates.length-1}return S}static processPublishedStates(g,m){const S={typeStates:[]};S.typeStates=[];const v=g;return yi.forEach(v,(g=>{const v=this.findOrCreateTypeState(this.getPluginlessStateTypeFromWire(g.stateType),S),C={id:m,publishedState:{content:g.content,stateId:g.stateId,typeRank:g.typeRank}};S.typeStates[v].participantStates.push(C)})),S}static fromRosterEndpoints(g){let m=[],S=!1,v=!1,C=!1,_=!1;return m=Object.keys(g).map((m=>{let E,T,I=[],b=!1,A=0;if(g[m].call&&(S=!0,I=g[m].call.mediaStreams||null,A=g[m].call.serverMuteVersion||0,T=g[m].call.appliedInteractivityLevel||"unknown"),g[m].lobby&&(b=!0,v=!0,I=g[m].lobby.mediaStreams||null),g[m].broadcast?.sessionInformation&&(E=g[m].broadcast.sessionInformation.role||null),g[m].mappedParticipant&&(C=!0,I=g[m].mappedParticipant.mediaStreams||null),!g[m].capabilities&&g[m].endpointCapabilities){const S=g[m].endpointCapabilities;g[m].capabilities={implicitCallback:16&S?"enabled":"disabled",cloudAudioVideoConference:1&S?"enabled":"disabled",cloudScreenSharing:2&S?"enabled":"disabled",hostlessConference:4&S?"enabled":"disabled",autoJoinOnConflict:32&S?"enabled":"disabled",serverMuteUnmute:64&S?"enabled":"disabled",supportsCompressedServicePayload:128&S?"enabled":"disabled",cloudMerge:8&S?"enabled":"disabled"}}return _=_||!!g[m].streamLobby||!!g[m].stream,{endpointId:m,participantId:g[m].participantId||null,clientVersion:g[m].clientVersion||null,endpointMetadata:g[m].endpointMetadata||null,originalId:g[m].originalId||null,contentSharing:g[m].contentSharing||null,capabilities:g[m].capabilities||null,endpointType:g[m].endpointType||"default",deviceType:g[m].deviceType||void 0,clientEndpointCapabilities:g[m].clientEndpointCapabilities||void 0,mediaStreams:I,serverMuteVersion:A,broadcastMeetingRole:E,isLobby:b,endpointState:g[m].endpointState||null,publishedStates:g[m].publishedStates||null,callLinks:g[m].callLinks||null,appliedInteractivityLevel:T||"unknown",mappedTo:g[m].mappedTo||null,meetingGroupDetails:g[m].meetingGroupDetails,streamInformation:g[m].streamInformation,propertyBag:g[m].propertyBag,streamLobby:g[m].streamLobby,stream:g[m].stream}})),{endpointDetails:m,participantHasCallModality:S,participantIsInLobby:v,participantHasMappedEndpoint:C,participantHasStreamEndpoint:_}}static fromRoster(g,m=!1){assertNotNull(g,`invalid rosterParticipant ${JSON.stringify(g)}`),assertNotNullOrEmpty(g.details.id,"participant must have valid Id");const S=g.endpoints||{},v=this.fromRosterEndpoints(S),C=v.endpointDetails,_=v.participantHasCallModality,E=v.participantHasMappedEndpoint,T=v.participantHasStreamEndpoint;let I=v.participantIsInLobby;return _||I||E||m||T?(_&&(I=!1),new _Participant({id:g.details.id,displayName:g.details.displayName,version:g.version||0,propertyBag:g.details.propertyBag||null,languageId:g.details.languageId,role:g.role||"",tenantId:g.details.tenantId||"",endpointDetails:C||[],acceptedBy:g.acceptedBy||"",isLobby:I,meetingRole:g.meetingRole,advancedMeetingRole:g.advancedMeetingRole,participantType:g.details.participantType,publishedStates:g.publishedStates||null,isIdentityMasked:g.details.isIdentityMasked,nonMaskedId:g.details.nonMaskedId||"",nonMaskedObjectId:g.details.nonMaskedObjectId||"",nonMaskedDisplayName:g.details.nonMaskedDisplayName||"",maskedIdSeqNumber:g.details.maskedIdSeqNumber||0,maskedId:g.details.maskedId||""})):null}static fromRosterSearchResults(g){assertNotNull(g,`invalid rosterParticipant ${JSON.stringify(g)}`),assertNotNullOrEmpty(g.details.id,"participant must have valid Id");const m=g.endpoints,S=this.fromRosterEndpoints(m),v=S.endpointDetails,C=S.participantHasCallModality,_=S.participantIsInLobby,E=S.participantHasMappedEndpoint;let T=0;return C?T=3:_?T=10:E&&(T=3),{id:g.details.id,state:T,tenantId:g.details.tenantId||"",displayName:g.details.displayName,role:g.role||"",meetingRole:g.meetingRole,advancedMeetingRole:g.advancedMeetingRole,participantType:g.details.participantType,isServerMuted:this.isParticipantServerMuted(v),publishedStates:this.processPublishedStates(g.publishedStates,g.details.id),endpoints:v||[],isIdentityMasked:g.details.isIdentityMasked,nonMaskedId:g.details.nonMaskedId||"",nonMaskedDisplayName:g.details.nonMaskedDisplayName||"",nonMaskedObjectId:g.details.nonMaskedObjectId||"",maskedIdSeqNumber:g.details.maskedIdSeqNumber||0,maskedId:g.details.maskedId||""}}constructor(g){this.id=g.id,this.displayName=g.displayName||"",this.version=g.version,this.propertyBag=g.propertyBag,this.languageId=g.languageId||null,this.endpointDetails=g.endpointDetails||[],this.acceptedBy=g.acceptedBy,this.role=g.role,this.tenantId=g.tenantId,this.isLobby=g.isLobby,this.meetingRole=g.meetingRole,this.advancedMeetingRole=g.advancedMeetingRole,this.participantType=g.participantType,this.publishedStates=g.publishedStates,this.isIdentityMasked=g.isIdentityMasked,this.nonMaskedId=g.nonMaskedId,this.nonMaskedDisplayName=g.nonMaskedDisplayName,this.nonMaskedObjectId=g.nonMaskedObjectId,this.maskedIdSeqNumber=g.maskedIdSeqNumber,this.maskedId=g.maskedId}},Li={HANDLE_MEDIA_ACKNOWLEDGEMENT:"HandleMediaAcknowledgement",HANDLE_MEDIA_NEGOTIATION_FAILURE:"HandleMediaNegotiationFailure",HANDLE_MEDIA_ANSWER:"HandleMediaAnswer",HANDLE_MEDIA_ANSWER_FAILED:"HandleMediaAnswerFailed",HANDLE_MEDIA_OFFER:"HandleMediaOffer",REJECT_RENEGOTIATION:"RejectRenegotiation",HANDLE_RETARGET_COMPLETED:"HandleRetargetCompleted",HANDLE_MEDIA_ANSWER_TIMEOUT:"HandleMediaAnswerTimeout",HANDLE_MEDIA_ACKNOWLEDGEMENT_TIMEOUT:"HandleMediaAcknowledgementTimeout",ACCEPT_RENEGOTIATION:"AcceptRenegotiation",START_RENEGOTIATION:"StartRenegotiation",MEDIA_FSM_STATE_CHANGED:"MediaFsmStateChanged",ADD_MODALITY_TIMEOUT:"AddModalityTimeout",ADD_PARTICIPANT:"AddParticipant",ADD_PARTICIPANT_TIMEOUT:"AddParticipantTimeout",ADD_PARTICIPANT_WITH_REPLACES:"AddParticipantWithReplaces",ADD_PARTICIPANT_WITH_REPLACES_TIMEOUT:"AddParticipantWithReplacesTimeout",ADD_PARTICIPANTS_AND_MODALITY:"AddParticipantsAndModality",ADMIT_PARTICIPANT:"AdmitParticipant",ADMIT_PARTICIPANT_TIMEOUT:"AdmitParticipantTimeout",ADMIT:"Admit",ADMIT_TIMEOUT:"AdmitTimeout",ADMIT_FAILURE:"AdmitFailure",ADMIT_SUCCESS:"AdmitSuccess",CALL_ME_BACK:"CallMeBack",CALL_ME_BACK_TIMEOUT:"CallMeBackTimeout",REMOVE_PARTICIPANT:"RemoveParticipant",REMOVE_PARTICIPANT_OTHERS:"RemoveParticipantOthers",REMOVE_PARTICIPANT_SPECIFIED:"RemoveParticipantSpecified",REMOVE_PARTICIPANT_TIMEOUT:"RemoveParticipantTimeout",HANDLE_ADD_PARTICIPANT_SUCCESS:"HandleAddParticipantSuccess",HANDLE_ADD_PARTICIPANT_FAILURE:"HandleAddParticipantFailure",HANDLE_ADMIT_PARTICIPANT_SUCCESS:"HandleAdmitParticipantSuccess",HANDLE_ADMIT_PARTICIPANT_FAILURE:"HandleAdmitParticipantFailure",HANDLE_ADD_PARTICIPANT_MODALITY_FAILURE:"HandleAddParticipantModalityFailure",HANDLE_REMOVE_PARTICIPANT_SUCCESS:"HandleRemoveParticipantSuccess",HANDLE_REMOVE_PARTICIPANT_FAILURE:"HandleRemoveParticipantFailure",HANDLE_ROSTER_UPDATE:"HandleRosterUpdate",HANDLE_ROSTER_UPDATE_FAIL:"HandleRosterUpdateFail",HANDLE_CONVERSATION_UPDATE:"HandleConversationUpdate",HANDLE_LOCAL_PARTICIPANT_UPDATE:"HandleLocalParticipantUpdate",SET_SUBJECT:"SetSubject",SET_JOINED_FROM:"SetJoinedFrom",SET_DEVICETYPE:"SetDeviceType",GET_EMERGENCY_CONTENT:"GetEmergencyContent",SET_MULTIPARTY:"SetMultiparty",SET_GROUPID:"SetGroupId",SET_THREADID:"SetThreadId",SET_CALLOPTIONS:"SetCallOptions",SET_TRANSFER_CONTEXT:"SetTransferContext",START_CALL:"StartCall",JOIN_CALL:"JoinCall",JOIN_CONVERSATION_WITHOUT_CALL_MODALITY:"JoinConversationWithoutCallModality",HANDLE_INCOMING_CALL:"HandleIncomingCall",END_CALL:"EndCall",END_WITH_BEACON:"EndWithBeacon",CONFLICTED_CALL:"ConflictedCall",SET_PROVISIONAL_ANSWER:"SetProvisionalAnswer",SET_PROVISIONAL_ANSWER_FAILED:"SetProvisionalAnswerFailed",ACCEPT_CALL:"AcceptCall",ACCEPT_CALL_FAILED:"AcceptCallFailed",HANDLE_CALL_ACCEPTANCE_ACK:"HandleCallAcceptanceAck",HANDLE_CALL_ACCEPTANCE:"HandleCallAcceptance",HANDLE_CALL_ACCEPTANCE_SYNC:"HandleCallAcceptanceSync",HANDLE_CALL_ACCEPTANCE_FAILED:"HandleCallAcceptanceFailed",HANDLE_CALL_ESTABLISHMENT_TIMEOUT:"HandleCallEstablishmentTimeout",HANDLE_CALL_END:"HandleCallEnd",HANDLE_CALL_PROGRESS:"HandleCallProgress",TROUTER_URL_CHANGED:"TrouterUrlChanged",TROUTER_STATE_CHANGED:"TrouterStateChanged",TROUTER_URL_CHANGED_TO_INVALID:"TrouterUrlChangedToInvalid",TROUTER_URL_UPDATE_FAILED:"TrouterUrlUpdateFailed",ADD_CONTENT_SHARING_MODALITY:"AddContentSharingModality",ACCEPTED_BEFORE_RINGING:"AcceptedBeforeRinging",LEAVE_CONTENT_SHARING:"LeaveContentSharing",DELETE_CONTENT_SHARING:"DeleteContentSharing",TAKE_CONTROL_CONTENT_SHARING:"TakeControlContentSharing",UPDATE_SESSION_STATE_CONTENT_SHARING:"UpdateSessionStateContentSharing",JOIN_CONTENT_SHARING:"JoinContentSharing",UPDATE_PARTICIPANT_STATE_CONTENT_SHARING:"UpdateParticipantStateContentSharing",HANDLE_CONTENT_SHARING_UPDATE:"HandleContentSharingUpdate",HANDLE_CONTENT_SHARING_END:"HandleContentSharingEnd",CONTENT_SHARING_START_FROM_ROSTER:"ContentSharingStartFromRoster",CONTENT_SHARING_END_FROM_ROSTER:"ContentSharingEndFromRoster",HANDLE_ADD_MODALITY_SUCCESS:"HandleAddModalitySuccess",HANDLE_ADD_MODALITY_FAILURE:"HandleAddModalityFailure",ADD_BROADCAST_MODALITY:"AddBroadcastModality",UPDATE_BROADCAST_DETAILS:"UpdateBroadcastDetails",WAITING_FOR_ADD_BROADCAST_MODALITY_COMPLETION:"WaitingForAddBroadcastModalityCompletion",MUTE:"Mute",NUDGE_PARTICIPANT_TIMEOUT:"NudgeParticipantTimeout",UNMUTE:"Unmute",UNMUTE_TIMEOUT:"UnmuteTimeout",HANDLE_UNMUTE_CONFIRM:"HandleUnmuteConfirm",HANDLE_UNMUTE_SUCCESS:"HandleUnmuteSuccess",HANDLE_UNMUTE_FAILURE:"HandleUnmuteFailure",APPROVE_UNMUTE:"ApproveUnmute",REJECT_UNMUTE:"RejectUnmute",HANDLE_CONTROL_VIDEO_STREAMING:"HandleControlVideoStreaming",HANDLE_DOMINANT_SPEAKER_CHANGED_COUNT:"HandleDominantSpeakerChangedCount",HANDLE_CSRC_INFO:"HandleCsrcInfo",SEND_WEBRTC_MEDIA_NOTIFICATION:"SendWebRtcMediaNotification",HANDLE_BALANCE_UPDATE:"HandleBalanceUpdate",TRANSFER_CALL:"TransferCall",PARK_CALL:"ParkCall",CALL_REDIRECT:"CallRedirect",CALL_REDIRECT_REQUEST_FAILED:"CallRedirectRequestFailed",TRANSFER_COMPLETION_FAILED:"TransferCompletionFailed",TRANSFER_REQUEST_RECEIVED:"TransferRequestReceived",HANDLE_PARK_REQUESTED:"HandleParkRequested",HANDLE_SERVER_HOLD:"HandleServerHold",DUPLICATE_MESSAGE_IGNORED:"DuplicateMessageIgnored",CORRELATION_ID_UPDATED:"CorrelationIdUpdated",UNKNOWN_MESSAGE_TYPE:"UnkownMessageType",FAILED_TO_HANDLE_MESSAGE:"FailedToHandleMessage",CONNECTIVITY_CHANGED:"ConnectivityChanged",TROUTER_DECODE_PAYLOAD_FAILURE:"TrouterDecodePayloadFailure",UPDATE_ENDPOINT_STATE:"UpdateEndpointState",UPDATE_ENDPOINT_STATE_SUCCESS:"UpdateEndpointStateSuccess",UPDATE_ENDPOINT_STATE_FAILURE:"UpdateEndpointStateFailure",BROKER_DECODE_PAYLOAD_FAILURE:"BrokerDecodePayloadFailure",BROKER_SUBSCRIPTION_TIMEOUT:"BrokerSubscriptionTimeout",BROKER_SUBSCRIPTION_SUCCESSFUL:"BrokerSubscriptionSuccessful",BROKER_SUBSCRIPTION_FAILED:"BrokerSubscriptionFailed",FAILED_TO_HANDLE_TROUTER_MESSAGE:"FailedToHandleTrouterMessage",FAILED_TO_HANDLE_BROKER_MESSAGE:"FailedToHandleBrokerMessage",BROKER_DISABLED_SUBSCRIBE_URL_PRESENT:"BrokerDisabledSubscribeUrlPresent",CONNECTED:"Connected",IN_LOBBY:"InLobby",STAGING:"Staging",MESSAGE_MISSING_BODY:"MessageMissingBody",BROADCAST_STATE_CHANGED:"BroadcastStateChanged",HANDLE_CALL_NOTIFICATION:"HandleCallNotification",HANDLE_INCOMING_CALL_REPLACEMENT:"HandleIncomingCallReplacement",HANDLE_PSTN_BALANCE_UPDATE:"HandlePstnBalanceUpdate",IGNORE_OLD_ROSTER:"IgnoreOldRoster",HANDLE_MEDIA_ACK:"HandleMediaAck",HANDLE_MEDIA_PROVISIONAL_ACK:"HandleMediaProvisionalAck",UPDATE_CALL_STATUS:"UpdateCallStatus",SEND_ATTACH:"SendAttach",REQUEST_NEW_OFFER:"RequestNewOffer",HANDLE_NEW_OFFER:"HandleNewOffer",UPDATE_CONVERSATION_LINKS:"UpdateConversationLinks",UPDATE_CONVERSATION_LINKS_SUCCESS:"UpdateConversationLinksSuccess",UPDATE_CONVERSATION_LINKS_FAILED:"UpdateConversationLinksFailed",PROCESS_INITIAL_OFFER:"ProcessInitialOffer",SEND_PROGRESS:"SendProgress",SEND_PROGRESS_FAILED:"SendProgressFailed",PROCESS_CALL_ACCEPTANCE:"ProcessCallAcceptance",ACCEPTANCE_USER_IN_LOBBY:"AcceptanceUserInLobby",REJECT_INCOMING_CALL:"RejectIncomingCall",SEND_KEEP_ALIVE:"SendKeepAlive",SEND_KEEP_ALIVE_FAILED:"SendKeepAliveFailed",SEND_CONVERSATION_KEEP_ALIVE_FAILED:"SendConversationKeepAliveFailed",START_AUDIO:"StartAudio",STOP_AUDIO:"StopAudio",UPDATE_MEETING_ROLE:"UpdateMeetingRole",UPDATE_MEETING_ROLE_TIMEOUT:"UpdateMeetingRoleTimeout",PREHEAT_ENABLING:"EnablingPreheat",PREHEAT_DISABLING:"DisablingPreheat",PREHEAT_DISABLED:"PreheatDisabled",TRANSFER_REQUEST_SENT:"TransferRequestSent",CALL_REDIRECT_REQUEST_SENT:"CallRedirectRequestSent",TRANSFER_REQUEST_FAILED:"TransferRequestFailed",SEND_ACCEPT_TRANSFER:"SendAcceptTransfer",SEND_ACCEPT_TRANSFER_FAIL:"SendAcceptTransferFail",WAITING_FOR_TRANSFER_COMPLETION:"WaitingForTransferCompletion",WAITING_FOR_TRANSFER_COMPLETION_FAIL:"WaitingForTransferCompletionFail",WAITING_FOR_TRANSFER_ACCEPTANCE_FAIL:"WaitingForTransferAcceptanceFail",WAITING_FOR_TRANSFER_ACCEPTANCE:"WaitingForTransferAcceptance",TRANSFER_COMPLETED:"TransferCompleted",SEND_COMPLETE_TRANSFER:"SendCompleteTransfer",SEND_COMPLETE_TRANSFER_FAILED:"SendCompleteTransferFailed",PICKUP_CODE_SET:"PickupCodeSet",ADD_PARTICIPANT_WITH_PICKUP_CODE:"AddParticipantWithPickupCode",ADD_PARTICIPANT_WITH_PICKUP_CODE_TIMEOUT:"AddParticipantWithPickupCodeTimeout",PUBLISH_STATE:"PublishState",PUBLISH_STATE_FAILURE:"PublishStateFailure",REMOVE_STATE:"RemoveState",REMOVE_STATE_FAILURE:"RemoveStateFailure",UPDATE_MEETING_SETTINGS:"UpdateMeetingSettings",UPDATE_MEETING_SETTINGS_FAILURE:"UpdateMeetingSettingsFailure",UPDATE_ENDPOINT_METADATA_SUCCESS:"UpdateEndpointMetadataSuccess",UPDATE_ENDPOINT_METADATA_FAILURE:"UpdateEndpointMetadataFailure",SEARCH_PARTICIPANTS:"SearchParticipants",GET_ALL_PARTICIPANTS:"GetAllParticipants",SEARCH_PARTICIPANTS_FAILURE:"SearchParticipantsFailure",GET_ALL_PARTICIPANTS_FAILURE:"GetAllParticipantsFailure",PARK_REQUEST:"SendParkRequest",PARK_REQUEST_FAILED:"ParkRequestFailed",WAITING_FOR_PARK_COMPLETION:"WaitingForParkCompletion",WAITING_FOR_PARK_COMPLETION_TIMEOUT:"WaitingForParkCompletionTimeout",PARK_COMPLETED:"ParkCompleted",PARK_FAILED:"ParkFailed",SEND_UNPARK_REQUEST:"SendUnparkRequest",UNPARK_REQUEST_FAILED:"UnparkRequestFailed",WAITING_FOR_UNPARK_COMPLETION:"WaitingForUnparkCompletion",WAITING_FOR_UNPARK_COMPLETION_TIMEOUT:"WaitingForUnparkCompletionTimeout",UNPARK_COMPLETED:"UnparkCompleted",UNPARK_FAILED:"UnparkFailed",UPDATE_MEETING_LIVE_STATE:"UpdateMeetingLiveState",WAITING_FOR_UPDATE_MEETING_LIVE_STATE_COMPLETION:"WaitingForUpdateMeetingLiveStateCompletion",UPDATE_MEETING_LIVE_STATE_REQUEST_FAILED:"UpdateMeetingLiveStateRequestFailed",UPDATE_MEETING_LIVE_STATE_RESPONSE_FAILURE:"UpdateMeetingLiveStateResponseFailure",UPDATE_MEETING_LIVE_STATE_RESPONSE_SUCCESS:"UpdateMeetingLiveStateResponseSuccess",UPDATE_MEETING_GROUPS:"UpdateMeetingGroups",UPDATE_PARTICIPANT_INTERPRETATION_STATE:"UpdateParticipantInterpretationState",UPDATE_PARTICIPANTS_PROPERTIES:"UpdateParticipantsProperties",JOIN_MEETING_GROUP:"JoinMeetingGroup",LEAVE_MEETING_GROUP:"LeaveMeetingGroup",INCOMING_PROXIED_MESSAGES:"incomingProxiedMessages",WAITING_FOR_UPDATE_MEETING_GROUPS_COMPLETION:"WaitingForUpdateMeetingGroupsCompletion",UPDATE_MEETING_GROUPS_REQUEST_FAILED:"UpdateMeetingGroupsRequestFailed",UPDATE_MEETING_GROUPS_REQUEST_COMPLETED:"UpdateMeetingGroupsRequestCompleted",UPDATE_MEETING_GROUPS_RESPONSE_FAILURE:"UpdateMeetingGroupsRequestFailure",UPDATE_MEETING_GROUPS_RESPONSE_SUCCESS:"UpdateMeetingGroupsResponseSuccess",SET_MEETING_LAYOUT:"SetMeetingLayout",WAITING_FOR_SET_MEETING_LAYOUT_COMPLETION:"WaitingForSetMeetingLayoutCompletion",SET_MEETING_LAYOUT_REQUEST_FAILED:"SetMeetingLayoutRequestFailed",SET_MEETING_LAYOUT_RESPONSE_FAILURE:"SetMeetingLayoutResponseFailure",SET_MEETING_LAYOUT_RESPONSE_SUCCESS:"SetMeetingLayoutResponseSuccess",WAITING_FOR_UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION:"WaitingForUpdateParticipantInterpretationStateCompletion",UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:"UpdateParticipantInterpretationStateTimeout",UPDATE_PARTICIPANT_INTERPRETATION_STATE_REQUEST_FAILED:"UpdateParticipantInterpretationStateRequestFailed",UPDATE_PARTICIPANT_INTERPRETATION_STATE_REQUEST_COMPLETED:"UpdateParticipantInterpretationStateRequestCompleted",UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_FAILED:"UpdateParticipantInterpretationStateResponseFailed",UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_COMPLETED:"UpdateParticipantInterpretationStateResponseCompleted",WAITING_FOR_UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION:"WaitingForUpdateParticipantsPropertiesCompletion",UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:"UpdateParticipantsPropertiesTimeout",UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED:"UpdateParticipantsPropertiesResponseFailed",UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_COMPLETED:"UpdateParticipantsPropertiesResponseCompleted",WAITING_FOR_JOIN_MEETING_GROUP_COMPLETION:"WaitingForJoinMeetingGroupCompletion",JOIN_MEETING_GROUP_REQUEST_FAILED:"JoinMeetingGroupRequestFailed",JOIN_MEETING_GROUP_REQUEST_COMPLETED:"JoinMeetingGroupRequestCompleted",JOIN_MEETING_GROUP_RESPONSE_FAILED:"JoinMeetingGroupRequestFailed",JOIN_MEETING_GROUP_RESPONSE_COMPLETED:"JoinMeetingGroupRequestCompleted",WAITING_FOR_LEAVE_MEETING_GROUP_COMPLETION:"WaitingForLeaveMeetingGroupCompletion",LEAVE_MEETING_GROUP_REQUEST_FAILED:"LeaveMeetingGroupRequestFailed",LEAVE_MEETING_GROUP_REQUEST_COMPLETED:"LeaveMeetingGroupRequestCompleted",LEAVE_MEETING_GROUP_RESPONSE_FAILED:"LeaveMeetingGroupRequestFailed",LEAVE_MEETING_GROUP_RESPONSE_COMPLETED:"LeaveMeetingGroupRequestCompleted",SUBSCRIBE_URL_FOUND:"SubscribeUrlFound",SUBSCRIBE_URL_MISSING:"SubscribeUrlMissing",SEND_MESSAGE_COMPLETION:"SendMessageCompletion",SEND_MESSAGE_TIMEOUT:"SendMessageTimeout",DISABLE_PREHEAT_SUCCEEDED:"DiablePreheatSucceeded",ASYNC_DISABLE_PREHEAT_SUCCEEDED:"AsyncDisablePreheatSucceeded",DISABLE_PREHEAT_FAILED:"DiablePreheatFailed",ASYNC_DISABLE_PREHEAT_FAILED:"AsyncDiablePreheatFailed",ASYNC_DISABLE_PREHEAT_TIMEOUT:"AsyncDiablePreheatTimeout",DISABLE_PREHEAT_RESPONSE_RECEIVED:"DisablePreheatResponseReceived",SET_STREAM_INFORMATION_RECEIVED:"StreamInformationReceived",UPDATE_MEDIA_DESCRIPTIONS:"UpdateMediaDescriptions",UPDATE_MEDIA_DESCRIPTIONS_FAILED:"UpdateMediaDescriptionsFailed",NUDGE_TO_JOIN_REALTIME:"NudgeToJoinAsRealtime",UPDATE_MEETING_STATES:"UpdateMeetingStates",WAITING_FOR_UPDATE_MEETING_STATES_COMPLETION:"WaitingForUpdateMeetingStatesCompletion",UPDATE_MEETING_STATES_RESPONSE_SUCCESS:"UpdateMeetingStatesResponseSuccess",UPDATE_MEETING_STATES_RESPONSE_FAILURE:"UpdateMeetingStatesResponseFailure"},Fi={SEND_MEDIA_ANSWER:{name:"SendMediaAnswer",controller:0},START_RENEGOTIATION:{name:"StartRenegotiation",controller:0},SEND_MEDIA_ACKNOWLEDGEMENT:{name:"SendMediaAcknowledgement",controller:0},SEND_MEDIA_REJECTION:{name:"SendMediaRejection",controller:0},ADD_PARTICIPANT:{name:"AddParticipant",controller:1},ADD_PARTICIPANT_WITH_REPLACES:{name:"AddParticipantWithReplaces",controller:1},NUDGE_PARTICIPANT:{name:"NudgeParticipant",controller:1},REMOVE_PARTICIPANT_NONE:{name:"RemoveParticipant",controller:1},REMOVE_PARTICIPANT_OTHERS:{name:"RemoveParticipantOthers",controller:1},REMOVE_PARTICIPANT_SPECIFIED:{name:"RemoveParticipantSpecified",controller:1},ADMIT_PARTICIPANT:{name:"AdmitParticipant",controller:1},ADMIT:{name:"Admit",controller:1},BROKER_SUBSCRIBE:{name:"BrokerSubscribe",controller:2},CALL_ME_BACK:{name:"CallMeBack",controller:1},SEND_ACCEPTANCE:{name:"SendAcceptance",controller:0},SEND_ACCEPTANCE_ACKNOWLEDGEMENT:{name:"SendAcceptanceAcknowledgement",controller:0},END_CALL:{name:"EndCall",controller:1},CANCEL_CALL:{name:"CancelCall",controller:1},REJECT_CALL:{name:"RejectCall",controller:0},JOIN_CONVERSATION:{name:"JoinConversation",controller:1},JOIN_CONVERSATION_WITHOUT_CALL_MODALITY:{name:"JoinConversationWithoutCallModality",controller:1},LEAVE_CONVERSATION:{name:"LeaveConversation",controller:1},DELETE_CONVERSATION:{name:"DeleteConversation",controller:1},START_CALL:{name:"StartCall",controller:1},PLACE_NUDGE_CALL:{name:"PlaceNudgeCall",controller:5},UPDATE_CONVERSATION_LINKS:{name:"UpdateConversationLinks",controller:1},SEND_CONVERSATION_KEEP_ALIVE:{name:"SendConversationKeepAlive",controller:1},SEND_CALL_ATTACH:{name:"SendCallAttach",controller:0},SEND_CALL_PROGRESS:{name:"SendCallProgress",controller:0},SEND_KEEP_ALIVE:{name:"SendKeepAlive",controller:0},ADD_CONTENT_SHARING_MODALITY:{name:"AddContentSharingModality",controller:1},DELETE_CONTENT_SHARING:{name:"DeleteContentSharing",controller:3},TAKE_CONTROL_CONTENT_SHARING:{name:"TakeControlContentSharing",controller:3},UPDATE_SESSION_STATE_CONTENT_SHARING:{name:"UpdateSessionStateContentSharing",controller:3},JOIN_CONTENT_SHARING:{name:"JoinContentSharing",controller:3},UPDATE_PARTICIPANT_STATE_CONTENT_SHARING:{name:"UpdateParticipantStateContentSharing",controller:3},UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS:{name:"UpdateContentSharingNotificationLinks",controller:3},MUTE_ALL:{name:"MuteAll",controller:1},MUTE_ALL_SYNC:{name:"MuteAllSync",controller:1},MUTE_SPECIFIED:{name:"MuteSpecified",controller:1},MUTE_SPECIFIED_SYNC:{name:"MuteSpecifiedSync",controller:1},MUTE_MYSELF:{name:"MuteMyself",controller:1},UNMUTE:{name:"Unmute",controller:1},UNMUTE_SYNC:{name:"UnmuteMyselfSync",controller:1},SEND_CONTROL_VIDEO_STREAMING:{name:"SendControlVideoStreaming",controller:0},SEND_APPLY_CHANNEL_PARAMETERS:{name:"SendApplyChannelParameters",controller:0},APPROVE_UNMUTE:{name:"ApproveUnmute",controller:5},REJECT_UNMUTE:{name:"RejectUnmute",controller:5},SEND_CALL_REDIRECT_REQUEST:{name:"SendCallRedirectRequest",controller:0},SEND_TRANSFER_REQUEST:{name:"SendTransferRequest",controller:0},SEND_PARK_REQUEST:{name:"SendParkRequest",controller:0},SEND_SHARED_LINE_PARK_REQUEST:{name:"SharedLinePark",controller:0},SEND_SERVER_HOLD_REQUEST:{name:"ServerHoldRequest",controller:0},PARK_REQUEST:{name:"ParkRequest",controller:0},SEND_UNPARK_REQUEST:{name:"UnparkRequest",controller:0},TRANSFER_ACCEPTANCE:{name:"TransferAcceptance",controller:0},TRANSFER_COMPLETION:{name:"TransferCompletion",controller:0},TRANSFER_COMPLETION_FAILED:{name:"TransferCompletionFailed",controller:0},UPDATE_ENDPOINT_STATE:{name:"UpdateEndpointState",controller:1},DISABLE_PREHEAT:{name:"DisablePreheat",controller:5},REQUEST_NEW_OFFER:{name:"RequestNewOffer",controller:0},UPDATE_ENDPOINT_METADATA:{name:"UpdateEndpointMetadata",controller:1},UPDATE_MEETING_ROLE_ATTENDEE:{name:"UpdateMeetingRoleToAttendee",controller:1},UPDATE_MEETING_ROLE_PRESENTER:{name:"UpdateMeetingRoleToPresenter",controller:1},UPDATE_MEETING_ROLE_ORGANIZER:{name:"UpdateMeetingRoleToOrganizer",controller:1},ADD_PARTICIPANT_WITH_PICKUP_CODE:{name:"AddParticipantWithPickupCode",controller:1},PUBLISH_STATE:{name:"PublishState",controller:1},REMOVE_STATE:{name:"RemoveState",controller:1},UPDATE_MEETING_SETTINGS:{name:"UpdateMeetingSettings",controller:1},ADD_PARTICIPANTS_AND_MODALITY:{name:"AddParticipantsAndModality",controller:1},ADD_BROADCAST_MODALITY:{name:"AddBroadcastModality",controller:1},SEARCH_PARTICIPANTS:{name:"SearchParticipants",controller:1},GET_ALL_PARTICIPANTS:{name:"GetAllParticipants",controller:1},UPDATE_MEETING_LIVE_STATE:{name:"UpdateMeetingLiveState",controller:1},UPDATE_MEETING_GROUPS:{name:"UpdateMeetingGroups",controller:1},SET_MEETING_LAYOUT:{name:"SetMeetingLayout",controller:1},UPDATE_PARTICIPANT_INTERPRETATION_STATE:{name:"UpdateParticipantInterpretationState",controller:1},JOIN_MEETING_GROUP:{name:"JoinMeetingGroup",controller:1},LEAVE_MEETING_GROUP:{name:"LeaveMeetingGroup",controller:1},SEND_PROXIED_MESSAGE:{name:"SendProxiedMessage",controller:1},UPDATE_PARTICIPANTS_PROPERTIES:{name:"UpdateParticipantsProperties",controller:1},UPDATE_MEDIA_DESCRIPTIONS:{name:"UpdateMediaDescriptions",controller:0},UPDATE_MEETING_STATES:{name:"UpdateMeetingStates",controller:1}},xi={EVENT_SOURCE:{TROUTER:"Trouter",BROKER:"Broker",UDP:"UDP",LOCAL:"Local"},SOURCE:{NGC_SOURCE:"SkypeConcore"},EVENT_TYPE:{CONVERSATION_CALL_MODALITY:"skypecosi_concore_web_csa_conversation_callmodality",CONVERSATION_CONTENT_SHARING:"skypecosi_concore_web_csa_conversation_contentsharing",CONVERSATION_HTTP_REQUEST:"skypecosi_concore_web_csa_conversation_httprequest",CONVERSATION_TOKEN:"skypecosi_concore_web_csa_conversation_token"},EXTENSIONS:{DATA_VERSION:"DataVersion",DIRECTION:"Direction",CONTENT_SHARING_DIRECTION:"ContentSharingDirection",CONNECTED_DURATION_IN_MS:"ConnectedDurationInMsecs",PREHEATED_CALL_SETUP_DURATION_IN_S:"PreheatedCallSetupDurationInSeconds",CALL_CANCELATION_DURATION_IN_S:"CallCancelationDurationInSeconds",IS_PREHEATED:"IsPreheated",TIME_TO_RING_IN_MS:"TimeToRingInMsecs",CALL_TERMINATING_END:"CallTerminatingEnd",NETWORK_REQUESTS_PENDING:"NetworkRequestsPending",NETWORK_REQUESTS_COMPLETED:"NetworkRequestsCompleted",LOCAL_OPERATIONS_PERFORMED:"LocalOperationsPerformed",TROUTER_WAIT_OPERATIONS:"TrouterWaitOperations",CALL_START_TIME:"CallStartTime",CALL_END_TIME:"CallEndTime",IS_GROUP_CALL:"IsGroupCall",IS_HOSTLESS_CALL:"IsHostLessCall",IS_CAST_CALL:"IsCastCall",IS_HUDDLE_GROUP_CALL:"IsHuddleGroupCall",IS_MEETUP_CALL:"IsMeetupCall",IS_ON_BEHALF_OF_CALL:"IsOnBehalfOfCall",IS_SDP_IN_CALL_NOTIFICATION:"SdpInCallNotification",CALL_END_CODE:"Code",CALL_END_SUB_CODE:"SubCode",CALL_PHRASE:"Phrase",CALL_END_RESULT_CATEGORIES:"ResultCategories",CALL_END_CAUSE_ID:"CauseId",CONTENT_SHARING_END_CODE:"ContentSharingEndReasonServiceCode",CONTENT_SHARING_END_SUB_CODE:"ContentSharingEndReasonServiceSubCode",CONVERSATION_SERVICE_URL:"ConversationServiceUrl",CONTENT_SHARING_SERVICE_URL:"ContentSharingServiceUrl",MEETING_INFO:"MeetingInfo",JOINED_FROM:"JoinedFrom",RESULT_VALUE:"ResultValue",RESULT_DETAIL:"ResultDetail",RESULT_CAUSE_ID:"ResultCauseId",RESULT_CODE:"ResultCode",LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS:"LocalOfferAnswerGenerationTimestamps",SELF_PARTICIPANT_ROLE:"SelfParticipantRole",SCENARIO:"Scenario",CALLER_TYPE:"Caller_Type",CALLEE_TYPE:"Callee_Type",CALL_TYPE:"Call_Type",TEST_CONTEXT_ID:"Test_Context_Id",OUTGOING_MODALITIES:"Outgoing_Modalities",INCOMING_MODALITIES:"Incoming_Modalities",OFFERED_MODALITIES:"CallOfferredModalities",ANSWERED_MODALITIES:"CallAnsweredModalities",VBSS_OPERATIONS:"VBSS_Operations",CHANGING_CORRELATION_ID_NEW_ID:"ChangingCorrelationId_NewId",CHANGING_CORRELATION_ID_OLD_ID:"ChangingCorrelationId_OldId",MESSAGING_CHANNEL:"MessagingChannel",EVENT_TIMESTAMP_BAG:"EventTimestampBag",ROSTER_UPDATES_BAG:"RosterUpdatesBag",NETWORK_REQUESTS_BAG:"NetworkRequestBag",CLIENT_INFORMATION:"ClientInformation",ECS_ETAG:"EcsEtag",APPLICATION_TYPE:"ApplicationType",RING:"Ring",TENANT_ID:"TenantId",USER_HEX_CID:"UserHexCID",ACS_RESOURCE_ID:"AcsResourceId",REGION:"Region",PARTITION:"Partition",CALL_END_CLIENT_SUB_CODE:"CallEventCallEndClientSubCode",CALL_END_CLIENT_PHRASE:"CallEventCallEndClientPhrase",MEETING_CODE:"MeetingCode",MEETING_URL:"MeetingJoinUrl",BROADCAST_MEETING_ROLE:"BroadcastMeetingRole",MEETING_ROLE:"MeetingRole",ADVANCED_MEETING_ROLE:"AdvancedMeetingRole",PARTICIPANT_TYPE:"ParticipantType",AUDIO_ONLY_WATERMARK:"ClientSupportsAudioOnlyWatermark",CLIENT_SUPPORT_WATERMARK:"ClientSupportsWatermark",TARGET_APPLICATION_TYPE:"TargetApplicationType",IS_REINVITELESS:"IsReinviteless",CLIENT_TYPE:"ClientType"},MESSAGING_CHANNEL:{TROUTER:"Trouter",BROKER:"Broker"},SIGNALING_CONFIG:"JsCsaConfig",SIGNALING_CONFIG_FLAGS:{BROKER_OUTGOING_ENABLED:"BrokerOutgoingEnabled",BROKER_INCOMING_ENABLED:"BrokerIncomingEnabled",BROKER_REQUEST_BATCHING_ENABLED:"BrokerRequestBatchingEnabled",BROKER_EXCLUSIVELY_ENABLED:"BrokerExclusivelyEnabled",SUPPORTS_COMPRESSED_PAYLOAD:"SupportsCompressedPayload",SYNC_TROUTER_RESPONSE:"SyncTrouterResponse",SERVER_MUTE_UNMUTE:"serverMuteUnmute",HANDLE_OFFER_FROM_NOTIFICATION:"handleMediaOfferFromPushNotification",HANDLE_NEW_OFFER_REQUEST:"handleNewOfferRequest",SEND_PROGRESS_FROM_CC:"sendProgressFromCC",HANDLE_UNMUTE_MUTE_FROM_RESPONSE:"handleUnmuteMuteFromResponse",INTERNAL_HTTP_DISPATCHER:"internalHttpDispatcher",ENABLE_TOKEN_CACHE:"enableTokenCache",ENABLE_TOKEN_PREFETCH:"enableTokenPrefetch",REQUEST_HEDGING:"requestHedging",SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION:"supportMediaRetargetWhileIncomingRenegotiation",ENABLE_ERROR_CODE_IMPROVEMENTS_FOR_NETWORK_FAILURES:"enableErrorCodeImprovementsForNetworkFailures",ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL:"enableCallEstablishmentTimeoutsForStartJoinCall",ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API:"enableTokenCacheForGenericTokenAPI",ENABLE_LONG_OUTGOING_1TO1_SETUP:"enableLongOutgoing1To1SetupTimeoutForWeb"},CONTEXT_ID:{CORRELATION_ID:"CorrelationId",SHARED_CORRELATION_ID:"SharedCorrelationId",SIGNALING_SESSION_ID:"SignalingSessionId",GROUP_ID:"GroupId",THREAD_ID:"ThreadId",TEAMS_MESSAGEID:"TeamsMessageId",TEAMS_MEETINGINFO:"TeamsMeetingInfo",ENDPOINT_ID:"EndpointId",PARTICIPANT_ID:"ParticipantId",DATA_VERSION:"DataVersion",CONTENT_SHARING_ID:"ContentSharingSessionId",CONTENT_SHARING_CORRELATION_ID:"ContentSharingCorrelationId"},CALL_TERMINATING_END:{LOCAL:"Local",REMOTE:"Remote"},RESULT_VALUE:{SUCCESS:"Success",FAILURE:"Failure"},DIRECTION:{INCOMING:"Incoming",OUTGOING:"Outgoing"},ROLE:{CALLER:"caller",CALLEE:"callee",JOIN:"join",JOIN_FOR_ROSTER_ONLY:"joinForRosterOnly",PREHEAT:"preheat"},VBSS_OPERATION:{START:"Start",STOP:"Stop",REJECTED:"Rejected",REMOTE_START:"RemoteStart",TIMEOUT:"Timeout",CALL_END:"CallEnd"},LOCAL_OFFER_ANSWER_OPERATIONS:{INITIAL_OFFER_GENERATION_STARTED:"InitialOfferGenerationStarted",INITIAL_OFFER_GENERATION_ENDED:"InitialOfferGenerationEnded",FINAL_ANSWER_PROCESSING_STARTED:"FinalAnswerProcessingStarted",FINAL_ANSWER_PROCESSING_ENDED:"FinalAnswerProcessingEnded",PROVISIONAL_ANSWER_PROCESSING_STARTED:"ProvisonalAnswerProcessingStarted",PROVISIONAL_ANSWER_PROCESSING_ENDED:"ProvisonalAnswerProcessingEnded",NEGOTIATION_COMPLETED:"NegotiationCompleted",INITIAL_OFFER_PROCESSING_STARTED:"InitialOfferProcessingStarted",INITIAL_OFFER_PROCESSING_ENDED:"InitialOfferProcessingEnded",FINAL_ANSWER_GENERATION_STARTED:"FinalAnswerGenerationStarted",FINAL_ANSWER_GENERATION_ENDED:"FinalAnswerGenerationEnded",PROVISIONAL_ANSWER_GENERATION_STARTED:"ProvisionalAnswerGenerationStarted",PROVISIONAL_ANSWER_GENERATION_ENDED:"ProvisionalAnswerGenerationEnded",RENEGOTIATION_OFFER_GENERATION_STARTED:"RenegotiationOfferGenerationStarted",RENEGOTIATION_OFFER_GENERATION_ENDED:"RenegotiationOfferGenerationEnded",RENEGOTIATION_ANSWER_PROCESSING_STARTED:"RenegotiationAnswerProcessingStarted",RENEGOTIATION_ANSWER_PROCESSING_ENDED:"RenegotiationAnswerProcessingEnded",RENEGOTIATION_OFFER_PROCESSING_STARTED:"RenegotiationOfferProcessingStarted",RENEGOTIATION_OFFER_PROCESSING_ENDED:"RenegotiationOfferProcessingEnded",RENEGOTIATION_ANSWER_GENERATION_STARTED:"RenegotiationAnswerGenerationStarted",RENEGOTIATION_ANSWER_GENERATION_ENDED:"RenegotiationAnswerGenerationEnded"},TROUTER_WAIT_OPERATION:{STARTED:"Started",ENDED:"Ended",FAILED:"Failed"},TOKEN_TELEMETRY_EVENT:{TOKEN_TELEMETRY:"TokenTelemetry"}};function setDefaultsForSignalingConfig(g){const m=!0,S="enabled",v=!1,C=!1,_=!0,E=!0,T=!0,I=!1,b=!1,A=!0,R=!0,P=!0,M=!0,w=!0,D=!1,O=!1,N=!1,k=!1,L=!1,F=!0,x=!1,U=!0,V=!0,B=3,H=4e3,$=!1,G=!1,j=!1,q=!1,W=!1,z={conversationKeepAliveTimeoutSec:2700,promotionUnmuteTimeoutSec:1e4},K=!1,J=!1,Y=!1,Q=!1,X=3600,Z=86400,ee=30,te=!1,ie=!0,ne=!0,re=60,se="https://calling.teams.microsoft.com",ae=!0,oe=!1,le=!1,ce=!1,de=!1,he=!1,ue=!1,ge=0,pe=0,me=!1,fe=!1,Se=!1,ve=!1,Ce=!0;g.cloudScreenSharingFlag="disabled"===g.cloudScreenSharingFlag?g.cloudScreenSharingFlag:S,g.isWebRtcEnabled="undefined"==typeof RTCIceGatherer,g.shouldServiceSendNGCUpgradeMessages=setDefault(g.shouldServiceSendNGCUpgradeMessages,_),g.isGVCOutgoingEnabled=setDefault(g.isGVCOutgoingEnabled,m),g.supportsCompressedServicePayload=setDefault(g.supportsCompressedServicePayload,E),g.supportsSynchronousTrouterResponse=setDefault(g.supportsSynchronousTrouterResponse,T),g.supportsHostlessGroupCalls=setDefault(g.supportsHostlessGroupCalls,A),g.doHostlessCalling=setDefault(g.doHostlessCalling,v),g.brokerExclusively=setDefault(g.brokerExclusively,D),g.brokerEnabledOutgoing=setDefault(g.brokerEnabledOutgoing,P),g.brokerEnabledIncoming=setDefault(g.brokerEnabledIncoming,M),g.brokerRequestBatching=setDefault(g.brokerRequestBatching,w),g.handleMediaOfferFromPushNotification=setDefault(g.handleMediaOfferFromPushNotification,F),g.handleNewOfferRequest=setDefault(g.handleNewOfferRequest,O),g.autoJoinOnConflict=setDefault(g.autoJoinOnConflict,R),g.endConflictedCall=setDefault(g.endConflictedCall,I),g.autoResolveConflictedCall=setDefault(g.autoResolveConflictedCall,b),g.shouldServiceSendCallEventMessages=setDefault(g.shouldServiceSendCallEventMessages,C),g.handleUnmuteMuteFromResponse=setDefault(g.handleUnmuteMuteFromResponse,x),g.forceTrouterReconnectOnNetworkOnline=setDefault(g.forceTrouterReconnectOnNetworkOnline,U),g.attemptHttpRequestWithCachedSkypetoken=setDefault(g.attemptHttpRequestWithCachedSkypetoken,V),g.useInternalHttpDispatcher=setDefault(g.useInternalHttpDispatcher,N),g.enableTokenCache=setDefault(g.enableTokenCache,k),g.enableTokenPrefetch=setDefault(g.enableTokenPrefetch,L),g.hedgeDelayMs=setDefault(g.hedgeDelayMs,H),g.hedgeMaxParallelAttempts=setDefault(g.hedgeMaxParallelAttempts,B),g.useInternalHttpDispatcher&&(g.httpRequestDispatcher=new Ue(g.logger)),g.enableQuickSendAcceptanceAck=setDefault(g.enableQuickSendAcceptanceAck,$),g.supportMediaRetargetWhileIncomingRenegotiation=setDefault(g.supportMediaRetargetWhileIncomingRenegotiation,G),g.callingServiceSupportsAADTokens=setDefault(g.callingServiceSupportsAADTokens,K),g.callingServiceSupportsCAETokens=setDefault(g.callingServiceSupportsCAETokens,J),g.aadTokenExpirationTimeInSeconds=setDefault(g.aadTokenExpirationTimeInSeconds,X),g.caeTokenExpirationTimeInSeconds=setDefault(g.caeTokenExpirationTimeInSeconds,Z),g.disableTokenMigrationHeader=setDefault(g.disableTokenMigrationHeader,Y),g.enablePublishTokenTelemetry=setDefault(g.enablePublishTokenTelemetry,Q),g.forceClearExpiredTokens=setDefault(g.forceClearExpiredTokens,te),g.enableRefreshToken=setDefault(g.enableRefreshToken,ie),g.refreshTimeBeforeTokenTimeoutInSeconds=setDefault(g.refreshTimeBeforeTokenTimeoutInSeconds,ee),g.enableCallEstablishmentTimeoutsForStartJoinCall=setDefault(g.enableCallEstablishmentTimeoutsForStartJoinCall,j),g.csaTimeoutConfiguration=mergeObjects(g.csaTimeoutConfiguration,z),g.reportPreviousErrorsForTimeout=setDefault(g.reportPreviousErrorsForTimeout,ce),g.callingTokenLogicalUrl=setDefault(g.callingTokenLogicalUrl,se),g.enableAsyncDisablePreheat=setDefault(g.enableAsyncDisablePreheat,de),g.forceLowercaseHttpHeaders=setDefault(g.forceLowercaseHttpHeaders,he),g.enableResolveScreenSharingWhenNegotiationComplete=setDefault(g.enableResolveScreenSharingWhenNegotiationComplete,ue),g.maxReinvitelessMediaForVideoForWeb=setDefault(g.maxReinvitelessMediaForVideoForWeb,ge),g.maxReinvitelessMediaForVBSSForWeb=setDefault(g.maxReinvitelessMediaForVBSSForWeb,pe),g.enableRefreshTokenRetry=setDefault(g.enableRefreshTokenRetry,ne),g.enableRefreshTokenRetryInSeconds=setDefault(g.enableRefreshTokenRetryInSeconds,re),g.enableConversationTypeUpdateOnCallEnd=setDefault(g.enableConversationTypeUpdateOnCallEnd,W),g.supportMissingTokenTypesInResponse=setDefault(g.supportMissingTokenTypesInResponse,ae),g.useSkypeTokenWhenNoAuthenticateHeader=setDefault(g.useSkypeTokenWhenNoAuthenticateHeader,oe),g.enableAutoPromotion=setDefault(g.enableAutoPromotion,me),g.enableBatchedSendMessageStatus=setDefault(g.enableBatchedSendMessageStatus,Se),g.enableBatchedReceiveMessage=setDefault(g.enableBatchedReceiveMessage,fe),g.enableAddParticipantEnhancements=setDefault(g.enableAddParticipantEnhancements,ve),g.enableTokenCacheForGenericTokenAPI=setDefault(g.enableTokenCacheForGenericTokenAPI,le),g.disableRealTimeModeFromRoster=setDefault(g.disableRealTimeModeFromRoster,Ce),g.enableLongOutgoing1To1SetupTimeoutForWeb=setDefault(g.enableLongOutgoing1To1SetupTimeoutForWeb,q)}function setDefault(g,m){return null==g?m:g}function mergeObjects(g,m){return(m||g)&&{...m,...g}}var Ui=class{constructor(){this.skypeTokenContext={},this.aadTokenContext={},this.caeTokenContext={}}getTokenContext(g){return 4===g?this.aadTokenContext:8===g?this.caeTokenContext:1===g?this.skypeTokenContext:void 0}getTokenExpiry(g,m){return 4===g?this.aadTokenContext?.expiryTime:8===g?this.caeTokenContext?.expiryTime:1===g?this.skypeTokenContext?.expiryTime:(m.info("[getTokenExpiry] unrecognized token type, return Number.MAX_VALUE"),Number.MAX_VALUE)}getToken(g,m,S,v){return 8&g&&this.caeTokenContext?.token&&this.caeTokenContext.token!==v?{token:this.caeTokenContext.token,tokenType:8}:4&g&&this.aadTokenContext?.token&&this.aadTokenContext.token!==v?{token:this.aadTokenContext.token,tokenType:4}:1&g&&this.skypeTokenContext?.token&&this.skypeTokenContext.token!==v?{token:this.skypeTokenContext.token,tokenType:1}:(S.info("[getToken] no cached token found of token type: ${tokenType}"),null)}setToken(g,m,S,v){switch(g){case 4:this.aadTokenContext.factorsJson=S,this.aadTokenContext.tokenType=g,this.aadTokenContext.token=m,this.aadTokenContext.expiryTime=v;break;case 1:this.skypeTokenContext.factorsJson=S,this.skypeTokenContext.tokenType=g,this.skypeTokenContext.token=m,this.skypeTokenContext.expiryTime=v;break;case 8:this.caeTokenContext.factorsJson=S,this.caeTokenContext.tokenType=g,this.caeTokenContext.token=m,this.caeTokenContext.expiryTime=v;break;default:throw new Error(`Invalid tokenType ${g}`)}}clearExpiredTokens(g){const m=Math.round(Date.now()/1e3);this.caeTokenContext?.expiryTime<=m&&(this.resetToken(8),g?.info("[cacheTokenManager] reset expired cae token")),this.aadTokenContext?.expiryTime<=m&&(this.resetToken(4),g?.info("[cacheTokenManager] reset expired aad token")),this.skypeTokenContext?.expiryTime<=m&&(this.resetToken(1),g?.info("[cacheTokenManager] reset expired skype token"))}resetToken(g){8===g?this.caeTokenContext={}:4===g?this.aadTokenContext={}:1===g&&(this.skypeTokenContext={})}},Vi=class{constructor(g){this.timers={},this.startTimer=(g,m,S,v)=>{this.logger.info(`startTimer called for :  ${g}`);const C=window.setTimeout(m,1e3*S),_=v?`${g}${v}`:g;this.timers[_]=C},this.stopTimer=(g,m)=>{this.logger.info(`stopTimer called for : ${g}`);const S=m?`${g}${m}`:g;this.timers.hasOwnProperty(S)&&(clearTimeout(this.timers[S]),delete this.timers[S])},this.dispose=()=>{this.logger.info("timeoutManager :: dispose"),Object.keys(this.timers).forEach((g=>{this.stopTimer(g)}))},this.logger=g}},Bi=3600,Hi=class{constructor(g,m,S,v){this.tokenProvider=m,this.tokenCachingEnabled=!1,this.enableTokenCacheForGenericTokenAPI=!1,this.cachedToken="",this.lastTokenType=1,this.lastToken="",this.clientSupportsGenericTokenAPI=!1,this.stopTimerFlag=!1,this.tokensPromiseMap={},this.logger=g.createChild("TokenManager"),S&&this.updateTokenSettings(S),this.cacheTimers=new Vi(g),this.cacheTokenManager=new Ui,this.telemetryManager=v,this.nextRefreshTimePointInSeconds=Number.MAX_VALUE}deletePromisesByTriggeredByRefresh(g,m){if(this.tokensPromiseMap[g]){const S=this.tokensPromiseMap[g];for(let v=S.length-1;v>=0;v--)S[v]?.tokenRequestOptions.triggeredByRefresh===m&&this.tokensPromiseMap[g].splice(v,1)}}startTokenRefreshTimer(g){const m="startTokenRefreshTimer";if(!this.enableRefreshToken)return void this.logger.info("[startTokenRefreshTimer] token refresh is disabled");if(this.stopTimerFlag)return this.logger.info("[startTokenRefreshTimer] stopTimerFlag=true so cancel timer"),void this.cacheTimers.dispose();this.logger.info(`[startTokenRefreshTimer] starting token refresh timer timeToStartInMilliseconds=${g}`);const S=epochTimeInSecRoundedDown(),v=millieSecondsToSeconds(g),C=S+v;this.nextRefreshTimePointInSeconds===Number.MAX_VALUE||this.nextRefreshTimePointInSeconds<S||C<this.nextRefreshTimePointInSeconds?(this.logger.info("[startTokenRefreshTimer] cancelling current refresh timer to create new one with shorter time"),this.cacheTimers.stopTimer(m),this.nextRefreshTimePointInSeconds=C,this.logger.info(`[startTokenRefreshTimer] start new timer with timeout=${v} at time=${S}`),this.cacheTimers.startTimer(m,(()=>{this.nextRefreshTimePointInSeconds=Number.MAX_VALUE,this.refreshToken()}),v)):this.logger.info("[startTokenRefreshTimer] no need to set a new refresh timer")}async refreshTokenWithContext(g){const m={triggeredByRefresh:!0},S=newGuid(),v={causeId:S},C=Date.now();let _,E,T,I=2;this.logger.info(`[${S}][refreshTokenWithContext] refreshing token tokenType=${g.tokenType} factorsJson=${g.factorsJson}`);try{const m=this.onTokenRequired({factorsJson:g.factorsJson,tokenType:g.tokenType,requestMetadataJson:v,invalidToken:void 0,isUnauthorized:void 0,triggeredByRefresh:!0}),C=await this.timeoutPromiseRace(m,this.enableRefreshTokenRetryInSeconds,"ActiveRefresh Token Timeout");_=Date.now(),T=C?.causeId,this.lastTokenType=C?.tokenType,I=1,_=Date.now(),this.logger.info(`[${S}][refreshTokenWithContext] refresh token success for factorsJson ${g.factorsJson} and tokenType ${g.tokenType}`)}catch(m){E=m,T=E?.causeId,m?.timeOut?(this.logger.info(`[${S}][refreshTokenWithContext] refresh token timeout, UI did not respond with token in time ${getPrintableObject(m)}`),I=5):(this.logger.info(`[${S}][refreshTokenWithContext] failed to refresh token, UI did not respond with token ${getPrintableObject(m)}`),I=2),_=Date.now(),this.deletePromisesByTriggeredByRefresh(g.factorsJson,!0)}finally{m&&(m.requestCauseId=S,m.responseCauseId=T,m.supportTokenApi=this.clientSupportsGenericTokenAPI,m.requestTokenFactors=g.factorsJson,m.tokenRequestTime=C,m.tokenResponseTime=_,m.tokenRequestStatus=I,m.requestTokenType=g.tokenType,m.foundInCache=!1,m.responseTokenType=g.tokenType,m.errorCode=E?.errorCode,m.errorSubCode=E?.errorSubCode,this.sendTokenTelemetry(m))}}refreshToken(){const g=this.cacheTokenManager.getTokenContext(4),m=this.cacheTokenManager.getTokenContext(8),S=this.cacheTokenManager.getTokenContext(1);if(!this.clientSupportsGenericTokenAPI)return void this.logger.info("[refreshToken] new Token Api is not spported");if(!g&&!m&&!S)return void this.logger.info("[refreshToken] no cached tokens available to refresh");const v=epochTimeInSecRoundedDown()+this.refreshTimeBeforeTokenTimeoutInSeconds;let C=Number.MAX_VALUE,_=!1;if(g)if(g.expiryTime>v){const m=g?.expiryTime-v;m<C&&(C=m)}else g.expiryTime<=v&&(this.refreshTokenWithContext(g),_=!0);if(m)if(m.expiryTime>v){const g=m?.expiryTime-v;g<C&&(C=g)}else m.expiryTime<=v&&(this.refreshTokenWithContext(m),_=!0);if(S)if(S.expiryTime>v){const g=S?.expiryTime-v;g<C&&(C=g)}else S.expiryTime<=v&&(this.refreshTokenWithContext(S),_=!0);_&&this.enableRefreshTokenRetry&&this.enableRefreshTokenRetryInSeconds>0&&this.enableRefreshTokenRetryInSeconds<C&&(C=this.enableRefreshTokenRetryInSeconds),C>=0&&C!==Number.MAX_VALUE&&this.startTokenRefreshTimer(secondsToMillieSeconds(C))}async getTokenWithTokenType(g,m=!1,S,v){this.logger.info(`[${g}][getTokenWithTokenType] call with factorJson=${S?.factorsJson} and request tokenType ${S?.tokenType}`);const{factorsJson:C,requestMetadataJson:_,invalidToken:E,isUnauthorized:T}=S||{},I=Date.now(),b=S?.tokenType;let A,R,P,M=2;this.clearExpiredTokens(),this.startTokenRefreshTimer(1);try{if(m)this.invalidateCachedTokenWithTokenType(b,E,C);else if(this.enableTokenCacheForGenericTokenAPI){const m=this.cacheTokenManager.getToken(b,C,this.logger,E);if(m?.token)return this.logger.info(`[${g}][getTokenWithTokenType] returning cached token for factorsJson ${C} and request tokenType ${b}, response tokenType ${m.tokenType}`),M=3,A=Date.now(),this.lastTokenType=m.tokenType,m}this.logger.info(`[${g}][getTokenWithTokenType] fetching new token for factorsJson ${C} and tokenType ${b}`);const S=_||{};S.causeId=g;const v=this.onTokenRequired({factorsJson:C,tokenType:b,requestMetadataJson:S,invalidToken:E,isUnauthorized:T,triggeredByRefresh:!1}),I=await this.timeoutPromiseRace(v,Di.TIMEOUT_VALUES_IN_SECONDS.TOKEN_REQUIRED_TIMEOUT,"Token not received from UI in time");return A=Date.now(),P=I?.causeId,this.lastTokenType=I?.tokenType,M=1,this.logger.info(`[${g}][getTokenWithTokenType] fetching new token success for factorsJson ${C} and tokenType ${b}`),I}catch(m){throw this.logger.info(`[${g}][getTokenWithTokenType] failed to fetch token ${getPrintableObject(m)}`),R=m,P=R?.causeId,R.timeOut&&(M=4),this.deletePromisesByTriggeredByRefresh(C,!1),m}finally{const m=!v?.tokenTelemetryData,C=m?{}:v?.tokenTelemetryData;C&&(C.requestCauseId=g,C.responseCauseId=P,C.supportTokenApi=this.clientSupportsGenericTokenAPI,C.requestTokenFactors=S?.factorsJson,C.tokenRequestTime=I,C.tokenResponseTime=A,C.tokenRequestStatus=M,C.requestTokenType=S?.tokenType,C.foundInCache=3===M,C.responseTokenType=this.lastTokenType,C.timeToResponse=A?A-I:A,C.errorCode=R?.errorCode,C.errorSubCode=R?.errorSubCode),(!v||m&&!v.signalingSession)&&(this.logger.info("[getTokenWithTokenType] TokenContext is not provided, sending token telemetry to Token table"),this.sendTokenTelemetry(C))}}async onTokenRequired(g){const{factorsJson:m,tokenType:S,requestMetadataJson:v,invalidToken:C,isUnauthorized:_,triggeredByRefresh:E}=g;if(this.logger.info(`[onTokenRequired] factorsJson=${m} tokenType=${S}`),!S)return this.logger.info(`[onTokenRequired] factorsJson=${m} with no token type`),Promise.reject({errorCode:Di.HTTP_STATUS_CODES.UNAUTHORIZED,errorSubCode:0,causeId:v?.causeId});if(this.tokensPromiseMap[m]&&!E)for(const g of this.tokensPromiseMap[m])if(g.tokenRequestOptions.tokenType===S)return this.logger.info(`[onTokenRequired] factorsJson=${m} and tokenType ${S} has pending request`),g.defered.promise;this.tokensPromiseMap[m]||(this.tokensPromiseMap[m]=[]);const T=defer();return this.tokensPromiseMap[m].push({tokenRequestOptions:g,defered:T}),this.tokenCallback({factorsJson:m,tokenType:S,requestMetadataJson:v,invalidToken:C,isUnauthorized:_}),T.promise}setTokenCaching(g,m){this.tokenCachingEnabled!==g&&(this.logger.info(`[authTokenManager]setTokenCaching=${g}`),this.tokenCachingEnabled=g)}setTokenCachingForGenericTokenAPI(g,m){this.enableTokenCacheForGenericTokenAPI!==g&&(this.logger.info(`[authTokenManager]setTokenCachingForGenericTokenAPI=${g}`),this.enableTokenCacheForGenericTokenAPI=g)}calculateTokenExpiry(g,m,S){const{factorsJson:v,tokenType:C}=m;let _=S-epochTimeInSecRoundedDown(),E=_,T=S;if(_&&_>0&&_>this.refreshTimeBeforeTokenTimeoutInSeconds){switch(C){case 4:_>this.aadTokenExpirationTimeInSeconds&&(_=this.aadTokenExpirationTimeInSeconds);break;case 8:_>this.caeTokenExpirationTimeInSeconds&&(_=this.caeTokenExpirationTimeInSeconds);break;default:_>Bi&&(_=Bi)}E=_-this.refreshTimeBeforeTokenTimeoutInSeconds,T=E+epochTimeInSecRoundedDown()}return this.logger.info(`[${g}][calculateTokenExpiry] calculate expiry to ${T} tokenType=${C} factorsJson=${v}`),T}addToCache(g,m,S,v){this.clearExpiredTokens(),this.cacheTokenManager.setToken(g,m,S,v)}clearExpiredTokens(){this.forceClearExpiredTokens&&this.cacheTokenManager.clearExpiredTokens(this.logger)}async getToken(g,m=!1,S,v){if(this.clientSupportsGenericTokenAPI){this.logger.info(`[${g}][getToken] callingTokenAPI is enabled so using new API to fetch it`);const{token:C}=await this.getTokenWithTokenType(g,m,S,v);return C}const C=Date.now();let _,E,T=2;try{if(m&&this.invalidateCachedToken(g),this.cachedToken&&this.tokenCachingEnabled)return this.logger.info(`[${g}][getToken] returning cached token`),T=3,Promise.resolve(this.cachedToken);this.logger.info(`[${g}][getToken] fetching new token`);const S=await this.tokenProvider();return _=Date.now(),S?(this.tokenCachingEnabled&&(this.cachedToken=S),T=1,this.lastToken=S,this.lastTokenType=1,this.logger.info(`[${g}][getToken] fetching new token success`),S):(this.logger.info(`[${g}][getToken] received empty token`),Promise.reject("Received empty token"))}catch(m){throw this.logger.info(`[${g}][getToken] failed to fetch token=${getPrintableObject(m)}`),E=m,this.cachedToken="",m}finally{const m=v?.tokenTelemetryData;m&&(m.requestCauseId=g,m.supportTokenApi=this.clientSupportsGenericTokenAPI,m.requestTokenFactors=S?.factorsJson,m.tokenRequestTime=C,m.tokenResponseTime=_,m.tokenRequestStatus=T,m.requestTokenType=S?.tokenType,m.foundInCache=3===T,m.responseTokenType=this.lastTokenType,m.timeToResponse=_?_-C:_,m.errorCode=E?.errorCode,m.errorSubCode=E?.errorSubCode)}}invalidateCachedToken(g){this.cachedToken&&(this.logger.info(`[${g}][invalidateCachedToken]`),this.cachedToken="")}invalidateCachedTokenWithTokenType(g,m,S){8===g&&this.cacheTokenManager.getToken(8,S,this.logger)?.token===m&&(this.cacheTimers.stopTimer(S,g.toString()),this.cacheTokenManager.resetToken(8)),4===g&&this.cacheTokenManager.getToken(4,S,this.logger)?.token===m&&(this.cacheTimers.stopTimer(S,g.toString()),this.cacheTokenManager.resetToken(4)),1===g&&this.cacheTokenManager.getToken(1,S,this.logger)?.token===m&&(this.cacheTimers.stopTimer(S,g.toString()),this.cacheTokenManager.resetToken(1))}getLastToken(g){return this.logger.info(`[${g}][getLastToken]`),this.lastToken}getLastTokenWithTokenType(g,m,S){return this.logger.info(`[${g}][getLastTokenWithTokenType] with Token Type: ${m}`),this.cacheTokenManager.getToken(m,S,this.logger)?.token}async timeoutPromiseRace(g,m,S){let v;const C=new Promise(((g,C)=>{v=window.setTimeout((()=>{C({phrase:S,timeOut:!0})}),secondsToMillieSeconds(m))}));return Promise.race([g.then((g=>(clearTimeout(v),g))),C])}getLastTokenType(g){return this.logger.info(`[${g}][getLastTokenType] lastTokenType=${this.lastTokenType}`),this.lastTokenType}updateTokenSettings(g){const{clientSupportsGenericTokenAPI:m,aadTokenExpirationTimeInSeconds:S,caeTokenExpirationTimeInSeconds:v,refreshTimeBeforeTokenTimeoutInSeconds:C,enablePublishTokenTelemetry:_,enableRefreshToken:E,forceClearExpiredTokens:T,enableRefreshTokenRetry:I,enableRefreshTokenRetryInSeconds:b}=g;this.logger.info(`updateTokenSettings ${JSON.stringify(g)}`),this.clientSupportsGenericTokenAPI=m??this.clientSupportsGenericTokenAPI,this.aadTokenExpirationTimeInSeconds=S??this.aadTokenExpirationTimeInSeconds,this.caeTokenExpirationTimeInSeconds=v??this.caeTokenExpirationTimeInSeconds,this.refreshTimeBeforeTokenTimeoutInSeconds=C??this.refreshTimeBeforeTokenTimeoutInSeconds,this.enablePublishTokenTelemetry=_??this.enablePublishTokenTelemetry,this.forceClearExpiredTokens=T??this.forceClearExpiredTokens,this.enableRefreshToken=E??this.enableRefreshToken,this.enableRefreshTokenRetry=I??this.enableRefreshTokenRetry,this.enableRefreshTokenRetryInSeconds=b??this.enableRefreshTokenRetryInSeconds}updateToken(g,m,S,v,C){if(this.logger.info(`[${v}][updateToken] UI replies a token with factorsJson=${g} updateMetadata=${JSON.stringify(m)} tokenExpirySecSinceEpoch?=${C}`),m.error){this.logger.info(`[${v}][updateToken] UI replies with error ${m.error} for factorsJson ${g}`);for(const S of this.tokensPromiseMap[g])S.tokenRequestOptions.requestMetadataJson.causeId===v&&S.defered.reject({phrase:m.error?.phrase,errorCode:m.error?.code,errorSubCode:m.error?.subCode,causeId:v});return}if(!S){this.logger.info(`[${v}][updateToken] received empty token`);for(const m of this.tokensPromiseMap[g])m.tokenRequestOptions.requestMetadataJson.causeId===v&&m.defered.reject({phrase:"Received empty token",causeId:v});return}if(C>epochTimeInSecRoundedDown()&&this.enableTokenCacheForGenericTokenAPI){this.logger.info(`[${v}][updateToken] caching Token with tokenType=${m.tokenType}`);const _={factorsJson:g,tokenType:m.tokenType,invalidToken:S};this.addToCache(m.tokenType,S,g,this.calculateTokenExpiry(v,_,C))}if(!this.tokensPromiseMap[g]){this.logger.warn(`[updateToken]: UI try to update token with invalid factorsJson=${g}`);const S={responseCauseId:v,supportTokenApi:this.clientSupportsGenericTokenAPI,requestTokenFactors:g,tokenResponseTime:Date.now(),tokenRequestStatus:6,responseTokenType:m.tokenType};return void this.sendTokenTelemetry(S)}if(this.tokensPromiseMap[g]){const C=this.tokensPromiseMap[g];for(let _=C.length-1;_>=0;_--)(C[_]?.tokenRequestOptions.tokenType&m.tokenType)>0&&(C[_].defered.resolve({token:S,tokenType:m.tokenType,causeId:v}),this.tokensPromiseMap[g].splice(_,1))}if(this.logger.info(`[${v}][updateToken] resolved and upateToken with factorsJson=${g} tokenType=${m.tokenType}`),0===this.tokensPromiseMap[g].length&&delete this.tokensPromiseMap[g],4!==m.tokenType&&8!==m.tokenType&&1!==m.tokenType)return;if(Object.keys(this.tokensPromiseMap).length>0)for(const C of Object.values(this.tokensPromiseMap))for(let _=C.length-1;_>=0;_--){const E=C[_];E.tokenRequestOptions.factorsJson!==g&&(E.tokenRequestOptions.tokenType&m.tokenType)>0&&!E.tokenRequestOptions.isUnauthorized&&(E.defered.resolve({token:S,tokenType:m.tokenType,causeId:v}),C.splice(_,1))}for(const g of Object.keys(this.tokensPromiseMap))0===this.tokensPromiseMap[g].length&&delete this.tokensPromiseMap[g];const _=C-epochTimeInSecRoundedDown();this.startTokenRefreshTimer(_>=0?secondsToMillieSeconds(_):0)}setTokenRequiredCallBack(g){this.tokenCallback=g}setDisableTimerFlag(g){this.logger.info(`[setDisableTimerFlag] set disableTimerFlag to ${g}`),this.stopTimerFlag=g}sendTokenTelemetry(g){if(!this.enablePublishTokenTelemetry)return;const m={};m[xi.TOKEN_TELEMETRY_EVENT.TOKEN_TELEMETRY]=JSON.stringify(g),this.telemetryManager?(this.logger.info("[sendTokenTelemetry] sending token telemetry:",m),this.telemetryManager.sendEvent(xi.EVENT_TYPE.CONVERSATION_TOKEN,m)):this.logger.warn("[sendTokenTelemetry] telemetryManager is undefined, cannot send token telemetry")}dispose(){this.cacheTimers&&this.cacheTimers.dispose()}},$i={build:(g,m,S,v)=>new Hi(g,m,S,v)},Gi=class{constructor(g){this.piiScrubber=this.getPiiScrubber(g)}scrubParticipantsList(g){const m=[];return Array.isArray(g)&&g.forEach((g=>m.push(this.scrubMriOrOmit(g)))),m}scrubMriOrOmit(g){return"string"==typeof g?this.piiScrubber.mri(g):this.piiScrubber.omit(g)}static scrubDisplayNamesFromResponse(g){const m=/"displayName": "[a-z]+"/gi;return safeJsonStringify(g).replace(m,'"displayName": "(redacted)"')}getPiiScrubber(g){return g&&"function"==typeof g.omit&&"function"==typeof g.mri?g:{omit:()=>"<pii:omit/>",mri:()=>"<pii:mri/>"}}},ji=__toESM(P);function getMediaLabel(g){switch(g){case 0:return"main-audio";case 1:return"main-video";case 2:return"applicationsharing-video";case 3:return"data"}throw new Error("Invalid media type")}function mapMediaTypeStringToMediaType(g){switch(g){case"audio":return 0;case"video":return 1;case"applicationsharing-video":return 2;case"data":return 3;default:return}}function hasParticipantLegId(g,m){return g.endpoints?.endpointDetails?.some((g=>g.participantId===m))??!1}function findSelfEndpointDetailUsingParticipantLegId(g,m){return g.endpoints?.endpointDetails.find((g=>g.participantId===m))}function findParticipantUsingParticipantLegId(g,m){return g.participants.find((g=>hasParticipantLegId(g,m)))}function hasStagingGroup(g){return!!g?.meetingGroupDetails?.groups&&Object.keys(g.meetingGroupDetails.groups).some((g=>"stagingGroup"===g))}function getSourceIdForMediaType(g,m){let S=-1;try{if(g.endpoints)e:for(const v of g.endpoints.endpointDetails)if(null!==v&&void 0!==v.mediaStreams){for(const g of v.mediaStreams)if(mapMediaTypeStringToMediaType(g.type)===m){S=g.sourceId;break e}}else S=Xt}catch(g){return-1}return S}function getSourceId(g,m,S){if(!g||!g.endpoints)return-1;const v=g.endpoints.endpointDetails.find((g=>g?.participantId===m));if(!v)return getSourceIdForMediaType(g,S);if(!v.mediaStreams)return getSourceIdForMediaType(g,S);const C=v.mediaStreams.find((({type:g})=>mapMediaTypeStringToMediaType(g)===S));return C?C.sourceId:-1}function getParticipantIdForSourceId(g,m,S){try{if(!g.endpoints)return;for(const v of g.endpoints.endpointDetails)if(v?.mediaStreams)for(const g of v.mediaStreams)if(S===g.sourceId&&mapMediaTypeStringToMediaType(g.type)===m)return v.participantId??null;return}catch(g){return}}function isScreenSharerStream(g){return"sendonly"===g.direction&&"applicationsharing-video"===g.label}function getSharingParticipantLeg(g){if(g.endpoints?.endpointDetails)return 1===g.endpoints.endpointDetails.length?g.endpoints.endpointDetails[0].participantId:g.endpoints.endpointDetails.find((g=>g?.mediaStreams?.some(isScreenSharerStream)))?.participantId}function processTransactionResponse(g){let m={};if(g.stateId)m.result=g.stateId;else if(g.results){const{results:S}=g;1===S.length&&S[0].stateId&&(m.result=S[0].stateId);const v={};g.results.forEach((g=>{const{result:S}=g,C=getParticipantId(g);(void 0===m.code||S.code>m.code)&&(m.code=S.code,m.subCode=S.subCode),v[C]=g})),m.result=JSON.stringify(v)}else g.result&&(m={code:g.result.code,phrase:g.result.phrase,subCode:g.result.subCode,resultCategories:g.result.resultCategories},g.additionalDetail&&(m.result=g.additionalDetail));return m}function getParticipantId(g){return g.participantId||g.participant&&g.participant.id}var qi=class{constructor(g,m){this.broadcastContext=null,this.broadcastControllerUrl="",this.broadcastCallbackUrl="",this.broadcastState=null,this.setContext=(g=null)=>{this.logger.info("BroadcastSession :: set broadcast context",g),this.broadcastContext=g},this.getContext=()=>(this.logger.info("BroadcastSession :: get broadcast context",this.broadcastContext||null),this.broadcastContext||null),this.signalingSession=g,this.signalingSessionCallback=m,this.logger=g.logger.createChild((()=>"[Broadcast]"))}handleBroadcastStateChanged(g){const m=g.body;this.broadcastState=m;const S=extractCauseIdFromMessage(g);this.signalingSession.telemetryHelper.recordIncomingEvent(Li.BROADCAST_STATE_CHANGED,g),this.logger.info(`[${S}] broadcast state changed=${this.broadcastState}`),this.updateBroadcastMetadata(S)}updateBroadcastCallbackUrl(g){const m=get(this.signalingSession,Mi.CONV_BROADCAST_UPDATE);this.broadcastCallbackUrl!==m&&(this.broadcastCallbackUrl=m,this.logger.info(`[${g}] broadcast callback url changed=${this.broadcastCallbackUrl}`),this.updateBroadcastMetadata(g))}handleBroadcastDetailsChanged(g,m){this.signalingSession.telemetryHelper.recordEvent(Li.UPDATE_BROADCAST_DETAILS,{causeId:m}),g.activeModalities&&g.activeModalities.broadcast&&g.activeModalities.broadcast.controller!==this.broadcastControllerUrl&&(this.broadcastControllerUrl=g.activeModalities.broadcast.controller,this.broadcastAdditionalData=g.activeModalities.broadcast,this.logger.info(`[${m}] broadcast controller changed=${this.broadcastControllerUrl}`),this.signalingSessionCallback.onBroadcastMeetingConnected(Di.SUCCESS_TRANSACTION_END,m),this.updateBroadcastMetadata(m)),!this.broadcastControllerUrl||g.activeModalities&&g.activeModalities.broadcast||(this.broadcastControllerUrl="",this.broadcastContext=null,this.logger.info(`[${m}] broadcast controller changed=${this.broadcastControllerUrl}`),this.updateBroadcastMetadata(m),this.signalingSessionCallback.onBroadcastMeetingEnded(Di.SUCCESS_TRANSACTION_END,m))}handleAddBroadcastModalitySuccess(g,m){this.logger.info(`[${m}][handleAddBroadcastModalitySuccess]`)}handleAddBroadcastModalityFailure(g,m){this.logger.info(`[${m}][handleAddBroadcastModalityFailure]`);const S={...g.modalityFailure.broadcast};this.signalingSessionCallback.onBroadcastMeetingEnded(S,m)}updateBroadcastMetadata(g){const m={broadcastControllerUrl:this.broadcastControllerUrl,broadcastStateCallbackUrl:this.broadcastCallbackUrl,broadcastState:this.broadcastState,broadcastAdditionalData:this.broadcastAdditionalData};this.logger.info(`[${g}] update broadcast metadata=${m}`),this.signalingSessionCallback.onBroadcastMeetingUpdated&&this.signalingSessionCallback.onBroadcastMeetingUpdated(m,g)}},Wi=class{static build(g,m){return new zi(g,m)}},zi=class{constructor(g,m){this.ontimeout=g,this.name=m}start(g){if(void 0!==this.timeoutId)throw new Error(`Timer ${this.name} already started`);return this.timeoutId=window.setTimeout((()=>this.ontimeout()),g),this}stop(){if(void 0===this.timeoutId)throw new Error(`Timer ${this.name} is not defined`);clearTimeout(this.timeoutId),this.timeoutId=void 0}},Ki="http://broker.invalid/",Ji=30,Yi=5,Qi=1,Xi=class{constructor(g){this._signalingSession=g,this.baseUrl=Ki,this.currentSubscriptionUrl=null,this._currentSubscriptionTimeoutInSec=Ji,this._subscribers=[],this._disposed=!1,this._reportedResultCount=0,this._subscriptionRetryBackoffInSec=Yi,this._notifySubscribers=g=>{this._logger.info("_notifySubscribers"),Promise.resolve().then((()=>{g.split(",").forEach((g=>{const m=parseRawHttpMessage(decodeMessage(g));let S=m.body;isEncodedMessage(m.headers)&&isMessageEncodingSupported(m.headers)&&(S=decodeMessage(S));const v={url:m.url,body:JSON.parse(S),headers:m.headers};this._logger.info("message length=",S.length,"n. of subscribers",this._subscribers.length),this._subscribers.forEach((g=>g(v)))}))})).catch((g=>{this._logger.error("_notifySubscribers, failed to decode message",g),this._signalingSession.telemetryHelper.recordEvent(Li.BROKER_DECODE_PAYLOAD_FAILURE)}))},this._subscribeToBroker=(g,m)=>{if(this._disposed)return void this._logger.warn("_subscribeToBroker, disposed, ignore subscription");const S=causeId2();this._logger.info("_subscribeToBroker, url: ",g,",timeout in sec",m),this.currentSubscriptionUrl=g,this._currentSubscriptionTimeoutInSec=m,this._clearAllPendingTimeouts(),this._setSubscriptionTimeout(m),this._signalingSession.http.sendGetRequest({url:this.currentSubscriptionUrl,requestName:Fi.BROKER_SUBSCRIBE.name,customHeaders:this._getBrokerRequestHeaders(S),payload:null,skipHttpTelemetry:!this._reportSubscriptionInTelemetry(),causeId:causeId2(),operationType:"BrokerSubscribe"}).then(this._handleSubscriptionSuccess).catch(this._handleSubscriptionFailure)},this._clearAllPendingTimeouts=()=>{this._cancelRequestTimer&&(this._cancelRequestTimer.stop(),this._cancelRequestTimer=null),this._retryRequestTimer&&(this._retryRequestTimer.stop(),this._retryRequestTimer=null)},this._abortPendingRequest=()=>{this._signalingSession.http.cancelRequestIfPending(Fi.BROKER_SUBSCRIBE.name,causeId2())},this._setSubscriptionTimeout=g=>{this._cancelRequestTimer=Wi.build((()=>{this._disposed||(this._signalingSession.http.hasPendingRequest(Fi.BROKER_SUBSCRIBE.name)?(this._logger.warn("timeout subscription"),this._signalingSession.telemetryHelper.recordEvent(Li.BROKER_SUBSCRIPTION_TIMEOUT),this._signalingSession.http.cancelRequestIfPending(Fi.BROKER_SUBSCRIBE.name,causeId2())):this._logger.error("Unable to resolve timeout deferred, it is not defined!"))}),"TIMEOUT").start(1e3*g)},this._handleSubscriptionSuccess=g=>{if(this._disposed)this._logger.warn("_handleSubscriptionSuccess, disposed, ignore subscription success");else if(this._reportSubscriptionInTelemetry(g)&&this._signalingSession.telemetryHelper.recordEvent(Li.BROKER_SUBSCRIPTION_SUCCESSFUL),g&&g.response){const m=g.response;this._logger.info("_handleSubscriptionSuccess, response",m),m.message&&this._notifySubscribers(m.message);const S=m.nextSubscribeUrl||this.currentSubscriptionUrl,v=m.expirationTimeInSec||this._currentSubscriptionTimeoutInSec;this._subscribeToBroker(S,v)}else this._logger.info("_handleSubscriptionSuccess, empty response")},this._handleSubscriptionFailure=g=>{if(this._disposed)return void this._logger.warn("_handleSubscriptionFailure, disposed, ignore subscription");if(g.status>=400&&g.status<500&&401!==g.status&&this.isNotNetworkErrors(g.status))return void this._logger.warn(`_handleSubscriptionFailure, received status ${g.status}, stop subscribing`);const m=getPrintableObject(g);this._logger.error("_handleSubscriptionFailure failed, re-subscribing",m),this._reportSubscriptionInTelemetry()&&this._signalingSession.telemetryHelper.recordEvent(Li.BROKER_SUBSCRIPTION_FAILED),this._retryRequestTimer=Wi.build((()=>{this._subscribeToBroker(this.currentSubscriptionUrl,this._currentSubscriptionTimeoutInSec)}),"RETRY").start(1e3*this._subscriptionRetryBackoffInSec)},this._reportSubscriptionInTelemetry=g=>(this._reportedResultCount++,this._reportedResultCount<=Qi),this._getBrokerRequestHeaders=g=>{const m=new Ni;return m.set(Di.HEADERS.CONTENT_TYPE,Di.CONTENT_TYPE.JSON),this._signalingSession.signalingAgentConfig.brokerRequestBatching&&m.set(Di.HEADERS.BROKER_USE_BATCHING_HEADER_NAME,"1"),m},this._logger=this._signalingSession.logger.createChild("Broker"),this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration?.brokerRetryBackOffInSec&&(this._subscriptionRetryBackoffInSec=this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration.brokerRetryBackOffInSec)}subscribeToBroker(g){this._logger.info("subscribeToBroker called."),this._abortPendingRequest(),this._clearAllPendingTimeouts(),this._subscribeToBroker(g,this._currentSubscriptionTimeoutInSec)}onBrokerMessage(g){this._logger.info("onBrokerMessage callback added"),this._subscribers.push(g)}dispose(){this._disposed=!0,this._logger.info("dispose"),this._subscribers=[],this._clearAllPendingTimeouts(),this._abortPendingRequest()}isNotNetworkErrors(g){return 490!==g&&496!==g&&498!==g&&499!==g}},Zi=class{constructor(g){this.requests={},this.logger=g}clear(g,m){const S=m||{code:Di.CALL_END_CODE.SUCCESS,subCode:Di.CALL_END_SUB_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((m=>{try{const v=parseInt(m,10);Object.keys(this.requests[v]).forEach((m=>{this.rejectOperation(v,m,g,S)}))}catch(g){this.logger.warn(`CallOperations: clear error = ${g}`)}}))}hasOperation(g,m){return this.requests.hasOwnProperty(g.valueOf())&&this.requests[g.valueOf()].hasOwnProperty(m)}getAllOperations(){return this.requests}getOperation(g,m){return this.hasOperation(g,m)?this.requests[g.valueOf()][m]:null}setOperation(g,m,S){return!this.hasOperation(g,m)&&(this.hasOwnProperty(g.valueOf())||(this.requests[g.valueOf()]={}),this.requests[g.valueOf()][m]=S,!0)}rejectOperation(g,m,S,v){if(this.hasOperation(g,m)){const S=g.valueOf(),C=this.requests[S][m].promise;delete this.requests[S][m],C.reject(v)}}resolveOperation(g,m,S,v){if(this.hasOperation(g,m)){const v=g.valueOf(),C=this.requests[v][m].promise;delete this.requests[v][m],C.resolve(S)}}},en=class{constructor(g){this.logger=g,this.localRequests=new Zi(g)}dispose(g,m,S){this.logger.info(`[${S}][dispose]`),this.rejectAllPendingOperations(g,m)}hasPendingOperation(g,m,S){return this.logger.info(`[${S}][hasPendingOperation] ${g} ${scrubMriOrOmit(m)}}`),this.localRequests.hasOperation(g,m)}rejectPendingOperation(g,m,S,v,C){this.logger.info(`[${C}][rejectPendingOperation] ${g} ${m} reason: ${S} endCode: ${v}`),this.localRequests.rejectOperation(g,m,S,v)}resolvePendingOperation(g,m,S,v){this.logger.info(`[${v}][resolvePendingOperation]: ${scrubMriOrOmit(m)}`),this.localRequests.resolveOperation(g,m,S,v)}setPendingOperation(g,m,S,v){return this.logger.info(`[${v}][setPendingOperation] ${g} value: ${S}`),this.localRequests.setOperation(g,m,S)}rejectAllPendingOperations(g,m){this.logger.info("rejectLocalQueuedOperations"),this.localRequests.clear(g,m)}};function getPayload(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"content cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:[]},contentSharing:{identifier:m.contentIdentifier,subject:m.subject,sessionState:m.sessionState,sequenceNumber:m.sequenceNumber,links:{sessionUpdate:get(g,Mi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Mi.CONV_CONTENT_SHARING_END)}},links:{addModalitySuccess:get(g,Mi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Mi.CONV_ADD_MODALITY_FAILURE)}}}}function getPayload2(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{contentSharing:{links:{sessionUpdate:get(g,Mi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Mi.CONV_CONTENT_SHARING_END)}},participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload3(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{contentSharingTransactionEnd:m,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload4(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload5(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},links:{sessionUpdate:get(g,Mi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Mi.CONV_CONTENT_SHARING_END)}}}}function getPayload6(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload7(g,m,S){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"sessionState cannot be null"),assertNotNull(S,"sequenceNumber cannot be null"),{payload:{sessionUpdateSequenceNumber:S,sessionState:m,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}var tn=class{constructor(){this.msElapsed=0,this.isPaused=!1,this.startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this.startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this.startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this.startTime,this.durationInMinutes=()=>{const g=this.duration()/6e4;return Math.ceil(g)},this.durationInSeconds=()=>{const g=this.duration()/1e3;return Math.ceil(g)}}};function build3(){return new tn}var nn=class{constructor(g,m,S,v){this.signalingSession=g,this.correlationId=m,this.sessionId=null,this.fsmState=Di.CONTENT_SHARING_FSM_STATE.IDLE,this.addSessionPromise=null,this.removeSessionPromise=null,this.confirmInRosterPromise=null,this.links={},this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.disposed=!1,this.isPresenter=!1,this.FSM_STATES=Di.CONTENT_SHARING_FSM_STATE,this.logger=g.logger.createChild((()=>`[${this.fsmState}][cs=${this.sessionId}][cc=${this.correlationId}]`)),S&&(this.sessionId=S),v&&(this.links=v)}start(g,m,S,v){if(this.logger.info(`[${v}][start]`),assertNotNullOrEmpty(g,"Correct addModality url is not provided"),!this.checkState("start",this.FSM_STATES.IDLE,this.addSessionPromise))return Promise.reject(null);this.addSessionPromise=S,this.confirmInRosterPromise=defer2(),this.fsmState=this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.addTelemetryOperation(Fi.ADD_CONTENT_SHARING_MODALITY.name,{causeId:v});const C=new Ni;return C.set(Di.HEADERS.CONTENT_SHARING_CORRELATION_ID,this.correlationId),this.signalingSession.http.sendPostRequest({url:g,payload:getPayload(this.signalingSession,m),requestName:Fi.ADD_CONTENT_SHARING_MODALITY.name,customHeaders:C,onceTrouterReady:()=>{this.startContentSharingTimer(v)},causeId:v}).then((()=>{this.disposed||(this.presenterMri=this.signalingSession.participantManager.localParticipant.id,this.isPresenter=!0)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${v}][start] error: ${getPrintableObject(m)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise(getPrintableObject(g),m.error)),Promise.reject(null)}))}delete(g,m){this.logger.info(`[${m}][delete]`);let S=!1;if(this.fsmState===this.FSM_STATES.IDLE)return this.logger.info(`[${m}][delete] skipped because state is already ${this.fsmState}`),g.resolve(),Promise.resolve();if(this.fsmState===this.FSM_STATES.CONTENT_SHARING_START_INITIATED)S=!0,this.rejectPendingPromise("Session delete called before start was finished");else if(!this.checkState("delete",this.FSM_STATES.CONTENT_SHARING_CONNECTED,g))return Promise.reject(null);S||assertNotNullOrEmpty(this.links[Di.LINKS.CONTENT_SHARING_CONTROLLER],"Correct controller url is not set"),this.removeSessionPromise=g,this.fsmState=this.FSM_STATES.CONTENT_SHARING_DELETE_INITIATED;const v=build3(),C=this.addTelemetryOperation(Fi.DELETE_CONTENT_SHARING.name,{causeId:m});return(S?Promise.resolve(void 0):this.signalingSession.http.sendDeleteRequest({url:this.links[Di.LINKS.CONTENT_SHARING_CONTROLLER],requestName:Fi.DELETE_CONTENT_SHARING.name,payload:getPayload3(this.signalingSession,{code:Di.CALL_END_CODE.SUCCESS,subCode:Di.CALL_END_SUB_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.LOCAL_USER_INITIATED}),causeId:m})).then((()=>{if(!this.disposed){const g={success:!0,duration:v.duration()};S&&(g.skipReason="Session delete called before start was finished"),this.updateTelemetryOperation(C,g),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][delete] error: ${getPrintableObject(S)}`),!this.disposed){const g={success:!1,duration:v.duration()};this.updateTelemetryOperation(C,g),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}return Promise.reject(null)}))}join(g,m){if(this.logger.info(`[${m}][join]`),assertNotNullOrEmpty(this.links[Di.LINKS.CONTENT_SHARING_CONTROLLER],"Correct joinContentSharing url is not provided"),!this.checkState("join",this.FSM_STATES.IDLE,g))return;this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.addSessionPromise=g,this.fsmState=this.FSM_STATES.CONTENT_SHARING_JOIN_INITIATED;const S=build3(),v=this.addTelemetryOperation(Fi.JOIN_CONTENT_SHARING.name,{causeId:m});this.signalingSession.http.sendPostRequest({url:this.links[Di.LINKS.CONTENT_SHARING_CONTROLLER],payload:getPayload2(this.signalingSession),requestName:Fi.JOIN_CONTENT_SHARING.name,causeId:m}).then((g=>{if(!this.disposed){const m={success:!0,duration:S.duration()};this.updateTelemetryOperation(v,m),this.processStartOrJoinSuccess(g.response),this.resolvePendingPromise(g.response)}})).catch((g=>{const C=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][join] error: ${getPrintableObject(C)}`),!this.disposed){const m={success:!1,duration:S.duration()};this.updateTelemetryOperation(v,m);const _=C.error;this.rejectPendingPromise(getPrintableObject(g),_)}}))}takeControl(g,m){if(this.logger.info(`[${m}][takeControl]`),assertNotNullOrEmpty(this.links[Di.LINKS.CONTENT_SHARING_TAKE_CONTROL],"correct contentSharingTakeControl url is not provided"),!this.checkState("takeControl",this.FSM_STATES.CONTENT_SHARING_CONNECTED,g))return;const S=build3(),v=this.addTelemetryOperation(Fi.TAKE_CONTROL_CONTENT_SHARING.name,{causeId:m});this.signalingSession.http.sendPostRequest({url:this.links[Di.LINKS.CONTENT_SHARING_TAKE_CONTROL],payload:getPayload4(this.signalingSession),requestName:Fi.TAKE_CONTROL_CONTENT_SHARING.name,withoutTrouter:!0,causeId:m}).then((m=>{if(!this.disposed){const C={success:!0,duration:S.duration()};this.updateTelemetryOperation(v,C);const _={contentIdentifier:m.response.identifier,presenter:m.response.presenter.id,subject:m.response.subject||null,sessionState:m.response.sessionState||null};g.resolve(_)}})).catch((C=>{const _=getErrorForXHRFailure(C,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][takeControl] error: ${getPrintableObject(_)}`),!this.disposed){const m={success:!1,duration:S.duration()};this.updateTelemetryOperation(v,m);const E=new Error(getPrintableObject(C));E.endCode=_.error,g.reject(E)}}))}updateSessionState(g,m,S){if(this.logger.info(`[${S}][updateSessionState]`),assertNotNullOrEmpty(this.links[Di.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],"Correct sendUpdateSessionState url is not provided"),!this.checkState("updateSessionState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,m))return;const v=build3(),C=this.addTelemetryOperation(Fi.UPDATE_SESSION_STATE_CONTENT_SHARING.name,{causeId:S});this.signalingSession.http.sendPostRequest({url:this.links[Di.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],payload:getPayload7(this.signalingSession,g,this.nextClientSequenceNumberToUse++),requestName:Fi.UPDATE_SESSION_STATE_CONTENT_SHARING.name,causeId:S}).then((()=>{if(!this.disposed){const g={success:!0,duration:v.duration()};this.updateTelemetryOperation(C,g),m.resolve()}})).catch((g=>{const _=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${S}][updateSessionState] error: ${getPrintableObject(_)}`),!this.disposed){const S={success:!1,duration:v.duration()};this.updateTelemetryOperation(C,S);const E=new Error(getPrintableObject(g));E.endCode=_.error,m.reject(E)}}))}updateParticipantState(g,m){if(this.logger.info(`[${m}][updateParticipantState]`),assertNotNullOrEmpty(this.links[Di.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],"correct confirmContentSharingView url is not provided"),!this.checkState("updateParticipantState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,g))return;const S=build3(),v=this.addTelemetryOperation(Fi.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,{causeId:m});this.signalingSession.http.sendPostRequest({url:this.links[Di.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],payload:getPayload6(this.signalingSession),requestName:Fi.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,withoutTrouter:!0,causeId:m}).then((()=>{if(!this.disposed){const m={success:!0,duration:S.duration()};this.updateTelemetryOperation(v,m),g.resolve()}})).catch((C=>{const _=getErrorForXHRFailure(C,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][updateParticipantState] error: ${getPrintableObject(_)}`),!this.disposed){const m={success:!1,duration:S.duration()};this.updateTelemetryOperation(v,m);const E=new Error(getPrintableObject(C));E.endCode=_.error,g.reject(E)}}))}updateNotificationLinks(g){if(this.logger.info(`[${g}][updateNotificationLinks]`),assertNotNullOrEmpty(this.links[Di.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],"correct notificationLinks url is not provided"),!this.checkState("updateState",this.FSM_STATES.CONTENT_SHARING_CONNECTED))return;const m=build3(),S=this.addTelemetryOperation(Fi.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,{causeId:g});this.signalingSession.http.sendPostRequest({url:this.links[Di.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],payload:getPayload5(this.signalingSession),requestName:Fi.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,withoutTrouter:!0,causeId:g}).then((()=>{if(!this.disposed){const g={success:!0,duration:m.duration()};this.updateTelemetryOperation(S,g)}})).catch((v=>{const C=getErrorForXHRFailure(v,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${g}][updateNotificationLinks] error: ${getPrintableObject(C)}`),!this.disposed){const g={success:!1,duration:m.duration()};this.updateTelemetryOperation(S,g)}}))}confirmInRoster(){this.confirmInRosterPromise&&this.confirmInRosterPromise.isPending&&(this.logger.info("Confirmed in roster"),this.confirmInRosterPromise.resolve())}handleAddModalitySuccess(g,m){return this.logger.info(`[${m}][handleAddModalitySuccess]`),this.checkState("handleAddModalitySuccess",this.FSM_STATES.CONTENT_SHARING_START_INITIATED)?g.modalitySuccess&&g.modalitySuccess.contentSharing?(this.addTelemetryOperation(Li.HANDLE_ADD_MODALITY_SUCCESS,{causeId:m}),this.processStartOrJoinSuccess(g.modalitySuccess.contentSharing),this.confirmInRosterPromise.promise.then((()=>{delete this.confirmInRosterPromise,this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_MODALITY),this.resolvePendingPromise(g.modalitySuccess.contentSharing)})),!0):(this.addTelemetryOperation(Li.HANDLE_ADD_MODALITY_SUCCESS,{causeId:m,skipReason:"no content sharing blob"}),this.logger.info(`[${m}][handleAddModalitySuccess] ignored because modalitySuccess was missing or did not contain content sharing blob`),!1):(this.logger.info(`[${m}][handleAddModalitySuccess] ignored because session is not waiting to start`),!1)}handleAddModalityFailure(g,m){this.logger.info(`[${m}][handleAddModalityFailure]`);if(!this.checkState("handleAddModalityFailure",[this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.FSM_STATES.CONTENT_SHARING_CONNECTED]))return!1;if(!g.modalityFailure||!g.modalityFailure.contentSharing)return this.addTelemetryOperation(Li.HANDLE_ADD_MODALITY_FAILURE,{causeId:m,skipReason:"no content sharing blob"}),!1;const S=g.modalityFailure.contentSharing;this.addTelemetryOperation(Li.HANDLE_ADD_MODALITY_FAILURE,{reason:S,causeId:m});const v={...S};return this.sendTelemetryData(v),this.rejectPendingPromise(v.phrase,v),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_MODALITY),!0}handleStartFromRoster(g,m){this.logger.info(`[${m}][handleStartFromRoster]`),this.addTelemetryOperation(Li.CONTENT_SHARING_START_FROM_ROSTER,{causeId:m})}handleStopFromRoster(g,m){this.logger.info(`[${m}][handleStopFromRoster]`),this.addTelemetryOperation(Li.CONTENT_SHARING_END_FROM_ROSTER,{causeId:m}),this.sendTelemetryData(g)}handleStop(g,m){if(this.logger.info(`[${m}][handleStop]`),this.isSelfInitiatedAction(g))return this.logger.info(`[${m}][handleStop]handleStop skipped because session was ended by self`),!1;const S={...g.contentSharingTransactionEnd};return this.addTelemetryOperation(Li.HANDLE_CONTENT_SHARING_END,{causeId:m}),this.sendTelemetryData(S),!0}handleUpdate(g,m){return this.logger.info(`[${m}][handleUpdate]`),g.sequenceNumber<=this.lastUpdateSequenceNumber?(this.logger.info(`handleUpdate skipped because of old sequence number: last received ${this.lastUpdateSequenceNumber}, update contained ${g.sequenceNumber}`),this.addTelemetryOperation(Li.HANDLE_CONTENT_SHARING_UPDATE,{causeId:m,skipReason:"old sequence number"}),!1):(this.lastUpdateSequenceNumber=g.sequenceNumber,this.isPresenter=g.presenter.id===this.signalingSession.participantManager.localParticipant.id,this.addTelemetryOperation(Li.HANDLE_CONTENT_SHARING_UPDATE,{causeId:m}),!0)}dispose(g,m){this.logger.info(`[${m}][dispose]`),this.disposed=!0,this.rejectPendingPromise("call ended",g||{code:Di.CALL_END_CODE.SUCCESS,subCode:Di.CALL_END_SUB_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.LOCAL_USER_INITIATED}),this.addTelemetryOperation(Li.HANDLE_CALL_END,{causeId:m}),this.sendTelemetryData(g)}rejectPendingPromise(g,m){this.logger.info("rejectPendingPromise");const S=new Error(g);m&&(S.endCode=m),this.removeSessionPromise&&(this.removeSessionPromise.reject(S),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.reject(S),this.addSessionPromise=null)}resolvePendingPromise(g){this.logger.info("resolvePendingPromise");let m=null;g&&(m={sessionId:g.sessionId,correlationId:g.contentSharingCorrelationId,contentIdentifier:g.identifier,presenter:g.presenter.id,subject:g.subject||null,sessionState:g.sessionState||null}),this.removeSessionPromise&&(this.removeSessionPromise.resolve(m),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.resolve(m),this.addSessionPromise=null)}processStartOrJoinSuccess(g){this.logger.info("processStartOrJoinSuccess"),this.sessionId=g.sessionId,this.fsmState=this.FSM_STATES.CONTENT_SHARING_CONNECTED,this.lastUpdateSequenceNumber=-1,this.links[Di.LINKS.CONTENT_SHARING_CONTROLLER]=g.links.contentSharingController,this.links[Di.LINKS.CONTENT_SHARING_TAKE_CONTROL]=g.links.takeControl,this.links[Di.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE]=g.links.updateSessionState,this.links[Di.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE]=g.links.sync,this.links[Di.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS]=g.links.notificationLinks,this.links[Di.LINKS.CONTENT_SHARING_LEAVE]=g.links.leave}checkState(g,m,S){let v;if(v="string"==typeof m?this.fsmState===m:m.indexOf(this.fsmState)>-1,v)return!0;{const v=`${g} requires state ${m}, but state is ${this.fsmState}`;return this.logger.error(v),S&&S.reject(v),!1}}isSelfInitiatedAction(g){return g.presenter.participantId===this.signalingSession.participantManager.localParticipant.participantId}startContentSharingTimer(g){this.logger.info("startContentSharingTimer"),this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.ADD_MODALITY,(()=>{this.addTelemetryOperation(Li.ADD_MODALITY_TIMEOUT,{causeId:g}),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise("timed out waiting for ContentSharing to start",{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Di.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT})}),Di.TIMEOUT_VALUES_IN_SECONDS.ADD_MODALITY_TIMEOUT)}addTelemetryOperation(g,m){return this.signalingSession.telemetryHelper.addContentSharingOperation(this.correlationId,g,m)}updateTelemetryOperation(g,m){this.signalingSession.telemetryHelper.updateContentSharingOperation(this.correlationId,g,m)}sendTelemetryData(g){this.signalingSession.telemetryHelper.sendContentSharingTelemetryData(this.correlationId,this.signalingSession.sessionId,this.isPresenter,g,this.links[Di.LINKS.CONTENT_SHARING_CONTROLLER],this.sessionId)}},rn=class{constructor(g,m){this.contentSharingToStartCallWith=null,this.contentSharingSessions={},this.DEFAULT_STOP_REASON={code:Di.CALL_END_CODE.SUCCESS,subCode:Di.CALL_END_SUB_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.REMOTE_USER_INITIATED},this.DEFAULT_STOP_ID="8:unknown",this.deleteContentSharingAsync=(g,m)=>{this.logger.info(`[${m}][deleteContentSharingAsync]`);const S=defer2();let v=this.contentSharingSessions[g];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===g&&(v=this.pendingSessionToStart),v){const always=()=>{this.contentSharingSessions[g]&&delete this.contentSharingSessions[g]};v.delete(S,m).then(always,always)}else this.rejectBecauseOfMissingSession(g,S);return S.promise},this.signalingSession=g,this.signalingSessionCallback=m,this.logger=g.logger.createChild((()=>"[ContentSharingManager]")),this.lastProcessedSequenceNumber=-1,this.lastProcessedSequenceNumberForParticipant={}}startContentSharingAsync(g,m,S,v,C,_,E){if(this.logger.info(`startContentSharingAsync called for: ${g}`),this.pendingSessionToStart){const g="There is already a ContentSharing session start pending";return this.logger.error(g),Promise.reject(new Error(g))}const T={contentIdentifier:g,subject:S||null,sessionState:m||null,sequenceNumber:1},I=defer2(),b=new nn(this.signalingSession,E||newGuid());return this.pendingSessionToStart=b,C?(this.logger.info("Call connected, send content sharing request out immediately"),b.start(v,T,I,_)):(this.logger.info("Content sharing is to be started when startOutgoingCall is called"),b.addSessionPromise=I,b.fsmState=Di.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED,this.contentSharingToStartCallWith=T),I.promise.then((()=>{this.contentSharingSessions.hasOwnProperty(b.correlationId)||(this.contentSharingSessions[b.correlationId]=b),this.pendingSessionToStart=null})).catch((()=>{this.pendingSessionToStart=null})),I.promise}joinContentSharingAsync(g,m){this.logger.info(`[${m}][joinContentSharingAsync]`);const S=defer2(),v=this.contentSharingSessions[g];return v?v.join(S,m):this.rejectBecauseOfMissingSession(g,S),S.promise}updateContentSharingSessionStateAsync(g,m,S){this.logger.info(`[${S}][updateContentSharingSessionStateAsync][sessionState=${JSON.stringify(m)}]`);const v=defer2(),C=this.contentSharingSessions[g];return C?C.updateSessionState(m,v,S):this.rejectBecauseOfMissingSession(g,v),v.promise}takeContentSharingControlAsync(g,m){this.logger.info(`[${m}][takeContentSharingControlAsync]`);const S=defer2(),v=this.contentSharingSessions[g];return v?v.takeControl(S,m):this.rejectBecauseOfMissingSession(g,S),S.promise}updateContentSharingParticipantStateAsync(g,m){this.logger.info(`[${m}][updateContentSharingParticipantStateAsync]`);const S=defer2(),v=this.contentSharingSessions[g];return v?v.updateParticipantState(S,m):this.rejectBecauseOfMissingSession(g,S),S.promise}updateContentSharingNotificationLinksAsync(g){this.logger.info(`[${g}][updateContentSharingNotificationLinksAsync]`);for(const m of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(m)){const S=this.contentSharingSessions[m];S&&S.updateNotificationLinks(g)}}getContentSharingInfoToStartSharing(){if(this.contentSharingToStartCallWith){const g=this.pendingSessionToStart,m=Di.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED;g&&g.fsmState===m||(this.contentSharingToStartCallWith=null,this.pendingSessionToStart=null)}return this.contentSharingToStartCallWith}dispose(g,m){this.logger.info(`[${m}][dispose]`);for(const S of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(S)){const v=this.contentSharingSessions[S];v&&v.dispose(g,m)}}handleContentSharingUpdate(g){const m=g.body,S=extractCauseIdFromMessage(g),v=this.contentSharingSessions[m.contentSharingCorrelationId];v?v.handleUpdate(m,S)&&this.signalingSessionCallback.onContentSharingUpdated({sessionId:m.sessionId,correlationId:m.contentSharingCorrelationId,contentIdentifier:m.identifier,presenter:m.presenter.id,subject:m.subject||null,sessionState:m.sessionState||null},S):this.logger.info(`[${S}][handleContentSharingUpdate][failed][reason=no session with correlation ID ${m.correlationId}]`)}handleAddModalitySuccess(g,m){this.logger.info(`[${m}][handleAddModalitySuccess]`);const S=this.pendingSessionToStart;S?S.handleAddModalitySuccess(g,m):this.logger.info(`[${m}][handleAddModalitySuccess]Ignoring handleAddModalitySuccess because not waiting for one`)}handleAddModalityFailure(g,m){this.logger.info(`[${m}][handleAddModalityFailure]`);const S=this.pendingSessionToStart;S?S.handleAddModalityFailure(g,m):this.logger.info(`[${m}][handleAddModalityFailure]Ignoring handleAddModalityFailure because not waiting for one`)}handleIncomingContentSharingFromRoster(g,m,S){if(this.logger.info(`[${S}] handleIncomingContentSharingFromRoster: isFullRoster ${m} content ${getPrintableObject(g)}`),("MultiPartyEndpoint"===g.type||m)&&this.lastProcessedSequenceNumber>g.sequenceNumber)return void this.logger.info(`[${S}] handleIncomingContentSharingFromRoster invalid roster current sequenceNumber ${g.sequenceNumber} lastProcessedSequenceNumber ${this.lastProcessedSequenceNumber}`);const{sessionsWithPresenters:v,sessionsWithoutPresenters:C}=this.parseContentSharingSessionsFromRoster(g);this.startSessionsFromRoster(v,S),this.stopSessionsFromRoster(C,S),this.lastProcessedSequenceNumber=g.sequenceNumber}handleContentSharingEnd(g){const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info("handleContentSharingEnd : ",getPrintableObject(m));const v=this.contentSharingSessions[m.contentSharingCorrelationId];if(!v)return void this.logger.info("Ignoring contentSharingEnd since there is no corresponding sharing ongoing");if(!v.handleStop(m,S))return;const C={...m.contentSharingTransactionEnd};this.raiseContentSharingStopped(m.contentSharingCorrelationId,S,m.presenter.id,C)}parseContentSharingSessionsFromRoster(g){const m={},S={},v=new Set;for(const S of Object.keys(g.participants)){const C=g.participants[S];if("Delta"===g.type&&this.lastProcessedSequenceNumberForParticipant.hasOwnProperty(S)&&C.version<=this.lastProcessedSequenceNumberForParticipant[S])continue;if(C.version=C.version||-1,this.lastProcessedSequenceNumberForParticipant[S]=C.version,v.add(C.details.id),!C.endpoints)continue;const _=this.signalingSession.participantManager.localParticipant.participantId;for(const g of Object.keys(C.endpoints)){const S=C.endpoints[g],v=S?.contentSharing?.sessionInformation;"presenter"===v?.role&&(m[v.contentSharingCorrelationId]={presenterId:C.details.id,sessionInfo:v,selfEndpointIsPresenter:S.participantId===_})}}for(const g of Object.keys(this.contentSharingSessions))!m[g]&&v.has(this.contentSharingSessions[g].presenterMri)&&(S[g]=this.contentSharingSessions[g]);return{sessionsWithPresenters:m,sessionsWithoutPresenters:S}}stopSessionsFromRoster(g,m){this.logger.info(`[${m}][stopSessionsFromRoster]`);for(const S of Object.keys(g))this.logger.info(`[${m}][stopSessionsFromRoster] stopping session with correlationId ${S}`),this.stopSession(g[S],m)}stopSession(g,m){this.logger.info(`[${m}][stopSession] Stopping session ${g.sessionId}`),g.handleStopFromRoster(this.DEFAULT_STOP_REASON,m),this.raiseContentSharingStopped(g.correlationId,m)}startSessionsFromRoster(g,m){this.logger.info(`[${m}][startSessionsFromRoster]`);for(const S of Object.keys(g)){this.logger.info(`[${m}][startSessionsFromRoster]`);const v=this.contentSharingSessions[S],C=g[S];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===S?this.pendingSessionToStart.confirmInRoster():v&&v.confirmInRoster(),v)v&&(this.contentSharingSessions[S].presenterMri=C.presenterId,this.logger.info(`[${m}][startSessionsFromRoster]Session ${S} is already present locally`));else{if(C.selfEndpointIsPresenter){this.logger.info(`[${m}][startSessionsFromRoster]This endpoint is presenting, dont fire callback`);continue}this.logger.info(`[${m}][startSessionsFromRoster]New sharing session found. Raising ContentSharingStarted`);this.raiseContentSharingStarted(C.presenterId,C.sessionInfo,m).handleStartFromRoster(C.presenterId,m)}}}raiseContentSharingStopped(g,m,S,v){this.logger.info(`[${m}][raiseContentSharingStopped]`),this.signalingSessionCallback.onContentSharingStopped({sessionId:this.contentSharingSessions[g].sessionId,correlationId:g,endedBy:S||this.DEFAULT_STOP_ID,reason:v||this.DEFAULT_STOP_REASON},m),delete this.contentSharingSessions[g]}raiseContentSharingStarted(g,m,S){this.logger.info(`[${S}][raiseContentSharingStarted]`);const v=new nn(this.signalingSession,m.contentSharingCorrelationId,m.contentSharingSessionId,{[Di.LINKS.CONTENT_SHARING_CONTROLLER]:m.contentSharingController});v.presenterMri=g,this.contentSharingSessions[v.correlationId]=v;const C={sessionId:m.contentSharingSessionId,correlationId:m.contentSharingCorrelationId,contentIdentifier:m.identifier,presenter:g,subject:m.subject||null,sessionState:m.sessionState||null};return this.signalingSessionCallback.onContentSharingStarted(C,S),v}rejectBecauseOfMissingSession(g,m){const S=`There is no ContentSharing session with the correlation ID ${g}`;this.logger.error(S),m&&m.reject(new Error(S))}},sn={Default:{retryIntervalsMs:[200,1e3,5e3],maxRequestAttempts:4,perRequestTimeoutMs:45e3,perAttemptTimeoutMs:15e3,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4,hedgeDelayMs:4e3},BrokerSubscribe:{retryIntervalsMs:[100,200,500],maxRequestAttempts:4,perRequestTimeoutMs:3e4,perAttemptTimeoutMs:3e4,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4}},an={CallSetup:{requestHedgingCapability:["disabled"],hedgeDelayMs:4e3},Other:{requestHedgingCapability:["disabled"]},BrokerSubscribe:{requestHedgingCapability:["disabled"]}},on="HttpRequestDispatcherFactory";function reportTokenTelemetryData(g,m,S){m?.signalingSession?m.signalingSession.telemetryHelper?.addTokenTelemetry(g,m?.tokenTelemetryData):S?.info("[reportTokenTelemetryData] signaling session is not available, cannot send token telemetry")}function get2(g,m){const{signalingSession:S,operation:v,causeId:C,data:_,customHeaders:E={},forceFetchToken:T,tokenRequestOptions:I}=g;if(S.disposed)return Promise.reject("Session already disposed");const handleFailure=g=>{const m="string"==typeof g?new Error(g):g;throw S.signalingAgent.clientSupportsGenericTokenAPI?g.timeOut?m.tokenTimeoutError=!0:m.tokenError=!0:m.skypeTokenError=!0,m};let b=!1;const A={signalingSession:S,tokenTelemetryData:{}};return S.signalingAgent.authTokenManager.getToken(C,T,I,A).catch((v=>(reportTokenTelemetryData(g.requestId,A,m),!T&&isAppOnline(S)&&S.signalingAgentConfig.attemptHttpRequestWithCachedSkypetoken&&S.signalingAgent.authTokenManager.getLastToken(C)?(b=!0,Promise.resolve(S.signalingAgent.authTokenManager.getLastToken(C))):(m?.info(`[${C}] getToken failed with error ${v}`),handleFailure(v))))).then((T=>{if(S.disposed)throw new Error("token returned too late. Object is already disposed");reportTokenTelemetryData(g.requestId,A,m);const I=new Ni;if(I.set(Di.HEADERS.CORRELATION_ID,S.correlationId),I.set(Di.HEADERS.MESSAGE_ID,newMessageId(C)),I.set(Di.HEADERS.CLIENT_USER_AGENT,S.signalingAgentConfig.clientInformation),S.signalingAgent.clientSupportsGenericTokenAPI){const g=S.signalingAgent.authTokenManager.getLastTokenType(C);switch(S.signalingAgentConfig.disableTokenMigrationHeader||I.set(Di.HEADERS.TOKEN_MIGRATION,"True"),g){case 8:case 4:I.set(Di.HEADERS.AUTHORIZATION,`${Di.HEADERS.BEARER_KEYWORD} ${T}`),I.delete(Di.HEADERS.SKYPE_TOKEN);break;case 1:I.set(Di.HEADERS.SKYPE_TOKEN,T),I.delete(Di.HEADERS.AUTHORIZATION);break;default:throw new Error(`Error in RequestBuilder. TokenType ${g} is not supported`)}}else I.set(Di.HEADERS.SKYPE_TOKEN,T);const R=S.participantManager.localParticipant;R&&(R.ring&&I.set(Di.HEADERS.RING,R.ring),R.region&&I.set(Di.HEADERS.REGION,R.region),R.partition&&I.set(Di.HEADERS.PARTITION,R.partition));const P=_?.payload?JSON.stringify(_.payload):null,M={headers:{...I?.getAll(),...E},payload:P,usedCachedSkypetoken:b,reporting:{serviceName:v?`${on}-${v}`:on}};return S.telemetryHelper.addNetworkOperationStarted(v),M})).catch(handleFailure)}function isAppOnline(g){const m=isTrouterAndNavigatorConnected(g.signalingAgentConfig.trouterServiceProvider);return 3===m||1===m}var ln=500,cn=1e4,dn=4,hn=3e3,un=3;function build4(g){return new gn(g.causeId,g.logger,g.dispatcher,g.requestType,g.url,g.request,g.attemptFailureCallback,g.authRequiredCallback,g.settings)}var gn=class{constructor(g,m,S,v,C,_,E,T,I){this.causeId=g,this.logger=m,this.dispatcher=S,this.requestType=v,this.url=C,this.request=_,this.onRequestFailed=E,this.authRequiredCallback=T,this.settings=I,this.requestsSent=0,this.otherAttemptSuccessful=!1,this.pendingAttempts=[],this.hedgeDelayMs=hn,this.hedgeMaxParallelAttempts=un,this.stopStandardRetryTimer=()=>{this.standardRetryTimer&&(this.standardRetryTimer.stop(),this.standardRetryTimer=null)},this.stopHedgeTimer=()=>{this.hedgeTimer&&(this.hedgeTimer.stop(),this.hedgeTimer=null)},this.stopAttemptTimeoutTimer=g=>{try{g.timeoutTimer&&(g.timeoutTimer.stop(),this.logger.info("attempt timer stopped"))}catch(g){this.logger.info(`stopAttemptTimeoutTimer error ${g}`)}},this.stopRequestTimer=()=>{try{this.requestTimer&&(this.requestTimer.stop(),this.logger.info("Request timer stopped"))}catch(g){this.logger.info(`stopRequestTimer error ${g}`)}this.requestTimer=null},this.canScheduleNextAttempt=()=>{if(this.stackError===Di.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful||this.requestsSent>=this.settings.maxRequestAttempts)return this.logger.info(`canScheduleNextAttempt stack error ${this.stackError} otherAttemptSuccessful ${this.otherAttemptSuccessful} exceeded max attempt ${this.requestsSent>=this.settings.maxRequestAttempts}`),!1;if(this.settings.enableRequestHedging){const g=this.pendingAttempts.length<this.hedgeMaxParallelAttempts;return g||this.logger.info(`canScheduleNextAttempt enableRequestHedging attempts sent: ${this.pendingAttempts.length} max attempts: ${this.hedgeMaxParallelAttempts}`),g}{const g=this.requestsSent<this.settings.retryIntervalsMs.length;return g||this.logger.info(`canScheduleNextAttempt attempts sent: ${this.requestsSent} max attempts: ${this.settings.retryIntervalsMs.length}`),g}},this.scheduleNextRequest=g=>{this.settings.enableRequestHedging?(this.logger.info("scheduleNextRequest with hedging"),this.hedgeTimer=Wi.build((()=>{this.attempt(),this.canScheduleNextAttempt()&&this.scheduleNextRequest(!1)}),"HEDGE").start(this.getNextDelay(g))):(this.logger.info("scheduleNextRequest with retry"),this.standardRetryTimer=Wi.build((()=>{this.attempt()}),"RETRY").start(this.getNextDelay(g)))},this.standardizeFailedRequest=(g,m)=>{let S;const v=this.logger.createChild("[standardizeFailedRequest]");try{if(this.stackError===Di.HTTP_STACK_ERROR.REQUEST_TIMEOUT)v.info("request timed out"),S=Ai.REQUEST_TIMEOUT;else if(this.stackError===Di.HTTP_STACK_ERROR.REQUEST_ABORTED)v.info("request aborted"),S=Ai.REQUEST_ABORTED;else if(m&&m.status===Di.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT)v.info("request attempt timed out"),S=Ai.ATTEMPT_TIMEOUT;else if(m&&[Di.HTTP_STACK_ERROR.ATTEMPT_ABORTED,Di.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL].indexOf(m.status)>-1)v.info("request attempt aborted"),S=Ai.ATTEMPT_ABORTED;else if(g){if(v.info(`request ${safeJsonStringify(g)}`),"function"==typeof XMLHttpRequest&&g instanceof XMLHttpRequest)S=g;else if("function"==typeof XMLHttpRequest&&g&&g.request instanceof XMLHttpRequest){const m=g;S={response:{...m?.request?.response,headers:m.response?.headers},status:m.request.status,statusText:m.request.statusText,readyState:m.request.readyState}}else g.status||g.statusCode||g.response?S={response:g.response,status:[void 0,null,""].indexOf(g.status)>-1?g.statusCode:g.status,statusText:g.statusText,readyState:g.readyState}:(v.info("Local http stack error"),S={response:Di.CALL_END_SUB_CODE.LOCAL_HTTP_STACK_ERROR,status:Di.CALL_END_CODE.LOCAL_HTTP_STACK_ERROR,statusText:"LocalHTTPStackError",readyState:g.readyState||0});this.isBrowserOffline()&&0===S.status&&4===S.readyState&&(v.info("offline"),S={response:Di.HTTP_STACK_ERROR.CANNOT_CONNECT,status:Di.HTTP_STATUS_CODES.OFFLINE,statusText:"offline",readyState:S.readyState}),g.response?.message&&(g.response.message.operationFailure||g.response.message.broadcastOperationFailure)?S={response:g.response.message}:!g.response&&g.body?.operationFailure&&(S={response:g.body})}else v.info("no response"),S={response:Di.HTTP_STACK_ERROR.NONE,status:Di.HTTP_STATUS_CODES.OTHER,statusText:"Empty Response",readyState:0}}catch(g){v.info(`Failed to handle error ${g}`),S={response:"",status:Di.HTTP_STATUS_CODES.OTHER,statusText:"FailedToHandleError",readyState:0}}return S},this.hasPendingAttempts=()=>this.pendingAttempts.some((g=>g.pending)),this.getRequestFromStatus=g=>g&&g.request&&g.request.status||0,this.isBrowserOffline=()=>navigator&&!1===navigator.onLine,this.logger=m.createChild(`[${this.causeId}][Dispatcher]`),this.logger.info(`created request, url=${C}`),!isNaN(this.settings.hedgeDelayMs)&&this.settings.hedgeDelayMs>=ln&&this.settings.hedgeDelayMs<=cn&&(this.hedgeDelayMs=this.settings.hedgeDelayMs),!isNaN(this.settings.hedgeMaxParallelAttempts)&&this.settings.hedgeMaxParallelAttempts>=0&&this.settings.hedgeMaxParallelAttempts<=dn&&(this.hedgeMaxParallelAttempts=this.settings.hedgeMaxParallelAttempts),(isNaN(this.settings.perAttemptTimeoutMs)||this.settings.perAttemptTimeoutMs<=0)&&(this.settings.perAttemptTimeoutMs=15e3),(isNaN(this.settings.perRequestTimeoutMs)||this.settings.perRequestTimeoutMs<=0)&&(this.settings.perRequestTimeoutMs=45e3),(isNaN(this.settings.maxRequestAttempts)||this.settings.maxRequestAttempts<=0)&&(this.settings.maxRequestAttempts=4),(isNaN(this.settings.perRequestTimeoutWithHedgingMs)||this.settings.perRequestTimeoutWithHedgingMs<=0)&&(this.settings.perRequestTimeoutWithHedgingMs=45e3),(isNaN(this.settings.perAttemptTimeoutWithHedgingMs)||this.settings.perAttemptTimeoutWithHedgingMs<=0)&&(this.settings.perAttemptTimeoutWithHedgingMs=3e4)}sendRequest(){this.stackError=Di.HTTP_STACK_ERROR.NONE;const timeoutCallback=()=>{this.stackError=Di.HTTP_STACK_ERROR.REQUEST_TIMEOUT,this.cancelAllAttempts(Di.HTTP_STACK_ERROR.REQUEST_TIMEOUT)};return this.logger.info("send api called"),this.requestTimer=Wi.build(timeoutCallback,"REQUEST_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perRequestTimeoutWithHedgingMs:this.settings.perRequestTimeoutMs),new Promise(((g,m)=>{this.resolve=g,this.reject=m,this.scheduleNextRequest(!0)}))}cancelRequest(){this.logger.info("cancelRequest"),this.stackError=Di.HTTP_STACK_ERROR.REQUEST_ABORTED,this.cancelAllAttempts(Di.HTTP_STACK_ERROR.ATTEMPT_ABORTED)}cancelOtherAttempts(g){this.pendingAttempts.splice(g-1,1),this.cancelAllAttempts(Di.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL)}cancelAllAttempts(g){this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.pendingAttempts.forEach((m=>{m.status=g,m.cancelDeferred.resolve(),this.stopAttemptTimeoutTimer(m)})),this.stopRequestTimer()}getRequestMethod(g){switch(g){case 0:return this.dispatcher.getAsync.bind(this.dispatcher);case 1:return this.dispatcher.postAsync.bind(this.dispatcher);case 2:return this.dispatcher.putAsync.bind(this.dispatcher);case 3:return this.dispatcher.removeAsync.bind(this.dispatcher);default:return null}}async queueAttempt(g){const m=g&&this.isNotRetryable(g);if(this.logger.info("queueAttempt"),m||!this.canScheduleNextAttempt())return this.logger.info(`unable to retry isNotRetryable ${m} ${JSON.stringify(g)}`),this.stopHedgeTimer(),this.stopRequestTimer(),void(this.hasPendingAttempts()||(this.settings.reportPreviousErrorsForTimeout&&g===Ai.ATTEMPT_TIMEOUT&&this.previousAttempt?this.reject(this.previousAttempt):this.reject(g)));if(this.isAuthFailedStatus(g)){this.logger.info("auth failed"),this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.stopRequestTimer();try{const m=g?.response?.headers,S=getRequestToken(this.request?.headers),v=await this.authRequiredCallback(m,S);this.request=v}catch(m){return void this.reject(g)}}this.previousAttempt=g,this.hedgeTimer?this.logger.info("scheduleNextRequest ignored as there's already active hedge timer"):this.scheduleNextRequest(!1)}attempt(){if(this.logger.info("attempt to send request"),this.stackError===Di.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful)return;const g=(new Date).getTime();this.requestsSent++;const m=this.requestsSent,S=defer2();this.request.timeout=S.promise;const v={cancelDeferred:S,status:Di.HTTP_STACK_ERROR.NONE,timeoutTimer:null,pending:!0},timeoutRequest=()=>{v.status=Di.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT,v.cancelDeferred.resolve()},C=Wi.build(timeoutRequest,"ATTEMPT_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perAttemptTimeoutWithHedgingMs:this.settings.perAttemptTimeoutMs);v.timeoutTimer=C,this.pendingAttempts.push(v);this.getRequestMethod(this.requestType)(this.url,this.request).then((S=>{if(this.logger.info(`attempt successful, request response=${Gi.scrubDisplayNamesFromResponse(S)} status=${this.getRequestFromStatus(S)}`),this.otherAttemptSuccessful)throw"Other attempt succesful";if(this.stackError===Di.HTTP_STACK_ERROR.REQUEST_ABORTED)throw"Session disposed";if(!S)throw"Invalid response";v.pending=!1,this.otherAttemptSuccessful=!0,this.stopRequestTimer(),this.stopHedgeTimer(),this.stopAttemptTimeoutTimer(v),this.cancelOtherAttempts(m),this.resolve({success:!0,request:S.request,response:S.response,attempt:this.requestsSent,attemptStartTimestamp:g,attemptResponseTimestamp:(new Date).getTime()})})).catch((m=>{v.pending=!1,this.stopAttemptTimeoutTimer(v);const S=this.standardizeFailedRequest(m,v);this.logger.info(`attempt failed, request: ${safeJsonStringify(m)} status=${S.status}`),this.onRequestFailed({abandoned:this.otherAttemptSuccessful,success:!1,request:S,attempt:this.requestsSent,attemptStartTimestamp:g,attemptResponseTimestamp:(new Date).getTime()}),this.queueAttempt(S)}))}getNextDelay(g){let m;if(g)m=0;else if(this.settings.enableRequestHedging)m=this.hedgeDelayMs;else{if(!(this.requestsSent<=this.settings.retryIntervalsMs.length))throw"Unable to get next delay";m=this.settings.retryIntervalsMs[this.requestsSent-1]}return this.logger.info(`next delay= ${m} ms`),m}isRequestWithStatus(g,m){return!!g&&m.indexOf(g.status)>-1}isNotRetryable(g){return!isRetryable(g&&g.status)}isAuthFailedStatus(g){return this.isRequestWithStatus(g,[Di.HTTP_STATUS_CODES.UNAUTHORIZED])}},pn={1:"POST",0:"GET",2:"PUT",3:"DELETE"},mn=class{constructor(g,m){this.signalingSession=g,this.callStartTime=m,this.pendingRequests={},this.sendGetRequest=g=>this.sendRequest(0,g),this.sendPostRequest=g=>this.sendRequest(1,g),this.sendPutRequest=g=>this.sendRequest(2,g),this.sendDeleteRequest=g=>this.sendRequest(3,g),this.cancelRequestIfPending=(g,m,S,v)=>{this.logger.info(`[${m}][cancelRequestIfPending]`),this.pendingRequests[g]?S?this.hasPendingRequest(g,S)&&this.cancelRequest(g,S,m,v):Object.keys(this.pendingRequests[g]).forEach((S=>this.cancelRequest(g,S,m,v))):this.logger.info(`[${m}][cancelRequestIfPending]no pending request with name=${g}`)},this.cancelAllRequests=g=>{this.logger.info(`[${g}][cancelAllRequests]`);const m=[];return Object.keys(this.pendingRequests).forEach((S=>{Object.keys(this.pendingRequests[S]).forEach((v=>{m.push(this.cancelRequest(S,v,g))}))})),Promise.all(m).catch((()=>{}))},this.hasPendingRequest=(g,m)=>!!this.pendingRequests[g]&&Boolean(m?this.pendingRequests[g][m]:this.pendingRequests[g]),this.cancelRequest=(g,m,S,v)=>{try{return this.pendingRequests[g][m].dispatcher&&this.pendingRequests[g][m].dispatcher.cancelRequest(),this.pendingRequests[g][m].aborted=!0,this.pendingRequests[g][m].errorDetails=v,this.logger.info(`[${S}][cancelRequest]Request=${g} aborted ${v?`with errorDetails ${JSON.stringify(v)}`:""}`),this.pendingRequests[g][m].requestPromise.catch((()=>{}))}catch(v){return this.logger.warn(`[${S}][cancelRequest]Unable to cancel request=${g}, requestId=${m}`),Promise.resolve()}},this.buildRequestTelemetry=(g,m,S,v)=>({name:`${pn[g]}-${m.requestName}`,url:m.url,eventStart:S-this.callStartTime,trouterReady:-1,requestReady:-1,status:-1,attempts:[],rtt:-1,uid:m.requestId,causeId:m.causeId,requestDispatcherConfig:v,enableRequestHedging:this.shouldEnableRequestHedging(v)}),this.addPendingRequest=g=>(this.pendingRequests[g.requestName]||(this.pendingRequests[g.requestName]={}),this.pendingRequests[g.requestName][g.requestId]={dispatcher:null,requestPromise:null,aborted:!1},this.pendingRequests[g.requestName][g.requestId]),this.sendRequest=(g,m)=>{if(!m.url){this.logger.error(m.requestName,"Link does not exist");const g={code:Di.CALL_END_CODE.HTTP_OTHER_ERROR,subCode:Di.CALL_END_SUB_CODE.MISSING_REQUEST_URI,phrase:`Link does not exist for requestName: ${m.requestName}.`};return Promise.reject(g)}m.requestId||(m.requestId=newGuid()),m.causeId||(m.causeId=causeId2());const S=this.logger.createChild(`[${m.causeId}][${m.requestName}]`);S.info("[scheduled]");const v=this.getInternalHttpDispatcherConfig(m.requestName,m.operationType);let C;m.skipHttpTelemetry||(m.skipHttpTelemetry=!1);const _=build3(),E=(new Date).getTime(),T=[],I=this.buildRequestTelemetry(g,m,E,v),updateRequestTelemetry=()=>{this.signalingSession.disposed?this.logger.info("Unable to record telemetry, session disposed"):this.signalingSession.telemetryHelper.updateNetworkRequest(I)},deleteRequestTelemetry=()=>{this.signalingSession.telemetryHelper.deleteNetworkRequest(I)};updateRequestTelemetry();const logRequestAttempt=(g,v)=>{if(!g?.request)return void this.logger.warn(m.requestName,"missing request details, unable to record for telemetry!");S.info(`[finished][status=${g.request.status}][statusText=${g.request.statusText}][retryCount=${g.attempt}]`);const C={status:g.request.status,statusSubCode:g.request.response?.operationFailure?.subCode,start:g.attemptStartTimestamp-E,end:g.attemptResponseTimestamp-E,online:isTrouterAndNavigatorConnected(this.signalingSession.signalingAgentConfig.trouterServiceProvider)};g.abandoned&&(C.abandoned=!0),g.request.statusText&&(C.statusText=g.request.statusText),(v||-1===I.status)&&(I.status=g.request.status),I.attempts.push(C),updateRequestTelemetry()};if(this.hasPendingRequest(m.requestName,m.requestId))return this.logger.warn(m.requestName,m.requestId,"is already pending request!!"),this.pendingRequests[m.requestName][m.requestId].requestPromise;C=this.addPendingRequest(m);const recordTelemetryAndCleanup=(g,v,C,E)=>{if(g&&m.skipHttpTelemetry)return this.logger.info("Skipping telemetry"),void deleteRequestTelemetry();S.info(`[steps=${T}]`),this.pendingRequests[m.requestName][m.requestId].aborted&&(I.aborted=!0),this.hasPendingRequest(m.requestName,m.requestId)?(delete this.pendingRequests[v][C],Object.keys(this.pendingRequests[v]).length||delete this.pendingRequests[v]):this.logger.warn("Unable to clean up!"),this.signalingSession.disposed||(E&&(I.error=E),I.rtt=_.duration(),this.signalingSession.telemetryHelper.addNetworkOperationCompleted(m.requestName,g,_.duration()),updateRequestTelemetry(),this.signalingSession.telemetryHelper.sendHttpTelemetryData(I.uid))},checkIfNotDisposed=g=>(...v)=>{if(this.signalingSession.disposed){const g=`[${m.causeId}][${m.requestName}][failed][reason=Session disposed]`;throw S.info("[failed][reason=Session disposed]"),new Error(g)}if(this.hasPendingRequest(m.requestName,m.requestId)&&this.pendingRequests[m.requestName][m.requestId].aborted){let g;const v=`[${m.causeId}][${m.requestName}][failed][reason=request already aborted]`,C=this.pendingRequests[m.requestName][m.requestId].errorDetails;throw C?(g=C,g.phrase=v):g=v,S.info(`${v}`),new Error(JSON.stringify(g))}return g(...v)},b=checkIfNotDisposed((()=>(T.push("[waitForTrouter]"),m.withoutTrouter?Promise.resolve():this.signalingSession.ensureMessageChannelReady(m.requestName)))),A=checkIfNotDisposed((()=>(T.push("[trouterReady]"),I.trouterReady=_.duration(),m.onceTrouterReady&&m.onceTrouterReady(),updateRequestTelemetry(),Promise.resolve()))),R=checkIfNotDisposed((()=>{const S=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,v=getTokenMetadata(this.signalingSession.signalingAgentConfig,S,g,m,!1,void 0,this.logger);return T.push("[buildRequest]"),get2({signalingSession:this.signalingSession,operation:m.requestName,data:m.payload,customHeaders:m.customHeaders?.getAll(),causeId:m.causeId,tokenRequestOptions:v,requestId:m.requestId},this.logger)})),P=checkIfNotDisposed((g=>{T.push("[failedToBuildRequestOptions]");const m={request:{status:Di.HTTP_STATUS_CODES.OTHER,statusText:"Local error"},attempt:1,success:!1,attemptResponseTimestamp:(new Date).getTime(),attemptStartTimestamp:(new Date).getTime()};return g&&(g.skypeTokenError?m.request={status:Di.CALL_END_SKYPE_TOKEN_ERROR.code,statusText:Di.CALL_END_SKYPE_TOKEN_ERROR.phrase}:g.tokenError?m.request={status:Di.CALL_END_TOKEN_ERROR.code,statusText:Di.CALL_END_TOKEN_ERROR.phrase}:g.tokenTimeoutError&&(m.request={status:Di.CALL_END_TOKEN_TIMEOUT_ERROR.code,statusText:Di.CALL_END_TOKEN_TIMEOUT_ERROR.phrase})),logRequestAttempt(m,!1),Promise.reject(g)})),M=checkIfNotDisposed((g=>(T.push("[requestBuilt]"),I.requestReady=_.duration(),g.usedCachedSkypetoken&&(I.usedCachedSkypetoken=g.usedCachedSkypetoken),updateRequestTelemetry(),Promise.resolve(g)))),authRequiredCallback=(S,v)=>{T.push("[authRequired]");const C=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,_=getTokenMetadata(this.signalingSession.signalingAgentConfig,C,g,m,!0,S,this.logger);return _.invalidToken=v,get2({signalingSession:this.signalingSession,operation:m.requestName,data:m.payload,customHeaders:m.customHeaders?.getAll(),causeId:m.causeId,forceFetchToken:!0,tokenRequestOptions:_,requestId:m.requestId},this.logger)},w=checkIfNotDisposed((S=>{T.push("[sendRequest]");const _={...v,enableRequestHedging:this.shouldEnableRequestHedging(v),hedgeDelayMs:v.hedgeDelayMs,hedgeMaxParallelAttempts:this.signalingSession.signalingAgentConfig.hedgeMaxParallelAttempts,retryIntervalsMs:m.disableRetry||!v.retryIntervalsMs?[]:v.retryIntervalsMs,reportPreviousErrorsForTimeout:this.signalingSession.signalingAgentConfig.reportPreviousErrorsForTimeout},E=build4({logger:this.logger,causeId:m.causeId,dispatcher:this.signalingSession.signalingAgentConfig.httpRequestDispatcher,url:m.url,request:S,requestType:g,authRequiredCallback:authRequiredCallback,attemptFailureCallback:g=>{logRequestAttempt(g,!1)},settings:_});return C.dispatcher=E,updateRequestTelemetry(),E.sendRequest()})),D=checkIfNotDisposed((async g=>(logRequestAttempt(g,!0),S.info("[success]"),recordTelemetryAndCleanup(!0,m.requestName,m.requestId),g))),onFailure=g=>{const v=getPrintableObject(g);return recordTelemetryAndCleanup(!1,m.requestName,m.requestId,v),!g||g.readyState||g.status?S.info(`[failed][reason=${v}]`):S.info(`[failed][offline][reason=${v}]`),Promise.reject(g)},O=Promise.resolve().then(b).then(A).then(R).catch(P).then(M).then(w).then(D).catch(onFailure);return C.requestPromise=O,O},this.logger=this.signalingSession.logger.createChild("[HTTP]")}getInternalHttpDispatcherConfig(g,m="Other"){let S={...sn.Default,...an[m],...sn[g]};return this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap&&(S={...S,...this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap[m]}),this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap&&(S={...S,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap.Default,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap[g]}),this.logger.info(`getInternalHttpDispatcherConfig request type: ${g} config: ${safeJsonStringify(S)}`),S}shouldEnableRequestHedging(g){return!!(this.signalingSession.getMeetingInfo()&&g.requestHedgingCapability.indexOf("enabledForMeetings")>-1)||(!this.signalingSession.multiParty&&g.requestHedgingCapability.indexOf("enabledForP2PCalls")>-1||(!!(this.signalingSession.multiParty&&g.requestHedgingCapability.indexOf("enabledForGroupCalls")>-1)||g.requestHedgingCapability.indexOf("enabled")>-1))}};function getPayload8(g,m,S){assertNotNull(g,"signalingSession cannot be null");let v=[];S&&(v=getMediaTypes(S),g.telemetryHelper.addOutgoingModalities(v));const C=causeId2();return{payload:{mediaNegotiation:{callModalities:v,sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},links:{mediaAnswer:get(g,Mi.MEDIA_ANSWER,C),rejection:get(g,Mi.MEDIA_REJECTION,C)},mediaContent:m}}}}function getPayload9(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{mediaNegotiationFailure:{sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},code:m.code,subCode:m.subCode,phrase:m.phrase},debugContent:{callId:g.correlationId,endpointId:g.participantManager.localParticipant.endpointId}}}}function getPayload10(g,m,S){assertNotNull(g,"signalingSession cannot be null");let v=[];return S&&(v=getMediaTypes(S),g.telemetryHelper.addOutgoingModalities(v)),{payload:{mediaAnswer:{callModalities:v,sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},links:{mediaAcknowledgement:get(g,Mi.MEDIA_ACKNOWLEDGEMENT)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),mediaContent:m},debugContent:{callId:g.correlationId,endpointId:g.participantManager.localParticipant.endpointId}}}}var fn=class{constructor(g,m,S){this.telemetryHelper=S,this.vbssInitiated=!1,this.disposed=!1,this.fsmState=Di.MEDIA_RENEGOTIATION_FSM_STATE.IDLE,this.fsmStateCauseId="",this.links={},this.renegotiationOffersSeenSoFar=[],this.isOutgoingRenegotiationInProgress=()=>this.fsmState===Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION||this.fsmState===Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.isIncomingRenegotiationInProgress=()=>this.fsmState===Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION||this.fsmState===Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.acceptRenegotiationAsync=(g,m,S)=>{this.logger.info(`[${S}][acceptRenegotiationAsync][mediaTypes=${m}]`),this.signalingSession.telemetryHelper.recordEvent(Li.ACCEPT_RENEGOTIATION,{mediaTypes:m,causeId:S}),assertNotNullOrEmpty(this.links[Di.LINKS.MEDIA_ANSWER],"MediaAnswer link not set");const v=defer2();switch(this.fsmState){case Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,S);break;case Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,S);break;default:return this.logger.info(`[${S}][acceptRenegotiationAsync]there is no incoming media renegotiation offer to accept`),v.reject(new Error("there is no incoming media renegotiation offer to accept")),v.promise}const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT,this.handleMediaAnswerAcknowledgmentTimeout.bind(this,S),Di.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT)};return this.signalingSession.http.sendPostRequest({url:this.links[Di.LINKS.MEDIA_ANSWER],payload:getPayload10(this.signalingSession,g,m),requestName:Fi.SEND_MEDIA_ANSWER.name,onceTrouterReady:onceTrouterReady,causeId:S}).then((g=>{v.resolve(g.response)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][acceptRenegotiationAsync] error: ${getPrintableObject(m)}`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),v.reject(new Error(`acceptRenegotiationAsync failed because : ${getPrintableObject(g)}`))})),v.promise},this.startRenegotiationAsync=(g,m,S,v)=>{this.logger.info(`[${v}][startRenegotiationAsync][mediaTypes=${S}]`),this.signalingSession.telemetryHelper.recordEvent(Li.START_RENEGOTIATION,{causeId:v,mediaTypes:S}),assertNotNullOrEmpty(m,"MediaRenegotiation link not set");const C=defer2();switch(this.fsmState){case Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,v);break;case Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:case Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:case Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.logger.info(`[${v}][startRenegotiationAsync][failed] can only be performed with no current outstanding renegotiations, previous negotiation causeId=${this.fsmStateCauseId}`),this.signalingSessionCallback.onMediaRenegotiationRejection(this.getGlareError(),v),Promise.resolve(null);default:return this.logger.info(`[${v}][startRenegotiationAsync][failed] can only be performed on an established call`),C.reject(new Error("media renegotiation can only be performed on an established call")),C.promise}const _=S&&arrayContains(S,Di.MEDIA_TYPES.SCREEN_SHARER);_?(this.vbssInitiated=!0,this.signalingSession.telemetryHelper.addVbssOperations(xi.VBSS_OPERATION.START)):!_&&this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(xi.VBSS_OPERATION.STOP));const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER,this.handleMediaAnswerTimeout.bind(this),Di.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_TIMEOUT)};return this.signalingSession.http.sendPostRequest({url:m,payload:getPayload8(this.signalingSession,g,S),requestName:Fi.START_RENEGOTIATION.name,onceTrouterReady:onceTrouterReady,causeId:v}).then((g=>{C.resolve(g.response)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${v}][startRenegotiationAsync] error: ${getPrintableObject(m)}`),!this.disposed){switch(this.fsmState){case Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,v);break;case Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,v)}this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER)}C.reject(new Error(`startRenegotiationAsync failed because : ${getPrintableObject(g)}`))})),C.promise},this.handleMediaAcknowledgment=(g,m)=>{this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_MEDIA_ACKNOWLEDGEMENT,{causeId:m}),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),this.signalingSession.saveMediaControllerLinksIfAny(g),this.signalingSession.saveUpdatedCallLinksIfAny(g),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!0,m)},this.onCallConnected=g=>{this.logger.info("onCallConnected"),this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,g)},this.handleMediaNegotiationFailure=g=>{const m=extractCauseIdFromMessage(g);this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_MEDIA_NEGOTIATION_FAILURE,g),this.handleMediaNegotiationFailureInternal(g.body.mediaNegotiationFailure,g.origin,m)},this.handleMediaAnswer=(g,m)=>{switch(this.logger.info(`[${m}][handleMediaAnswer]`),this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_MEDIA_ANSWER,{causeId:m}),this.fsmState){case Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,m);break;case Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,m);break;default:return}this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER);let S=[];g.mediaAnswer.callModalities&&g.mediaAnswer.callModalities.length>0&&(S=getMediaTypes(g.mediaAnswer.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(S));const v={provisional:!1,renegotiation:!0,mediaTypes:S,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(g.mediaAnswer.mediaContent),mediaContent:g.mediaAnswer.mediaContent};this.signalingSession.http.sendPostRequest({url:g.mediaAnswer.links.mediaAcknowledgement,payload:null,requestName:Fi.SEND_MEDIA_ACKNOWLEDGEMENT.name,causeId:m}).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${m}][handleMediaAnswer] error: ${getPrintableObject(S)}`),this.signalingSession.disposed||this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_MEDIA_ANSWER_FAILED,{causeId:m})})),this.signalingSessionCallback.onAnswer(v,m)},this.handleMediaNegotiationOffer=g=>{const m=g.body,S=g.headers,v=extractCauseIdFromMessage(g);this.logger.info(`[${v}][handleMediaNegotiationOffer]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_MEDIA_OFFER,g);const C=isDuplicateMessage(S,this.renegotiationOffersSeenSoFar);switch(this.fsmState){case Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,v),this.raiseMediaRenegotiationOffer(m,v);break;case Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,v),this.raiseMediaRenegotiationOffer(m,v);break;case Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:if(this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.supportMediaRetargetWhileIncomingRenegotiation){this.raiseMediaRenegotiationOffer(m,v);break}this.rejectAndLog(v,C,m);break;default:this.rejectAndLog(v,C,m)}},this.rejectRenegotiationAsync=(g,m)=>{this.logger.info(`[${m}][rejectRenegotiationAsync]`),this.signalingSession.telemetryHelper.recordEvent(Li.REJECT_RENEGOTIATION,{rejectionData:g,causeId:m}),assertNotNullOrEmpty(this.links[Di.LINKS.MEDIA_REJECTION],"MediaRejection link not set");const S=g||{code:Di.CALL_END_CODE.NOT_ACCEPTABLE_HERE,subCode:Di.CALL_END_SUB_CODE.MEDIA_ANSWER_PROCESSING_ERROR,phrase:Di.CALL_END_PHRASE.MEDIA_ANSWER_ERROR};switch(this.fsmState){case Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:return this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,m),this.rejectMediaRenegotiation(this.links[Di.LINKS.MEDIA_REJECTION],S,m);case Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,m),this.rejectMediaRenegotiation(this.links[Di.LINKS.MEDIA_REJECTION],S,m);default:return this.logger.error(`[${m}][rejectRenegotiationAsync][failed] There is no incoming media renegotiation offer to reject`),Promise.resolve(null)}},this.handleRetargetCompleted=g=>{const m=g.body.retargetCompleted,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleRetargetCompleted][details=${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_RETARGET_COMPLETED,g,getPIISafeObject(m)),0===m.code?this.signalingSessionCallback.onReTargetCompletedSuccess(S):this.signalingSessionCallback.onReTargetCompletedFailure(m,S)},this.dispose=()=>{this.logger.info("mediaRenegotiationManager :: dispose"),this.disposed=!0},this.getGlareError=()=>({code:Di.CALL_END_CODE.GLARE_ERROR,subCode:Di.CALL_END_SUB_CODE.MEDIA_GLARE_ERROR,phrase:Di.CALL_END_PHRASE.RENEGOTIATION_IN_PROGRESS,previousNegotiationCauseId:this.fsmStateCauseId}),this.handleMediaNegotiationFailureInternal=(g,m,S)=>{switch(this.logger.info(`[${S}][handleMediaNegotiationFailureInternal][failureData=${getPIISafeObject(g)}]`),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.fsmState){case Di.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,S);break;case Di.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Di.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,S);break;default:return}this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(xi.VBSS_OPERATION.REJECTED)),this.signalingSession.telemetryHelper.addIncomingModalities(["Rejected"]),this.signalingSessionCallback.onMediaRenegotiationRejection({code:g.code,subCode:g.subCode,phrase:g.phrase},S)},this.signalingSession=g,this.signalingSessionCallback=m,this.logger=g.logger.createChild((()=>`[RenegotiationManager][${this.fsmState}][stateCauseId=${this.fsmStateCauseId}]`))}rejectAndLog(g,m,S){this.logger.error(`[${g}][handleMediaNegotiationOffer] Cannot handle the incoming mediaRenegotiation offer in present callstate. Either call not connected or renegotiation in progress. isDuplicateOffer=${m}`),m||this.rejectMediaRenegotiation(S.mediaNegotiation.links.rejection,this.getGlareError(),g)}setFsmState(g,m){this.fsmState=g,this.fsmStateCauseId=m,this.logger.info(`[setFsmState]state=${g}`),this.telemetryHelper.recordEvent(Li.MEDIA_FSM_STATE_CHANGED,{state:g,causeId:m})}raiseMediaRenegotiationOffer(g,m){this.logger.info(`[${m}][raiseMediaRenegotiationOffer]`),this.links[Di.LINKS.MEDIA_ANSWER]=g.mediaNegotiation.links.mediaAnswer,this.links[Di.LINKS.MEDIA_REJECTION]=g.mediaNegotiation.links.rejection;let S=[];g.mediaNegotiation.callModalities&&g.mediaNegotiation.callModalities.length>0&&(S=getMediaTypes(g.mediaNegotiation.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(S),arrayContains(S,Di.MEDIA_TYPES.SCREEN_SHARER)&&this.signalingSession.telemetryHelper.addVbssOperations(xi.VBSS_OPERATION.REMOTE_START));const v={mediaTypes:S,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(g.mediaNegotiation.mediaContent),mediaContent:g.mediaNegotiation.mediaContent,renegotiation:!0};this.signalingSessionCallback.onOffer(v,m)}rejectMediaRenegotiation(g,m,S){this.logger.info(`[${S}][rejectMediaRenegotiation][rejectionData=${getPIISafeObject(m)}]`);const v=defer2();return this.signalingSession.http.sendPostRequest({url:g,payload:getPayload9(this.signalingSession,m),requestName:Fi.SEND_MEDIA_REJECTION.name,causeId:S}).then((g=>{v.resolve(g.response)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][rejectMediaRenegotiation] error: ${getPrintableObject(m)}`),v.reject(new Error(`rejectMediaRenegotiation failed because : ${getPrintableObject(g)}`))})),v.promise}handleMediaAnswerTimeout(g){this.logger.info(`[${g}][handleMediaAnswerTimeout]`),this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(xi.VBSS_OPERATION.TIMEOUT)),this.signalingSession.telemetryHelper.addIncomingModalities(["Timeout"]),this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_MEDIA_ANSWER_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.handleMediaNegotiationFailureInternal({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.MEDIA_FINAL_ANSWER_TIMEOUT,phrase:Di.CALL_END_PHRASE.MEDIA_FINAL_ANSWER_TIMEOUT},xi.EVENT_SOURCE.LOCAL,g)}handleMediaAnswerAcknowledgmentTimeout(g){this.logger.info(`[${g}][handleMediaAnswerAcknowledgmentTimeout]`),this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_MEDIA_ACKNOWLEDGEMENT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT);const m={reason:"timed out waiting for Media Answer Acknowledgement"};this.signalingSessionCallback.onMediaAcknowledgementFailure(!0,m,g)}},Sn=__toESM(P),vn=class{constructor(){this.requests={}}clear(g,m){const S=m||{code:Di.CALL_END_CODE.SUCCESS,subCode:Di.CALL_END_SUB_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((m=>{this.rejectOperation(m,g,S)}))}hasOperation(g){return this.requests.hasOwnProperty(g)}getAllOperations(){return this.requests}getOperation(g){return this.hasOperation(g)?this.requests[g]:null}setOperation(g,m){return!this.hasOperation(g)&&(this.requests[g]=m,!0)}rejectOperation(g,m,S){const v=new Error(m);if(S&&(v.endCode=S),this.hasOperation(g)){const m=this.requests[g].promise;delete this.requests[g],m.reject(v)}}resolveOperation(g,m){if(this.hasOperation(g)){const S=this.requests[g].promise;delete this.requests[g],S.resolve(m)}}},Cn=class{constructor(g){this.logger=g,this.localAddParticipantRequests=new vn,this.localAdmitParticipantRequests=new vn,this.localCallMeBackRequests=new vn,this.localRemoveParticipantEndpointRequests=new vn,this.localRemoveParticipantRequests=new vn,this.localUpdateParticipantInterpretationStateRequest=new vn,this.participantIdMriMap=new Map}dispose(g,m,S){this.logger.info(`[${S}][dispose]`),this.rejectAllPendingOperations(g,m)}getAllPendingOperations(g,m){this.logger.info(`[${m}][getAllPendingOperations] ${g}`);const S=this.getOperationTable(g);return S?S.getAllOperations():null}getPendingOperation(g,m,S){this.logger.info(`[${S}][getPendingOperation] ${g} ${m}`);const v=this.getOperationTable(g);return v?v.getOperation(m):null}getRnlMri(g,m){this.logger.info(`[${m}][getRnlMri] ${g}`);for(const m of g)if(this.participantIdMriMap.has(m))return this.participantIdMriMap.get(m);return""}hasPendingOperation(g,m,S){this.logger.info(`[${S}][hasPendingOperation] ${g} ${scrubMriOrOmit(m)}`);const v=this.getOperationTable(g);return!!v&&v.hasOperation(m)}rejectPendingOperation(g,m,S,v,C){this.logger.info(`[${C}][rejectPendingOperation] ${g} ${scrubMriOrOmit(m)} reason: ${S}`);const _=this.getOperationTable(g);_&&_.rejectOperation(m,S,v)}resolvePendingOperation(g,m,S,v){this.logger.info(`[${v}][resolvePendingOperation]: ${scrubMriOrOmit(m)}`);const C=this.getOperationTable(g);C&&C.resolveOperation(m,S)}setPendingOperation(g,m,S,v){this.logger.info(`[${v}][setPendingOperation] ${g} ${scrubMriOrOmit(m)} value: ${S}`);const C=this.getOperationTable(g);if(!C)return!1;if(0===g){const g=S&&S.participant&&S.participant.participantId;g&&this.participantIdMriMap.set(g,m)}return C.setOperation(m,S)}setParticipantIdToMriMapping(g,m,S,v){v?(this.logger.info(`[${S}][setParticipantIdMriMap] ${mriOrId(g)}: ${scrubMriOrOmit(m)} clear mapping.`),this.participantIdMriMap.delete(g)):g&&m&&(this.logger.info(`[${S}][setParticipantIdMriMap] ${mriOrId(g)}: ${scrubMriOrOmit(m)}`),this.participantIdMriMap.set(g,m))}getOperationTable(g){switch(g){case 0:return this.localAddParticipantRequests;case 1:return this.localAdmitParticipantRequests;case 2:return this.localCallMeBackRequests;case 4:return this.localRemoveParticipantEndpointRequests;case 3:return this.localRemoveParticipantRequests;case 5:return this.localUpdateParticipantInterpretationStateRequest;default:return null}}rejectAllPendingOperations(g,m){this.logger.info("rejectLocalQueuedOperations"),this.localAddParticipantRequests.clear(g,m),this.localAdmitParticipantRequests.clear(g,m),this.localCallMeBackRequests.clear(g,m),this.localRemoveParticipantRequests.clear(g,m),this.localRemoveParticipantEndpointRequests.clear(g,m),this.localUpdateParticipantInterpretationStateRequest.clear(g,m)}};function getPayload11(g,m,S,v){assertNotNull(g,"signalingSession cannot be null");const C=S.groupId?{id:S.groupId}:null,_=S.threadId?{threadId:S.threadId,messageId:S.messageId||null}:null;let E=[],T={};m&&m.length>0?(E=m.map((m=>({id:m.nonMaskedId?m.nonMaskedId:m.id,assertedId:m.assertedId,displayName:m.displayName,participantId:m.participantId,replacementDetails:3===S.replacementType?g.getReplacementDetailsByParticipantLegOfCall(S.callIdToReplace,m.id,m.replacementParticipantId):void 0}))),T={addParticipantSuccess:get(g,Mi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Mi.CONV_ADD_PARTICIPANT_FAILURE)}):T={addModalitySuccess:get(g,Mi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Mi.CONV_ADD_MODALITY_FAILURE)};const I={payload:{disableUnmute:S&&S.disableUnmute,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:E},participantInvitationData:S.additionalData,replacementDetails:3===S.replacementType?void 0:v,groupContext:C,groupChat:_,links:T}};return S&&S.alternateId&&(I.payload.participants.from.alternateId=S.alternateId),S?.clientScenario&&(I.payload.debugContent={clientScenario:S.clientScenario}),I}function getPayload12(g,m,S,v){assertNotNull(g,"signalingSession cannot be null");const C=m.map((g=>(assertNotNull(g,"remoteParticipant cannot be null"),{id:g.id,assertedId:g.assertedId,displayName:g.displayName,participantId:g.participantId})));return{payload:{disableUnmute:S&&S.disableUnmute,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,alternateId:S?S.alternateId:null},to:C},participantInvitationData:S.additionalData,replacementDetails:v,links:{addParticipantSuccess:get(g,Mi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Mi.CONV_ADD_PARTICIPANT_FAILURE)},debugContent:{clientScenario:S.clientScenario}}}}function getPayload13(g,m,S){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:[{id:m.id,displayName:m.displayName}]},links:{admitFailure:get(g,Mi.CONV_ADMIT_PARTICIPANT_FAILURE),admitSuccess:get(g,Mi.CONV_ADMIT_PARTICIPANT_SUCCESS)},debugContent:{causeId:S}}}}function getPayload14(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},mediaTypes:["audio"]}}}function getPayload15(g,m,S){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"muteScope be null"),assertNotNull(S,"participantList cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:m,muteParticipants:S,mediaTypes:["audio"]}}}function getPayload16(g,m,S,v,C,_){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"participantsIds cannot be null");const E=g.groupId?{id:g.groupId}:null,T=v?{threadId:v,messageId:C||null}:null,I=[];return m.forEach((g=>{const m={id:g};I.push(m)})),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},invitationType:Di.INVITATION_TYPE.NUDGE,to:I},participantInvitationData:_,groupContext:E,groupChat:T,links:{nudgeParticipantSuccess:get(g,Mi.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:get(g,Mi.CONV_NUDGE_PARTICIPANT_FAILURE)}}}}function getPayload17(g,m,S){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"participantsIds cannot be null");const v=[];return m.forEach((g=>{const m={id:g};v.push(m)})),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},invitationType:Di.INVITATION_TYPE.NUDGE,to:v},participantInvitationData:S,links:{nudgeParticipantSuccess:get(g,Mi.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:get(g,Mi.CONV_NUDGE_PARTICIPANT_FAILURE),addParticipantSuccess:get(g,Mi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Mi.CONV_ADD_PARTICIPANT_FAILURE)}}}}function getPayload18(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{transactionEnd:m}}}function getPayload19(g,m,S){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:S,toEndpoints:[{id:m.id,endpointId:m.endpointId}]},links:{removeParticipantSuccess:get(g,Mi.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:get(g,Mi.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function getPayload20(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:[{id:m.id,displayName:m.displayName}]},links:{removeParticipantSuccess:get(g,Mi.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:get(g,Mi.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function getPayload21(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},mediaTypes:["audio"]}}}function getPayload22(g,m,S,v=""){assertNotNull(S&&"specified"===S,"Only non-null non-empty scope of 'specified' is supported."),assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"participantsIds cannot be null");const C=[];return m.forEach((g=>{const m={id:g,meetingRole:v};C.push(m)})),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:S,to:C}}}function getUpdateParticipantInterpretationStatePayload(g,m,S){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"options cannot be null");return{payload:{from:{id:g.participantManager.localParticipant.id},to:m,links:{updateParticipantInterpretationStateStatus:get(g,Mi.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS)},operationId:S}}}var _n=__toESM(P),yn=class{constructor(g,m){this.participantManager=g,this.logger=m,this.setStaleCheckForFullRoster=g=>{this.checkStaleRosterFromFull=g},this.handleRosterUpdate=(g,m,S,v)=>{if("Delta"===g.type||"MultiPartyEndpoint"===g.type){if(void 0===g.sequenceNumber&&(g.sequenceNumber=this.lastRosterUpdateSeqNumber),this.logger.info(`[${v}][handleRosterUpdate][sequenceNumber=${g.sequenceNumber}]`),this.rostersInLifetime.add(g.sequenceNumber),"Delta"===g.type)this.logger.info(`[${v}][handleRosterUpdate], RosterType: Delta, isFullRoster: ${S}`),this.handleDeltaRoster(g,S,m,v);else{if(this.logger.info(`[${v}][handleRosterUpdate], RosterType: MultiPartyEndpoint`),this.isRosterStale(g,v))return this.participantManager.signalingSession.telemetryHelper.recordEvent(Li.IGNORE_OLD_ROSTER,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:g.sequenceNumber,causeId:v}),void this.logger.info(`[${v}][handleRosterUpdate] Ignoring old roster update: received ${g.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const S of Object.keys(g.participants)){const C=ki.fromRoster(g.participants[S]);this.handleRosterParticipant(C,m,v)}this.checkForRemovedParticipants(m,g.participants,v),this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(g.participantCounts,v)}if(g.sequenceNumber>this.lastRosterUpdateSeqNumber){this.checkStaleRosterFromFull&&this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(g.participantCounts,v),this.lastRosterUpdateSeqNumber=g.sequenceNumber,this.firstRosterUpdateSeqNumber<0&&(this.firstRosterUpdateSeqNumber=this.lastRosterUpdateSeqNumber);const m=Object.keys(g.participants||0).length;this.participantCountInFirstRoster<0&&(this.participantCountInFirstRoster=m),this.maxConcurrentParticipantsDuringLeg=Math.max(this.maxConcurrentParticipantsDuringLeg,m)}this.recordTelemetry(g,S,v),this.participantManager.signalingSessionCallback.onRosterHandlingComplete()}else this.logger.warn(`[${v}][handleRosterUpdate][sequenceNumber=${g.sequenceNumber}] invalid roster type ${g.type}`)},this.isRosterStaleFromFull=(g,m)=>!!this.checkStaleRosterFromFull&&(this.logger.info(`[${m}][isRosterStale] ${g.sequenceNumber<this.lastFullRosterSeqNumber}`),g.sequenceNumber<this.lastFullRosterSeqNumber),this.isRosterStale=(g,m)=>(this.logger.info(`[${m}][isRosterStale] ${g.sequenceNumber<this.lastRosterUpdateSeqNumber}`),g.sequenceNumber<this.lastRosterUpdateSeqNumber),this.updateLocalParticipantFromSubscribe=(g,m)=>{this.logger.info(`[${m}][updateLocalParticipantFromSubscribe]`),this.updateLocalParticipant(g,m)},this.handleParticipantAcceptedBy=(g,m,S)=>{const v=m.hasOwnProperty(g.id),C=g.id===g.acceptedBy.id;this.logger.info(`[${S}][RosterManager::handleParticipantAcceptedBy] oldParticipantInRoster: ${v}`);this.participantManager.participantOperationHandler.setParticipantIdToMriMapping(g.participantId,g.id,S,!0),v&&!C&&this.handleRemovedDeltaRosterParticipant(new ki({id:g.id}),this.lastRosterUpdateSeqNumber,m,S)},this.lastRosterUpdateSeqNumber=-1,this.lastFullRosterSeqNumber=-1,this.firstRosterUpdateSeqNumber=-1,this.tombstoneSequence=new Map,this.latestRosterVersionForActiveParticipants=new Map,this.rostersInLifetime=new Set,this.maxConcurrentParticipantsDuringLeg=-1,this.participantCountInFirstRoster=-1,this.checkStaleRosterFromFull=!1}recordTelemetry(g,m,S){const v={participantCountInLastRoster:Object.keys(g.participants||0).length,participantCountInFirstRoster:this.participantCountInFirstRoster,sequenceNumberOfLastRoster:this.lastRosterUpdateSeqNumber,sequenceNumberOfLastFullRoster:this.lastFullRosterSeqNumber,sequenceNumberOfFirstRoster:this.firstRosterUpdateSeqNumber,rosterType:g.type,isFullRoster:m,maxConcurrentParticipantsDuringLeg:this.maxConcurrentParticipantsDuringLeg,totalParticipantsDuringLifetimeOfLeg:this.tombstoneSequence.size+this.latestRosterVersionForActiveParticipants.size,countOfMissingNotifications:this.getMissingNotificiations()};this.logger.info(`[recordTelemetry] data ${JSON.stringify(v,null,4)}`),this.participantManager.signalingSession.telemetryHelper.recordRosterEvent(v,Li.HANDLE_ROSTER_UPDATE,S)}getMissingNotificiations(){const g=this.lastRosterUpdateSeqNumber-this.firstRosterUpdateSeqNumber+1-this.rostersInLifetime.size;return g>0?g:0}isParticipantRosterStale(g,m){if(this.logger.info(`[isParticipantRosterStale], rosterParticipantVersion ${m}`),m){if(this.tombstoneSequence.has(g))return m<=this.tombstoneSequence.get(g);if(this.latestRosterVersionForActiveParticipants.has(g))return m<=this.latestRosterVersionForActiveParticipants.get(g)}return!1}handleDeltaRoster(g,m,S,v){if(this.logger.info(`[${v}][handleDeltaRoster] isFullRoster ${m}`),this.isRosterStaleFromFull(g,v))return this.participantManager.signalingSession.telemetryHelper.recordEvent(Li.IGNORE_OLD_ROSTER,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,lastFullRosterSeqNumber:this.lastFullRosterSeqNumber,sequenceNumber:g.sequenceNumber,causeId:v}),void this.logger.info(`[${v}][handleRosterUpdate] Ignoring old roster update: received ${g.sequenceNumber}, but already handled full roster ${this.lastFullRosterSeqNumber}`);if(m){if(!this.checkStaleRosterFromFull&&this.isRosterStale(g,v))return this.participantManager.signalingSession.telemetryHelper.recordEvent(Li.IGNORE_OLD_ROSTER,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:g.sequenceNumber,causeId:v}),void this.logger.info(`[${v}][handleRosterUpdate] Ignoring old roster update: received ${g.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const m of Object.keys(S))if(!(g.participants.hasOwnProperty(m)||this.checkStaleRosterFromFull&&this.isParticipantRosterStale(m,g.sequenceNumber))){const C=new ki({id:m});this.logger.info(`[${v}][handleRosterUpdate] participant missing from delta, full roster`),this.handleRemovedDeltaRosterParticipant(C,g.sequenceNumber,S,v)}this.lastFullRosterSeqNumber=g.sequenceNumber}else if(!g?.participants)return void this.logger.warn(`[${v}][handleRosterUpdate] participants blob empty in delta roster`);for(const m of Object.keys(g.participants)){const C=g.participants[m];if(!this.isParticipantRosterStale(m,C.version)){let g=ki.fromRoster(C);C.state&&"active"===C.state?(this.logger.info(`[${v}][handleDeltaRoster] participant active`),this.handleRosterParticipant(g,S,v),this.tombstoneSequence.has(m)&&this.tombstoneSequence.delete(m),this.latestRosterVersionForActiveParticipants.set(m,C.version)):C.state&&"inactive"===C.state?(g=g||new ki({id:C.details.id}),this.logger.info(`[${v}][handleDeltaRoster] participant inactive`),this.handleRemovedDeltaRosterParticipant(g,C.version,S,v)):this.logger.info(`[${v}][handleDeltaRoster] unexpected participant state ${C.state}`)}}this.handleRemoveParticipantRequests(this.getActiveParticipants(g.participants),v),this.checkStaleRosterFromFull||this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(g.participantCounts,v)}getRnlMri(g,m){const S=this.participantManager.participantOperationHandler;if(g){const v=this.getRnlParticipantIdsFromRoster(g,m);return S.getRnlMri(v,m)}return""}handleRemovedDeltaRosterParticipant(g,m,S,v){const C=g.id,_=this.getRnlMri(g,v);let E="";S.hasOwnProperty(C)?E=C:S.hasOwnProperty(_)&&(E=_),E&&this.handleRemovedParticipant(S,E,v),this.tombstoneSequence.set(C,m),this.latestRosterVersionForActiveParticipants.has(C)&&this.latestRosterVersionForActiveParticipants.delete(C)}handleRemovedParticipant(g,m,S){const v=this.participantManager.signalingSessionCallback,C=this.participantManager.signalingSession;!1!==g[m]&&(tryRemoveKeyFromHashTable(this.participantManager.connectedRemoteParticipantIds,m),this.logger.info(`[${S}][handleRemovedParticipant] ${scrubMriOrOmit(m)} removed from roster`),v.onParticipantRemoved({id:m},S),C.clearParticipantCallLinks(m))}getActiveParticipants(g){const m={};for(const S of Object.keys(g))"inactive"!==g[S].state&&(m[S]=g[S]);return m}handleRosterParticipant(g,m,S){if(!g)return void this.logger.info(`[handleRosterParticipant][${S}] rosterParticipant processing skipped because null.`);if(g.id===this.participantManager.localParticipant.id){this.updateLocalParticipant(g,S);const m=this.getLocalEndpoint(),v=!(!m?.stream&&!m?.streamLobby),C=0===this.participantManager.signalingSession.callMode;return this.logger.info(`[handleRosterParticipant][${S}] isStreaming:${v} isInitialMode:${C}`),void(v&&C?this.participantManager.signalingSession.configureStreamingMode(S):v||this.participantManager.signalingSession.setRealTimeState(1,S))}const v=this.participantManager.participantOperationHandler,C=this.participantManager.signalingSession,_=this.participantManager.signalingSessionCallback,E=g.id,T=this.getRnlMri(g,S),I=this.getRnlParticipantIdsFromRoster(g,S);C.remoteCaller&&-1!==I.indexOf(C.remoteCaller.participantId)&&(g.displayName=C.remoteCaller.displayName),tryAddNewKeyToHashTable(this.participantManager.connectedRemoteParticipantIds,g.id,!0);const b=m.hasOwnProperty(g.id),A=m.hasOwnProperty(T);(b||A)&&(m[g.id]=!1),v.hasPendingOperation(0,g.id,S)&&this.isParticipantInCall(g)?(this.logger.info(`participant ${scrubMriOrOmit(g.id)} appears in roster. Resolving AddParticipant request`),C.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,g.id),v.resolvePendingOperation(0,g.id,g,S)):T&&v.hasPendingOperation(0,T,S)&&this.isParticipantInCall(g)?(this.logger.info(`RNL participant ${scrubMriOrOmit(T)} appears in roster. Resolving AddParticipant request`),C.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,T),v.resolvePendingOperation(0,T,g,S)):v.hasPendingOperation(1,g.id,S)&&this.isParticipantInCall(g)&&(this.logger.info(`participant: ${scrubMriOrOmit(g.id)} appears in roster. Resolving AdmitParticipant request`),C.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g.id),v.resolvePendingOperation(1,g.id,g,S));for(const m of g.endpointDetails)v.hasPendingOperation(0,m.participantId,S)&&this.isParticipantInCall(g)&&(this.logger.info(`participant ${scrubMriOrOmit(g.id)} appears in roster. Resolving AddParticipant request`),C.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,m.participantId),v.resolvePendingOperation(0,m.participantId,g,S));b?(this.logger.info(`participantIds=[${I}] updated ${scrubMriOrOmit(g.id)}`),_.onParticipantUpdated(g,S),C.setParticipantCallLinks(g)):A?(this.logger.info(`RNL participant participantIds=[${I}] removed old ${scrubMriOrOmit(T)} and added new ${scrubMriOrOmit(E)}`),_.onParticipantRemoved({id:T},S,!0),C.clearParticipantCallLinks(T),_.onParticipantJoined(g,S),C.setParticipantCallLinks(g)):v.hasPendingOperation(3,g.id,S)?this.logger.info(`participantIds=[${I}] ignored ${scrubMriOrOmit(g.id)}`):(this.logger.info(`participantIds=[${I}] joined ${scrubMriOrOmit(g.id)}`),_.onParticipantJoined(g,S),C.setParticipantCallLinks(g))}getLocalEndpoint(){return _n.find(this.participantManager.localParticipant.endpointDetails,(g=>this.participantManager.localParticipant.endpointId===g.endpointId))}getRnlParticipantIdsFromRoster(g,m){const S=[];for(const m of g.endpointDetails)S.push(m.participantId);return this.logger.info(`[${m}][getRnlParticipantIdsFromRoster] ${JSON.stringify(S)}`),S}isParticipantInCall(g){return g.endpointDetails?.[0]&&!g.endpointDetails[0].isLobby}updateLocalParticipant(g,m){const S=this.participantManager.localParticipant,v=this.participantManager.signalingSession,C=this.participantManager.signalingSessionCallback;v.setParticipantCallLinks(g),this.logger.info(`[${m}][updateLocalParticipant]`);let _=!1;if(g?.endpointDetails){const E=_n.find(g.endpointDetails,(g=>S.endpointId===g.endpointId)),T=_n.find(S.endpointDetails,(g=>S.endpointId===g.endpointId));_=hasStagingGroup(E),E?.isLobby&&!T?.isLobby?v.telemetryHelper.recordEvent(Li.IN_LOBBY,{causeId:m}):!E||E.isLobby||T&&!T.isLobby||(_?v.telemetryHelper.recordEvent(Li.STAGING,{causeId:m}):v.telemetryHelper.recordEvent(Li.CONNECTED,{causeId:m})),E?.broadcastMeetingRole&&S&&S.broadcastMeetingRole!==E.broadcastMeetingRole&&(S.broadcastMeetingRole=E.broadcastMeetingRole,v.telemetryHelper.setBroadcastMeetingRole(E.broadcastMeetingRole)),C.onMeetingGroupDetailsUpdated(E?.meetingGroupDetails,m)}if(g?.meetingRole&&v.telemetryHelper.setMeetingRole(g.meetingRole),g?.advancedMeetingRole&&v.telemetryHelper.setAdvancedMeetingRole(g.advancedMeetingRole),g?.participantType&&v.telemetryHelper.setParticipantType(g.participantType),g&&(S.endpointDetails=g.endpointDetails||[],S.acceptedBy=g.acceptedBy,S.role=g.role,S.meetingRole=g.meetingRole,S.advancedMeetingRole=g.advancedMeetingRole,S.participantType=g.participantType,S.tenantId=g.tenantId,S.isLobby=g.isLobby,S.publishedStates=g.publishedStates,S.isStaging=_,S.version=g.version,S.propertyBag=g.propertyBag,S.isIdentityMasked=g.isIdentityMasked,S.maskedIdSeqNumber=g.maskedIdSeqNumber,S.maskedId=g.maskedId,this.participantManager.localParticipant.fromRoster=!0,C.onSelfParticipantUpdated(S,m)),this.isParticipantInCall(g)){const S=this.participantManager.participantOperationHandler,C=this.getRnlMri(g,m);C&&S.hasPendingOperation(0,C,m)&&(this.logger.info(`RNL participant ${scrubMriOrOmit(C)} appears in roster. Resolving AddParticipant request`),v.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,C),S.resolvePendingOperation(0,C,g,m))}}checkForRemovedParticipants(g,m,S){const v=this.participantManager.signalingSessionCallback,C=this.participantManager.signalingSession,_=this.participantManager.participantOperationHandler;this.logger.info(`[${S}][checkForRemovedParticipants]`);for(const m of Object.keys(g))g.hasOwnProperty(m)&&!1!==g[m]&&!_.hasPendingOperation(0,m,S)&&(tryRemoveKeyFromHashTable(this.participantManager.connectedRemoteParticipantIds,m),this.logger.info(`[${S}][checkForRemovedParticipants] ${scrubMriOrOmit(m)} removed from roster`),v.onParticipantRemoved({id:m},S),C.clearParticipantCallLinks(m));this.handleRemoveParticipantRequests(m,S)}handleRemoveParticipantRequests(g,m){const S=this.participantManager.signalingSession,v=this.participantManager.participantOperationHandler;this.logger.info(`handleRemoveParticipantRequests [${m}] dynamicRosterParticipants`);const C=[];Object.keys(g).forEach((m=>{const S=ki.fromRoster(g[m]);S&&S.endpointDetails&&S.endpointDetails.forEach((g=>{g.originalId&&C.push(g.originalId)}))}));const _=v.getAllPendingOperations(3,m);for(const E of Object.keys(_))-1!==C.indexOf(E)||g.hasOwnProperty(E)||(this.logger.info(`[${m}][handleRemoveParticipantRequests] ${scrubMriOrOmit(E)} no longer appears in roster. Resolving RemoveParticipant request`),tryRemoveKeyFromHashTable(this.participantManager.connectedRemoteParticipantIds,E),S.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,E),v.resolvePendingOperation(3,E,{id:E},m))}},En=class{constructor(g,m,S){this.connectedRemoteParticipantIds={},this.disposed=!1,this.unmuteApprovalLinks={},this.setLocalParticipantId=(g,m)=>{g&&(this.logger.info(`[${m}][setLocalParticipantId][participantId=${g}]`),this.localParticipant.participantId=g,this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId))},this.setStaleCheckForFullRoster=g=>{this.rosterManager.setStaleCheckForFullRoster(g)},this.admitParticipantAsync=(g,m,S)=>{const v=`[${S}][admitParticipantAsync]`;this.logger.info(`${v}${this.piiUtils.scrubMriOrOmit(g.id)}`);const C=defer2();return this.participantOperationHandler.hasPendingOperation(1,g.id,S)?(this.logger.info(`${v}there is an existing pending request to admit the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),C.reject(new Error("there is an existing pending request to admit the participant"))):(this.participantOperationHandler.setPendingOperation(1,g.id,{participant:g,promise:C,causeId:S},S),this.sendNetworkRequestForAdmittingParticipant(g,m,S)),C.promise},this.addParticipantsAsync=(g,m,S,v,C)=>{const _=`[${C}][addParticipantsAsync]`,E=g.map((g=>this.piiUtils.scrubMriOrOmit(g.id)));this.logger.info(`${_} remoteParticipantsIds: ${E}`);const T=[],I=[];return g.forEach((g=>{const m=defer2(),S=3===v.replacementType?g.participantId:g.id;this.connectedRemoteParticipantIds.hasOwnProperty(g.id)?(this.logger.info(`${_}the given participant is already connected to the call ${this.piiUtils.scrubMriOrOmit(g.id)}`),m.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(0,S,C)?(this.logger.info(`${_}there is an existing pending request to add the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),m.reject(new Error("there is an existing pending request to add the participant"))):(g.participantId||(g.participantId=newGuid(),this.logger.info(`participantId created ${g.participantId}`)),this.participantOperationHandler.setPendingOperation(0,S,{participant:g,promise:m,causeId:C},C),T.push(g)),I.push(m.promise)})),S&&this.sendNetworkRequestForAddingParticipant(T,m,v,C),I},this.nudgeParticipantsAsync=(g,m,S,v,C,_,E,T)=>(this.logger.info(`[${v}][nudgeParticipantAsync] ${this.piiUtils.scrubParticipantsList(g)}`),S?this.sendNetworkRequestForNudgingParticipants(g,m,v,C,_,E,T):Promise.reject(`[${v}][nudgeParticipantAsync] Call not started`)),this.updateMeetingRolesAsync=(g,m,S,v=causeId2())=>{const C=defer2();if(!g||g.length<1){const g=`[${v}][updateMeetingRolesAsync] participantsInfo cannot be empty or null`,m=new Error(g);m.endCode={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),C.reject(m)}else if(m)if(S){let _;"attendee"===m?_=Fi.UPDATE_MEETING_ROLE_ATTENDEE.name:"presenter"===m?_=Fi.UPDATE_MEETING_ROLE_PRESENTER.name:"organizer"===m?_=Fi.UPDATE_MEETING_ROLE_ORGANIZER.name:C.reject(new Error(`[${v}] Invalid meetingRole value(${m})`)),this.logger.info(`[${v}][updateMeetingRolesAsync][meetingRole=${m}]`),this.signalingSession.ensureMessageChannelReady(_).then((()=>{this.sendNetworkRequestForUpdatingMeetingRoles(g,m,S,_,v,C)})).catch((g=>{const m=getPrintableObject(g);this.logger.info(`[${v}][updateMeetingRolesAsync][failed][reason=${m}]`);const S={...getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig).error};C.reject(S)}))}else{const g=`[${v}][updateMeetingRolesAsync] updateMeetingRoleUrl cannot be empty or null`,m=new Error(g);m.endCode={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),C.reject(m)}else{const g=`[${v}][updateMeetingRolesAsync] meetingRole cannot be empty or null`,m=new Error(g);m.endCode={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),C.reject(m)}return C.promise},this.updateParticipantInterpretationStateAsync=(g,m,S)=>{const v=`[${S}][updateParticipantInterpretationStateAsync]`,C=g.map((g=>this.piiUtils.scrubMriOrOmit(g.id)));this.logger.info(`${v} remoteParticipantsIds: ${C}`);const _=[],E=[];return g.forEach((g=>{const m=defer2();this.participantOperationHandler.hasPendingOperation(5,g.id,S)?(this.logger.info(`${v}there is an existing pending request to update the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),m.reject(new Error("there is an existing pending request to update the participant"))):(this.participantOperationHandler.setPendingOperation(5,g.id,{option:g,promise:m,causeId:S},S),_.push(g)),E.push(m.promise)})),this.sendNetworkRequestToUpdateParticipantInterpretationState(_,m,g,S),E},this.callMeBackAsync=(g,m,S)=>{this.logger.info(`[${S}][callMeBackAsync] ${this.piiUtils.scrubMriOrOmit(g.id)}`);const v=defer2();return this.connectedRemoteParticipantIds.hasOwnProperty(g.id)?(this.logger.info(`the given participant is already connected to the call : ${this.piiUtils.scrubMriOrOmit(g.id)}`),v.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(2,g.id,S)?(this.logger.info(`there is an existing pending request to call back the participant : ${this.piiUtils.scrubMriOrOmit(g.id)}`),v.reject(new Error("there is an existing pending request to call back the participant"))):(this.participantOperationHandler.setPendingOperation(2,g.id,{participant:g,promise:v},S),this.sendNetworkRequestForCallMeBack(g,m,S)),v.promise},this.isRosterStale=(g,m)=>this.rosterManager.isRosterStale(g,m),this.removeParticipantAsync=(g,m,S)=>{this.logger.info(`[${S}][removeParticipantAsync] ${this.piiUtils.scrubMriOrOmit(g.id)}`),assertNotNullOrEmpty(m,"correct removeParticipantUrl is not provided");const v=defer2();if(this.participantOperationHandler.hasPendingOperation(3,g.id,S))this.logger.info(`there is an existing pending request to remove the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),v.reject(new Error("there is an existing pending request to remove the participant"));else{this.participantOperationHandler.setPendingOperation(3,g.id,{participant:g,promise:v},S);const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession.telemetryHelper.recordEvent(Li.REMOVE_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(3,g.id,"timed out waiting for participant to not show up in roster",{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Di.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},S)}),Di.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,g.id)};this.signalingSession.http.sendPostRequest({url:m,payload:getPayload20(this.signalingSession,g),requestName:Fi.REMOVE_PARTICIPANT_NONE.name,onceTrouterReady:onceTrouterReady,causeId:S}).catch((m=>{const v=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][removeParticipantAsync][failed][reason=${getPrintableObject(v)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(3,g.id,m,v.error,S))}))}return v.promise},this.removeParticipantEndpointAsync=(g,m,S,v)=>{this.logger.info(`[${v}][removeParticipantEndpointAsync] ${truncate(g.endpointId)} [endPointScope] ${S}`),assertNotNullOrEmpty(m,"correct removeParticipantUrl is not provided");const C=defer2();let _="";switch(S){case"all":_=Fi.REMOVE_PARTICIPANT_OTHERS.name;break;case"specified":_=Fi.REMOVE_PARTICIPANT_SPECIFIED.name;break;default:return Promise.reject(`invalid scope ${S} removeParticipantEndpointAsync`)}this.participantOperationHandler.setPendingOperation(4,g.endpointId,{participant:g,promise:C,scope:S},v);const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Li.REMOVE_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.endpointId),this.participantOperationHandler.rejectPendingOperation(4,g.endpointId,"timed out waiting for participant endpoint sync response from service",{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Di.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},v))}),Di.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,g.endpointId)};return this.signalingSession.http.sendPostRequest({url:m,payload:getPayload19(this.signalingSession,g,S),requestName:_,onceTrouterReady:onceTrouterReady,causeId:v}).then((g=>{if(g.response&&g.response.code)if(-1!==[Di.HTTP_STATUS_CODES.OK,Di.HTTP_STATUS_CODES.CREATED].indexOf(g.response.code))this.logger.info(`[${v}][removeParticipantEndpointAsync][endPointScope] ${S} [passed][reason=${getPrintableObject(g.response)}]`),C.resolve(g.response);else{const m=new Error("invalid service response for removeParticipantEndpoint");m.endCode={code:g.response.code,subCode:g.response.subcode,phrase:g.response.reason},this.logger.info(`[${v}][removeParticipantEndpointAsync][endPointScope] ${S} [failed][reason=${getPrintableObject(g.response)}]`),C.reject(m)}C.resolve()})).catch((m=>{const C=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${v}][removeParticipantEndpointAsync][endPointScope] ${S} [failed][reason=${getPrintableObject(C)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.endpointId),this.participantOperationHandler.rejectPendingOperation(4,g.endpointId,getPrintableObject(m),C.error,v))})),C.promise},this.getParticipantsToInitiateCallWith=()=>{this.logger.info("getParticipantsToInitiateCallWith");const g=[],m=this.participantOperationHandler.getAllPendingOperations(0,causeId2());for(const S of Object.keys(m))m.hasOwnProperty(S)&&m[S]&&g.push(m[S].participant);return g},this.initializeForIncomingCall=g=>{this.logger.info("initializeForIncomingCall"),this.participantOperationHandler.dispose("incoming calls cannot add/remove participants until call is connected",null,causeId2())},this.handleAddParticipantSuccess=g=>{const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleAddParticipantSuccess(${m.participantInfos?"new format":"old format"})]${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_ADD_PARTICIPANT_SUCCESS,g),this.internalHandleCallMeBackSuccess(m,S)||this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_ADD_PARTICIPANT_SUCCESS),this.signalingSession.signalingAgentConfig.enableAddParticipantEnhancements&&this.internalHandleAcceptedByParticipants(m,S)},this.handleAddParticipantFailure=g=>{const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleAddParticipantFailure(${m.participantInfos?"new format":"old format"})][${getPrintableObject(m)}]`),m.modalityFailure?(this.logger.info(`[${S}][handleAddParticipantFailure][modalityFailure=${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_ADD_PARTICIPANT_MODALITY_FAILURE,g)):this.internalHandleAddParticipantFailure(g,S)},this.handleAdmitParticipantSuccess=g=>{const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleAdmitParticipantSuccess][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_ADMIT_PARTICIPANT_SUCCESS,g),m.participants&&this.internalHandleAdmitParticipantSuccess(g,S)},this.handleAdmitParticipantFailure=g=>{const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleAdmitParticipantFailure][${getPrintableObject(m)}]`),m.participants&&this.internalHandleAdmitParticipantFailure(g,S)},this.handleRemoveParticipantFailure=g=>{const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleRemoveParticipantFailure][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_REMOVE_PARTICIPANT_FAILURE,g);for(const g of Object.keys(m.participants))m.participants.hasOwnProperty(g)&&this.internalHandleRemoveParticipantFailure(g,m.participants[g],S)},this.handleRemoveParticipantSuccess=g=>{const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleRemoveParticipantSuccess][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_REMOVE_PARTICIPANT_SUCCESS,g)},this.handleUnmuteConfirmRequest=g=>{const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleUnmuteConfirmRequest][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_UNMUTE_CONFIRM,g),this.unmuteApprovalLinks[m.from.id]={approve:m.links.approveUnmute,reject:m.links.rejectUnmute},this.signalingSessionCallback.onUnmuteRequested(m.from.id,S)},this.approveUnmuteRequestAsync=(g,m)=>{this.logger.info(`[${m}][approveUnmuteRequestAsync]`);const S=defer2();return this.unmuteApprovalLinks.hasOwnProperty(g)?(this.signalingSession.ensureMessageChannelReady(Fi.APPROVE_UNMUTE.name).then((()=>{this.muteUnmute(Fi.APPROVE_UNMUTE.name,getPayload14(this.signalingSession),S,this.unmuteApprovalLinks[g].approve,m)})).catch((g=>{const v=getPrintableObject(g);this.logger.info(`[${m}][approveUnmuteRequestAsync][failed][reason=${v}]`),S.reject(new Error(g))})),S.promise):(S.reject(new Error("no unmute links found for given participant")),S.promise)},this.rejectUnmuteRequestAsync=(g,m,S)=>{this.logger.info(`[${m}][rejectUnmuteRequestAsync]`);const v=defer2();if(!this.unmuteApprovalLinks.hasOwnProperty(g))return v.reject(new Error("no unmute links found for given participant")),v.promise;const C=S||{code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UNMUTE_REQUEST_REJECTED,phrase:Di.CALL_END_PHRASE.UNMUTE_REQUEST_REJECTED};return this.signalingSession.ensureMessageChannelReady(Fi.REJECT_UNMUTE.name).then((()=>{this.muteUnmute(Fi.REJECT_UNMUTE.name,getPayload18(this.signalingSession,C),v,this.unmuteApprovalLinks[g].reject,m)})).catch((g=>{const S=getPrintableObject(g);this.logger.info(`[${m}][rejectUnmuteRequestAsync][failed][reason=${S}]`),v.reject(new Error(g))})),v.promise},this.handleRosterUpdate=(g,m,S)=>{const v=this.getCurrentParticipantsInCallModality(!1);this.rosterManager.handleRosterUpdate(g,v,m,S)},this.updateLocalParticipantFromSubscribe=(g,m)=>{this.localParticipant.fromRoster||this.rosterManager.updateLocalParticipantFromSubscribe(g,m)},this.muteAsync=(g,m,S,v)=>{this.logger.info(`[${v}][muteAsync][muteScope=${m}]`);let C="specified";const _=[];let E=Fi.MUTE_SPECIFIED;switch(m){case Di.MUTE_SCOPE.MYSELF:E=Fi.MUTE_MYSELF,_.push({id:this.localParticipant.id});break;case Di.MUTE_SCOPE.EVERYONE_ELSE:E=this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()?Fi.MUTE_ALL_SYNC:Fi.MUTE_ALL,C="all",S.forEach((g=>{_.push({id:g})}));break;case Di.MUTE_SCOPE.SPECIFIED_PARTICIPANTS:assertNotNullOrEmpty(S,`[${v}]array of participantIds must be specified for SPECIFIED_PARTICIPANTS mute scope`),E=this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()?Fi.MUTE_SPECIFIED_SYNC:Fi.MUTE_SPECIFIED,S.forEach((g=>{_.push({id:g})}));break;default:assert2(!1,`[${v}]muteScope is a required param. please pass in a valid value.`)}const T=defer2();if(m===Di.MUTE_SCOPE.SPECIFIED_PARTICIPANTS){const g=this.areParticipantsConnectedToCall(S);if(!g.result)return T.reject(new Error(`[${v}]specified participant is not connected to call yet. Id = ${g.participant}`)),T.promise}return this.signalingSession.ensureMessageChannelReady(E.name).then((()=>{this.muteUnmute(E.name,getPayload15(this.signalingSession,C,_),T,g,v)})).catch((g=>{const m=getPrintableObject(g),S=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${v}][muteAsync][failed][reason=${m}]`),T.reject(S)})),T.promise},this.unmuteAsync=(g,m)=>{this.logger.info(`[${m}][unmuteAsync]`);const S=defer2();return this.signalingSession.ensureMessageChannelReady(Fi.UNMUTE.name).then((()=>{this.muteUnmute(this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()?Fi.UNMUTE_SYNC.name:Fi.UNMUTE.name,getPayload21(this.signalingSession),S,g,m,!0)})).catch((g=>{const v=getPrintableObject(g);this.logger.info(`[${m}][unmuteAsync][failed][reason=${v}]`),S.reject(new Error(g))})),S.promise},this.dispose=(g,m)=>{this.logger.info(`[${m}][dispose]`),this.disposed=!0,this.participantOperationHandler.dispose("call ended",g,m),this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId)},this.internalHandleAcceptedByParticipants=(g,m)=>{if(g?.participantInfos){const S=g.participantInfos,v=this.getCurrentParticipantsInCallModality(!1);this.logger.info(`[${m}][internalHandleAcceptedByParticipants] handling participants with acceptedBy blob.`);for(const g of S)if(g?.acceptedBy){const S=g.id;this.participantOperationHandler.hasPendingOperation(0,S,m)&&(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,S),this.logger.info(`[${m}][internalHandleAcceptedByParticipants] ${this.piiUtils.scrubMriOrOmit(S)} added using a different MRI. Resolving operation.`),this.participantOperationHandler.resolvePendingOperation(0,S,void 0,m)),this.rosterManager.handleParticipantAcceptedBy(g,v,m)}}},this.internalHandleCallMeBackSuccess=(g,m)=>{let S=!1;if(g&&g.participantInfos){const v=g.participantInfos;for(const g of v){const v=g.id;this.internalHandleCallMeBackSuccessHelper(v,m)&&(S=!0)}}else if(g&&g.participants)for(const v of g.participants)this.internalHandleCallMeBackSuccessHelper(v,m)&&(S=!0);return S},this.signalingSession=g,this.signalingSessionCallback=m,this.localParticipant=S,this.localParticipant.endpointId||(this.localParticipant.endpointId=this.signalingSession.getEndpointId());const v=truncate(this.localParticipant.endpointId);this.logger=g.logger.createChild((()=>`[PM][${v}]`)),this.piiUtils=g.piiUtils,this.participantOperationHandler=new Cn(g.logger.createChild((()=>`[ParticipantOperationHandler][${v}]`))),this.rosterManager=new yn(this,g.logger.createChild((()=>`[RosterManager][${v}]`))),this.localParticipant.participantId||(this.localParticipant.participantId=newGuid()),"string"==typeof g.signalingAgentConfig.languageCode?this.localParticipant.languageId=g.signalingAgentConfig.languageCode:"function"==typeof g.signalingAgentConfig.languageCode&&(this.localParticipant.languageId=g.signalingAgentConfig.languageCode()),g.telemetryHelper.setParticipantId(this.localParticipant.participantId),g.telemetryHelper.setEndPointId(this.localParticipant.endpointId)}handleUpdateParticipantInterpretationStateCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g),v=m.operationId;if(this.disposed)return void this.logger.info(`[${S}][handleUpdateParticipantInterpretationStateCompletion] ignored. Call disposed.`);v||this.logger.warn(`[${S}][handleUpdateParticipantInterpretationStateCompletion] operationId is undefined.`),this.logger.info(`[${S}][handleUpdateParticipantInterpretationStateCompletion] starts`);const C=g.body;if(C.participantInfos)for(const m of C.participantInfos)if(this.logger.info(m),this.participantOperationHandler.hasPendingOperation(5,m.participant.id,S))if(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,m.participant.id),m.transactionEnd.code===Di.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${S}]Update participant interpretation state succeeded for: ${this.piiUtils.scrubMriOrOmit(m.participant.id)}`),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_COMPLETED,g),this.participantOperationHandler.resolvePendingOperation(5,m.participant.id,void 0,S);else{const v=m.transactionEnd.reason;this.logger.info(`[${S}]Update participant interpretation state failed for: ${this.piiUtils.scrubMriOrOmit(m.participant.id)} reason : ${getPrintableObject(v)}`);const C=this.getCallEndGivenParticipantFailure(v);this.signalingSession.telemetryHelper.recordIncomingEvent(Li.UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_FAILED,g,C),this.participantOperationHandler.rejectPendingOperation(5,m.participant.id,C.phrase,C,S)}}areParticipantsConnectedToCall(g){this.logger.info(`areParticipantsConnectedToCall : ${getPrintableObject(g)}`);const m=this.getCurrentParticipantsInCallModality(!0);for(const S of g)if(!m.hasOwnProperty(S))return this.logger.info(`areParticipantsConnectedToCall : returning false for :${this.piiUtils.scrubMriOrOmit(S)}`),{result:!1,participant:S};return this.logger.info("areParticipantsConnectedToCall : returning true"),{result:!0}}processUnmuteInfo(g){if(void 0===g||void 0===g.muteUnmuteResponse)return;const m=g.muteUnmuteResponse[this.localParticipant.id];if(void 0===m)return;const S=Sn.find(m,(g=>g.participantId===this.localParticipant.participantId));void 0!==S&&("success"===S.reason?this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_UNMUTE_SUCCESS,S.serverMuteVersion):this.signalingSession.telemetryHelper.recordEvent(Li.HANDLE_UNMUTE_FAILURE,S.serverMuteVersion))}muteUnmute(g,m,S,v,C,_){assert2(2!==this.signalingSession.callMode,"mute/unmute operations are not allowed in streaming mode"),this.logger.info(`[muteUnmute][${C}][operation=${g}]`),v?(_&&this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UNMUTE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(Li.UNMUTE_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UNMUTE);const g=new Error("timed out waiting for response to request");g.endCode={code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UNMUTE_REQUEST_TIMEOUT,phrase:Di.CALL_END_PHRASE.UNMUTE_REQUEST_TIMEOUT},S.reject(g)}}),Di.TIMEOUT_VALUES_IN_SECONDS.UNMUTE_TIMEOUT),this.signalingSession.http.sendPostRequest({url:v,payload:m,requestName:g,withoutTrouter:!0,causeId:C}).then((m=>{this.disposed||(g===Fi.UNMUTE.name&&m.response&&this.processUnmuteInfo(m.response),this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()&&(g===Fi.UNMUTE_SYNC.name&&m.response&&S.resolve(m.response),g!==Fi.MUTE_ALL_SYNC.name&&g!==Fi.MUTE_SPECIFIED_SYNC.name||!m.response||S.resolve(m.response)),S.resolve())})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${C}][muteUnmute][failed][reason=${getPrintableObject(m)}]`),this.disposed||(_&&this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UNMUTE),S.reject(m.error))}))):S.reject(new Error(`[${C}][muteUnmute] cannot be performed now, the link is not yet available`))}sendNetworkRequestForUpdatingMeetingRoles(g,m,S,v,C,_){if(!S){const g=`[${C}][sendNetworkRequestForUpdatingMeetingRoles] failed because correct updateMeetingRoleUrl is not provided`;new Error(g).endCode={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),_.reject()}if(!g){const g=`[${C}][sendNetworkRequestForUpdatingMeetingRoles] failed because participants list is empty or null`,m=new Error(g);m.endCode={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),_.reject(m)}const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(Li.UPDATE_MEETING_ROLE,{causeId:C}),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE);const g=new Error(`[${C}] Timed out waiting for response to request`);g.endCode={code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_TIMEOUT,phrase:Di.CALL_END_PHRASE.UPDATE_MEETING_ROLE_TIMEOUT},_.reject(g)}}),Di.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_ROLE_TIMEOUT)};this.signalingSession.http.sendPostRequest({url:S,payload:getPayload22(this.signalingSession,g,"specified",m),requestName:v,onceTrouterReady:onceTrouterReady,causeId:C}).then((g=>{_.resolve(g.response)})).catch((g=>{const m=getPrintableObject(g);this.logger.info(`[${C}][sendNetworkRequestForUpdatingMeetingRoles] failed: ${m}`);const S=new Error(`[${C}][CS response] Forbidden request`),v=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);S.code=v.error.code,S.subCode=v.error.subCode,S.phrase=v.error.phrase,this.disposed||(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE),_.reject(S))}))}sendNetworkRequestForNudgingParticipants(g,m,S,v,C,_,E){if(m){const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Li.NUDGE_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,g?g.join():""))}),Di.TIMEOUT_VALUES_IN_SECONDS.NUDGE_PARTICIPANT_TIMEOUT,g?g.join():"")},T=_||C?getPayload16(this.signalingSession,g,C,_,E,v):getPayload17(this.signalingSession,g,v);return this.signalingSession.http.sendPostRequest({url:m,payload:T,requestName:Fi.NUDGE_PARTICIPANT.name,onceTrouterReady:onceTrouterReady,causeId:S}).then((()=>{})).catch((m=>{const v=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${S}][sendNetworkRequestForNudgingParticipant][failed][reason=${getPrintableObject(v)}]`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,g?g.join():""),Promise.reject(v.error)}))}return this.logger.info(`[${S}][sendNetworkRequestForNudgingParticipant] failed because correct nudgeParticipantUrl is not provided`),Promise.reject("Missing nudgeParticipant url")}sendNetworkRequestForAddingParticipant(g,m,S,v=causeId2()){if(m){let C=Fi.ADD_PARTICIPANT.name,_=Li.ADD_PARTICIPANT_TIMEOUT,E={};switch(S.replacementType){case 2:C=Fi.ADD_PARTICIPANT_WITH_PICKUP_CODE.name,_=Li.ADD_PARTICIPANT_WITH_PICKUP_CODE_TIMEOUT,E.unparkContent={pickupCode:S.pickupCode};break;case 1:C=Fi.ADD_PARTICIPANT_WITH_REPLACES.name,_=Li.ADD_PARTICIPANT_WITH_REPLACES_TIMEOUT,E=this.signalingSession.getCallReplacementDetailsForCall(S.callIdToReplace,v);break;case 3:C=Fi.ADD_PARTICIPANT_WITH_REPLACES.name,_=Li.ADD_PARTICIPANT_WITH_REPLACES_TIMEOUT,E=this.signalingSession.getReplacementDetailsByParticipantLegOfCall(S.callIdToReplace,g[0].id,g[0].replacementParticipantId,v);break;default:C=Fi.ADD_PARTICIPANT.name,_=Li.ADD_PARTICIPANT_TIMEOUT,E=null}const onceTrouterReady=()=>{g.forEach((g=>{const m=3===S.replacementType?g.participantId:g.id;this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(_,{causeId:v}),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,m),this.participantOperationHandler.rejectPendingOperation(0,m,"timed out waiting for participant to show up in roster",{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Di.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},v))}),Di.TIMEOUT_VALUES_IN_SECONDS.ADD_PARTICIPANT_TIMEOUT,m)}))},T=S.threadId||S.groupId?getPayload11(this.signalingSession,g,S,E):getPayload12(this.signalingSession,g,S,E);this.signalingSession.http.sendPostRequest({url:m,payload:T,requestName:C,onceTrouterReady:onceTrouterReady,causeId:v}).catch((m=>{const C=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${v}][sendNetworkRequestForAddingParticipant] failed:${getPrintableObject(m)}`),this.disposed||g.forEach((g=>{const _=3===S.replacementType?g.participantId:g.id;this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,_),this.participantOperationHandler.rejectPendingOperation(0,_,m,C.error,v)}))}))}else this.logger.info(`[${v}][sendNetworkRequestForAddingParticipants] failed because correct addParticipantUrl is not provided`),g.forEach((g=>{const m=3===S.replacementType?g.participantId:g.id;this.participantOperationHandler.rejectPendingOperation(0,m,"correct addParticipantUrl is not provided",{code:Di.CALL_END_CODE.LOCAL_ERROR,subCode:Di.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Di.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},v)}))}sendNetworkRequestToUpdateParticipantInterpretationState(g,m,S,v=causeId2()){if(m){const C=Fi.UPDATE_PARTICIPANT_INTERPRETATION_STATE.name,_=Li.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT,onceTrouterReady=()=>{const m={code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT,phrase:Di.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT};g.forEach((g=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.logger.info(`[${v}][sendNetworkRequestToUpdateParticipantInterpretationState] timed out`),this.signalingSession.telemetryHelper.recordEvent(_,{causeId:v}),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,g.id),this.participantOperationHandler.rejectPendingOperation(5,g.id,"timed out waiting to update particiant interpretation state",m,v))}),Di.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT,g.id)}))},E=getUpdateParticipantInterpretationStatePayload(this.signalingSession,S,v);this.signalingSession.http.sendPostRequest({url:m,payload:E,requestName:C,onceTrouterReady:onceTrouterReady,causeId:v}).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${v}][sendNetworkRequestToUpdateParticipantInterpretationState] failed:${getPrintableObject(m)}`),this.disposed||g.forEach((g=>{this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,g.id),this.participantOperationHandler.rejectPendingOperation(5,g.id,m,S.error,v)}))}))}else{this.logger.info(`[${v}][sendNetworkRequestToUpdateParticipantInterpretationState] failed because correct updateParticipantUrl is not provided`);const m={code:Di.CALL_END_CODE.LOCAL_ERROR,subCode:Di.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Di.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING};g.forEach((g=>{this.participantOperationHandler.rejectPendingOperation(5,g.id,"correct updateParticipantUrl is not provided",m,v)}))}}sendNetworkRequestForCallMeBack(g,m,S){if(m){const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.CALL_ME_BACK,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Li.CALL_ME_BACK_TIMEOUT,{causeId:S}),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.CALL_ME_BACK,g.id),this.participantOperationHandler.rejectPendingOperation(2,g.id,"timed out waiting for call me back success response",{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Di.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},S))}),Di.TIMEOUT_VALUES_IN_SECONDS.CALL_ME_BACK_TIMEOUT,g.id)},v={groupId:this.signalingSession.groupId,threadId:this.signalingSession.threadId,messageId:this.signalingSession.teamsMessageId};this.signalingSession.http.sendPostRequest({url:m,payload:getPayload11(this.signalingSession,[g],v),requestName:Fi.CALL_ME_BACK.name,onceTrouterReady:onceTrouterReady,causeId:S}).catch((m=>{const v=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][sendNetworkRequestForCallMeBack] failed: ${getPrintableObject(v)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.CALL_ME_BACK,g.id),this.participantOperationHandler.rejectPendingOperation(2,g.id,m,v.error,S))}))}else this.logger.info(`[${S}][sendNetworkRequestForCallMeBack] failed because correct addParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(2,g.id,"correct addParticipantUrl is not provided",{code:Di.CALL_END_CODE.LOCAL_ERROR,subCode:Di.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Di.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},S)}sendNetworkRequestForAdmittingParticipant(g,m,S){if(m){const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Li.ADMIT_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(1,g.id,"timed out waiting for participant to show up in roster",{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Di.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},S))}),Di.TIMEOUT_VALUES_IN_SECONDS.ADMIT_PARTICIPANT_TIMEOUT,g.id)};this.signalingSession.http.sendPostRequest({url:m,payload:getPayload13(this.signalingSession,g,S),requestName:Fi.ADMIT_PARTICIPANT.name,onceTrouterReady:onceTrouterReady,causeId:S}).catch((m=>{const v=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][sendNetworkRequestForAdmittingParticipant][failed][reason=${getPrintableObject(v)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(1,g.id,m,v.error,S))}))}else this.logger.info(`[${S}][sendNetworkRequestForAdmittingParticipant] failed because correct admitParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(1,g.id,"correct admitParticipantUrl is not provided",{code:Di.CALL_END_CODE.LOCAL_ERROR,subCode:Di.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Di.CALL_END_PHRASE.ADMIT_PARTICIPANT_URL_MISSING},S)}getCurrentParticipantsInCallModality(g){const m={},S=[Di.PARTICIPANT_AUDIO_STATE.CONNECTED];return g||S.push(Di.PARTICIPANT_AUDIO_STATE.CONNECTING,Di.PARTICIPANT_AUDIO_STATE.RINGING),this.signalingSessionCallback.getRemoteParticipantCollection()?.forEach((g=>{S.some((m=>m===g.audioState))&&(m[g.mri]=!0)})),m}internalHandleRemoveParticipantFailure(g,m,S){if(this.participantOperationHandler.hasPendingOperation(3,g,S)){this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g),this.logger.info(`[${S}][internalHandleRemoveParticipantFailure] failed for ${this.piiUtils.scrubMriOrOmit(g)} reason ${getPrintableObject(m)}`);const v=this.getCallEndGivenParticipantFailure(m);this.participantOperationHandler.rejectPendingOperation(3,g,v.phrase,v,S)}}internalHandleCallMeBackSuccessHelper(g,m){if(this.participantOperationHandler.hasPendingOperation(2,g,m)){const S={id:g};return this.logger.info(`participant : ${this.piiUtils.scrubMriOrOmit(g)} was successfully added. Resolving CallMeBack request`),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.CALL_ME_BACK,g),this.participantOperationHandler.resolvePendingOperation(2,S.id,S,m),!0}return!1}internalHandleAddParticipantFailure(g,m=causeId2()){const S=g.body;if(S.participantInfos){S.participantInfos.forEach((S=>{const v=[S.participant.participantId],C=this.participantOperationHandler.getRnlMri(v,m)||S.participant.id;this.rejectAddParticipantFailure(C,S.transactionEnd,g,m)}))}else if(S.participants)for(const v of Object.keys(S.participants))this.rejectAddParticipantFailure(v,S.participants[v],g,m)}rejectAddParticipantFailure(g,m,S,v){const C=this.getCallEndGivenParticipantFailure(m);this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_ADD_PARTICIPANT_FAILURE,S,C),this.participantOperationHandler.hasPendingOperation(0,g,v)?(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,g),this.logger.info(`participantAdd failed for : ${this.piiUtils.scrubMriOrOmit(g)} reason : ${getPrintableObject(m)}`),this.participantOperationHandler.rejectPendingOperation(0,g,C.phrase,C,v)):this.participantOperationHandler.hasPendingOperation(2,g,v)&&(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.CALL_ME_BACK,g),this.logger.info(`callMeBack failed for : ${this.piiUtils.scrubMriOrOmit(g)} reason : ${getPrintableObject(m)}`),this.participantOperationHandler.rejectPendingOperation(2,g,C.phrase,C,v))}internalHandleAdmitParticipantSuccess(g,m){const S=g.body;for(const g of S.participants)this.participantOperationHandler.hasPendingOperation(1,g,m)&&(this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g),this.logger.info(`Admit participant success for : ${this.piiUtils.scrubMriOrOmit(g)}`),this.participantOperationHandler.resolvePendingOperation(1,g,void 0,m))}internalHandleAdmitParticipantFailure(g,m){const S=g.body;for(const v of Object.keys(S.participants))if(this.participantOperationHandler.hasPendingOperation(1,v,m)){this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,v);const C=S.participants[v];this.logger.info(`Admit participant failed for : ${this.piiUtils.scrubMriOrOmit(v)} reason : ${getPrintableObject(C)}`);const _=this.getCallEndGivenParticipantFailure(C);this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_ADMIT_PARTICIPANT_FAILURE,g,_),this.participantOperationHandler.rejectPendingOperation(1,v,_.phrase,_,m)}}getCallEndGivenParticipantFailure(g){let m={code:g.code,subCode:g.subCode,phrase:g.phrase,resultCategories:g.resultCategories};return g.code===Di.CALL_END_CODE.CALL_MODALITY_FAILURE&&g.callControllerTransactionEnd?m={...g.callControllerTransactionEnd}:g.code===Di.CALL_END_CODE.ATC_CONTROLLER_FAILURE&&g.atcControllerTransactionEnd?m={...g.atcControllerTransactionEnd}:g.code===Di.CALL_END_CODE.CVA_CONTROLLER_FAILURE&&g.cvaControllerTransactionEnd&&(m={...g.cvaControllerTransactionEnd}),m}};function getPayload23(g,m){assertNotNull(g,"signalingSession cannot be null"),assertNotNullOrEmpty(m,"sendMessageOptions cannot be null or empty");const S=[];for(const v of m){const m=0===v.scope?"all":"specified",C=[];v.to&&Object.keys(v.to).forEach((g=>{v.to[g].participantLegIdMap?Object.keys(v.to[g].participantLegIdMap).forEach((m=>{C.push({id:g,level:v.to[g].level,endpointId:v.to[g].participantLegIdMap[m].endpointId,participantId:m})})):C.push({id:g,level:v.to[g].level})})),S.push({links:{sendMessageStatus:get(g,Mi.SEND_MESSAGE_STATUS)},operationId:v.operationId,payload:v.payload,scope:m,to:C,type:v.type})}return{payload:{from:{displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,id:g.participantManager.localParticipant.id,languageId:g.participantManager.localParticipant.languageId??"",participantId:g.participantManager.localParticipant.participantId},messageContent:S}}}function mapMriToResolveString(g,m){return`${g}-${m}`}function mapLegIdToResolveString(g,m){return`${g}-${m}`}function mapMriAndPropertyNameToResolveString(g,m,S){return`${g}_${m}_${S}`}var Tn=class{constructor(g){this.signalingSession=g,this.scopeAllOperations=new Map,this.mriOperations=new Map,this.legOperations=new Map,this.logger=g.logger.createChild((()=>"[ProxiedMessageNotificationManager]"))}sendProxiedMessageAsync(g,m,S){this.logger.createChild("sendProxiedMessageAsync",g).info(`Url: ${S}`);const v=[],C=[];for(const S of m)if(0!==S.scope){if(1===S.scope)for(const m in S.to)if("participant"===S.to[m].level){const _=mapMriToResolveString(m,S.operationId),E=defer2();this.mriOperations.set(_,E),v.push(E.promise),C.push(_),this.startTimeout(g,"participant",_)}else if("endpoint"===S.to[m].level)for(const _ in S.to[m].participantLegIdMap){const m=mapLegIdToResolveString(_,S.operationId),E=defer2();this.legOperations.set(m,E),v.push(E.promise),C.push(m),this.startTimeout(g,"endpoint",m)}}else{const m=defer2();this.scopeAllOperations.set(S.operationId,m),v.push(m.promise),C.push(S.operationId),this.startTimeout(g,"all",S.operationId)}return this.sendProxiedMessageNetworkRequest(g,m,S,C),v}sendProxiedMessageNetworkRequest(g,m,S,v){const C=getPayload23(this.signalingSession,m),_=this.logger.createChild("sendProxiedMessageNetworkRequest",g);_.info(`Url: ${S}`),this.signalingSession.http.sendPostRequest({url:S,requestName:Fi.SEND_PROXIED_MESSAGE.name,payload:C,causeId:g}).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);if(_.info(`failed:${getPrintableObject(m)}`),this.signalingSession.disposed)_.info("signaling session is already disposed.");else for(const m of v){this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,m);let v=null;this.scopeAllOperations.has(m)?(v=this.scopeAllOperations.get(m),this.scopeAllOperations.delete(m)):this.mriOperations.has(m)?(v=this.mriOperations.get(m),this.mriOperations.delete(m)):this.legOperations.get(m)?(v=this.legOperations.get(m),this.legOperations.delete(m)):_.warn(`could not find resolveString:${m} to reject it.`),null!==v&&v.reject({transactionEnd:S.error,causeId:g,resolveString:m})}}))}startTimeout(g,m,S){const v=this.logger.createChild("startTimeout",g);v.info(`Creating timeout for level ${m} message with resolveString ${S}`),this.signalingSession.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,(()=>{this.signalingSession.telemetryHelper.recordEvent(Li.SEND_MESSAGE_TIMEOUT,{causeId:g,resolveString:S}),v.info(`timed out waiting for level [${m}] message with resolveString [${S}]`),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,S);const C="all"===m?this.scopeAllOperations:"participant"===m?this.mriOperations:"endpoint"===m?this.legOperations:null;null!==C?C.has(S)?(C.get(S).reject({transactionEnd:{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.CONVERSATION_NOTIFICATION_TIMEOUT,phrase:Di.CALL_END_PHRASE.CONVERSATION_NOTIFICATION_TIMEOUT},causeId:g,resolveString:S}),C.delete(S)):v.warn(`Could not find resolveString [${S}] on map for ${m}. Will not reject promise.`):v.warn(`Could not find a operations map for ${m}. Will not reject promise.`)}),Di.TIMEOUT_VALUES_IN_SECONDS.SEND_MESSAGE_COMPLETION_TIMEOUT,S)}handleProxiedMessageNotificationItem(g,m,S){if(m.info(`Message contains ${g.participantInfos?.length} participantInfos.`),0===this.scopeAllOperations.size&&0===this.mriOperations.size&&0===this.legOperations.size)return void m.info("Received statusMessage but there is no pending operation.");const v=g.operationId;if(this.scopeAllOperations.has(v)){m.info(`Scope all resolveString:${v}`),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,v);const g={transactionEnd:{code:0,subCode:0,phrase:""},causeId:S,resolveString:v};return this.scopeAllOperations.get(v).resolve(g),this.scopeAllOperations.delete(v),void this.signalingSession.telemetryHelper.recordEvent(Li.SEND_MESSAGE_COMPLETION,{causeId:S,operationId:v,level:"all"})}for(const C of g.participantInfos){const g=0===C.transactionEnd?.code,_=mapMriToResolveString(C.participant.id,v),E=mapLegIdToResolveString(C.participant.participantId,v);if(_&&this.mriOperations.has(_)){m.info(`Scope mri resolveString:${_}`);const E={transactionEnd:C.transactionEnd,causeId:S,resolveString:_};g?this.mriOperations.get(_).resolve(E):this.mriOperations.get(_).reject(E),this.mriOperations.delete(_),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,_),this.signalingSession.telemetryHelper.recordEvent(Li.SEND_MESSAGE_COMPLETION,{causeId:S,operationId:v,level:"mri"})}else if(E&&this.legOperations.has(E)){m.info(`Scope legId resolveString:${E}`);const _={transactionEnd:C.transactionEnd,causeId:S,resolveString:E};g?this.legOperations.get(E).resolve(_):this.legOperations.get(E).reject(_),this.legOperations.delete(E),this.signalingSession.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,E),this.signalingSession.telemetryHelper.recordEvent(Li.SEND_MESSAGE_COMPLETION,{causeId:S,operationId:v,level:"leg"})}else m.warn(`Could not map this participantInfo to any pending operation operationId:${v}`)}}handleProxiedMessageNotification(g){const m=extractCauseIdFromMessage(g),S=this.logger.createChild("handleProxiedMessageNotification",m);let v;v=Array.isArray(g.body?.statuses)?g.body.statuses:[g.body],S.info(`Received ${v.length} proxied message notification(s).`);for(const g of v)this.handleProxiedMessageNotificationItem(g,S,m)}};function getPayload24(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"broadcastContext cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},broadcast:m,links:{addModalitySuccess:get(g,Mi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Mi.CONV_ADD_MODALITY_FAILURE)}}}}function getPayload25(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},links:{admitAllStatus:get(g,Mi.CONV_ADMIT_ALL_STATUS)},operationId:m,debugContent:{causeId:m}}}}function getPayload26(g,m,S=!0){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"joinUrl cannot be null");const v={type:"Delta",rosterUpdate:get(g,Mi.CONV_ROSTER_UPDATE)},C=g.getEndpointCapabilities(),_={payload:{attach:{requireMediaContent:S,links:{end:get(g,Mi.END)},locationContent:g.getLocationContent(),networkContent:g.getNetworkContent(),areaContent:g.getAreaContent()},capabilities:null,endpointCapabilities:C,additionalActions:[{input:{capabilities:null,endpointCapabilities:C,conversationRequest:{applicationType:g.participantManager.localParticipant.applicationType,roster:v,links:{conversationEnd:get(g,Mi.CONV_END),conversationUpdate:get(g,Mi.CONV_UPDATE),localParticipantUpdate:get(g,Mi.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:get(g,Mi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Mi.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:get(g,Mi.RECEIVE_MESSAGE)}},endpointMetadata:g.endpointMetadata,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}},name:"join",url:m,waitForResponse:!0}]}};return g.signalingAgentConfig.ecsEtag&&(_.payload.debugContent={ecsEtag:g.signalingAgentConfig.ecsEtag}),_.payload.additionalActions.length>0&&g.deviceType&&"default"!==g.deviceType&&(_.payload.additionalActions[0].input.conversationRequest.deviceType=g.deviceType),_}function getPayload27(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{callAcceptanceAcknowledgement:{links:{mediaRenegotiation:get(g,Mi.MEDIA_RENEGOTIATION),transfer:get(g,Mi.TRANSFER),replacement:get(g,Mi.REPLACE),balanceUpdate:get(g,Mi.BALANCE_UPDATE),retargetCompletion:get(g,Mi.RETARGET_COMPLETION),controlVideoStreaming:get(g,Mi.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:get(g,Mi.UPDATE_MEDIA_DESCRIPTIONS)}}}}}function getPayload28(g,m,S,v){assertNotNull(g,"signalingSession cannot be null");const C=getMediaTypes(S);g.telemetryHelper.addOutgoingModalities(C);const _=g.getEndpointCapabilities();return{payload:{callAcceptance:{acceptedBy:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},acceptedCallModalities:C,capabilities:null,endpointCapabilities:_,clientEndpointCapabilities:0!==v?v:null,links:{mediaRenegotiation:get(g,Mi.MEDIA_RENEGOTIATION),transfer:get(g,Mi.TRANSFER),replacement:get(g,Mi.REPLACE),balanceUpdate:get(g,Mi.BALANCE_UPDATE),retargetCompletion:get(g,Mi.RETARGET_COMPLETION),controlVideoStreaming:get(g,Mi.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:get(g,Mi.UPDATE_MEDIA_DESCRIPTIONS)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),mediaContent:m,pstnContent:g.pstnContent,callKeepAliveInterval:null}}}}function getPayload29(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{callProgress:{sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},status:"ringing",phrase:"ringing"}}}}function getPayload30(g,m,S,v){assertNotNull(g,"signalingSession cannot be null");const C=g.participantManager.localParticipant;return{payload:{invitationRedirection:{target:{type:m,endpointType:v,id:S},sender:{id:C.id,endpointId:C.endpointId,participantId:C.participantId,languageId:C.languageId}}}}}function getPayload31(g,m,S){assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m);const v={payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,languageId:g.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Di.CALL_END_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:m}};return S&&m.code===Di.CALL_END_CODE.CANCEL&&(v.payload.callTransactionEnd.callQualityDiagnosticsInformation=S),v}function getPayload32(g,m,S,v){assertNotNull(g,"signalingSession cannot be null");let C=[];C=v.invitationType===Di.INVITATION_TYPE.NUDGE&&Array.isArray(v.participantsToNudge)?v.participantsToNudge.map((g=>({id:g}))):g.participantManager.getParticipantsToInitiateCallWith(),g.signalingAgentConfig.doHostlessCalling||assert2(C.length>0,"remoteParticipants need to be set before a call can be made");const _={type:"Delta",rosterUpdate:get(g,Mi.CONV_ROSTER_UPDATE)},E=g.groupId?{id:g.groupId}:null,T=g.threadId?{threadId:g.threadId,messageId:g.teamsMessageId||null}:null,I=g.contentSharingManager.getContentSharingInfoToStartSharing(),b=null===I?null:{identifier:I.contentIdentifier,subject:I.subject,sessionState:I.sessionState,sessionUpdateSequenceNumber:I.sequenceNumber,links:{sessionUpdate:get(g,Mi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Mi.CONV_CONTENT_SHARING_END)}},A=g.broadcastSession&&g.broadcastSession.getContext(),R=g.getEndpointCapabilities();1===C.length&&g.telemetryHelper.setCalleeType(C[0].id),g.numberOfOriginalInvitees=C.length;const P=[];C.forEach((m=>{const S={id:m.id};m.displayName&&(S.displayName=m.displayName),m.participantId&&(S.participantId=m.participantId),(v.callToVoicemail||g.transferContext&&g.transferContext.target&&"voicemail"===g.transferContext.target.endpointType)&&(S.endpointType="voicemail"),P.push(S)}));const M=g.transferContext?g.transferContext.transferor:null,w=g.transferContext?g.transferContext.transferContext:null,D={};v.callToVoicemail&&(v.voicemailResourcePath&&(D.localResourcePath=v.voicemailResourcePath),v.voicemailItemId&&(D.voicemailItemId=v.voicemailItemId));const O={payload:{conversationRequest:{conversationType:v.conversationType,subject:g.convSubject,suppressDialout:v.suppressDialout,applicationType:v.applicationType,targetApplicationType:v.targetApplicationType,roster:_,properties:{allowConversationWithoutHost:g.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:g.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:g.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:g.enableGroupCallMeetupGeneration},links:{conversationEnd:get(g,Mi.CONV_END),conversationUpdate:get(g,Mi.CONV_UPDATE),localParticipantUpdate:get(g,Mi.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:get(g,Mi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Mi.CONV_ADD_PARTICIPANT_FAILURE),addModalitySuccess:get(g,Mi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Mi.CONV_ADD_MODALITY_FAILURE),confirmUnmute:get(g,Mi.CONV_CONFIRM_UNMUTE),receiveMessage:get(g,Mi.RECEIVE_MESSAGE)}},broadcast:A,contentSharing:b,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,meetingRegistrationId:v.meetingRegistrationId,participantPin:v.participantPin},to:P},capabilities:null,endpointCapabilities:R,clientEndpointCapabilities:v.clientEndpointCapabilities?v.clientEndpointCapabilities:null,endpointMetadata:g.endpointMetadata,groupContext:E,groupChat:T,meetingInfo:g.getMeetingInfo(),meetingData:v.meetingData,meetingPreferences:v.meetingPreferences,endpointState:v.endpointState}};if(v.publishedStates?.publishedStates.length>0){let m=[];m=v.publishedStates.publishedStates.map((m=>{let S={};try{S=JSON.parse(m.content)}catch(m){g.logger.warn("createConversationRequest getPayload() failed to parse state.content")}return{stateType:m.type,level:m.level,content:S,sequenceNumber:g.getPublishStateSequenceNumber()}})),O.payload.publishedStates=m}g.deviceType&&"default"!==g.deviceType&&(O.payload.conversationRequest.deviceType=g.deviceType);const N=getMediaTypes(S);if(g.telemetryHelper.addOutgoingModalities(N),O.payload.callInvitation={callModalities:N,replaces:null,transferor:M||null,clientTransferContext:w,links:{progress:get(g,Mi.PROGRESS),mediaAnswer:get(g,Mi.MEDIA_ANSWER),acceptance:get(g,Mi.ACCEPT),redirection:get(g,Mi.REDIRECTION),end:get(g,Mi.END)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),pstnContent:g.pstnContent,emergencyContent:g.getEmergencyContent(),mediaContent:m,voicemailSettings:D,routingFlags:v.routingFlags,invitationData:v.invitationData,locationContent:g.getLocationContent(),networkContent:g.getNetworkContent(),areaContent:g.getAreaContent()},v.pickupCode&&(O.payload.callInvitation.unparkContent={pickupCode:parseInt(v.pickupCode,10)}),v.onBehalfOf&&(O.payload.callInvitation.onBehalfOf={id:v.onBehalfOf},v.onBehalfOfUserDisplayName&&(O.payload.callInvitation.onBehalfOf.displayName=v.onBehalfOfUserDisplayName)),v.scenario&&(O.payload.conversationRequest.scenario=v.scenario),v.alternateId&&(O.payload.participants.from.alternateId=v.alternateId),v.invitationType===Di.INVITATION_TYPE.NUDGE&&(O.payload.participants.invitationType=v.invitationType),g.signalingAgentConfig.ecsEtag&&(O.payload.debugContent={ecsEtag:g.signalingAgentConfig.ecsEtag}),v.clientEndpointDebugContent){O.payload.debugContent||(O.payload.debugContent={});try{O.payload.debugContent.clientDebugContent=JSON.parse(v.clientEndpointDebugContent)}catch(g){assert2(!1,`Failed to parse ${v.clientEndpointDebugContent}`)}}return O}function getPayload33(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Di.CALL_END_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED},callTransactionEnd:m}}}function getPayload34(g,m){return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:m}}}function getPayload35(g,m,S,v,C){assertNotNull(g,"signalingSession cannot be null");const _={type:"Delta",rosterUpdate:get(g,Mi.CONV_ROSTER_UPDATE)},E=g.getEndpointCapabilities(),T=g.groupId?{id:g.groupId}:null,I=g.threadId?{threadId:g.threadId,messageId:g.teamsMessageId||null}:null,b={payload:{conversationRequest:{conversationType:v.conversationType,subject:g.convSubject,suppressDialout:v.suppressDialout,scenario:v.scenario,applicationType:v.applicationType,roster:_,properties:{allowConversationWithoutHost:g.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:g.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:g.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:g.enableGroupCallMeetupGeneration},links:{conversationEnd:get(g,Mi.CONV_END),conversationUpdate:get(g,Mi.CONV_UPDATE),localParticipantUpdate:get(g,Mi.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:get(g,Mi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Mi.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:get(g,Mi.RECEIVE_MESSAGE)}},groupContext:T,groupChat:I,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,meetingRegistrationId:v.meetingRegistrationId,participantPin:v.participantPin}},capabilities:null,endpointCapabilities:E,clientEndpointCapabilities:v.clientEndpointCapabilities?v.clientEndpointCapabilities:null,endpointMetadata:g.endpointMetadata,meetingInfo:g.getMeetingInfo(),meetingData:v.meetingData,meetingPreferences:v.meetingPreferences,endpointState:v.endpointState}};if(v.publishedStates?.publishedStates.length>0){let m=[];m=v.publishedStates.publishedStates.map((m=>{let S={};try{S=JSON.parse(m.content)}catch(m){g.logger.warn("joinConversationRequest getPayload() failed to parse state.content")}return{stateType:m.type,level:m.level,content:S,sequenceNumber:g.getPublishStateSequenceNumber()}})),b.payload.publishedStates=m}if(v?.applyServerMute&&(b.payload.participants.from.applyServerMute=v.applyServerMute.value,v.applyServerMute.mediaTypes&&(b.payload.participants.from.mediaTypes=v.applyServerMute.mediaTypes)),g.deviceType&&"default"!==g.deviceType&&(b.payload.conversationRequest.deviceType=g.deviceType),!v.subscribe){const C=getMediaTypes(S);g.telemetryHelper.addOutgoingModalities(C),b.payload.callInvitation={callModalities:C,replaces:null,transferor:null,links:{progress:get(g,Mi.PROGRESS),mediaAnswer:get(g,Mi.MEDIA_ANSWER),acceptance:get(g,Mi.ACCEPT),redirection:get(g,Mi.REDIRECTION),end:get(g,Mi.END)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),mediaContent:m,pstnContent:g.pstnContent,locationContent:g.getLocationContent(),networkContent:g.getNetworkContent(),areaContent:g.getAreaContent(),sharedLineCallInvitationContent:v.sharedLineCallInvitationContent,invitationData:v.invitationData}}if(g.signalingAgentConfig.ecsEtag&&(b.payload.debugContent={ecsEtag:g.signalingAgentConfig.ecsEtag}),C&&(b.payload.debugContent||(b.payload.debugContent={}),b.payload.debugContent.causeId=C),v.clientEndpointDebugContent){b.payload.debugContent||(b.payload.debugContent={});try{b.payload.debugContent.clientDebugContent=JSON.parse(v.clientEndpointDebugContent)}catch(g){assert2(!1,`Failed to parse ${v.clientEndpointDebugContent}`)}}return b}function getJoinMeetingGroupPayload(g,m,S){assertNotNull(g,"signalingSession cannot be null");const{meetingGroupId:v,groupPreferences:C}=m;return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},meetingGroup:v,...C&&{groupPreferences:C},links:{joinMeetingGroupStatus:get(g,Mi.JOIN_MEETING_GROUP_STATUS)},operationId:S}}}function getPayload36(g,m,S,v){assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m);const C={payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:v&&"all"!==v?void 0:v},conversationTransactionEnd:{reason:"noError",code:Di.CALL_END_CODE.SUCCESS,phrase:Di.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:m}};return S&&m.code===Di.CALL_END_CODE.CANCEL&&(C.payload.callTransactionEnd.callQualityDiagnosticsInformation=S),C}function getLeaveMeetingGroupPayload(g,m,S){assertNotNull(g,"signalingSession cannot be null");const{meetingGroupId:v}=m;return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},meetingGroup:v,links:{leaveMeetingGroupStatus:get(g,Mi.LEAVE_MEETING_GROUP_STATUS)},operationId:S}}}function getPayload37(g,m,S){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(S,"newOfferLink cannot be null"),{payload:{mediaOfferRequirements:{compatibleContentTypes:m,links:{offerReady:get(g,Mi.NEW_MEDIA_OFFER)}}}}}function getPayload38(g,m){return assertNotNull(m,"signalingSession cannot be null"),{payload:{callTransfer:{target:{id:m.participantManager.localParticipant.id},transferor:{details:{id:m.participantManager.localParticipant.id,endpointId:m.participantManager.localParticipant.endpointId,participantId:m.participantManager.localParticipant.participantId,languageId:m.participantManager.localParticipant.languageId},authorizationToken:null},parkType:g,links:{transferAcceptance:get(m,Mi.TRANSFER_ACCEPTANCE),transferCompletion:get(m,Mi.TRANSFER_COMPLETION)}}}}}function getPayload39(g,m,S){assertNotNull(g,"ParkRequestPayload: signalingSession cannot be null");const v={payload:{hold:{holdType:m,links:{holdCompletion:get(g,Mi.PARK_COMPLETION)}}}};return S&&(v.payload.debugContent=S),v}function getPayload40(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{callParticipantUpdate:{links:getLinksPayload(g,Ri),clientContentForMediaController:g.webRtcSignalingManager.getClientUrls()}}}}function getPayload41(g,m,S,v,C,_){const E={payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},publishedState:{content:v,level:S,stateType:m,sequenceNumber:g.getPublishStateSequenceNumber()},scope:C}};if(_&&_.length>0){const g=_.map((g=>({id:g})));E.payload.to=g}return E}function getPayload42(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{callEnd:m}}}function getPayload43(g,m,S,v){const C={from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},sequenceNumber:g.getPublishStateSequenceNumber(),scope:m};return"specified"===m?C.stateIds=S:C.stateType=v,{payload:C}}function getPayload44(g,m){return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},searchOptions:m}}}function getPayload45(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},...m,links:{setMeetingLayoutStatus:get(g,Mi.SET_MEETING_LAYOUT_STATUS)}}}}function getPayload46(){return{payload:{transferAcceptance:{}}}}function getPayload47(g,m,S,v,C){assertNotNull(m,"signalingSession cannot be null"),assertNotNullOrEmpty(g,"transferTarget cannot be null OR empty");return{payload:{callTransfer:{target:{id:g,endpointType:"TransferTypeVoicemail"===v?"voicemail":void 0},transferor:{details:{id:m.participantManager.localParticipant.id,endpointId:m.participantManager.localParticipant.endpointId,participantId:m.participantManager.localParticipant.participantId,languageId:m.participantManager.localParticipant.languageId},authorizationToken:null},links:{transferAcceptance:get(m,Mi.TRANSFER_ACCEPTANCE),transferCompletion:get(m,Mi.TRANSFER_COMPLETION)},replacementDetails:S,disableForwardingAndUnanswered:C&&C.disableForwardingAndUnanswered,transferContext:C&&C.clientTransferContext}}}}function getPayload48(g){return{payload:{transferCompletion:g}}}function getPayload49(g,m){assertNotNull(g,"ResumePayload: signalingSession cannot be null");const S={payload:{resume:{links:{resumeCompletion:get(g,Mi.UNPARK_COMPLETION)}}}};return m&&(S.payload.debugContent=m),S}function getPayload50(g,m){return assertNotNull(m,"clientMetadataJson cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},endpointMetadata:m}}}function getPayload51(g,m,S,v){assertNotNull(m,"clientStateJson cannot be null");const C={payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},endpointState:m}};if(S?.publishedStates.length>0){let m=[];m=S.publishedStates.map((m=>{let S={};try{S=JSON.parse(m.content)}catch(m){g.logger.warn("updateEndpointState getPayload() failed to parse stateType.content")}return{stateType:m.type,level:m.level,content:S,sequenceNumber:g.getPublishStateSequenceNumber()}})),C.payload.publishedStates=m}return v&&(C.payload.links={updateEndpointStateStatus:get(g,Mi.DISABLE_PREHEAT_ASYNC_STATUS)}),C}function getMeetingGroupsPayload(g,m,S){assertNotNull(g,"signalingSession cannot be null");const{scope:v,toGroup:C,fromGroup:_,participants:E}=m;"specified"===v&&assertNotNull(E,"participantsIds cannot be null");const T={from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},scope:v,fromGroup:_,toGroup:C,links:{updateMeetingGroupsStatus:get(g,Mi.UPDATE_MEETING_GROUPS_STATUS)},operationId:S};return E&&(T.to=E.map((g=>({id:g.mri,endpointId:g.endpointId,participantId:g.participantId})))),{payload:T}}function getPayload52(g,m,S){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},meetingLiveState:m,links:{updateMeetingLiveStateStatus:get(g,Mi.UPDATE_MEETING_LIVE_STATE_STATUS)},operationId:S}}}function getPayload53(g,m){const S={};return void 0!==m.allowRaiseHands&&(S.allowRaiseHands=m.allowRaiseHands),void 0!==m.attendeeRestrictions&&(S.attendeeRestrictions=m.attendeeRestrictions),void 0!==m.lockMeeting&&(S.lockMeeting=m.lockMeeting),void 0!==m.breakoutRoomsEnabled&&(S.breakoutRoomsEnabled=m.breakoutRoomsEnabled),void 0!==m.allowPresentersToManageBreakoutRooms&&(S.allowPresentersToManageBreakoutRooms=m.allowPresentersToManageBreakoutRooms),void 0!==m.disableMdpClientAudioRecording&&(S.disableMdpClientAudioRecording=m.disableMdpClientAudioRecording),void 0!==m.refreshSettings&&(S.refreshSettings=m.refreshSettings),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},meetingSettings:S,sequenceNumber:g.getPublishStateSequenceNumber()}}}function getPayload54(g){assertNotNull(g,"signalingSession cannot be null");const m={type:"Delta",rosterUpdate:get(g,Pi.CONV_ROSTER_UPDATE)};return{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},roster:m,links:getLinksPayload(g,Pi)}}}function getUpdateParticipantsPropertiesPayload(g,m,S){assertNotNull(g,"signalingSession cannot be null");return{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId},to:m,links:{updateParticipantPropertiesStatus:get(g,Mi.UPDATE_PARTICIPANT_PROPERTIES_STATUS)},operationId:S}}}function getPayload55(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{mediaAnswer:{sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},mediaContent:m,pstnContent:g.pstnContent}}}}function getPayload56(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{UpdateMediaDescriptions:{mediaDescriptions:m}}}}function getPayload57(g,m,S){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},meetingStates:m,updateMeetingStatesStatus:get(g,Mi.UPDATE_MEETING_STATES_STATUS),operationId:S}}}var In=__toESM(P),bn=__toESM(Te()),An=class{constructor(g,m){this.signalingSession=g,this.logger=m,this.logConversationCallModalityEvent=g=>{const m=this.createCallModalityEvent(g);this.logger.info("sending modality telemetry:",this.getStringifiedEventData(m)),m.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(xi.EVENT_TYPE.CONVERSATION_CALL_MODALITY,m)},this.logConversationContentSharingEvent=g=>{g[xi.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,g[xi.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,this.logger.info("sending content sharing telemetry:",this.getStringifiedEventData(g)),g.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(xi.EVENT_TYPE.CONVERSATION_CONTENT_SHARING,g)},this.logHttpTelemetryEvent=g=>{g[xi.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,g[xi.SIGNALING_CONFIG]=this.getSignalingAgentConfig(),this.logger.info("sending http telemetry:",this.getStringifiedEventData(g)),g.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(xi.EVENT_TYPE.CONVERSATION_HTTP_REQUEST,g)},this.getHostDomainInfo=()=>"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>",this.getSignalingAgentConfig=()=>{const g=[],m=this.signalingSession.signalingAgentConfig;return m.supportsCompressedServicePayload&&g.push(xi.SIGNALING_CONFIG_FLAGS.SUPPORTS_COMPRESSED_PAYLOAD),m.brokerEnabledOutgoing&&g.push(xi.SIGNALING_CONFIG_FLAGS.BROKER_OUTGOING_ENABLED),m.brokerEnabledIncoming&&g.push(xi.SIGNALING_CONFIG_FLAGS.BROKER_INCOMING_ENABLED),m.brokerRequestBatching&&g.push(xi.SIGNALING_CONFIG_FLAGS.BROKER_REQUEST_BATCHING_ENABLED),m.brokerExclusively&&g.push(xi.SIGNALING_CONFIG_FLAGS.BROKER_EXCLUSIVELY_ENABLED),m.supportsSynchronousTrouterResponse&&g.push(xi.SIGNALING_CONFIG_FLAGS.SYNC_TROUTER_RESPONSE),m.handleMediaOfferFromPushNotification&&g.push(xi.SIGNALING_CONFIG_FLAGS.HANDLE_OFFER_FROM_NOTIFICATION),m.handleNewOfferRequest&&g.push(xi.SIGNALING_CONFIG_FLAGS.HANDLE_NEW_OFFER_REQUEST),m.sendProgressFromCC&&g.push(xi.SIGNALING_CONFIG_FLAGS.SEND_PROGRESS_FROM_CC),m.handleUnmuteMuteFromResponse&&g.push(xi.SIGNALING_CONFIG_FLAGS.HANDLE_UNMUTE_MUTE_FROM_RESPONSE),m.useInternalHttpDispatcher&&g.push(xi.SIGNALING_CONFIG_FLAGS.INTERNAL_HTTP_DISPATCHER),m.enableTokenCache&&g.push(xi.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_CACHE),m.enableTokenPrefetch&&g.push(xi.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_PREFETCH),m.supportMediaRetargetWhileIncomingRenegotiation&&g.push(xi.SIGNALING_CONFIG_FLAGS.SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION),m.enableCallEstablishmentTimeoutsForStartJoinCall&&g.push(xi.SIGNALING_CONFIG_FLAGS.ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL),m.enableTokenCacheForGenericTokenAPI&&g.push(xi.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API),m.enableLongOutgoing1To1SetupTimeoutForWeb&&g.push(xi.SIGNALING_CONFIG_FLAGS.ENABLE_LONG_OUTGOING_1TO1_SETUP),g.push(xi.SIGNALING_CONFIG_FLAGS.SERVER_MUTE_UNMUTE),g.join(",")},this.getStringifiedEventData=g=>{try{return JSON.stringify(g)}catch(g){return"invalid data"}},this.telemetryLogger=this.signalingSession.signalingAgentConfig.oneDsTelemetryLogger??this.signalingSession.signalingAgentConfig.telemetryManager}createCallModalityEvent(g){const m={};m.Type=xi.SOURCE.NGC_SOURCE;const setEventPropertyIfRecorded=(S,v=!1)=>{g.hasOwnProperty(S)&&(m[S]=v?JSON.stringify(g[S]):g[S])};if(m.ResultDetail=g[xi.EXTENSIONS.RESULT_DETAIL],m.ResultValue=g[xi.EXTENSIONS.RESULT_VALUE],m.ResultCode=g[xi.EXTENSIONS.CALL_END_CODE],m.ResultCauseId=g[xi.EXTENSIONS.RESULT_CAUSE_ID],m[xi.SIGNALING_CONFIG]=this.getSignalingAgentConfig(),m[xi.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,m[xi.CONTEXT_ID.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,m[xi.CONTEXT_ID.ENDPOINT_ID]=g[xi.CONTEXT_ID.ENDPOINT_ID],m[xi.CONTEXT_ID.PARTICIPANT_ID]=g[xi.CONTEXT_ID.PARTICIPANT_ID],m[xi.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,m[xi.EXTENSIONS.CONVERSATION_SERVICE_URL]=g[xi.EXTENSIONS.CONVERSATION_SERVICE_URL],m[xi.EXTENSIONS.CALL_START_TIME]=JSON.stringify(g[xi.EXTENSIONS.CALL_START_TIME]),m[xi.EXTENSIONS.CALL_END_TIME]=JSON.stringify(g[xi.EXTENSIONS.CALL_END_TIME]),m[xi.EXTENSIONS.MESSAGING_CHANNEL]=JSON.stringify(g[xi.EXTENSIONS.MESSAGING_CHANNEL]),m[xi.EXTENSIONS.IS_GROUP_CALL]=this.signalingSession.multiParty?"true":"false",m[xi.EXTENSIONS.IS_HOSTLESS_CALL]=this.signalingSession.isHostLessCall?"true":"false",m[xi.EXTENSIONS.IS_CAST_CALL]=this.signalingSession.isCastCall?"true":"false",m[xi.EXTENSIONS.IS_HUDDLE_GROUP_CALL]=this.signalingSession.isHuddleGroupCall?"true":"false",m[xi.EXTENSIONS.IS_ON_BEHALF_OF_CALL]=this.signalingSession.onBehalfOf?"true":"false",m[xi.EXTENSIONS.CLIENT_INFORMATION]=g[xi.EXTENSIONS.CLIENT_INFORMATION],m[xi.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION]=g[xi.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION],m[xi.EXTENSIONS.CALL_TERMINATING_END]=g[xi.EXTENSIONS.CALL_TERMINATING_END],m[xi.EXTENSIONS.CALL_END_CODE]=JSON.stringify(g[xi.EXTENSIONS.CALL_END_CODE]),m[xi.EXTENSIONS.CALL_END_SUB_CODE]=JSON.stringify(g[xi.EXTENSIONS.CALL_END_SUB_CODE]),setEventPropertyIfRecorded(xi.CONTEXT_ID.SHARED_CORRELATION_ID),setEventPropertyIfRecorded(xi.EXTENSIONS.DIRECTION),setEventPropertyIfRecorded(xi.EXTENSIONS.SELF_PARTICIPANT_ROLE),setEventPropertyIfRecorded(xi.EXTENSIONS.CONNECTED_DURATION_IN_MS,!0),setEventPropertyIfRecorded(xi.EXTENSIONS.TIME_TO_RING_IN_MS,!0),setEventPropertyIfRecorded(xi.EXTENSIONS.NETWORK_REQUESTS_COMPLETED),setEventPropertyIfRecorded(xi.EXTENSIONS.NETWORK_REQUESTS_PENDING),setEventPropertyIfRecorded(xi.EXTENSIONS.LOCAL_OPERATIONS_PERFORMED),setEventPropertyIfRecorded(xi.EXTENSIONS.EVENT_TIMESTAMP_BAG),setEventPropertyIfRecorded(xi.EXTENSIONS.ROSTER_UPDATES_BAG),setEventPropertyIfRecorded(xi.EXTENSIONS.NETWORK_REQUESTS_BAG),setEventPropertyIfRecorded(xi.EXTENSIONS.TROUTER_WAIT_OPERATIONS),setEventPropertyIfRecorded(xi.EXTENSIONS.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS),setEventPropertyIfRecorded(xi.EXTENSIONS.OUTGOING_MODALITIES),setEventPropertyIfRecorded(xi.EXTENSIONS.INCOMING_MODALITIES),setEventPropertyIfRecorded(xi.EXTENSIONS.OFFERED_MODALITIES),setEventPropertyIfRecorded(xi.EXTENSIONS.ANSWERED_MODALITIES),setEventPropertyIfRecorded(xi.EXTENSIONS.VBSS_OPERATIONS),setEventPropertyIfRecorded(xi.EXTENSIONS.CALLER_TYPE),setEventPropertyIfRecorded(xi.EXTENSIONS.CALLEE_TYPE),setEventPropertyIfRecorded(xi.EXTENSIONS.SCENARIO),setEventPropertyIfRecorded(xi.EXTENSIONS.PREHEATED_CALL_SETUP_DURATION_IN_S),setEventPropertyIfRecorded(xi.EXTENSIONS.CALL_CANCELATION_DURATION_IN_S),setEventPropertyIfRecorded(xi.EXTENSIONS.IS_PREHEATED),setEventPropertyIfRecorded(xi.EXTENSIONS.ACS_RESOURCE_ID),setEventPropertyIfRecorded(xi.EXTENSIONS.CALL_END_RESULT_CATEGORIES),setEventPropertyIfRecorded(xi.EXTENSIONS.APPLICATION_TYPE),setEventPropertyIfRecorded(xi.EXTENSIONS.RING),setEventPropertyIfRecorded(xi.EXTENSIONS.REGION),setEventPropertyIfRecorded(xi.EXTENSIONS.PARTITION),setEventPropertyIfRecorded(xi.EXTENSIONS.JOINED_FROM),setEventPropertyIfRecorded(xi.EXTENSIONS.MEETING_URL),setEventPropertyIfRecorded(xi.EXTENSIONS.MEETING_CODE),setEventPropertyIfRecorded(xi.EXTENSIONS.USER_HEX_CID),setEventPropertyIfRecorded(xi.EXTENSIONS.BROADCAST_MEETING_ROLE),setEventPropertyIfRecorded(xi.EXTENSIONS.MEETING_ROLE),setEventPropertyIfRecorded(xi.EXTENSIONS.ADVANCED_MEETING_ROLE),setEventPropertyIfRecorded(xi.EXTENSIONS.PARTICIPANT_TYPE),setEventPropertyIfRecorded(xi.EXTENSIONS.AUDIO_ONLY_WATERMARK),setEventPropertyIfRecorded(xi.EXTENSIONS.TARGET_APPLICATION_TYPE),setEventPropertyIfRecorded(xi.EXTENSIONS.IS_REINVITELESS),setEventPropertyIfRecorded(xi.EXTENSIONS.CLIENT_TYPE),this.signalingSession.callType&&(m[xi.EXTENSIONS.CALL_TYPE]=this.signalingSession.callType),this.signalingSession.signalingAgentConfig.testCall&&(m[xi.EXTENSIONS.TEST_CONTEXT_ID]="Test"),this.signalingSession.groupId&&(m[xi.CONTEXT_ID.GROUP_ID]=scrubMriOrOmit(this.signalingSession.groupId)),this.signalingSession.threadId&&(m[xi.CONTEXT_ID.THREAD_ID]=getLoggableThreadId(this.signalingSession.threadId)),this.signalingSession.teamsMessageId&&(m[xi.CONTEXT_ID.TEAMS_MESSAGEID]=this.signalingSession.teamsMessageId),this.signalingSession.getMeetingInfo()){const g={...this.signalingSession.getMeetingInfo()};g.hasOwnProperty("organizerId")&&(g.organizerId=scrubMriOrOmit(g.organizerId)),m[xi.CONTEXT_ID.TEAMS_MEETINGINFO]=JSON.stringify(g)}return this.signalingSession.multiParty&&0===this.signalingSession.numberOfOriginalInvitees&&g.hasOwnProperty(xi.EXTENSIONS.SELF_PARTICIPANT_ROLE)&&g[xi.EXTENSIONS.SELF_PARTICIPANT_ROLE]===xi.ROLE.CALLER&&(m[xi.EXTENSIONS.IS_MEETUP_CALL]="true"),m}};function getLogger(g,m){return new An(g,m)}var Rn=class{constructor(g,m,S){this.signalingSession=g,this.callStartTime=S,this.networkRequestsCompleted=[],this.networkRequestsStarted={},this.networkRequests={},this.localOperationsPerformed=[],this.recordedEvents=[],this.rosterUpdates=[],this.contentSharingOperationsPerformed={},this.outgoingModalities=[],this.incomingModalities=[],this.offeredModalities="",this.answeredModalities="",this.vbssOperations=[],this.vbssStarted=!1,this.localOfferAnswerGenerationTimestamps=[],this.trouterWaitOperations=[],this.telemetryData={},this.contentSharingBaseTelemetryData={},this.httpRequestTelemetryData={},this.connectedStopWatch=null,this.preheatedCallSetupDurationWatch=null,this.callCancelationDurationWatch=null,this.timeToRingStopWatch=null,this.isSdpInCallNotification=!1,this.isPreheated=0,this.isReinviteless=0,this.addBrokerChannel=()=>{this.setMessagingChannel(xi.MESSAGING_CHANNEL.BROKER)},this.addTrouterChannel=()=>{this.setMessagingChannel(xi.MESSAGING_CHANNEL.TROUTER)},this.addTrouterWaitOperation=g=>{this.trouterWaitOperations.push(this.recordOperation(g))},this.recordIncomingEvent=(g,m,S)=>{const v=extractCauseIdFromMessage(m),C={origin:m.origin,causeId:v,data:S};S||delete C.data,this.recordEvent(g,C)},this.recordIncomingEventCount=g=>{this.localOperationsPerformed.push(this.recordOperation(g));const m=this.recordedEvents.findIndex((m=>m[g]));if(-1!==m)this.recordedEvents[m][g]+=1;else{const m={};m[g]=1,this.recordedEvents.push(m)}},this.recordEvent=(g,m)=>{this.logger.debug("Event:",g,m),this.localOperationsPerformed.push(this.recordOperation(g));const S={};S[g]=this.timeSinceCallStart(),m&&(S.data=m),this.recordedEvents.push(S)},this.recordRosterEvent=(g,m,S)=>{this.localOperationsPerformed.push(this.recordOperation(m));const v={data:g,causeId:S},C={eventName:this.timeSinceCallStart(),data:v};this.rosterUpdates.push(C)},this.addOutgoingModalities=g=>{g&&this.outgoingModalities.push(g)},this.addIncomingModalities=g=>{g&&this.incomingModalities.push(g)},this.setOfferedModalities=(g,m)=>{this.offeredModalities=this.sdpTelemetryFormat(g,m)},this.setAnsweredModalities=(g,m)=>{this.answeredModalities=this.sdpTelemetryFormat(g,m)},this.setIsSdpInCallNotification=g=>{this.isSdpInCallNotification=g},this.addVbssOperations=g=>{g&&(g===xi.VBSS_OPERATION.START?this.vbssStarted=!0:this.vbssStarted=!1,this.vbssOperations.push(this.recordOperation(g)))},this.addNetworkOperationStarted=g=>{tryAddNewKeyToHashTable(this.networkRequestsStarted,g,this.recordOperation(g))},this.addNetworkOperationCompleted=(g,m,S)=>{const v=m?xi.RESULT_VALUE.SUCCESS:xi.RESULT_VALUE.FAILURE,C=S?`${g}:${v}:${S}`:`${g}:${v}`;this.networkRequestsCompleted.push(this.recordOperation(C)),tryRemoveKeyFromHashTable(this.networkRequestsStarted,g)},this.updateNetworkRequest=g=>{this.networkRequests[g.uid]?In.assign(this.networkRequests[g.uid],g):this.networkRequests[g.uid]=g},this.deleteNetworkRequest=g=>{delete this.networkRequests[g.uid]},this.addContentSharingOperation=(g,m,S)=>{this.contentSharingOperationsPerformed[g]||(this.contentSharingOperationsPerformed[g]=[]);const v={[m]:this.timeSinceCallStart()};this.contentSharingOperationsPerformed[g].push(v);const C=this.contentSharingOperationsPerformed[g].length-1;return S&&this.updateContentSharingOperation(g,C,S),C},this.updateContentSharingOperation=(g,m,S)=>{if(!this.contentSharingOperationsPerformed[g])return;const v=this.contentSharingOperationsPerformed[g][m],C=[];for(const g of Object.keys(S))C.push(`${g}: ${S[g]}`);v.data=C.join(", ")},this.setDirection=g=>{this.telemetryData[xi.EXTENSIONS.DIRECTION]=g},this.setEndPointId=g=>{this.telemetryData[xi.CONTEXT_ID.ENDPOINT_ID]=g,this.contentSharingBaseTelemetryData[xi.CONTEXT_ID.ENDPOINT_ID]=g,this.httpRequestTelemetryData[xi.CONTEXT_ID.ENDPOINT_ID]=g},this.setParticipantId=g=>{this.telemetryData[xi.CONTEXT_ID.PARTICIPANT_ID]=g,this.contentSharingBaseTelemetryData[xi.CONTEXT_ID.PARTICIPANT_ID]=g,this.httpRequestTelemetryData[xi.CONTEXT_ID.PARTICIPANT_ID]=g},this.addTokenTelemetry=(g,m)=>{g?this.networkRequests?.[g]?(this.networkRequests[g].tokenTelemetries||(this.networkRequests[g].tokenTelemetries=[]),this.networkRequests[g].tokenTelemetries.push(m)):this.logger.info(`[addTokenTelemtry] httprequest: ${g} is not found in networkRequests`):this.logger.error("[addTokenTelemetry] httprequest uid is undefined")},this.setConversationServiceUrl=g=>{this.telemetryData[xi.EXTENSIONS.CONVERSATION_SERVICE_URL]=g},this.setMeetingInfo=g=>{g||(this.telemetryData[xi.EXTENSIONS.MEETING_INFO]=g)},this.setJoinedFrom=g=>{this.telemetryData[xi.EXTENSIONS.JOINED_FROM]=g},this.setMeetingCode=g=>{this.telemetryData[xi.EXTENSIONS.MEETING_CODE]=g},this.setMeetingUrl=g=>{this.telemetryData[xi.EXTENSIONS.MEETING_URL]=g},this.setBroadcastMeetingRole=g=>{this.telemetryData[xi.EXTENSIONS.BROADCAST_MEETING_ROLE]=g},this.setMeetingRole=g=>{this.telemetryData[xi.EXTENSIONS.MEETING_ROLE]=g},this.setAdvancedMeetingRole=g=>{this.telemetryData[xi.EXTENSIONS.ADVANCED_MEETING_ROLE]=g},this.setParticipantType=g=>{this.telemetryData[xi.EXTENSIONS.PARTICIPANT_TYPE]=g},this.setSelfParticipantRole=g=>{this.telemetryData[xi.EXTENSIONS.SELF_PARTICIPANT_ROLE]=g},this.setAudioOnlyWatermark=g=>{this.telemetryData[xi.EXTENSIONS.AUDIO_ONLY_WATERMARK]=g},this.setWatermarkSupport=g=>{this.telemetryData[xi.EXTENSIONS.CLIENT_SUPPORT_WATERMARK]=g},this.setScenario=g=>{this.telemetryData[xi.EXTENSIONS.SCENARIO]=g},this.setTargetApplicationType=g=>{g&&(this.telemetryData[xi.EXTENSIONS.TARGET_APPLICATION_TYPE]=g)},this.setCallerType=g=>{g&&(this.telemetryData[xi.EXTENSIONS.CALLER_TYPE]=g.split(":",1)[0])},this.setCalleeType=g=>{g&&(this.telemetryData[xi.EXTENSIONS.CALLEE_TYPE]=g.split(":",1)[0])},this.setTerminatingData=g=>{this.telemetryData[xi.EXTENSIONS.CALL_TERMINATING_END]=g.terminatingEnd,this.telemetryData[xi.EXTENSIONS.CALL_END_CODE]=g.endCode||Di.CALL_END_CODE.SUCCESS,this.telemetryData[xi.EXTENSIONS.CALL_END_SUB_CODE]=g.endSubCode||Di.CALL_END_SUB_CODE.SUCCESS,this.telemetryData[xi.EXTENSIONS.CALL_PHRASE]=g.phrase||Di.CALL_END_PHRASE.UNKNOWN,this.telemetryData[xi.EXTENSIONS.RESULT_VALUE]=g.resultValue||xi.RESULT_VALUE.SUCCESS,this.telemetryData[xi.EXTENSIONS.RESULT_DETAIL]=g.resultDetail||"Call gracefully hungup",this.telemetryData[xi.EXTENSIONS.RESULT_CAUSE_ID]=g.causeId||"unknown",this.telemetryData[xi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=g.resultCategories||[],this.telemetryData[xi.EXTENSIONS.CALL_END_CLIENT_SUB_CODE]=g.clientReasonSubCode,this.telemetryData[xi.EXTENSIONS.CALL_END_CLIENT_PHRASE]=g.clientReasonPhrase},this.startCallInitializationWatch=g=>{this.timeToRingStopWatch=build3(),g&&(this.timeToRingStopWatch.msElapsed+=g)},this.startCallConnectedWatch=()=>{this.connectedStopWatch=build3()},this.setIsPreheated=()=>{this.isPreheated=1},this.startPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch=build3()},this.stopPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch.pause()},this.startCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=build3()},this.stopCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch&&this.callCancelationDurationWatch.pause()},this.getCallCancelationDuration=()=>this.callCancelationDurationWatch?this.callCancelationDurationWatch.durationInSeconds():0,this.resetCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=null},this.setOfferAnswerGenerationTimestamps=g=>{this.localOfferAnswerGenerationTimestamps.push(this.recordOperation(g))},this.setTimeToRingDuration=()=>{this.timeToRingStopWatch&&(this.telemetryData[xi.EXTENSIONS.TIME_TO_RING_IN_MS]=this.timeToRingStopWatch.duration(),this.timeToRingStopWatch=null)},this.dispose=()=>{this.sendCallModalityTelemetryData()},this.setMessagingChannel=g=>{this.telemetryData[xi.EXTENSIONS.MESSAGING_CHANNEL]||(this.telemetryData[xi.EXTENSIONS.MESSAGING_CHANNEL]=[]);this.telemetryData[xi.EXTENSIONS.MESSAGING_CHANNEL].some((m=>-1!==m.indexOf(g)))||this.telemetryData[xi.EXTENSIONS.MESSAGING_CHANNEL].push(this.recordOperation(g))},this.sendHttpTelemetryData=g=>{const m={...this.httpRequestTelemetryData};m[xi.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,m[xi.CONTEXT_ID.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,m[xi.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation;const S=JSON.stringify({eventStart:this.callStartTime,events:this.networkRequests[g]});tryRemoveKeyFromHashTable(this.networkRequests,g),m[xi.EXTENSIONS.NETWORK_REQUESTS_BAG]=S,this.telemetryLogger.logHttpTelemetryEvent(m)},this.sdpTelemetryFormat=(g,m)=>{if(!g)return"";const convertType=g=>{switch(g){case"main-audio":return"Audio";case"main-video":return"Video";case"applicationsharing-video":return"AppSharing";default:return}},convertDirection=g=>{switch(g){case"inactive":return"Inactive";case"sendonly":return m?"ReceiveFromPeer":"SendToPeer";case"recvonly":return m?"SendToPeer":"ReceiveFromPeer";default:return"Bidirectional"}},S={"main-audio":0,"main-video":0,"applicationsharing-video":0},v=[],C=bn.parse(g);for(const g of C.media){const m=convertType(g.label);if(!m)continue;const C=S[g.label]++,_=convertDirection(g.direction);v.push(`${m}[${C}] = ${_}`)}return v.join(", ")},this.setReinviteless=g=>{this.isReinviteless=g?1:0},this.logger=g.logger,this.telemetryLogger=getLogger(g,this.logger),this.telemetryData[xi.EXTENSIONS.CALL_START_TIME]=this.callStartTime,this.telemetryData[xi.EXTENSIONS.CONVERSATION_SERVICE_URL]=g.signalingAgentConfig.conversationServiceUrl,this.fillCommonData(m,this.telemetryData),this.fillCommonData(m,this.httpRequestTelemetryData),this.fillCommonData(m,this.contentSharingBaseTelemetryData)}fillCommonData(g,m){m[xi.EXTENSIONS.APPLICATION_TYPE]=g.applicationType,m[xi.EXTENSIONS.RING]=g.ring,m[xi.EXTENSIONS.TENANT_ID]=g.tenantId,m[xi.EXTENSIONS.USER_HEX_CID]=g.userHexCID,m[xi.EXTENSIONS.ACS_RESOURCE_ID]=g.acsResourceId,m[xi.EXTENSIONS.REGION]=g.region,m[xi.EXTENSIONS.PARTITION]=g.partition,m[xi.EXTENSIONS.CLIENT_TYPE]=g.clientType}addChangingCorrelationId(g,m){this.telemetryData[xi.EXTENSIONS.CHANGING_CORRELATION_ID_OLD_ID]=g,this.telemetryData[xi.EXTENSIONS.CHANGING_CORRELATION_ID_NEW_ID]=m}addSharedCorrelationId(g){this.telemetryData[xi.CONTEXT_ID.SHARED_CORRELATION_ID]=g}sendContentSharingTelemetryData(g,m,S,v,C,_){const E={...this.contentSharingBaseTelemetryData},T=this.contentSharingOperationsPerformed[g];T&&(E[xi.EXTENSIONS.EVENT_TIMESTAMP_BAG]=JSON.stringify(T)),E[xi.CONTEXT_ID.CONTENT_SHARING_CORRELATION_ID]=g,E[xi.CONTEXT_ID.SIGNALING_SESSION_ID]=m,E[xi.CONTEXT_ID.CONTENT_SHARING_ID]=_||"",E[xi.EXTENSIONS.CONTENT_SHARING_SERVICE_URL]=C,E[xi.EXTENSIONS.CONTENT_SHARING_DIRECTION]=S?xi.DIRECTION.OUTGOING:xi.DIRECTION.INCOMING,E[xi.EXTENSIONS.CALL_END_CODE]=v.code,E[xi.EXTENSIONS.CALL_END_SUB_CODE]=v.subCode,E[xi.EXTENSIONS.CALL_PHRASE]=v.phrase,E[xi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(v.resultCategories),E[xi.EXTENSIONS.CALL_END_CAUSE_ID]=v.causeId,E[xi.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,delete this.contentSharingOperationsPerformed[g],this.telemetryLogger.logConversationContentSharingEvent(E)}recordOperation(g){return`${g}:${this.timeSinceCallStart()}`}timeSinceCallStart(){return(new Date).getTime()-this.callStartTime}sendCallModalityTelemetryData(){this.vbssStarted&&this.addVbssOperations(xi.VBSS_OPERATION.CALL_END);const durationMsToS=g=>"number"==typeof g?g/1e3:0;if(this.telemetryData[xi.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,this.telemetryData[xi.EXTENSIONS.CALL_END_TIME]=(new Date).getTime(),this.connectedStopWatch&&(this.telemetryData[xi.EXTENSIONS.CONNECTED_DURATION_IN_MS]=this.connectedStopWatch.duration()),this.telemetryData[xi.EXTENSIONS.IS_PREHEATED]=this.isPreheated,this.preheatedCallSetupDurationWatch&&(this.telemetryData[xi.EXTENSIONS.PREHEATED_CALL_SETUP_DURATION_IN_S]=durationMsToS(this.preheatedCallSetupDurationWatch.duration())),this.callCancelationDurationWatch&&(this.telemetryData[xi.EXTENSIONS.CALL_CANCELATION_DURATION_IN_S]=durationMsToS(this.callCancelationDurationWatch.duration())),this.networkRequestsCompleted.length&&(this.telemetryData[xi.EXTENSIONS.NETWORK_REQUESTS_COMPLETED]=JSON.stringify(this.networkRequestsCompleted)),this.localOperationsPerformed.length&&(this.telemetryData[xi.EXTENSIONS.LOCAL_OPERATIONS_PERFORMED]=JSON.stringify(this.localOperationsPerformed)),this.trouterWaitOperations.length&&(this.telemetryData[xi.EXTENSIONS.TROUTER_WAIT_OPERATIONS]=JSON.stringify(this.trouterWaitOperations)),this.localOfferAnswerGenerationTimestamps.length&&(this.telemetryData[xi.EXTENSIONS.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS]=JSON.stringify(this.localOfferAnswerGenerationTimestamps)),this.incomingModalities.length&&(this.telemetryData[xi.EXTENSIONS.INCOMING_MODALITIES]=JSON.stringify(this.incomingModalities)),this.outgoingModalities.length&&(this.telemetryData[xi.EXTENSIONS.OUTGOING_MODALITIES]=JSON.stringify(this.outgoingModalities)),this.offeredModalities.length&&(this.telemetryData[xi.EXTENSIONS.OFFERED_MODALITIES]=this.offeredModalities),this.answeredModalities.length&&(this.telemetryData[xi.EXTENSIONS.ANSWERED_MODALITIES]=this.answeredModalities),this.telemetryData[xi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(this.telemetryData[xi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]),this.telemetryData[xi.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION]=this.isSdpInCallNotification.toString(),this.vbssOperations.length&&(this.telemetryData[xi.EXTENSIONS.VBSS_OPERATIONS]=JSON.stringify(this.vbssOperations)),this.recordedEvents.length){const g=JSON.stringify({eventStart:this.callStartTime,events:this.recordedEvents});this.telemetryData[xi.EXTENSIONS.EVENT_TIMESTAMP_BAG]=g}if(this.rosterUpdates.length){const g=JSON.stringify({eventStart:this.callStartTime,events:this.rosterUpdates});this.telemetryData[xi.EXTENSIONS.ROSTER_UPDATES_BAG]=g}const g=[];for(const m of Object.keys(this.networkRequestsStarted))g.push(this.networkRequestsStarted[m]);g.length>0&&(this.telemetryData[xi.EXTENSIONS.NETWORK_REQUESTS_PENDING]=JSON.stringify(g)),this.telemetryData[xi.EXTENSIONS.IS_REINVITELESS]=this.isReinviteless,this.telemetryLogger.logConversationCallModalityEvent(this.telemetryData)}getResultCategoryString(g){return g&&Array.isArray(g)?g.join(","):""}},Pn=class{constructor(g,m){this.disposed=!1,this.lastSeenSeqNumbers={},this.isDominantSpeakerInfoLinkEnabled=!0,this.clientUrlsGenerated=!1,this.getClientUrls=()=>{this.clientUrlsGenerated=!0;let g=null;return this.isWebRtcCall&&(g={controlVideoStreaming:get(this.signalingSession,Mi.CONTROL_VIDEO_STREAMING),csrcInfo:get(this.signalingSession,Mi.CSRC_INFO)},this.isDominantSpeakerInfoLinkEnabled&&(g.dominantSpeakerInfo=get(this.signalingSession,Mi.DOMINANT_SPEAKER_INFO))),g},this.handleDominantSpeakerInfo=g=>{const m=g.body;this.logger.debug("handleDominantSpeakerInfo : ",getPrintableObject(m)),this.signalingSession.telemetryHelper.recordIncomingEventCount(Li.HANDLE_DOMINANT_SPEAKER_CHANGED_COUNT),this.handleWebRtcNotification(Di.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO,m.dominantSpeakerInformation)},this.handleControlVideoStreaming=g=>{const m=g.body;this.logger.debug("handleControlVideoStreaming: ",getPrintableObject(m)),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_CONTROL_VIDEO_STREAMING,g),this.handleWebRtcNotification(Di.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING,m.controlVideoStreaming,!1)},this.handleCsrcInfo=g=>{const m=g.body;this.logger.debug("handleCsrcInfo : ",getPrintableObject(m)),this.signalingSession.telemetryHelper.recordIncomingEvent(Li.HANDLE_CSRC_INFO,g),this.handleWebRtcNotification(Di.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO,m.csrcInfo)},this.sendWebRtcMediaNotificationAsync=({operation:g,requestUrl:m,requestBody:S,stackRetry:v=!0},C)=>{this.logger.info("sendWebRtcMediaNotificationAsync"),assert2(this.isWebRtcCall,"this is not a webrtc call"),assertNotNullOrEmpty(m,"correct media notification requestUrl is not provided"),assertNotNullOrEmpty(S,"media notification requestBody cannot be null or empty");const _=defer2(),E={url:m,payload:{payload:S},requestName:g,withoutTrouter:!0,causeId:C};return v||(E.disableRetry=!0),this.signalingSession.http.sendPostRequest(E).then((()=>{this.disposed||_.resolve()})).catch((g=>{const m=getPrintableObject(g);if(this.logger.error(`sendWebRtcMediaNotificationAsync failed because : ${m}`),!this.disposed){const m=new Error(g);m.endCode=Di.CALL_END_NETWORK_ERROR,_.reject(m)}})),_.promise},this.dispose=()=>{this.logger.info("WebRtcSignalingManager :: dispose"),this.disposed=!0},this.signalingSession=g,this.signalingSessionCallback=m,this.isWebRtcCall=g.signalingAgentConfig.isWebRtcEnabled,this.logger=g.logger,this.lastSeenSeqNumbers[Di.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING]=-1,this.lastSeenSeqNumbers[Di.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO]=-1,this.lastSeenSeqNumbers[Di.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO]=-1}areClientURLsGenerated(){return this.clientUrlsGenerated}getIsDominantSpeakerInfoLinkEnabled(){return this.isDominantSpeakerInfoLinkEnabled}setIsDominantSpeakerInfoLinkEnabled(g){this.isDominantSpeakerInfoLinkEnabled=g}handleWebRtcNotification(g,m,S=!0){assert2(this.isWebRtcCall,"ignoring message in non-webrtc call");const v=this.lastSeenSeqNumbers[g];S&&m.sequenceNumber<=v?this.logger.info(`ignoring ${g} . Last seen seq = ${v} current seq = ${m.sequenceNumber}`):(m.sequenceNumber<=v&&this.logger.info(`let listener to handle older ${g} . Last seen seq = ${v} current seq = ${m.sequenceNumber}`),this.lastSeenSeqNumbers[g]=Math.max(m.sequenceNumber,this.lastSeenSeqNumbers[g]),this.signalingSessionCallback.onWebRtcMediaNotification(g,m))}},Mn=class{constructor(g,m,S,v,C,_){this.disposed=!1,this.convSubject=null,this.groupId=null,this.threadId=null,this.incomingCallCallerId=null,this.incomingCallPayload=null,this.multiParty=!0,this.isIncomingCall=!1,this.isHostLessCall=!1,this.isCastCall=!1,this.isHuddleGroupCall=!1,this.numberOfOriginalInvitees=0,this.teamsMessageId=null,this.enableGroupCallMeetupGeneration=!1,this.meetingInfo=null,this.meetingDetails=null,this.emergencyContent=null,this.transferContext=null,this.callType="default",this.callMode=0,this.transferor=null,this.onBehalfOf=null,this.onBehalfOfUserDisplayName=null,this.callPhoneLineType=null,this.endpointMetadata={},this.sessionId=newGuid(),this.remoteCaller=null,this.acceptedElsewhereBy=null,this.parkAdditionalContextJson=null,this.serverHoldLocation=null,this.breakoutDetails=null,this.callLimits=null,this.complianceRecordingContent=null,this.backroomThreadId=null,this.realTimeState=0,this.disposing=!1,this.links={},this.provisionalMediaAnswersSeenSoFar=[],this.incomingTrouterMessagesSeenSoFar=[],this.incomingBrokerMessagesSeenSoFar=[],this.currentCallStatus=null,this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.convJoined=!1,this.keepAliveTimer=null,this.keepAliveInterval=null,this.keepAliveCount=1,this.conversationKeepAliveTimer=null,this.conversationKeepAliveInterval=null,this.conversationKeepAliveCount=1,this.remoteUser=null,this.mediaTypesToUse=null,this.lastUsedOutgoingMediaContent=null,this.lastUsedJoinCallOptions=null,this.originalRoleBeforePreheat="",this.endpointStateSequenceNumber=0,this.publishStateSequenceNumber=0,this.requestedPublishedStatesWhileConnecting=null,this.linkUpdateRequested={conversationLinks:!1,keepAliveLinks:!1},this.incomingMessageSyncResponseCache={},this.isPreheatOnly=!1,this.callStartTime=(new Date).getTime(),this.callUsesMixer=!1,this.disablePreheatDefer=defer2(),this.participantReplacementDetails={},this.meetingLiveStateSequenceNumber=0,this.meetingLayoutSequenceNumber=0,this.localParticipantUpdateSequenceNumber=0,this.isRedirectAllowed=!1,this.updateSequenceNumber=-1,this.isPromotingToRealtime=!1,this.streamInformationReceived=!1,this.startOrJoinConvResponseReceived=!1,this.updateParticipantsPromises={},this.updateEndpointState=(g,m=causeId2(),S)=>{this.logger.info(`[${m}][requestedEndpointState=${getPrintableObject(g,!0)}]`);const v=this.links[Di.LINKS.UPDATE_ENDPOINT_STATE],C=this.getEndpointState();this.logger.info(`[${m}][currentEndpointState=${getPrintableObject(C,!0)}] startOrJoinConvResponseReceived=${this.startOrJoinConvResponseReceived}`);const _={...C,...g,endpointStateSequenceNumber:++this.endpointStateSequenceNumber};this.telemetryHelper.recordEvent(Li.UPDATE_ENDPOINT_STATE,{newEndpointState:_,causeId:m});const preheatDisabledInNewState=g=>0===g?.endpointProperties?.preheatProperties;if(preheatDisabledInNewState(_)&&this.isPreheatOnly&&(this.telemetryHelper.recordEvent(Li.PREHEAT_DISABLING,{causeId:m}),this.telemetryHelper.startPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallCancelationDurationWatch()),2===this.callMode&&preheatDisabledInNewState(_))return this.logger.info(`[${m}][updateEndpointState skipped as mode is streaming]`),this.handleEndpointStateUpdated(m,!0),Promise.resolve();if(!this.startOrJoinConvResponseReceived)return this.logger.info(`[${m}][updateEndpointState will be queued as we don't have a link yet]`),this.requestedEndpointStateWhileConnecting=g,preheatDisabledInNewState(_)?(this.requestedPublishedStatesWhileConnecting=S,this.disablePreheatDefer.promise):Promise.resolve();if(!this.shouldUpdateEndpointState(C,_)&&!this.http.hasPendingRequest(Fi.UPDATE_ENDPOINT_STATE.name))return this.logger.info(`[${m}][updateEndpointState will ignore current update as there is nothing new to send]`),Promise.resolve();if(!v)return this.logger.info(`[${m}][updateEndpointState operation cannot be performed now, the link is not yet available]`),Promise.reject("No link");this.latestEndpointState=_;const E=this.signalingAgentConfig.enableAsyncDisablePreheat&&preheatDisabledInNewState(_);E&&this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT,(()=>{const g={code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.DISABLE_PREHEAT_TIMEOUT,phrase:Di.CALL_END_PHRASE.DISABLE_PREHEAT_TIMEOUT};this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject({response:g})}),Di.TIMEOUT_VALUES_IN_SECONDS.DISABLE_PREHEAT_TIMEOUT);const T=this.http.sendPostRequest({url:v,requestName:Fi.UPDATE_ENDPOINT_STATE.name,payload:getPayload51(this,_,S,E),causeId:m}).then((()=>(E&&(this.logger.info(`[${m}][updateEndpointState] asyncDisablePreheat: true`),this.telemetryHelper.recordEvent(Li.DISABLE_PREHEAT_RESPONSE_RECEIVED,{causeId:m})),Promise.resolve()))).catch((g=>{if(!E)throw g;this.disablePreheatDefer.reject(g)}));return(E?this.disablePreheatDefer.promise:T).then((()=>{this.logger.info(`[${m}][updateEndpointState] asyncDisablePreheat: ${E}`),this.telemetryHelper.recordEvent(E?Li.ASYNC_DISABLE_PREHEAT_SUCCEEDED:Li.DISABLE_PREHEAT_SUCCEEDED,{causeId:m}),this.disposed||this.handleEndpointStateUpdated(m,preheatDisabledInNewState(_))})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${m}][updateEndpointState] error: ${getPrintableObject(S)}`),preheatDisabledInNewState(_)&&(this.handleDisablePreheatError(S.error,E?Li.ASYNC_DISABLE_PREHEAT_FAILED:Li.DISABLE_PREHEAT_FAILED,m),this.stopCallPreheatTimer(),this.terminateEstablishedCall({code:S.error.code,subCode:S.error.subCode,phrase:S.error.phrase},{forEveryone:!1,causeId:m})),Promise.reject(S.error)}))},this.setParticipantCallLinks=g=>{g&&g.endpointDetails&&(this.participantReplacementDetails[g.id]={},g.endpointDetails.forEach((m=>{m&&m.callLinks&&(this.participantReplacementDetails[g.id][m.participantId]=m.callLinks)})))},this.clearParticipantCallLinks=g=>{this.participantReplacementDetails?.hasOwnProperty(g)&&delete this.participantReplacementDetails[g]},this.getReplacementDetailsByParticipantLeg=(g,m,S=causeId2())=>(this.logger.info(`[${S}]getReplacementDetailsByParticipantLeg: participantMri ${getPIISafeObject(g)} participantLegId ${m}`),this.participantReplacementDetails?.hasOwnProperty(g)&&this.participantReplacementDetails[g].hasOwnProperty(m)?{replaces:this.participantReplacementDetails[g][m].replacement,replacementTargetParticipantId:m}:(this.logger.info(`[${S}]getReplacementDetailsByParticipantLeg: unable to find replacement details for participantLegId ${m}`),{})),this.getReplacementDetailsByParticipantLegOfCall=(g,m,S,v=causeId2())=>{this.logger.info(`[${v}]getReplacementDetailsByParticipantLegOfCall: callId ${g} participantMri ${getPIISafeObject(m)} participantLegId ${S}`);const C=this.signalingAgent.getSignalingSession(g);return C?C.getReplacementDetailsByParticipantLeg(m,S,v):{}},this.getMriByParticipantLegOfCall=(g,m,S)=>{this.logger.info(`[${S}]getMriByParticipantLegOfCall: callId: ${g} participantLegId ${m}`);const v=this.signalingAgent.getSignalingSession(g);return v?v.getMriByParticipantLeg(m,S):""},this.getMriByParticipantLeg=(g,m)=>{this.logger.info(`getMriByParticipantLeg[${m}] participantLegId ${g}`);for(const m of Object.keys(this.participantReplacementDetails))if(m&&this.participantReplacementDetails.hasOwnProperty(m)&&this.participantReplacementDetails[m]?.hasOwnProperty(g))return m;return""},this.handleEndpointStateUpdated=(g,m)=>{this.requestedEndpointStateWhileConnecting=null,this.requestedPublishedStatesWhileConnecting=null,m&&this.handlePreheatDisabled(g)},this.handlePreheatDisabled=g=>{this.isPreheatOnly=!1,this.telemetryHelper.setSelfParticipantRole(this.originalRoleBeforePreheat),this.telemetryHelper.recordEvent(Li.PREHEAT_DISABLED,{causeId:g}),this.telemetryHelper.resetCallCancelationDurationWatch(),this.telemetryHelper.stopPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallConnectedWatch(),this.stopCallPreheatTimer(),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.resolve()},this.shouldUpdateEndpointState=(g,m)=>{if(!m)return!1;const S=m.state&&m.state.isMuted?1:0,v=m.endpointProperties&&1===m.endpointProperties.preheatProperties?1:0,C=g&&g.state&&g.state.isMuted?1:0,_=g&&g.endpointProperties&&1===g.endpointProperties.preheatProperties?1:0,E=g?.endpointProperties?.additionalEndpointProperties,T=m?.endpointProperties?.additionalEndpointProperties;return!!(S^C||v^_||T!==E)},this.setInitialTelemetry=(g,m)=>{let S,v;switch(g){case"Subscribe":this.telemetryHelper.recordEvent(Li.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY,{causeId:m.causeId,correlationId:m.correlationId}),this.telemetryHelper.setDirection(xi.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(xi.ROLE.JOIN_FOR_ROSTER_ONLY),this.telemetryHelper.setConversationServiceUrl(m.conversationServiceUrl||this.signalingAgentConfig.conversationServiceUrl),this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id);break;case"Acknowledge":this.telemetryHelper.recordEvent(Li.HANDLE_INCOMING_CALL,{causeId:m.causeId}),this.telemetryHelper.setDirection(xi.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(xi.ROLE.CALLEE),this.telemetryHelper.setCalleeType(this.participantManager.localParticipant.id);break;case"JoinCall":S=this.gatherTelemetryForStartOrJoin(m.joinCallOptions,m.causeId,m.offerGenerationTime),this.telemetryHelper.recordEvent(Li.JOIN_CALL,S),this.telemetryHelper.setDirection(xi.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(xi.ROLE.JOIN);break;case"StartCall":case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":v=this.gatherTelemetryForStartOrJoin(m.callStartOptions,m.causeId,m.offerGenerationTime),this.telemetryHelper.recordEvent(Li.START_CALL,v),this.telemetryHelper.setDirection(xi.DIRECTION.OUTGOING),this.telemetryHelper.setSelfParticipantRole(xi.ROLE.CALLER),this.telemetryHelper.startCallInitializationWatch(m.offerGenerationTime),this.telemetryHelper.setMeetingInfo(this.getMeetingInfo())}},this.getParticipantIdForOfferAnswer=g=>{assertNotNull(g,"mediaContent should be a non null value"),this.logger.info("getParticipantIdForOfferAnswer");let m=null;return!this.remoteUser||this.groupId||this.threadId||g.newOffer||g.escalationOccurring||(m=this.remoteUser.id),m},this.getMeetingInfo=()=>this.meetingInfo,this.getEmergencyContent=()=>(this.telemetryHelper.recordEvent(Li.GET_EMERGENCY_CONTENT),this.emergencyContent),this.getEndpointId=()=>this.signalingAgent.endpointId,this.getConversationUrl=()=>this.links[Di.LINKS.CONVERSATION_CONTROLLER],this.setJoinedFrom=g=>{!this.disposed&&g&&(this.telemetryHelper.recordEvent(Li.SET_JOINED_FROM),this.telemetryHelper.setJoinedFrom(g))},this.setMeetingCode=g=>{!this.disposed&&g&&this.telemetryHelper.setMeetingCode(g)},this.setMeetingUrl=g=>{!this.disposed&&g&&this.telemetryHelper.setMeetingUrl(g)},this.setSubject=g=>{this.disposed||(this.telemetryHelper.recordEvent(Li.SET_SUBJECT),assertNotNull(g,"subject should be a non null value"),this.convSubject=g)},this.setDeviceType=g=>{this.disposed||(this.telemetryHelper.recordEvent(Li.SET_DEVICETYPE),g&&(this.deviceType=g,this.logger.info("setDeviceType",this.deviceType)))},this.setOfferAnswerGenerationTimestamps=g=>{this.disposed||this.telemetryHelper.setOfferAnswerGenerationTimestamps(g)},this.setTimeToRingDuration=()=>{this.disposed||this.telemetryHelper.setTimeToRingDuration()},this.setGroupId=g=>{this.telemetryHelper.recordEvent(Li.SET_GROUPID),this.groupId!==g&&g&&(assert2(!this.groupId,"conversation groupId has already been set. It cannot be overwritten"),this.groupId=g)},this.setThreadId=g=>{this.telemetryHelper.recordEvent(Li.SET_THREADID),assertNotNull(g,"threadId should be a non null value"),this.threadId!==g&&(assert2(!this.threadId,"conversation threadId has already been set. It cannot be overwritten"),this.threadId=g)},this.setCallOptions=g=>{if(assertNotNull(g,"callOptions should be a non null value"),this.logger.info("setCallOptions",getPrintableObject(g)),this.telemetryHelper.recordEvent(Li.SET_CALLOPTIONS),g){this.teamsMessageId=g.teamsMessageId,this.meetingInfo=g.meetingInfo||null,this.emergencyContent=g.emergencyContent||null,this.enableGroupCallMeetupGeneration=g.enableGroupCallMeetupGeneration||!1,g.broadcastContext&&(this.broadcastSession=new qi(this,this.signalingSessionCallback),this.broadcastSession.setContext(g.broadcastContext));try{this.endpointMetadata=JSON.parse(g.endpointMetadata)}catch(g){this.logger.warn("Unable to parse endpoint metadata")}}},this.setTransferContext=g=>{assertNotNull(g,"transferContext should not be null"),this.logger.info("Transfer: setTransferContext",g),this.telemetryHelper.recordEvent(Li.SET_TRANSFER_CONTEXT),this.transferContext=g},this.muteAsync=(g,m,S=causeId2())=>(assert2(2!==this.callMode||g!==Di.MUTE_SCOPE.MYSELF,"mute self operation is not allowed in streaming mode"),this.logger.info(`[${S}][muteAsync][scope=${g}]`),this.telemetryHelper.recordEvent(Li.MUTE,{causeId:S}),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,`[${S}]mute operation for all or specified only allowed in a connected call`),this.participantManager.muteAsync(this.links[Di.LINKS.MUTE],g,m,S)),this.unmuteAsync=(g=causeId2())=>(assert2(2!==this.callMode,"unmute operation is not allowed in streaming mode"),this.logger.info(`[${g}][unmuteAsync]`),this.telemetryHelper.recordEvent(Li.UNMUTE,{causeId:g}),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"unmute operation only allowed in a connected call"),this.participantManager.unmuteAsync(this.links[Di.LINKS.UNMUTE],g)),this.recordTelemetryForStartAudio=(g,m)=>(this.telemetryHelper.recordEvent(Li.START_AUDIO,{mediaNegotiationStatus:g,causeId:m}),Promise.resolve(null)),this.recordTelemetryForStopAudio=(g,m)=>(this.telemetryHelper.recordEvent(Li.STOP_AUDIO,{mediaNegotiationStatus:g,causeId:m}),Promise.resolve(null)),this.rejectUnmuteRequestAsync=(g,m=causeId2(),S)=>(assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"rejectUnmute operation only allowed in a connected call"),assertNotNullOrEmpty(g,"requestor must be specified"),this.logger.info(`[${m}][rejectUnmuteRequestAsync][rejectionReason=${S}]`),this.telemetryHelper.recordEvent(Li.REJECT_UNMUTE,{causeId:m,rejectionReason:S}),this.participantManager.rejectUnmuteRequestAsync(g,m,S)),this.approveUnmuteRequestAsync=(g,m=causeId2())=>(assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"approveUnmute operation only allowed in a connected call"),assertNotNullOrEmpty(g,"requestor must be specified"),this.logger.info(`[${m}][approveUnmuteRequestAsync]`),this.telemetryHelper.recordEvent(Li.APPROVE_UNMUTE,{causeId:m}),this.participantManager.approveUnmuteRequestAsync(g,m)),this.sendWebRtcMediaNotificationAsync=(g,m,S=causeId2())=>(assert2(2!==this.callMode,"sendWebRtcMediaNotification operation is not allowed in streaming mode"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"webRtc media notification can only be sent in a connected call"),this.telemetryHelper.recordEvent(Li.SEND_WEBRTC_MEDIA_NOTIFICATION,{causeId:S}),0===g?this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:Fi.SEND_APPLY_CHANNEL_PARAMETERS.name,requestUrl:this.links[Di.LINKS.APPLY_CHANNEL_PARAMETERS],requestBody:m,stackRetry:!1},S):this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:Fi.SEND_CONTROL_VIDEO_STREAMING.name,requestUrl:this.links[Di.LINKS.CONTROL_VIDEO_STREAMING],requestBody:m},S)),this.addParticipantsAsync=(g,m,S=causeId2())=>{assertNotNullOrEmpty(g,"remoteParticipants should be a non null value"),assert2(this.isCallOngoing()||this.isCallIdleOrRosterOnly(),"remoteParticipants can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${S}][addParticipantsAsync][addParticipantOptions=${getPrintableObject(m)}]\n            [remoteParticipantId=${g.map((g=>this.piiUtils.scrubMriOrOmit(g.id)))}]`);let v=Li.ADD_PARTICIPANT;switch(m.replacementType){case 2:v=Li.ADD_PARTICIPANT_WITH_PICKUP_CODE;break;case 1:case 3:v=Li.ADD_PARTICIPANT_WITH_REPLACES;break;default:v=Li.ADD_PARTICIPANT}this.telemetryHelper.recordEvent(v,{causeId:S}),m.groupId=this.groupId||m.groupId,m.threadId=this.threadId||m.threadId;const C=m.threadId||m.groupId?this.links[Di.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Di.LINKS.ADD_PARTICIPANT],_=this.participantManager.addParticipantsAsync(g,C,this.isCallConnectedOrConnectedForRoster(),m,S);return this.currentCallStatus||this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,S),_},this.addGroupModalityAsync=(g,m)=>{assert2(this.isCallOngoing(),"GroupModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${m}][addGroupModalityAsync][addGroupModalityOptions=${getPrintableObject(g)}]`);const S=Li.ADD_PARTICIPANTS_AND_MODALITY;this.telemetryHelper.recordEvent(S,{causeId:m});const v=getPayload11(this,null,g);return this.http.sendPostRequest({url:this.links[Di.LINKS.ADD_PARTICIPANTS_AND_MODALITY],payload:v,requestName:Fi.ADD_PARTICIPANTS_AND_MODALITY.name,causeId:m}).then((()=>{ji.noop()})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][sendNetworkRequestForAddingParticipant] failed:${getPrintableObject(S)}`);throw S.error}))},this.addBroadcastModalityAsync=(g,m)=>{if(assert2(this.isCallOngoing(),"BroadcastModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${m}][addBroadcastModalityAsync][addBroadcastContext=${getPrintableObject(this.addBroadcastModalityAsync)}]`),this.telemetryHelper.recordEvent(Li.ADD_BROADCAST_MODALITY,{causeId:m}),this.broadcastSession){const g="There is already a broadcast session";return this.logger.info(g),Promise.resolve(Di.SUCCESS_TRANSACTION_END)}this.broadcastSession=new qi(this,this.signalingSessionCallback),this.broadcastSession.setContext(g);const S=getPayload24(this,g);return this.http.sendPostRequest({url:this.links[Di.LINKS.ADD_MODALITY],payload:S,requestName:Fi.ADD_BROADCAST_MODALITY.name,causeId:m}).then((g=>(this.logger.info(`[${m}][addBroadcastModalityAsync] response: ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_ADD_BROADCAST_MODALITY_COMPLETION,{causeId:m}),Di.SUCCESS_TRANSACTION_END))).catch((g=>{const S=getErrorForXHRFailure(g);return this.logger.info(`[${m}][sendNetworkRequestForAddBroadcastModalityAsync] failed:${getPrintableObject(S)}`),this.endBroadcastMeeting(m),Promise.reject(S.error)}))},this.nudgeParticipantsAsync=g=>{if(assertNotNull(g.participantsIds,"ParticipantsIds should be a non null value"),assert2(this.isCallOngoing(),"Participants can only be nudged before starting an outgoing call or to an ongoing call"),this.logger.info(`[${g.causeId}][nudgeParticipantsAsync][participantsIds=${this.piiUtils.scrubParticipantsList(g.participantsIds)}][invitationData=${g.invitationData}]`),void 0===g.participantsIds||g.participantsIds.length<1)return Promise.reject("List of participants to nudge is empty");this.telemetryHelper.recordEvent(Li.ADD_PARTICIPANT,{withNudge:Di.INVITATION_TYPE.NUDGE,causeId:g.causeId});const m=this.groupId||g.newGroupId,S=this.threadId||g.newThreadId,v=this.teamsMessageId||g.newMessageId,C=S||m?this.links[Di.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Di.LINKS.ADD_PARTICIPANT];return this.participantManager.nudgeParticipantsAsync(g.participantsIds,C,this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,g.causeId,g.invitationData,m,S,v)},this.callMeBackAsync=(g,m=causeId2())=>(assertNotNull(g,"remoteParticipant should be a non null value"),this.logger.info(`[${m}][callMeBackAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(g.id)}]`),this.telemetryHelper.recordEvent(Li.CALL_ME_BACK,{causeId:m}),this.hasGroupModality()||assert2(!1,"threadId/groupId must be set before using call me back"),this.participantManager.callMeBackAsync(g,this.links[Di.LINKS.ADD_PARTICIPANTS_AND_MODALITY],m)),this.removeParticipantAsync=(g,m=causeId2(),S="none")=>{switch(assertNotNull(g,"remoteParticipant should be a non null value"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"participants can only be removed from an ongoing call"),this.logger.info(`[${m}][removeParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(g.id)}] [removeEndpointScope] ${S}`),S){case"all":this.telemetryHelper.recordEvent(Li.REMOVE_PARTICIPANT_OTHERS,{causeId:m});break;case"specified":this.telemetryHelper.recordEvent(Li.REMOVE_PARTICIPANT_SPECIFIED,{causeId:m});break;default:this.telemetryHelper.recordEvent(Li.REMOVE_PARTICIPANT,{causeId:m})}return"none"!==S&&g.endpointId?this.participantManager.removeParticipantEndpointAsync(g,this.links[Di.LINKS.REMOVE_PARTICIPANT],S,m):this.participantManager.removeParticipantAsync(g,this.links[Di.LINKS.REMOVE_PARTICIPANT],m)},this.admitParticipantAsync=(g,m=causeId2())=>(assertNotNull(g,"remoteParticipant should be a non null value"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"remoteParticipants can only be admitted to an ongoing call"),this.hasGroupModality()||assert2(!1,"threadId/groupId must be set before admitting more participants to connected call"),this.logger.info(`[${m}][admitParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(g.id)}]`),this.telemetryHelper.recordEvent(Li.ADMIT_PARTICIPANT,{causeId:m}),this.participantManager.admitParticipantAsync(g,this.links[Di.LINKS.ADMIT],m)),this.admitAsync=g=>{if(this.logger.info(`[${g}][admitAsync]`),this.telemetryHelper.recordEvent(Li.ADMIT,{causeId:g}),!this.links[Di.LINKS.ADMIT_ALL]){const m={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.ADMIT_ALL_LINK_MISSING,phrase:Di.CALL_END_PHRASE.ADMIT_ALL_URL_MISSING};return this.telemetryHelper.recordEvent(Li.ADMIT_FAILURE,{causeId:g,transactionEnd:m}),this.logger.warn(`admitAsync error ${JSON.stringify(m)}`),Promise.reject(m)}const m=defer2();return this.callOperationHandler.setPendingOperation(0,g,{promise:m,causeId:g},g),this.sendNetworkRequestForAdmit(g),m.promise},this.updateMeetingRolesAsync=(g,m,S=causeId2())=>(assertNotNull(g,"participants array should be a non null value"),assertNotNull(m,"meetingRole should be a non null value"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"remote participant roles can only be updated in an ongoing call"),this.logger.info(`[${S}][updateMeetingRolesAsync][participants=${this.piiUtils.scrubMriOrOmit(g)}]`),this.participantManager.updateMeetingRolesAsync(g,m,this.links[Di.LINKS.UPDATE_PARTICIPANT_ROLE],S)),this.startContentSharingAsync=(g,m,S,v,C=causeId2())=>(assertNotNull(g,"contentIdentifier should be a non null value"),assert2(this.isCallOngoing(),"contentSharing can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${C}][startContentSharingAsync]`),this.telemetryHelper.recordEvent(Li.ADD_CONTENT_SHARING_MODALITY,{causeId:C}),this.contentSharingManager.startContentSharingAsync(g,m,S,this.links[Di.LINKS.ADD_MODALITY],this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,C,v)),this.deleteContentSharingAsync=(g,m=causeId2())=>(this.logger.info(`[${m}][deleteContentSharingAsync][correlationId=${g}]`),this.telemetryHelper.recordEvent(Li.DELETE_CONTENT_SHARING,{causeId:m,correlationId:g}),this.contentSharingManager.deleteContentSharingAsync(g,m)),this.joinContentSharingAsync=(g,m=causeId2())=>(this.logger.info(`[${m}][joinContentSharingAsync][correlationId=${g}]`),this.telemetryHelper.recordEvent(Li.JOIN_CONTENT_SHARING,{causeId:m,correlationId:g}),this.contentSharingManager.joinContentSharingAsync(g,m)),this.updateContentSharingSessionStateAsync=(g,m,S=causeId2())=>(assertNotNull(m,"sessionState should be a non null value"),this.telemetryHelper.recordEvent(Li.UPDATE_SESSION_STATE_CONTENT_SHARING,{causeId:S,correlationId:g}),this.logger.info(`[${S}][updateContentSharingSessionStateAsync][correlationId=${g}][sessionState=${m}]`),this.contentSharingManager.updateContentSharingSessionStateAsync(g,m,S)),this.takeContentSharingControlAsync=(g,m=causeId2())=>(this.telemetryHelper.recordEvent(Li.TAKE_CONTROL_CONTENT_SHARING,{causeId:m,correlationId:g}),this.logger.info(`[${m}][takeContentSharingControlAsync][correlationId=${g}]`),this.contentSharingManager.takeContentSharingControlAsync(g,m)),this.updateContentSharingParticipantStateAsync=(g,m=causeId2())=>(this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING,{causeId:m}),this.logger.info(`[${m}][updateContentSharingParticipantStateAsync][correlationId=${g}]`),this.contentSharingManager.updateContentSharingParticipantStateAsync(g,m)),this.configureEndpointStateForStartOrJoin=g=>{const m={endpointStateSequenceNumber:this.endpointStateSequenceNumber};let S=!1;if(g&&(g.muted&&(S=!0,Object.assign(m,{state:{isMuted:g.muted}})),g.isPreheatOnly||g.additionalEndpointProperties)){const v={};S=!0,g.isPreheatOnly&&(v.preheatProperties=1),g.additionalEndpointProperties&&(v.additionalEndpointProperties=g.additionalEndpointProperties),Object.assign(m,{endpointProperties:v})}if(S)return m},this.gatherTelemetryForStartOrJoin=(g,m,S)=>{const v={causeId:m};return g&&(g.invitationType===Di.INVITATION_TYPE.NUDGE&&(v.withNudge=g.invitationType===Di.INVITATION_TYPE.NUDGE),g.parkContext&&(v.unpark=!0,v.context=g.parkContext),g.isPreheatOnly&&(v.isPreheatOnly=!0),g.targetApplicationType&&(v.targetApplicationType=g.targetApplicationType,this.telemetryHelper.setTargetApplicationType(g.targetApplicationType))),v},this.startOutgoingCall=(g,m,S,v,C=causeId2())=>{if(assertNotNull(g,"mediaContent should be a non null value"),assertNotNull(g.blob,"outgoingSdp should be a non null value"),assert2(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.logger.info(`[${C}][startOutgoingCall][start] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${C}][startOutgoingCall][failed][reason=Session disposed]`);this.lastUsedJoinCallOptions={muted:S?S.muted:null,scenario:S?S.scenario:null,isPreheatOnly:S?S.isPreheatOnly:null,clientEndpointCapabilities:S?S.clientEndpointCapabilities:null,clientEndpointDebugContent:S?S.clientEndpointDebugContent:null},this.originalRoleBeforePreheat=xi.ROLE.CALLER,S&&S.scenario&&this.telemetryHelper.setScenario(S.scenario),this.logger.info(`[${C}][startOutgoingCall]options=${getPrintableObject(this.gatherTelemetryForStartOrJoin(S,C,v))}`),this.isBrokerEnabledForOutgoingCall()&&this.setupBrokerChannel(),this.callUsesMixer=!(!S||!S.callUsesMixer),this.fsmState=Di.SIGNALING_FSM_STATE.OUTGOING,this.meetingData=S?.meetingData,this.meetingPreferences=S?.meetingPreferences;const _={newCall:!0,suppressDialout:S&&S.suppressDialout||!1,conversationServiceUrl:this.signalingAgentConfig.conversationServiceUrl,onBehalfOf:S?S.onBehalfOf:null,onBehalfOfUserDisplayName:S?S.onBehalfOfUserDisplayName:null,callToVoicemail:!!S&&S.callToVoicemail,voicemailResourcePath:S?S.voicemailResourcePath:null,voicemailItemId:S?S.voicemailItemId:null,endpointState:this.configureEndpointStateForStartOrJoin(S),invitationType:S&&S.invitationType?S.invitationType:null,participantsToNudge:S&&Array.isArray(S.participantsToNudge)?S.participantsToNudge:null,routingFlags:S?S.routingFlags:null,parkContext:S?S.parkContext:null,pickupCode:S?S.pickupCode:null,scenario:S?S.scenario:null,isPreheatOnly:!!S&&S.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:S?S.clientEndpointCapabilities:0,clientEndpointDebugContent:S?S.clientEndpointDebugContent:null,invitationData:S?S.invitationData:null,conversationType:S?this.getConversationType(S.isEmergency,S.castCall,S.isHuddleGroupCall):null,meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,alternateId:S?S.alternateId:null,meetingRegistrationId:S?S.meetingRegistrationId:null,participantPin:S?S.participantPin:null,publishedStates:S?S.publishedStates:null,targetApplicationType:S?S.targetApplicationType:null};this.isCastCall=S&&S.castCall,this.isHuddleGroupCall=S&&S.isHuddleGroupCall,this.onBehalfOf=_.onBehalfOf,this.onBehalfOfUserDisplayName=_.onBehalfOfUserDisplayName,this.startOrJoinCall(_,Fi.START_CALL.name,C,g,m)},this.joinGivenConversation=(g,m,S,v,C,_={},E=causeId2())=>{if(assertNotNull(m,"correlationId should be a non null value"),assertNotNullOrEmpty(g||this.getConversationUrl(),"conversationUrl should be a non null value"),assertNotNull(S,"mediaContent should be a non null value"),assertNotNull(S.blob,"outgoingSdp should be a non null value"),this.isPromotingToRealtime=2===this.callMode,assert2(this.isCallIdleOrRosterOnly()||this.isPromotingToRealtime,"a call is already in progress"),this.logger.info(`[${E}][joinGivenConversation][start][correlationId=${m}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${E}][joinGivenConversation][failed][reason=Session disposed]`);const T=this.gatherTelemetryForStartOrJoin(_,E,C);this.lastUsedJoinCallOptions=_,this.originalRoleBeforePreheat=xi.ROLE.JOIN,this.telemetryHelper.startCallInitializationWatch(C),_&&_.scenario&&this.telemetryHelper.setScenario(_.scenario),this.logger.info(`[${E}][joinGivenConversation]options=${getPrintableObject(T)}`),this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Di.SIGNALING_FSM_STATE.OUTGOING,this.updateCorrelationId(m,E),this.meetingData=_?.meetingData,this.meetingPreferences=_?.meetingPreferences;const I={newCall:!1,suppressDialout:!0,conversationServiceUrl:g,endpointState:this.configureEndpointStateForStartOrJoin(_),scenario:_?_.scenario:null,isPreheatOnly:!!_&&_.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:_?_.clientEndpointCapabilities:0,clientEndpointDebugContent:_?_.clientEndpointDebugContent:null,conversationType:_?this.getConversationType(_.isEmergency,!1):null,meetingPreferences:this.meetingPreferences,meetingData:this.meetingData,meetingRegistrationId:_?.meetingRegistrationId,participantPin:_?.participantPin,sharedLineCallInvitationContent:_?.sharedLineCallInvitationContent,applyServerMute:_?.applyServerMute,publishedStates:_?.publishedStates,invitationData:_?.invitationData};this.isCastCall=!1,this.startOrJoinCall(I,Fi.JOIN_CONVERSATION.name,E,S,v)},this.subscribeToCall=(g,m,S=0,v,C=causeId2())=>{assertNotNull(m,"correlationId should be a non null value"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.IDLE,"a call is already in progress");let _=g;return _||(_=this.signalingAgentConfig.conversationServiceUrl,this.logger.info(`conversationServiceUrl passed is empty. so it is set to ${_}`)),assertNotNullOrEmpty(_,"conversationUrl should be a non null value"),this.logger.info(`[${C}][subscribeToCall][start][correlationId=${m}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed?(this.logger.warn(`[${C}][subscribeToCall][failed][reason=Session disposed]`),Promise.reject(Di.CALL_END_CODE.CALL_DOES_NOT_EXIST)):(this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.lastUsedJoinCallOptions=v||{},this.lastUsedJoinCallOptions.clientEndpointCapabilities=S||this.lastUsedJoinCallOptions?.clientEndpointCapabilities,this.meetingData=v?.meetingData,this.meetingPreferences=v?.meetingPreferences,this.fsmState=Di.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY,this.updateCorrelationId(m,C),this.http.sendPostRequest({url:_,requestName:Fi.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,operationType:"CallSetup",payload:getPayload35(this,null,null,{subscribe:!0,clientEndpointCapabilities:S,...v,applicationType:this.participantManager.localParticipant.applicationType,endpointState:this.configureEndpointStateForStartOrJoin({additionalEndpointProperties:v?.additionalEndpointProperties})},C),causeId:C}).then((g=>{this.disposed||(this.fsmState=Di.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.processConversationServiceResponseHeaders(g,C),this.processConversationServiceResponse(g.response,C,1),this.onCallStatusChanged(Di.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY,C))})).catch((g=>{if(g.stack&&!this.isFatalException(g))return Promise.resolve();const m=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${C}][subscribeToCall] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(m)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultValue:xi.RESULT_VALUE.FAILURE,endCode:m.telemetryEndSubCode,endSubCode:m.error.subCode,resultCategories:m.error.resultCategories,resultDetail:m.error.phrase||this.getTerminatingCallResultDetail("subscribe",m.error),causeId:C}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,C,m.error),Promise.reject(m.error))})))},this.getCallReplacementDetailsForCall=(g,m=causeId2())=>{this.logger.info(`[${m}] getCallReplacementDetailsForCall callId ${g}`);const S=this.signalingAgent.getSignalingSession(g);return S?S.getCallReplacementDetails(m):{replaces:""}},this.getCallReplacementDetails=(g=causeId2())=>(this.logger.info(`[${g}] getCallReplacementDetails`),{replaces:this.links[Di.LINKS.REPLACE]}),this.transferCallAsync=(g,m,S,v,C=causeId2())=>{this.logger.info(`[${C}] transferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(g)} transferType ${m} callTransferOptions: ${safeJsonStringify(v)}`),this.transferHelper(g,m,S,v,C)},this.redirectCall=(g,m=causeId2(),S)=>{const{id:v,endpointType:C,type:_}=g.redirectOptions;if(this.logger.info(`[${m}] redirectCall: targetId: ${this.piiUtils.scrubMriOrOmit(v)} targetEndpointType ${C}`),!this.isRedirectAllowed){const g={code:Di.CALL_END_CODE.REJECT,phrase:Di.CALL_END_PHRASE.CALL_REDIRECT_IS_NOT_ALLOWED};return Promise.reject(g)}this.telemetryHelper.recordEvent(Li.CALL_REDIRECT,{causeId:m});const E=getPayload30(this,_,v,C);return this.http.sendPostRequest({url:this.links[Di.LINKS.REDIRECT],requestName:Fi.SEND_CALL_REDIRECT_REQUEST.name,payload:E,causeId:m}).then((v=>(this.logger.info(`[${m}][redirectCall] succeeds. Leaving the call...`),this.telemetryHelper.recordEvent(Li.CALL_REDIRECT_REQUEST_SENT,{causeId:m,targetEndpointType:C}),this.terminateEstablishedCall(S,g)))).catch((g=>{const v=getErrorForXHRFailure(g);this.logger.info(`[${m}][redirectCall] error: ${getPrintableObject(v)}`);const _=v.error;return this.telemetryHelper.recordEvent(Li.CALL_REDIRECT_REQUEST_FAILED,{causeId:m,transactionEnd:_,endpointType:C}),this.disposed||(this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,endCode:S.code,endSubCode:S.subCode,clientReasonSubCode:S.clientReasonSubCode,clientReasonPhrase:S.clientReasonPhrase,resultDetail:S.phrase||"RedirectCall",resultCategories:S.resultCategories,causeId:m}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,S),this.dispose(S,m)),Promise.reject(_)}))},this.transferHelper=(g,m,S,v,C=causeId2())=>{assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet");let _=!1;this.logger.info(`[${C}][transferHelper][replacementDetails=${getPrintableObject(S)}] disableForwardingAndUnanswered=${v&&v.disableForwardingAndUnanswered}`),this.telemetryHelper.recordEvent(Li.TRANSFER_CALL,{causeId:C}),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(C,_)}),Di.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT),this.http.sendPostRequest({url:this.links[Di.LINKS.TRANSFER],requestName:Fi.SEND_TRANSFER_REQUEST.name,payload:getPayload47(g,this,S,m,v),causeId:C}).then((()=>{this.telemetryHelper.recordEvent(Li.WAITING_FOR_TRANSFER_ACCEPTANCE,{causeId:C}),_=!0})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${C}][transferCallAsync] error: ${getPrintableObject(m)}`),this.disposed||(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Di.CALL_END_CODE.NETWORK_ERROR,reason:getPrintableObject(g)}},C),this.telemetryHelper.recordEvent(Li.TRANSFER_REQUEST_FAILED,{causeId:C,...m.error}))})),this.telemetryHelper.recordEvent(Li.TRANSFER_REQUEST_SENT,{causeId:C,transferType:m})},this.consultTransferCallAsync=(g,m,S,v,C)=>{let _,E;if(this.logger.info(`[${v}] consultTransferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(m)} transferTargetParticipantLegId: ${S}`),S?(E=this.getMriByParticipantLegOfCall(g,S,v),_=this.getReplacementDetailsByParticipantLegOfCall(g,m,S,v)):(E=m,_=this.getCallReplacementDetailsForCall(g,v)),!E||!_){const C=_?"target mri corresponding not found":`unable to retrieve replacementDetails for transferTargetCallId: ${g}, transferTargetMri: ${m}, transferTargetParticipantLegId: ${S}`;return this.logger.info(`[${v}] consultTransferCallAsync: error: ${C}`),void this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Di.CALL_END_CODE.BAD_REQUEST,reason:C}},v)}this.transferHelper(E,"TransferTypeStandard",_,C,v)},this.isParkByTransfer=(g,m)=>{const S=["serverHold","sharedLinePark","teamPark"].indexOf(g)>-1;return this.logger.info(`[${m}][isParkByTransfer][context=${g}] result = ${S}`),S},this.parkCallAsync=(g,m=causeId2())=>{if(g&&"none"===g){throw{code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"}}return assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet"),this.logger.info(`[${m}][parkCallAsync][context=${g}]`),this.telemetryHelper.recordEvent(Li.PARK_CALL,{causeId:m,parkType:getParkTypeName(g)}),this.isParkByTransfer(g,m)?this.parkByTransfer(g,m):this.park(g,m)},this.unparkAsync=(g,m=causeId2())=>{if(g&&"none"===g){throw{code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"}}if(!this.links[Di.LINKS.UNPARK]){throw{code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark link not available"}}this.logger.info(`[${m}][unparkAsync][context=${g}]`),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UNPARK_COMPLETION,(()=>{this.handleUnparkError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UNPARK_COMPLETION_TIMEOUT,phrase:Di.CALL_END_PHRASE.UNPARK_COMPLETION_TIMEOUT},Li.WAITING_FOR_UNPARK_COMPLETION_TIMEOUT,m,g)}),Di.TIMEOUT_VALUES_IN_SECONDS.UNPARK_COMPLETION_TIMEOUT);const S={causeId:m};return this.http.sendPostRequest({url:this.links[Di.LINKS.UNPARK],requestName:Fi.SEND_UNPARK_REQUEST.name,payload:getPayload49(this,S),causeId:m}).then((g=>(this.logger.info(`[${m}][unparkAsync] response: ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_UNPARK_COMPLETION,{causeId:m}),Promise.resolve()))).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingAgentConfig);return this.logger.info(`[${m}][unparkAsync] error: ${getPrintableObject(v)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUnparkError(v.error,Li.UNPARK_REQUEST_FAILED,m,g),Promise.reject(v.error))}))},this.handleUpdateParticipantsPropertiesCompletion=g=>{const m=g.body,S=extractCauseIdFromMessage(g),v=this.logger.createChild(`[${S}][handleUpdateParticipantsPropertiesCompletion]`,this.correlationId),C={};if(this.disposed)v.info("ignored. Call disposed.");else{if(m.operationId||v.warn("operationId is undefined."),v.info("starts"),m.participantInfos)for(const g of m.participantInfos){if(!g.participant.id){v.warn("participant id is undefined."),this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,"participant id is undefined in response, property");continue}if(!g.participant.key){v.warn("property name (key) is undefined."),this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,"property name (key) is undefined in response");continue}const _=mapMriAndPropertyNameToResolveString(g.participant.id,m.operationId,g.participant.key),E={code:g.transactionEnd.code,subCode:g.transactionEnd.subCode,phrase:g.transactionEnd.phrase,resultCategories:g.transactionEnd.resultCategories};v.info(`Update participants properties completed for: ${this.piiUtils.scrubMriOrOmit(g.participant.id)} with transactionEnd ${getPrintableObject(E)}`),this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_COMPLETED,{causeId:S,resolveId:this.piiUtils.scrubMriOrOmit(_),property:g.participant.key,result:getPrintableObject(E)}),C[_]=E,this.updateParticipantsPromises[m.operationId].delete(_)}this.checkAndCleanupPromisesForOperationId(m.operationId),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(C,m.operationId,S)}},this.getCallStatus=()=>this.currentCallStatus,this.processIncomingCallRequest=(g,m,S=causeId2())=>{if(assertNotNull(g,"request should be a non null value"),assertNotNullOrEmpty(g.body,"request should have a valid body"),assertNotNullOrEmpty(g.body.gp||g.body.cp,"request body should have payload"),assert2(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.callUsesMixer=g.fromMixer,this.logger.info(`[${S}][processIncomingCallRequest][start]`),this.disposed)return void this.logger.warn("processIncomingCallRequest canceled");this.telemetryHelper.startCallInitializationWatch(),this.isIncomingCall=!0,this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Di.SIGNALING_FSM_STATE.INCOMING,this.participantManager.initializeForIncomingCall();let v={};try{m&&(v=JSON.parse(m))}catch(g){this.logger.warn("Unable to parse endpoint metadata")}this.endpointMetadata=v;try{let m;if(g?.body?.gp&&!isStringBase64(g.body.gp))this.logger.info(`[${S}][processIncomingCallRequest] unencoded payload, skipping decoding.`),m=g.body.gp;else{const S=g.body.gp?atob(g.body.gp):decodeMessage(g.body.cp);m=JSON.parse(S)}if(!m.callNotification)throw this.logger.info(`[${S}][processIncomingCallRequest][failed][reason=CallNotification missing]`),new Error("CallNotification is missing");this.processIncomingCallPayload(m,S),this.incomingCallPayload=m}catch(g){this.endIncomingCallBecauseOfInvalidPayload(S)}},this.sendAttachToCall=(g=causeId2())=>(this.logger.info(`[${g}][sendAttachToCall]`),this.incomingCallPayload?(this.onCallStatusChanged(Di.CALL_STATUS.IDLE,g),this.sendAttachToCallInternal(g)):(this.endIncomingCallBecauseOfInvalidPayload(g),Promise.reject(Di.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD))),this.supportsNewOfferRequest=()=>this.signalingAgentConfig.handleNewOfferRequest,this.requestNewOffer=(g,m=causeId2())=>(this.telemetryHelper.recordEvent(Li.REQUEST_NEW_OFFER,{compatibleContentTypes:g,causeId:m}),this.signalingAgentConfig.handleNewOfferRequest?(assertNotNullOrEmpty(this.links[Di.LINKS.NEW_OFFER],"newOffer link should be a non null value"),this.http.sendPostRequest({url:this.links[Di.LINKS.NEW_OFFER],requestName:Fi.REQUEST_NEW_OFFER.name,payload:getPayload37(this,g,this.links[Di.LINKS.NEW_OFFER]),causeId:m}).then((g=>this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):Promise.resolve(g))).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[requestNewOffer][${m}] error ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultValue:xi.RESULT_VALUE.FAILURE,endCode:S.telemetryEndSubCode,endSubCode:S.error.subCode,resultCategories:S.error.resultCategories,resultDetail:S.error.phrase||this.getTerminatingCallResultDetail("requestNewOffer",S.error),causeId:m}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,S.error),this.dispose(S.error,m),Promise.reject(S.error))}))):Promise.reject("Disabled")),this.endAsync=(g,m={})=>{m.causeId=m.causeId||causeId2();const S=m.causeId;if(this.logger.info(`[${S}][endAsync][rejectionData=${g&&getPrintableObject(g)}][endCallForAll=${m.forEveryone}]`),this.disposed)return this.logger.warn(`[${S}][endAsync] canceled but session already disposed`),Promise.resolve(null);if(this.disposing=!0,this.telemetryHelper.recordEvent(Li.END_CALL,g?{code:g.code,subCode:g.subCode,causeId:S,callEndClientSubCode:g.clientReasonSubCode,callEndClientPhrase:g.clientReasonPhrase}:{causeId:S}),m.preventAllCallbacks){const g=Object.keys(this.signalingSessionCallback);for(const m of g)this.signalingSessionCallback[m]=ji.noop}const v=this.mediaRenegotiationManager?.isIncomingRenegotiationInProgress()||this.mediaRenegotiationManager?.isOutgoingRenegotiationInProgress();if(this.telemetryHelper.stopCallCancelationDurationWatch(),this.fsmState===Di.SIGNALING_FSM_STATE.INCOMING)return g.code===Di.CALL_END_CODE.CALL_REDIRECTED?this.redirectCall(m,S,g):this.rejectIncomingCall(g,S);if(this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY)return this.cancelOutgoingCall(g,S);if(this.fsmState===Di.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK)return this.rejectIncomingCall(g,S);if((this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED||v)&&m.forEveryone)return this.deleteConversation(g,S);if(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY||v)return this.terminateEstablishedCall(g,m);{this.logger.info(`[${S}][endAsync] there is no call to cancel or end or reject in current state`);const m={code:isNaN(g?.code)?Di.CALL_END_CODE.NOT_FOUND:g.code,subCode:isNaN(g?.subCode)?Di.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED:g.subCode,phrase:g?.phrase||Di.CALL_END_PHRASE.CALL_DOES_NOT_EXIST,resultCategories:g?.resultCategories||[Ii.ExpectedError],clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};return this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultDetail:m.phrase||"CallDoesNotExist",endCode:m.code,endSubCode:m.subCode,resultCategories:m.resultCategories,causeId:S,clientReasonSubCode:m.clientReasonSubCode,clientReasonPhrase:m.clientReasonPhrase}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,S,m),this.dispose(m,S),Promise.resolve(null)}},this.handleIncomingMsgAsync=(g,m=Di.INCOMING_MESSAGE_ORIGIN.TROUTER)=>{assertNotNull(g,"incoming message should be a non null value");const S=extractMessageIdFromMessage(g),v=defer2(),C=g.body,_=g.url,E={...g,origin:m},T=extractCauseIdFromMessage(E);if(this.logger.info(`[${T}][handleIncomingMsgAsync][url=${_}][messageId=${S}]`),!C)return this.logger.info(`[${T}][handleIncomingMsgAsync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(Li.MESSAGE_MISSING_BODY,{origin:m,messageId:S,causeId:T}),v.reject(new Error("received message with no body")),v.promise;if(this.disposed)return this.logger.info(`[${T}][handleIncomingMsgAsync][failed][reason=call is disposed]`),v.reject(this.getCallNotFoundTransactionEnd()),v.promise;if(this.isDuplicatedIncomingMessage(E))return this.logger.info(`[${T}][handleIncomingMsgAsync][failed][reason=duplicate]`),this.telemetryHelper.recordEvent(Li.DUPLICATE_MESSAGE_IGNORED,{origin:m,messageId:S,causeId:T}),v.resolve(new Error("Message was already handled")),v.promise;this.checkCorrelationIdChange(g,T);const I={[wi.CALL_NOTIFICATION]:g=>{this.handleCallNotification(g)},[wi.MEDIA_ANSWER]:g=>{this.handleMediaAnswer(g)},[wi.MEDIA_ACKNOWLEDGEMENT]:g=>{this.handleMediaAcknowledgement(g)},[wi.CALL_ACCEPTANCE]:g=>{this.handleCallAcceptance(g)},[wi.CALL_END]:g=>{this.handleCallEnd(g)},[wi.CALL_PROGRESS]:g=>{this.handleCallProgress(g)},[wi.CALL_ACCEPTANCE_ACKNOWLEDGEMENT]:g=>{this.handleCallAcceptanceAck(g)},[wi.MEDIA_NEGOTIATION]:g=>{this.mediaRenegotiationManager?.handleMediaNegotiationOffer(g)},[wi.MEDIA_NEGOTIATION_FAILURE]:g=>{this.mediaRenegotiationManager?.handleMediaNegotiationFailure(g)},[wi.BALANCE_UPDATE]:g=>{this.handlePSTNBalanceUpdate(g)},[wi.RETARGET_COMPLETED]:g=>{this.mediaRenegotiationManager?.handleRetargetCompleted(g)},[wi.CALL_TRANSFER]:g=>{this.handleTransferRequested(g)},[wi.TRANSFER_COMPLETION]:g=>{this.handleTransferCompletion(g)},[wi.TRANSFER_ACCEPTANCE]:g=>{this.handleTransferAcceptance(g)},[wi.PARK_COMPLETION]:g=>{this.handleParkCompletion(g)},[wi.UNPARK_COMPLETION]:g=>{this.handleUnparkCompletion(g)},[wi.UPDATE_MEETING_LIVE_STATE_RESPONSE]:g=>{this.handleUpdateMeetingLiveStateCompletion(g)},[wi.UPDATE_MEETING_GROUPS_RESPONSE]:g=>{this.handleUpdateMeetingGroupsCompletion(g)},[wi.SET_MEETING_LAYOUT_RESPONSE]:g=>{this.handleSetMeetingLayoutCompletion(g)},[wi.UPDATE_MEETING_STATES_RESPONSE]:g=>{this.handleUpdateMeetingStatesCompletion(g)}},b={[Mi.CONTROL_VIDEO_STREAMING]:g=>{this.webRtcSignalingManager.handleControlVideoStreaming(g)},[Mi.DOMINANT_SPEAKER_INFO]:g=>{this.webRtcSignalingManager.handleDominantSpeakerInfo(g)},[Mi.CSRC_INFO]:g=>{this.webRtcSignalingManager.handleCsrcInfo(g)},[Mi.CONV_ROSTER_UPDATE]:g=>{this.handleRosterUpdate(g,!1)},[Mi.NEW_MEDIA_OFFER]:g=>{this.handleNewMediaOffer(g)},[Mi.CONV_ADD_PARTICIPANT_SUCCESS]:g=>{this.participantManager.handleAddParticipantSuccess(g)},[Mi.CONV_ADD_PARTICIPANT_FAILURE]:g=>{this.participantManager.handleAddParticipantFailure(g)},[Mi.CONV_ADMIT_PARTICIPANT_SUCCESS]:g=>{this.participantManager.handleAdmitParticipantSuccess(g)},[Mi.CONV_ADMIT_PARTICIPANT_FAILURE]:g=>{this.participantManager.handleAdmitParticipantFailure(g)},[Mi.CONV_ADMIT_ALL_STATUS]:g=>{this.handleAdmitAllStatus(g)},[Mi.CONV_REMOVE_PARTICIPANT_SUCCESS]:g=>{this.participantManager.handleRemoveParticipantSuccess(g)},[Mi.CONV_REMOVE_PARTICIPANT_FAILURE]:g=>{this.participantManager.handleRemoveParticipantFailure(g)},[Mi.CONV_CONFIRM_UNMUTE]:g=>{this.participantManager.handleUnmuteConfirmRequest(g)},[Mi.CONV_UPDATE]:g=>{this.handleConversationUpdate(g)},[Mi.CONV_LOCAL_PARTICIPANT_UPDATE]:g=>{this.handleLocalParticipantUpdate(g)},[Mi.CONV_ADD_MODALITY_SUCCESS]:g=>{this.handleAddModalitySuccess(g)},[Mi.CONV_ADD_MODALITY_FAILURE]:g=>{this.handleAddModalityFailure(g)},[Mi.CONV_BROADCAST_UPDATE]:g=>{this.broadcastSession.handleBroadcastStateChanged(g)},[Mi.CONV_CONTENT_SHARING_UPDATE]:g=>{this.contentSharingManager?.handleContentSharingUpdate(g)},[Mi.CONV_CONTENT_SHARING_END]:g=>{this.contentSharingManager?.handleContentSharingEnd(g)},[Mi.CONV_END]:g=>{this.handleCallEnd(g)},[Mi.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS]:g=>{this.participantManager.handleUpdateParticipantInterpretationStateCompletion(g)},[Mi.UPDATE_PARTICIPANT_PROPERTIES_STATUS]:g=>{this.handleUpdateParticipantsPropertiesCompletion(g)},[Mi.JOIN_MEETING_GROUP_STATUS]:g=>{this.handleJoinMeetingGroupCompletion(g)},[Mi.LEAVE_MEETING_GROUP_STATUS]:g=>{this.handleLeaveMeetingGroupCompletion(g)},[Mi.RECEIVE_MESSAGE]:g=>{this.handleReceiveMessage(g)},[Mi.SEND_MESSAGE_STATUS]:g=>{this.proxiedMessageNotificationManager.handleProxiedMessageNotification(g)},[Mi.DISABLE_PREHEAT_ASYNC_STATUS]:g=>{this.handleDisablePreheatCompletion(g)}};try{const g=Object.keys(I).filter((g=>C.hasOwnProperty(g)))[0],m=Object.keys(b).filter((g=>E.url&&stringEndsWith(E.url,g)))[0];g?I[g](E):m?b[m](E):(this.telemetryHelper.recordEvent(Li.UNKNOWN_MESSAGE_TYPE,{messageId:S}),this.logger.info(`[${T}][handleIncomingMsgAsync][failed][reason=received unknown message]`)),v.resolve(!0)}catch(g){this.telemetryHelper.recordEvent(Li.FAILED_TO_HANDLE_MESSAGE,{messageId:S,error:getPrintableObject(g)}),this.logger.info(`[${T}][handleIncomingMsgAsync][failed][reason=${g.message}]`),v.reject(new Error(g.message))}return v.promise},this.canHandleIncomingMsgSync=g=>{if(this.signalingAgentConfig.supportsSynchronousTrouterResponse){const m=g.body;return Boolean(m.callAcceptance)}return!1},this.handleIncomingMsgSync=g=>{const m=extractMessageIdFromMessage(g),S=g.body,v=g.url,C=Di.INCOMING_MESSAGE_ORIGIN.TROUTER,_={...g,origin:C},E=extractCauseIdFromMessage(_);this.logger.info(`[${E}][handleIncomingMsgSync][url=${v}][messageId=${m}]`);const T=_.headers;let I=Di.HTTP_STATUS_CODES.OK,b="";const A=new Ni;if(isDuplicateMessage(T,this.incomingTrouterMessagesSeenSoFar)){this.logger.info(`[${E}][handleIncomingMsgSync][failed][reason=duplicate]`);const g=getMessageResultFromCache(T,this.incomingMessageSyncResponseCache);if(g)return this.logger.info(`[${E}][handleIncomingMsgSync][cachedResponse]`),g;this.telemetryHelper.recordEvent(Li.DUPLICATE_MESSAGE_IGNORED,{origin:C,messageId:m,causeId:E}),this.logger.info(`[${E}][handleIncomingMsgSync][failed][reason=cachedResponseNotFound]`),I=Di.HTTP_STATUS_CODES.BAD_REQUEST}else if(S){if(S.callAcceptance)try{b=safeJsonStringify(this.handleCallAcceptanceSync(_))}catch(g){this.telemetryHelper.recordEvent(Li.FAILED_TO_HANDLE_MESSAGE,{messageId:m,origin:C,causeId:E,error:getPrintableObject(g)}),this.logger.info(`[${E}][handleIncomingMsgSync][failed][reason=${g?.message}]`),I=Di.HTTP_STATUS_CODES.BAD_REQUEST}}else this.logger.info(`[${E}][handleIncomingMsgSync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(Li.MESSAGE_MISSING_BODY,{origin:C,messageId:m,causeId:E}),I=Di.HTTP_STATUS_CODES.BAD_REQUEST;T&&(T.get(Di.HEADERS.CORRELATION_ID)&&A.set(Di.HEADERS.CORRELATION_ID,T.get(Di.HEADERS.CORRELATION_ID)),T.get(Di.HEADERS.MESSAGE_ID)&&A.set(Di.HEADERS.MESSAGE_ID,T.get(Di.HEADERS.MESSAGE_ID)));const R={resultCode:I,responseBody:b,responseHeaders:A.getAll()};return cacheMessageResult(T,this.incomingMessageSyncResponseCache,R),this.logger.info(`[${E}][handleIncomingMsgSync][success][resultCode=${I}]`),R},this.acceptRenegotiationAsync=(g,m,S=causeId2())=>(assertNotNull(g.blob,"finalSdp should be a non null value"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${S}][acceptRenegotiationAsync][mediaTypes=${m}]`),this.mediaRenegotiationManager.acceptRenegotiationAsync(g,m,S)),this.setProvisionalAnswerAsync=(g,m=causeId2())=>{assertNotNull(g.blob,"sdp should be a non null value"),this.telemetryHelper.recordEvent(Li.SET_PROVISIONAL_ANSWER,{causeId:m});const S=defer2();return this.fsmState!==Di.SIGNALING_FSM_STATE.INCOMING?(this.logger.info(`[setProvisionalAnswerAsync][${m}] there is no incoming call to set provisional answer on.`),S.reject(new Error("there is no incoming call to set provisional answer on.")),S.promise):(this.http.sendPostRequest({url:this.links[Di.LINKS.MEDIA_ANSWER],requestName:Fi.SEND_MEDIA_ANSWER.name,payload:getPayload55(this,g),causeId:m}).then((g=>{this.disposed||this.onCallStatusChanged(Di.CALL_STATUS.CONNECTING,m),S.resolve(null),this.disposed||(this.telemetryHelper.recordEvent(Li.HANDLE_MEDIA_ACKNOWLEDGEMENT,{causeId:m}),this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Di.CALL_STATUS.RINGING,m),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!1,m))})).catch((g=>{const v=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[setProvisionalAnswerAsync][${m}] error: ${getPrintableObject(v)}`),this.disposed?S.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(Li.SET_PROVISIONAL_ANSWER_FAILED,{causeId:m}),S.reject(v.error))})),S.promise)},this.startRenegotiationAsync=(g,m,S=causeId2())=>(assertNotNull(g,"mediaContent should be a non null value"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${S}][startRenegotiationAsync]`),this.mediaRenegotiationManager.startRenegotiationAsync(g,this.links[Di.LINKS.MEDIA_RENEGOTIATION],m,S)),this.updateMediaDescriptionsAsync=(g=causeId2(),m)=>{assertNotNull(m,"mediaDescriptions should be a non null value"),assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"updateMediaDescriptions operations are only allowed when the call is connected");const S=this.links[Di.LINKS.UPDATE_MEDIA_DESCRIPTIONS];return assertNotNull(S,"updateMediaDescriptionsUrl should be a non null value"),this.telemetryHelper.recordEvent(Li.UPDATE_MEDIA_DESCRIPTIONS,{causeId:g}),this.http.sendPostRequest({url:S,requestName:Fi.UPDATE_MEDIA_DESCRIPTIONS.name,payload:getPayload56(this,m),causeId:g}).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingAgentConfig);return this.logger.info(`[updateMediaDescriptionsAsync][${g}] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(Li.UPDATE_MEDIA_DESCRIPTIONS_FAILED,{causeId:g}),Promise.reject(S.error))}))},this.acceptAsync=(g,m,S,v=causeId2())=>{assertNotNull(g,"mediaContent should be a non null value"),assertNotNull(g.blob,"outgoingSdp should be a non null value"),this.logger.info(`[${v}][acceptAsync][mediaTypes=${m}]`),this.telemetryHelper.recordEvent(Li.ACCEPT_CALL,{causeId:v}),this.telemetryHelper.setAnsweredModalities(g.blob);const C=defer2();return this.fsmState!==Di.SIGNALING_FSM_STATE.INCOMING?(this.logger.warn("acceptAsync, there is no incoming call to accept"),C.reject(new Error("there is no incoming call to accept")),C.promise):(this.fsmState=Di.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK,this.http.sendPostRequest({url:this.links[Di.LINKS.ACCEPT],requestName:Fi.SEND_ACCEPTANCE.name,payload:getPayload28(this,g,m,S),causeId:v}).then((g=>{this.disposed||(this.currentCallStatus===Di.CALL_STATUS.IDLE&&(this.telemetryHelper.setTimeToRingDuration(),this.telemetryHelper.recordEvent(Li.ACCEPTED_BEFORE_RINGING,{causeId:v}),this.onCallStatusChanged(Di.CALL_STATUS.CONNECTING,v)),g.response.callAcceptanceAcknowledgement&&(this.logger.info("acceptAsync, handling inlined callAcceptanceAcknowledgement"),this.internalHandleCallAcceptanceAck(g.response,v))),C.resolve(null)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[acceptAsync][${v}] error: ${getPrintableObject(m)}`),this.disposed?C.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Di.SIGNALING_FSM_STATE.INCOMING,this.telemetryHelper.recordEvent(Li.ACCEPT_CALL_FAILED,{causeId:v,xhrError:m}),C.reject(m.error))})),C.promise)},this.rejectRenegotiationAsync=(g,m=causeId2())=>(assert2(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${m}][rejectRenegotiationAsync][rejectionData=${g}]`),this.mediaRenegotiationManager.rejectRenegotiationAsync(g,m)),this.saveMediaControllerLinksIfAny=g=>{g.links&&(this.links[Di.LINKS.CONTROL_VIDEO_STREAMING]=g.links.controlVideoStreaming||this.links[Di.LINKS.CONTROL_VIDEO_STREAMING],this.links[Di.LINKS.APPLY_CHANNEL_PARAMETERS]=g.links.applyChannelParameters||this.links[Di.LINKS.APPLY_CHANNEL_PARAMETERS])},this.getInitialMediaOfferFromIncomingCallPayload=(g=causeId2())=>{if(!this.signalingAgentConfig.handleMediaOfferFromPushNotification)return null;const m=this.incomingCallPayload?.callNotification?.mediaContent?this.incomingCallPayload.callNotification.mediaContent:null;return this.telemetryHelper.setIsSdpInCallNotification(!!m),m},this.updateCorrelationId=(g,m=causeId2())=>{if(this.logger.info(`[${m}][updateCorrelationId][old=${this.correlationId}][new=${g}]`),this.correlationId!==g&&!this.disposed){const S=this.correlationId;this.correlationId=g,this.telemetryHelper&&this.telemetryHelper.recordEvent&&this.telemetryHelper.recordEvent(Li.CORRELATION_ID_UPDATED,{newId:this.correlationId,oldId:S,causeId:m}),this.signalingSessionCallback&&this.signalingSessionCallback.onCorrelationIdUpdated&&this.signalingSessionCallback.onCorrelationIdUpdated(this.correlationId,m)}},this.endIncomingCallBecauseOfInvalidPayload=g=>{this.logger.info(`[${g}][endIncomingCallBecauseOfInvalidPayload]`),this.fsmState=Di.SIGNALING_FSM_STATE.IDLE;const m={code:Di.CALL_END_CODE.BAD_REQUEST,subCode:Di.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD,phrase:Di.CALL_END_PHRASE.BAD_NOTIFICATION_PAYLOAD,resultCategories:[Ii.UnexpectedServerError]};this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultValue:xi.RESULT_VALUE.FAILURE,endCode:m.code,endSubCode:m.subCode,resultDetail:m.phrase||"EndIncomingCall",resultCategories:m.resultCategories,causeId:g}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,g,m),this.dispose(m,g)},this.isDuplicatedIncomingMessage=g=>g.origin===Di.INCOMING_MESSAGE_ORIGIN.BROKER&&isDuplicateMessage(g.headers,this.incomingBrokerMessagesSeenSoFar)||g.origin===Di.INCOMING_MESSAGE_ORIGIN.TROUTER&&isDuplicateMessage(g.headers,this.incomingTrouterMessagesSeenSoFar),this.getEndpointState=()=>{let g;return g=this.startOrJoinConvResponseReceived?{...this.latestEndpointState}:{...this.requestedEndpointStateWhileConnecting},g},this.setMultiParty=(g,m)=>{const S=!!g;this.multiParty!==S&&(this.telemetryHelper.recordEvent(Li.SET_MULTIPARTY,{isMultiparty:S,causeId:m}),this.multiParty=S)},this.setupTrouterChannel=()=>{this.logger.info(`Broker config: outgoing=${this.signalingAgentConfig.brokerEnabledOutgoing?"enabled":"disabled"}incoming=${this.signalingAgentConfig.brokerEnabledIncoming?"enabled":"disabled"}batching=${this.signalingAgentConfig.brokerRequestBatching?"enabled":"disabled"}exclusive=${this.signalingAgentConfig.brokerExclusively?"enabled":"disabled"}`);const setTrouterUrl=g=>{g&&"string"==typeof g&&g.trim()&&(this.baseMessagingChannelUrl=this.previousTrouterUrl=this.currentTrouterUrl=g.trim(),this.telemetryHelper.addTrouterChannel())};this.brokerExclusiveEnabled()||(this.signalingAgentConfig.trouterServiceProvider?(2===this.signalingAgentConfig.trouterServiceProvider.state()&&this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync().then(setTrouterUrl),this.signalingAgentConfig.trouterServiceProvider.onStateChanged(this.onTrouterStateChanged)):(setTrouterUrl(this.signalingAgentConfig.trouterUrlGetter.trouterUrl()),this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed(this.onTrouterUrlChanged)))},this.isTrouterDisconnected=()=>{try{return 3===this.signalingAgentConfig.trouterServiceProvider.state()}catch(g){return!1}},this.forceTrouterConnectionCheck=()=>{try{return void this.signalingAgentConfig.trouterServiceProvider.checkConnection(!1)}catch(g){return}},this.navigatorOnlineCallback=()=>{this.disposed||(this.reportConnectivityStatus(),this.isTrouterDisconnected()&&this.signalingAgentConfig.forceTrouterReconnectOnNetworkOnline&&this.forceTrouterConnectionCheck())},this.navigatorOfflineCallback=()=>{this.reportConnectivityStatus()},this.reportConnectivityStatus=()=>{if(!this.disposed){const g=isTrouterAndNavigatorConnected(this.signalingAgentConfig.trouterServiceProvider);this.logger.info(`[Connectivity] status=${g}`),this.telemetryHelper.recordEvent(Li.CONNECTIVITY_CHANGED,{status:g})}},this.onTrouterStateChanged=(g,m)=>{const S=causeId2();this.logger.info(`[${S}][onTrouterStateChanged][state=${g}]`),this.disposed?this.logger.info("onTrouterStateChanged ignored"):(this.reportConnectivityStatus(),2===g&&(this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(Li.TROUTER_STATE_CHANGED,S)))},this.setupConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.addEventListener&&(window.addEventListener("online",this.navigatorOnlineCallback),window.addEventListener("offline",this.navigatorOfflineCallback))}catch(g){return}},this.tearDownConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.removeEventListener&&(window.removeEventListener("online",this.navigatorOnlineCallback),window.removeEventListener("offline",this.navigatorOfflineCallback))}catch(g){return}},this.getTrouterUrlAsync=()=>this.signalingAgentConfig.trouterServiceProvider?this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync():this.signalingAgentConfig.trouterUrlGetter.getTrouterUrlAsync(),this.brokerExclusiveEnabled=()=>this.signalingAgentConfig.brokerEnabledOutgoing&&this.signalingAgentConfig.brokerEnabledIncoming&&this.signalingAgentConfig.brokerExclusively,this.isBrokerEnabledForOutgoingCall=()=>this.signalingAgentConfig.brokerEnabledOutgoing,this.isBrokerEnabledForIncomingCall=()=>this.signalingAgentConfig.brokerEnabledIncoming,this.isHandleUnmuteMuteFromResponseEnabled=()=>this.signalingAgentConfig.handleUnmuteMuteFromResponse,this.setupBrokerChannel=()=>{this.brokerService||(this.logger.info("setupBrokerChannel, Enable broker"),this.brokerService=new Xi(this),this.brokerService.onBrokerMessage((g=>{this.logger.info("setupBrokerChannel, message from broker",g),this.handleIncomingMsgAsync(g,Di.INCOMING_MESSAGE_ORIGIN.BROKER).catch((g=>{this.telemetryHelper.recordEvent(Li.FAILED_TO_HANDLE_BROKER_MESSAGE),this.logger.info("setupBrokerChannel, Failed to handle message from broker",g)}))})),this.baseMessagingChannelUrl||(this.telemetryHelper.addBrokerChannel(),this.baseMessagingChannelUrl=this.brokerService.baseUrl))},this.onTrouterUrlChanged=()=>{const g=causeId2();this.logger.info(`[${g}][onTrouterUrlChanged]`),this.disposed?this.logger.info("onTrouterUrlChanged ignored"):this.getTrouterUrlAsync().then((m=>{this.telemetryHelper.recordEvent(Li.TROUTER_URL_CHANGED,{url:m}),this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(Li.TROUTER_URL_CHANGED,g)})).catch((g=>{this.logger.info(`Failed to update links to trouter: ${g}`)}))},this.updateLinksToTrouter=(g,m)=>{this.logger.info(`[${m}][updateLinksToTrouter][tag=${g}]`),this.ensureLatestTrouterUrl(g).then((()=>{this.previousTrouterUrl!==this.currentTrouterUrl?(this.previousTrouterUrl=this.currentTrouterUrl,this.updateConversationLinks(),this.updateKeepAliveUrl(),this.contentSharingManager?.updateContentSharingNotificationLinksAsync(m),this.broadcastSession&&this.broadcastSession.updateBroadcastCallbackUrl(m)):this.logger.info(`[${m}][updateLinksToTrouter]skip updating links, url did not change`)})).catch((g=>{this.disposed||this.telemetryHelper.recordEvent(Li.TROUTER_URL_UPDATE_FAILED,{causeId:m}),this.logger.info(`[${m}][updateLinksToTrouter][failed][reason=${getPrintableObject(g)}]`)}))},this.updateLinks=(g,m)=>{this.ensureLatestTrouterUrl(Li.TROUTER_URL_CHANGED).then((()=>{g(m)})).catch((g=>{this.disposed||this.telemetryHelper.recordEvent(Li.TROUTER_URL_UPDATE_FAILED,{causeId:m}),this.logger.warn("Failed to update links")}))},this.startCallPreheatTimer=g=>{this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT,(()=>{this.handleCallEstablishmentTimeout(g,Di.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,"Preheat timed out!"),this.terminateEstablishedCall({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,phrase:"Preheat timed out!"},{forEveryone:!1,causeId:g})}),Di.TIMEOUT_VALUES_IN_SECONDS.MAX_PREAHEATED_TIMEOUT)},this.stopCallPreheatTimer=()=>{this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT)},this.updateKeepAliveUrl=()=>{this.logger.info("updateKeepAliveUrl"),this.links.hasOwnProperty(Di.LINKS.KEEPALIVE)?(this.linkUpdateRequested.keepAliveLinks=!1,this.logger.info("updateKeepAliveUrl, sending request"),this.sendToKeepAliveUrl(getPayload40(this))):this.linkUpdateRequested.keepAliveLinks=!0},this.updateConversationLinks=(g=causeId2())=>{this.logger.info(`[${g}][updateConversationLinks]`),this.telemetryHelper.recordEvent(Li.UPDATE_CONVERSATION_LINKS,{causeId:g}),this.links.hasOwnProperty(Di.LINKS.NOTIFICATION_LINKS)?(this.linkUpdateRequested.conversationLinks=!1,this.logger.info("updateConversationLinks, sending request"),this.sendToUpdateConversationLinks(!0)):this.linkUpdateRequested.conversationLinks=!0},this.sendAttachToCallInternal=(g=causeId2())=>{this.telemetryHelper.recordEvent(Li.SEND_ATTACH,{causeId:g}),this.logger.info(`[${g}][sendAttachToCallInternal]`);const m=new Ni;return this.signalingAgentConfig.sendProgressFromCC&&m.set(Di.HEADERS.CACHE_SKYPE_TOKEN,"1"),this.http.sendPostRequest({url:this.incomingCallPayload.callNotification.links.attach,customHeaders:m,requestName:Fi.SEND_CALL_ATTACH.name,payload:getPayload26(this,this.incomingCallPayload.conversationInvitation.conversationController,!this.getInitialMediaOfferFromIncomingCallPayload()),causeId:g}).then((m=>{if(!this.disposed){this.processAttachResponse(this.incomingCallPayload,m,g);const S=m.response.additionalActionResponses;S&&S.length>0&&this.processConversationServiceResponse(S[0].output,g,0),this.onCallStatusChanged(Di.CALL_STATUS.RINGING,g),this.telemetryHelper.setTimeToRingDuration(),this.handleBrokerSubscription(m.response.callInvitation,g)}})).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingAgentConfig);this.logger.info(`[${g}][sendAttachToCallInternal] error: ${getPrintableObject(m)} xhrError: ${getPrintableObject(S)}`),this.disposed||(this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultValue:xi.RESULT_VALUE.FAILURE,endCode:S.telemetryEndSubCode,endSubCode:S.error.subCode,resultCategories:S.error.resultCategories,resultDetail:S.error.phrase||this.getTerminatingCallResultDetail("attach",S.error),causeId:g}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,g,S.error),this.dispose(S.error,g))}))},this._processCallAcceptance=(g,m)=>{if(this.logger.info(`[${m}][_processCallAcceptance]`),this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING){this.processCallAcceptance(g.body,m),this.telemetryHelper.setTimeToRingDuration();try{this.multiParty||this.callUsesMixer||this.participantManager.handleRosterUpdate(this.getFakeRoster(g.body),!0,m)}catch(S){const v={code:Di.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Di.CALL_END_SUB_CODE.CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE,phrase:S?.toString()};throw this.logger.info(`[${m}][_processCallAcceptance] ${safeJsonStringify(v)}`),this.telemetryHelper.recordRosterEvent(g,Li.HANDLE_ROSTER_UPDATE_FAIL,m),v}}},this.restartKeepAliveInterval=(g=!1,m)=>{this.disposed||(g&&this.telemetryHelper.recordEvent(Li.SEND_KEEP_ALIVE_FAILED,m),this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval))},this.isCallOngoing=()=>this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Di.SIGNALING_FSM_STATE.IDLE,this.isCallIdleOrRosterOnly=()=>this.fsmState===Di.SIGNALING_FSM_STATE.IDLE||this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.isCallConnectedOrConnectedForRoster=()=>this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,_&&(this.callStartTime=_),this.signalingSessionCallback=m,this.signalingAgentConfig=S,this.signalingAgent=C,this.urlIdentifier=v,this.piiUtils=new Gi(S.piiScrubber),this.isHostLessCall=S.doHostlessCalling||!1,this.logger=S.logger.createChild((()=>`CSA[${this.correlationId}][${this.fsmState}]`),this.correlationId,!0),this.updateCorrelationId(v),this.logger.info(`[endpointId=${truncate(this.signalingAgent.endpointId)}]`),this.logger.info(`[participantId=${g.participantId}]`),this.callOperationHandler=new en(this.logger.createChild((()=>`[CallOperationHandler][${g.participantId}]`))),this.http=new mn(this,this.callStartTime),this.telemetryHelper=new Rn(this,g,this.callStartTime),this.mediaRenegotiationManager=new fn(this,m,this.telemetryHelper),this.participantManager=new En(this,m,g),this.proxiedMessageNotificationManager=new Tn(this),this.timeoutManager=new Vi(this.logger),this.contentSharingManager=new rn(this,m),this.webRtcSignalingManager=new Pn(this,m),this.pstnContent={emergencyCallCountry:S.emergencyCallCountry||"",platformName:S.clientInformation,publicApiCall:!1},this.setupTrouterChannel(),this.setupConnectionCheck()}onPromotionCompleted(g,m,S){this.logger.info(`[${S}][onPromotionCompleted] isFailed=${g} error=${getPrintableObject(m)}]`),this.isPromotingToRealtime=!1,this.signalingSessionCallback.onPromotionCompleted(g,m,S)}setRealTimeState(g,m){let S=g;(2===g&&1===this.realTimeState||1===g&&2===this.realTimeState)&&(S=3),S!==this.realTimeState&&(this.logger.info(`[${m}][setRealTimeState] changed: input=${g} old=${this.realTimeState}, new=${S}`),this.realTimeState=S,(3===S||0===this.callMode&&(2===S||this.signalingAgentConfig.disableRealTimeModeFromRoster&&1===S))&&this.setCallMode(1,m))}setCallMode(g,m){this.callMode!==g&&(this.logger.info(`[${m}][setCallMode] oldMode=${this.callMode}, newMode=${g}`),this.callMode=g,this.signalingSessionCallback.onCallModeChanged(this.callMode,m))}configureStreamingMode(g){2!==this.callMode?(this.logger.info(`[${g}][configureStreamingMode]`),this.setCallMode(2,g),this.cleanUpDueToStreaming(g),this.onCallStatusChanged(Di.CALL_STATUS.CONNECTED,g)):this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT)}updateDominantSpeakerHistoryMessageSubscription(g){this.webRtcSignalingManager.getIsDominantSpeakerInfoLinkEnabled()!==g&&(this.logger.info(`Signaling dominant speaker history subscription updated: ${g}`),this.webRtcSignalingManager.setIsDominantSpeakerInfoLinkEnabled(g),this.webRtcSignalingManager.areClientURLsGenerated()&&this.updateKeepAliveUrl())}cleanUpDueToStreaming(g){this.setRealTimeState(0,g),this.fsmState=Di.SIGNALING_FSM_STATE.CONNECTED,this.isPromotingToRealtime=!1,this.provisionalMediaAnswersSeenSoFar=[],this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=new fn(this,this.signalingSessionCallback,this.telemetryHelper),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const m={code:Di.CALL_END_CODE.SUCCESS,subCode:Di.CALL_END_SUB_CODE.DOWNGRADE_TO_STREAMING_CLIENT,phrase:Di.CALL_END_PHRASE.DOWNGRADE_TO_STREAMING_CLIENT},S=Fi;for(const v of Object.keys(S))0!==S[v].controller&&4!==S[v].controller&&3!==S[v].controller||this.http.cancelRequestIfPending(S[v].name,g,void 0,m)}updateEndpointMetadata(g,m=causeId2()){let S={};try{S=JSON.parse(g)}catch(g){return Promise.reject("Invalid metadata")}return this.http.sendPutRequest({url:this.links[Di.LINKS.UPDATE_ENDPOINT_METADATA],requestName:Fi.UPDATE_ENDPOINT_METADATA.name,payload:getPayload50(this,S),causeId:m}).then((()=>{this.telemetryHelper.recordEvent(Li.UPDATE_ENDPOINT_METADATA_SUCCESS,{causeId:m})})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${m}][updateEndpointMetadata] error: ${getPrintableObject(S)}`),this.telemetryHelper.recordEvent(Li.UPDATE_ENDPOINT_METADATA_FAILURE,{...S.error}),Promise.reject(S.error)}))}isOneToOnePSTNCall(){return this.signalingSessionCallback.isOneToOnePstnCall()}getLocationContent(){return this.isOneToOnePSTNCall()?tryParse(this.locationInfoContent):null}getNetworkContent(){return this.isOneToOnePSTNCall()?tryParse(this.networkInfoContent):null}getAreaContent(){return this.isOneToOnePSTNCall()?tryParse(this.areaContent):null}setLocationInfo(g,m,S){this.locationInfoContent=g,this.networkInfoContent=m,this.areaContent=S}setStreamInformationReceived(){this.disposed||this.streamInformationReceived||(this.streamInformationReceived=!0,this.telemetryHelper.recordEvent(Li.SET_STREAM_INFORMATION_RECEIVED))}getEndpointCapabilities(){let g=0;return this.signalingAgentConfig.brokerEnabledIncoming&&(g|=16),this.signalingAgentConfig.isGVCJoiningEnabled&&(g|=1),"disabled"!==this.signalingAgentConfig.cloudScreenSharingFlag&&(g|=2),this.signalingAgentConfig.supportsHostlessGroupCalls&&(g|=4),this.signalingAgentConfig.autoJoinOnConflict&&(g|=32),this.signalingAgentConfig.supportsCompressedServicePayload&&(g|=128),this.signalingAgentConfig.enableAutoPromotion&&(g|=65536),this.signalingAgentConfig.enableBatchedSendMessageStatus&&(g|=16384),this.signalingAgentConfig.enableBatchedReceiveMessage&&(g|=8192),g|=64,g|=1024,this.signalingAgent?.accountConfig?.clientSupportsAudioOnlyWatermark&&(g|=4096,this.telemetryHelper.setAudioOnlyWatermark(!0)),this.signalingAgent?.accountConfig?.clientSupportsWatermark&&(g|=2048,this.telemetryHelper.setWatermarkSupport(!0)),(this.getMaxReinvitelessMediaForVBSSForWeb()||this.getMaxReinvitelessMediaForVideoForWeb())&&(this.telemetryHelper.setReinviteless(this.callUsesMixer),g|=512),g}handleAdmitAllStatus(g){const m=g.body?.transactionResponse,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleAdmitAllStatus][${getPrintableObject(m)}]`);const v=m?.operationId;if(v&&this.callOperationHandler.hasPendingOperation(0,v,S)){this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT,v);const g=m?.result?.code,C=m?.result?.subCode,_=m?.result?.resultCategories,E=m?.additionalDetail;if(0===g||g>=200&&g<300){const m={code:g,subCode:C,resultCategories:_,result:safeJsonStringify(E)};this.telemetryHelper.recordEvent(Li.ADMIT_SUCCESS,{causeId:v,transactionEnd:m}),this.callOperationHandler.resolvePendingOperation(0,v,m,S)}else{const E={code:g||Di.CALL_END_CODE.BAD_REQUEST,subCode:C||0,resultCategories:_,result:m,phrase:Di.CALL_END_PHRASE.BAD_SERVICE_RESPONSE};this.telemetryHelper.recordEvent(Li.ADMIT_FAILURE,{causeId:v,transactionEnd:E}),this.callOperationHandler.rejectPendingOperation(0,v,"AdmitAllStatus response contains failure",E,S)}}else this.logger.warn(`[${S}][handleAdmitAllStatus] invalid admitAllStatus response or no pending operation. operationId=${v}`)}sendNetworkRequestForAdmit(g){const onceTrouterReady=()=>{this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.ADMIT,(()=>{this.telemetryHelper.recordEvent(Li.ADMIT_TIMEOUT,{causeId:g}),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT,g),this.callOperationHandler.rejectPendingOperation(0,g,"timed out waiting for admit operation",{code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.ADMIT_TIMEOUT,phrase:Di.CALL_END_PHRASE.ADMIT_TIMEOUT},g)}),Di.TIMEOUT_VALUES_IN_SECONDS.ADMIT_TIMEOUT,g)};this.http.sendPostRequest({url:this.links[Di.LINKS.ADMIT_ALL],requestName:Fi.ADMIT.name,payload:getPayload25(this,g),causeId:g,onceTrouterReady:onceTrouterReady}).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingAgentConfig);this.telemetryHelper.recordEvent(Li.ADMIT_FAILURE,{causeId:g,...S.error}),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.ADMIT,g),this.callOperationHandler.rejectPendingOperation(0,g,m,S.error,g)}))}getConversationType(g,m,S){return g?"emergencyGroupCall":m?"cast":S?"huddleGroupCall":null}getMaxReinvitelessMediaForVideoForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVideoForWeb}getMaxReinvitelessMediaForVBSSForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVBSSForWeb}convertParkType(g){return"teamPark"===g?"TransferTypeTeamPark":"sharedLinePark"===g?"TransferTypeSharedLinePark":"serverHold"===g?"TransferTypeServerHold":(this.logger.info(`convertParkType, parkType: ${g} is unknown`),"none")}parkByTransfer(g,m){this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(m)}),Di.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT);const S=this.getNetworkRequestName(g);return this.http.sendPostRequest({url:this.links[Di.LINKS.TRANSFER],requestName:S,payload:getPayload38(g,this),causeId:m}).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${m}][parkByTransfer] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Di.CALL_END_CODE.NETWORK_ERROR,reason:getPrintableObject(g)}},m),this.telemetryHelper.recordEvent(Li.TRANSFER_REQUEST_FAILED,{causeId:m,...S.error}),Promise.reject(S.error))})),this.telemetryHelper.recordEvent(Li.TRANSFER_REQUEST_SENT,{causeId:m,transferType:this.convertParkType(g)}),Promise.resolve()}park(g,m){this.logger.info(`[${m}][park] context ${g}`),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.PARK_COMPLETION,(()=>{this.handleParkError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.PARK_COMPLETION_TIMEOUT,phrase:Di.CALL_END_PHRASE.PARK_COMPLETION_TIMEOUT},Li.WAITING_FOR_PARK_COMPLETION_TIMEOUT,m,g)}),Di.TIMEOUT_VALUES_IN_SECONDS.PARK_COMPLETION_TIMEOUT);const S=this.getHoldTypeInRequest(g),v={causeId:m};return this.http.sendPostRequest({url:this.links[Di.LINKS.PARK],requestName:Fi.PARK_REQUEST.name,payload:getPayload39(this,S,v),causeId:m}).then((g=>{this.logger.info(`[${m}][park] response: ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_PARK_COMPLETION,{causeId:m}),assertNotNull(g.response.holdResponse.links,"server response does not include park links"),this.links[Di.LINKS.UNPARK]=g.response.holdResponse.links.resume})).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingAgentConfig);return this.logger.info(`[${m}][park] error: ${getPrintableObject(v)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleParkError(v.error,Li.PARK_REQUEST_FAILED,m,g),Promise.reject(v.error))})),Promise.resolve()}getHoldTypeInRequest(g){switch(g){case"serverHoldV2":return"musicOnHold";case"sharedLineParkV2":return"sharedLineAppearance";case"callPark":return"callPark";default:return null}}handleParkError(g,m,S,v){this.disposed?this.logger.info("handleParkError ignored"):(this.logger.info(`[${S}] handleParkError reject reason: ${getPrintableObject(g)}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.PARK_COMPLETION),this.signalingSessionCallback.onParkCompleted&&(this.telemetryHelper.recordEvent(m,{...g,parkContext:v,causeId:S}),this.signalingSessionCallback.onParkCompleted(g,S)),this.links[Di.LINKS.UNPARK]=void 0)}handleParkCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g),v=m.holdCompletion;this.handleOperationCompletionCommon(v,S,void 0,getPrintableObject(m),"handleParkCompletion",Di.TIMEOUT_OPERATIONS.PARK_COMPLETION,Li.PARK_COMPLETED,Li.PARK_FAILED,this.signalingSessionCallback.onParkCompleted,this.handleParkError.bind(this))}handleUnparkError(g,m,S,v){this.disposed?this.logger.info("handleUnparkError ignored"):(this.logger.info(`[${S}] handleUnparkError reject reason: ${g}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.signalingSessionCallback.onUnparkCompleted&&(this.telemetryHelper.recordEvent(m,{...g,parkContext:v,causeId:S}),this.signalingSessionCallback.onUnparkCompleted(g,S)),this.links[Di.LINKS.UNPARK]=void 0)}handleUnparkCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g);if(this.disposed)return void this.logger.info(`[${S}]handleUnparkCompletion ignored`);this.logger.info(`[${S}][handleUnparkCompletion] body ${getPrintableObject(m)}`);const v=m.resumeCompletion;v.code===Di.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.telemetryHelper.recordEvent(Li.UNPARK_COMPLETED,{...v,causeId:S}),this.signalingSessionCallback.onUnparkCompleted(v,S),this.links[Di.LINKS.UNPARK]=void 0):this.handleUnparkError(v,Li.UNPARK_FAILED,S)}getNetworkRequestName(g){return{none:null,teamPark:Fi.SEND_PARK_REQUEST.name,sharedLinePark:Fi.SEND_SHARED_LINE_PARK_REQUEST.name,serverHold:Fi.SEND_SERVER_HOLD_REQUEST.name}[g]}updateMeetingsGroupsAsync(g,m){this.logger.info(`[${g}][updateMeetingsGroupsAsync] scope=${m.scope}`),this.telemetryHelper.recordEvent(Li.UPDATE_MEETING_GROUPS,{causeId:g,options:m}),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION,(()=>{this.handleUpdateMeetingGroupsError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT,phrase:Di.CALL_END_PHRASE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT},Li.WAITING_FOR_UPDATE_MEETING_GROUPS_COMPLETION,g,g,m)}),Di.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT);const S=getMeetingGroupsPayload(this,m,g);return this.http.sendPostRequest({url:this.links[Di.LINKS.UPDATE_MEETING_GROUPS],requestName:Fi.UPDATE_MEETING_GROUPS.name,payload:S,causeId:g}).then((m=>{this.logger.info(`[${g}][updateMeetingsGroupsAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_UPDATE_MEETING_GROUPS_COMPLETION,{causeId:g})})).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingAgentConfig);return this.logger.info(`[${g}][updateMeetingsGroupsAsync] error: ${getPrintableObject(v)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingGroupsError(v.error,Li.UPDATE_MEETING_GROUPS_REQUEST_FAILED,g,g,m),Promise.reject(v.error))}))}updateParticipantInterpretationStateAsync(g,m){return assertNotNullOrEmpty(m,"options should be a non null value"),this.logger.info(`[${g}][updateParticipantInterpretationStateAsync]`),this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANT_INTERPRETATION_STATE,{causeId:g,options:m}),this.participantManager.updateParticipantInterpretationStateAsync(m,this.links[Di.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE],g)}async sendProxiedMessageAsync(g,m){return m&&0!==m.length?this.links[Di.LINKS.SEND_MESSAGE]?this.proxiedMessageNotificationManager.sendProxiedMessageAsync(g,m,this.links[Di.LINKS.SEND_MESSAGE]):Promise.reject({code:Di.VALIDATION.VALIDATION_FAILED,subCode:Di.VALIDATION.NULL_OR_EMPTY,phrase:"missing url for CONSTANTS.LINKS.SEND_MESSAGE"}):Promise.reject({code:Di.VALIDATION.VALIDATION_FAILED,subCode:Di.VALIDATION.NULL_OR_EMPTY,phrase:"options should be a non empty array"})}async updateParticipantsPropertiesAsync(g,m,S,v){this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANTS_PROPERTIES,{causeId:v,updateParticipantsPropertiesContext:g});const C=this.links[Di.LINKS.UPDATE_PARTICIPANTS_PROPERTIES],_=[],E=g.scope;if("self"===E){const m={id:this.participantManager.localParticipant.id,propertyBag:g.propertyBag};_.push(m)}else{if("specified"!==E)return Promise.reject("This scope is not Supported");{const m=g.participants;for(const g of m){const m={id:g.id,propertyBag:g.propertyBag};_.push(m)}}}return this.sendNetworkRequestForUpdateParticipantsProperties(_,m,C,S,v)}sendNetworkRequestForUpdateParticipantsProperties(g,m,S,v,C){const _=this.logger.createChild(`[${C}][sendNetworkRequestForUpdateParticipantsProperties]`,this.correlationId);if(S){const onceTrouterReady=()=>{const g={code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT,phrase:Di.CALL_END_PHRASE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT};this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,(()=>{this.handleUpdateParticipantsPropertiesOnTimeout(m,g,Li.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT,v,C)}),Di.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT,v)},E=getUpdateParticipantsPropertiesPayload(this,g,v);return this.updateParticipantsPromises[v]=m,this.http.sendPostRequest({url:S,payload:E,requestName:Fi.UPDATE_PARTICIPANTS_PROPERTIES.name,onceTrouterReady:onceTrouterReady,causeId:C}).then((g=>{_.info(`response: ${getPrintableObject(g)}`)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);_.info(`failed: ${getPrintableObject(m)}`);const S={...m.error};return this.disposed||(this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,v),delete this.updateParticipantsPromises[v]),this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,{causeId:C,transactionEnd:S}),Promise.reject(S)}))}{const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING,phrase:"updateParticipantsProperties link is missing"};return _.warn(g),this.telemetryHelper.recordEvent(Li.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,{causeId:C,error:g}),Promise.reject(g)}}checkAndCleanupPromisesForOperationId(g){this.updateParticipantsPromises[g]&&(0===this.updateParticipantsPromises[g].size?(delete this.updateParticipantsPromises[g],this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,g)):this.logger.info(`remaining promises for the operation  ${g} (count: ${this.updateParticipantsPromises[g].size}): \n                ${this.piiUtils.scrubMriOrOmit(safeJsonStringify(this.updateParticipantsPromises[g]))}`))}handleUpdateParticipantsPropertiesOnTimeout(g,m,S,v,C){if(this.disposed)return void this.logger.info("handleUpdateParticipantsPropertiesOnTimeout ignored");this.logger.createChild(`[${C}][handleUpdateParticipantsPropertiesOnTimeout]`,this.correlationId).info(`reason: ${m}`),this.telemetryHelper.recordEvent(S,{...m,causeId:C});const _={};g.forEach((g=>{_[g]=m,this.updateParticipantsPromises[v].delete(g)})),this.checkAndCleanupPromisesForOperationId(v),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(_,v,C)}joinMeetingGroupAsync(g,m){this.logger.info(`[${g}][joinMeetingGroupAsync]`),this.telemetryHelper.recordEvent(Li.JOIN_MEETING_GROUP,{causeId:g,options:m}),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION,(()=>{this.handleJoinMeetingGroupError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.JOIN_MEETING_GROUP_TIMEOUT,phrase:Di.CALL_END_PHRASE.JOIN_MEETING_GROUP_TIMEOUT},Li.WAITING_FOR_JOIN_MEETING_GROUP_COMPLETION,g,g,m)}),Di.TIMEOUT_VALUES_IN_SECONDS.JOIN_MEETING_GROUP_COMPLETION_TIMEOUT);const S=getJoinMeetingGroupPayload(this,m,g);return this.http.sendPostRequest({url:this.links[Di.LINKS.JOIN_MEETING_GROUP],requestName:Fi.JOIN_MEETING_GROUP.name,payload:S,causeId:g}).then((m=>{this.logger.info(`[${g}][joinMeetingGroupAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_JOIN_MEETING_GROUP_COMPLETION,{causeId:g})})).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingAgentConfig);return this.logger.info(`[${g}][joinMeetingGroupAsync] error: ${getPrintableObject(v)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleJoinMeetingGroupError(v.error,Li.JOIN_MEETING_GROUP_REQUEST_FAILED,g,g,m),Promise.reject(v.error))}))}leaveMeetingGroupAsync(g,m){this.logger.info(`[${g}][leaveMeetingGroupAsync]`),this.telemetryHelper.recordEvent(Li.LEAVE_MEETING_GROUP,{causeId:g,options:m}),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION,(()=>{this.handleLeaveMeetingGroupError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.LEAVE_MEETING_GROUP_TIMEOUT,phrase:Di.CALL_END_PHRASE.LEAVE_MEETING_GROUP_TIMEOUT},Li.WAITING_FOR_LEAVE_MEETING_GROUP_COMPLETION,g,g,m)}),Di.TIMEOUT_VALUES_IN_SECONDS.LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT);const S=getLeaveMeetingGroupPayload(this,m,g);return this.http.sendPostRequest({url:this.links[Di.LINKS.LEAVE_MEETING_GROUP],requestName:Fi.LEAVE_MEETING_GROUP.name,payload:S,causeId:g}).then((m=>{this.logger.info(`[${g}][leaveMeetingGroupAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_LEAVE_MEETING_GROUP_COMPLETION,{causeId:g})})).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingAgentConfig);return this.logger.info(`[${g}][leaveMeetingGroupAsync] error: ${getPrintableObject(v)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleLeaveMeetingGroupError(v.error,Li.LEAVE_MEETING_GROUP_REQUEST_FAILED,g,g,m),Promise.reject(v.error))}))}handleUpdateMeetingGroupsError(g,m,S,v,C){this.disposed?this.logger.info(`[${S}][handleUpdateMeetingGroupsError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${S}][handleUpdateMeetingGroupsError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,updateMeetingGroupsOptions:C,causeId:S}),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(g,S,v))}handleUpdateMeetingGroupsCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g),v=m.updateMeetingGroupsResponse.operationId;if(this.disposed)return void this.logger.info(`[${S}][handleUpdateMeetingGroupsCompletion] ignored. Call disposed.`);v||this.logger.warn(`[${S}][handleUpdateMeetingGroupsCompletion] operationId is undefined.`),this.logger.info(`[${S}][handleUpdateMeetingGroupsCompletion] starts`);const{updateMeetingGroupsResponse:C}=m,_=processTransactionResponse(C);_.code===Di.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${S}][handleUpdateMeetingGroupsCompletion] update meeting group succeeded`),this.telemetryHelper.recordEvent(Li.UPDATE_MEETING_GROUPS_RESPONSE_SUCCESS,{..._,causeId:S})):(this.logger.info(`[${S}][handleUpdateMeetingGroupsCompletion] update meeting group failed code=${_.code} subCode=${_.subCode}`),this.telemetryHelper.recordEvent(Li.UPDATE_MEETING_GROUPS_RESPONSE_FAILURE,{..._,causeId:S})),this.logger.info(`[${S}][handleUpdateMeetingGroupsCompletion] completes`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(_,S,v)}handleJoinMeetingGroupError(g,m,S,v,C){this.disposed?this.logger.info(`[${S}][handleJoinedMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${S}][handleJoinedMeetingGroupError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,joinMeetingGroupOptions:C,causeId:S}),this.signalingSessionCallback.onJoinMeetingGroupCompleted(g,S,v))}handleJoinMeetingGroupCompletion(g){const m=g.body.joinMeetingGroupResponse,S=extractCauseIdFromMessage(g),v=m.operationId;if(this.disposed)return void this.logger.info(`[${S}][handleJoinMeetingGroupCompletion] ignored. Call disposed.`);v||this.logger.warn(`[${S}][handleJoinMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${S}][handleJoinMeetingGroupCompletion] starts`);const C=processTransactionResponse(m);C.code===Di.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${S}][handleJoinMeetingGroupCompletion] join meeting group succeeded`),this.telemetryHelper.recordEvent(Li.JOIN_MEETING_GROUP_RESPONSE_COMPLETED,{...C,causeId:S})):(this.logger.info(`[${S}][handleJoinMeetingGroupCompletion] join meeting group failed code=${C.code} subCode=${C.subCode}`),this.telemetryHelper.recordEvent(Li.JOIN_MEETING_GROUP_RESPONSE_FAILED,{...C,causeId:S})),this.logger.info(`[${S}][handleJoinMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onJoinMeetingGroupCompleted(C,S,v)}handleLeaveMeetingGroupError(g,m,S,v,C){this.disposed?this.logger.info(`[${S}][handleLeaveMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${S}][handleLeaveMeetingGroupError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,leaveMeetingGroupOptions:C,causeId:S}),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(g,S,v))}handleLeaveMeetingGroupCompletion(g){const m=g.body.leaveMeetingGroupResponse,S=extractCauseIdFromMessage(g),v=m.operationId;if(this.disposed)return void this.logger.info(`[${S}][handleLeaveMeetingGroupCompletion] ignored. Call disposed.`);v||this.logger.warn(`[${S}][handleLeaveMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${S}][handleLeaveMeetingGroupCompletion] starts`);const C=processTransactionResponse(m);C.code===Di.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${S}][handleLeaveMeetingGroupCompletion] leave meeting group succeeded`),this.telemetryHelper.recordEvent(Li.LEAVE_MEETING_GROUP_RESPONSE_COMPLETED,{...C,causeId:S})):(this.logger.info(`[${S}][handleLeaveMeetingGroupCompletion] leave meeting group failed code=${C.code} subCode=${C.subCode}`),this.telemetryHelper.recordEvent(Li.LEAVE_MEETING_GROUP_RESPONSE_FAILED,{...C,causeId:S})),this.logger.info(`[${S}][handleLeaveMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(C,S,v)}handleDisablePreheatError(g,m,S){this.disposed?this.logger.info(`[${S}][handleDisablePreheatError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${S}][handleDisablePreheatError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),this.telemetryHelper.recordEvent(m,{...g,causeId:S}),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject(g))}handleDisablePreheatCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g),v=m.transactionEnd;if(this.disposed)this.logger.info(`[${S}][handleDisablePreheatCompletion] ignored. Call disposed.`);else if(this.disablePreheatDefer.isPending()){if(this.logger.info(`[${S}][handleDisablePreheatCompletion] starts`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),v.code===Di.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${S}][handleDisablePreheatCompletion] update endpoint state succeeded`),this.handleEndpointStateUpdated(S,!0);else if(this.logger.info(`[${S}][handleDisablePreheatCompletion] update endpoint state failed code=${v.code} subCode=${v.subCode}`),this.disablePreheatDefer.isPending()){const g={response:v};this.disablePreheatDefer.reject(g)}}else this.logger.info(`[${S}][handleDisablePreheatCompletion] ignored. Disable preheat promise is resolved/rejected.`)}handleReceiveMessage(g){const m=extractCauseIdFromMessage(g);if(this.disposed)return void this.logger.info(`[${m}][handleReceiveMessage] ignored. Call disposed.`);let S;S=Array.isArray(g.body?.messageContent)?g.body.messageContent:[g.body];let v="";const C=[];for(let g=0;g<S.length;g++){const m=S[g];v+=m?.operationId,g<S.length-1&&(v+=","),C.push({operationId:m.operationId,messageType:m.type,payload:m.payload,from:{[m.from.id]:{participantLegIdMap:{[m.from.participantId]:{...m.from.endpointId&&{endpointId:m.from.endpointId}}},level:"endpoint"}}})}this.logger.info(`[${m}][handleReceiveMessage] complete. OperationIds:${v}`),this.telemetryHelper.recordEvent(Li.INCOMING_PROXIED_MESSAGES,{causeId:m,operationIds:v}),this.signalingSessionCallback.onIncomingProxiedMessages(C,m)}publishStateAsync(g,m,S,v,C,_){this.logger.info(`[${S}][publishStateAsync][publishType=${g} publishLevel=${m}]`),this.telemetryHelper.recordEvent(Li.PUBLISH_STATE,{causeId:S,publishType:g,publishLevel:m});const E=this.links[Di.LINKS.PUBLISH_STATE];if(!E){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.PUBLISH_STATE_LINK_MISSING,phrase:"publish state link is missing"};return this.logger.warn(g),Promise.reject(g)}let T={};try{T=JSON.parse(v)}catch(g){const m={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_CONTENT,phrase:"publish state content is invalid"};return this.logger.warn(m),Promise.reject(m)}return this.http.sendPostRequest({url:E,requestName:Fi.PUBLISH_STATE.name,payload:getPayload41(this,g,m,T,C,_),causeId:S,requestId:S}).then((g=>{if(g?.response?.publishStateResponse)return this.parsePublishStateResult(g,S);{const m=`Invalid CS response which does not contains publishStateResponse. Respone: ${g?.response?JSON.stringify(g.response):"no response"}`;throw this.logger.warn(m),{response:{code:Di.CALL_END_CODE.DECODING_FAILED,subCode:Di.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:m}}}})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${S}][publishStateAsync] error: ${getPrintableObject(m)}`);const v=m.error;return this.telemetryHelper.recordEvent(Li.PUBLISH_STATE_FAILURE,{causeId:S,transactionEnd:v}),Promise.reject(v)}))}getPublishStateSequenceNumber(){return++this.publishStateSequenceNumber}parsePublishStateResult(g,m){let S={};if(g?.response?.publishStateResponse){if(g.response.publishStateResponse.stateId)return g.response.publishStateResponse.stateId;if(g.response.publishStateResponse.results){if(1===g.response.publishStateResponse.results.length){if(g.response.publishStateResponse.results[0].stateId)return g.response.publishStateResponse.results[0].stateId;this.logger.warn("invalid response format")}return g.response.publishStateResponse.results.forEach((g=>{S[g.participantId]={code:g.result.code,phrase:g.result.phrase,subCode:g.result.subCode}})),JSON.stringify(S)}if(g.response.publishStateResponse.result)return S={code:g.response.publishStateResponse.result.code,phrase:g.response.publishStateResponse.result.phrase,subCode:g.response.publishStateResponse.result.subCode,result:g.response.publishStateResponse.additionalDetail},JSON.stringify(S)}const v=`Invalid CS response which does not contains publishStateResponse. Respone: ${g?.response?JSON.stringify(g.response):"no response"}`;throw this.logger.warn(v),{response:{code:Di.CALL_END_CODE.DECODING_FAILED,subCode:Di.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:v}}}removeStateAsync(g,m,S,v){if(this.logger.info(`[${g}][removeStateAsync][scope=${m} publishType=${S} stateIds=${v}]`),this.telemetryHelper.recordEvent(Li.REMOVE_STATE,{causeId:g,scope:m,publishType:S,stateIds:v}),!S&&!v){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.REMOVE_STATE_MISSING_ARGUMENTS,phrase:"remove state operation miss arguments"};return this.logger.warn(g),Promise.reject(g)}const C=this.links[Di.LINKS.REMOVE_STATE];if(!C){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.REMOVE_STATE_LINK_MISSING,phrase:"remove state link is missing"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPostRequest({url:C,requestName:Fi.REMOVE_STATE.name,payload:getPayload43(this,m,v,S),causeId:g,requestId:g}).then((m=>this.parseRemoveStateResult(m,g))).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingAgentConfig);this.logger.info(`[${g}][removeStateAsync] error: ${getPrintableObject(S)}`);const v=S.error;return this.telemetryHelper.recordEvent(Li.REMOVE_STATE_FAILURE,{causeId:g,transactionEnd:v}),Promise.reject(v)}))}parseRemoveStateResult(g,m){let S={};return g?.response?.removeStateResponse&&(g.response.removeStateResponse.results?g.response.removeStateResponse.results.forEach((g=>{S[g.stateId]={code:g.result.code,phrase:g.result.phrase,subCode:g.result.subCode}})):g.response.removeStateResponse.result&&(S={code:g.response.removeStateResponse.result.code,phrase:g.response.removeStateResponse.result.phrase,subCode:g.response.removeStateResponse.result.subCode,result:g.response.removeStateResponse.additionalDetail})),JSON.stringify(S)}updateMeetingSettingsAsync(g,m){this.telemetryHelper.recordEvent(Li.UPDATE_MEETING_SETTINGS,{causeId:m,meetingSettings:g});const S=this.links[Di.LINKS.UPDATE_MEETING_SETTINGS];if(!S){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_LINK_MISSING,phrase:"update meeting settings link is missing"};return this.logger.warn(g),Promise.reject(g)}if(!Object.keys(g).length){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS,phrase:"update meeting settings missing arguments"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPutRequest({url:S,requestName:Fi.UPDATE_MEETING_SETTINGS.name,payload:getPayload53(this,g),causeId:m,requestId:m}).then((()=>{ji.noop()})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][updateMeetingSettingsAsync] error: ${getPrintableObject(S)}`);const v=S.error;throw this.telemetryHelper.recordEvent(Li.UPDATE_MEETING_SETTINGS_FAILURE,{causeId:m,transactionEnd:v}),v}))}searchParticipantsAsync(g,m){this.logger.info(`[${m}][searchParticipantsAsync][queryOptions=${g}]`),this.telemetryHelper.recordEvent(Li.SEARCH_PARTICIPANTS,{causeId:m,queryOptions:g});const S=this.links[Di.LINKS.SEARCH_PARTICIPANTS];if(!S){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_LINK_MISSING,phrase:"search participants link is missing"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPostRequest({url:S,requestName:Fi.SEARCH_PARTICIPANTS.name,payload:getPayload44(this,g),causeId:m,requestId:m}).then((g=>{if(g?.response?.participants)return this.parseSearchParticipantsResult(g,m);{const m=`Invalid CS response which does not contain proper search results. Respone: ${g?.response?JSON.stringify(g.response):"no response"}`;throw this.logger.warn(m),{response:{code:Di.CALL_END_CODE.DECODING_FAILED,subCode:Di.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:m}}}})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][searchParticipantsAsync] error: ${getPrintableObject(S)}`);const v=S.error;return this.telemetryHelper.recordEvent(Li.SEARCH_PARTICIPANTS_FAILURE,{causeId:m,transactionEnd:v}),Promise.reject(v)}))}parseSearchParticipantsResult(g,m){const S=[];if(g?.response){const m=g.response.participants;if(m)for(const v of Object.keys(m))S.push(ki.fromRosterSearchResults(g.response.participants[v]))}return{participants:S}}getAllParticipantsAsync(g,m){this.logger.info(`[${m}][getAllParticipantsAsync][scope=${g}]`),this.telemetryHelper.recordEvent(Li.GET_ALL_PARTICIPANTS,{causeId:m,scope:g});const S=this.links[Di.LINKS.GET_ALL_PARTICIPANTS];if(!S){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_LINK_MISSING,phrase:"get all participants link is missing"};return this.logger.warn(g),Promise.reject(g)}if("lobby"!==g){const g={code:Di.CALL_END_CODE.REJECT,subCode:Di.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SCOPE,phrase:"get all participants scope is invalid"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPostRequest({url:S,requestName:Fi.GET_ALL_PARTICIPANTS.name,payload:getPayload34(this,g),causeId:m,requestId:m}).then((g=>{if(g?.response){return{participants:g.response.participants}}{const g="Invalid CS response which does not contain results.";throw this.logger.warn(g),{response:{code:Di.CALL_END_CODE.DECODING_FAILED,subCode:Di.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:g}}}})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][getAllParticipantsAsync] error: ${getPrintableObject(S)}`);const v=S.error;return this.telemetryHelper.recordEvent(Li.GET_ALL_PARTICIPANTS_FAILURE,{causeId:m,transactionEnd:v}),Promise.reject(v)}))}resetState(){this.currentCallStatus=null,this.fsmState=Di.SIGNALING_FSM_STATE.IDLE}saveUpdatedCallLinksIfAny(g){g.links&&(this.logger.info(`saveUpdatedCallLinksIfAny, updated call links found, update to new links ${getPrintableObject(g)}`),this.links[Di.LINKS.MEDIA_RENEGOTIATION]=g.links.mediaRenegotiation||this.links[Di.LINKS.MEDIA_RENEGOTIATION],this.links[Di.LINKS.TRANSFER]=g.links.transfer||this.links[Di.LINKS.TRANSFER],this.links[Di.LINKS.REPLACE]=g.links.replacement||this.links[Di.LINKS.REPLACE],this.links[Di.LINKS.HANGUP]=g.links.callLeg||this.links[Di.LINKS.HANGUP],this.links[Di.LINKS.KEEPALIVE]=g.links.callLeg||this.links[Di.LINKS.KEEPALIVE],this.links[Di.LINKS.PARK]=g.links.hold||this.links[Di.LINKS.PARK],this.links[Di.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=g.links.updateMediaDescriptions||this.links[Di.LINKS.UPDATE_MEDIA_DESCRIPTIONS])}ensureMessageChannelReady(g){return this.disposed?(this.logger.info("ensureMessageChannelReady: error: call already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):this.brokerService?(this.telemetryHelper.addTrouterWaitOperation(`${xi.TROUTER_WAIT_OPERATION.STARTED}:${g}`),this.telemetryHelper.addTrouterWaitOperation(`${xi.TROUTER_WAIT_OPERATION.ENDED}:${g}`),Promise.resolve()):this.ensureLatestTrouterUrl(g)}ensureLatestTrouterUrl(g){return this.telemetryHelper.addTrouterWaitOperation(`${xi.TROUTER_WAIT_OPERATION.STARTED}:${g}`),this.getTrouterUrlAsync().then((m=>!m||"string"==typeof m&&!m.trim()?(this.telemetryHelper.recordEvent(Li.TROUTER_URL_CHANGED_TO_INVALID),this.telemetryHelper.addTrouterWaitOperation(`${xi.TROUTER_WAIT_OPERATION.ENDED}:${g}`),Promise.reject(new Error("Invalid trouter url"))):this.disposed?(this.logger.info("ensureLatestTrouterUrl, trouterUrlGetter returned too late. Object is already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):(this.telemetryHelper.addTrouterWaitOperation(`${xi.TROUTER_WAIT_OPERATION.ENDED}:${g}`),this.baseMessagingChannelUrl=this.currentTrouterUrl=m,Promise.resolve()))).catch((m=>(this.disposed||this.telemetryHelper.addTrouterWaitOperation(`${xi.TROUTER_WAIT_OPERATION.FAILED}:${g}`),this.logger.info(`ensureLatestTrouterUrl, failed because:${m}`),Promise.reject(m))))}signalTransferAcceptedAsync(g,m=causeId2()){return this.logger.info(`[signalTransferAcceptedAsync][${m}] transferType ${g}`),this.disposed?(this.logger.info(`[signalTransferAcceptedAsync][${m}] Call already ended, skip acceptance request`),Promise.reject({code:Di.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(this.telemetryHelper.recordEvent(Li.SEND_ACCEPT_TRANSFER,{causeId:m,transferType:g}),this.http.sendPostRequest({url:this.links[Di.LINKS.TRANSFER_ACCEPTANCE],requestName:Fi.TRANSFER_ACCEPTANCE.name,payload:getPayload46(),causeId:m}).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[signalTransferAcceptedAsync][${m}] error: ${getPrintableObject(S)}`),this.telemetryHelper.recordEvent(Li.SEND_ACCEPT_TRANSFER_FAIL,{causeId:m}),Promise.reject(S.error)})))}signalTransferCompletedAsync(g,m=causeId2()){return this.logger.info(`[signalTransferCompletedAsync][${m}] rejectReason ${g}`),this.disposed?(this.logger.info(`[signalTransferCompletedAsync][${m}]  Call already ended by transferor, skip completion request`),Promise.reject({code:Di.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(0!==g.code?this.telemetryHelper.recordEvent(Li.TRANSFER_COMPLETION_FAILED,{code:g.code,subcode:g.subCode,causeId:m}):this.telemetryHelper.recordEvent(Li.TRANSFER_COMPLETED,{causeId:m}),this.telemetryHelper.recordEvent(Li.SEND_COMPLETE_TRANSFER,{causeId:m}),this.http.sendPostRequest({url:this.links[Di.LINKS.TRANSFER_COMPLETION],requestName:Fi.TRANSFER_COMPLETION.name,payload:getPayload48(g),causeId:m}).catch((g=>{this.telemetryHelper.recordEvent(Li.SEND_COMPLETE_TRANSFER_FAILED,{causeId:m});const S=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[signalTransferCompletedAsync][${m}] error: ${getPrintableObject(S)}`),Promise.reject(S.error)})))}endWithBeacon(g){if(navigator&&navigator.sendBeacon&&!this.disposed){const m={code:Di.CALL_END_CODE.SUCCESS,subCode:Di.CALL_END_SUB_CODE.BEACON,phrase:Di.CALL_END_PHRASE.LOCAL_USER_INITIATED};this.telemetryHelper.recordEvent(Li.END_WITH_BEACON,{causeId:g});const S=JSON.stringify(getPayload36(this,m).payload),v=-1===this.links[Di.LINKS.LEAVE].indexOf("?")?"?":"&",C=`skypeToken=${this.signalingAgent.authTokenManager.getLastToken(g)}`;return navigator.sendBeacon(`${this.links[Di.LINKS.LEAVE]}${v}${C}`,S)}return!1}setFsmState(g){this.fsmState=g}setIsHostless(g,m){const S=!!g;this.isHostLessCall!==S&&(this.logger.info(`[${m}][setIsHostless] isHostless=${S}`),this.isHostLessCall=S)}hasGroupModality(){return this.threadId||this.groupId}processConversationServiceResponseHeaders(g,m){this.logger.info(`[${m}][processConversationServiceResponseHeaders]`);try{const S=g.request.getResponseHeader(Di.HEADERS.CORRELATION_ID)||g.request.getResponseHeader(Di.HEADERS.CORRELATION_ID.toLowerCase());this.updateCorrelationId(S,m)}catch(g){this.logger.info(`[${m}][processConversationServiceResponseHeaders] failed, reason=${getPrintableObject(g)}`)}}processConversationServiceResponse(g,m,S){const v=this.logger.createChild(`[${m}][processConversationServiceResponse]`);if(v.info(`responseType :${S}`),this.processConversationServiceUpdate(g,m),g.subscriptionDetails?.selfParticipant){const S=ki.fromRoster(g.subscriptionDetails.selfParticipant,!0);v.info("converted selfParticipant to Participant type"),this.participantManager.updateLocalParticipantFromSubscribe(S,m)}this.handleBrokerSubscription(g,m),g.roster&&this.internalHandleRosterUpdate(g.roster,!0,m),0===S&&(this.startOrJoinConvResponseReceived=!0,this.handlePendingEndpointState(m))}processConversationServiceUpdate(g,m){const S=this.logger.createChild(`[${m}][processConversationServiceUpdate]`);S.info(),this.convJoined=!0;const v=g.sequenceNumber>=0?g.sequenceNumber:-1;v<this.updateSequenceNumber?S.info(`seqNum=${v} is less than latest seqNum=${this.updateSequenceNumber}`):(this.updateSequenceNumber=v,this.links[Di.LINKS.CONVERSATION_CONTROLLER]=g.conversationController,this.links[Di.LINKS.ADD_PARTICIPANT]=g.links.addParticipant,this.links[Di.LINKS.ADD_PARTICIPANTS_AND_MODALITY]=g.links.addParticipantAndModality,this.links[Di.LINKS.LEAVE]=g.links.leave,this.links[Di.LINKS.NOTIFICATION_LINKS]=g.links.notificationLinks,this.links[Di.LINKS.REMOVE_PARTICIPANT]=g.links.removeParticipant,this.links[Di.LINKS.ADD_MODALITY]=g.links.addModality,this.links[Di.LINKS.REMOVE_MODALITY]=g.links.removeModality,this.links[Di.LINKS.MUTE]=g.links.mute||null,this.links[Di.LINKS.UNMUTE]=g.links.unmute||null,this.links[Di.LINKS.ADMIT]=g.links.admit||null,this.links[Di.LINKS.ADMIT_ALL]=g.links.admitAll||null,this.links[Di.LINKS.UPDATE_ENDPOINT_STATE]=g.links.updateEndpointState||null,this.links[Di.LINKS.UPDATE_ENDPOINT_METADATA]=g.links.updateEndpointMetadata||null,this.links[Di.LINKS.UPDATE_PARTICIPANT_ROLE]=g.links.updateParticipantRole||null,this.links[Di.LINKS.PUBLISH_STATE]=g.links.publishState||null,this.links[Di.LINKS.REMOVE_STATE]=g.links.removeState||null,this.links[Di.LINKS.UPDATE_MEETING_SETTINGS]=g.links.updateMeetingSettings||null,this.links[Di.LINKS.SEARCH_PARTICIPANTS]=g.links.searchParticipants||null,this.links[Di.LINKS.GET_ALL_PARTICIPANTS]=g.links.getAllParticipants||null,this.links[Di.LINKS.UPDATE_MEETING_LIVE_STATE]=g.links.updateMeetingLiveState||null,this.links[Di.LINKS.UPDATE_MEETING_GROUPS]=g.links.updateMeetingGroups||null,this.links[Di.LINKS.SET_MEETING_LAYOUT]=g.links.setMeetingLayout||null,this.links[Di.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE]=g.links.updateParticipantInterpretationState||null,this.links[Di.LINKS.UPDATE_PARTICIPANTS_PROPERTIES]=g.links.updateParticipantProperties||null,this.links[Di.LINKS.JOIN_MEETING_GROUP]=g.links.joinMeetingGroup||null,this.links[Di.LINKS.LEAVE_MEETING_GROUP]=g.links.leaveMeetingGroup||null,this.links[Di.LINKS.SEND_MESSAGE]=g.links.sendMessage||null,this.links[Di.LINKS.UPDATE_MEETING_STATES]=g.links.updateMeetingStates||null,this.convSubject=g.subject,g.state&&(this.setMultiParty(g.state.isMultiParty,m),this.setIsHostless(g.state.isHostless||!1,m),this.conversationType=g.state.conversationType,this.isCastCall="cast"===g.state.conversationType,this.isHuddleGroupCall="huddleGroupCall"===g.state.conversationType),g.activeModalities&&g.activeModalities.groupChat&&this.updateGroupChatIds(g.activeModalities.groupChat,m),g.activeModalities&&g.activeModalities.broadcast&&(this.broadcastSession||(this.broadcastSession=new qi(this,this.signalingSessionCallback)),this.broadcastSession.handleBroadcastDetailsChanged(g,m)),this.handleMeetingDetailsChanged(g,m),this.handleMeetingStatesChanged(g,m),this.linkUpdateRequested.conversationLinks?(S.info("Updating CS links as requested"),this.updateLinks(this.updateConversationLinks,m)):this.scheduleConversationKeepAlive(),g.meetingData&&(this.meetingData=g.meetingData),g.meetingInfo&&(this.meetingInfo=g.meetingInfo),g.region&&(this.region=g.region),g.callLimits&&(this.callLimits=g.callLimits),g.complianceRecordingContent&&(this.complianceRecordingContent=g.complianceRecordingContent),this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,complianceRecordingContent:this.complianceRecordingContent,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},m))}processLocalParticipantUpdateResponse(g,m){this.logger.info(`[${m}][processLocalParticipantUpdateResponse]`),g.sequenceNumber&&g.sequenceNumber<this.localParticipantUpdateSequenceNumber||(this.breakoutDetails=g.breakoutDetails||{},this.signalingSessionCallback.onBreakoutDetailsUpdated(this.breakoutDetails,m),!0===g.nudgeToJoinAsRealtime&&(this.telemetryHelper.recordEvent(Li.NUDGE_TO_JOIN_REALTIME,{causeId:m}),this.signalingSessionCallback.onNudgeToJoinRealtime(m)))}handlePendingEndpointState(g){this.requestedEndpointStateWhileConnecting&&(this.logger.info(`[${g}][handlePendingEndpointState]sending pending endpoint state now that we are connected.`),this.updateEndpointState(this.requestedEndpointStateWhileConnecting,g,this.requestedPublishedStatesWhileConnecting).catch((g=>{this.isPreheatOnly&&this.disablePreheatDefer.isPending()&&(this.logger.info("handlePendingEndpointState failed"),this.disablePreheatDefer.reject(g))})))}handleMeetingDetailsChanged(g,m){this.logger.info(`[${m}][handleMeetingDetailsChanged]`),g.meetingDetails&&!ji.isEqual(g.meetingDetails,this.meetingDetails)&&this.signalingSessionCallback.onMeetingDetailsUpdated&&(this.meetingDetails=g.meetingDetails,this.meetingDetails.meetingCapability?.meetingLiveState&&(this.meetingLiveStateSequenceNumber=this.meetingDetails.meetingCapability.meetingLiveState.seqNum,this.logger.info(`[${m}][handleMeetingDetailsChanged] update meeting seqNum as ${this.meetingLiveStateSequenceNumber}`)),this.signalingSessionCallback.onMeetingDetailsUpdated(this.meetingDetails,m))}handleMeetingStatesChanged(g,m){this.logger.info(`[${m}][handleMeetingStatesChanged]`),this.signalingSessionCallback.onMeetingStatesUpdated&&this.signalingSessionCallback.onMeetingStatesUpdated(g.meetingStates,m)}handleBrokerSubscription(g,m){this.logger.info(`[${m}][handleBrokerSubscription]`),g.links.subscribe?(this.telemetryHelper.recordEvent(Li.SUBSCRIBE_URL_FOUND,m),this.brokerService&&!ji.isEqual(g.links.subscribe,this.brokerService.currentSubscriptionUrl)?this.brokerService.subscribeToBroker(g.links.subscribe):(this.logger.info(`[${m}][handleBrokerSubscription] broker subscribe ignored. Broker is disabled or subscribe url is same.`),this.telemetryHelper.recordEvent(Li.BROKER_DISABLED_SUBSCRIBE_URL_PRESENT,m))):this.telemetryHelper.recordEvent(Li.SUBSCRIBE_URL_MISSING,m)}cancelOutgoingCall(g,m){const S=defer2();this.logger.info(`[${m}][cancelOutgoingCall][rejectionData=${g&&getPrintableObject(g)}]`);const v={code:isNaN(g?.code)?Di.CALL_END_CODE.CANCEL:g.code,subCode:g?.subCode||Di.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Di.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:g?.resultCategories,clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};if(v.resultCategories=v.resultCategories||[Ii.Success],this.links.hasOwnProperty(Di.LINKS.LEAVE)){this.logger.info(`[${m}][cancelOutgoingCall] cancelling outgoing call`),this.fsmState=Di.SIGNALING_FSM_STATE.IDLE;const g={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()},C={terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultDetail:v.phrase||"CancelOutgoingCall",endCode:v.code,endSubCode:v.subCode,causeId:m,clientReasonSubCode:v.clientReasonSubCode,clientReasonPhrase:v.clientReasonPhrase,resultCategories:v.resultCategories};this.http.sendPostRequest({url:this.links[Di.LINKS.LEAVE],requestName:Fi.CANCEL_CALL.name,payload:getPayload31(this,v,g),causeId:m}).then((g=>{this.disposed||(this.telemetryHelper.setTerminatingData(C),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,v),this.dispose(v,m)),S.resolve(null)})).catch((g=>{const _=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[cancelOutgoingCall][${m}] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(_)}`),this.disposed||(this.telemetryHelper.setTerminatingData(C),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,v),this.dispose(v,m)),S.resolve(null)}))}else this.logger.info(`[${m}][cancelOutgoingCall] Conversation Service Leave Url is not yet set. Cannot leave conversation. Disposing anyways.`),v.subCode=Di.CALL_END_SUB_CODE.CONV_URL_NOT_SET,this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultDetail:v.phrase||"CancelOutgoingCall",endCode:v.code,endSubCode:v.subCode,causeId:m,clientReasonSubCode:v.clientReasonSubCode,clientReasonPhrase:v.clientReasonPhrase,resultCategories:v.resultCategories}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,v),this.dispose(v,m),S.resolve(null);return S.promise}terminateEstablishedCall(g,m){const S=m.causeId||causeId2();this.logger.info(`[${S}][terminateEstablishedCall]`);const v=defer2();this.fsmState=Di.SIGNALING_FSM_STATE.IDLE;const C=this.convJoined?Fi.LEAVE_CONVERSATION.name:Fi.END_CALL.name,_=build3(),E={code:g?.code||Di.CALL_END_CODE.SUCCESS,subCode:g?.subCode||Di.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Di.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:g?.resultCategories,clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};E.resultCategories=E.resultCategories||[Ii.Success];const T={terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,endCode:E.code,endSubCode:E.subCode,resultDetail:E.phrase||"TerminateEstablishedCall",causeId:S,clientReasonSubCode:E.clientReasonSubCode,clientReasonPhrase:E.clientReasonPhrase,resultCategories:E.resultCategories};return this.leaveConversation(E,m).then((()=>{this.logger.info(`[${S}][terminateEstablishedCall]success`),this.disposed||(this.telemetryHelper.setTerminatingData(T),this.telemetryHelper.addNetworkOperationCompleted(C,!0,_.duration()),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,S,E),this.dispose(E,S)),v.resolve(null)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${S}][terminateEstablishedCall][failed] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(m)}]`),this.disposed||(this.telemetryHelper.setTerminatingData(T),this.telemetryHelper.addNetworkOperationCompleted(C,!1,_.duration()),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,S,E),this.dispose(E,S)),v.resolve(null)})),v.promise}deleteConversation(g,m){this.logger.info(`[${m}][deleteConversation]`);const S=defer2();this.fsmState=Di.SIGNALING_FSM_STATE.IDLE;const v=Fi.DELETE_CONVERSATION.name,C=build3(),_={code:g?.code||Di.CALL_END_CODE.SUCCESS,subCode:g?.subCode||Di.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Di.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED,resultCategories:g?.resultCategories||[Ii.Success],clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase},E={terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,endCode:_.code,endSubCode:_.subCode,resultDetail:_.phrase,causeId:m,clientReasonSubCode:_.clientReasonSubCode,clientReasonPhrase:_.clientReasonPhrase,resultCategories:_.resultCategories};return this.deleteConversationController(_,m).then((()=>{this.logger.info(`[${m}][deleteConversation]success`),this.disposed||(this.telemetryHelper.setTerminatingData(E),this.telemetryHelper.addNetworkOperationCompleted(v,!0,C.duration()),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,_),this.dispose(_,m)),S.resolve(null)})).catch((g=>{const T=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][deleteConversation][failed] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(T)}`),this.disposed||(this.telemetryHelper.setTerminatingData(E),this.telemetryHelper.addNetworkOperationCompleted(v,!1,C.duration()),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,_),this.dispose(_,m)),S.resolve(null)})),S.promise}leaveConversation(g,m){const S=m.causeId||causeId2();if(this.convJoined){this.logger.info(`[${S}][leaveConversation]`);const v={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()};return this.http.sendPostRequest({url:this.links[Di.LINKS.LEAVE],requestName:Fi.LEAVE_CONVERSATION.name,payload:getPayload36(this,g,v,m.scope),withoutTrouter:!0,causeId:S})}return this.logger.info(`[${S}][leaveConversation] ignore, not joined to conversation`),Promise.resolve(void 0)}deleteConversationController(g,m){return this.convJoined?(this.logger.info(`[${m}][deleteConversationController]`),this.http.sendDeleteRequest({url:this.links[Di.LINKS.CONVERSATION_CONTROLLER],requestName:Fi.DELETE_CONVERSATION.name,payload:getPayload33(this,g),withoutTrouter:!0,causeId:m})):(this.logger.info(`[${m}][deleteConversationController]ignored, not joined to conversation`),Promise.resolve(void 0))}rejectIncomingCall(g,m){this.telemetryHelper.recordEvent(Li.REJECT_INCOMING_CALL,m),this.logger.info(`[${m}][rejectIncomingCall]`);const S=defer2();this.fsmState=Di.SIGNALING_FSM_STATE.IDLE;const v={code:isNaN(g?.code)?Di.CALL_END_CODE.REJECT:g.code,subCode:g?.subCode||Di.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Di.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:g?.resultCategories,clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};v.resultCategories=v.resultCategories||[Ii.Success];const C={terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,endCode:v.code,endSubCode:v.subCode,resultDetail:v.phrase||"RejectCall",causeId:m,clientReasonSubCode:v.clientReasonSubCode,clientReasonPhrase:v.clientReasonPhrase,resultCategories:v.resultCategories};return this.http.sendDeleteRequest({url:this.links[Di.LINKS.REJECT],requestName:Fi.REJECT_CALL.name,payload:getPayload42(this,v),causeId:m}).then((g=>{this.disposed||(this.telemetryHelper.setTerminatingData(C),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,v),this.dispose(v,m)),S.resolve(null)})).catch((g=>{const _=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[rejectIncomingCall][${m}] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(_)}`),this.disposed||(this.telemetryHelper.setTerminatingData(C),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,m,v),this.dispose(v,m)),S.resolve(null)})),S.promise}onCallStatusChanged(g,m,S){const v=`[${m}][onCallStatusChanged]`;if(this.logger.info(`${v}${this.currentCallStatus}=>${g}]`),this.disposed)this.logger.info(`${v}Call is already disposed!!`);else if(S&&this.logger.info(`${v}[statusCode=${getPrintableObject(S)}]`),this.isPromotingToRealtime)g===Di.CALL_STATUS.CONNECTED&&this.onPromotionCompleted(!1,void 0,m);else if(this.isValidStateTransitions(g)){this.currentCallStatus=g;const v={callStatus:g,statusCode:S,causeId:m};this.isPreheatOnly&&(v.isPreheatOnly=!0),this.telemetryHelper.recordEvent(Li.UPDATE_CALL_STATUS,v),this.signalingSessionCallback.onCallStatusChanged(g,S,m),this.currentCallStatus===Di.CALL_STATUS.CONNECTED&&(this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.telemetryHelper.resetCallCancelationDurationWatch(),this.isPreheatOnly&&this.startCallPreheatTimer(m))}}updateMeetingLiveStateAsync(g,m){this.logger.info(`[${g}][updateMeetingLiveStateAsync][options=${JSON.stringify(m)}]`),this.telemetryHelper.recordEvent(Li.UPDATE_MEETING_LIVE_STATE,{causeId:g,meetingLiveStateOptions:m}),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,(()=>{this.handleUpdateMeetingLiveStateError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT,phrase:Di.CALL_END_PHRASE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT},Li.WAITING_FOR_UPDATE_MEETING_LIVE_STATE_COMPLETION,g,g,m)}),Di.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT);const S=getPayload52(this,{...m,seqNum:this.meetingLiveStateSequenceNumber},g);return this.http.sendPostRequest({url:this.links[Di.LINKS.UPDATE_MEETING_LIVE_STATE],requestName:Fi.UPDATE_MEETING_LIVE_STATE.name,payload:S,causeId:g}).then((m=>{this.logger.info(`[${g}][updateMeetingLiveStateAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_UPDATE_MEETING_LIVE_STATE_COMPLETION,{causeId:g})})).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingAgentConfig);return this.logger.info(`[${g}][updateMeetingLiveStateAsync] error: ${getPrintableObject(v)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingLiveStateError(v.error,Li.UPDATE_MEETING_LIVE_STATE_REQUEST_FAILED,g,g,m),Promise.reject(v.error))}))}updateMeetingStatesAsync(g,m){const S=this.logger.createChild(`[${g}][updateMeetingStatesAsync]`,this.correlationId);if(S.info(`meetingStatesOptions: ${JSON.stringify(m)}`),!m)return Promise.reject({code:Di.VALIDATION.VALIDATION_FAILED,subCode:Di.VALIDATION.NULL_OR_EMPTY,phrase:"meetingStatesOptions should be a non empty object"});this.telemetryHelper.recordEvent(Li.UPDATE_MEETING_STATES,{causeId:g,meetingStatesOptions:m}),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,(()=>{for(const S in m.meetingStates)this.handleUpdateMeetingStatesError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT,phrase:Di.CALL_END_PHRASE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT},Li.WAITING_FOR_UPDATE_MEETING_STATES_COMPLETION,g,m.operationId+"_"+S)}),Di.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT);const v=getPayload57(this,{...m.meetingStates},g);return this.http.sendPostRequest({url:this.links[Di.LINKS.UPDATE_MEETING_STATES],requestName:Fi.UPDATE_MEETING_STATES.name,payload:v,causeId:g}).then((m=>{S.info(`response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_UPDATE_MEETING_STATES_COMPLETION,{causeId:g})})).catch((v=>{const C=getErrorForXHRFailure(v,this.signalingAgentConfig);if(S.error(`error: ${getPrintableObject(C)}`),!this.disposed){for(const S in m.meetingStates)this.handleUpdateMeetingStatesError(C.error,Li.UPDATE_MEETING_STATES_RESPONSE_FAILURE,g,m.operationId+"_"+S);return Promise.reject(C.error)}return Promise.reject(this.getCallNotFoundTransactionEnd())}))}handleUpdateMeetingLiveStateError(g,m,S,v,C){this.disposed?this.logger.info(`[${S}][handleUpdateMeetingLiveStateError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${S}][handleUpdateMeetingLiveStateError] reject reason: ${g}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,updateMeetingGroupsOptions:C,causeId:S}),this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted&&this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted(g,S,v))}handleUpdateMeetingLiveStateCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g),v=m.updateMeetingLiveStateResponse.result,C=m.updateMeetingLiveStateResponse.operationId;C||this.logger.warn(`[${S}][handleUpdateMeetingLiveStateCompletion] operationId is undefined.`),this.logger.info(`[${S}][handleUpdateMeetingLiveStateCompletion] meetingLiveUpdate completes with operationId=${C}`),this.handleOperationCompletionCommon(v,S,C,getPrintableObject(m),"handleUpdateMeetingLiveStateCompletion",Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,Li.UPDATE_MEETING_LIVE_STATE_RESPONSE_SUCCESS,Li.UPDATE_MEETING_LIVE_STATE_RESPONSE_FAILURE,this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted,this.handleUpdateMeetingLiveStateError.bind(this))}handleUpdateMeetingStatesError(g,m,S,v){this.disposed?this.logger.info(`[${S}][handleUpdateMeetingStatesError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${S}][handleUpdateMeetingStatesError] reject reason: ${g}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,causeId:S}),this.signalingSessionCallback.onUpdateMeetingStatesCompleted&&this.signalingSessionCallback.onUpdateMeetingStatesCompleted(g,S,v))}handleUpdateMeetingStatesCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g),v=m.updateMeetingStatesResponse,C=m.operationId,_=this.logger.createChild(`[${S}][handleUpdateMeetingStatesCompletion]`,this.correlationId);C||_.warn("operationId is undefined.");for(const g of v)_.info(`UpdateMeetingStates completes with operationId=${C}.`),this.handleOperationCompletionCommon(g.transactionEnd,S,C+"_"+g.meetingStateName,getPrintableObject(m),"handleUpdateMeetingStatesCompletion",Di.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,Li.UPDATE_MEETING_STATES_RESPONSE_SUCCESS,Li.UPDATE_MEETING_STATES_RESPONSE_FAILURE,this.signalingSessionCallback.onUpdateMeetingStatesCompleted,this.handleUpdateMeetingStatesError.bind(this))}setMeetingLayoutAsync(g,m){this.logger.info(`[${g}][setMeetingLayoutAsync][options=${JSON.stringify(m)}]`),this.telemetryHelper.recordEvent(Li.SET_MEETING_LAYOUT,{causeId:g,setMeetingLayoutOptions:m}),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,(()=>{this.handleSetMeetingLayoutError({code:Di.CALL_END_CODE.TIMEOUT,subCode:Di.CALL_END_SUB_CODE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT,phrase:Di.CALL_END_PHRASE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT},Li.WAITING_FOR_SET_MEETING_LAYOUT_COMPLETION,g,g,m)}),Di.TIMEOUT_VALUES_IN_SECONDS.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT);const S=getPayload45(this,{...m,sequenceNumber:this.meetingLayoutSequenceNumber});return this.http.sendPostRequest({url:this.links[Di.LINKS.SET_MEETING_LAYOUT],requestName:Fi.SET_MEETING_LAYOUT.name,payload:S,causeId:g}).then((m=>{this.logger.info(`[${g}][setMeetingLayoutAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Li.WAITING_FOR_SET_MEETING_LAYOUT_COMPLETION,{causeId:g})})).catch((S=>{const v=getErrorForXHRFailure(S);return this.logger.info(`[${g}][setMeetingLayoutAsync] error: ${getPrintableObject(v)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleSetMeetingLayoutError(v.error,Li.SET_MEETING_LAYOUT_REQUEST_FAILED,g,g,m),Promise.reject(v.error))}))}handleSetMeetingLayoutError(g,m,S,v,C){this.disposed?this.logger.info(`[${S}][handleSetMeetingLayoutError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${S}][handleSetMeetingLayoutError] reject reason: ${g}`),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,updateMeetingGroupsOptions:C,causeId:S}),this.signalingSessionCallback.onSetMeetingLayoutCompleted&&this.signalingSessionCallback.onSetMeetingLayoutCompleted(g,S,v))}handleSetMeetingLayoutCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g),v=m.setMeetingLayoutResponse.result,C=m.setMeetingLayoutResponse.operationId;C||this.logger.warn(`[${S}][handleSetMeetingLayoutCompletion] operationId is undefined.`),this.handleOperationCompletionCommon(v,S,C,getPrintableObject(m),"handleSetMeetingLayoutCompletion",Di.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,Li.SET_MEETING_LAYOUT_RESPONSE_SUCCESS,Li.SET_MEETING_LAYOUT_RESPONSE_FAILURE,this.signalingSessionCallback.onSetMeetingLayoutCompleted,this.handleSetMeetingLayoutError.bind(this))}handleOperationCompletionCommon(g,m,S,v,C,_,E,T,I,b){this.disposed?this.logger.info(`[${m}][${C}] ignored. Call disposed.`):(this.logger.info(`[${m}][${C}] body ${v}`),g.code===Di.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(_),this.telemetryHelper.recordEvent(E,{...g,causeId:m}),I&&I(g,m,S)):b&&b(g,T,m,S))}isValidStateTransitions(g){if(this.currentCallStatus===Di.CALL_STATUS.LOCAL_TERMINATED&&g===Di.CALL_STATUS.CONNECTING)return!0;const orderOfCallState=g=>{switch(g){case Di.CALL_STATUS.IDLE:case Di.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY:return 0;case Di.CALL_STATUS.CONNECTING:return 1;case Di.CALL_STATUS.RINGING:return 2;case Di.CALL_STATUS.CONNECTED:return 3;case Di.CALL_STATUS.LOCAL_TERMINATED:case Di.CALL_STATUS.REMOTE_TERMINATED:return 4;default:return-1}};return orderOfCallState(g)>orderOfCallState(this.currentCallStatus)}handlePSTNBalanceUpdate(g){const m=g.body.balanceUpdate,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handlePSTNBalanceUpdate]`),this.telemetryHelper.recordIncomingEvent(Li.HANDLE_PSTN_BALANCE_UPDATE,g),m.updateBalance?this.signalingSessionCallback.onPSTNBalanceUpdate(m):this.logger.info(Li.HANDLE_PSTN_BALANCE_UPDATE,"this was a pstn keepAlive message - ignore")}handleCallAcceptanceAck(g){const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleCallAcceptanceAck]`),this.telemetryHelper.recordIncomingEvent(Li.HANDLE_CALL_ACCEPTANCE_ACK,g),this.internalHandleCallAcceptanceAck(m,S)}internalHandleCallAcceptanceAck(g,m){this.logger.info(`[${m}][internalHandleCallAcceptanceAck] ${getPrintableObject(g)}`),this.fsmState!==Di.SIGNALING_FSM_STATE.CONNECTED&&(this.links[Di.LINKS.MEDIA_RENEGOTIATION]=g.callAcceptanceAcknowledgement.links.mediaRenegotiation,this.links[Di.LINKS.TRANSFER]=g.callAcceptanceAcknowledgement.links.transfer,this.links[Di.LINKS.REPLACE]=g.callAcceptanceAcknowledgement.links.replacement,this.links[Di.LINKS.HANGUP]=g.callAcceptanceAcknowledgement.links.callLeg,this.links[Di.LINKS.KEEPALIVE]=g.callAcceptanceAcknowledgement.links.callLeg,this.links[Di.LINKS.PARK]=g.callAcceptanceAcknowledgement.links.hold,this.links[Di.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=g.callAcceptanceAcknowledgement.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(g.callAcceptanceAcknowledgement),this.scheduleKeepAlives(g.callAcceptanceAcknowledgement.callKeepAliveInterval),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(g.callAcceptanceAcknowledgement.callProperties?.isSharedLineAppearanceV2Activated),this.fsmState=Di.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.INCOMING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(m),this.onCallStatusChanged(Di.CALL_STATUS.CONNECTED,m),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${m}][internalHandleCallAcceptanceAck] updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,m)))}isFatalException(g){let m=!0;try{JSON.parse(g.message).code===Di.CALL_END_CODE.CONFLICT&&(m=!1,this.logger.info("isFatalException: received non-fatal 409 error"))}catch(g){this.logger.error("isFatalException: failed to parse error")}return m}startOrJoinCall(g,m,S,v,C){if(this.logger.info(`[${S}]startOrJoinCall[${m}]`),this.disposed)return void this.logger.info(`[${S}][${m}] session already disposed, ignore`);this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,S);const _=this.getConversationUrl()?this.getConversationUrl():g.conversationServiceUrl;this.telemetryHelper.setConversationServiceUrl(_),this.logger.info(`options.conversationServiceUrl ${g.conversationServiceUrl} conversationServiceUrl ${_}`),g.isPreheatOnly?(this.isPreheatOnly=!0,this.telemetryHelper.recordEvent(Li.PREHEAT_ENABLING,{causeId:S}),this.telemetryHelper.setSelfParticipantRole(xi.ROLE.PREHEAT),this.telemetryHelper.setIsPreheated()):this.telemetryHelper.startCallCancelationDurationWatch(),this.mediaTypesToUse=C,this.lastUsedOutgoingMediaContent=v,this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id);const E=!this.multiParty&&this.signalingAgentConfig.enableLongOutgoing1To1SetupTimeoutForWeb,T=E?Di.TIMEOUT_VALUES_IN_SECONDS.LONGER_OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:Di.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT;this.logger.info(`[${S}][${m}]target endpointType = ${this.transferContext&&this.transferContext.target?this.transferContext.target.endpointType:"default"} timeout = ${T} LongerTimeout = ${E}`);const I=g.newCall?getPayload32(this,v,C,g):getPayload35(this,v,C,g,S);this.signalingAgentConfig.enableCallEstablishmentTimeoutsForStartJoinCall&&this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(S)}),T),this.signalingSessionCallback.onTransferredCallAcceptance(S),g.endpointState&&(this.latestEndpointState=g.endpointState),this.http.sendPostRequest({url:_,requestName:m,operationType:"CallSetup",payload:I,causeId:S}).then((g=>{this.disposed||(this.processConversationServiceResponseHeaders(g,S),this.processConversationServiceResponse(g.response,S,0),this.onCallStatusChanged(Di.CALL_STATUS.CONNECTING,S))})).catch((g=>{if(g.stack&&!this.isFatalException(g))return;const v=getErrorForXHRFailure(g,this.signalingAgentConfig);if(this.logger.info(`[startOrJoinCall][${S}][${m}] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(v)}`),!this.disposed){if(this.isPromotingToRealtime)return void this.onPromotionCompleted(!0,v.error,S);this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultValue:xi.RESULT_VALUE.FAILURE,endCode:v.telemetryEndSubCode,endSubCode:v.error.subCode,resultCategories:v.error.resultCategories,resultDetail:v.error.phrase||this.getTerminatingCallResultDetail(m,v.error),causeId:S}),this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,S,v.error),this.dispose(v.error,S)}}))}processIncomingCallPayload(g,m){this.remoteUser=ki.fromWireParticipant(g.callNotification.from),this.participantManager.setLocalParticipantId(g.callNotification.to.participantId,m),g?(g.conversationInvitation&&(this.links[Di.LINKS.CONVERSATION_CONTROLLER]=g.conversationInvitation.conversationController,this.setMultiParty(g.conversationInvitation.isMultiParty,m),this.setIsHostless(!!g.conversationInvitation.isHostless,m)),g.callNotification&&(this.links[Di.LINKS.ATTACH]=g.callNotification.links?.attach,this.links[Di.LINKS.REDIRECT]=g.callNotification.links?.redirection,this.onBehalfOf=g.callNotification.onBehalfOf?.id,this.onBehalfOfUserDisplayName=g.callNotification.onBehalfOf?.displayName,this.callPhoneLineType=g.callNotification.callPhoneLineType,this.callType=g.callNotification.callType,this.incomingCallCallerId=g.callNotification.from?.id,this.callUsesMixer=!!g.callNotification.mediaContent?.fromMixer,this.isRedirectAllowed=!!g.callNotification.redirectionProperties?.isRedirectAllowed),g.debugContent&&this.updateCorrelationId(g.debugContent.callId,m),g.callNotification.transferor&&(this.transferor=g.callNotification.transferor.details?g.callNotification.transferor.details.id:null),g.groupChat&&this.updateGroupChatIds(g.groupChat,m),g.meetingData&&(this.meetingData=g.meetingData),g.meetingInfo&&(this.meetingInfo=g.meetingInfo)):this.logger.info(`[${m}][processIncomingCallPayload] empty incoming payload content`)}processAttachResponse(g,m,S){this.telemetryHelper.recordEvent(Li.PROCESS_INITIAL_OFFER,{causeId:S}),this.links[Di.LINKS.MEDIA_ANSWER]=m.response.callInvitation.links.mediaAnswer,this.links[Di.LINKS.ACCEPT]=m.response.callInvitation.links.acceptance,this.links[Di.LINKS.REJECT]=m.response.callInvitation.links.callLeg,this.links[Di.LINKS.REDIRECT]=m.response.callInvitation.links.redirection,this.links[Di.LINKS.NEW_OFFER]=m.response.callInvitation.links.newOffer,this.signalingAgentConfig.sendProgressFromCC||this.sendProgress(m),this.remoteCaller=m.response.participants.from;const v=this.getInitialMediaOfferFromIncomingCallPayload()||m.response.callInvitation.mediaContent;this.telemetryHelper.setCallerType(this.getParticipantIdForOfferAnswer(v));const C=getMediaTypes(m.response.callInvitation.callModalities);this.telemetryHelper.addIncomingModalities(C),this.telemetryHelper.setOfferedModalities(v.blob,!0),this.callUsesMixer=v.fromMixer,this.isRedirectAllowed=!(!m.response.callInvitation.redirectionProperties||!m.response.callInvitation.redirectionProperties.isRedirectAllowed),this.signalingSessionCallback.onOffer({subject:g.conversationInvitation.subject,remoteParticipantId:this.getParticipantIdForOfferAnswer(v),remoteEndpointId:m.response.participants.from.endpointId,transferor:m.response.callInvitation.transferor,clientTransferContext:g.callNotification.transferContext,mediaTypes:C,mediaContent:v,renegotiation:!1,invitationData:m.response.callInvitation.invitationData,riskLevel:m.response.callInvitation.spamProperties&&m.response.callInvitation.spamProperties.riskLevel,stirAttestation:m.response.callInvitation.spamProperties&&m.response.callInvitation.spamProperties.stirAttestation,isRedirectAllowed:this.isRedirectAllowed},S)}sendProgress(g,m=causeId2()){this.logger.info(`[${m}][sendProgress]`),this.telemetryHelper.recordEvent(Li.SEND_PROGRESS,{causeId:m}),this.http.sendPostRequest({url:g.response.callInvitation.links.progress,requestName:Fi.SEND_CALL_PROGRESS.name,payload:getPayload29(this),causeId:m}).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][sendProgress] error: ${getPrintableObject(S)}`),this.disposed||this.telemetryHelper.recordEvent(Li.SEND_PROGRESS_FAILED,{causeId:m,...S.error})}))}handleCallNotification(g){const m=extractCauseIdFromMessage(g);if(this.logger.info(`[${m}][handleCallNotification]`),this.telemetryHelper.recordIncomingEvent(Li.HANDLE_CALL_NOTIFICATION,g),!stringEndsWith(g.url,Mi.REPLACE))throw new Error(`[${m}][handleCallNotification]IncomingCallNotification should not be received in handleIncomingMsg`);this.telemetryHelper.recordIncomingEvent(Li.HANDLE_INCOMING_CALL_REPLACEMENT,g),this.logger.info(`[${m}][handleCallNotification]replacementCallNotification`),this.signalingSessionCallback&&this.signalingSessionCallback.onIncomingCallReplacement(g.body,m)}handleMediaAnswer(g){this.telemetryHelper.recordIncomingEvent(Li.HANDLE_MEDIA_ANSWER,g);const m=g.body,S=extractCauseIdFromMessage(g);if(this.logger.info(`[${S}][handleMediaAnswer]`),this.mediaRenegotiationManager.isOutgoingRenegotiationInProgress())this.mediaRenegotiationManager.handleMediaAnswer(m,S);else if(this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED);else if(this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING){if(isDuplicateMessage(g.headers,this.provisionalMediaAnswersSeenSoFar))return void this.logger.info(`[${S}][handleMediaAnswer] ignoring provisional answer retried by service`);m.mediaAnswer.sender&&(this.remoteUser=m.mediaAnswer.sender),this.resetCallEstablishmentTimeout(S),m.mediaAnswer.noRingBack||(this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Di.CALL_STATUS.RINGING,S));const v=m.mediaAnswer.mediaContent;this.signalingSessionCallback.onAnswer({provisional:!0,renegotiation:!1,remoteEndpointId:m.mediaAnswer.sender?m.mediaAnswer.sender.endpointId:newGuid(),remoteParticipantId:this.getParticipantIdForOfferAnswer(v),mediaContent:v},S)}}async _sendCallAcceptanceAcknowledgement(g,m){this.http.sendPostRequest({url:g.body.callAcceptance.links.acknowledgement,requestName:Fi.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:getPayload27(this),causeId:m}).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][_sendCallAcceptanceAcknowledgement] error: ${getPrintableObject(S)}`),this.disposed||this.telemetryHelper.recordEvent(Li.HANDLE_CALL_ACCEPTANCE_FAILED,{causeId:m,...S.error})}))}handleCallAcceptance(g){const m=extractCauseIdFromMessage(g);this.telemetryHelper.recordIncomingEvent(Li.HANDLE_CALL_ACCEPTANCE,g,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:m}),this.logger.info(`[${m}][handleCallAcceptance]enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?(this._sendCallAcceptanceAcknowledgement(g,m),this._processCallAcceptance(g,m)):(this._processCallAcceptance(g,m),this.http.sendPostRequest({url:g.body.callAcceptance.links.acknowledgement,requestName:Fi.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:getPayload27(this),causeId:m}).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][handleCallAcceptance] error: ${getPrintableObject(S)}`),this.disposed||this.telemetryHelper.recordEvent(Li.HANDLE_CALL_ACCEPTANCE_FAILED,{causeId:m,...S.error})})))}handleCallAcceptanceSync(g){const m=extractCauseIdFromMessage(g);this.telemetryHelper.recordIncomingEvent(Li.HANDLE_CALL_ACCEPTANCE_SYNC,g,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:m}),this.logger.info(`[${m}][handleCallAcceptanceSync] enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?ji.defer(this._processCallAcceptance,g,m):this._processCallAcceptance(g,m);const S=getPayload27(this).payload;return this.telemetryHelper.addNetworkOperationCompleted(Fi.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,!0),S}getFakeRoster(g){const m=this.participantManager.getParticipantsToInitiateCallWith();let S;S=1===m.length?m[0].id:g.callAcceptance.acceptedBy.id;const v={id:S,displayName:g.callAcceptance.acceptedBy.id===S?g.callAcceptance.acceptedBy.displayName:"",languageId:g.callAcceptance.acceptedBy.languageId},C=g.callAcceptance.acceptedBy.endpointId;return{type:"MultiPartyEndpoint",participants:{[S]:{acceptedBy:g.callAcceptance.acceptedBy.id,details:v,endpoints:{[C]:{call:{},contentSharing:{},capabilities:g.callAcceptance.capabilities,participantId:g.callAcceptance.acceptedBy.participantId}}}}}}processCallAcceptance(g,m){this.logger.info(`[${m}][processCallAcceptance] ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Li.PROCESS_CALL_ACCEPTANCE,{causeId:m}),this.fsmState=Di.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(m);let S=!1;g.callAcceptance.controllerName===Di.MISC.LOBBY_CALL_CONTROLLER&&(this.logger.info(`[${m}][processCallAcceptance] Controller name is lobby so putting user in lobby`),this.participantManager.localParticipant.isLobby=!0,this.participantManager.localParticipant.endpointDetails.push({isLobby:!0,endpointId:this.participantManager.localParticipant.endpointId,participantId:this.participantManager.localParticipant.participantId}),S=!0,this.telemetryHelper.recordEvent(Li.ACCEPTANCE_USER_IN_LOBBY,{causeId:m})),this.participantManager.localParticipant.isStaging=hasStagingGroup(g.callAcceptance),this.signalingSessionCallback.onMeetingGroupDetailsUpdated(g.callAcceptance.meetingGroupDetails,m),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(g.callAcceptance.callProperties?.isSharedLineAppearanceV2Activated),this.logger.info(`[${m}][processCallAcceptance] for localParticipant, isStaging is set to ${this.participantManager.localParticipant.isStaging}`);let v=this.mediaTypesToUse,C=newGuid();g.callAcceptance.acceptedBy&&(this.remoteUser=ki.fromWireParticipant(g.callAcceptance.acceptedBy),C=g.callAcceptance.acceptedBy.endpointId),g.callAcceptance.acceptedCallModalities&&g.callAcceptance.acceptedCallModalities.length>0&&(v=g.callAcceptance.acceptedCallModalities);const _=g.callAcceptance.mediaContent;this.callUsesMixer=_.fromMixer;const E=getMediaTypes(v);this.telemetryHelper.addIncomingModalities(E),this.telemetryHelper.setAnsweredModalities(_.blob,!0),this.links[Di.LINKS.MEDIA_RENEGOTIATION]=g.callAcceptance.links.mediaRenegotiation,this.links[Di.LINKS.TRANSFER]=g.callAcceptance.links.transfer,this.links[Di.LINKS.REPLACE]=g.callAcceptance.links.replacement,this.links[Di.LINKS.HANGUP]=g.callAcceptance.links.callLeg,this.links[Di.LINKS.KEEPALIVE]=g.callAcceptance.links.callLeg,this.links[Di.LINKS.PARK]=g.callAcceptance.links.hold,this.links[Di.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=g.callAcceptance.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(g.callAcceptance),this.scheduleKeepAlives(g.callAcceptance.callKeepAliveInterval);const T=this.getParticipantIdForOfferAnswer(_);this.signalingSessionCallback.onAnswer({provisional:!1,renegotiation:!1,remoteEndpointId:C,remoteParticipantId:T,callAcceptedByNGCVoicemail:T===Di.KNOWN_BOTS.VOICEMAIL_BOT_ID,mediaTypes:E,mediaContent:_},m),this.setRealTimeState(2,m),this.onCallStatusChanged(Di.CALL_STATUS.CONNECTED,m),S&&this.signalingSessionCallback.onSelfParticipantUpdated(this.participantManager.localParticipant,m),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${m}][processCallAcceptance] Updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,m))}updateGroupChatIds(g,m){const S=this.groupId,v=this.threadId,C=this.teamsMessageId,_=this.backroomThreadId;this.groupId=g.groupId,this.threadId=g.threadId,this.teamsMessageId=g.messageId,this.backroomThreadId=g.backroomThreadId,this.groupId===S&&this.threadId===v&&this.teamsMessageId===C&&this.backroomThreadId===_||this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},m)}handleCallEnd(g){let m=g.body.callEnd||g.body;const S=extractCauseIdFromMessage(g);if(this.logger.info(`[${S}][handleCallEnd][content=${getPrintableObject(m)}]`),this.telemetryHelper.recordEvent(Li.HANDLE_CALL_END,{origin:g.origin,code:m?m.code:"unknown",subCode:m?m.subCode:"unknown",resultCategories:m?m.resultCategories:[],causeId:S}),this.signalingAgentConfig.enableConversationTypeUpdateOnCallEnd&&(this.conversationType=m?.conversationType||this.conversationType),this.fsmState!==Di.SIGNALING_FSM_STATE.IDLE)if(m.code===Di.CALL_END_CODE.CONFLICT&&this.multiParty&&m.conversationUrl?.Location)this.handleConversationResolutionConflict(m,S);else{this.disposing=!0,m.callControllerTransactionEnd&&(this.logger.info("handleCallEnd: using CC end details specified in CS end"),m=m.callControllerTransactionEnd),m.broadcastOperationFailure&&(this.logger.info("handleCallEnd: using broadcastOperationFailure end details specified in CS end"),m=m.broadcastOperationFailure);const g=m.code===Di.CALL_END_CODE.SUCCESS||m.code===Di.CALL_END_CODE.CANCEL||m.code===Di.CALL_END_CODE.REJECT;this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.REMOTE,resultDetail:m.phrase,resultValue:g?xi.RESULT_VALUE.SUCCESS:xi.RESULT_VALUE.FAILURE,endCode:m.code,endSubCode:m.subCode,resultCategories:m?m.resultCategories:[],causeId:S});const v={code:m.code,subCode:m.subCode,phrase:m.phrase,resultCategories:m.resultCategories,pickupCode:""};this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,m.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:m.acceptedElsewhereBy.id,displayName:m.acceptedElsewhereBy.displayName}),m.unparkContent&&(m.unparkContent.CallParkAdditionalContext&&(this.parkAdditionalContextJson=JSON.stringify(m.unparkContent.CallParkAdditionalContext),this.serverHoldLocation=m.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),m.unparkContent.pickupCode&&(v.pickupCode=m.unparkContent.pickupCode)),this.onCallStatusChanged(Di.CALL_STATUS.REMOTE_TERMINATED,S,v),this.dispose(v,S)}else this.logger.info(`[${S}][handleCallEnd] not handling incoming callEnd since fsmstate = SIGNALING_FSM_STATE.IDLE`)}handleConversationResolutionConflict(g,m){this.logger.info(`[${m}][handleConversationResolutionConflict]`);const S={...g,phrase:g.phrase||"Conflict Resolution Error"};if(this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Di.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY)this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.http.cancelRequestIfPending(Fi.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,m,void 0,S),this.subscribeToCall(g.conversationUrl.Location,g.correlationId,this.lastUsedJoinCallOptions?this.lastUsedJoinCallOptions.clientEndpointCapabilities:0,{meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,additionalEndpointProperties:this.lastUsedJoinCallOptions?.additionalEndpointProperties},m);else{this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const v={meetingData:this.meetingData,meetingPreferences:this.meetingPreferences};if(this.lastUsedJoinCallOptions){const g=this.lastUsedJoinCallOptions.scenario;v.muted=this.lastUsedJoinCallOptions.muted,v.scenario=`409Redirect${g||""}`,v.isPreheatOnly=this.lastUsedJoinCallOptions.isPreheatOnly,v.clientEndpointCapabilities=this.lastUsedJoinCallOptions.clientEndpointCapabilities,v.clientEndpointDebugContent=this.lastUsedJoinCallOptions.clientEndpointDebugContent,v.additionalEndpointProperties=this.lastUsedJoinCallOptions.additionalEndpointProperties}else v.scenario="409RedirectJoin";this.setInitialTelemetry("JoinCall",{correlationId:g.correlationId,causeId:m,conversationServiceUrl:g.conversationUrl.Location,joinCallOptions:v,offerGenerationTime:void 0}),this.http.cancelRequestIfPending(Fi.JOIN_CONVERSATION.name,m,void 0,S),this.http.cancelRequestIfPending(Fi.START_CALL.name,m,void 0,S),this.joinGivenConversation(g.conversationUrl.Location,g.correlationId,this.lastUsedOutgoingMediaContent,this.mediaTypesToUse,void 0,v,m)}}handleCallProgress(g){this.telemetryHelper.recordIncomingEvent(Li.HANDLE_CALL_PROGRESS,g);const m=extractCauseIdFromMessage(g);this.logger.info(`[${m}][handleCallProgress]`);const S=g.body.callProgress;this.fsmState===Di.SIGNALING_FSM_STATE.OUTGOING&&(this.telemetryHelper.setTimeToRingDuration(),this.resetCallEstablishmentTimeout(m),this.onCallStatusChanged(Di.CALL_STATUS.RINGING,m),"forwarded"===S.status&&this.signalingSessionCallback.onCallForwarded({destinationType:S.forwardingDestinationType||"user"},m))}resetCallEstablishmentTimeout(g){this.logger.info("resetCallEstablishmentTimeout"),this.timeoutManager.stopTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.timeoutManager.startTimer(Di.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(g)}),Di.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT)}handleMediaAcknowledgement(g){this.telemetryHelper.recordIncomingEvent(Li.HANDLE_MEDIA_ACK,g);const m=g.body,S=extractCauseIdFromMessage(g);this.currentCallStatus!==Di.CALL_STATUS.CONNECTED?this.telemetryHelper.recordEvent(Li.HANDLE_MEDIA_PROVISIONAL_ACK,{causeId:S}):this.mediaRenegotiationManager.handleMediaAcknowledgment(m,S)}handleConversationUpdate(g){const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleConversationUpdate]content=${getPrintableObject(m)}`),this.telemetryHelper.recordIncomingEvent(Li.HANDLE_CONVERSATION_UPDATE,g),this.processConversationServiceResponse(m,S,2)}endBroadcastMeeting(g){this.logger.info(`[${g}][endBroadcastMeeting]`),this.broadcastSession=null}handleLocalParticipantUpdate(g){const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleLocalParticipantUpdate]content=${getPrintableObject(m)}`),this.telemetryHelper.recordIncomingEvent(Li.HANDLE_LOCAL_PARTICIPANT_UPDATE,g),this.processLocalParticipantUpdateResponse(m,S)}handleAddModalityFailure(g){const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleAddModalityFailure]`),this.telemetryHelper.recordIncomingEvent(Li.HANDLE_ADD_MODALITY_FAILURE,g),m.modalityFailure.contentSharing?this.contentSharingManager?.handleAddModalityFailure(m,S):m.modalityFailure.groupChat?this.signalingSessionCallback.onChatModalitySetupFailed({code:m.modalityFailure.groupChat.code,subCode:m.modalityFailure.groupChat.subCode,phrase:m.modalityFailure.groupChat.phrase,resultCategories:m.modalityFailure.groupChat.resultCategories},S):m.modalityFailure.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalityFailure(m,S)}handleAddModalitySuccess(g){const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleAddModalitySuccess]`),this.telemetryHelper.recordIncomingEvent(Li.HANDLE_ADD_MODALITY_SUCCESS,g),m.modalitySuccess.contentSharing?this.contentSharingManager?.handleAddModalitySuccess(m,S):m.modalitySuccess.groupChat?this.logger.info(`[${S}][handleAddModalitySuccess] group modality ${getPrintableObject(m.modalitySuccess.groupChat)}`):m.modalitySuccess.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalitySuccess(m,S)}handleTransferRequested(g){const m=g.body.callTransfer,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleTransferRequested]`),m.parkType?(this.telemetryHelper.recordIncomingEvent(Li.HANDLE_PARK_REQUESTED,g,{type:m.parkType}),this.telemetryHelper.addSharedCorrelationId(m.sharedCorrelationId)):"voicemail"===m.target.endpointType?(this.logger.info(`[${S}][handleTransferRequested] target endpointType = ${m.target.endpointType}`),this.telemetryHelper.recordIncomingEvent(Li.TRANSFER_REQUEST_RECEIVED,g)):this.telemetryHelper.recordIncomingEvent(Li.TRANSFER_REQUEST_RECEIVED,g),this.links[Di.LINKS.TRANSFER_ACCEPTANCE]=m.links.transferAcceptance,this.links[Di.LINKS.TRANSFER_COMPLETION]=m.links.transferCompletion,this.signalingSessionCallback.onTransferRequested?this.signalingSessionCallback.onTransferRequested(m,S):this.logger.info(`[${S}][handleTransferRequested] failed, no callback defined`)}handleTransferAcceptance(g){const m=extractCauseIdFromMessage(g);this.logger.info(`[${m}][handleTransferAcceptance]`),this.telemetryHelper.recordIncomingEvent(Li.WAITING_FOR_TRANSFER_COMPLETION,g),this.signalingSessionCallback.onTransferAccepted?this.signalingSessionCallback.onTransferAccepted(m):this.logger.info(`[${m}][handleTransferAcceptance]failed, no callback defined`)}handleTransferCompletion(g){const m=g.body,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleTransferCompletion]`),m.sharedCorrelationId&&this.telemetryHelper.addSharedCorrelationId(m.sharedCorrelationId),void 0!==m.unparkContent?.pickupCode&&(m.unparkContent.pickupCode=m.unparkContent.pickupCode.toString(),this.telemetryHelper.recordIncomingEvent(Li.PICKUP_CODE_SET,g)),this.signalingSessionCallback.onTransferCompleted?(g.body.transferCompletion&&(0===g.body.transferCompletion.code?this.telemetryHelper.recordIncomingEvent(Li.TRANSFER_COMPLETED,g):(this.logger.info(`[${S}][handleTransferCompletion]-1-code: ${m.transferCompletion.code}, message: ${getPrintableObject(g)}`),this.telemetryHelper.recordIncomingEvent(Li.TRANSFER_COMPLETION_FAILED,g,{code:m.transferCompletion.code,subcode:m.transferCompletion.subCode,resultCategories:m.transferCompletion.resultCategories}))),this.signalingSessionCallback.onTransferCompleted(m,S)):(g.body.transferCompletion&&(g.body.transferCompletion.code===Di.CALL_END_CODE.NETWORK_ERROR?this.telemetryHelper.recordIncomingEvent(Li.WAITING_FOR_TRANSFER_COMPLETION_FAIL,g):this.telemetryHelper.recordIncomingEvent(Li.TRANSFER_COMPLETION_FAILED,g,{code:m.transferCompletion.code,subcode:m.transferCompletion.subCode,resultCategories:m.transferCompletion.resultCategories})),this.logger.info(`[${S}][handleTransferCompletion]failed, no callback defined`))}handleRosterUpdate(g,m){const S=g.body,v=extractCauseIdFromMessage(g);this.disposing||this.disposed?this.logger.info(`[${v}][handleRosterUpdate]failed=ignore call ending or ended`):this.internalHandleRosterUpdate(S,m,v)}handleNewMediaOffer(g){const m=extractCauseIdFromMessage(g);this.telemetryHelper.recordIncomingEvent(Li.HANDLE_NEW_OFFER,g);const S=g.body.mediaOfferReady.mediaContent;this.callUsesMixer=S.fromMixer,this.signalingSessionCallback.onNewOffer({mediaContent:S,renegotiation:!1},m)}internalHandleRosterUpdate(g,m,S){if(g&&"Delta"!==g.type&&"MultiPartyEndpoint"!==g.type)this.logger.warn(`[${S}][internalHandleRosterUpdate] roster.type=${g.type} is invalid`);else{this.logger.info(`[${S}][internalHandleRosterUpdate]`);try{this.participantManager.handleRosterUpdate(g,m,S),this.contentSharingManager?.handleIncomingContentSharingFromRoster(g,m,S)}catch(m){const v={code:Di.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Di.CALL_END_SUB_CODE.ROSTER_HANDLING_INVALID_SERVICE_RESPONSE,phrase:m?.toString()};throw this.logger.info(`[${S}][internalHandleRosterUpdate] ${safeJsonStringify(v)}`),this.telemetryHelper.recordRosterEvent(g,Li.HANDLE_ROSTER_UPDATE_FAIL,S),v}}}scheduleKeepAlives(g){const m=.9*g*1e3;this.logger.info(`scheduleKeepAlives: every ${m} milliseconds`),this.keepAliveInterval=m,this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval)}scheduleConversationKeepAlive(){if(!this.conversationKeepAliveTimer&&!this.disposed){if(!this.conversationKeepAliveInterval){const g=getRandomizedTimeout(1e3*this.signalingAgentConfig.csaTimeoutConfiguration.conversationKeepAliveTimeoutSec);this.logger.info(`sendConversationKeepAlive: every ${g} milliseconds`),this.conversationKeepAliveInterval=g}this.conversationKeepAliveTimer=window.setInterval(this.sendConversationKeepAlive.bind(this),this.conversationKeepAliveInterval)}}sendConversationKeepAlive(){this.logger.info("sendConversationKeepAlive"),this.disposed?this.logger.info("sendConversationKeepAlive ignored"):(this.logger.info("sendConversationKeepAlive keepAlive count = "+this.conversationKeepAliveCount++),this.sendToUpdateConversationLinks(!0))}sendKeepAlive(){this.logger.info("sendKeepAlive"),this.disposed?this.logger.info("sendKeepAlive ignored"):(this.logger.info("sendKeepAlive keepAlive count = "+this.keepAliveCount++),this.sendToKeepAliveUrl(null))}sendToUpdateConversationLinks(g,m=causeId2()){if(this.disposed)return;const S=this.logger.createChild(`[${m}][sendToUpdateConversationLinks]`,this.correlationId),v=g?getPayload54(this):{},C=g?Fi.UPDATE_CONVERSATION_LINKS.name:Fi.SEND_CONVERSATION_KEEP_ALIVE.name,_=this.links[Di.LINKS.NOTIFICATION_LINKS];S.info(`shouldUpdateUrl: ${g}, url: ${_}, payload: ${getPrintableObject(v)}`),_&&(this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.http.sendPostRequest({url:_,payload:v,withoutTrouter:!0,requestName:C,causeId:m}).then((g=>{this.disposed||(this.telemetryHelper.recordEvent(Li.UPDATE_CONVERSATION_LINKS_SUCCESS,{causeId:m}),this.processConversationServiceResponse(g.response,m,2))})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig),v=isRetryable(S.error.code);this.logger.info(`[${m}][updateConversationLinks] error: ${getPrintableObject(S)}, retryable: ${v}`),this.disposed||(this.telemetryHelper.recordEvent(Li.UPDATE_CONVERSATION_LINKS_FAILED,{causeId:m,...S.error}),v?this.scheduleConversationKeepAlive():this.links[Di.LINKS.NOTIFICATION_LINKS]=null)})))}sendToKeepAliveUrl(g,m=causeId2()){const S=this.logger.createChild(`[${m}][sendToKeepAliveUrl]`,this.correlationId);S.info(`payload: ${getPrintableObject(g)}`),window.clearInterval(this.keepAliveTimer),this.disposed||(this.telemetryHelper.recordEvent(Li.SEND_KEEP_ALIVE),this.http.sendPostRequest({url:this.links[Di.LINKS.KEEPALIVE],payload:g,requestName:Fi.SEND_KEEP_ALIVE.name,withoutTrouter:!0,causeId:m}).then((()=>{this.restartKeepAliveInterval()})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);S.info(`error: ${getPrintableObject(m)}`),this.restartKeepAliveInterval(!0,m.error)})))}handleCallEstablishmentTimeout(g,m,S){const v={code:Di.CALL_END_CODE.TIMEOUT,subCode:m||Di.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:S||Di.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT,resultCategories:[Ii.UnexpectedClientError]};this.isPromotingToRealtime?this.onPromotionCompleted(!0,v,g):(this.telemetryHelper.recordEvent(Li.HANDLE_CALL_ESTABLISHMENT_TIMEOUT),this.telemetryHelper.setTerminatingData({terminatingEnd:xi.CALL_TERMINATING_END.LOCAL,resultValue:xi.RESULT_VALUE.FAILURE,resultDetail:v.phrase,endCode:v.code,endSubCode:v.subCode,causeId:g,resultCategories:v.resultCategories}),this.fsmState=Di.SIGNALING_FSM_STATE.IDLE,this.onCallStatusChanged(Di.CALL_STATUS.LOCAL_TERMINATED,g,v),this.dispose(v,g))}handleCallTransferTimeout(g,m){if(this.disposed)return void this.logger.info("Transfer: handleCallTransferTimeout ignored");const S={code:Di.CALL_END_CODE.TIMEOUT,phrase:Di.CALL_END_PHRASE.TRANSFER_COMPLETION_TIMEOUT};this.signalingSessionCallback.onTransferCompleted&&(!1===m?this.telemetryHelper.recordEvent(Li.TRANSFER_COMPLETION_FAILED,{code:Di.CALL_END_CODE.TIMEOUT,subcode:Di.CALL_END_SUB_CODE.TRANSFER_COMPLETE_TIMEOUT,causeId:g}):!0===m&&this.telemetryHelper.recordEvent(Li.WAITING_FOR_TRANSFER_ACCEPTANCE_FAIL,{causeId:g}),this.signalingSessionCallback.onTransferCompleted({transferCompletion:S},g))}checkCorrelationIdChange(g,m){if(g&&g.headers){const S=g.headers.get(Di.HEADERS.CORRELATION_ID);if(S&&S.length){const v=[Mi.CONV_CONTENT_SHARING_UPDATE,Mi.CONV_CONTENT_SHARING_END].some((m=>g.url&&stringEndsWith(g.url,m)));this.correlationId===S||v||(this.logger.info(`[${m}]checkCorrelationIdChange:${this.correlationId} => ${S}`),this.telemetryHelper.addChangingCorrelationId(this.correlationId,S),this.updateCorrelationId(S,m))}}}getCommandUrlPresence(){let g=0;return this.links[Di.LINKS.MUTE]&&(g|=1),this.links[Di.LINKS.UNMUTE]&&(g|=2),g}getCallNotFoundTransactionEnd(){return{code:Di.CALL_END_CODE.CALL_DOES_NOT_EXIST,subCode:0,phrase:Di.CALL_END_PHRASE.CALL_DOES_NOT_EXIST}}getTerminatingCallResultDetail(g,m){return getPrintableObject({source:g,...m})}dispose(g,m){this.disposed||(this.logger.info(`[${m}][dispose] end reason ${getPrintableObject(g)}`),this.disposed=!0,this.disposing=!1,this.tearDownConnectionCheck(),this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.brokerService&&this.brokerService.dispose(),this.http.cancelAllRequests(m).then((()=>{this.signalingAgent.onCallCompleted(this.sessionId,m),this.signalingAgentConfig.trouterUrlGetter&&this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed.off(this.onTrouterUrlChanged),this.signalingAgentConfig.trouterServiceProvider&&this.signalingAgentConfig.trouterServiceProvider.offStateChanged(this.onTrouterStateChanged),this.timeoutManager.dispose(),this.timeoutManager=null,this.participantManager.dispose(g,m),this.callOperationHandler.dispose("call ended",g,m),this.participantManager=null,this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=null,this.contentSharingManager?.dispose(g,m),this.contentSharingManager=null,this.telemetryHelper.dispose(),this.telemetryHelper=null,this.webRtcSignalingManager.dispose(),this.webRtcSignalingManager=null})))}};function build5(g,m,S,v,C,_){return new Mn(g,m,S,v,C,_)}var wn=class{constructor(g){this.endpointId=newGuid(),this.signalingSessions={},this.clientSupportsGenericTokenAPI=!1,this.getNewSignalingSession=(g,m,S,v)=>{const C=causeId2();assertNotNull(g,"selfParticipant should be a non null value"),assertNotNull(m,"signalingSessionCallback should be a non null value");const _=S||newGuid();assertNotNullOrEmpty(_,"signalingSession id generated cannot be null or empty"),this.checkConfigChange(C);const E=build5(g,m,this.signalingAgentConfig,_,this,v),T=E.sessionId;return this.signalingSessions[T]=E,this.logger.info(`[${C}]Created new signalingSession with correlation ID ${_} and session ID ${T}`),E},this.resolvePotentialCallConflict=g=>{const m=causeId2();let S;if(this.logger.info(`[${m}][resolvePotentialCallConflict]`),!g.multiParty)return Object.keys(this.signalingSessions).forEach((m=>{this.isSessionInConflictingState(this.signalingSessions[m],!g.isIncomingCall)&&(S=g.isIncomingCall?this.compareAndGetConflictingSession(g,this.signalingSessions[m]):this.compareAndGetConflictingSession(this.signalingSessions[m],g))})),S?(this.logger.info("Call conflict done, conflicting session callId=",S.correlationId,"urlIdentifier=",S.urlIdentifier),S.telemetryHelper.recordEvent(Li.CONFLICTED_CALL),this.signalingAgentConfig.endConflictedCall?(this.endConflictedSession(S,m),S):void 0):void 0},this.handleIncomingNotification=g=>{if(assertNotNull(g,"request should be a non null value"),this.logger.info(`handleIncomingNotification to : ${g.url}`),!g.body&&!g.rawBody)return this.logger.error("request has no body"),this.buildNotificationResponse(Di.HTTP_STATUS_CODES.BAD_REQUEST);let m=Di.HTTP_STATUS_CODES.OK;const S=getIdFromUrl(g.url);if(S){const v=this.signalingSessions.hasOwnProperty(S);if(this.logger.info(`Is session found:${v}`),v){const m=this.signalingSessions[S];if(g.headers=new Ni(g.headers),isEncodedMessage(g.headers))try{if(!isMessageEncodingSupported(g.headers))throw new Error("Unsupported encoding");const m=decodeMessage(g.rawBody),S=JSON.parse(m);g.body=S}catch(g){return m.telemetryHelper.recordEvent(Li.TROUTER_DECODE_PAYLOAD_FAILURE),this.buildNotificationResponse(Di.HTTP_STATUS_CODES.BAD_REQUEST)}if(m.canHandleIncomingMsgSync(g))return m.handleIncomingMsgSync(g);window.setTimeout((()=>{if(this.signalingSessions.hasOwnProperty(S)){const m=this.signalingSessions[S];m.handleIncomingMsgAsync(g).catch((g=>{m&&m.telemetryHelper&&m.telemetryHelper.recordEvent(Li.FAILED_TO_HANDLE_TROUTER_MESSAGE),this.logger.error(`handling IncomingMsg failed with error: ${g}`)}))}}),0)}else this.logger.info(`Incoming message for session ID ${S}, but session was not found!`),m=Di.HTTP_STATUS_CODES.NOT_FOUND}else this.logger.error(`Could not retrieve session ID from Url path. Path = ${g.url}`),m=Di.HTTP_STATUS_CODES.BAD_REQUEST;const v=this.buildNotificationResponse(m);return this.logger.info(`Result code:${getPrintableObject(v)}`),v},this.onCallCompleted=(g,m)=>{this.signalingSessions.hasOwnProperty(g)?(delete this.signalingSessions[g],this.logger.info(`[${m}][onCallCompleted] Session ID ${g} found. Deleted from signalingSession table`)):this.logger.info(`[${m}][onCallCompleted] Session ID ${g} not found. Could not delete from signalingSession table`)},this.applyAuthTokenCacheConfig=g=>{this.signalingAgentConfig.enableTokenCache?(this.authTokenManager.setTokenCaching(!0,g),this.signalingAgentConfig.enableTokenPrefetch&&this.authTokenManager.getToken(g).then((()=>{this.logger.info(`[${g}] token prefetch success`)})).catch((m=>{this.logger.info(`[${g}] token prefetch failure, error=${getPrintableObject(m)}`)}))):this.authTokenManager.setTokenCaching(!1,g),this.signalingAgentConfig.enableTokenCacheForGenericTokenAPI?this.authTokenManager.setTokenCachingForGenericTokenAPI(!0,g):this.authTokenManager.setTokenCachingForGenericTokenAPI(!1,g)},this.endConflictedSession=(g,m)=>{this.logger.info("Call conflict, ending signalingSession with callId=",g.correlationId,"urlIdentifier=",g.urlIdentifier),g.endAsync({code:Di.CALL_END_CODE.CONFLICT,subCode:Di.CALL_END_SUB_CODE.CONFLICT_IN_NG,phrase:Di.CALL_END_PHRASE.CONFLICT},{forEveryone:!1,causeId:m})},this.compareAndGetConflictingSession=(g,m)=>{if(!is1to1Mri(g.incomingCallCallerId)||!is1to1Mri(m.participantManager.localParticipant.id))return;const S=stripMri(g.incomingCallCallerId),v=stripMri(m.participantManager.getParticipantsToInitiateCallWith().length&&m.participantManager.getParticipantsToInitiateCallWith()[0].id),C=stripMri(m.participantManager.localParticipant.id);return v===S?C>S?g:m:void 0},this.isSessionInConflictingState=(g,m)=>{if(!g)return this.logger.info("Call conflict, ignore, session already disposed"),!1;const S=[Di.CALL_STATUS.IDLE,Di.CALL_STATUS.CONNECTING,Di.CALL_STATUS.RINGING];return!g.multiParty&&S.indexOf(g.getCallStatus())>-1&&(m&&g.isIncomingCall||!m&&!g.isIncomingCall)},this.buildNotificationResponse=(g,m)=>this.signalingAgentConfig.supportsSynchronousTrouterResponse?{resultCode:g,responseBody:m}:g,setDefaultsForSignalingConfig(g),this.signalingAgentConfig=g,this.logger=g.logger.createChild("SignalingAgent"),assertNotNull(g,"signalingAgentConfig should be a non null value"),this.logger.info(g.isWebRtcEnabled?"webRTC enabled":"ORTC enabled");const m={aadTokenExpirationTimeInSeconds:g.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:g.caeTokenExpirationTimeInSeconds,disableTokenMigrationHeader:g.disableTokenMigrationHeader,enablePublishTokenTelemetry:g.enablePublishTokenTelemetry,refreshTimeBeforeTokenTimeoutInSeconds:g.refreshTimeBeforeTokenTimeoutInSeconds,forceClearExpiredTokens:g.forceClearExpiredTokens,enableRefreshToken:g.enableRefreshToken,enableRefreshTokenRetry:g.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:g.enableRefreshTokenRetryInSeconds};this.authTokenManager=$i.build(this.logger,g.skypeToken,m,g.telemetryManager),this.applyAuthTokenCacheConfig(causeId2()),Ni.useLowerCaseHeaders=g.forceLowercaseHttpHeaders}updateSignalingAgentConfig(g){const m=causeId2(),S=JSON.stringify(g,((g,m)=>g?String(m):m));this.logger.info(`[${m}] updateSignalingAgentConfig, SignalingAgentConfig: ${S}`),this.logger.info(`[${m}] ecsEtag=${g.ecsEtag}`),setDefaultsForSignalingConfig(g),this.updatedSignalingAgentConfig=g,this.authTokenManager?.updateTokenSettings({aadTokenExpirationTimeInSeconds:g.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:g.caeTokenExpirationTimeInSeconds,refreshTimeBeforeTokenTimeoutInSeconds:g.refreshTimeBeforeTokenTimeoutInSeconds,disableTokenMigrationHeader:g.disableTokenMigrationHeader,enablePublishTokenTelemetry:g.enablePublishTokenTelemetry,forceClearExpiredTokens:g.forceClearExpiredTokens,enableRefreshToken:g.enableRefreshToken,enableRefreshTokenRetry:g.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:g.enableRefreshTokenRetryInSeconds}),Ni.useLowerCaseHeaders=g.forceLowercaseHttpHeaders}updateUrls(g,m,S){this.logger.info(`updateUrls: conversationServiceUrl: ${g}, uploadLogRequestUrl: ${m}, enforceUrls: ${S}`),this.updatedSignalingAgentConfig=this.updatedSignalingAgentConfig||this.signalingAgentConfig,S||!this.updatedSignalingAgentConfig.isConversationServiceUrlFromEcs?this.updatedSignalingAgentConfig.conversationServiceUrl=g||this.updatedSignalingAgentConfig.conversationServiceUrl:this.updatedSignalingAgentConfig.conversationServiceUrl=this.updatedSignalingAgentConfig.conversationServiceUrl||g,S||!this.updatedSignalingAgentConfig.isUploadLogRequestUrlFromEcs?this.updatedSignalingAgentConfig.uploadLogRequestUrl=m||this.updatedSignalingAgentConfig.uploadLogRequestUrl:this.updatedSignalingAgentConfig.uploadLogRequestUrl=this.updatedSignalingAgentConfig.uploadLogRequestUrl||m}update(g){this.logger.info(`update accountConfiguration ${JSON.stringify(g)}`),g&&g.clientSupportsGenericTokenAPI!==this.clientSupportsGenericTokenAPI&&(this.clientSupportsGenericTokenAPI=g.clientSupportsGenericTokenAPI,this.authTokenManager.updateTokenSettings({clientSupportsGenericTokenAPI:this.clientSupportsGenericTokenAPI})),this.accountConfig=g}sendPushAsync(g,m,S,v,C=causeId2()){const _=new Gi(this.signalingAgentConfig.piiScrubber),E=`sendPush[local participant mri = ${_.scrubMriOrOmit(g)}][recipientList = ${_.scrubMriOrOmit(m)}][headers = ${S})][causeId = ${C}]`;if(!g?.id)return this.logger.info(`${E} Empty localParticipantId`),Promise.reject("invalid localParticipantId");if(!m||0===m.length||m.every((g=>g&&""===g.id)))return this.logger.info(`${E} Empty recipientList`),Promise.reject("invalid recipientList");if(!S)return this.logger.info(`${E} Empty headers`),Promise.reject("invalid headers");if(!v||null===tryParse(v))return this.logger.info(`${E} Invalid body.`),Promise.reject("invalid body");const T={...tryParse(v),To:Array.from(m,(g=>g.id)),From:g.id},I=new Ni(S);I.hasOwnPropertyCaseInsensitive(Di.HEADERS.CORRELATION_ID)||I.set(Di.HEADERS.CORRELATION_ID,generateGuid()),I.hasOwnPropertyCaseInsensitive(Di.HEADERS.MESSAGE_ID)||I.set(Di.HEADERS.MESSAGE_ID,generateGuid()),I.hasOwnPropertyCaseInsensitive(Di.HEADERS.PARTICIPANT_ID)||I.set(Di.HEADERS.PARTICIPANT_ID,generateGuid()),I.hasOwnPropertyCaseInsensitive(Di.HEADERS.CONTENT_TYPE)||I.set(Di.HEADERS.CONTENT_TYPE,"application/json"),I.hasOwnPropertyCaseInsensitive(Di.HEADERS.CLIENT_USER_AGENT)&&I.set(Di.HEADERS.CLIENT_USER_AGENT,I.get(Di.HEADERS.CLIENT_USER_AGENT)+`/TsCallingVersion=${getTsCallingVersion()}/Ovb=${getOvb()}`);const b=this.signalingAgentConfig.httpRequestDispatcher.getRequestOptions("POST",I?.getAll(),JSON.stringify(T),3e4);return new Promise(((g,m)=>{this.signalingAgentConfig.httpRequestDispatcher.postAsync(this.signalingAgentConfig.uploadLogRequestUrl||Di.URL_DEFAULTS.UPLOAD_LOG_URL,b).then((()=>{g()})).catch((g=>{m(g)}))}))}getSignalingSession(g){for(const m of Object.keys(this.signalingSessions)){const S=this.signalingSessions[m];if(S.correlationId===g)return S}return null}updateToken(g,m,S,v,C){this.authTokenManager.updateToken(g,m,S,v,C)}setTokenRequiredCallBack(g){this.authTokenManager.setTokenRequiredCallBack(g)}resetAuthTokenManager(){this.setTokenRequiredCallBack(null),this.authTokenManager.setDisableTimerFlag(!0),this.authTokenManager.dispose()}checkConfigChange(g){this.updatedSignalingAgentConfig&&this.updatedSignalingAgentConfig!==this.signalingAgentConfig&&(this.signalingAgentConfig=this.updatedSignalingAgentConfig,this.updatedSignalingAgentConfig=null,this.applyAuthTokenCacheConfig(g))}},Dn=/;aliases=.*$/i,On="8:",Nn=";aliases=",kn="2:",Ln="4:";function stripMriAliases(g){return g?g.replace(Dn,""):g}function generateAliasedMri(g,m){let S=g;return m&&(S+=Nn+kn+m),S}var isOneOfPhaseErrors=(g,m)=>m&&void 0!==m.phase&&!!g[m.phase],isPhaseError=(g,m)=>m&&void 0!==m.phase&&m.phase===g;function createPhaseExecutor(g){const m={},recordPhaseStep=g=>{const S={status:"Pending"};m[g]=S},recordStepDoneTelemetry=(g,S)=>{m[g].t=S,delete m[g].status},recordStepFailedTelemetry=(g,S,v)=>{m[g].status="Failed",m[g].t=S,m[g].reason=getPrintableObject(v)};return{execute:async(S,v)=>{const C=g.createChild(`[phase=${S}]`);recordPhaseStep(S),C.info("started");const _=(new Date).getTime();try{const g=await v(),m=+new Date-_;return C.logSuccess(`done, time=${m}`),recordStepDoneTelemetry(S,m),g}catch(g){const v=+new Date-_;throw C.logFailure(`time=${v}, error=${getPrintableObject(g)}`),recordStepFailedTelemetry(S,v,g),{phase:S,error:g,phases:m}}},executeSync:(S,v)=>{const C=g.createChild(`[phase=${S}]`);C.info("started"),recordPhaseStep(S);const _=(new Date).getTime();try{const g=v(),m=+new Date-_;return recordStepDoneTelemetry(S,m),C.logSuccess(`done, time=${m}`),g}catch(g){const v=+new Date-_;throw C.logFailure(`time=${v}, error=${getPrintableObject(g)}`),recordStepFailedTelemetry(S,v,g),{phase:S,error:g,phases:m}}},getTelemetryData:()=>m}}function callStateIsAnyOf(g,m){return-1!==m.indexOf(g)}var Fn,xn,Un,Vn={0:[1,2,8,6,10,11,9],1:[2,6,7,10,13],2:[1,3,6,7,9,10,13,14],3:[6,7,4,5,10,13],8:[1,11,10,2,9,6,7],4:[6,7,3,5,10,13],5:[6,7,3,4,10,13],9:[3,6,7,10,13],10:[3,6,7,9,4,5,13,15],13:[3,6,7,4,5],14:[3,6,7,10,13],15:[3,6,7,4,5,13],11:[12,1,2,6,7],12:[2,6,7],6:[7],7:[]};(g=>{let m;var S;let v;var C;let _;var E;let T;var I;(S=m=g.VideoEffectType||(g.VideoEffectType={})).Off="off",S.BackgroundBlur="blur",S.BackgroundReplacement="replacement",(C=v=g.PowerPreference||(g.PowerPreference={})).Default="default",C.HighPerformance="high-performance",C.LowPower="low-power",(E=_=g.ProcessorType||(g.ProcessorType={})).Wasm="Wasm",E.Webgl2="Webgl2",(I=T=g.EffectQualityChangeReason||(g.EffectQualityChangeReason={}))[I.ExternalParam=0]="ExternalParam",I[I.Performance=1]="Performance",I[I.RendererSize=2]="RendererSize"})(Fn||(Fn={})),(g=>{let m;var S;let v;var C;let _;var E;let T;var I;let b;var A;(S=m=g.CallType||(g.CallType={}))[S.P2P=0]="P2P",S[S.Conference=1]="Conference",S[S.PSTN=2]="PSTN",S[S.BroadcastingConf=3]="BroadcastingConf",(C=v=g.AudioUsageMode||(g.AudioUsageMode={}))[C.Default=0]="Default",C[C.LongRangeSpeaker=1]="LongRangeSpeaker",C[C.Auditorium=2]="Auditorium",(E=_=g.AecPerfProfile||(g.AecPerfProfile={}))[E.Normal=0]="Normal",E[E.Soc=1]="Soc",E[E.Mobile=2]="Mobile",E[E.NoisyTimestamps=3]="NoisyTimestamps",(I=T=g.VqeMode||(g.VqeMode={}))[I.Off=0]="Off",I[I.SkypeNS=1]="SkypeNS",I[I.SkypeAEC=2]="SkypeAEC",I[I.SkypeVQE=3]="SkypeVQE",I[I.DeepNS=4]="DeepNS",I[I.DeepVQE=5]="DeepVQE",(A=b=g.AudioEffectType||(g.AudioEffectType={})).Off="Off",A.NoiseSuppressionDeep="Deep NS",A.NoiseSuppressionClassic="Classic NS",A.EchoCancellationClassic="Classic AEC",A.VoiceQualityEnhancementClassic="Classic VQE",A.VoiceQualityEnhancementDeep="Deep VQE"})(xn||(xn={})),(g=>{let m;var S;let v;var C;(S=m=g.FrameType||(g.FrameType={}))[S.None=0]="None",S[S.Software=1]="Software",S[S.Hardware=2]="Hardware",(C=v=g.LogLevel||(g.LogLevel={}))[C.Default=0]="Default",C[C.Debug=1]="Debug",C[C.Info=2]="Info",C[C.Warning=3]="Warning",C[C.Error=4]="Error"})(Un||(Un={}));var Bn=P,Hn=(g=>(g[g.CallStateChanged=0]="CallStateChanged",g[g.TrouterStateChanged=1]="TrouterStateChanged",g[g.MultiPartyModeSet=2]="MultiPartyModeSet",g[g.MediaRetargetSucceeded=3]="MediaRetargetSucceeded",g[g.MediaRetargetFailed=4]="MediaRetargetFailed",g))(Hn||{}),$n=(g=>(g[g.StartModality=0]="StartModality",g[g.StopModality=1]="StopModality",g[g.StreamStateChanged=2]="StreamStateChanged",g[g.NegotiationStateChanged=3]="NegotiationStateChanged",g))($n||{}),Gn=(g=>(g[g.SelectSource=0]="SelectSource",g[g.AttachSource=1]="AttachSource",g[g.DetachSource=2]="DetachSource",g))(Gn||{}),jn=(g=>(g[g.Available=0]="Available",g[g.Subscribe=1]="Subscribe",g[g.Subscribed=2]="Subscribed",g[g.Unsubscribe=3]="Unsubscribe",g[g.Unsubscribed=4]="Unsubscribed",g[g.RenderingStarted=5]="RenderingStarted",g[g.RenderingStopped=6]="RenderingStopped",g))(jn||{}),qn=class{constructor(g,m){this.value=g,this.piiKind=m}},Wn=class{};Wn.agentEnvironmentId="agent_environment_id",Wn.correlationId="CorrelationId",Wn.participantId="participant_id",Wn.tenantId="TenantId",Wn.userHexCID="UserHexCID",Wn.acsResourceId="AcsResourceId",Wn.endpointId="endpoint_id",Wn.mediaLegId="media_leg_id",Wn.webMediaConfigIds="web_media_config_ids",Wn.tsCallingVersion="ts_calling_version";var zn=class{};zn.diagnostics="MediaDiagnostic",zn.qoeStats="QoE",zn.webrtcSession="webrtc_session",zn.webrtcSessionInitial="webrtc_session_initial",zn.realtimeTelemetry="realtimetelemetry",zn.webrtcMediaSession="webrtc_call_session",zn.mediaSession="pluginless_modality_session",zn.callSession="pluginless_call_session";var Kn=class{constructor(g){this.eventName=g,this.ended=!1,this.events=[]}setLocalUserId(g){this.localUserId=g}start(){this.ended||(this.startTime=Date.now())}end(g=0){this.ended||(this.ended=!0,this.resultCode=g)}asStatsRecord(g={}){if((0,Bn.isEmpty)(this.events))return null;const m=(0,Bn.uniqBy)(this.events,(g=>JSON.stringify(g))).map((g=>{const m={[g.type]:g.timestamp-this.startTime};return(0,Bn.isEmpty)(g.data)||(m.data=g.data),m}));return{name:this.eventName,record:(0,Bn.assign)({LocalUser:this.localUserId,ResultCode:String(this.resultCode),EventTimestampBag:JSON.stringify({eventStart:this.startTime,events:m})},g)}}add(g){!this.ended&&g.type&&((0,Bn.isUndefined)(this.startTime)&&(this.startTime=Date.now()),(0,Bn.isUndefined)(g.timestamp)&&(g.timestamp=Date.now()),this.events.push(g))}},Jn=class _CallStats extends Kn{constructor(){super(zn.callSession)}callStateChanged(g){super.add({type:Hn[0],data:_CallStats.callStateToString[g]||g})}event(g){super.add({type:Hn[g]})}};Jn.callStateToString={0:"None",1:"Notified",2:"Connecting",3:"Connected",4:"LocalHold",5:"RemoteHold",6:"Disconnecting",7:"Disconnected",8:"Observing",10:"Lobby"};var Yn=Jn,Qn=class _MediaModalityStats extends Kn{constructor(g,m){super(zn.mediaSession),this.mediaType=g,this.mediaDirection=m,this.streamDirection=_MediaModalityStats.mediaDirectionToStream[this.mediaDirection]}addEvent(g,m){super.add({type:g,data:m})}lifecycle(g){this.addEvent($n[g])}streamStateChanged(g,m=this.streamDirection){const S=$n[2];this.addEvent(S,{state:_MediaModalityStats.streamStateToString[g],direction:_MediaModalityStats.streamDirectionToString[m]})}negotiationStateChanged(g,m,S=this.streamDirection){const v=$n[3];this.addEvent(v,{state:_MediaModalityStats.negotiationStateToString[g],reason:m})}asStatsRecord(g={}){return super.asStatsRecord((0,Bn.assign)({MediaType:_MediaModalityStats.mediaTypeToString[this.mediaType],Role:_MediaModalityStats.mediaDirectionToRole[this.mediaDirection]},g))}};Qn.negotiationStateToString={started:"NegotiationStarted",rejected:"NegotiationRejected",completed:"NegotiationCompleted"},Qn.streamStateToString={created:"StreamCreated",started:"StreamStarted",active:"StreamActive",inactive:"StreamInactive",stopped:"StreamStopped",removed:"StreamRemoved",failed:"StreamFailed",cancelled:"StreamCancelled"},Qn.streamDirectionToString={send:"Send",receive:"Receive"},Qn.mediaTypeToString={0:"Audio",1:"Video",2:"ScreenShare",3:"Data"},Qn.mediaDirectionToRole={1:"Receiver",2:"Sender",4:"Bidirectional"},Qn.mediaDirectionToStream={1:"receive",2:"send"};var Xn=Qn,Zn=class extends Xn{constructor(){super(0,4)}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}},er=class extends Xn{constructor(g){super(g,2),this.mediaType=g}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}event(g){super.addEvent(Gn[g])}},tr=class extends Xn{constructor(g,m){super(g,1),this.mediaType=g,this.remoteParticipantId=m,this.rendererCounter=0}newRendererId(){return this.rendererCounter+=1,String(this.rendererCounter)}event(g,m,S){super.addEvent(jn[g],(0,Bn.isUndefined)(S)?{rendererId:m}:{rendererId:m,sourceId:S})}asStatsRecord(){return super.asStatsRecord({TargetUser:this.remoteParticipantId})}},ir=class{constructor(){this.allStats=[],this.ended=!1}setLocalUserId(g){this.localUserId=g}get call(){return this.callStats||this.startCall()}get audio(){return this.audioStats||this.newSession(0)}get video(){return this.videoStats||this.newSession(1)}get screenShare(){return this.sharingStats||this.newSession(2)}renderer(g,m){let S=this.renderingStats[m];return S||(S=this.renderingStats[m]=this.receive(g,m)),S}startCall(){return this.callStats?this.callStats:(this.callStats=new Yn,this.callStats.start(),this.addStats(this.callStats))}endCall(g=0){this.ended=!0,this.call.end(g),this.allStats.forEach((g=>g.end())),this.cleanUp()}cleanUp(){this.audioStats&&(this.audioStats.stop(),this.audioStats=null),this.videoStats&&(this.videoStats.stop(),this.videoStats=null),this.sharingStats&&(this.sharingStats.stop(),this.sharingStats=null)}newSession(g){let m;switch(g){case 0:m=this.audioStats=new Zn;break;case 1:m=this.videoStats=new er(g);break;case 2:m=this.sharingStats=new er(g)}return this.addStats(m)}receive(g,m){const S=new tr(g,m);return S.start(),this.addStats(S)}buildStatsRecords(){return this.allStats.map((g=>g.asStatsRecord())).filter((g=>!!g))}addStats(g){return this.ended||(this.allStats.push(g),g.setLocalUserId(this.localUserId)),g}},nr=class _CallTelemetryBuilder{constructor(g){this.configProvider=g,this.localStats=new ir,this.tsCallingVersion=getTsCallingVersion()}setCallId(g){this.callId=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}setParticipantId(g){this.participantId=g}setEndpointId(g){this.endpointId=g}setMediaLegId(g){this.mediaLegId=g}setMediaStats(g){this.mediaStats=g}setAcsResourceId(g){this.acsResourceId=g}appendDataChannelInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.DataHandlers=g)}appendSharingControlInfo(g){this.mediaStats?.data&&(this.mediaStats.data.SharingControlEnabled=g?"true":"false")}appendMediaControlPaneInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.MediaControlPlane=g)}appendTerminationInfo(g,m){this.mediaStats?.data&&(this.mediaStats.data.TerminatedReason=`${g}`,this.mediaStats.data.TerminatedState=`${m}`)}appendPictureInPictureInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.PictureInPicture=g)}appendCallDeviceManagerInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.CallDeviceManager=g)}buildFromMediaStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,zn.webrtcSession)]:[]}buildShortBeaconEvent(){const g=this.configProvider?.config?.mediaEventDictionary??Ke.MEDIA_EVENT_FIELDS,m={};m[Wn.correlationId]=this.callId||"",m[Wn.participantId]=this.participantId||"",m[Wn.tenantId]=this.tenantId||"",m[Wn.tsCallingVersion]=this.tsCallingVersion||"",m.metrics_TerminationReason_code=new qn(Qt.CODE.SUCCESS,0),m.metrics_TerminationReason_subCode=new qn(Qt.SUB_CODE.BEACON,0);const S=this.buildFromDictionary(this.mediaStats.data,g);return[{eventName:zn.webrtcMediaSession,props:this.buildProps(S,null,m)}]}buildShortCallModalityStats(){const g={};return g[Wn.correlationId]=this.callId||"",g[Wn.userHexCID]=this.userHexCID||"",g[Wn.participantId]=this.participantId||"",g[Wn.endpointId]=this.endpointId||"",g[Wn.tenantId]=this.tenantId||"",g[Wn.tsCallingVersion]=this.tsCallingVersion||"",g[Wn.acsResourceId]=this.acsResourceId||"",g.Code=new qn(Qt.CODE.SUCCESS,0),g.SubCode=new qn(Qt.SUB_CODE.BEACON,0),[{eventName:"skypecosi_concore_web_csa_conversation_callmodality",props:g}]}buildFromDictionary(g,m){const S={};for(const v in m)g[v]&&(S[v]={},m[v].forEach((m=>{void 0!==g[v][m]&&(S[v][m]=g[v][m])})));return S}buildMediaTelemetry(){if(!this.mediaStats)return;const g=this.buildEvent(this.mediaStats.data,null).props,m={};return Object.keys(g).forEach((S=>{void 0===g[S].piiKind?m[S]=g[S]:m[S]=g[S].value})),m}buildMidCallTelemetry(g){if(!this.mediaStats)return[];const m=this.buildEvent(this.mediaStats.data,zn.webrtcSession),S=m.props,v=g.reduce(((g,m)=>(S[m]&&(g[m]=S[m]),g)),{});return[{eventName:m.eventName,props:v}]}buildFromCallSetupStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,zn.webrtcSessionInitial)]:[]}buildFromLocalStats(){return this.localStats.buildStatsRecords().map((g=>this.buildEvent(g.record,g.name)))}buildEvent(g,m){const S={};return S[Wn.agentEnvironmentId]=_CallTelemetryBuilder.agentEnvironmentId,S[Wn.correlationId]=this.callId||"",S[Wn.tenantId]=this.tenantId||"",S[Wn.userHexCID]=this.userHexCID||"",S[Wn.participantId]=this.participantId||"",S[Wn.endpointId]=this.endpointId||"",S[Wn.mediaLegId]=this.mediaLegId||"",S[Wn.webMediaConfigIds]=this.webMediaConfigIds||"",S[Wn.tsCallingVersion]=this.tsCallingVersion||"",S[Wn.acsResourceId]=this.acsResourceId||"",{eventName:m,props:this.buildProps(g,null,S)}}normalizeKey(g){return g.replace(/[^a-zA-Z0-9._]/g,"_")}buildProps(g,m,S){return Object.keys(g).forEach((v=>{const C=this.normalizeKey(v),_=m?`${m}_${C}`:C,E=g[v];if((0,Bn.isString)(E))S[_]=this.getPiiAwareValue(v,E);else if((0,Bn.isArray)(E)){if(E.length>0){const g=E,m=g.map((g=>g.value)).toString();S[_]=new qn(m,g[0].type)}}else if((0,Bn.isObject)(E))if(E.__VALUE__){const g=E;(0,Bn.isBoolean)(g.value)&&(g.value=g.value?"true":"false"),S[_]=new qn(g.value,g.type)}else this.buildProps(E,_,S)})),S}getPiiAwareValue(g,m){return _CallTelemetryBuilder.piiProps.hasOwnProperty(g)?new qn(m,_CallTelemetryBuilder.piiProps[g]):m}build(){return(0,Bn.flatten)([this.buildFromMediaStats(),this.buildFromLocalStats()])}};nr.agentEnvironmentId=generateGuid(),nr.piiProps={IPAddr:13,MACAddr:13,IPAddress:13,OpaqueData:0,LocalSite:13,RemoteSite:13,BaseAddress:13,LocalAddress:13,RemoteAddress:13,NetworkName:12,LocalUser:10,TargetUser:10};var rr=nr,sr=P;function convertReason(g){return g?getTerminationCode(g.code,g.subCode):0}function convertSignalingEndpointDetails(g,m){const S={clientVersion:g.clientVersion,participantId:g.participantId,endpointId:g.endpointId,endpointType:g.endpointType,endpointMetadata:g.endpointMetadata,originalId:g.originalId,capabilities:g.capabilities,clientEndpointCapabilities:g.clientEndpointCapabilities,mappedTo:g.mappedTo,meetingGroupDetails:g.meetingGroupDetails};return g.mediaStreams&&(S.mediaStreams=g.mediaStreams),g.appliedInteractivityLevel&&(S.appliedInteractivityLevel=g.appliedInteractivityLevel),g.deviceType&&(S.deviceType=g.deviceType),g.streamInformation&&32&m&&(S.streamInformation=g.streamInformation),g.propertyBag&&(S.propertyBag=g.propertyBag),S}function getTerminationCode(g,m=null){if(g===li.Success)switch(m){case ci.RemovedFromConversation:case ci.RemovedFromCall:return 44;case ci.DeniedInLobby:return 55;case ci.TimedOutInLobby:return 56;default:return 1}if(null!==m&&m>=2e5&&m<=299999){const g=m-2e5;return hi[g]?hi[g]:0}return null!==m&&m>=4e5&&m<=499999?ui[g]?ui[g]:43:g===li.Forbidden?m===ci.UserBlocked?64:m===ci.PolicyRestriction?62:m===ci.AnonymousJoinDisabledByPolicy?66:m===ci.NoLobbyForBroadcastJoin?67:m===ci.NotAllowedDueToInformationBarrier?68:m===ci.TeamParkPolicyDisabled?70:m===ci.B2bJoinDisabledByPolicy?71:m===li.Success?8:7:g===li.PreconditionFailed&&m===ci.InsufficientCapabilities?63:g===li.ServiceUnavailable?m===ci.BroadcastLimitReached?69:48:g===li.InternalServerError?7:g===li.ConfParticipantCountLimitReached?m===ci.MaxLobbyParticipantLimitReached?73:59:di[g]?di[g]:g}function getCSAEndCode(g){if(1===g)return li.Success;const m=Object.keys(di).filter((m=>di[m]===g));if(m.length>=1)for(const S of m){const m=parseInt(S);if(m&&di[m]===g)return m}return li.UnknownError}function getMediaState(g,m){if(void 0!==m&&3!==m&&1!==m)return{mediaType:g,isDisabled:0===m,label:getMediaLabel(g)}}function getCallStartOptions(g){if(g.sendMediaModalities)return g;const m={mediaStates:[]};let S=getMediaState(0,g.audioDirection?g.audioDirection:4);return S&&m.mediaStates.push(S),S=getMediaState(1,g.withVideo?4:g.videoDirection),S&&m.mediaStates.push(S),S=getMediaState(2,g.screenshareDirection?g.screenshareDirection:1),S&&m.mediaStates.push(S),g.sendMediaModalities=m,g}function convertRedirectOptions(g){const m=convertRedirectionTargetIdType(g.type),S=convertRedirectionEndpointType(g.endpointType);return{type:m,id:g.id,endpointType:S}}function convertRedirectionTargetIdType(g){if("mri"===g)return"mri";throw"Unknown RedirectionTargetIdType"}function convertRedirectionEndpointType(g){switch(g){case"voicemail":return"voicemail";case"default":return"default";default:throw"Unknown RedirectionEndpointType"}}var ar=class{constructor(g){this.mediaStateConfiguration=g}isDisabled(g){if(this.mediaStateConfiguration?.mediaStates){const m=this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g));return!!m&&!!m.isDisabled}return!1}isInactiveOrDisabled(g){if(this.mediaStateConfiguration?.mediaStates){const m=this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g));return!m||!!m.isDisabled}return!1}isSending(g){if(this.mediaStateConfiguration?.mediaStates){return!!this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g&&!m.isDisabled))}return!1}disableModality(g){this.setModality(g,!0)}enableModality(g){this.setModality(g,!1)}removeModality(g){this.mediaStateConfiguration?.mediaStates&&(0,sr.remove)(this.mediaStateConfiguration.mediaStates,(m=>m.mediaType===g))}setCallAcceptOptions(g){const m=this.isDisabled(1),S=this.isDisabled(2),v=this.isSending(3);if(g.sendMediaModalities)this.mediaStateConfiguration=g.sendMediaModalities;else{void 0===g.answerMediaType&&(g.answerMediaType=g.withVideo?1:0);const m={mediaStates:[]};switch(g.answerMediaType){case 0:m.mediaStates.push(getMediaState(0,4));break;case 1:m.mediaStates.push(getMediaState(0,4)),m.mediaStates.push(getMediaState(1,4));break;case 2:m.mediaStates.push(getMediaState(1,0))}this.mediaStateConfiguration=m}m&&this.setModality(1,!0),S&&this.setModality(2,!0),v&&this.setModality(3,!1),g.sendMediaModalities=this.mediaStateConfiguration}setModality(g,m){if(this.mediaStateConfiguration?.mediaStates){const S=this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g));S?S.isDisabled=m:this.mediaStateConfiguration.mediaStates.push({mediaType:g,isDisabled:m,label:getMediaLabel(g)})}}};function hasValue2(g){return g||!1===g||""===g||0===g}function scrubCallOptions(g){const m={};hasValue2(g.callStartTime)&&(m.callStartTime=g.callStartTime),hasValue2(g.callVoicemailStartOptions)&&(m.callVoicemailStartOptions=g.callVoicemailStartOptions),hasValue2(g.invitationType)&&(m.invitationType=g.invitationType),hasValue2(g.meetingPreferences)&&(m.meetingPreferences=g.meetingPreferences),hasValue2(g.parkContext)&&(m.parkContext=g.parkContext),hasValue2(g.pickupCode)&&(m.pickupCode=g.pickupCode),hasValue2(g.participantsToNudge)&&(m.participantsToNudgeSize=g.participantsToNudge.length);const S=g.callStartOptions;if(S){const g={};hasValue2(S.additionalEndpointProperties)&&(g.additionalEndpointProperties=S.additionalEndpointProperties),hasValue2(S.clientEndpointCapabilities)&&(g.clientEndpointCapabilities=S.clientEndpointCapabilities),hasValue2(S.connectionType)&&(g.connectionType=S.connectionType),hasValue2(S.invitationDataJson)&&(g.invitationDataJson=S.invitationDataJson),hasValue2(S.isCast)&&(g.isCast=S.isCast),hasValue2(S.isHuddleGroupCall)&&(g.isHuddleGroupCall=S.isHuddleGroupCall),hasValue2(S.label)&&(g.label=S.label),hasValue2(S.maxVideoChannels)&&(g.maxVideoChannels=S.maxVideoChannels),hasValue2(S.mediaConfiguration)&&(g.mediaConfiguration=S.mediaConfiguration),hasValue2(S.muteFlags)&&(g.muteFlags=S.muteFlags),hasValue2(S.muted)&&(g.muted=S.muted),hasValue2(S.negotiationTag)&&(g.negotiationTag=S.negotiationTag),hasValue2(S.preheatFlags)&&(g.preheatFlags=S.preheatFlags),hasValue2(S.ringOthers)&&(g.ringOthers=S.ringOthers),hasValue2(S.routingFlags)&&(g.routingFlags=S.routingFlags),hasValue2(S.scenario)&&(g.scenario=S.scenario),hasValue2(S.screenshareDirection)&&(g.screenshareDirection=S.screenshareDirection),hasValue2(S.sendMediaModalities)&&(g.sendMediaModalities=S.sendMediaModalities),hasValue2(S.sharedLineCallInvitationContentJson)&&(g.sharedLineCallInvitationContentJson=S.sharedLineCallInvitationContentJson),hasValue2(S.targetApplicationType)&&(g.targetApplicationType=S.targetApplicationType),hasValue2(S.clientEndpointDebugContent)&&(g.clientEndpointDebugContentSize=S.clientEndpointDebugContent.length),hasValue2(S.alternateId)&&(g.alternateId=scrubMriOrOmit(S.alternateId)),hasValue2(S.callKey)&&(g.callKeySize=S.callKey.length),hasValue2(S.encryptedKey)&&(g.encryptedKeySize=S.encryptedKey.length),m.callStartOptions=g}return m}function getAgentMediaType(g){switch(g){case 0:return"Audio";case 1:return"Video";case 2:return"ScreenShare"}throw new Error("MediaType required")}function getSkypeMediaType(g){switch(g){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2}throw new Error("MediaType required")}var or=class{constructor(){this.stateInt=0,this.promiseInt=new Promise(((g,m)=>{this.resolveInt=g,this.rejectInt=m}))}get state(){return this.stateInt}get resolve(){return g=>{this.stateInt=2,this.resolveInt(g)}}get reject(){return g=>{this.stateInt=1,this.rejectInt(g)}}get promise(){return this.promiseInt}get isPending(){return 0===this.stateInt}},lr=class{constructor(g){this.mcpConfig=g,this.data={sourceRequestsSignaling:{},sourceRequestsMCP:{},fallback:!1,sourceRequestsResponses:{},errors:[]}}setRecord(g,m,S){const v={sequenceNumber:m,timestamp:Date.now(),sourceId:S?.sourceId,fmtp:S?.fmtParams};g.records??(g.records=[]),arrayLimitedPush(g.records,v,this.mcpConfig.storedSRRecordsCount)}recordSignalingOperation(g,m){var S;(S=this.data.sourceRequestsSignaling)[g]??(S[g]={counter:0}),this.data.sourceRequestsSignaling[g].counter++,this.mcpConfig.verboseTelemetry&&this.mcpConfig.sendDuplicates&&"ApplyChannelParametersSourceRequest"===g&&this.setRecord(this.data.sourceRequestsSignaling[g],m)}recordMCPOperation(g,m,S){var v;(v=this.data.sourceRequestsMCP)[g]??(v[g]={counter:0}),this.data.sourceRequestsMCP[g].counter++,this.mcpConfig.verboseTelemetry&&this.setRecord(this.data.sourceRequestsMCP[g],m,S)}recordError(g,m){const S=[Date.now(),m,g];arrayLimitedPush(this.data.errors,S,this.mcpConfig.storedSRRecordsCount)}recordFallback(){this.data.fallback=!0}recordSignalingOperationDuration(g,m){const S=this.data.sourceRequestsSignaling[g]?.records?.find((g=>g.sequenceNumber===m));S&&(S.duration=Date.now()-S.timestamp)}recordSrResultReceived(g,m,S){var v;if(this.mcpConfig.verboseTelemetry){const v=this.data.sourceRequestsMCP[S]?.records?.find((g=>g.sequenceNumber===m));v&&(v.duration=Date.now()-v.timestamp,v.result=g)}(v=this.data.sourceRequestsResponses)[g]??(v[g]=0),this.data.sourceRequestsResponses[g]++}getObjectRef(){return this.data}},cr=5,dr=class{constructor(g){this.mcpConfig=g,this.storage={createTime:Date.now(),startedCount:0,stoppedCount:0,clientCapabilities:[],events:[]},this.sourceRequestSenderDiagnostics=new lr(this.mcpConfig)}get getSourceRequestSenderDiagnostics(){return this.sourceRequestSenderDiagnostics}logStarted(){if(this.storage.startedCount++,this.storage.startedCount>cr)return;const g={startedTs:duration(this.storage.createTime),mpCapabilities:{},sentMessages:{},recvMessages:{},sentFailed:0,recvFailed:0,cachedDshReceived:!1};this.storage.events.push(g),this.lastEventConnecting=!0}logStopped(){this.storage.stoppedCount++;const g=this.getCurrentDCSessionEvent();g&&(g.stoppedTs=duration(this.storage.createTime)),this.lastEventConnecting=!1}logSentMsg(g){var m,S;const v=this.getCurrentDCSessionEvent();v&&((m=v.sentMessages)[S=g.type]??(m[S]=0),v.sentMessages[g.type]++)}logReceivedMsg(g){var m,S;this.lastEventConnecting=!1;const v=this.getCurrentDCSessionEvent();v&&((m=v.recvMessages)[S=g.type]??(m[S]=0),v.recvMessages[g.type]++,"dsh"!==g.type||v.handshakeDuration||(v.cachedDshReceived=!0))}logHandshakeStarted(g){const m=this.getCurrentDCSessionEvent();m&&(m.handshakeStartedTs=Date.now()),this.storage.clientCapabilities=g}logHandshakeCompleted(g){const m=this.getCurrentDCSessionEvent();m&&(m.handshakeDuration||(m.handshakeDuration=duration(m.handshakeStartedTs)),m.mpCapabilities.send=g.send_capabilities,m.mpCapabilities.recv=g.receive_capabilities)}logSentFailed(g){const m=this.getCurrentDCSessionEvent();m&&(m.sentFailed++,m.lastSentFailed={ts:duration(this.storage.createTime),error:g})}logRecvFailed(g){const m=this.getCurrentDCSessionEvent();m&&(m.recvFailed++,m.lastRecvFailed={ts:duration(this.storage.createTime),error:g})}logTimeout(){if(this.storage.startedCount>=cr&&!this.lastEventConnecting)return;const g={timeoutTs:Date.now()},m=this.getCurrentDCSessionEvent();m&&(g.handshakeStartedTs=m.handshakeStartedTs),this.lastEventConnecting&&this.storage.events.pop(),this.storage.events.push(g),this.lastEventConnecting=!1}getReport(){const g=this.sourceRequestSenderDiagnostics.getObjectRef();return this.storage.sourceRequestsReport=g,this.storage}getCurrentDCSessionEvent(){const g=this.storage.events[this.storage.events.length-1];return this.storage.startedCount<=cr&&void 0!==g?.startedTs?g:null}};function duration(g){return Date.now()-g}var hr=4294967292,ur=class extends Ge{constructor(g,m,S){super(),this.dcAdapter=g,this.logger=m,this.mcpConfig=S,this.dcSend=null,this.handshakePromise=new or,this.isStarted=!1,this.isActive=!1,this.handshakeTimeout=null,this.telemetryLogger=new dr(this.mcpConfig),this.mcpSupportedFeautres={sourceRequestsEnabled:!1,sourceRequestsResponseEnabled:!1,sendDuplicates:this.mcpConfig?.sendDuplicates}}getTelemetryLogger(){return this.telemetryLogger}mcpFeaturesSupported(g){return this.mcpSupportedFeautres[g]}switchMcpFeauture(g,m){this.logger.warn(`Switching ${g} to ${m}`),this.mcpSupportedFeautres[g]=m}getConfig(){return this.mcpConfig}dispose(){super.dispose(),this.isStarted&&this.dcAdapter.removeHandler(18),this.handshakePromise.promise.catch((()=>{})),this.handshakePromise.reject("MediaControlPlane disposed"),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1),this.dcSend=null}getTelemetryReport(){return this.logger.debug(`Telemetry ${JSON.stringify(this.telemetryLogger.getReport())}`),this.telemetryLogger.getReport()}async sendMsg(g){return await this.handshakePromise.promise,this.sendMsgInternal(g)}start(){if(this.isStarted||!this.mcpConfig)return;this.isStarted=!0;const g={onStarted:async(g,m)=>{this.logger.info(`Data channel handler is started ${g}`),this.telemetryLogger.logStarted(),this.dcSend=m,await this.startHandshake()},onStopped:async g=>{this.logger.info(`Data channel handler is stopped ${g}`),this.telemetryLogger.logStopped(),this.dcSend=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1)},onDataReceived:async(g,m)=>{this.processIncomingData(m)}};this.dcAdapter.addHandler(18,g)}onTransportConnected(){this.isStarted&&this.mcpConfig.handshakeTimeout&&!this.isActive&&(this.handshakeTimeout&&clearTimeout(this.handshakeTimeout),this.handshakeTimeout=window.setTimeout((()=>{this.handshakeTimeout=null,this.telemetryLogger.logTimeout(),this.logger.warn(`Timeout after ${this.mcpConfig.handshakeTimeout}ms, raising onHandshakeTimeout`),this.event("onHandshakeTimeout").raise()}),this.mcpConfig.handshakeTimeout))}async startHandshake(){this.handshakePromise.isPending||(this.handshakePromise=new or),this.isActive=!1;try{const g=[];this.mcpConfig.enableDominantSpeakerHistory&&g.push("dsh"),this.mcpConfig.enableBweNotifications&&g.push("bwe"),this.mcpConfig.enableSourceRequests&&g.push("sr"),this.telemetryLogger.logHandshakeStarted(g),this.logger.info(`Send syn, client capabilities: ${JSON.stringify(g)}`),await this.sendMsgInternal({type:"syn",client_capabilities:g})}catch(g){this.handshakePromise.reject(g)}}async sendMsgInternal(g){const m=Array.isArray(g)?g:[g],S=(new TextEncoder).encode(JSON.stringify(m)),v=new Uint8Array(1+S.length);v[0]=1,v.set(S,1);try{await this.dcSend(v,[hr]);for(const g of m)this.telemetryLogger.logSentMsg(g)}catch(g){throw this.logger.error(`Send failed: ${stringifyObject(g)}`),this.telemetryLogger.logSentFailed(stringifyObject(g)),g}}processIncomingData(g){if(1!==g[0]){const m=`Unsupported header version ${g[0]}`;return this.logger.info(m),void this.telemetryLogger.logRecvFailed(m)}const m=new DataView(g.buffer,1);let S;try{const g=(new TextDecoder).decode(m);S=JSON.parse(g)}catch(g){return this.logger.error(`Failed to parse received data, error ${stringifyObject(g)}`),void this.telemetryLogger.logRecvFailed(stringifyObject(g))}for(const g of S)switch(this.telemetryLogger.logReceivedMsg(g),g.type){case"syn":break;case"ack":this.processAckMsg(g);break;case"bwe":this.processBweMsg(g);break;case"dsh":this.processDshMsg(g);break;case"sr_res":this.processSrResMsg(g);break;default:{const m=`Unsupported msg type ${g.type}`;this.logger.error(m),this.telemetryLogger.logRecvFailed(m)}}}processDshMsg(g){this.mcpConfig.enableDominantSpeakerHistory&&(this.logger.debug(`DSH received: ${JSON.stringify(g)}`),this.event("mpDshChanged").raise(g.history))}processSrResMsg(g){this.mcpConfig.enableSourceRequests&&(this.logger.debug(`SR_RES received: ${JSON.stringify(g)}`),this.event("mpSrResReceived").raise(g.sequenceNumber,g.result))}processBweMsg(g){this.mcpConfig.enableBweNotifications&&this.event("mpSendBandwidthChanged").raise(g.bw)}processAckMsg(g){this.telemetryLogger.logHandshakeCompleted(g),this.logger.info(`Ack received: ${JSON.stringify(g)}`);const m=!(!this.mcpConfig.enableDominantSpeakerHistory||!g.send_capabilities?.includes("dsh"));this.switchMcpFeauture("sourceRequestsEnabled",!(!this.mcpConfig.enableSourceRequests||!g.receive_capabilities?.includes("sr"))),this.switchMcpFeauture("sourceRequestsResponseEnabled",!(!this.mcpConfig.enableSourceRequests||!g.send_capabilities?.includes("sr_res"))),this.logger.info(`raising mpDshStatusChanged ${m}`),this.event("mpDshStatusChanged").raise(m),this.handshakePromise.resolve(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!0}},gr={NEGOTIATION_COMPLETED:"NegotiationCompleted",INITIAL:{OFFER_GENERATION_STARTED:"InitialOfferGenerationStarted",OFFER_GENERATION_ENDED:"InitialOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"InitialAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"InitialAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"InitialOfferProcessingStarted",OFFER_PROCESSING_ENDED:"InitialOfferProcessingEnded",ANSWER_GENERATION_STARTED:"InitialAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"InitialAnswerGenerationEnded"},RENEGOTIATION:{OFFER_GENERATION_STARTED:"RenegotiationOfferGenerationStarted",OFFER_GENERATION_ENDED:"RenegotiationOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"RenegotiationAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"RenegotiationAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"RenegotiationOfferProcessingStarted",OFFER_PROCESSING_ENDED:"RenegotiationOfferProcessingEnded",ANSWER_GENERATION_STARTED:"RenegotiationAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"RenegotiationAnswerGenerationEnded"}},pr=class{constructor(g,m,S){this.mediaSession=g,this.signalingSession=m,this.sourceRequestSender=S,this.operationNames=gr.INITIAL,this.configureModalitiesAsync=this.mediaSession.configureModalitiesAsync.bind(this.mediaSession),this.getAllowedModalities=this.mediaSession.getAllowedModalities.bind(this.mediaSession),this.rejectNegotiationAsync=this.mediaSession.rejectNegotiationAsync.bind(this.mediaSession),this.createRemoteRenderer=this.mediaSession.createRemoteRenderer.bind(this.mediaSession),this.getStatsAsync=this.mediaSession.getStatsAsync.bind(this.mediaSession),this.getLastKnownStats=this.mediaSession.getLastKnownStats.bind(this.mediaSession),this.getCallTechnicalInfo=this.mediaSession.getCallTechnicalInfo.bind(this.mediaSession),this.muteHold=this.mediaSession.muteHold.bind(this.mediaSession),this.muteInputAsync=this.mediaSession.muteInputAsync.bind(this.mediaSession),this.unmuteInputAsync=this.mediaSession.unmuteInputAsync.bind(this.mediaSession),this.muteOutputAsync=this.mediaSession.muteOutputAsync.bind(this.mediaSession),this.unmuteOutputAsync=this.mediaSession.unmuteOutputAsync.bind(this.mediaSession),this.terminate=this.mediaSession.terminate.bind(this.mediaSession),this.createAudioElement=this.mediaSession.createAudioElement.bind(this.mediaSession),this.getSessionConfig=this.mediaSession.getSessionConfig.bind(this.mediaSession),this.getDiagnostics=this.mediaSession.getDiagnostics.bind(this.mediaSession),this.getIncomingRawAudioStream=this.mediaSession.getIncomingRawAudioStream.bind(this.mediaSession),this.getUnmixedAudioProvider=this.mediaSession.getUnmixedAudioProvider.bind(this.mediaSession),this.useNullAudioStreamClient=this.mediaSession.useNullAudioStreamClient.bind(this.mediaSession),this.getSubscriptionManager=this.mediaSession.getSubscriptionManager.bind(this.mediaSession),this.configureSpatialAudio=this.mediaSession.configureSpatialAudio.bind(this.mediaSession),this.setParticipantSpatialAudioPositions=this.mediaSession.setParticipantSpatialAudioPositions.bind(this.mediaSession),this.setCallConstraints=this.mediaSession.setCallConstraints.bind(this.mediaSession),this.startMediaDescriptionsUpdateAsync=this.mediaSession.startMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.completeMediaDescriptionsUpdateAsync=this.mediaSession.completeMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.rejectMediaDescriptionsUpdateAsync=this.mediaSession.rejectMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.getExtensionsManager()?.configureExtension("videoStreamControl",{sender:this.sourceRequestSender})}enableTeamsRealTimeTelemetry(){this.mediaSession.enableTeamsRealTimeTelemetry()}getMediaStatsReport(){return this.mediaSession.getMediaStatsReport()}processOfferAsync(g,m){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_STARTED),this.mediaSession.processOfferAsync(g,m).then((g=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_ENDED),g)))}createAnswerAsync(g,m){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_STARTED),this.mediaSession.createAnswerAsync(g,m).then((m=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_ENDED),g||(this.operationNames=gr.RENEGOTIATION),m)))}createOfferAsync(g){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_STARTED),this.mediaSession.createOfferAsync(g).then((g=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_ENDED),g)))}processAnswerAsync(g,m,S,v=!1){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_STARTED),this.mediaSession.processAnswerAsync(g,m,S,v).then((()=>{this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_ENDED),this.operationNames=gr.RENEGOTIATION}))}completeNegotiationAsync(g){return this.mediaSession.completeNegotiationAsync(g).then((g=>(this.signalingSession.setOfferAnswerGenerationTimestamps(gr.NEGOTIATION_COMPLETED),g)))}sendDtmf(g){return this.mediaSession.sendDtmf?this.mediaSession.sendDtmf(g):Promise.reject("Not Implemented")}getExtensionsManager(){return this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null}reconnectAsync(g,m=!1){return this.mediaSession.reconnectAsync(g,m)}completeEscalationAsync(g){return this.mediaSession.completeEscalationAsync(g)}rejectEscalationAsync(g,m){return this.mediaSession.rejectEscalationAsync(g,m)}getAcceptedTypes(){return this.mediaSession.getAcceptedTypes()}getLocalMediaTrackId(g){return this.mediaSession.getLocalMediaTrackId?this.mediaSession.getLocalMediaTrackId(g):null}processNotification(g,m){this.mediaSession.processNotification(g,m)}};function handleServerMutedVersion(g,m,S){if(void 0===m?.serverMuteVersion||void 0===S?.serverMuteVersion||S.serverMuteVersion>=m.serverMuteVersion)return;const v=S&&S.mediaStreams,C=v&&v.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type)),_=m&&m.mediaStreams,E=_&&_.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type));C&&C.length&&(S.serverMuteVersion=m.serverMuteVersion,C[0].serverMuted=E[0].serverMuted,g.info(`handleServerMutedVersion: patching server muted state in audio streams updated:${JSON.stringify(C[0])} as we encountered stale muteServerVersion. Updated to ${m.serverMuteVersion}`))}function handleMuteUnmuteParticipantInfo(g,m,S,v){if("success"!==S.reason||void 0===m||S.serverMuteVersion<=m.serverMuteVersion)return g.info(`handleMuteUnmuteParticipantInfo: ignoring updating since we encountered invalid state: ${S.reason} serverMuteVersion: ${S.serverMuteVersion}`),!1;const C=m&&m.mediaStreams,_=C&&C.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type));return!!_&&(_[0].serverMuted=v,m.serverMuteVersion=S.serverMuteVersion,g.info(`handleMuteUnmuteParticipantInfo: updating since we encountered valid state serverMuteVersion: ${S.serverMuteVersion} to: ${v} streams: ${_[0].sourceId}`),!0)}var mr=R;function scrub(g,m,S,v){const C=JSON.stringify(g),_=JSON.parse(C);return _&&(scrubOneTypeOfParams(g,_,m,mr.pii.Omit),scrubOneTypeOfParams(g,_,S,mr.pii.Mri),scrubOneTypeOfParams(g,_,v,mr.pii.UserName)),JSON.stringify(_)}function scrubOneTypeOfParams(g,m,S,v){S?.forEach((S=>{g[S]&&(m[S]=v(g[S]))}))}function scrubSignalingParticipant(g){return`id=${mr.pii.Mri(g.id)}, participantId=${g.participantId}`}function scrubITransferContext(g){return scrub(g,[],["transferorMri","targetMri"])}var fr=P,Sr=S.setImmediate?g=>{S.setImmediate(g)}:g=>{(0,fr.defer)(g)},vr=class _DeferHandler{constructor(){this.deferredOperations=new Map,this.deferredOperationsNames=[],this.isRunning=!1}setLogger(g){this._logger=g.createChild("[DeferHandler]")}setDeferToQueueMicrotask(g){g&&S.queueMicrotask?_DeferHandler.defer=g=>S.queueMicrotask(g):_DeferHandler.defer=Sr}createDeferRunner(g){const m={};return S=>this.runDeferred(m,S,g)}runDeferredWithoutDedup(g,m){const S={};this.runDeferred(S,g,m)}runDeferred(g,m,S){this.deferredOperations.has(g)||(this.deferredOperations.set(g,m),S&&this.deferredOperationsNames.push(" "+S),this.isRunning||(this.isRunning=!0,this._startDeferalTime=Date.now(),this.causeId=generateCauseId(),this._logger?.info(`[${this.causeId}]Deferring operations`),_DeferHandler.defer((()=>{this._timeToRun=Date.now()-this._startDeferalTime,this.deferredOperations.forEach((g=>{_DeferHandler.runWithTryCatch(g)})),this.deferredOperations.clear(),this.isRunning=!1,this._logger?.info(`[${this.causeId}]Deferred operations ran after ${this._timeToRun}ms | Completed after ${Date.now()-this._startDeferalTime}ms | Operations:${this.deferredOperationsNames}`),this.deferredOperationsNames=[]}))))}static runWithTryCatch(g){try{g&&g()}catch(g){}}};vr.defer=Sr;var Cr=vr,_r=class{};_r.instance=new Cr;var yr=P,Er={send:"sendonly",receive:"recvonly",sendReceive:"sendrecv"},Tr={audio:"audio",video:"video",sharing:"applicationsharing-video",audioteleconference:"audio-teleconferencing"},Ir=class extends Ge{constructor(g,m,S){super(m),this.mediaSession=g,this.isAvailable=!1,this.mediaSessionInitPromise=new or,this.currentIsStreaming=!1,g&&this.mediaSessionInitPromise.resolve(),this.id=S,this.logger=m.createChild(`Stream[${this.id}]`)}set isStreaming(g){this.currentIsStreaming=g,this.logger.info(`isStreaming has changed to ${this.currentIsStreaming}`),this.raiseChanged()}get isStreaming(){return this.currentIsStreaming}update({sourceId:g=null,direction:m=Er.receive,participantId:S=null,endpointId:v=null}={},C){this.logger.info(`[${C}][update before]  sourceId=${g}, direction=${m}, participantId=${S}, endpointId=${truncate(v)}`),this.id=g,this.isAvailable=m===Er.sendReceive||m===Er.send,this.mediaSession?.getSessionConfig().config.streamAvailabilityConsiderModalities&&this.getIsModalityDisabled()&&(this.logger.info(`Disabling current modality, disabled: ${JSON.stringify(this.mediaSession?.getDisabledModalities?.()||"")}`),this.isAvailable=!1),this.participantId=S,this.endpointId=v,this.logger.info(`[${C}][update after]  sourceId=${g}, direction=${m}, participantId=${S}, endpointId=${truncate(v)}`),this.raiseChanged()}setMediaSession(g,m){const S=g?.getAllowedModalities?.()||{};this.logger.info(`[${m}][setMediaSession] ${JSON.stringify(S)}`),this.mediaSession=g,g?this.mediaSessionInitPromise.resolve():this.mediaSessionInitPromise.reject(new Error("MediaSession is null"))}isActive(){return this.isAvailable&&this.isStreaming}getIsModalityDisabled(){return!1}},br=class extends Ir{},Ar=P,Rr=class extends Ir{constructor(g,m,S,v,C,_){super(void 0,g,m),this.configProvider=S,this.streamOptions=v,this.telemetryLogger=C,this.callInfo=_,this.type=2,this.finalTelemetrySent=!1,this.player=new Rt(g.createChild("UmsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger),this.isAvailable=!0}getStreamOptions(){return this.streamOptions}getDiagnosticData(){return JSON.stringify({id:this.id,type:this.type,rank:this.rank,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const g=this.player.getSnapshotTelemetryReport(),m={isAvailable:this.isAvailable,isStreaming:this.isStreaming,...g};return(0,Ar.isEqual)(this.lastStreamStats,m)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=m),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,rank:this.rank,...this.lastStreamStats}}stop(){return Promise.resolve(void 0)}async start(g){if(this.logger.info("[start]: Starting UMS stream"),!this.renderer){await this.player.configure(this.streamOptions);if(!(await this.player.loadPlayer(g)).setupSucceeded)return this.player.stop(),this.logger.error("[start]: Failed to load UMS player"),Promise.reject("Failed to load UMS player");this.renderer=this.player.getRenderer()}return this.isStreaming=!0,this.renderer}sendSnapshotTelemetry(){const g=this.player.getSnapshotTelemetryReport();this.logger.debug(`[sendSnapshotTelemetry] sending snapshot telemetry report: ${JSON.stringify(g)}`);const m={...this.callInfo,...g};this.telemetryLogger.sendEvent({eventName:"live_events",props:m})}sendTelemetry(g){if(this.finalTelemetrySent)return;g&&(this.finalTelemetrySent=!0);const m=this.player.getTelemetryReport();this.logger.debug(`[sendTelemetry] sending telemetry report: ${JSON.stringify(m)}`);const S={...this.callInfo,...m};this.telemetryLogger.sendEvent({eventName:"live_events",props:S})}};function toMediaAgentScalingMode(g){switch(g){case 1:return"crop";case 0:return"stretch";default:return"fit"}}var Pr=class extends Ge{constructor(){super(...arguments),this.isRendering=!1,this.frameType=-1}get rendererType(){return 0}captureFrame(){if(this.renderer.captureFrame)return this.renderer.captureFrame();throw new Error("Not implemented yet")}async getStats(){if(this.renderer.getStats)return this.renderer.getStats();throw new Error("Renderer does not support stats")}async setScalingMode(g){this.renderer.setScalingMode(toMediaAgentScalingMode(g))}async cameraAutoControl(g){throw new Error("Not implemented")}async getCameraManualControlStates(g){throw new Error("Not implemented")}async setCameraManualControlStates(g){throw new Error("Not implemented")}async enumerateCameraManualControls(){throw new Error("Not implemented")}onVideoSizeChanged(g,m){this.streamSize={width:g,height:m},this.event("videoSizeChanged").raise(g,m),this.raiseChanged()}},Mr=class extends Pr{constructor(g,m){super(),this.renderer=m.createPreviewRenderer(g),this.renderer.on("onVideoSizeChanged",((g,m)=>this.onVideoSizeChanged(g,m)))}onVideoSizeChanged(g,m){this.isRendering=g>0&&m>0,super.onVideoSizeChanged(g,m)}setVideoMirroring(g){this.renderer.setVideoMirroring(g)}startVideoAsync(){return this.renderer.startVideoAsync()}dispose(){this.renderer&&(this.renderer.dispose(),this.renderer=null)}},wr=class extends Pr{constructor(g,m,S,v,C){super(),this.logger=g,this.target=m,this.rendererStats=v,this.configProvider=C,this.subscriptionActive=!1,this.firstFrameRendered=!1,this.rendererId=v.newRendererId(),this.renderer=S.createRemoteRenderer(m),this.renderer.on("onVideoSizeChanged",((g,m)=>this.onVideoSizeChanged(g,m))),this.renderer.on("onVideoStateChanged",(g=>this.onVideoStateChanged(g))),this.renderer.on("onIsRenderingChanged",(g=>this.onIsRenderingChanged(g)))}toString(){return`rvr:${this.rendererId}`}onVideoStateChanged(g){this.rendererStats.streamStateChanged(g.stream)}onVideoSizeChanged(g,m){this.configProvider.config.videoIsRenderingCheck&&this.setIsRendering(g>0&&m>0),super.onVideoSizeChanged(g,m)}setIsRendering(g){this.isRendering!==g&&(this.isRendering=g,this.logger.info(`isRendering has changed to ${this.isRendering}`),this.rendererStats.event(this.isRendering?5:6,this.rendererId),this.isRendering&&!this.firstFrameRendered&&(this.firstFrameRendered=!0,this.event("firstFrameRendered").raise()))}onIsRenderingChanged(g){this.setIsRendering(g),this.raiseChanged()}subscribeVideoAsync(g){this.currentVideoStream=g,this.rendererStats.event(1,this.rendererId,g.id);const m=this.renderer.subscribeVideoAsync(g.id,1===g.type);return this.subscriptionActive=!0,m.then((()=>{this.rendererStats.event(2,this.rendererId,g.id),this.watchStream(g)})),m}watchStream(g){this.changeSub&&this.changeSub.dispose(),this.changeSub=g.changed((()=>{g.isAvailable?this.subscriptionActive||this.subscribeVideoAsync(g):(this.subscriptionActive=!1,this.rendererStats.event(3,this.rendererId),this.renderer.unsubscribeNow(),this.rendererStats.event(4,this.rendererId))}))}dispose(){this.renderer&&(this.subscriptionActive&&(this.rendererStats.event(3,this.rendererId),this.currentVideoStream&&!this.currentVideoStream.isAvailable&&this.renderer.unsubscribeNow()),this.renderer.dispose(),this.subscriptionActive&&this.rendererStats.event(4,this.rendererId),this.renderer=null,this.currentVideoStream=null),this.changeSub&&(this.changeSub.dispose(),this.changeSub=null)}},Dr=class extends Ge{constructor(g,m,S,v=generateCauseId()){super(S),this.getRawStream=g,this.disposeStream=m,this.logger=S,this.causeId=v,this.isClientDisposed=!1,this.clientId=uniqueId()}get isDisposed(){return this.isClientDisposed}notifyStreamChange(){this.logger.info(`Raw stream changed, causeId=${this.causeId}`),this.raiseChanged(),this.event("notifiedOnStreamChanged").raise(this.clientId)}async getMediaStream(){return this.checkDisposed(),this.logger.info(`Raw stream requested, causeId=${this.causeId}`),this.event("rawStreamRequested").raise(this.clientId),this.getRawStream()}dispose(){this.checkDisposed(),this.disposeStream?.(),this.isClientDisposed=!0,this.event("clientDisposed").raise(this.clientId),super.dispose(),this.logger.info(`Raw stream client disposed, causeId=${this.causeId}`)}checkDisposed(){if(this.isClientDisposed)throw new Error("Raw stream client is already disposed")}},Or=class{constructor(g,m,S){this.stream=g,this.rawBaseClient=new Dr((async()=>this.stream),(()=>this.dispose()),m,S)}client(){return this.rawBaseClient}updateAndNotifyClient(g){this.rawBaseClient&&(this.stream=g,this.rawBaseClient.notifyStreamChange())}dispose(){this.rawBaseClient=null,this.stream=null}},Nr=class{constructor(g,m,S,v){this.videoStream=g,this.subscriptionManager=m,this.logger=S,this.causeId=v,this.modality=0===g.type?Ke.MODALITY.video:Ke.MODALITY.sharing,this.subscriptionClient=m.subscribeVideo(this.modality,g.mediaSourceId),this.rawBaseClient=new Dr((async()=>this.subscriptionClient?.subscribedStream),(()=>this.unsubscribeVideo()),S,v),this.setClientSubscription(),this.videoStream.changed((()=>{this.rawBaseClient?.isDisposed||(g.isAvailable?this.updateSubscription():this.unsubscribeVideo())}))}client(){return this.rawBaseClient}updateSubscription(){this.rawBaseClient?.isDisposed?this.logger.error(`updateSubscription skipped, raw stream client disposed: stream already exists, causeId=${this.causeId}`):(this.logger.info(`update subcription: Created new subscription, causeId=${this.causeId}`),this.subscriptionClient=this.subscriptionManager.subscribeVideo(this.modality,this.videoStream.mediaSourceId),this.setClientSubscription())}unsubscribeVideo(){this.logger.info(`Disposing subcription, causeId=${this.causeId}`),this.subscriptionClient?.unsubscribe(),this.subscriptionClient?.dispose(),this.subscriptionClient=null}setClientSubscription(){this.logger.info(`setting onMediaStreamChanged callback, causeId=${this.causeId}`),this.subscriptionClient.setOnMediaStreamChangedHandler((()=>this.rawBaseClient?.notifyStreamChange()))}},kr=class{constructor(){this.handlerMap=new Map}dispose(){this.handlerMap.forEach((g=>g.client().dispose())),this.handlerMap.clear()}handlerAdded(g){const m=g.client();m.on("clientDisposed",(()=>this.deleteRawStreamManagerById(m.clientId))),this.handlerMap.set(m.clientId,g)}deleteRawStreamManagerById(g){this.handlerMap.delete(g)}},Lr=class extends kr{constructor(g){super(),this.logger=g}streamChanged(g){this.handlerMap.forEach((m=>m.updateAndNotifyClient(g)))}createIRawStreamClient(g){const m=new Or(g,this.logger);super.handlerAdded(m);return m.client()}updateHandlers(g){g.forEach(((g,m)=>{this.handlerMap.has(m)||this.handlerMap.set(m,g)}))}},Fr=class extends kr{constructor(g){super(),this.logger=g}createIRawStreamClient(g,m){const S=new Nr(g,m,this.logger);super.handlerAdded(S);return S.client()}},xr=P,Ur=class extends Ir{constructor(g,m,S,v){super(g,S,v),this.rendererStats=m,this.rawIncomingVideoStreamManager=new Fr(this.logger.createChild("rawVideoStream")),this.type=0}get mediaSourceId(){return this.id}getDiagnosticData(){return JSON.stringify({id:this.id,msi:this.mediaSourceId,rank:this.rank,type:this.type,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const g={isAvailable:this.isAvailable,isStreaming:this.isStreaming};return(0,xr.isEqual)(this.lastStreamStats,g)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=g),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,msi:this.mediaSourceId,rank:this.rank,...this.lastStreamStats}}stop(){return this.mediaSessionInitPromise.reject(new Error("Video stream stopped")),Promise.resolve(void 0)}getRawStream(g){this.logger.info(`[${g}] - IRawStream for incoming video stream requested`);return this.rawIncomingVideoStreamManager.createIRawStreamClient(this,this.mediaSession.getSubscriptionManager())}start(g,m){return this.logger.info(`video start: target=${g}, options=${JSON.stringify(m)}`),this.mediaSessionInitPromise.promise.then((()=>new wr(this.logger.createChild("RemoteVideoRenderer"),g,this.mediaSession,this.rendererStats,this.mediaSession?.getSessionConfig()))).then((g=>(m&&g.setScalingMode(m.scalingMode),this.logger.info(`subscribeVideoAsync: videoRenderer=${g}, id=${this.id}`),g.subscribeVideoAsync(this).catch((m=>{throw g.dispose(),m})).then((()=>(this.isStreaming=!0,g))))))}update(g,m){this.logger.info(`[${m}][update] stream=${JSON.stringify(g)}`);const S=this.isAvailable;super.update(g,m),this.isAvailable&&this.isAvailable!==S&&this.rendererStats.event(0)}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().video}},Vr=class extends Ur{constructor(g,m,S,v){super(g,m,S,v),this.type=1}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().sharing}},Br=1,Hr=2,$r=3,Gr=class _PluginlessCallStreamManager extends Ge{constructor(g,m,S,v){super(),this.participantId=g,this.mediaSession=m,this.localStats=S,this.audioSourceIds=[],this.streams={},this.lastUmsStreamId=1;const C=S.receive(1,g),_=S.receive(2,g);this.audio=new br(m,v,Br);const E=new Ur(m,C,v,Hr),T=new Vr(m,_,v,$r),I=this.mediaSession?.getSessionConfig()?.config.participantStreamInitialSubscriptions;I&&(E.changed((()=>this.event("streamChanged").raise())),T.changed((()=>this.event("streamChanged").raise()))),this.streams[0]=[E],this.streams[1]=[T],this.streams[2]=[],this.logger=v.createChild("PluginlessCallStreamManager")}setMediaSession(g,m){this.logger.info(`[${m}][setMediaSession]`),this.mediaSession=g;[[this.audio],this.streams[0],this.streams[1]].forEach((S=>S.forEach((S=>S.setMediaSession(g,m)))))}updateStreams(g,m){this.logger.info(`[${m}][updateStreams]`);const filterAndSortStreams=m=>g.filter((g=>g.type===m)).sort(_PluginlessCallStreamManager.compareStreams);let S=filterAndSortStreams(Tr.audio);0===S.length&&(S=filterAndSortStreams(Tr.audioteleconference)),S.length>0&&(this.audioSourceIds=S.map((g=>g.sourceId)));const v=S[0];v&&this.audio.update(v,m),this.updateMediaStreams(filterAndSortStreams(Tr.video),0,m),this.updateMediaStreams(filterAndSortStreams(Tr.sharing),1,m)}hasAudioSource(g){return this.audioSourceIds.some((m=>m===g))||this.audio.id===g}useUmsStream(g,m,S,v,C,_){this.logger.info(`[${_}][useUmsStream] Updating ums streams`);const E=this.getUmsInformation(g,v),T=this.streams[2],I=T.filter((g=>!E.some((m=>_PluginlessCallStreamManager.compareUmsStreams(g,m)))));I.forEach((g=>(0,yr.remove)(T,g))),I.length&&this.logger.info(`[${_}][useUmsStream] Removing ${I.length} ums streams`),E.forEach((g=>{let v=T.find((m=>_PluginlessCallStreamManager.compareUmsStreams(m,g)));v||(v=new Rr(this.logger.createChild("UmsStream"),this.lastUmsStreamId++,m,g,C,S),this.logger.info(`[${_}][useUmsStream] Adding ums stream with metadata: ${JSON.stringify(g)}`),T.push(v))}))}getUmsStreamMetadata(g,m){let S=null,v=null;if(S=g.find((function(g){return"MiddleLaneUltraLowLatency"===g.deliveryPipelineType&&m===g.isPrimary})),S){const g=S.urls;if(g&&g.length>0){S.identifier||this.logger.warn(`[getUmsStreamMetadata]: no ums stream identifier found, isPrimary: ${m}`);const C=S.decryptionKey?.id,_=S.decryptionKey?.value;C&&_||this.logger.warn(`[getUmsStreamMetadata]: no valid ums stream decryption key found, isPrimary: ${m}`);const E=S.deliveryPipelineType||void 0;v={url:g[0],streamDeliveryPipeline:E,decryptionKey:C&&_?{id:C,value:_}:null}}else this.logger.info(`[getUmsStreamMetadata]: no ums URLs found, isPrimary: ${m}`)}else this.logger.info(`[getUmsStreamMetadata]: no ums stream information found, isPrimary: ${m}`);return v}getUmsInformation(g,m){const S=[];let v=null,C=null;for(const m in g){const S=g[m].streams;if(S){if(v)this.logger.info(`[getUmsInformation]: primary ums stream already found, skipping finding primary stream for participant: ${m}`);else{const g=this.getUmsStreamMetadata(S,!0);g?v=g:this.logger.info(`[getUmsInformation]: no primary ums stream found for participant: ${m}`)}if(C)this.logger.info(`[getUmsInformation]: alternate ums stream already found, skipping finding alternate stream for participant: ${m}`);else{const g=this.getUmsStreamMetadata(S,!1);g?C=g:this.logger.info(`[getUmsInformation]: no alternate ums stream found for participant: ${m}`)}}else this.logger.warn(`[getUmsInformation]: no stream information found for participant: ${m}`)}return(v||C)&&S.push({stream:v,altStream:C,threadId:m}),S}static compareStreams(g,m){const S="sendonly"===g.direction||"sendrecv"===g.direction,v="sendonly"===m.direction||"sendrecv"===m.direction;return S&&!v?-1:v&&!S?1:m.sourceId-g.sourceId}static compareUmsStreams(g,m){const S=g.getStreamOptions();return _PluginlessCallStreamManager.compareUmsStreamMetadata(S.stream,m.stream)&&_PluginlessCallStreamManager.compareUmsStreamMetadata(S.altStream,m.altStream)}static compareUmsStreamMetadata(g,m){return!g&&!m||!(!g&&m||g&&!m)&&(g.decryptionKey.id===m.decryptionKey.id&&g.decryptionKey.value===m.decryptionKey.value&&g.url===m.url)}updateMediaStreams(g,m,S){const v=this.streams[m],C=v.filter((m=>!g.some((g=>g.sourceId===m.id))));C.forEach((g=>(0,yr.remove)(v,g))),C.length&&this.logger.info(`[${S}][updateMediaStreams] Removing ${C.length} streams of type ${m}`),g.forEach(((C,_)=>{let E=v.find((g=>g.id===C.sourceId));E||(0===m?E=new Ur(this.mediaSession,this.localStats.receive(1,this.participantId),this.logger,C.sourceId):1===m&&(E=new Vr(this.mediaSession,this.localStats.receive(2,this.participantId),this.logger,C.sourceId)),this.logger.info(`[${S}][updateMediaStreams] Adding stream ${C.sourceId} of type ${m}`),v.push(E),E.changed((()=>this.event("streamChanged").raise()))),E.update(C,S),E.rank=g.length-_}))}},jr={0:[1],1:[2,6,3,4,5,7,8],2:[6,3,4,8],3:[1,4,5,8],7:[3,4,8],4:[],5:[3,4,8],6:[3,4],8:[3,5,4]},qr={0:"Disconnected",1:"Connecting",2:"Ringing",3:"Connected",5:"Connected",4:"Disconnected",7:"Connecting"},Wr=class extends Ge{constructor(g,m,S,v,C,_=generateCauseId(),E=[]){super(S),this.mri=g,this.callTelemetry=C,this.cachedMediaStreams=E,this.state=0,this.voiceLevel=0,this.isServerMuted=!1,this.endpointType="default",this.balanceUpdates={},this._raiseChangeDeferRunner=_r.instance.createDeferRunner("CallParticipant.RaiseChange"),this.filteredParticipantEndpointDetails={},this.recordTelemetryForStateChange=(g,m,S,v)=>{if(v){const v="_SetParticipantStateInvalid",C={state:m,reason:S,endpoints:[]};this.endpoints?.endpointDetails?.length&&(C.endpoints=getEndpointInformationForTelemetry(this.endpoints.endpointDetails)),this.callTelemetry.recordEvent(v,C,g)}},this.checkIfIncomingServerMutedIsUpdated=g=>{g.endpointDetails.forEach((g=>{const m=this.filteredParticipantEndpointDetails[g.participantId];void 0!==m&&handleServerMutedVersion(this.logger,m,g)}))},this.handleServerMutedInfoUpdate=g=>{let m=!1;for(const S of g){const g=this.filteredParticipantEndpointDetails[S.participantId];handleMuteUnmuteParticipantInfo(this.logger,g,S,!0)&&(m=!0)}m&&this.updateIsServerMuted()},this.id=this.mri,this.logger=S.createChild((()=>`ICallParticipant[${scrubMriOrOmit(this.id)}][${this.state}]`)),this.logger.info(`[${_}]created`),this.streamManager=new Gr(this.id,m,v,this.logger),this.streamManager.on("streamChanged",(()=>this.raiseChanged()))}get audio(){return this.streamManager.audio}get streams(){return this.streamManager.streams}getDiagnosticData(){return JSON.stringify({id:scrubMriOrOmit(this.id),state:this.state,isServerMuted:this.isServerMuted})}isSameParticipantsMri(g){return this.id===g}setMediaSession(g,m=generateCauseId()){this.streamManager.setMediaSession(g,m)}applyCachedMediaStreams(g=generateCauseId()){const m=this.logger.createFnLogger("applyCachedMediaStreams",g);this.cachedMediaStreams?.length?(m.info("applying cachedMediaStreams"),this.updateStreams(this.cachedMediaStreams,g,!1)):m.info("cachedMediaStreams is empty")}updateStreams(g,m=generateCauseId(),S=!1){this.logger.createFnLogger("updateStreams",m).info(`isStreamingMode=${S} mediaStreams=${safeJsonStringify(g)}`),g?.length&&(this.cachedMediaStreams=g),S||(this.streamManager.updateStreams(g,m),this.raiseChangedDeferred())}hasAudioSource(g){return this.streamManager.hasAudioSource(g)}raiseChangedDeferred(){this._raiseChangeDeferRunner((()=>this.raiseChanged()))}updateIsServerMuted(){if(!Object.values(this.filteredParticipantEndpointDetails).length)return void this._updateIsServerMuted(!1);let g=!1;Object.values(this.filteredParticipantEndpointDetails).forEach((m=>{const filterAndSortStreams=g=>m.mediaStreams?.filter((m=>m.type===g)).sort(Gr.compareStreams);let S=filterAndSortStreams(Tr.audio)?.[0];S||(S=filterAndSortStreams(Tr.audioteleconference)?.[0]);const v=!!S?.serverMuted,C=m.endpointState?.state;!1!==v||!1!==!!C?.isMuted||(g=!0)}));const m=!g;this._updateIsServerMuted(m)}_updateIsServerMuted(g){g!==this.isServerMuted&&(this.isServerMuted=g,this.logger.info(`_updateIsServerMuted updating to: ${this.isServerMuted}`),this.raiseChanged())}updateVoiceLevel(g){this.voiceLevel!==g&&(this.voiceLevel=g,this.raiseChanged())}setState(g,m,S){if(this.state===g)return;const v=this.logger.createFnLogger("setState",S);if(3===this.state&&6===g)return void v.info("Ignore Connected->EarlyMedia transition, it is a race between media and signaling");const C=jr[this.state].indexOf(g)>=0;this.recordTelemetryForStateChange(S,g,m,!C),C?(v.info(`state=${this.state}->${g} reason=${this.stateReason}->${m}`),this.state=g,this.stateReason=m,this.raiseChangedDeferred()):v.logFailure(`Invalid state transition ${this.state}->${g} attempted`)}processParticipantDetails(g,m,S){const v=this.logger.createFnLogger("processParticipantDetails","");this.role=g.role,this.meetingRole=g.meetingRole,this.advancedMeetingRole=g.advancedMeetingRole,this.participantType=g.participantType,this.tenantId=g.tenantId,this.propertyBag=g.propertyBag,this.version=g.version,this.isIdentityMasked=!!g.isIdentityMasked,this.nonMaskedId=g.nonMaskedId,this.nonMaskedDisplayName=g.nonMaskedDisplayName,this.nonMaskedObjectId=g.nonMaskedObjectId,this.maskedIdSeqNumber=g.maskedIdSeqNumber,this.maskedId=g.maskedId,g.endpointDetails?.length&&(this.endpoints={endpointDetails:[]},this.participantCapabilities={canConference:!1,canShareScreen:!1,canMerge:!0},this.checkIfIncomingServerMutedIsUpdated(g),this.filteredParticipantEndpointDetails={},g.endpointDetails.forEach((g=>{const v=convertSignalingEndpointDetails(g,m);if(this.endpoints.endpointDetails.push(v),!v.mappedTo){if(this.filteredParticipantEndpointDetails[g.participantId]={endpointId:g.endpointId,serverMuteVersion:g.serverMuteVersion,endpointState:g.endpointState,mediaStreams:g.mediaStreams},g.capabilities&&(this.participantCapabilities.canConference||"enabled"!==g.capabilities.cloudAudioVideoConference||(this.participantCapabilities.canConference=!0),this.participantCapabilities.canShareScreen||"enabled"!==g.capabilities.cloudScreenSharing||(this.participantCapabilities.canShareScreen=!0),this.participantCapabilities.canMerge||"enabled"!==g.capabilities.cloudMerge||(this.participantCapabilities.canMerge=!0)),this.contentSharingRole=0,g.contentSharing&&g.contentSharing.sessionInformation){const m=g.contentSharing.sessionInformation;"attendee"===m.role?this.contentSharingRole=1:"presenter"===m.role&&(this.contentSharingRole=2)}v.streamInformation&&S&&S()}})),this.updateIsServerMuted(),v.info(`endpointDetails=${JSON.stringify(this.endpoints)}`),this.raiseChangedDeferred())}toCafeParticipant(){return{audioState:qr[this.state],mri:this.mri}}getSourceIdForMediaType(g){const m=getSourceIdForMediaType(this,g);return-1===m&&this.logger.warn("getSourceIdForMediaType failed"),m}useUmsStream(g,m,S,v,C,_){this.streamManager.useUmsStream(g,m,S,v,C,_),this.raiseChangedDeferred()}hasSourceId(g,m){return void 0!==getParticipantIdForSourceId(this,g,m)}},zr=class extends Ge{constructor(g,m,S,v,C,_="",E,T){super(),this.callTelemetry=g,this.signalingSession=S,this.contentSharingGuid=v,this.contentSharingIdentity=C,this.state=_,this.subject=E,this.handleOperationFailure=(g,m,S)=>{S.logFailure(g);const v=this.getTerminatedReasonFromError(g);return m.updateStatusTo&&(this.contentSharingStatus=m.updateStatusTo,this.rejectContentSharing(v)),Promise.reject(v)},this._logger=m.createChild((()=>`[ContentSharingSession][${this.contentSharingGuid}]`)),this.contentSharingStatus=0,this.contentSharingTerminationReason=null,this.contentSharingState=_,this._callOperationHandler=new oi(this._logger,this.callTelemetry),T&&(this.sessionId=T)}get contentSharingStatus(){return this.status}set contentSharingStatus(g){if(this._logger.info(`[set contentSharingStatus][currentStatus=${this.status}][newStatus=${g}]`),this.callTelemetry.recordEvent("_SetContentSharingStatus",{newStatus:g,oldStatus:this.status}),this.status!==g&&7!==this.status&&8!==this.status){if(this._logger.info(`[set contentSharingStatus] Changing content sharing status to: ${g}`),this.status=g,7===this.status){const g={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[set contentSharingStatus] Content sharing is disconnected"};this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(g)}if(2===this.status||5===this.status){const g={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Content sharing cannot be ended when not presenting"};this._callOperationHandler.maybeRejectOperation("StopContentSharing",g)}3===this.status&&(this._callOperationHandler.maybeResolveOperation("StartContentSharing"),this._callOperationHandler.maybeResolveOperation("TakeContentSharingControl")),this.raiseChanged()}}get contentSharingState(){return this.state}set contentSharingState(g){this.state!==g&&(this.state=g,this.raiseChanged())}startContentSharing(g=generateCauseId()){const m=this._logger.createFnLogger("StartContentSharing",g);if(0!==this.contentSharingStatus){const S=`[${g}][startContentSharing][failed][reason=InvalidState]`,v={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:S};return m.logFailure(`state=${this.contentSharingStatus}, reason=${S}`),Promise.reject(v)}return this.signalingSession.startContentSharingAsync(this.contentSharingIdentity,this.contentSharingState,this.subject,this.contentSharingGuid,g).then((g=>{this.sessionId=g.sessionId,this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((S=>this.handleOperationFailure(S,{causeId:g,operation:"StartContentSharing",updateStatusTo:8},m))),this._callOperationHandler.waitForOperation("StartContentSharing")}joinContentSharing(g=generateCauseId()){const m=this._logger.createFnLogger("JoinContentSharing",g);if(2!==this.contentSharingStatus){const S=`[${g}][joinContentSharing][failed][reason=InvalidState]`,v={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:S};return m.logFailure(`state=${this.contentSharingStatus}, reason=${S}`),Promise.reject(v)}return this.signalingSession.joinContentSharingAsync(this.contentSharingGuid,g).then((g=>(this.contentSharingStatus=4,this.contentSharingState=g.sessionState,this.presenterId=g.presenter,Promise.resolve()))).catch((S=>this.handleOperationFailure(S,{causeId:g,operation:"JoinContentSharing",updateStatusTo:8},m)))}updateContentSharingSessionState(g,m,S=generateCauseId()){const v=this._logger.createFnLogger("UpdateContentSharingSessionState",S);if(3!==this.contentSharingStatus){const g=`[${S}][updateContentSharingSessionState][failed][reason=InvalidState]`,m={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:g};return v.logFailure(`state=${this.contentSharingStatus}, reason=${g}`),Promise.reject(m)}return this.signalingSession.updateContentSharingSessionStateAsync(this.contentSharingGuid,m,S).then((()=>Promise.resolve())).catch((m=>this.handleOperationFailure(m,{causeId:S,operation:"UpdateContentSharingSessionState",operationId:g},v)))}takeContentSharingControl(g=generateCauseId()){const m=this._logger.createFnLogger("TakeContentSharingControl",g);if(5!==this.contentSharingStatus){const S=`[${g}][updateContentSharingSessionState][failed][reason=InvalidState]`,v={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:S};return m.logFailure(`state=${this.contentSharingStatus}, reason=${S}`),Promise.reject(v)}return this.signalingSession.takeContentSharingControlAsync(this.contentSharingGuid,g).then((()=>{this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((S=>this.handleOperationFailure(S,{causeId:g,operation:"TakeContentSharingControl"},m))),this._callOperationHandler.waitForOperation("TakeContentSharingControl")}updateContentSharingParticipantStateToViewer(g=generateCauseId()){const m=this._logger.createFnLogger("UpdateParticipantState",g);if(4!==this.contentSharingStatus){const S=`[${g}][updateContentSharingSessionState][failed][reason=InvalidState]`,v={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:S};return m.logFailure(`state=${this.contentSharingStatus}, reason=${S}`),Promise.reject(v)}return this.signalingSession.updateContentSharingParticipantStateAsync(this.contentSharingGuid,g).then((()=>(this.contentSharingStatus=this.presenterId===this.signalingSession.participantManager.localParticipant.id?3:5,Promise.resolve()))).catch((S=>this.handleOperationFailure(S,{causeId:g,operation:"UpdateParticipantState"},m)))}stopContentSharing(g=generateCauseId()){const m=this._logger.createFnLogger("StopContentSharing",g);if(2===this.contentSharingStatus||4===this.contentSharingStatus||5===this.contentSharingStatus){const S=`[${g}][stopContentSharing][failed][reason=InvalidState]`,v={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:S};return m.logFailure(`state=${this.contentSharingStatus}, reason=${S}`),Promise.reject(v)}return this.signalingSession.deleteContentSharingAsync(this.contentSharingGuid,g).then((()=>(this.contentSharingStatus=7,this._callOperationHandler.waitForOperation("StopContentSharing")))).catch((S=>this.handleOperationFailure(S,{causeId:g,operation:"StopContentSharing"},m)))}dispose(g=generateCauseId()){const m={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Call ended"};this._callOperationHandler.rejectPendingOperations(m,g),this.contentSharingStatus=7,this.contentSharingState="",super.dispose()}rejectContentSharing(g={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[rejectContentSharing] Content sharing is disconnected"}){if(7!==this.status&&8!==this.status)throw new Error(`Tried to reject content sharing with status=${this.status}`);this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(g)}getTerminatedReasonFromError(g){const m=g?.endCode?.code||0,S={terminatedReason:32,terminatedReasonCode:m,terminatedReasonSubCode:g?.endCode?.subCode||0,errorMessage:g};switch(m){case li.NotFound:S.terminatedReason=34,S.errorMessage="Active session not found on server";break;case li.Forbidden:S.terminatedReason=8,S.errorMessage="Failed due to insufficient permissions"}return S}};__decorateClass([callOperation("StartContentSharing"),__decorateParam(0,causeId)],zr.prototype,"startContentSharing",1),__decorateClass([callOperation("JoinContentSharing"),__decorateParam(0,causeId)],zr.prototype,"joinContentSharing",1),__decorateClass([callOperation("UpdateContentSharingSessionState"),__decorateParam(0,operationId),__decorateParam(2,causeId)],zr.prototype,"updateContentSharingSessionState",1),__decorateClass([callOperation("TakeContentSharingControl"),__decorateParam(0,causeId)],zr.prototype,"takeContentSharingControl",1),__decorateClass([callOperation("UpdateParticipantState"),__decorateParam(0,causeId)],zr.prototype,"updateContentSharingParticipantStateToViewer",1),__decorateClass([callOperation("StopContentSharing",{waitFor:"StartContentSharing"}),__decorateParam(0,causeId)],zr.prototype,"stopContentSharing",1);var Kr,Jr=class{constructor(){this.messageCounters=new Map}recordDataChannelProtocolEvent(g){this.messageCounters.has(g.dataId)||this.messageCounters.set(g.dataId,{});const m=this.messageCounters.get(g.dataId);switch(m[g.direction]||(m[g.direction]={successful:0,failed:0,fragmented:0,dismissed:0}),g.state){case 0:m[g.direction].successful++;break;case 1:m[g.direction].failed++;break;case 2:m[g.direction].fragmented++;break;case 3:m[g.direction].dismissed++}}setSessionDataChannelState(g){this.sessionState=g.toString()}recordDataChannelError(g){this.dataChannelError=g}get protocolCounters(){if(!this.messageCounters.size)return;const g={};for(const m of this.messageCounters.keys())g[m]=this.messageCounters.get(m);return g}getReport(g){const m={};return m[g+"ProtocolCounters"]=JSON.stringify(this.protocolCounters),m[g+"SessionState"]=this.sessionState,m[g+"Error"]=this.dataChannelError,m}},Yr=class{constructor(g){this.value=g,this.next=void 0}},Qr=class{constructor(){this.length=0}enqueue(g){const m=new Yr(g);this.front?(this.rear.next=m,this.rear=m):(this.front=m,this.rear=m),this.length++}dequeue(){if(!this.front)return;const g=this.front;return this.front===this.rear?(this.front=void 0,this.rear=void 0):this.front=this.front.next,this.length--,g.value}peek(){return this.front?.value}size(){return this.length}back(){return this.rear?.value}},Xr=P,Zr=class{constructor(g){this.comparator=g,this.heap=[]}enqueue(g){this.heap.push(g),this.bubbleUp()}dequeue(){const g=this.peek();if(void 0!==g){const g=this.heap.pop();this.size()>0&&(this.heap[0]=g,this.bubbleDown())}return g}peek(){return this.heap[0]}size(){return this.heap.length}bubbleUp(){let g=this.size()-1,m=this.getParentIndex(g);for(;!this.isRoot(g)&&this.comparator(this.heap[g],this.heap[m]);)[this.heap[m],this.heap[g]]=[this.heap[g],this.heap[m]],g=m,m=this.getParentIndex(g)}bubbleDown(){if(this.size()<=1)return;let g=this.getRootIndex(),m=this.getLeftIndex(g),S=this.getRightIndex(g);for(;this.heap[m]&&this.comparator(this.heap[m],this.heap[g])||this.heap[S]&&this.comparator(this.heap[S],this.heap[g]);)!this.heap[S]||this.comparator(this.heap[m],this.heap[S])?([this.heap[g],this.heap[m]]=[this.heap[m],this.heap[g]],g=m):([this.heap[g],this.heap[S]]=[this.heap[S],this.heap[g]],g=S),m=this.getLeftIndex(g),S=this.getRightIndex(g)}getRootIndex(){return 0}isRoot(g){return 0===g}getLeftIndex(g){return 2*g+1}getRightIndex(g){return 2*g+2}getParentIndex(g){return Math.floor((g-1)/2)}},es=class{constructor(g,m,S){this.maxPacketRate=m,this.rateLimiterCheckInterval=S,this.maxDataRate=0,this.packetsEndTimeForPacketRate=0,this.packetsEndTimeForBitrate=0,this.maxDataRate=g/8}canSend(g){if(0===this.maxDataRate&&0===this.maxPacketRate)return!0;const m=Je();if(this.maxPacketRate&&this.packetsEndTimeForPacketRate>m+this.rateLimiterCheckInterval)return!1;if(this.maxDataRate&&this.packetsEndTimeForBitrate>m+this.rateLimiterCheckInterval)return!1;const S=this.maxPacketRate?1e3/this.maxPacketRate:0,v=this.maxDataRate?g.length/this.maxDataRate*1e3:0;return this.packetsEndTimeForPacketRate=Math.max(this.packetsEndTimeForPacketRate,m)+S,this.packetsEndTimeForBitrate=Math.max(this.packetsEndTimeForBitrate,m)+v,!0}},ts=class{constructor(g){this.dataIds=new Map,this.maxBitrate=g.config.webrtcDataChannel.maxBitrate,this.maxPacketRate=g.config.webrtcDataChannel.maxPacketRate,this.maxQueueSize=g.config.webrtcDataChannel.maxQueueSize,g.config.webrtcDataChannel.dataIds.forEach((g=>{this.dataIds.set(g.dataId,g)}))}getMaxBitrate(g){return this.dataIds.get(g)?.maxBitrate??this.maxBitrate}getMaxPacketRate(g){return this.dataIds.get(g)?.maxPacketRate??this.maxPacketRate}getMaxQueueSize(g){return this.dataIds.get(g)?.maxQueueSize??this.maxQueueSize}getConfig(g){const m=this.dataIds.get(g)||{dataId:g};return m.maxBitrate=m.maxBitrate??this.maxBitrate,m.maxPacketRate=m.maxPacketRate??this.maxPacketRate,m.maxQueueSize=m.maxQueueSize??this.maxQueueSize,m.priorityWeight=m.priorityWeight??1,m}},is=class{constructor(g,m,S){this.dataIdConfig=m,this.rateLimiterCheckInterval=S,this.timeOffset=0,this.packets=new Qr,this.startTime=g(),this.finishTime=this.startTime,this.rateLimiter=new es(m.maxBitrate,m.maxPacketRate,this.rateLimiterCheckInterval),this.getCurrentTime=g,this.stats={bufferSize:m.maxQueueSize,remainingBytes:0,remainingPackets:0}}enqueue(g){if(0===g.length)return 0;const m=(0,Xr.sumBy)(g,(g=>g.length)),S=this.dataIdConfig.maxQueueSize;if(S&&this.stats.remainingBytes+m>S)throw new Error(`dataId ${this.dataIdConfig.dataId} send queue is full`);const v=this.getCurrentTime();let C=0;return 0===this.packets.size()?(this.startTime=v,this.finishTime=v,this.timeOffset=0,C=v):C=this.finishTime,g.forEach((g=>{C+=g.length*this.dataIdConfig.priorityWeight,this.packets.enqueue({finishTime:C,packet:g}),this.stats.remainingBytes+=g.length,this.stats.remainingPackets++})),this.finishTime=C,m}dequeue(){const g=this.peek();if(void 0!==g){if(!this.rateLimiter.canSend(g.packet))return;this.packets.dequeue(),this.stats.remainingBytes-=g.packet.length,this.stats.remainingPackets--}return g}updateTimeOffset(){this.packets.size()?this.timeOffset=this.getCurrentTime()-this.startTime:(this.startTime=this.getCurrentTime(),this.finishTime=this.startTime,this.timeOffset=0)}peek(){if(0===this.packets.size())return;const g=this.packets.peek();return{finishTime:g.finishTime+this.timeOffset,packet:g.packet}}getConfig(){return this.dataIdConfig}getStats(){return(0,Xr.clone)(this.stats)}},ns=class{constructor(g){this.senders=new Map,this.currentVirtualClock=0,this.dataIdConfigManager=new ts(g),this.virtualTimeQueue=new Zr(((g,m)=>g.minTime<m.minTime)),this.sendStats={bufferSize:0,remainingBytes:0,remainingPackets:0},this.rateLimiterCheckInterval=g.config.webrtcDataChannel.rateLimiterCheckInterval}getPacketsToSend(g){if(0===this.virtualTimeQueue.size())return[];const m=[],S=[];for(;g>=0&&this.virtualTimeQueue.size();){const v=this.virtualTimeQueue.peek();if(v.size>g)break;this.virtualTimeQueue.dequeue();const C=v.dataId,_=this.senders.get(C);if(void 0!==_.peek()){const v=_.dequeue();if(void 0!==v){m.push(v.packet),this.sendStats.remainingBytes-=v.packet.length,g-=v.packet.length,this.sendStats.remainingPackets--,this.currentVirtualClock=Math.max(this.currentVirtualClock,v.finishTime);const S=_.peek();S&&this.virtualTimeQueue.enqueue({dataId:C,minTime:S.finishTime,size:S.packet.length})}else S.push(C)}}return S.forEach((g=>{const m=this.senders.get(g);m.updateTimeOffset();const S=m.peek();S&&this.virtualTimeQueue.enqueue({dataId:g,minTime:S.finishTime,size:S.packet.length})})),m}appendPackets(g,m){let S=this.senders.get(g);void 0===S&&(S=new is((()=>this.currentVirtualClock),this.dataIdConfigManager.getConfig(g),this.rateLimiterCheckInterval),this.senders.set(g,S));const v=S.getStats(),C=S.enqueue(m);if(this.sendStats.remainingBytes+=C,this.sendStats.remainingPackets+=m.length,0===v.remainingPackets){const m=S.peek();void 0!==m&&this.virtualTimeQueue.enqueue({dataId:g,minTime:m.finishTime,size:m.packet.length})}}getStats(g){if(void 0===g)return(0,Xr.clone)(this.sendStats);const m=this.senders.get(g);return void 0===m?{bufferSize:this.dataIdConfigManager.getMaxQueueSize(g),remainingBytes:0,remainingPackets:0}:m.getStats()}},rs=class{constructor(g,m,S){this.dataId=g,this.statsGatherer=m,this.logger=S,this.pendingFragments=[]}depacketize(g){const m=new DataView(g.buffer),S=63&m.getUint8(2);if(S!==this.dataId)throw new Error(`Invalid packet dataId: ${this.dataId} !== ${S}`);const v=11,C=((15&m.getUint8(0))<<8)+m.getUint8(1),_=128&m.getUint8(2),E=m.getUint16(3),T=m.getUint8(5),I=m.getUint32(6),b=m.getUint8(10);if(_){this.pendingFragments.length&&this.logger.warn(`Unfinished message: dataId: ${this.dataId} seqNum: ${E}`),this.remainingPackets=T,0!==T&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:2,dataId:S}),this.pendingFragments=[],this.sourceId=I,this.recipients=[];for(let g=0;g<b;g++){const S=m.getUint32(v+4*g);this.recipients.push(S)}}else{if(0===this.pendingFragments.length)return this.logger.safe.error(`No start flag dataId: ${this.dataId} seqNum: ${E}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:S}),null;if(this.nextSeqNum!==E)return this.logger.safe.error(`Invalid sequence number: dataId: ${this.dataId} seqNum: ${E}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:S}),null;this.remainingPackets-=1}if(this.nextSeqNum=E+1&65535,this.pendingFragments.push(g.slice(C)),0===this.remainingPackets){const g=this.pendingFragments.reduce(((g,m)=>g+m.length),0),m=new Uint8Array(g);let S=0;for(const g of this.pendingFragments)m.set(g,S),S+=g.length;return this.pendingFragments=[],{dataId:this.dataId,sourceId:this.sourceId,data:m,recipients:this.recipients}}return null}},ss=class{constructor(g){this.seqNum=0,this.dataId=g}packetize(g){if(g.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${g.dataId}`);const m=11,S=m+4*g.recipients.length,v=new Uint8Array(g.data.length+S),C=new DataView(v.buffer);C.setUint8(0,16+(S>>8)),C.setUint8(1,255&S),C.setUint8(2,128|63&g.dataId),C.setUint16(3,this.seqNum),C.setUint8(5,0),C.setUint32(6,g.sourceId),C.setUint8(10,g.recipients.length);for(let S=0;S<g.recipients.length;S++)C.setUint32(m+4*S,g.recipients[S]);return v.set(g.data,S),this.seqNum+=1,[v]}},as=class{constructor(g,m,S){this.statsGatherer=S,this.seqNum=0,this.dataId=g,this.fragmentationSize=m}packetize(g){if(g.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${g.dataId}`);const m=11,S=m+4*g.recipients.length,v=[],C=this.fragmentationSize-S;if(C<0)throw new Error(`message dataId: ${this.dataId} payload size: ${S} exceeds limit`);let _=g.data.length?Math.ceil(g.data.length/C):1;const E=_-1;E>0&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:2,dataId:this.dataId});let T=g.data.length,I=!0,b=0;for(;_>0;){const A=Math.min(T,C),R=new Uint8Array(A+S),P=new DataView(R.buffer);P.setUint8(0,16+(S>>8)),P.setUint8(1,255&S),I?(I=!1,P.setUint8(2,128|63&g.dataId)):P.setUint8(2,63&g.dataId),P.setUint16(3,this.seqNum),P.setUint8(5,E),P.setUint32(6,g.sourceId),P.setUint8(10,g.recipients.length);for(let S=0;S<g.recipients.length;S++)P.setUint32(m+4*S,g.recipients[S]);R.set(g.data.slice(b,b+A),S),b+=A,v.push(R),this.seqNum+=1,_-=1,T-=A}return v}},os=class extends je{constructor(g,m,S,v){super(),this.dataChannel=g,this.statsGatherer=m,this.stateInternal="Created",this.packetizers=new Map,this.depacketizers=new Map,this.sendScheduleTimer=0,this.pendingPackets=new Qr,this.label=g.label,this.logger=S.createChild(`[WebRtcDataChannel ${this.label}]`),this.bufferedAmountLowThreshold=v.config.webrtcDataChannel.bufferedAmountLowThreshold,this.bufferedAmountHighThreshold=v.config.webrtcDataChannel.bufferedAmountHighThreshold,this.fragmentationSize=v.config.webrtcDataChannel.enableFragmentation?v.config.webrtcDataChannel.fragmentationSize:0,v.config.webrtcDataChannel.enableSendScheduler&&(this.sendScheduler=new ns(v)),this.rateLimiterCheckInterval=v.config.webrtcDataChannel.rateLimiterCheckInterval,this.discardOnSendFailure=v.config.webrtcDataChannel.discardOnSendFailure,this.subscribeOnDataChannelEvents()}getDataIdStats(g){return this.sendScheduler?.getStats(g)}get state(){return this.stateInternal}setDataChannel(g){this.dataChannel&&(this.logger.info(`Replacing internal data channel ${this.label}:${this.dataChannel.id} with ${g.label}:${g.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close()),this.dataChannel=g,this.subscribeOnDataChannelEvents()}dispose(){this.logger.info("dispose"),this.dataChannel&&(this.logger.info(`dataChannel.close ${this.dataChannel.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close(),this.dataChannel=null,this.setState("Destroyed"),super.dispose())}sendMessage(g,m,S,v=[]){try{this.packetizers.has(g)||(this.fragmentationSize?this.packetizers.set(g,new as(g,this.fragmentationSize,this.statsGatherer)):this.packetizers.set(g,new ss(g)));const C=this.packetizers.get(g).packetize({dataId:g,sourceId:m,data:S,recipients:v});void 0!==this.sendScheduler?(this.sendScheduler.appendPackets(g,C),this.scheduleSend()):C.forEach((g=>{this.dataChannel.send(g)})),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:0,dataId:g})}catch(m){throw this.logger.unsafe.warn(`Failed to construct protocol message: ${stringifyObject(m)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:1,dataId:g}),m}}scheduleSend(){if("Connected"!==this.state)return;const sendPacket=g=>{try{this.dataChannel.send(g)}catch(g){return this.logger.unsafe.warn(`Failed to send message: ${stringifyObject(g)}`),!1}return!0};if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){const g=Date.now();let m=this.bufferedAmountHighThreshold-this.dataChannel.bufferedAmount;for(;this.pendingPackets.size();){const g=this.pendingPackets.peek();if(g.length>m)break;if(!sendPacket(g))break;this.pendingPackets.dequeue(),m-=g.length}if(0===this.pendingPackets.size()&&m>0){const g=this.sendScheduler.getPacketsToSend(m);for(const m of g)if(!1===sendPacket(m)&&!1===this.discardOnSendFailure){this.pendingPackets.enqueue(m);break}}if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){if(this.sendScheduleTimer)return;if(this.sendScheduler.getStats().remainingPackets>0){const m=Math.max(g+this.rateLimiterCheckInterval-Date.now(),20);this.sendScheduleTimer=window.setTimeout((()=>{this.sendScheduleTimer=0,this.scheduleSend()}),m)}}}}subscribeOnDataChannelEvents(){this.dataChannel.binaryType="arraybuffer",this.dataChannel.onmessage=g=>{const m=new Uint8Array(g.data),S=63&m[2];try{this.depacketizers.has(S)||this.depacketizers.set(S,new rs(S,this.statsGatherer,this.logger));const g=this.depacketizers.get(S).depacketize(m);g&&(this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:0,dataId:S}),this.event("onmessage").raise(S,g.sourceId,g.data))}catch(g){this.logger.unsafe.warn(`Failed to parse incoming message: ${stringifyObject(g)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:1,dataId:S})}},this.dataChannel.onerror=g=>{const m=g?.target,S=stringifyObject(g?.error??g);this.logger.safe.warn(`onerror: label:${m.label} id:${m.id} ${S} `),this.statsGatherer.recordDataChannelError(S)},"open"===this.dataChannel.readyState&&this.dataChannel.id%2==0&&(this.logger.safe.info(`readyState is already 'open' label:${this.dataChannel.label} id:${this.dataChannel.id}`),this.setState("Connected")),this.dataChannel.onopen=g=>{const m=g.target;this.logger.safe.info(`onopen label:${m.label} id:${m.id}`),m.id%2==0&&this.setState("Connected")},this.dataChannel.onclose=g=>{const m=g.target;this.logger.safe.info(`onclose label:${m.label} id:${m.id}`),this.setState("Closed")},this.dataChannel.onclosing=g=>{const m=g.target;this.logger.safe.debug(`onclosing label:${m.label} id:${m.id}`),this.setState("Closed")},void 0!==this.sendScheduler&&(this.dataChannel.bufferedAmountLowThreshold=this.bufferedAmountLowThreshold,this.dataChannel.onbufferedamountlow=()=>{this.scheduleSend()})}unsubscribeOnDataChannelEvents(){this.dataChannel.onmessage=null,this.dataChannel.onerror=null,this.dataChannel.onopen=null,this.dataChannel.onclose=null,this.dataChannel.onclosing=null,this.dataChannel.onbufferedamountlow=null}setState(g){this.stateInternal=g,this.event("onStateChanged").raise(),"Connected"===g&&void 0!==this.sendScheduler&&this.scheduleSend()}},ls="main-channel",cs=class extends je{constructor(g,m,S,v){const C=S.createChild("PluginlessDataChannel");super(C),this.pc=g,this.statsGatherer=m,this.configProvider=v,this._state="Inactive",this.logger=C,this.subscribeOnDatachannel()}get state(){return this._state}getDataChannel(g){if(!this.dataChannel){this.logger.safe.info(`[${g}] creating new dataChannel`);try{const g={};this.dataChannel=new os(this.pc.createDataChannel(ls,g),this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()}catch(m){return this.logger.safe.error(`[${g}] createDataChannel failed: ${stringifyObject(m)}`),this.statsGatherer.sessionInfo.setCreateChannelFailReason(m),this.setState("Failed"),null}}return this.dataChannel}updateDataModalityState(g){"Failed"!==this._state&&"Disabled"!==this._state&&(g===Ke.MEDIA_STATE.sendReceive?this.setState("Active"):g===Ke.MEDIA_STATE.inactive&&this.setState("Inactive"))}disable(){this.setState("Disabled")}dispose(){this.stopDataChannel(),this.pc=null,super.dispose()}subscribeOnDatachannel(){this.pc.ondatachannel=g=>{this.onDataChannel(g.channel)}}onDataChannel(g){this.logger.safe.info(`onDataChannel id=${g.id} label=${g.label}`),g.id%2==0?this.dataChannel?(this.logger.safe.info("Found existing data channel, replacing"),this.dataChannel.setDataChannel(g)):(this.dataChannel=new os(g,this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()):this.logger.safe.info(`onDataChannel ignoring id ${g.id}`)}subscribeForDataChannelEvents(){this.dataChannel.on("onStateChanged",(()=>{"Closed"===this.dataChannel.state&&(this.stopDataChannel(),this.setState("Inactive"))}))}setState(g){if(this._state!==g){this.statsGatherer.setSessionDataChannelState(g);const m=generateCauseId();this._state=g,this.logger.safe.info(`[${m}] SessionDataChannelState changed, state=${this._state}`),"Inactive"===this._state||"Disabled"===this._state?this.stopDataChannel():"Active"===this._state&&this.getDataChannel(m),this.event("onStateChanged").raise(this._state)}}stopDataChannel(){this.dataChannel&&(this.logger.safe.info("stopDataChannel"),this.dataChannel.dispose(),this.dataChannel=null)}},ds=class extends Ge{constructor(g){super(),this.mainChannel=null,this.sourceId=Xt,this._state="Inactive",this.dataHandlers=new Map,this.dataHandlerTelemetry=new Map,this.startTime=Date.now(),this.sendMessage=async(g,m,S)=>{if(this.logger.debug(`Sending message for ${g}, from: ${this.sourceId} to: ${S} state: ${!!this.mainChannel&&this.mainChannel.state} len: ${m.length}`),!this.mainChannel||"Connected"!==this.mainChannel.state||"Active"!==this.state)throw new Error("No active data channel to send data from");this.mainChannel.sendMessage(g,this.sourceId,m,S)},this.logger=g.createChild("PluginlessDataChannel")}get state(){return this._state}registerSessionDataChannel(g,m){this.sessionDataChannel&&this.stop(m),this.sessionDataChannel=g,this.subscribeForSessionDataChannelEvents()}setDataChannelSourceId(g){this.logger.debug(`setDataChannelSourceId ${g}`),this.sourceId=g}requestDataChannelHandler(g){return this.sessionDataChannel.getDataChannel(g)}async sendUserEvents(g,m){if(!this.mainChannel)throw this.logger.info("sendUserEvents() no data channel available"),new Error("Main DataChannel is not active");{const S=m?m.map((g=>parseInt(g,10))):[];this.mainChannel.sendMessage(0,this.sourceId,(new TextEncoder).encode(g),S)}}async addHandler(g,m){if(this.logger.info(`Adding handler with dataId ${g}`),this.dataHandlers.get(g))throw new Error(`Data Id ${g} is already registered`);const S={isStarted:!1,handler:m};this.dataHandlers.set(g,S),this.recordDataHandlerEvent(g,"added"),"Connected"===this.mainChannel?.state&&this.startHandler(g,S)}async removeHandler(g){if(this.logger.info(`Removing handler with dataId ${g}`),!this.dataHandlers.has(g))throw new Error(`Handler associated with Data Id ${g} is not attached`);const m=this.dataHandlers.get(g);m.isStarted&&this.stopHandler(g,m),this.dataHandlers.delete(g)}async updateNegotiationTag(g){}getTelemetry(){if(!this.dataHandlerTelemetry.size)return"";const g={};for(const[m,S]of this.dataHandlerTelemetry)g[m]=S;return JSON.stringify(g)}start(g){this.mainChannel?this.logger.info(`[${g}] already started`):(this.logger.info(`[${g}] starting`),this.mainChannel=this.sessionDataChannel.getDataChannel(g),this.subscribeForMainDataChannelEvents())}stop(g){this.mainChannel&&(this.logger.info(`[${g}] stopping`),this.mainChannel.dispose(),this.mainChannel=null)}dispose(){this.stop(void 0),this.sessionDataChannel=null,super.dispose()}setConfigProviderView(g){this.configProviderView=g}subscribeForMainDataChannelEvents(){this.mainChannel.on("onmessage",((g,m,S)=>{this.logger.debug(`Got message for ${g}, from: ${m} state: ${!!this.mainChannel&&this.mainChannel.state}, len: ${S.length}`),this.dataHandlers.has(g)&&(this.recordDataHandlerEvent(g,"recvd"),this.dataHandlers.get(g).handler.onDataReceived(g,S,m)),this.event("remoteUserEventsReceived").raise(g.toString(),(new TextDecoder).decode(S))})),this.onMainChannelStateChanged(),this.mainChannel.on("onStateChanged",(()=>this.onMainChannelStateChanged()))}onMainChannelStateChanged(){if(this.mainChannel)switch(this.mainChannel.state){case"Connected":this.startHandlers();break;case"Closed":case"Destroyed":this.stopHandlers()}}startHandlers(){for(const[g,m]of this.dataHandlers.entries())m.isStarted||this.startHandler(g,m)}stopHandlers(){for(const[g,m]of this.dataHandlers.entries())m.isStarted&&this.stopHandler(g,m)}startHandler(g,m){this.logger.info(`Starting dataHandler id: ${g}`),m.handler.onStarted(g,((m,S)=>(this.recordDataHandlerEvent(g,"sent"),this.sendMessage(g,m,S))),(()=>{const m=this.mainChannel?.getDataIdStats(g);if(void 0!==m){const g={bufferSize:m.bufferSize,remainingBytes:m.remainingBytes,remainingPackets:m.remainingPackets};return Promise.resolve(g)}return Promise.reject(new Error(`Stats of dataId ${g} is not available`))})),m.isStarted=!0,this.recordDataHandlerEvent(g,"started")}stopHandler(g,m){this.logger.info(`Stopping dataHandler id: ${g}`),m.handler.onStopped(g),m.isStarted=!1,this.recordDataHandlerEvent(g,"removed")}subscribeForSessionDataChannelEvents(){this.sessionDataChannel.on("onStateChanged",(g=>{const m=generateCauseId();switch(g){case"Active":this.start(m),this.setState("Active");break;case"Inactive":this.stop(m),this.setState("Inactive");break;case"Failed":this.stop(m),this.setState("Failed");break;case"Disabled":this.stop(m),this.setState("Disabled");break;default:this.logger.warn(`[${m}] unhandled SessionDataChannelState ${g}`)}}))}recordDataHandlerEvent(g,m){this.dataHandlerTelemetry.has(g)||this.dataHandlerTelemetry.set(g,[{}]);const S=this.dataHandlerTelemetry.get(g);let v=S[S.length-1];if("added"===m&&void 0!==v.added){v={},S.push(v);const g=this.configProviderView?.config.maxStoredDataChannelValues??15;S.length>g&&S.shift()}switch(m){case"added":case"started":case"removed":v[m]=Date.now()-this.startTime;break;case"recvd":case"sent":v[m]=isNaN(v[m])?1:v[m]+1}}setState(g){this._state!==g&&(this._state=g,this.logger.info(`PluginlessDataChannelState changed, state=${this._state}`),this.event("onDataChannelStateUpdated").raise(this._state))}},hs=__toESM(Ie());(g=>{const m=7,S=3;function encodeMouseEvent(g){if(!g)return new Uint8Array(0);g.buttonType||(g.buttonType=0),g.xPos||(g.xPos=0),g.yPos||(g.yPos=0),g.wheelRotation||(g.wheelRotation=0);const S=new ArrayBuffer(m),v=new DataView(S),C=(3&g.type)<<0,_=(7&g.buttonType)<<2,E=(g.buttonDown?1:0)<<5,T=(g.wheelButtonDown?1:0)<<6,I=0;return v.setUint8(0,1),v.setUint8(1,C|_|E|T|I),v.setUint16(2,g.xPos,!0),v.setUint16(4,g.yPos,!0),v.setUint8(6,g.wheelRotation),new Uint8Array(S)}function encodeKeyboardEvent(g){const m=new ArrayBuffer(S),v=new DataView(m),C=(3&g.codeType)<<0,_=0,E=(g.keyUp?1:0)<<4,T=(g.repeat?1:0)<<5,I=0,b=0;return v.setUint8(0,0),v.setUint8(1,C|_|E|T|I|b),v.setUint8(2,g.code),new Uint8Array(m)}function decodeEventType(g){return g[0]}function decodeMouseEvent(g){if(1!==g[0]||g.length!==m)return null;const S=new DataView(g.buffer),v=S.getUint8(1);return{type:3&v,buttonType:v>>2&7,buttonDown:!!(v>>5&1),wheelButtonDown:!!(v>>6&1),xPos:S.getUint16(2,!0),yPos:S.getUint16(4,!0),wheelRotation:S.getUint8(6)}}function decodeKeyboardEvent(g){if(0!==g[0]||g.length!==S)return null;const m=new DataView(g.buffer),v=m.getUint8(1);return{codeType:3&v,code:m.getUint8(2),repeat:!!(v>>5&1),keyUp:!!(v>>4&1)}}g.encodeMouseEvent=encodeMouseEvent,g.encodeKeyboardEvent=encodeKeyboardEvent,g.decodeEventType=decodeEventType,g.decodeMouseEvent=decodeMouseEvent,g.decodeKeyboardEvent=decodeKeyboardEvent})(Kr||(Kr={}));var us=P,gs=R,ps=3e4,ms=1e4,fs=2e3,Ss=6,vs="",Cs=class extends Kt{constructor(g,m,S,v,C,_){super(g,m,(()=>this.recordedEvents.length>100)),this.negotiationTag=S,this.callId=v,this.participantId=C,this.endpointId=_,this.messagesFromUnknownSender={},this.tsCallingVersion=getTsCallingVersion()}recordProtocolMessage(g,m){g||(m in this.messagesFromUnknownSender||(this.messagesFromUnknownSender[m]=0),this.messagesFromUnknownSender[m]++)}setCallId(g){this.callId=g}setEndpointId(g){this.endpointId=g}setParticipantId(g){this.participantId=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}},_s=class extends Cs{constructor(g,m,S,v,C,_,E){super(g,m,S,v,C,_);const T=getSharingParticipantLeg(E);if(T){this.sharerParticipantId=T;const g=(0,us.find)(E.endpoints.endpointDetails,(g=>g.participantId===T));g&&(this.sharerClientVersion=g.clientVersion)}}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{CorrelationId:getValue2(this.callId),ParticipantId:getValue2(this.participantId),EndpointId:getValue2(this.endpointId),NegotiationTag:getValue2(this.negotiationTag),TsCallingVersion:getValue2(this.tsCallingVersion),TenantId:getValue2(this.tenantId),SharerParticipantId:getValue2(this.sharerParticipantId),SharerClientVersion:getValue2(this.sharerClientVersion),EventTimestampBag:super.getEventTimestampBag(g,m),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},ys=class extends Cs{constructor(g,m,S,v,C,_){super(g,m,S,v,C,_)}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{CorrelationId:getValue2(this.callId),ParticipantId:getValue2(this.participantId),EndpointId:getValue2(this.endpointId),NegotiationTag:getValue2(this.negotiationTag),TsCallingVersion:getValue2(this.tsCallingVersion),TenantId:getValue2(this.tenantId),EventTimestampBag:super.getEventTimestampBag(g,m),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},Es=class extends Ge{constructor(g,m,S,v){super(g),this._logger=g,this._call=m,this._telemetryLoggers=S,this._config=v,this.controlState=0,this.role=0,this._enabled=!1,this._availableAckEnabled=!0,this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._controlRequest=null,this._controlRequestSubscription=null,this._controllerParticipant=null,this._controllerParticipantSubscription=null,this._controllerSourceId=null,this._screenSharingVideoRenderer=null,this._screenSharingVideoRendererSubscriptions=[],this._sharerParticipant=null,this._pendingSharer=null,this._controlCapturer=null,this._captureEventSubscription=null,this._mouseControlEventSubscription=null,this._keyboardControlEventSubscription=null,this._requestControlTimer=null,this._grantControlTimer=null,this._acceptControlTimer=null,this._terminateControlTimer=null,this._delayedSendHandshakeTimer=null,this._availableAckTimer=null,this._retryAttempt=0,this._raiseRenderedAtViewer=null,this._participantSubscriptions={},this._viewerSessionLastTerminatedReason=0,this._completedViewerSessions=[],this.giveControlEnabled=!0,this.isEscalationInProgress=!1,this._logger.info("constructor"),this._callId=this._call.callId,this._call.on("callIdChanged",(g=>{this._callId=g,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setCallId(g),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setCallId(g)})),this._participantId=this._call.participantId,this._call.on("callLegIdChanged",(g=>{this._participantId=g,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setParticipantId(g),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setParticipantId(g)})),this._endpointId=this._call.endpointId}setAdapters(g,m,S){this._controlInjector=g,this._rendererAdapter=m,this._dataChannelAdapter=S,this._dataChannelAdapter.on("stateChange",(g=>{this._onDataChannelStatusChanged(g)})),this._dataChannelAdapter.on("protocolMessage",((g,m,S,v)=>this.processProtocolMessage(g,m,S,v))),this._dataChannelAdapter.on("controlMessage",((g,m)=>this.processControlMessage(g,m)))}testSetControlInjector(g){}enableScreenSharingControl(g,m,S,v){if(this._logger.info(`enableScreenSharingControl() enabled=${g} disabledReason=${m}`),this._availableAckEnabled!==g||this._allowControlForUser!==v){if(this._allowControlForUser=v,g)this._raiseScreenSharingControlCapableEvent(!0,vs);else{if(0===m){const g={reason:2,detail:S};this.event("sharingControlError").raise(g)}this._raiseScreenSharingControlCapableEvent(!1,vs)}if(this._availableAckEnabled!==g){const m=g?"AvailableAckEnabled":"AvailableAckDisabled";this._recordSharerSessionTelemetry((g=>g.recordEvent(m)),!1)}this._availableAckEnabled=g}}setGiveControlEnabled(g){this.giveControlEnabled=g}_canEnableGiveControl(){return this._controlInjector.canBeEnabled()&&this.giveControlEnabled}setRaiseRenderedAtViewer(g){this._raiseRenderedAtViewer=g}setScreenSharingControlFeatureFlag(g){this._logger.info(`setScreenSharingControlFeatureFlag() enabled=${g}`),this._enabled=g,this._availableAckEnabled=g,this._enabled&&this._handleCallState(this._callState)}isScreenSharingControlEnabled(){return this._enabled}_disposeRenderer(g){this._disposeControlCapturer(g);for(const g of this._screenSharingVideoRendererSubscriptions)g.dispose();this._screenSharingVideoRendererSubscriptions=[],this._screenSharingVideoRenderer=null}setRenderer(g,m){this._logger.info("setRenderer");const S=generateCauseId();if(this._disposeRenderer(S),!g)return Promise.resolve();const v=m||this._rendererAdapter.getTarget(g);return asap((()=>{this._setViewingRenderer(g,v)}))}_isDataChannelActive(){return this._dataChannelAdapter.isActive()&&this._dataChannelAvailable}_raiseScreenSharingControlCapableEvent(g,m,S){if(this._enabled&&this._isDataChannelActive()){this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=true, capable=${g}, role=${this.role}`);const v={capable:g,id:m,disabledBySharer:S};this.event("sharingControlCapable").raise(v)}else{this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=false, capable=${g}, role=${this.role}`);const S={capable:!1,id:m};this.event("sharingControlCapable").raise(S)}}initControlForSharer(g){this._logger.info("initControlForSharer()"),this._isSharing()&&this._logger.warn("initControlForSharer() when already sharing"),this._resetControlState(),this._screenSharingVideoRenderer=null,this._disposeControlCapturer(),this._logger.info(`role is changing from=${this.role} to=1`),this.role=1,this._availableHandshakeSent=!1,this._raiseScreenSharingControlCapableEvent(this._canEnableGiveControl(),vs),this._initiateSharerSessionTelemetry(g)}enableControlInjector(g){this._logger.info(`enableControlInjector() trackId: ${g}`),this._canEnableGiveControl()?this._controlInjector.enableInjector(g).catch((g=>{const m={reason:0,detail:JSON.stringify({errorMsg:g})};this.event("sharingControlError").raise(m)})):this._logger.info("enableControlInjector() give control cannot be enabled")}shutdownControlForSharer(){if(this._logger.info("shutdownControlForSharer()"),this._isSharing()||this._logger.warn("shutdownControlForSharer() when not sharing"),this._controlRequest){this._logger.warn("Rejecting pending control requests");const g=this._getDataSourceIdForParticipantLeg(this._controlRequest),m=this._controlRequest;this._clearControlRequest(),this._raiseControlRequestCanceled(m),this._sendControlRejectRequest(5,g)}if(this._controllerParticipant){const g={inControl:!1,id:this._controllerParticipant.participant.id,terminatedReason:5};this.event("sharingControlChanged").raise(g)}this._finalizeSharerSessionTelemetry("Shutdown"),this._teardownSharerRemoteControl(),this._controlInjector.disableInjector().catch((g=>{const m={reason:0,detail:JSON.stringify({errorMsg:g})};this.event("sharingControlError").raise(m)})),this._resetControlState(),this._resetParticipantSubscriptions(),this._availableAckEnabled=this._enabled,this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}_resetParticipantSubscriptions(){this._logger.info("resetParticipantSubscriptions() Stopping tracking all participant state changes"),(0,us.each)(this._participantSubscriptions,(g=>{g.dispose()})),this._participantSubscriptions={}}_initiateViewerSessionTelemetry(g,m,S){if(!S&&!m)return null;if(!S&&(0,us.find)(this._completedViewerSessions,(g=>m===g)))return null;if(this._currentViewerSessionTelemetry){if(this._currentViewerSessionTelemetry.negotiationTag===m)return null;this._finalizeViewerSessionTelemetry("ShutdownByOtherSession")}return this._logger.info(`Initiating new viewer session telemetry for ${m}`),this._currentViewerSessionTelemetry=new _s(this._logger,(new Date).getTime(),m,this._callId,this._participantId,this._endpointId,g),this._currentViewerSessionTelemetry.recordEvent("CallState",{state:this._callState}),this._isDataChannelActive()&&this._currentViewerSessionTelemetry.recordEvent("DataChannelAvailable"),this._currentViewerSessionTelemetry}_recordViewerSessionTelemetry(g,m=!0){this._currentViewerSessionTelemetry?g&&g(this._currentViewerSessionTelemetry):m&&this._logger.error("Cannot record telemetry without current session")}_finalizeViewerSessionTelemetry(g){if(!this._currentViewerSessionTelemetry)return;this._currentViewerSessionTelemetry.recordEvent(g);const m=this._currentViewerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_viewer_session",m),this._currentViewerSessionTelemetry.negotiationTag&&this._completedViewerSessions.push(this._currentViewerSessionTelemetry.negotiationTag),this._currentViewerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentViewerSessionTelemetry.messagesFromUnknownSender).length&&gs.RootToolsManager.logExternalForDDL("ScreenSharingControl_viewer: messages received from unkonwn sender",JSON.stringify(m.ProtocolMessages)),this._currentViewerSessionTelemetry=null}_initiateSharerSessionTelemetry(g){if(this._currentSharerSessionTelemetry){if(this._currentSharerSessionTelemetry.negotiationTag===g)return null;this._finalizeSharerSessionTelemetry("ShutdownByOtherSession")}this._logger.info(`Initiating new sharer session telemetry for ${g}`),this._currentSharerSessionTelemetry=new ys(this._logger,(new Date).getTime(),g,this._callId,this._participantId,this._endpointId),this._isDataChannelActive()&&this._currentSharerSessionTelemetry.recordEvent("DataChannelAvailable")}_recordSharerSessionTelemetry(g,m=!0){this._currentSharerSessionTelemetry?g&&g(this._currentSharerSessionTelemetry):m&&this._logger.error("Cannot record telemetry without current session")}_finalizeSharerSessionTelemetry(g){if(!this._currentSharerSessionTelemetry)return;this._currentSharerSessionTelemetry.recordEvent(g);const m=this._currentSharerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_sharer_session",m),this._currentSharerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentSharerSessionTelemetry.messagesFromUnknownSender).length&&gs.RootToolsManager.logExternalForDDL("ScreenSharingControl_sharer: messages received from unkonwn sender",JSON.stringify(m.ProtocolMessages)),this._currentSharerSessionTelemetry=null}_sendTelemetryEvent(g,m){this._logger.info(`Sending event ${g}: `),Object.keys(m).forEach((g=>{this._logger.info(`     ${g} => ${m[g]}`)})),this._telemetryLoggers?.media?.sendEvent({eventName:g,props:m})}_recordProtocolMessage(g,m){this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.recordProtocolMessage(g,m),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.recordProtocolMessage(g,m)}reportSharingSessionChangeForViewer(g,m){m&&this._initiateViewerSessionTelemetry(g,m,!1)}initControlForViewer(g,m){if(this._logger.info(`initControlForViewer(${scrubMriOrOmit(g?.id)}, ${m})`),!g)return void this._logger.warn("initControlForViewer: Sharer undefined, ignoring");if(this._isViewing()&&this._logger.warn("initControlForViewer: called when already viewing"),3!==this._callState)return this._logger.info(`initControlForViewer: postponed until call is connected, callState=${this._callState}`),this._pendingNegotiationTag=m,void(this._pendingSharer=g);const S=!this._sharerParticipant||this._sharerParticipant&&this._sharerParticipant.id!==g.id||m!==this._currentNegotiationTag;this._currentNegotiationTag=m,this._logger.info(`role is changing from=${this.role} to=2`),this.role=2,this._sharerParticipant?this._sharerParticipant.id!==g.id&&(this._recordViewerSessionTelemetry((g=>g.recordEvent("ShutdownByOtherSession",null,m))),this._logger.info(`initControlForViewer: sharer switched, new sharer id=${scrubMriOrOmit(g.id)}`),this._availableHandshakeSent=!1,4===this.controlState&&this._terminateControl(!1)):(this._logger.info(`initControlForViewer: setting sharer to id=${scrubMriOrOmit(g.id)}`),this._sharerParticipant=g,this._availableHandshakeSent=!1),this._initiateViewerSessionTelemetry(g,m,!0),S&&this._recordViewerSessionTelemetry((g=>g.recordEvent("SharingStarted"))),this._enabled&&this._isDataChannelActive()&&!this._availableHandshakeSent&&(this._resetControlState(),this._sharerParticipant=g,this._logger.info("initControlForViewer: sending Available message to sharer"),this._startAvailableHandshake())}shutdownControlForViewer(g){this._logger.info("shutdownControlForViewer()"),this._pendingSharer=null;let m=!1;if(g&&g.id!==this._sharerParticipant?.id||(this._logger.info(`shutdownControlForViewer: setting shouldShutdownControlForViewer to true, isViewing: ${this._isViewing()}`),m=!0),m&&this._isViewing()){if(1===this.controlState){if(this._sharerParticipant){const g=this._getSharerDataSourceId();this._sendRequest({action:2,terminatedReason:6},g)}else this._logger.warn("shutdownControlForViewer: sharer participant is null");const g={inControl:!1,id:vs,terminatedReason:6};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:g,details:""}))):this._logger.error("shutdownControlForViewer: Unexpected, no promise could be resolved, controlState=RequestSent")}else if(4===this.controlState){const g={inControl:!1,id:vs,terminatedReason:6};this.event("sharingControlChanged").raise(g)}this._teardownViewerRemoteControl(),this._resetControlState(),this._screenSharingVideoRenderer=null,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._availableHandshakeSent=!1,this._finalizeViewerSessionTelemetry("Shutdown"),2===this.role?(this._logger.info(`_raiseScreenSharingControlCapableEvent  with user role=${this.role}, MRI=${vs}, isCapable=false`),this._raiseScreenSharingControlCapableEvent(!1,vs)):this._logger.warn(`can't call _raiseScreenSharingControlCapableEvent, role=${this.role}`),this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}}_resetControlRequest(g){this._clearControlRequest(),this._controlRequest=g,this._registerParticipantListener(g),3===g.participantState&&(this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${g.participant.id}`),this.event("sharingIncomingControlRequest").raise(g.participant.id))}_clearControlRequest(){this._logger.info("_clearControlRequest()"),this._stopListeningToParticipantChanges(this._controlRequest),this._controlRequest=null}_stopListeningToParticipantChanges(g){this._controlRequestSubscription&&(this._logger.info(`_stopListeningToParticipantChanges: stopping tracking changes for ${g.participant.id}`),this._controlRequestSubscription.dispose(),this._controlRequestSubscription=null)}_registerParticipantListener(g){this._logger.info(`_registerParticipantListener: tracking changes for ${g.participant.id}`),this._logger.info(`request.participantState: ${g.participantState} | request.participant.state: ${g.participant.state}`),this._controlRequestSubscription=g.participant.changed((()=>{if(g.participant.state!==g.participantState)switch(this._logger.info(`request.participantState about to changed from: ${g.participantState} to: ${g.participant.state}`),g.participantState=g.participant.state,g.participantState){case 3:this.event("sharingIncomingControlRequest").raise(g.participant.id),this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${g.participant.id}`);break;case 0:case 5:case 4:this.denyControlRequest().catch((g=>{this._logger.info(`It is ok if denyControlRequest rejects here as screensharing may have just been stopped. Err: ${g}`)})),this._logger.info(`_registerParticipantListener: participant ${g.participant.id} is no longer connected. resetting`),this._clearControlRequest(),this._raiseControlRequestCanceled(g);break;case 1:case 2:case 6:case 7:this._logger.info(`participantState: ${g.participantState}, participantId: ${g.participant.id}`);break;default:this._logger.error(`_registerParticipantListener: Unexpected participantState ${g.participantState} unhandled`)}}))}_resetControllerParticipant(g){this._controllerParticipantSubscription&&(this._logger.info(`_resetControllerParticipant: stopping tracking changes for ${this._controllerParticipant.participant.id}`),this._controllerParticipantSubscription.dispose(),this._controllerParticipantSubscription=null),g&&(this._logger.info(`_resetControllerParticipant: tracking changes for ${g.participant.id}`),this._controllerParticipantSubscription=g.participant.changed((()=>{3!==g.participant.state&&this.handleParticipantRemoved(g.participant.id)}))),this._controllerParticipant=g}handleParticipantRemoved(g){if(this._participantSubscriptions[g]&&(this._logger.info(`handleParticipantRemoved(): Stopping tracking state changes for ${g}`),this._participantSubscriptions[g].dispose(),delete this._participantSubscriptions[g]),this._isSharing()){if(this._controllerParticipant&&this._controllerParticipant.participant.id===g){this._logger.info("handleParticipantRemoved: controller left call, tearing down control session"),this._teardownSharerRemoteControl(),this.controlState=0,this._resetControllerParticipant();const m={inControl:!1,id:g,terminatedReason:5};this.event("sharingControlChanged").raise(m)}this._raiseScreenSharingControlCapableEvent(!1,g)}else if(this._sharerParticipant&&this._sharerParticipant.id===g&&4===this.controlState){this._logger.info("handleParticipantRemoved: sharer left call, tearing down control session"),this._teardownViewerRemoteControl(),this.controlState=0;const g={inControl:!1,id:vs,terminatedReason:6};this.event("sharingControlChanged").raise(g)}}callStateChanged(g){this._callState=g,this._recordViewerSessionTelemetry((m=>m.recordEvent("CallState",{state:g})),!1),this._recordSharerSessionTelemetry((m=>m.recordEvent("CallState",{state:g})),!1),this.isScreenSharingControlEnabled()&&this._handleCallState(g)}setIsEscalationInProgress(g){this.isEscalationInProgress=g}_getHandshakeDelay(){if(!this._config.handshakeSendDelay?.minParticipantThreshold)return 0;let g=0;if(this._call.participants.length>=this._config.handshakeSendDelay.minParticipantThreshold)for(const m of this._call.participants)m.endpoints?.endpointDetails.some((g=>"interactive"===g.appliedInteractivityLevel))&&g++;if(g<=this._config.handshakeSendDelay.minParticipantThreshold)return 0;const m=Math.ceil((g-this._config.handshakeSendDelay.minParticipantThreshold)/this._config.handshakeSendDelay.increaseEveryN);return Math.min(this._config.handshakeSendDelay.maxDelay,m*this._config.handshakeSendDelay.delayPerN)}_handleCallState(g){switch(g){case 3:this._handleCallConnected();break;case 7:this._handleCallDisconnected();break;case 4:case 5:this.shutdownControlForViewer()}}_handleCallConnected(){this._logger.info("_handleCallConnected()"),this._pendingSharer&&(this.initControlForViewer(this._pendingSharer,this._pendingNegotiationTag),this._pendingSharer=null)}_handleCallDisconnected(){this._logger.info("_handleCallDisconnected()"),this._isSharing()?this.shutdownControlForSharer():this.shutdownControlForViewer()}_videoSizeChanged(g,m){null!==this._controlCapturer&&this._controlCapturer.updateVideoSize(g,m)}_onRenderStarted(){const g={action:11,terminatedReason:0};if(this._sharerParticipant){const m=this._getSharerDataSourceId();this._sendRequest(g,m)}else this._logger.error("Attempted to send sharing rendered message to null sharerParticipant")}_setViewingRenderer(g,m){try{this._screenSharingVideoRenderer=g,this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeVideoSizeChangedEvent(this._screenSharingVideoRenderer,((g,m)=>{this._videoSizeChanged(g,m)}))),this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeRenderStartedEvent(this._screenSharingVideoRenderer,(()=>{this._onRenderStarted()})));let S=1;g.streamSize&&g.streamSize.width>0&&g.streamSize.height>0&&(S=g.streamSize.width/g.streamSize.height),this._controlCapturer=new hs.SlimCoreElectronControlCapturer(this._logger,m,!0,S),4===this.controlState?(this._logger.info("_setViewingRenderer: detected local state is controlling"),this._setupViewerRemoteControl()):this._teardownViewerRemoteControl()}catch(g){this._logger.error(`_setViewingRenderer: unable to set _screenSharingVideoRenderer error=${g}`)}}_onDataChannelStatusChanged(g){this._logger.info(`_onDataChannelStatusChanged(): Data channel status=${g}, isEscalationInProgress=${this.isEscalationInProgress}`),g?this._dataChannelAvailable||(this._dataChannelAvailable=!0,this._recordViewerSessionTelemetry((g=>g.recordEvent("DataChannelAvailable")),!1),this._recordSharerSessionTelemetry((g=>g.recordEvent("DataChannelAvailable")),!1),this._enabled&&(this._isViewing()?this._availableHandshakeSent||(this._sharerParticipant?(this._logger.info("_onDataChannelStatusChanged: sending Available message to sharer"),this._startAvailableHandshake()):this._logger.error("Unexpected null _sharerParticipant trying to send Available to sharer")):this._isSharing()&&(this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!0,vs)))):this._dataChannelAvailable&&(this._recordViewerSessionTelemetry((g=>g.recordEvent("DataChannelUnavailable")),!1),this._recordSharerSessionTelemetry((g=>g.recordEvent("DataChannelUnavailable")),!1),this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(3),this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!1,vs))}_isSharing(){return 1===this.role}_isViewing(){return 2===this.role}_handleAvailableRequest(g,m,S){let v=!1,C=0;if(this._enabled)if(this._availableAckEnabled)if(this._canEnableGiveControl())if(m?.id){if(this._allowControlForUser&&typeof this._allowControlForUser==typeof Function)return void this._allowControlForUser(m).then((_=>{_||(v=!0,C=1),this._sendResponseToAvailableRequest(g,m,S,v,C)}))}else v=!0,C=10;else this._logger.info("GiveControl is not enabled. no need to answer the available ack"),v=!0,C=9;else this._logger.info("Available ack is off. no need to answer the available ack"),v=!0,C=9;else this._logger.info("Feature flag is off. no need to answer the available ack"),v=!0,C=9;this._sendResponseToAvailableRequest(g,m,S,v,C)}_sendResponseToAvailableRequest(g,m,S,v,C){v?(this._logger.info(`Rejecting Available for handShake:${S}:${g.handshakeId}`),this.event("controlAvailableHandshake").raise(g.handshakeId,S,7,this._getAvailableHandshakeTerminatedFromControlTerminated(C)),this._sendRequest({action:10,terminatedReason:C,handshakeId:g.handshakeId},S)):(this._raiseScreenSharingControlCapableEvent(!0,m.id),this._participantSubscriptions[m.id]||(this._logger.info(`Tracking participant status for ${m.id}`),this._participantSubscriptions[m.id]=m.changed((()=>{3!==m.state&&(this._logger.info(`Participant ${m.id} is not connected. removing`),this.handleParticipantRemoved(m.id))}))),this._logger.info(`Acking Available for handShake:${S}:${g.handshakeId}`),this.event("controlAvailableHandshake").raise(g.handshakeId,S,3),this._sendRequest({action:9,terminatedReason:0,handshakeId:g.handshakeId},S))}processProtocolMessage(g,m,S,v){return asap((()=>{this._processProtocolMessage(g,m,S,v)}))}_raiseControlRequestCanceled(g){this.event("sharingIncomingControlRequestCancelled").raise(g.participant.id)}_handleControlRequest(g,m,S){this._recordSharerSessionTelemetry((g=>{g.recordOperation("ControlRequest",null,String(m))})),this._enabled?this._controlRequest?(this._logger.warn("Sharer is already processing a control request...rejecting new requests"),this._sendControlRejectRequest(3,m)):this._controllerParticipant&&this._controllerParticipant.participant===g?this._controllerParticipant.participantId&&this._controllerParticipant.participantId!==S?(this._logger.warn(`rejecting control request from second endpoint. participantId: ${S}`),this._sendControlRejectRequest(3,m)):(this._logger.warn("Got control request for someone already in control"),this._resetControllerParticipant(),this._resetControlRequest({participant:g,participantState:g.state,participantId:S})):g?(this._logger.info(`resetControlRequest for participantId: ${S}`),this._resetControlRequest({participant:g,participantState:g.state,participantId:S})):this._logger.error("Got ControlRequest message but could not find a sender participant, ignoring"):(this._logger.warn("Sharer control is disabled - rejecting request"),this._sendControlRejectRequest(9,m))}_handleAcceptRequest(g,m){if(1===this.controlState){const S=this._sendRequest({action:5,terminatedReason:0},m);this._logger.info(`_handleAcceptRequest controlMessage.action: ${toControlActionString(g.action)} _sendRequest isSent: ${S}`),S?(this._setupViewerRemoteControl(),this.controlState=4,this._requestControlPromise?this._requestControlPromise.resolve():this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${toControlActionString(g.action)}`),this._recordViewerSessionTelemetry((g=>{g.recordOperationSuccess("ControlRequest",null)}))):this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control is accepted, but failed to send ack"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)} action=${toControlActionString(g.action)}`),this._cancelRequestControlTimer()}else this._logger.warn(`AcceptRequest message received in controlState=${toControlStateString(this.controlState)}`)}_handleRejectRequest(g){if(1===this.controlState){this._logger.info(`_handleRejectRequest: controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(0)}`),this.controlState=0;const m={inControl:!1,id:vs,terminatedReason:g.terminatedReason};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:m,details:""}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${toControlActionString(g.action)}`),this._recordViewerSessionTelemetry((m=>{m.recordOperationFailure("ControlRequest",{reason:toControlTerminatedReason(g.terminatedReason)})})),this._cancelRequestControlTimer()}else this._logger.warn(`RejectRequest message received in controlState=${toControlStateString(this.controlState)} reason=${g.terminatedReason}`)}_handleCancelControlRequest(g,m){if(this._logger.info(`_handleCancelControlRequest action=${toControlActionString(g.action)} sender=${m}, controlRequest participantId: ${this._controlRequest.participantId}, controlRequest participantState: ${this._controlRequest.participantState}:`),this._controlRequest){const S=this._controlRequest;this._logger.info(`_handleCancelControlRequest action=${toControlActionString(g.action)} sender=${m}, about to raise: _raiseControlRequestCanceled state: ${this._controlRequest.participantState} `),this._recordSharerSessionTelemetry((g=>{g.recordOperationTimeout("ControlRequest",{participantId:m},String(m))})),this._clearControlRequest(),this._raiseControlRequestCanceled(S)}}_handleGiveControl(g,m,S){const v=this._sendRequest({action:5,terminatedReason:0},m);if(this._logger.info(`_handleGiveControl: controlMessage.action: ${toControlActionString(g.action)} _sendRequest isSent: ${v}`),v){this._setupViewerRemoteControl(),this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(4)}`),this.controlState=4,this._recordViewerSessionTelemetry((g=>{g.recordEvent("ControlGiven",{sender:m})}));const S={inControl:!0,id:vs,terminatedReason:g.terminatedReason};this.event("sharingControlChanged").raise(S)}}_handleAck(g,m,S){if(2===this.controlState)if(this._controllerParticipant&&this._controllerParticipant.participant===m){const m=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);S!==m&&this._logger.warn(`acknowledging source id: ${S} does not match requesting source id: ${m}`),this._logger.info(`Setting up remote control for controller source id=${m}`),this._setupSharerRemoteControl(m),this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(3)}`),this.controlState=3;const v={inControl:!0,id:this._controllerParticipant.participant.id,terminatedReason:g.terminatedReason};this.event("sharingControlChanged").raise(v),this._grantControlPromise?(this._grantControlPromise.resolve(),this._cancelGrantControlTimer(),this._recordSharerSessionTelemetry((g=>{g.recordOperationSuccess("GiveControl",{participantId:m})}))):this._acceptControlPromise?(this._acceptControlPromise.resolve(),this._cancelAcceptControlTimer(),this._recordSharerSessionTelemetry((g=>{g.recordOperationSuccess("ControlRequest",{participantId:m},String(m))}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForControlAck action=${toControlActionString(g.action)}`)}else m?this._logger.warn(`Ignoring ack from participant that does not match controller id=${scrubMriOrOmit(m.id)}`):this._logger.warn(`Ignoring ack from null participant source id=${S}`);else 5===this.controlState?(this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(0)}`),this.controlState=0,this._resetControllerParticipant(),this._terminateControlPromise?(this._terminateControlPromise.resolve(),this._cancelTerminateControlTimer()):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck action=${toControlActionString(g.action)}`)):this._logger.warn(`Unexpected ack in control controlState=${toControlStateString(this.controlState)}`)}_handleTerminate(g,m,S){let v;this._isViewing()?(this._teardownViewerRemoteControl(),v=vs):(this._teardownSharerRemoteControl(),m?v=m.id:this._logger.error("Got terminate message but could not find a sender participant!")),this._logger.info(`controlMessage action: ${toControlActionString(g.action)}, controllerId: ${v}`),this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(0)}`),this.controlState=0,this._resetControllerParticipant();const C={inControl:!1,id:v,terminatedReason:g.terminatedReason};this.event("sharingControlChanged").raise(C),8===g.action&&this._sendRequest({action:5,terminatedReason:0},S)}_handleAvailableAck(g){this._terminateAvailableHandshake&&(this._logger.info(`_handleAvailableAck: terminate available handshake reason: 1,handshakeId: ${g.handshakeId}`),this._terminateAvailableHandshake(1,g.handshakeId)),2===this.role?this._raiseScreenSharingControlCapableEvent(!0,vs):this._logger.info(`Ignoring AvailableAck as viewer session is not initialized, role: ${this.role}`)}_handleAvailableNack(g){this._logger.info(`_handleAvailableNack: action=${toControlActionString(g.action)} terminate reason: ${toControlTerminatedReason(g.terminatedReason)}`),this._viewerSessionLastTerminatedReason=g.terminatedReason,this._recordViewerSessionTelemetry((m=>{m.updateOperationData("AvailableHandshake",{nackReason:g.terminatedReason},g.handshakeId)})),10!==g.terminatedReason?(this._terminateAvailableHandshake&&(this._terminateAvailableHandshake(this._getAvailableHandshakeTerminatedFromControlTerminated(g.terminatedReason),g.handshakeId),this._logger.info(`_handleAvailableNack: terminateAvailableHandshake reason=${toControlTerminatedReason(g.terminatedReason)}`)),1===g.terminatedReason?(this._logger.warn("_handleAvailableNack: control terminate reason: SharerDenied"),this._raiseScreenSharingControlCapableEvent(!0,vs,!0)):this._raiseScreenSharingControlCapableEvent(!1,vs)):this._logger.warn("_handleAvailableNack: control terminate reason: UnknownSender")}_handleRenderedAtViewer(g,m){this._raiseRenderedAtViewer&&(m?(this._logger.info(`raiseRenderedAtViewer senderId=${m.id}, action=${toControlActionString(g.action)}`),this._raiseRenderedAtViewer(m.id)):this._logger.error("Got RenderedAtViewer message but could not find a sender participant!"))}_processProtocolMessage(g,m,S,v){let C;this._recordProtocolMessage(m,v);try{C=JSON.parse(g)}catch(g){return void this._logger.error("Error parsing controlMessage")}switch(m||this._logger.warn(`protocol message from unknown sender with sourceId=${v}`),this._logger.info(`_processProtocolMessage action=${toControlActionString(C.action)}, sourceId=${v}`),C.action){case 0:this._handleAvailableRequest(C,m,v);break;case 1:this._handleControlRequest(m,v,S);break;case 3:this._handleAcceptRequest(C,v);break;case 4:this._handleRejectRequest(C);break;case 2:this._handleCancelControlRequest(C,v);break;case 6:this._handleGiveControl(C,v,m);break;case 5:this._handleAck(C,m,v);break;case 8:case 7:this._handleTerminate(C,m,v);break;case 9:this._handleAvailableAck(C);break;case 10:this._handleAvailableNack(C);break;case 11:this._handleRenderedAtViewer(C,m);break;default:this._logger.error(`Unknown request action received on control protocol data sink, action=${toControlActionString(C.action)}`)}}_getAvailableHandshakeTerminatedFromControlTerminated(g){switch(g){case 10:return 6;case 1:return 7;default:return 0}}_sendRequest(g,m){if(m<0)return this._logger.warn(`Unexpected: invalid sourceID=${m}`),!1;this._logger.info(`_sendRequest() action=${toControlActionString(g.action)} recipient sourceid=${m}`);const S={type:0,message:JSON.stringify(g)},v=[m];return this._dataChannelAdapter.sendProtocolMessage(stringToBuffer(JSON.stringify(S)),v),!0}async processControlMessage(g,m){if(m===this._controllerSourceId){if(3===this.controlState)return this._processControlMessage(g,m);this._logger.debug(`Ignoring control message, wrong controlState. Expected: RemoteControlling, got: ${toControlStateString(this.controlState)}`)}else this._logger.debug(`Ignoring control message, wrong sourceId. Expected: ${m}, got: ${this._controllerSourceId}`)}_processControlMessage(g,m){return this._controlInjector.injectRawInput(g,m)}_resetControlState(){this._logger.info("_resetControlState()"),this.controlState=0,this._resetControllerParticipant(),this._sharerParticipant=null,this._clearControlRequest(),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer()}_setupSharerRemoteControl(g){this._logger.info(`_setupSharerRemoteControl() sourceId=${g}`),this._controllerSourceId=g,this._controlInjector.showVirtualCursor(g).catch((m=>{const S={reason:3,detail:JSON.stringify({sourceId:g,errorMsg:m})};this.event("sharingControlError").raise(S)}))}_teardownSharerRemoteControl(){this._logger.info("_teardownSharerRemoteControl()"),this._controllerSourceId=null,this._controlInjector.showVirtualCursor(0).catch((g=>{const m={reason:3,detail:JSON.stringify({sourceId:0,errorMsg:g})};this.event("sharingControlError").raise(m)}))}_setupViewerRemoteControl(){this._logger.info("_setupViewerRemoteControl()"),this._setCapturerMode(3)}_teardownViewerRemoteControl(){this._logger.info("_teardownViewerRemoteControl()"),this._setCapturerMode(0)}_clearCapturerEventSubscriptions(){this._logger.info("_clearCapturerEventSubscriptions()"),this._captureEventSubscription&&(this._captureEventSubscription.dispose(),this._captureEventSubscription=null),this._mouseControlEventSubscription&&(this._mouseControlEventSubscription.dispose(),this._mouseControlEventSubscription=null),this._keyboardControlEventSubscription&&(this._keyboardControlEventSubscription.dispose(),this._keyboardControlEventSubscription=null)}sendRemoteControlEvent(g,m){if(m)switch(g){case"mouseControlEvent":this._sendControlEvent(Kr.encodeMouseEvent(m));break;case"keyboardControlEvent":this._sendControlEvent(Kr.encodeKeyboardEvent(m));break;default:return void this._logger.error("sendRemoteControlEvent: Invalid type=",g)}else this._logger.error("sendRemoteControlEvent: Invalid argument.")}_sendControlEvent(g){if(!this._isDataChannelActive()||!this._sharerParticipant||4!==this.controlState)return void this._logger.error(`_sendControlEvent: Dropping message - No data channel or wrong controlState. dataConnected: ${this._isDataChannelActive()} controlState: ${toControlStateString(this.controlState)})`);const m=[this._getSharerDataSourceId()];this._dataChannelAdapter.sendControlMessage(g,m)}_setCapturerMode(g){this._logger.info(`_setCapturerMode() capturerMode=${g}`),this._controlCapturer?(this._controlCapturer.setCaptureMode(g),this._clearCapturerEventSubscriptions(),1===g?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(g=>{0===g&&this.event("sharingRendererClicked").raise()})):2===g?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(g=>{1===g?this.event("sharingRendererMouseEntering").raise():2===g&&this.event("sharingRendererMouseLeaving").raise()})):3===g&&(this._mouseControlEventSubscription=this._controlCapturer.on("mouseControlEvent",(g=>{this._sendControlEvent(Kr.encodeMouseEvent(g))})),this._keyboardControlEventSubscription=this._controlCapturer.on("keyboardControlEvent",(g=>{this._sendControlEvent(Kr.encodeKeyboardEvent(g))})),this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(g=>{1===g?this.event("sharingRendererMouseEntering").raise():2===g&&this.event("sharingRendererMouseLeaving").raise()})))):this._logger.info("_controlCapturer not set, relying on external controlCapturer")}setPointerImage(g,m){return this._logger.warn("setPointerImage is deprecated. Use setLocalPointerImage or setRemotePointerImage"),g?this.setRemotePointerImage(g,m):this.setLocalPointerImage(m)}setLocalPointerImage(g){return 0===g.length?Promise.reject(new Error("setLocalPointerImage invalid image length")):this._setPointerImage(0,g)}async setRemotePointerImage(g,m){if(!g)throw new Error("setRemotePointerImage participant is null");if(0===m.length)throw new Error("setRemotePointerImage invalid image length");const S=this._getParticipantsDataSourceIds(g);if(0===S.length)throw new Error("setRemotePointerImage unable to map participant to sourceIds");this._logger.info(`set pointer image for ${S.length} sources`);for(const g of S)await this._setPointerImage(g,m)}_setPointerImage(g,m){return this._isSharing()||this._logger.warn("_setPointerImage called when not sharing"),this._controlInjector.setPointerImage(g,m)}startPointerMode(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`startPointerMode called in bad control controlState=${toControlStateString(this.controlState)}`)):this._isViewing()?asap((()=>{this._setCapturerMode(2)})):Promise.reject(new Error("startPointerMode when not viewing")):Promise.reject(new Error("startPointerMode when data channel not active")):Promise.reject(new Error("startPointerMode when feature not enabled"))}stopPointerMode(){return 0!==this.controlState?Promise.reject(new Error(`stopPointerMode called in bad control controlState=${toControlStateString(this.controlState)}`)):this._isViewing()?asap((()=>{this._setCapturerMode(1)})):Promise.reject(new Error("stopPointerMode when not viewing"))}_startAvailableHandshake(){const g=this._getSharerDataSourceId(),m=generateGuid(),S=this._getHandshakeDelay(),v=Math.floor(Math.random()*S);if(this._logger.info(`_startAvailableHandshake() - handshakeId: ${g}:${m} ${v>0?`delay: ${v}ms maxDelay: ${S}ms`:""}}`),this._terminateAvailableHandshake&&(this._logger.warn("Replacing existing availble handshake"),this._terminateAvailableHandshake(4)),this._recordViewerSessionTelemetry((g=>g.recordOperation("AvailableHandshake",m))),g<0)this._logger.warn(`_startAvailableHandshake() - sharer: ${scrubMriOrOmit(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(m);else{const sendAvailableHandshake=()=>{this.event("controlAvailableHandshake").raise(m,g,1);this._sendRequest({action:0,terminatedReason:0,handshakeId:m},g)||this._logger.error("Failed to send Available message to sharer, will retry after backoff"),this._waitForAvailableAck(m)};v>0?(this._delayedSendHandshakeTimer=window.setTimeout(sendAvailableHandshake,v),this._recordViewerSessionTelemetry((g=>{g.updateOperationData("AvailableHandshake",{delay:v,maxDelay:S},m)}))):sendAvailableHandshake()}this._availableHandshakeSent=!0,this._terminateAvailableHandshake=(S=0,v)=>{this._logger.info(`_terminateAvailableHandshake() - handshakeId: ${g}:${m}, status: ${S}`),this._recordViewerSessionTelemetry((g=>{g.updateOperationData("AvailableHandshake",{tries:this._retryAttempt},v)})),1===S?this._recordViewerSessionTelemetry((g=>{g.recordOperationSuccess("AvailableHandshake",null,"",v)})):(this._logger.error(`GTC handshake terminated with code ${S}, last terminated reason: ${toControlTerminatedReason(this._viewerSessionLastTerminatedReason)}`),gs.RootToolsManager.logExternalForDDL(`GTC handshake terminated with code ${S},`,this._viewerSessionLastTerminatedReason.toString()),this._recordViewerSessionTelemetry((g=>{g.recordOperationFailure("AvailableHandshake",{reason:S},"",v)}))),this._terminateAvailableHandshake=null,this.event("controlAvailableHandshake").raise(m,g,1===S?5:6,S),v&&v!==m&&this._logger.warn(`AvailableSeries: Got handshake from another series - expected: ${m}, received: ${v}`),this._availableAckTimer&&(clearTimeout(this._availableAckTimer),this._availableAckTimer=null),this._delayedSendHandshakeTimer&&(clearTimeout(this._delayedSendHandshakeTimer),this._delayedSendHandshakeTimer=null),this._retryAttempt=0}}_waitForAvailableAck(g){this._logger.info("_waitForAvailableAck()"),this._availableAckTimer=window.setTimeout((()=>{this._logger.warn(`No Ack received for Available message from attempt=${this._retryAttempt}`),this._availableAckTimer=null;const m=this._getSharerDataSourceId();if(this._retryAttempt<=Ss)m>=0?(this._logger.info(`Re-sending Available message handshakeId: ${m}:${g}`),this.event("controlAvailableHandshake").raise(g,m,2),this._sendRequest({action:0,terminatedReason:0,handshakeId:g},m)):this._logger.warn(`_waitForAvailableAck() - sharer: ${scrubMriOrOmit(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(g);else if(this._logger.error("Reached Available retry limit! Control capability will be false"),this._terminateAvailableHandshake)this._terminateAvailableHandshake(5);else{const g={reason:4,detail:JSON.stringify({sourceId:m,errorMsg:`Timed out after ${this._retryAttempt} tries`})};this.event("sharingControlError").raise(g)}}),fs*++this._retryAttempt)}requestControl(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`requestControl called in bad controlState=${toControlStateString(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?Promise.reject(new Error("request control promise has not been resolved yet while requesting control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while requesting control")):this._requestControl():Promise.reject(new Error("requestControl unexpected null sharer")):Promise.reject(new Error("requestControl when not viewing")):Promise.reject(new Error("requestControl when data channel not active")):Promise.reject(new Error("requestControl when feature not enabled"))}_requestControl(){this._logger.info(`_requestControl(), controlState: ${this.controlState}`),this._requestControlPromise=defer();const always=()=>{this._requestControlPromise=null};this._requestControlPromise.promise.then(always,always);const g=this._getSharerDataSourceId();if(!this._sendRequest({action:1,terminatedReason:0},g)){const g={inControl:!1,id:vs,terminatedReason:7};return this._requestControlPromise.reject(new Error),this._logger.error("_requestControl(): failed to send the request."),Promise.reject(new Error(JSON.stringify({controlInfo:g,details:""})))}return this._recordViewerSessionTelemetry((g=>g.recordOperation("ControlRequest",""))),this.controlState=1,this._requestControlTimer=window.setTimeout((()=>{if(1===this.controlState){this.controlState=0,this._logger.warn("No response to control request - canceling");this._sendRequest({action:2,terminatedReason:2},g)||this._logger.error("Failed to send the cancel control request");const m={inControl:!1,id:vs,terminatedReason:2};this._recordViewerSessionTelemetry((g=>{g.recordOperationTimeout("ControlRequest",null)})),this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:m,details:"we did not get any response to the control - terminating control"}))):this._logger.error("Unexpected, no promise could be resolved - controlState=RequestSent")}else this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control - times out in bad state - do nothing"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._requestControlTimer=null}),ps),this._requestControlPromise.promise}_cancelRequestControlTimer(){this._requestControlTimer&&(this._requestControlPromise&&this._requestControlPromise.reject(new Error("cancelled by _cancelRequestControlTimer")),clearTimeout(this._requestControlTimer),this._requestControlTimer=null)}cancelControl(){return this._enabled?this._isDataChannelActive()?1!==this.controlState?Promise.reject(new Error(`cancelControl called in bad state=${toControlStateString(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while cancelling control")):this._cancelControl():Promise.reject(new Error("Request control promise has been resolved while cancelling control")):Promise.reject(new Error("cancelControl unexpected null sharer")):Promise.reject(new Error("cancelControl when not viewing")):Promise.reject(new Error("cancelControl when data channel not active")):Promise.reject(new Error("cancelControl when feature not enabled"))}_cancelControl(){this._logger.info("_cancelControl()");const g=this._getSharerDataSourceId();if(1!==this.controlState)return Promise.reject(new Error("Cancel control - in bad state - do nothing"));this._cancelRequestControlTimer(),this.controlState=0,this._logger.info("Viewer cancels the control");if(!this._sendRequest({action:2,terminatedReason:8},g))return Promise.reject(new Error("Failed to send cancel control request"));{const g={inControl:!1,id:vs,terminatedReason:8};this._recordViewerSessionTelemetry((m=>{m.recordOperationFailure("ControlRequest",{reason:toControlTerminatedReason(g.terminatedReason)})})),this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:g,details:""})))}return new Promise(((g,m)=>{g()}))}acceptControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while accepting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while accepting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while accepting control")):this._acceptControlRequest():Promise.reject(new Error("acceptControlRequest when not sharing")):Promise.reject(new Error("acceptControlRequest while no control request pending")):Promise.reject(new Error("acceptControlRequest when data channel not active")):Promise.reject(new Error("acceptControlRequest when feature not enabled"))}_acceptControlRequest(){this._logger.info("_acceptControlRequest()"),this._acceptControlPromise=defer();const always=()=>{this._acceptControlPromise=null};if(this._acceptControlPromise.promise.then(always,always),this._controllerParticipant){this._logger.warn("_acceptControlRequest called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const g=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},g)||this._logger.error("Failed to send the terminateNoAck request"),this._resetControllerParticipant()}const g=this._getDataSourceIdForParticipantLeg(this._controlRequest),m=this._controlRequest.participant.id;return this._sendControlAcceptRequest(g)?(this._resetControllerParticipant(this._controlRequest),this._clearControlRequest(),this.controlState=2,this._acceptControlTimer=window.setTimeout((()=>{if(2===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._recordSharerSessionTelemetry((m=>{m.recordOperationTimeout("ControlRequest",{participantId:g},String(g))})),this._logger.error("No ack received when accepting control request - terminating control");this._sendRequest({action:7,terminatedReason:4},g)||this._logger.error("Failed to send the TerminateNoAck request");const S={inControl:!1,id:m,terminatedReason:4};this.event("sharingControlChanged").raise(S),this._acceptControlPromise?this._acceptControlPromise.reject(new Error("No ack received when accept control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")}else this._acceptControlPromise?this._acceptControlPromise.reject(new Error("accept control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._acceptControlTimer=null}),ms),this._acceptControlPromise.promise):(this._logger.error("Failed to send the accept control request"),this._acceptControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the accept control request!")))}_sendControlAcceptRequest(g){const m=this._sendRequest({action:3,terminatedReason:0},g);return this._recordSharerSessionTelemetry((m=>{m.updateOperationData("ControlRequest",{status:"accepting",participantId:g},null,String(g))})),m}_sendControlRejectRequest(g,m){const S=this._sendRequest({action:4,terminatedReason:g},m);return this._recordSharerSessionTelemetry((S=>{S.recordOperationFailure("ControlRequest",{participantId:m,reason:toControlTerminatedReason(g)},String(m))})),S}_cancelAcceptControlTimer(){this._acceptControlTimer&&(this._acceptControlPromise&&this._acceptControlPromise.reject(new Error("cancelled by _cancelAcceptControlTimer")),clearTimeout(this._acceptControlTimer),this._acceptControlTimer=null)}denyControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while denying control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while denying control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while denying control")):this._denyControlRequest():Promise.reject(new Error("denyControlRequest when not sharing")):Promise.reject(new Error("denyControlRequest while no control request pending")):Promise.reject(new Error("denyControlRequest when data channel not active")):Promise.reject(new Error("denyControlRequest when feature not enabled"))}_denyControlRequest(){this._logger.info("_denyControlRequest()");const g=this._getDataSourceIdForParticipantLeg(this._controlRequest);this._clearControlRequest();return this._sendControlRejectRequest(1,g)?Promise.resolve():Promise.reject(new Error("Failed to send the deny control requst"))}grantControl(g){return this._enabled?this._isDataChannelActive()?this._controlRequest?Promise.reject(new Error("grantControl called while control request pending")):this._isSharing()?g?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while granting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while granting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while granting control")):this._grantControl(g):Promise.reject(new Error("grantControl null participant")):Promise.reject(new Error("grantControl when not sharing")):Promise.reject(new Error("grantControl when data channel not active")):Promise.reject(new Error("grantControl when feature not enabled"))}_grantControl(g){this._logger.info("_grantControl()"),this._grantControlPromise=defer();const always=()=>{this._grantControlPromise=null};if(this._grantControlPromise.promise.then(always,always),3===this.controlState){if(this._controllerParticipant.participant===g)return this._logger.warn("_grantControl called for participant who already has control"),this._grantControlPromise.resolve(),new Promise(((g,m)=>{g()}));{this._logger.warn("_grantControl called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const g=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},g)||this._logger.error("Failed to send the terminateNoAck request")}}const m=this._mapParticipantToSourceId(g),S=this._sendRequest({action:6,terminatedReason:0},m);if(this._recordSharerSessionTelemetry((g=>{g.recordOperation("GiveControl",null)})),!S)return this._logger.error("Failed to send the grant control request"),this._grantControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));const v=this._getParticipantIdForDataSourceId(g,m);return this._resetControllerParticipant({participant:g,participantState:g.state,participantId:v}),this.controlState=2,this._grantControlTimer=window.setTimeout((()=>{if(2===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when granting control - terminating control");this._sendRequest({action:7,terminatedReason:4},m)||this._logger.error("Failed to send the terminateNoAck request"),this._recordSharerSessionTelemetry((g=>{g.recordOperationTimeout("GiveControl",null)})),this._grantControlPromise?this._grantControlPromise.reject(new Error("No ack received when granting control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")}else this._grantControlPromise?this._grantControlPromise.reject(new Error("Grant control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._grantControlTimer=null}),ms),this._grantControlPromise.promise}_cancelGrantControlTimer(){this._grantControlTimer&&(this._grantControlPromise&&this._grantControlPromise.reject(new Error("cancelled by _cancelGrantControlTimer")),clearTimeout(this._grantControlTimer),this._grantControlTimer=null)}_mapParticipantToSourceId(g){return this._dataChannelAdapter.isActive()?getSourceIdForMediaType(g,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getParticipantsDataSourceIds(g){const m=[];try{if(g?.endpoints?.endpointDetails){if(1===g.endpoints.endpointDetails.length){const S=g.endpoints.endpointDetails[0];if(!S?.mediaStreams)return m.push(Xt),m}for(const S of g.endpoints.endpointDetails)if(S?.mediaStreams)for(const g of S.mediaStreams)if(3===mapMediaTypeStringToMediaType(g.type)){if(m.push(g.sourceId),m.length>=8)return this._logger.error("Excessive amount of data streams"),m;break}}}catch(g){this._logger.error(`_getParticipantsDataSourceIds caught exception error=${g}`)}return m}_getParticipantIdForDataSourceId(g,m){return getParticipantIdForSourceId(g,3,m)}_getDataSourceIdForParticipantId(g,m){return this._dataChannelAdapter.isActive()?getSourceId(g,m,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getDataSourceIdForParticipantLeg(g){return this._getDataSourceIdForParticipantId(g.participant,g.participantId)}_getSharerDataSourceId(){const g=getSharingParticipantLeg(this._sharerParticipant);return g?this._getDataSourceIdForParticipantId(this._sharerParticipant,g):(this._logger.warn("Unable to identify the sharer participantId, falling back to first data channel"),this._mapParticipantToSourceId(this._sharerParticipant))}terminateControl(){if(this._isViewing()){if(4!==this.controlState)return Promise.reject(new Error("terminateControl called while not in control"));if(!this._sharerParticipant)return Promise.reject(new Error("terminateControl called but _sharerParticipant is null"))}else{if(!this._isSharing())return Promise.reject(new Error("terminateControl called but not sharing nor viewing"));if(!this._controllerParticipant)return Promise.reject(new Error("terminateControl called but controllerParticipant is null"))}return this._requestControlPromise?Promise.reject(new Error("Request control promise has not been resolved yet while terminating control")):this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while terminating control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while terminating control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while terminating control")):this._terminateControl()}_terminateControl(g=!0){this._logger.info("_terminateControl()"),this._terminateControlPromise=defer();const always=()=>{this._terminateControlPromise=null};this._terminateControlPromise.promise.then(always,always);let m=0;const S=g?8:7;let v,C;if(this._isViewing()){if(4!==this.controlState)return this._logger.error("Local viewer called terminateControl when not controlling"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local viewer called terminateControl when not controlling"));this._teardownViewerRemoteControl(),m=6,v=this._getSharerDataSourceId(),C=vs,this._logger.info(`Terminating remote control reason: ${m},  recipient: ${v}, controllerId: ${C}`)}else{if(3!==this.controlState||!this._controllerParticipant)return this._logger.error("Local sharer called terminateControl when no one is in control"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local sharer called terminateControl when no one is in control"));this._teardownSharerRemoteControl(),m=5,v=this._getDataSourceIdForParticipantLeg(this._controllerParticipant),C=this._controllerParticipant.participant.id,this._logger.info(`Terminating control on the sharer side, reason: ${m}, recipient: ${v}, controllerId: ${C}`)}if(!this._sendRequest({action:S,terminatedReason:m},v)){if(g)return this._logger.error("Failed to send the terminate control request"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));this._logger.error("Failed to send the terminateNoAck request")}this.controlState=g?5:0;const _={inControl:!1,id:C,terminatedReason:m};return this._logger.info(`raising event sharingControlChanged reason=${_.terminatedReason} controlState=${this.controlState}`),this.event("sharingControlChanged").raise(_),g?(this._terminateControlTimer=window.setTimeout((()=>{if(5===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when terminating control - resending terminate request");this._sendRequest({action:7,terminatedReason:4},v)||this._logger.error("Failed to send the terminateNoAck request"),this._terminateControlPromise?this._terminateControlPromise.reject(new Error("No ack received when terminating control - resending terminate request")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck")}else this._terminateControlPromise?this._terminateControlPromise.reject(new Error("terminate control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._terminateControlTimer=null}),ms),this._terminateControlPromise.promise):(this._terminateControlPromise.resolve(),new Promise(((g,m)=>{g()})))}_cancelTerminateControlTimer(){this._terminateControlTimer&&(this._terminateControlPromise&&this._terminateControlPromise.reject(new Error("cancelled by _cancelTerminateControlTimer")),clearTimeout(this._terminateControlTimer),this._terminateControlTimer=null,this._logger.info("_cancelTerminateControlTimer()"))}_disposeControlCapturer(g=generateCauseId()){this._logger.info(`_disposeControlCapturer causeId: ${g}`),this._clearCapturerEventSubscriptions(),this._controlCapturer&&(this._controlCapturer.dispose(g),this._controlCapturer=null)}dispose(g){this._logger.info(`dispose causeId: ${g}`),this._dataChannelAdapter.dispose(g),this._resetControlState(),this._disposeRenderer(g),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer(),this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._call=null,this._resetParticipantSubscriptions(),this._finalizeViewerSessionTelemetry("Shutdown"),this._finalizeSharerSessionTelemetry("Shutdown"),super.dispose(g)}};function toControlActionString(g){switch(g){case 0:return"Available";case 1:return"ControlRequest";case 2:return"CancelControlRequest";case 3:return"AcceptRequest";case 4:return"RejectRequest";case 5:return"Ack";case 6:return"GiveControl";case 7:return"TerminateNoAck";case 8:return"Terminate";case 9:return"AvailableAck";case 10:return"AvailableNack";case 11:return"RenderedAtViewer";default:return"Unknown"}}function toControlStateString(g){switch(g){case 0:return"None";case 1:return"RequestSent";case 2:return"WaitingForControlAck";case 3:return"RemoteControlling";case 4:return"LocalControlling";case 5:return"WaitingForTerminateAck";default:return"Unknown"}}function toControlTerminatedReason(g){switch(g){case 0:return"None";case 1:return"SharerDenied";case 2:return"SharerNoResponse";case 3:return"SharerBusy";case 4:return"AckTimeout";case 5:return"SharerTerminated";case 6:return"ViewerTerminated";case 7:return"DataChannelError";case 8:return"ViewerCancelled";case 9:return"SharerControlDisabled";case 10:return"UnknownSender";default:return"Unknown"}}var Ts=(g=>(g[g.LEFT=0]="LEFT",g[g.RIGHT=1]="RIGHT",g[g.MIDDLE=2]="MIDDLE",g[g.BACK=3]="BACK",g[g.FORWARD=4]="FORWARD",g))(Ts||{}),Is=(g=>(g[g.SCAN_CODE=0]="SCAN_CODE",g[g.VIRTUAL_KEY=1]="VIRTUAL_KEY",g[g.RECOGNITION_INPUT=2]="RECOGNITION_INPUT",g))(Is||{}),bs=class{constructor(g){this.logger=g}toEdgeControlMouseEvent(g){let m;switch(g.type){case 0:return{event:this.toMouseMoveEvent(g),apiName:"injectMouseMoveEvent"};case 1:return{event:this.toMouseWheelEvent(g),apiName:"injectMouseWheelEvent"};case 2:return{event:this.toMouseButtonPressedEvent(g),apiName:"injectMouseButtonEvent"};default:throw m=`Uncovered mouse control event type. Event: ${g}`,this.logger.error(m),Error(m)}}toEdgeControlKeyboardEvent(g){return{event:{repeat:g.repeat,keyUp:g.keyUp,codeType:Is[g.codeType],keyCode:g.code},apiName:"injectKeyEvent"}}toMouseMoveEvent(g){return{xPos:g.xPos,yPos:g.yPos}}toMouseWheelEvent(g){return{wheelButtonDown:g.wheelButtonDown,wheelRotation:g.wheelRotation}}toMouseButtonPressedEvent(g){return{xPos:g.xPos,yPos:g.yPos,button:Ts[g.buttonType],buttonDown:g.buttonDown}}};async function pngBase64ToBitmap(g,m,S){return new Promise(((v,C)=>{const _=Buffer.from(g,"base64"),E=document.createElement("canvas").getContext("2d"),T=new Blob([_],{type:"image/png"});let I=new Image;I.onload=()=>{E.drawImage(I,0,0,I.width,I.height,0,0,m,S);const g=E.getImageData(0,0,m,S);window.URL.revokeObjectURL(I.src),I=null,v(Array.from(g.data))},I.onerror=g=>{C(g)},I.src=window.URL.createObjectURL(T)}))}var As="ncbjelpjchkpbikbpkcchkhkblodoama",Rs=class{constructor(g){this.logger=g}async sendInjectInputEventMessage(g,m){return this.logger.info("EdgeControlInjectorApi - sendInjectInputEventMessage"),new Promise(((S,v)=>{window.top.chrome.runtime.sendMessage(As,{api:g,deviceId:this.virtualInputDeviceId,event:m},(g=>{g.error?v(g.error.message):S(0)}))}))}async createInputDeviceId(g,m,S){this.virtualInputDeviceId&&this.logger.warn("EdgeControlInjectorApi - createInputDeviceId virtual input already exists.");try{this.virtualInputDeviceId=await this.sendCreateInputDeviceMessage(g,S)}catch(g){this.logger.error(`EdgeControlInjectorApi - createInputDevice failed, error: ${JSON.stringify(g)}`),m()}}async sendSetLocalUserAvatarMessage(g){const m=await this.generateAvatarBitmap(g);return new Promise(((g,S)=>{const v=window.top;m&&v.chrome.runtime.sendMessage(As,{api:"setLocalUserAvatar",avatarBitmap:m},(m=>{m.error?S(m.error.message):g()}))}))}async sendCloseVirtualInputDeviceMessage(){const g=this.virtualInputDeviceId;return g?(this.logger.info("EdgeControlInjectorApi - sendCloseVirtualInputDeviceMessage called"),new Promise(((m,S)=>{const v=window.top;v.chrome.runtime.sendMessage(As,{api:"closeInputDevice",deviceId:g},(g=>{g?g.error?S(g.error.message):(this.virtualInputDeviceId=null,m(g.deviceId)):S(v.chrome.runtime.lastError.message)}))}))):(this.logger.info("EdgeControlInjectorApi - VirtualInputDevice does not exists, nothing to close."),Promise.resolve())}async sendCreateInputDeviceMessage(g,m){this.logger.info("EdgeControlInjectorApi - sendCreateInputDeviceMessage called");const S=await this.generateAvatarBitmap(m);return new Promise(((m,v)=>{const C=window.top,messageCallback=g=>{g?g.deviceId?m(g.deviceId):g.error?v(g.error.message):v("Error: Unexpected response from API"):v(C.chrome.runtime.lastError.message)};S?C.chrome.runtime.sendMessage(As,{api:"createInputDevice",mediaStreamTrackId:g,avatarBitmap:S},messageCallback):C.chrome.runtime.sendMessage(As,{api:"createInputDevice",mediaStreamTrackId:g},messageCallback)}))}async generateAvatarBitmap(g){if(!g)return null;try{const m=32;return{width:m,height:m,data:await pngBase64ToBitmap(g,m,m)}}catch(g){return this.logger.error(`EdgeControlInjectorApi - generateAvatarBitmap error: ${JSON.stringify(g)}, continue without avatar.`),null}}};async function sendIsVirtualInputSupportedMessage(g){return new Promise(((m,S)=>{g.info("EdgeControlInjectorApi - sendIsVirtualInputSupportedMessage");const v=window.top;v.chrome.runtime.sendMessage(As,{api:"isVirtualInputSupported"},(g=>{g?g.error?m(g.error.message):m(g):S(v.chrome.runtime.lastError?.message)}))}))}var Ps=class{constructor(g,m,S){this.logger=g,this.sharingTrackId=m,this.onInitErrorCallback=S,this.images=new Map,this.controlEventConverter=new bs(g),this.edgeApi=new Rs(this.logger)}showVirtualCursor(g,m){if(this.logger.info(`EdgeControlInjector - showVirtualCursor, id: ${g} sharingTrackId: ${this.sharingTrackId}`),m){this.edgeApi.createInputDeviceId(this.sharingTrackId,this.onInitErrorCallback,this.images[g]);const m=this.images[0];m?this.edgeApi.sendSetLocalUserAvatarMessage(m):this.logger.error("EdgeControllerInjector - local avatar is missing, continue without local avatar")}else this.edgeApi.sendCloseVirtualInputDeviceMessage()}setAvatar(g,m){this.logger.info(`${g} EdgeControlInjector - setAvatar, id: ${g}, data: ${JSON.stringify(m)}`),this.images[g]=m}async injectMouseEvent(g,m){this.logger.info(`${g} EdgeControlInjector - injectMouseEvent ${JSON.stringify(m)}`);const S=this.controlEventConverter.toEdgeControlMouseEvent(m);return this.edgeApi.sendInjectInputEventMessage(S.apiName,S.event)}async injectKeyboardEvent(g,m){const S=this.controlEventConverter.toEdgeControlKeyboardEvent(m);return this.edgeApi.sendInjectInputEventMessage(S.apiName,S.event)}injectClipboardText(g,m){return this.logger.info(`${g} EdgeControlInjector - injectClipboardText is unimplemented`),Promise.resolve(0)}dispose(g){this.logger.info("EdgeControlInjector - dispose"),this.edgeApi.sendCloseVirtualInputDeviceMessage()}},Ms=class{constructor(g){this.logger=g,this.activeSourceId=0,this.edgeVirtualInputSupported=!1,this.pendingPointerImages=new Map,this.logger.info("ControlInjectorAdapter"),"EdgeAnaheim"===getBrowserInfo().name&&sendIsVirtualInputSupportedMessage(g).then((m=>{this.edgeVirtualInputSupported=m,g.info(`ControlInjectorAdapter - Edge supports virtual input device: ${JSON.stringify(this.edgeVirtualInputSupported)}`)})).catch((m=>{g.info(`ControlInjectorAdapter - Edge IsVirtualInputSupported: ${JSON.stringify(m)}`)}))}enableInjector(g){if(this.injector)return this.logger.error("Control injector already present"),Promise.reject();if("EdgeAnaheim"===getBrowserInfo().name){if(!this.edgeVirtualInputSupported)return this.logger.info("ControlInjectorAdapter - Edge doesn't support give control"),Promise.reject();const onInitErrorCallback=()=>(this.disableInjector(),this.logger.error("ControlInjectorAdapter - An error occured, control injector is disabled."),Promise.reject());this.injector=new Ps(this.logger,g,onInitErrorCallback),this.logger.info("ControlInjectorAdapter - Edge ControlInjector created")}else window.ControlInjector&&(this.injector=window.ControlInjector(g),this.logger.info("ControlInjectorAdapter - Window ControlInjector created"));return this.pendingPointerImages.forEach(((g,m)=>{this.injector.setAvatar(m,g)})),this.pendingPointerImages.clear(),Promise.resolve()}disableInjector(){return this.injector?(this.logger.info("ControlInjectorAdapter - ControlInjector disposed"),this.injector.dispose(),this.injector=null,Promise.resolve()):(this.logger.error("Control injector not present"),Promise.reject())}setPointerImage(g,m){return this.injector?new Promise((S=>{this.injector.setAvatar(g,m),S()})):(this.pendingPointerImages.set(g,m),Promise.resolve())}showVirtualCursor(g){return this.logger.info(`ControlInjectorAdapter - showVirtualCursor ${g} ${this.activeSourceId}`),this.injector?new Promise((m=>{g?(this.activeSourceId&&this.injector.showVirtualCursor(this.activeSourceId,!1),this.injector.showVirtualCursor(g,!0),this.activeSourceId=g):this.activeSourceId&&(this.injector.showVirtualCursor(this.activeSourceId,!1),this.activeSourceId=0),m()})):(this.logger.error("Control injector not present"),Promise.reject())}injectRawInput(g,m){if(!this.injector)return this.logger.error("Control injector not present"),Promise.reject();const S=this.injector;return new Promise(((v,C)=>{let _,E;const T=Kr.decodeEventType(g);switch(T){case 1:_=Kr.decodeMouseEvent(g),S.injectMouseEvent(m,_).then((g=>0===g?v():C()));break;case 0:E=Kr.decodeKeyboardEvent(g),S.injectKeyboardEvent(m,E).then((g=>0===g?v():C()));break;default:this.logger.error(`Invalid event type in raw input: ${T}`),C()}}))}canBeEnabled(){return"EdgeAnaheim"===getBrowserInfo().name?this.edgeVirtualInputSupported:!!window.ControlInjector}},ws=class{constructor(g){this.logger=g,this.logger.info("RendererAdapter")}getTarget(g){return g.target}subscribeVideoSizeChangedEvent(g,m){const S=g;return S.streamSize&&m(S.streamSize.width,S.streamSize.height),S.renderer.on("onVideoSizeChanged",m)}subscribeRenderStartedEvent(g,m){return g.renderer.on("onVideoStarted",((g,S)=>m()))}};function bufferToString(g){return String.fromCharCode.apply(null,g)}var Ds=class extends Ge{constructor(g,m){super(g),this.logger=g,this._call=m}isActive(){return!(!this.protocolSendFunc||!this.controlSendFunc)}sendProtocolMessage(g,m){return this.protocolSendFunc?this.protocolSendFunc(g,m):(this.logger.error("Cannot send protocol message, ProtocolHandler hasn't started"),Promise.resolve())}sendControlMessage(g,m){return this.controlSendFunc?this.controlSendFunc(g,m):(this.logger.error("Cannot send control message, ControlHandler hasn't started"),Promise.resolve())}getProtocolHandler(){return{onStarted:async(g,m)=>{this.logger.info(`ProtocolHandler started for ${g}`),this.protocolSendFunc=m,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async g=>{this.logger.info(`ProtocolHandler stopped for ${g}`);const m=this.isActive();this.protocolSendFunc=null,m&&this.event("stateChange").raise(!1)},onDataReceived:async(g,m,S)=>{if(1===g){const g=JSON.parse(bufferToString(m)),v=this._call.mapDataChannelSourceIdToParticipant(S);let C;return v&&(C=getParticipantIdForSourceId(v,3,S)),this.event("protocolMessage").raise(g.message,v,C,S)}}}}getControlHandler(){return{onStarted:async(g,m)=>{this.logger.info(`ControlHandler started for ${g}`),this.controlSendFunc=m,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async g=>{this.logger.info(`ControlHandler stopped for ${g}`);const m=this.isActive();this.controlSendFunc=null,m&&this.event("stateChange").raise(!1)},onDataReceived:async(g,m,S)=>{if(2===g)return this.event("controlMessage").raise(m,S)}}}},Os=class extends Es{constructor(g,m,S,v,C){const _={};try{const g=C.getEcsConfig("SkypeCalling","gtcHandshakeSendDelay");g&&(_.handshakeSendDelay=JSON.parse(g))}catch(m){g.error(`Failed to parse ecs config gtcAvailableAckDelay: ${stringifyObject(m)}`)}super(g.createChild("ScreenSharingControl"),S,v,_),this.dataChannel=m;const E=new Ms(this._logger),T=new ws(this._logger),I=new Ds(this._logger,S);this.setAdapters(E,T,I)}setupDataHandlers(){this.dataChannel.addHandler(1,this.getProtocolHandler()),this.dataChannel.addHandler(2,this.getControlHandler())}startOrStopControlForViewer(g,m,S){g&&"nonInteractive"!==S?.appliedInteractivityLevel?m&&0===this.role&&this.initControlForViewer(m):2===this.role&&this.shutdownControlForViewer()}getProtocolHandler(){return this._dataChannelAdapter.getProtocolHandler()}getControlHandler(){return this._dataChannelAdapter.getControlHandler()}};function createParticipantListFromMriMap(g){const m=[];for(const S in g)if(g[S].participantLegIdMap)for(const v in g[S].participantLegIdMap){const C=g[S].participantLegIdMap[v].endpointId;m.push({id:S,mri:S,participantId:v,...C&&{endpointId:C}})}else m.push({id:S,mri:S});return m}function mapParticipantScope(g){switch(g){case 1:return"specified";case 0:return"all";case 3:return"attendees";case 2:return"presenters";case 4:return"self";default:return"none"}}var Ns={};__export(Ns,{addReceiveDirectionality:()=>addReceiveDirectionality,allowDataChannel:()=>allowDataChannel,allowProvisionalAnswer:()=>allowProvisionalAnswer,areNegotiatedDirectionsAcceptable:()=>areNegotiatedDirectionsAcceptable,areNegotiatedDirectionsFulfilled:()=>areNegotiatedDirectionsFulfilled,areSendDirectionsFulfilled:()=>areSendDirectionsFulfilled,canUseWebrtc1_0:()=>canUseWebrtc1_0,convertToCodecInfo:()=>convertToCodecInfo,getAllowedCodecs:()=>getAllowedCodecs,getSendMediaModalities:()=>getSendMediaModalities,getSimulcastConfigForMediaType:()=>getSimulcastConfigForMediaType,getSrtpInfo:()=>getSrtpInfo,hasReceiveDirectionality:()=>hasReceiveDirectionality,hasSendDirectionality:()=>hasSendDirectionality,invertModalities:()=>invertModalities,ipAddressConverter:()=>ipAddressConverter,ipV4RegExp:()=>Bs,ipV6RegExp:()=>Hs,ipv4AddressConverter:()=>ipv4AddressConverter,ipv6AddressConverter:()=>ipv6AddressConverter,isOnHold:()=>isOnHold,isSendModalityAdded:()=>isSendModalityAdded,isVersionGreaterOrEqual:()=>isVersionGreaterOrEqual,makeReinvitelessContext:()=>makeReinvitelessContext,mediaTypeToModality:()=>mediaTypeToModality,mergeSendModalities:()=>mergeSendModalities,modalityToMediaType:()=>modalityToMediaType,negotiateDirectionality:()=>negotiateDirectionality,negotiateModalities:()=>negotiateModalities,parseCandidateString:()=>parseCandidateString,preferSdesSrtp:()=>preferSdesSrtp,printMediaStream:()=>printMediaStream,removeChangedSendDirection:()=>removeChangedSendDirection,removeSendDirectionality:()=>removeSendDirectionality,scrubConstraints:()=>scrubConstraints,scrubDevices:()=>scrubDevices,scrubObjectExcludingFields:()=>scrubObjectExcludingFields,scrubObjectFields:()=>scrubObjectFields,scrubSelectedDevices:()=>scrubSelectedDevices,sendStreamsToModalities:()=>sendStreamsToModalities});var ks,Ls,Fs="undefined"!=typeof navigator&&void 0!==navigator.mediaDevices?.getUserMedia,xs=(g=>(g.AVD="43",g.Citrix="44",g.VMware="45",g))(xs||{});function setAgentPlatformInfo(g=""){const m=g.match(new RegExp("^SkypeSpaces/(\\d+)/"));m?.length&&Object.values(xs).includes(m[1])&&(Ls=m[1]),overrideGetUserMediaIfNeeded()}function isVdiPlatform(){return!!Ls}function overrideGetUserMediaIfNeeded(){"undefined"!=typeof window&&"undefined"!=typeof navigator&&(void 0!==navigator.webkitGetUserMedia&&"undefined"!=typeof webkitRTCPeerConnection&&isVdiPlatform()?(window.RTCPeerConnection=webkitRTCPeerConnection,navigator.getUserMedia=(g,m,S)=>{const polyfillDeviceId=g=>{g?.deviceId?.exact&&(g.mandatory||(g.mandatory={}),g.mandatory.sourceId=g.deviceId.exact,delete g.deviceId)};return g&&(polyfillDeviceId(g.audio),polyfillDeviceId(g.video)),navigator.webkitGetUserMedia(g,m,S)}):Fs&&overrideGumSourceFromWebkit())}function overrideGumSourceFromWebkit(){navigator.getUserMedia=function(g,m,S){return navigator.mediaDevices.getUserMedia(g).then(m).catch(S)}}"undefined"!=typeof window&&"undefined"!=typeof navigator&&(ks=window,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.MediaStream=window.MediaStream||window.webkitMediaStream||window.mozMediaStream||window.msMediaStream,window.AudioContext=window.AudioContext||window.webkitAudioContext);var Us={window:ks},Vs=class _UserAgentConfig extends je{constructor(g){super(),this.isAudioOutputSelectionSupportedValue=!1,g.on("configUpdated",(()=>this.updateConfig())),this.updateConfig(),this.isRollbackSupported()}get isAudioOutputSelectionSupported(){return this.isAudioOutputSelectionSupportedValue}get isBrowserRollbackSupported(){return this.isRollbackSupportedValue}static hasApplyConstraints(){return void 0!==MediaStreamTrack.prototype.applyConstraints}static hasPermissionsApi(){return void 0!==navigator.permissions&&"Firefox"!==getBrowserInfo().name}static get hardwareConcurrency(){return window.navigator.hardwareConcurrency}static get unmaskedGlRenderer(){if(this.renderer)return this.renderer===Ke.MEDIA_ERROR.webGlRendererError?void 0:this.renderer;try{const g=document.createElement("canvas").getContext("webgl"),m=g?.getExtension("WEBGL_debug_renderer_info"),S=m&&g.getParameter(m.UNMASKED_RENDERER_WEBGL);return this.renderer=S,S}catch{return void(this.renderer=Ke.MEDIA_ERROR.webGlRendererError)}}async isRollbackSupported(){let g;try{if(g=Us.window.RTCPeerConnection&&new Us.window.RTCPeerConnection({sdpSemantics:"unified-plan"}),g){const m=await g.createOffer();await g.setLocalDescription(m),await g.setLocalDescription({type:"rollback"}),this.isRollbackSupportedValue=!0}}catch(g){this.isRollbackSupportedValue=!1}finally{g?.close()}}static async isCodecsSupported(g){const m={format:"annexb"},S=1280,v=720,C=["no-preference","prefer-software","prefer-hardware"],_=[];for(const E of g)for(const g of C){const C=await(window.VideoEncoder?.isConfigSupported({codec:E,hardwareAcceleration:g,hevc:m,width:S,height:v})),T=await(window.VideoDecoder?.isConfigSupported({codec:E,hardwareAcceleration:g,hevc:m}));if(C||T){const g={name:E,mode:C?.config.hardwareAcceleration,encode:C?.supported,decode:T?.supported};_.push(g)}}return _}static async hasH264CodecSupport(g){const m="v=0\no=- 596983 0 IN IP4 127.0.0.1\ns=session\nc=IN IP4 0.0.0.0\nt=0 0\na=msid-semantic: WMS *\nm=video 3480 RTP/SAVPF 107 99\na=rtpmap:107 H264/90000\na=rtpmap:99 rtx/90000\na=fmtp:107 max-fs=240;max-mbps=3600;max-br=208;max-fps=1500;profile-level-id=42C02A;packetization-mode=1\na=fmtp:99 apt=107\na=setup:actpass\na=mid:video\na=recvonly\na=rtcp-mux\na=ice-ufrag:CvYq\na=ice-pwd:axsjsa0GOz3kz6TuGvNgJZWO\na=fingerprint:sha-256 34:DF:5C:15:60:FF:28:3E:E8:96:4B:F8:85:61:E4:C0:57:D1:60:82:21:FD:BC:D2:90:41:06:FA:03:FD:12:A2\n",S=Us.window.RTCPeerConnection&&new Us.window.RTCPeerConnection;if(!S)return!1;try{return await S.setRemoteDescription({sdp:m,type:"offer"}),!0}catch(m){return g.error("H264 not supported",m),!1}finally{try{S.close()}catch(g){}}}static hasMediaApi(){return navigator.getUserMedia&&"undefined"!=typeof RTCPeerConnection}static hasCapabilitiesApi(){return!!Us.window.RTCRtpReceiver?.getCapabilities}static isAudioOutputSelectionSupportedByBrowser(){return!!Us.window?.HTMLAudioElement?.prototype.setSinkId}updateConfig(){const g=_UserAgentConfig.isAudioOutputSelectionSupportedByBrowser();g!==this.isAudioOutputSelectionSupportedValue&&(this.isAudioOutputSelectionSupportedValue=g,this.event("isAudioOutputSelectionSupportedChanged").raise())}static hasUnifiedPlanSupport(){let g;try{g=Us.window.RTCPeerConnection&&new Us.window.RTCPeerConnection({sdpSemantics:"unified-plan"})}catch(g){return!1}let m=!1;return g&&(m=!!g.addTransceiver,g.close()),m}static hasEncodedStreamApi(){return!!RTCRtpReceiver.prototype.createEncodedStreams||_UserAgentConfig.hasScriptTransformApi()}static hasScriptTransformApi(){return!!window.RTCRtpScriptTransform}static isWakeLockSupported(){return!!window.navigator.wakeLock}},Bs=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(:[0-9]{1,5})?$/),Hs=RegExp(/^\[?(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|:((:[0-9a-fA-F]{1,4}){1,5}|:)((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,5}([0-9a-fA-F]{1,4})?:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\]?(?::\d{1,5})?$/);function invertDirectionality(g){switch(g){case Ke.MEDIA_STATE.send:return Ke.MEDIA_STATE.receive;case Ke.MEDIA_STATE.receive:return Ke.MEDIA_STATE.send;default:return g}}function negotiateDirectionality(g,m){const S=hasSendDirectionality(g)&&hasSendDirectionality(m),v=hasReceiveDirectionality(g)&&hasReceiveDirectionality(m);return S&&v?Ke.MEDIA_STATE.sendReceive:S?Ke.MEDIA_STATE.send:v?Ke.MEDIA_STATE.receive:g===Ke.MEDIA_STATE.inactive&&m||g&&m===Ke.MEDIA_STATE.inactive?Ke.MEDIA_STATE.inactive:void 0}function invertModalities(g){const m={},S=invertDirectionality(g.audio);S&&(m.audio=S);const v=invertDirectionality(g.video);v&&(m.video=v);const C=invertDirectionality(g.sharing);C&&(m.sharing=C);const _=invertDirectionality(g.data);return _&&(m.data=_),m}function removeSendDirectionality(g){return g===Ke.MEDIA_STATE.sendReceive?Ke.MEDIA_STATE.receive:void 0}function hasSendDirectionality(g){return g===Ke.MEDIA_STATE.send||g===Ke.MEDIA_STATE.sendReceive}function hasReceiveDirectionality(g){return g===Ke.MEDIA_STATE.receive||g===Ke.MEDIA_STATE.sendReceive}function addReceiveDirectionality(g){return hasReceiveDirectionality(g)?g:g===Ke.MEDIA_STATE.send?Ke.MEDIA_STATE.sendReceive:Ke.MEDIA_STATE.receive}function isOnHold(g){return!(g.audio!==Ke.MEDIA_STATE.inactive||g.video&&g.video!==Ke.MEDIA_STATE.inactive||g.sharing&&g.sharing!==Ke.MEDIA_STATE.inactive)}function negotiateModalities(g,m){const S={},v=negotiateDirectionality(g.audio,m.audio);v&&(S.audio=v);const C=negotiateDirectionality(g.video,m.video);C&&(S.video=C);const _=negotiateDirectionality(g.sharing,m.sharing);_&&(S.sharing=_);const E=negotiateDirectionality(g.data,m.data);return E&&(S.data=E),S}function isNegotiatedDirectionAcceptable(g,m,S){const v=hasSendDirectionality(g)&&hasSendDirectionality(m)||!hasSendDirectionality(g)&&!hasSendDirectionality(S),C=!S||hasReceiveDirectionality(g)&&hasReceiveDirectionality(m)||!hasReceiveDirectionality(g)&&!hasReceiveDirectionality(S);return v&&C}function areNegotiatedDirectionsAcceptable(g,m,S){return isNegotiatedDirectionAcceptable(g.audio,m.audio,S.audio)&&isNegotiatedDirectionAcceptable(g.video,m.video,S.video)&&isNegotiatedDirectionAcceptable(g.sharing,m.sharing,S.sharing)&&isNegotiatedDirectionAcceptable(g.data,m.data,S.data)}function areNegotiatedDirectionsFulfilled(g,m){function isNegotiatedDirectionFulfilled(g,m){const S=hasSendDirectionality(g)===hasSendDirectionality(m),v=hasReceiveDirectionality(g)===hasReceiveDirectionality(m)||hasReceiveDirectionality(g)&&!m;return S&&v}return isNegotiatedDirectionFulfilled(g.audio,m.audio)&&isNegotiatedDirectionFulfilled(g.video,m.video)&&isNegotiatedDirectionFulfilled(g.sharing,m.sharing)&&isNegotiatedDirectionFulfilled(g.data,m.data)}function areSendDirectionsFulfilled(g,m){const isSendDirectionFulfilled=(g,m)=>hasSendDirectionality(g)===hasSendDirectionality(m);return isSendDirectionFulfilled(g.audio,m.audio)&&isSendDirectionFulfilled(g.video,m.video)&&isSendDirectionFulfilled(g.sharing,m.sharing)&&isSendDirectionFulfilled(g.data,m.data)}function getSrtpInfo(g){const m={dtls:!1,sdes:!1};return m.dtls=!!g.fingerprint,g.media.forEach((g=>{m.dtls=m.dtls||!!g.fingerprint,m.sdes=m.sdes||!!g.crypto})),m}function removeChangedSendDirection(g,m){if(!m||isEmpty(m))return g;const S={};return forOwn(g,((g,v)=>{v===Ke.MODALITY.data?S[v]=removeChangedDataSendDirection(g,m[v]):S[v]=removeChangedMediaSendDirection(g,m[v])})),S}function removeChangedMediaSendDirection(g,m){return hasSendDirectionality(g)&&!hasSendDirectionality(m)?removeSendDirectionality(g)||m:g}function removeChangedDataSendDirection(g,m){return hasSendDirectionality(g)&&!hasSendDirectionality(m)?m:g}function parseCandidateString(g){const m=(g||"").split(" ");return{component:m[1],protocol:m[2],priority:m[3],ip:m[4],port:m[5],type:m[7]}}function isSendModalityAdded(g,m){return!hasSendDirectionality(g)&&hasSendDirectionality(m)}function getSendMediaModalities(g){return{Audio:hasSendDirectionality(g.audio),Video:hasSendDirectionality(g.video),ScreenShare:hasSendDirectionality(g.sharing),Data:hasSendDirectionality(g.data)}}function mergeSendModalities(g,m){const S=shallowClone(g);return forOwn(g,((g,v)=>{const C=modalityToMediaType(v);hasSendDirectionality(g)&&!m[C]&&(S[v]=removeSendDirectionality(g))})),S}function modalityToMediaType(g){switch(g){case"audio":return"Audio";case"video":return"Video";case"sharing":return"ScreenShare";default:return null}}function mediaTypeToModality(g){switch(g){case"Audio":return"audio";case"Video":return"video";case"ScreenShare":return"sharing";default:return null}}function sendStreamsToModalities(g){const m={};return keys(g).forEach((S=>m[S]=!!g[S])),m}function scrubObjectFields(g,m,S){if(!g)return g;const v={...g};for(const[C,_]of Object.entries(g))"object"==typeof _?v[C]=scrubObjectFields(_,m):_&&m.includes(C)&&(v[C]=S?S(_):scrubMriOrOmit(_));return v}function scrubObjectExcludingFields(g,m,S){if(!g)return g;const v={...g};for(const[C,_]of Object.entries(g))"object"==typeof _?v[C]=scrubObjectExcludingFields(_,m):_&&!m.includes(C)&&(v[C]=S?S(_):scrubMriOrOmit(_));return v}function scrubSelectedDevices(g){return g?scrubObjectExcludingFields(g,[]):g}function scrubDevices(g,m){if(!g)return g;const S=scrubObjectFields(g,["deviceId","groupId","guid"]);return scrubObjectFields(S,["label"],(g=>scrubDeviceLabelPii(g,m)))}function scrubConstraints(g){return scrubObjectFields(g,["sourceId","deviceId"])}function preferSdesSrtp(g){return!(!g.configProvider.config.webrtcForceSdesForS1||!g.configProvider.config.checkSupportForWebrtc_1_0||g.configProvider.mediaConfig.simulcastSessionEnabled)||(g.config.isPstnCall?g.configProvider.config.preferSdesSrtpPstn:g.configProvider.config.preferSdesSrtp)}function canUseWebrtc1_0(g){return!g||Vs.hasUnifiedPlanSupport()}function allowDataChannel(g){return!!g.configProvider.mediaConfig.simulcastSessionEnabled&&(g.config.isPstnCall?g.configProvider.config.enableDataChannelPstn:g.configProvider.config.enableDataChannel)}function getAllowedCodecs(g,m){switch(m){case Ke.MEDIA_TYPE.audio:return g.config.allowedAudioCodecs;case Ke.MEDIA_TYPE.video:return g.config.allowedVideoCodecs;default:return[]}}function isVersionGreaterOrEqual(g,m){const S=m.split(".").map((g=>parseInt(g,10))),v=g.split(".").map((g=>parseInt(g,10)));return v[0]>S[0]||v[0]===S[0]&&v[1]>=S[1]}function getSimulcastConfigForMediaType(g,m){return"Video"===g?m.config.specCompliantSimulcast?.video:"ScreenShare"===g?m.config.specCompliantSimulcast?.sharing:null}function convertToCodecInfo(g){return g.map((g=>{const m=g.mimeType.split("/"),S={codec:m[1]||m[0],rate:g.clockRate};return g.channels&&(S.encoding=g.channels),g.sdpFmtpLine&&(S.fmtpLine=g.sdpFmtpLine),S}))}function allowProvisionalAnswer(g,m=!1){const S=!g.configProvider.config.acceptProvisionalAnswerFromPstnOnly||m;return g.config.isPstnCall?g.configProvider.config.allowProvisionalAnswerPstn&&S:g.configProvider.config.allowProvisionalAnswer}function printMediaStream(g){return`${g?.id}:${JSON.stringify(g?.getTracks().map((g=>g.id)))}}`}function ipAddressConverter(g){try{if(Bs.test(g))return ipv4AddressConverter(g);if(Hs.test(g))return ipv6AddressConverter(g)}catch(m){return g}return g}function ipv6AddressConverter(g){let m,S=g.lastIndexOf("]")+1,v="",C="";S>0?(m=g.substring(0,S),C=g.substring(S)):(m=g,S=m.length);const _=m.lastIndexOf(":");if(m.includes(".")){const g=ipv4AddressConverter(m.substring(_+1,S-1-_));v=m.substring(0,_+1)+g}else _<m.length-1||":"===m[_-1]&&m.match(/:/g).length<7?v=m.substring(0,_+1)+"x":7===m.match(/:/g).length&&(v=m.substring(0,_)+"0:x");return v?C?v+"]"+C:"["===g.substring(0,1)?(v=v.substring(1),v):v:g}function ipv4AddressConverter(g){const m=g.substring(0,g.lastIndexOf(".")+1)+"x",S=g.lastIndexOf(":");return S>0?m+g.substring(S):m}function makeReinvitelessContext(g,m){const S=(m?g?.maxReinvitelessMediaForVideoMultiparty:g?.maxReinvitelessMediaForVideo1on1)||0,v=(m?g?.maxReinvitelessMediaForVBSSMultiparty:g?.maxReinvitelessMediaForVBSS1on1)||0;return{enabled:S>0||v>0,maxStreamsForModality:{video:S,sharing:v}}}function getStreamInformation(g){let m=[];return g.forEach((g=>{try{let S=m.find((m=>m.participantId===g.participantId&&m.endpointId===g.endpointId));S||(S={participantId:g.participantId,endpointId:g.endpointId},m.push(S)),"audio"!==g.type&&"audioteleconference"!==g.type||(S.serverMuted=g.serverMuted),S[g.type]=g.direction}catch(g){m=[]}})),m}var $s=class extends Ge{constructor(){super(),this.subs=[]}get streams(){return this.sessionAudioProvider?.streams??[]}get comfortNoiseStream(){return this.sessionAudioProvider?.comfortNoiseStream??null}get active(){return this.sessionAudioProvider?.active??!1}setSessionStreamsProvider(g){this.unsubscribeFromStreamEvents(),this.sessionAudioProvider=g,this.subscribeForStreamEvents(),this.event("onStreamsChanged").raise(),this.event("onActiveStateChanged").raise()}dispose(){super.dispose(),this.unsubscribeFromStreamEvents()}subscribeForStreamEvents(){this.sessionAudioProvider&&this.subs.push(this.sessionAudioProvider.on("onStreamsChanged",(()=>this.event("onStreamsChanged").raise())),this.sessionAudioProvider.on("onStreamSourcesUpdated",(g=>this.event("onStreamSourcesUpdated").raise(g))),this.sessionAudioProvider.on("onActiveStateChanged",(()=>this.event("onActiveStateChanged").raise())))}unsubscribeFromStreamEvents(){this.subs.forEach((g=>g.dispose())),this.subs=[]}},Gs=class extends Ge{constructor(g,m,S,v,C){super(),this.allowVirtualDeviceInCall=g,this.defaultDeviceManager=m,this.logger=S,this.callStats=v,this.isMediaSending=C,this.stats=[],this.selectedVirtualDevice={camera:void 0,screenshare:void 0},this.subs=[this.defaultDeviceManager.on("onVirtualDevicesChanged",(()=>this.handleRegisteredDeviceChange()))]}get isVirtualDeviceEnabled(){return this.allowVirtualDeviceInCall}selectDevices(g){const m=this.defaultDeviceManager.getRegisteredDevices(),S=m.find((m=>m.id===g.camera)),v=m.find((m=>m.id===g.screenshare));this.logger.info(`Selecting virtual devices, camera: ${S?.id}, screenshare: ${v?.id}`);const C={camera:this.selectedVirtualDevice.camera?.id,screenshare:this.selectedVirtualDevice.screenshare?.id};g.camera!==C.camera||g.screenshare!==C.screenshare?(this.selectedVirtualDevice={camera:S,screenshare:v},this.addToCallStat({type:"VirtualDeviceSelected",payload:this.selectedVirtualDevice}),this.event("onSelectedVirtualDevicesChanged").raise(g,C)):this.logger.info("Virtual Device did not change.")}getSelectedDevices(){return Object.entries(this.selectedVirtualDevice).reduce(((g,[m,S])=>(g[m]=S?.id,g)),{})}getDeviceManager(g){return this.allowVirtualDeviceInCall?this.getDeviceManagersForVirtualDevice(g)[0]:(this.logger.info(`VirtualDevice not enabled, using default DM, type: ${g}`),this.defaultDeviceManager)}getDeviceManagersForVirtualDevice(g){return"Video"===g&&this.selectedVirtualDevice.camera?(this.logger.info(`Using Virtual Device (DM), type: ${g}`),this.selectedVirtualDevice.camera.getDeviceManagers()):"ScreenShare"===g&&this.selectedVirtualDevice.screenshare?(this.logger.info(`Using Virtual Device (DM), type: ${g}`),this.selectedVirtualDevice.screenshare.getDeviceManagers()):(this.logger.info(`Using default DM, type: ${g}`),[this.defaultDeviceManager])}getDefaultDeviceManager(){return this.defaultDeviceManager}dispose(){this.stats=[],this.subs.forEach((g=>g.dispose())),super.dispose()}hasDevice(g){return this.defaultDeviceManager.id===g||[...this.selectedVirtualDevice.camera?.getDeviceManagers()??[],...this.selectedVirtualDevice.screenshare?.getDeviceManagers()??[]].some((m=>m?.id===g))}addToCallStat(g){const m=this.stats.push(g);this.callStats.appendCallDeviceManagerInfo({events:JSON.stringify(m)})}handleRegisteredDeviceChange(){const g=this.defaultDeviceManager.getRegisteredDevices(),{camera:m,screenshare:S}=this.selectedVirtualDevice;let v=!1,C=!1;m&&(v=g.some((g=>g.id===m.id)),this.logger.info(`Selected camera(${m.id}) in call, isCameraValid:${v}`)),S&&(C=g.some((g=>g.id===S.id)),this.logger.info(`Selected SS(${S.id}) in call, isScreenShareValid:${C}`)),this.selectDevices({camera:v?m.id:void 0,screenshare:C?S.id:void 0})}isModalityEnabled(g){return this.isMediaSending(getSkypeMediaType(g))}},js=class{constructor(g){this.ontimeout=g,this.active=!1}get isActive(){return this.active}start(g){void 0!==this.timeoutId&&this.stop(),this.timeoutId=setTimeout((()=>{this.ontimeout(),this.active=!1}),g),this.active=!0}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0,this.active=!1}};function defer4(){let g,m,S=!0;return{isPending:()=>S,promise:new Promise(((S,v)=>{g=S,m=v})),resolve:m=>{S&&(g(m),S=!1)},reject:g=>{S&&(m(g),S=!1)}}}function delay2(g){return new Promise((m=>setTimeout(m,g)))}function timeout(g,m,S,v){let C;const _=[g,new Promise(((g,v)=>{C=setTimeout(v.bind(null,new Error(`Promise timed out ${S?`: ${S}`:""} after ${m} ms`)),m)}))];v&&_.push(v);const E=Promise.race(_),always=()=>{C&&clearTimeout(C)};return E.then(always,always),E}var qs=class{constructor(g,m,S,v){this.mediaControlPlane=g,this.signalingSession=m,this.logger=S,this.diagnostics=v,this.pendingSourceRequests=new Map,this.mediaControlPlane.on("mpSrResReceived",((g,m)=>this.onMsgReceived(g,m)))}mapToSignalingOperation(g){switch(g){case"ApplyChannelParametersSourceRequest":case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":return 0;case"ControlVideoStreaming":return 1;default:return this.logger.error("Unknown send operation"),null}}send(g,m,S,v){switch(g){case"ApplyChannelParametersSourceRequest":return this.sendMessages(g,m,S,v);case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":case"ControlVideoStreaming":return this.signalingSession?(this.diagnostics.recordSignalingOperation(g),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(g),m)):Promise.reject(new Error("no signaling session"));default:return this.logger.warn(`Unable to send message reason: Operation unknown ${g}`),Promise.reject(new Error("Unable to send message"))}}async sendMessages(g,m,S,v){return this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")?Promise.all([this.sendMcpMessage(g,m,S,v),this.sendSignalingDupeOperation(g,m,v)]).then():this.sendMcpMessage(g,m,S,v)}setResendingMechanism(g,m,S,v){const C=window.setTimeout((()=>{this.logger.warn(`Fallback for SR: ${g}, switching to signaling`),this.mediaControlPlane.switchMcpFeauture("sourceRequestsEnabled",!1),this.resendPendingMessagesThroughSignaling()}),this.mediaControlPlane.getConfig()?.sourceRequestsMessagesTimeout);this.pendingSourceRequests.set(g,{sequenceNumber:g,timeoutId:C,deferred:m,message:S,operation:v})}async sendMcpMessage(g,m,S,v){if(this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsEnabled")&&m.applyChannelParameters?.multiChannelParameter?.mediaParameter?.includes("controlVideoStreaming")){const C=defer4();this.setResendingMechanism(v,C,m,g);try{return this.diagnostics.recordMCPOperation(g,v,S.controlVideoStreaming?.controlInfo),await this.mediaControlPlane.sendMsg({type:"sr",controlVideoStreaming:S.controlVideoStreaming}),this.logger.info(`Sending to MCP sequenceNumber:${v}`),this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsResponseEnabled")?C.promise:Promise.resolve()}catch(g){const m=stringifyObject(g);this.diagnostics.recordError(m,v),this.logger.error(`sendMsgInternal failed with error: ${m}`)}}return this.signalingSession?this.mediaControlPlane?.mcpFeaturesSupported("sendDuplicates")?void 0:(this.diagnostics.recordSignalingOperation(g),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(g),m)):Promise.reject(new Error("no signaling session"))}async sendSignalingDupeOperation(g,m,S){if(this.signalingSession){const v=this.mapToSignalingOperation(g);return this.diagnostics.recordSignalingOperation(g,S),await this.signalingSession.sendWebRtcMediaNotificationAsync(v,m),this.diagnostics.recordSignalingOperationDuration(g,S),Promise.resolve()}return Promise.reject(new Error("no signaling session"))}resendPendingMessagesThroughSignaling(){this.diagnostics.recordFallback(),this.pendingSourceRequests.forEach((async(g,m)=>{try{this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")||(this.diagnostics.recordSignalingOperation(g.operation),await this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(g.operation),g.message)),g.deferred.resolve()}catch{g.deferred.reject()}finally{this.logger.warn(`Deleting message from pending: ${m}`),this.pendingSourceRequests.delete(m),clearTimeout(g.timeoutId)}}))}onMsgReceived(g,m){const S=this.pendingSourceRequests.get(g);switch(this.diagnostics.recordSrResultReceived(m,g,S.operation),m){case"ok":case"duplicate":case"out_of_order":S.deferred.resolve();break;default:S.deferred.reject(`Sequence number: ${g} failed with ${m}!`)}clearTimeout(S.timeoutId),this.pendingSourceRequests.delete(g)}},Ws=[1,2,9,10,11,12,30,27,28],zs="remote",Ks="remote",Js=class extends Ge{constructor(g,m){super(),this.isStreaming=g,this.mediaType=m}},Ys=class _PluginlessCall extends Ge{constructor(g,m,S,v,C,_,E,T,I,b,A,R,P,M,w,D,O){super(S),this.signalingAgent=g,this.mediaAgent=m,this.logger=S,this.telemetryLoggers=v,this.currentUserSkypeIdentity=C,this.groupId=_,this.threadId=E,this.ecsProvider=b,this.trouterService=A,this.accountConfiguration=R,this.participants=[],this.isServerMuted=!1,this.isSpeakerMuted=!1,this.isVideoOn=!1,this.isScreenSharingOn=!1,this.callStartedAt=null,this.callHeldAt=null,this.callType=-1,this.failureType=2,this.isEmergency=!1,this.contentSharingSessions=[],this.endpoints={endpointDetails:[]},this.isPreheatEnabled=!1,this.localMediaStreams=[],this.enableRealtimeTelemetry=!1,this.isSharedLineAppearanceV2Activated=!1,this.requestedHoldState=!1,this.mediaStateConfigurationHelper=new ar({mediaStates:[getMediaState(0,4)]}),this.canToggleAudio=!0,this.canToggleVideo=!0,this.connectCallPromise=Promise.resolve(),this.canToggleScreenSharing=!0,this.callUsesMixer=!1,this.isEscalationInProgress=!1,this.retryOutgoingRenegotiation={retry:!1,causeId:""},this.isHoldInProgress=!1,this.isMuteOnHold=!1,this.callSetupFailed=!1,this.isSomeoneSharing=!1,this.isSomeoneStreamingVideo=!1,this.activeTalkersHistory=[],this.callGotConnected=!1,this.mediaRelayWhiteListingIssue=!1,this.signalingSessionCallOptions=null,this.tsCallingTelemetryReported=!1,this.isCallSetupTelemetrySent=!1,this._isAudioStreamConnected=!1,this._wasAudioStreamConnected=!1,this._callInLobby=!1,this._callIsSetupComplete=!1,this._transferState=0,this._parkState=0,this._muteState=0,this._callCreationTime=(new Date).getTime(),this._commandUrlPresence=0,this._capabilities={canMuteOthers:!1,canUnmuteSelf:!1},this._spamRiskLevel=null,this._spamStirAttestation=null,this._callMode=0,this._isUpdatePropertiesSpecifiedAllowedByEcs=!1,this._deferUsingMicrotask=!1,this._staleRosterCheckFixForPluginless=!1,this._transfereeAcceptanceWithoutWaitingForConv=!1,this._enableResolveScreenSharingWhenNegotiationComplete=!1,this._publishedStatesModified=0,this._participantPublishedStatesMap={},this._endpointPublishedStatesMap={},this._participantChangedEventSkipConfig={skipParticipantsUpdatesOnCall:!0},this._dominantSpeakerChangedEventSkipConfig={skipDominantSpeakerUpdatesOnCall:!0},this.receiveOnlyAudioOnCallStart=!1,this.lastContibutingSourceReport=Date.now(),this.instanceNumber=_PluginlessCall.instanceCount++%1e3,this._hasDelayedReconnect=!1,this.startVM=(g,m,S,v,C)=>this.signalingSession.startOutgoingCall(S,v,{voicemailResourcePath:m.callVoicemailStartOptions.voicemailResourcePath,voicemailItemId:m.callVoicemailStartOptions.voicemailItemId,callToVoicemail:!0},Date.now()-C,g),this.getSignalingSessionCallOptions=g=>{const m={suppressDialout:!g.callStartOptions.ringOthers,isPreheatOnly:1==(1&g.callStartOptions.preheatFlags),onBehalfOf:this.onBehalfOfMri,onBehalfOfUserDisplayName:this.onBehalfOfUserDisplayName,muted:1==(1&g.callStartOptions.muteFlags),invitationType:g.invitationType,participantsToNudge:g.participantsToNudge,routingFlags:g.callStartOptions&&g.callStartOptions.routingFlags,parkContext:g.parkContext,pickupCode:g.pickupCode,scenario:g.callStartOptions&&g.callStartOptions.scenario,callUsesMixer:this.callUsesMixer,clientEndpointCapabilities:g.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:g.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:g.meetingPreferences,alternateId:g.callStartOptions?g.callStartOptions.alternateId:null,meetingRegistrationId:g.callStartOptions?g.callStartOptions.meetingRegistrationId:"",participantPin:g.callStartOptions?g.callStartOptions.participantPin:"",additionalEndpointProperties:g.callStartOptions?.additionalEndpointProperties||null,publishedStates:g.callStartOptions?.publishedStates||null,targetApplicationType:g.callStartOptions?.targetApplicationType,isHuddleGroupCall:g.callStartOptions?.isHuddleGroupCall},S=g.callStartOptions?.invitationDataJson;if(S)try{m.invitationData=JSON.parse(S)}catch(g){throw new Error(`Invalid JSON in invitationData: ${S}`)}return m},this.startOutgoingCall=(g,m,S,v,C)=>this.signalingSession.startOutgoingCall(S,v,this.getSignalingSessionCallOptions(m),Date.now()-C,g),this.joinGivenConversation=(g,m,S,v,C,_)=>{const E=1==(1&m.callStartOptions.muteFlags),T=1==(1&m.callStartOptions.preheatFlags),I=m.callStartOptions?.invitationDataJson,b=m.callStartOptions?.sharedLineCallInvitationContentJson;this.logger.info(`[${g}][joinGivenConversation] muted=${E}, isPreheatOnly=${T},\n            sharedLineCallInvitationContentJson=${b}, invitationDataJson=${I}`);const A={muted:E,isPreheatOnly:T,clientEndpointCapabilities:m.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:m.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:m.meetingPreferences,meetingRegistrationId:m.callStartOptions?m.callStartOptions.meetingRegistrationId:"",participantPin:m.callStartOptions?m.callStartOptions.participantPin:"",additionalEndpointProperties:m?.callStartOptions?.additionalEndpointProperties,applyServerMute:m?.applyServerMute,publishedStates:m?.callStartOptions.publishedStates,invitationData:m?.callStartOptions.invitationDataJson};if(b)try{A.sharedLineCallInvitationContent=JSON.parse(b)}catch(g){throw new Error(`Invalid JSON in sharedLineCallInvitationContent: ${b}`)}if(I)try{A.invitationData=JSON.parse(I)}catch(g){throw new Error(`Invalid JSON in invitationDataJson: ${I}`)}return this.signalingSession.joinGivenConversation(_,this.callId,S,v,Date.now()-C,A,g)},this.executeCallTransfer=(g,m,S,v)=>{this._setTransferState(1);const C=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,m,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return 0===S?this.signalingSession.transferCallAsync(g,"TransferTypeStandard",void 0,v,m):2===S&&this.signalingSession.transferCallAsync(g,"TransferTypeVoicemail",void 0,v,m),C},this.executeConsultCallTransfer=(g,m,S,v,C)=>{this._setTransferState(1);const _=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,v,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return this.signalingSession.consultTransferCallAsync(g,m,S,v,C),_},this.createUpdateParticipantPromise=(g,m)=>this._callOperationHandler.createPendingOperation("UpdateParticipantsProperties",g,m),this._getCallEndOperation=()=>this._callOperationHandler.hasPendingOperation("StopCall")?this._callOperationHandler.waitForOperation("StopCall"):this._callOperationHandler.hasPendingOperation("Reject")?this._callOperationHandler.waitForOperation("Reject"):this._callOperationHandler.hasPendingOperation("CallRedirect")?this._callOperationHandler.waitForOperation("CallRedirect"):Promise.resolve(),this._onAcknowledgeError=(g,m,S,v)=>{S.logFailure(g);let C,_={code:2,success:!1,fatal:!0},E=7;throw isPhaseError("SendAttach",g)&&(C={code:li.InternalServerError,subCode:ci.AttachFailed,phrase:fi.AttachFailed}),isPhaseError("ProcessIncomingCallRequest",g)&&(C={code:li.NotAcceptable,subCode:ci.AttachActionFailed,phrase:fi.BadNotificationPayload},_={code:0,success:!1,fatal:!0}),isOneOfPhaseErrors(Ci,g)&&(E=47),g?.error&&g.error.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer&&(C={code:li.MediaError,subCode:ci.MediaOfferProcessingError,phrase:fi.IncompatibleOffer}),this.callTelemetry.updateOperationData("Acknowledge",{phases:v,error:getPIISafeObject(g)},m),this._callOperationHandler.maybeRejectOperation("Acknowledge",_,void 0,m),this.stopInternal({rejectReason:C,causeId:m,terminatedReason:E}),_},this._onAcknowledgeSuccess=(g,m,S)=>(g.logSuccess("success"),this.callTelemetry.updateOperationData("Acknowledge",{phases:m},S),{code:1,success:!0}),this._processOfferedModalities=(g,m)=>{this.handleOfferedModalities(g,m);const S=this.callUsesMixer?void 0:{modalityOverride:g};return this.updateMediaModalities(S,m)},this._handleOfferProcessingError=(g,m,S)=>(S.logFailure(`handleOfferProcessingError=${g}`),g?.error?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer?(this.callTelemetry.recordEvent("IncompatibleOffer",void 0,m),this.signalingSession.supportsNewOfferRequest()?(this.newOfferRequestDeferred=defer(),this.attachToCallAndGetOffer.promise.then((()=>this.mediaSession.rejectNegotiationAsync(g.error,m))).then((()=>this.signalingSession.requestNewOffer(this.mediaSession.getAcceptedTypes(),m))).then((()=>this.newOfferRequestDeferred.promise)).then((g=>this.mediaSession.processOfferAsync(g,m))).catch((g=>(this.callTelemetry.recordEvent("NewOfferFailed",getPrintableObject(g),m),Promise.reject(g))))):Promise.reject(g)):Promise.reject(g)),this._trySendProvisionalMediaAnswer=g=>Promise.resolve(void 0).then((()=>this.mediaSession.createAnswerAsync(!0,g))).then((g=>g.blob?(this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",void 0,generateCauseId(),{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.signalingSession.setProvisionalAnswerAsync(g).then((()=>this.mediaAcknowledgmentOperation))):Promise.resolve(void 0))),this.checkForCallIdUpdate=(g,m)=>{if(this.callId!==g){this.logger.info(`[${m}][checkForCallIdUpdate] old=${this.callId}, new=${g}`),this.setCallId(g);try{this.event("callIdChanged").raise(this.callId)}catch(g){this.logger.error(`Error raising call ID change: ${g}`)}this.raiseChanged()}},this.handleRemoteParticipantStateInOneToOneCall=g=>{if(!this.callUsesMixer&&3===this.state){const m=this.participants[0];m&&m.setState(3,void 0,g)}},this.handleRemoteParticipantJoinedInOneToOneCall=(g,m)=>{if(!this.callUsesMixer&&3===this.state){const S=this.participants.filter((m=>m.id===g.id))[0];S?S.setState(3,void 0,m):this.logger.logFailure(`[${m}][handleRemoteParticipantJoinedInOneToOneCall]unable to find particpant ${scrubMriOrOmit(g.id)}`)}},this.handleRemoteParticipantStateInObservingCall=(g,m,S)=>{const v=m.isLobby;if(8===this.state){const m=v?7:3;g.setState(m,void 0,S)}},this.getTelemetryFromPhaseExecution=g=>{const m={phase:g.phase,phases:g.phases,code:g.error&&g.error.code,subCode:g.error&&g.error.subCode,message:g.error&&g.error.message,error:g.error};return(m.code||m.message)&&delete m.error,m},this._setTransferState=g=>{this.transferState!==g&&(this.logger.info(`Transfer: state set: ${g}`),this._transferState=g,this.callTelemetry.recordEvent("_SetTransferState",{state:g}),this.raiseChanged())},this._setParkState=g=>{this.parkState!==g&&(this.logger.info(`Parking: state set: ${g}`),this._parkState=g,this.callTelemetry.recordEvent("_SetParkState",{state:g}),this.raiseChanged())},this.prepareNegotiationResultForTelemtry=g=>({isComplete:g.isComplete,activeModalities:g.activeModalities,configuredModalities:g.configuredModalities,initiator:scrubMriOrOmit(g.initiator),attemptedModalities:g.attemptedModalities,offeredModalities:g.offeredModalities}),this.prepareTelemetryForOfferAnswer=g=>g&&g.mediaContent&&{isRenegotiation:!!g.renegotiation,isEscalation:!!g.mediaContent.isTwoPartyToMultiPartyEscalation,mediaTypes:g.mediaTypes,newOffer:g.mediaContent.newOffer},this.updateLocalParticipantEndpoints=g=>{const m=this.logger.createFnLogger("updateLocalParticipantEndpoints",""),S=[];(0,_i.forEach)(g,(g=>{const m=convertSignalingEndpointDetails(g,this.getSelfClientEndpointCapabilities());S.push(m)})),this.endpoints.endpointDetails=S;const v=this.getDataChannelSourceId();-1!==v&&this.dataChannel&&this.dataChannel.setDataChannelSourceId(v),m.info(`selfEndpointDetails=${JSON.stringify(this.endpoints)}`)},this.handleParticipantsMutedUpdated=g=>{if(void 0!==g?.muteUnmuteResponse){this.logger.info(`handleParticipantsMutedUpdated: number of infos: ${g.muteUnmuteResponse.length}`);for(const m of Object.keys(g.muteUnmuteResponse)){const S=this.getParticipant(m);S&&S.handleServerMutedInfoUpdate(g.muteUnmuteResponse[m])}}},this.handleSelfUnmuteUpdatedInfo=(g,m)=>{if(void 0!==g?.muteUnmuteResponse){this.logger.info("handleSelfUnmuteUpdatedInfo");for(const S of Object.keys(g.muteUnmuteResponse)){const v=g.muteUnmuteResponse[S];if(S===this.localSignalingParticipant.id){const g=(0,_i.find)(v,(g=>g.participantId===this.localSignalingParticipant.participantId));if(void 0===g)continue;const S=(0,_i.find)(this.localSignalingParticipant.endpointDetails,(m=>m.participantId===g.participantId));handleMuteUnmuteParticipantInfo(this.logger,S,g,!1)&&this.handleSelfServerMutedState(m)}}}},this.state=0,this.terminatedReason=0,this.callStats=new rr(this.mediaAgent?.getConfigProvider()),this.callDeviceManager=this.createCallDeviceManager(),this.callTelemetry=new Yt(this.logger,this._callCreationTime),this.collectMediaStatsDeferred=defer(),this.setCallId(T),this.setGroupId(_),this.setThreadId(E),this.setMessageId(P),this.setSkypeId(this.currentUserSkypeIdentity.id),this.setParticipantId(I),this.setCallOrigin(0),this.logger=this.logger.createChild((()=>{const g=(this.endpointId||"").substr(0,8),m=(this.participantId||"").substr(0,8);return`Web/${this.instanceNumber}[${this.callId}][${g}][${m}][${this.state}]`})),this._staleRosterCheckFixForPluginless=this.ecsProvider.getEcsConfig("SkypeCalling","staleRosterCheckFixForPluginless"),this._transfereeAcceptanceWithoutWaitingForConv=this.ecsProvider.getEcsConfig("SkypeCalling","transfereeAcceptanceWithoutWaitingForConv"),this.initializeSignalingSession(I),this.signalingSession.setLocationInfo(M,w,O),this.streamManager=new Gr(this.participantId,null,this.callStats.localStats,this.logger),this.mediaAgent&&(this.dataChannel=new ds(this.logger),this.dataChannel.on("remoteUserEventsReceived",((g,m)=>this.event("remoteUserEventsReceived").raise(g,m))),this.dataChannel.on("onDataChannelStateUpdated",(g=>{"Failed"===g&&(this.logger.error("onDataChannelStateUpdated: datachannel creation failed, will remove data modality"),this.mediaStateConfigurationHelper.removeModality(3),this.updateSignalingDSHMessageSubscription(!0),this.updateMediaModalities())})),this.screenSharingControl=new Os(this.logger,this.dataChannel,this,this.telemetryLoggers,this.ecsProvider),this.initializeMediaControlPlane(),this.mediaAgent.handleSendMidCallTelemetry(this.sendMidCallTelemetry.bind(this)));const N={enableErrorConversion:this.ecsProvider.getEcsConfig("SkypeCalling","enableErrorConversion")};this._deferUsingMicrotask=this.ecsProvider.getEcsConfig("SkypeCalling","deferUsingMicrotask"),_r.instance.setDeferToQueueMicrotask(this._deferUsingMicrotask),_r.instance.setLogger(S),this.logger.info(`operationHandlerEcsConfig: ${JSON.stringify(N)}`),this._preferredMpLocation=this.ecsProvider.getEcsConfig("SkypeCalling","preferredMpLocation"),this._isUpdatePropertiesSpecifiedAllowedByEcs=this.ecsProvider.getEcsConfig("SkypeCalling","enableUpdateParticipantsSpecified"),this._enableResolveScreenSharingWhenNegotiationComplete=this.ecsProvider.getEcsConfig("SkypeCalling","enableResolveScreenSharingWhenNegotiationComplete"),this._callOperationHandler=new oi(this.logger,this.callTelemetry,N,void 0,((g,m)=>{this.preconditions(g,m)})),this._participantOperationHandler=new oi(this.logger,this.callTelemetry,N),this.setMeetingData(D),this.initializeLiveStreamConfigProvider()}get callMode(){return this._callMode}get callId(){return this._callId}get endpointId(){return this._endpointId}get isHostless(){return this.signalingSession.isHostLessCall}get transferState(){return this._transferState}get parkState(){return this._parkState}get capabilities(){return this._capabilities}get publishedStates(){return this._publishedStates}get dataChannelAdapter(){return this.dataChannel}get participantId(){try{const g=this.signalingSession?.participantManager?.localParticipant?.participantId;this._participantId=g||this._participantId}catch(g){this.logger.error("Error updating participantId")}return this._participantId}get role(){return this.localSignalingParticipant.role}get meetingRole(){return this.localSignalingParticipant.meetingRole}get advancedMeetingRole(){return this.localSignalingParticipant.advancedMeetingRole}get maskedIdentityDetails(){return{isIdentityMasked:this.localSignalingParticipant.isIdentityMasked,maskedIdSeqNumber:this.localSignalingParticipant.maskedIdSeqNumber,maskedId:this.localSignalingParticipant.maskedId}}get participantType(){return this.localSignalingParticipant.participantType}get isMuted(){return 2===this._muteState||3===this._muteState}get tenantId(){return this.localSignalingParticipant.tenantId}get mediaLegId(){return this._mediaLegId}get isIncomingOneOnOneVideoCall(){return this.isOneToOneCall()&&this.isSomeoneStreamingVideo}get mediaStreams(){return this.streamManager.streams}get origin(){return this._origin}get propertyBag(){return this.localSignalingParticipant.propertyBag}get version(){return this.localSignalingParticipant.version}get isAudioStreamConnected(){return this._isAudioStreamConnected}set isAudioStreamConnected(g){this._isAudioStreamConnected!==g&&(this._isAudioStreamConnected=g,this._wasAudioStreamConnected=this._wasAudioStreamConnected||g,this.raiseChanged())}setMeetingRole(g){g!==this.localSignalingParticipant.meetingRole&&(this.logger.info(`changing self role to [${g}]`),this.localSignalingParticipant.meetingRole=g,this.event("meetingRoleUpdated").raise(g))}setAdvancedMeetingRole(g){g!==this.localSignalingParticipant.advancedMeetingRole&&(this.logger.info(`changing self advanced meeting role to [${g}]`),this.localSignalingParticipant.advancedMeetingRole=g,this.event("advancedMeetingRoleUpdated").raise(g))}setParticipantType(g){g!==this.localSignalingParticipant.participantType&&(this.logger.info(`changing self participant user type to [${g}]`),this.localSignalingParticipant.participantType=g,this.event("participantTypeUpdated").raise(g))}setPropertyBag(g){g&&!(0,_i.isEqual)(g,this.localSignalingParticipant.propertyBag)&&(this.logger.info(`changing self participant property bag to [${g}]`),this.localSignalingParticipant.propertyBag=g,this.event("propertyBagUpdated").raise(g))}setPropertyRosterVersion(g){g!==this.localSignalingParticipant.version&&(this.logger.info(`changing self participant property version to [${g}]`),this.localSignalingParticipant.version=g,this.event("propertyRosterVersionUpdated").raise(g))}setMaskedIdentityDetails(g=!1,m,S){this.localSignalingParticipant.isIdentityMasked===g&&this.localSignalingParticipant.maskedIdSeqNumber===m&&this.localSignalingParticipant.maskedId===S||(this.localSignalingParticipant.isIdentityMasked=g,this.localSignalingParticipant.maskedIdSeqNumber=m,this.localSignalingParticipant.maskedId=S,this.logger.info(`self participant masked identity details updated to [${JSON.stringify(this.maskedIdentityDetails)}]`),this.event("maskedIdentityDetailsUpdated").raise(this.maskedIdentityDetails))}get spamRiskLevel(){return this._spamRiskLevel}set spamRiskLevel(g){g&&(this._spamRiskLevel=g)}get spamStirAttestation(){return this._spamStirAttestation}set spamStirAttestation(g){g&&(this._spamStirAttestation=g)}async getScreenHandle(g){if(!this.sharedScreenHandle){const m=!!this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled,S=!!this.mediaSession&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&!this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing,v=this.mediaStateConfigurationHelper.isSending(0)&&S&&m,C=3===g?.getType()?g?.getDeviceId():void 0,_=this.callDeviceManager.getDeviceManager(getAgentMediaType(2));_.setAudioSharingRequested(v),this.sharedScreenHandle=await _.createDevicesHandle({audio:v,sharing:!0},"pluginlessCall:getScreenHandle()",C),this.subscribeOnSharedScreenHandleEvents(this.sharedScreenHandle)}return this.sharedScreenHandle}setCallOrigin(g){this.logger.info(`Set call origin to ${g}`),this._origin=g,this.callTelemetry.setCallOrigin(g),this.callTelemetry.recordEvent("_SetCallOrigin",{origin:g})}setMediaLegId(g){this._mediaLegId=g,this.callStats.setMediaLegId(g)}setCallId(g){this.callTelemetry.setCallId(g),this.callStats.setCallId(g),this._callId=g}setEndpointId(g){this._endpointId=g,this.logger.info(`[endpointId=${truncate(this._endpointId)}]`),this.callTelemetry.setEndpointId(g),this.callStats.setEndpointId(g)}setFailureType(g){this.callTelemetry.setFailureType(g),this.failureType=g}setParticipantId(g){this._participantId=g,this.logger.info(`[participantId=${this._participantId}]`),this.callTelemetry.setParticipantId(this.participantId)}setCallerMri(g){this.callerMri=g,this.logger.info(`[callerMri=${scrubMriOrOmit(this.callerMri)}]`)}setTransferorMri(g){const m=stripMriAliases(g);m!==this.transferorMri&&(this.transferorMri=m,this.logger.info(`transferorMri: ${scrubMriOrOmit(this.transferorMri)}`),this.raiseChanged())}setGroupId(g,m=generateCauseId()){this.logger.info(`[${m}][setGroupId] groupId=${scrubMriOrOmit(g)}`),this.groupId!==g&&(this.groupId=g,this.callTelemetry.setGroupId(g),this.event("groupIdChanged").raise(g))}setMeetingData(g){if(g){if(g.meetingCode&&(!this.meetingData||this.meetingData&&g.meetingCode!==this.meetingData.meetingCode)){const m=g.meetingCode;this.logger.info(`[setMeetingData] meetingCode=${m}`),this.callTelemetry.setMeetingCode(m),this.signalingSession.setMeetingCode(m)}if(g.meetingUrl&&(!this.meetingData||this.meetingData&&g.meetingUrl!==this.meetingData.meetingUrl)){const m=g.meetingUrl.split("?")[0];this.logger.info(`[setMeetingData] meetingUrl=${g.meetingUrl}`),this.callTelemetry.setMeetingUrl(m),this.signalingSession.setMeetingUrl(m)}}this.meetingData=g}setHuddleGroupCall(g){this.isHuddleGroupCall!==!!g&&(this.logger.info(`[setHuddleGroupCall] new isHuddleGroupCall=${g}`),this.isHuddleGroupCall=g,this.callTelemetry.setIsHuddleGroupCall(!0))}setComplianceRecordingContent(g,m){try{if(!(0,_i.isEqual)(this.complianceRecordingContent,m)){this.complianceRecordingContent=m;const S=m?JSON.stringify(m):"";this.callTelemetry.setComplianceRecordingContentLength(S.length),this.logger.info(`[${g}][setComplianceRecordingContent] complianceRecordingContentLength=${S.length}`)}}catch(m){this.logger.error(`[${g}][setComplianceRecordingContent] ${m}`)}}setThreadId(g,m=generateCauseId()){this.threadId!==g&&(this.logger.info(`[${m}][setThreadId] threadId=${getLoggableThreadId(g)}`),this.threadId=g,this.callTelemetry.setThreadId(g))}setBackroomThreadId(g,m=generateCauseId()){this.backroomThreadId!==g&&(this.logger.info(`[${m}][setBackroomThreadId] backroomThreadId=${getLoggableThreadId(g)}`),this.backroomThreadId=g,this.callTelemetry.setBackroomThreadId(g))}setMessageId(g,m=generateCauseId()){this.messageId!==g&&(this.logger.info(`[${m}][setMessageId] messageId=${scrubMriOrOmit(g)}`),this.messageId=g,this.callTelemetry.setMesageId(g))}setSkypeId(g,m=generateCauseId()){this.skypeId!==g&&(this.logger.info(`[${m}][setSkypeId]`),this.skypeId=g,this.callTelemetry.setSkypeId(g))}setCallType(g,m){const S=this.logger.createFnLogger("setCallType",m);S.info(`current=${this.callType}, newValue: ${g}`),2!==this.callType||1!==g?g!==this.callType&&(this.callType=g,this.callTelemetry.setCallType(g),2===g&&this.callStats.localStats.call.event(2),this.raiseChanged()):S.logFailure("De-escalating to P2P should not happen!")}setConversationType(g,m){this.logger.createFnLogger("setConversationType",m).info(`current=${this.conversationType}, newValue=${g}`),g!==this.conversationType&&(this.conversationType=g,this.callTelemetry.setConversationType(g),this.raiseChanged())}setCallUsesMixer(g,m){this.callUsesMixer!==!!g&&(this.logger.info(`[${m}][setCallUsesMixer] new value=${g}`),this.callUsesMixer=g,this.callTelemetry.recordEvent("_CallUsesMixer",{newValue:g},m),this.dataChannel.setConfigProviderView(this.mediaSession?.getSessionConfig())),g&&this.mediaControlPlane.start()}setIsEscalationInProgress(g,m){this.logger.info(`[${m}][setIsEscalationInProgress] currentValue=${this.isEscalationInProgress}, newValue=${g}`),this.isEscalationInProgress=g,this.allowScreenSharingControl()&&this.screenSharingControl.setIsEscalationInProgress(g),this.callTelemetry.recordEvent("_EscalationInProgress",void 0,m)}setFromApplicationType(g,m){g&&(this.fromApplicationType=g,this.callTelemetry.recordEvent("_SetFromApplicationType",{fromApplicationType:g},m))}processCallStartOptions(g,m){const S=this.logger.createFnLogger("_ProcessCallStartOptions",m);try{1&g.preheatFlags&&(this.isPreheatEnabled=!0)}catch(g){S.logFailure(g)}}getlocalScreenShareStream(){return(0,_i.find)(this.localMediaStreams,(g=>2===g.mediaType))}setMeetingLayout(g,m){throw new Error("Method not implemented.")}async selectDevices(g){this.callDeviceManager.isVirtualDeviceEnabled?this.callDeviceManager.selectDevices(g):this.logger.error("allowVirtualDeviceInCall not enabled.")}async getSelectDevices(){return this.callDeviceManager.getSelectedDevices()}createStage(g){throw new Error("Method not implemented.")}updateDisplayName(g){this.logger.info("updating displayName"),this.localSignalingParticipant.displayName=g,this.signalingSession.participantManager.localParticipant.displayName=g}init(g){if(this.logger.info(`init callInitOptions:${safeJsonStringify(getPIISafeCallInitOptions(g))}`),this.signalingSessionCallOptions={teamsMessageId:g.messageId,enableGroupCallMeetupGeneration:g.enableGroupCallMeetupGeneration,meetingInfo:g.meetingInfo,emergencyContent:g.emergencyContent?JSON.parse(g.emergencyContent):void 0,broadcastContext:g.broadcastContext,endpointMetadata:g.endpointMetadata},this.setMessageId(g.messageId),this.onBehalfOfMri=g.onBehalfOf,this.onBehalfOfUserDisplayName=g.onBehalfOfUserDisplayName,g.threadId&&(this.setThreadId(g.threadId),this.signalingSession.setThreadId(g.threadId)),this.groupId&&this.signalingSession.setGroupId(this.groupId),this.signalingSession.setCallOptions(this.signalingSessionCallOptions),g.transferContext){switch(this.logger.info("Transfer: Call.init, set transferContext",scrubITransferContext(g.transferContext)),this.signalingSession.setTransferContext(g.transferContext.context),g.transferContext.transferType){case 1:this.setCallOrigin(2);break;case 0:this.setCallOrigin(1);break;case 2:this.setCallOrigin(3);break;default:throw new Error(`TransferType: ${g.transferContext.transferType} doesn't have a switch option`)}g.transferContext.context.callAcceptanceCallback?this._transferredCallAcceptanceCallback=g.transferContext.context.callAcceptanceCallback:this.logger.info("[failed]Transfer: Missing transferred call acceptance callback"),g.transferContext.transferorMri&&this.setTransferorMri(g.transferContext.transferorMri)}this.setIsEmergency(!!g.isEmergency),this.raiseChanged()}getIncomingRawAudioStream(){if(!this.mediaSession)throw this.logger.error("can not execute getIncomingRawAudioStream as there is no mediaSession"),new Error("NoMediaSession");return this.mediaSession.getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.unmixedAudioProvider?Promise.resolve(this.unmixedAudioProvider):Promise.reject("No audio provider available")}setDeviceManager(g){}async startVideo(g,m=generateCauseId()){return this.startStopVideo(!0,m)}async stopVideo(g,m=generateCauseId()){return this.startStopVideo(!1,m)}async dumpVideoSourceImages(){return Promise.reject(60)}async hold(g,m=generateCauseId(),S,v){const C=this.logger.createFnLogger("Hold",m);return C.info(`[Hold][${m}] negotiationTag ${g} hold options: ${safeJsonStringify(S)}`),4===this.state?(C.logFailure("Trying to put a call on hold which is already held state, early resolving the promise"),Promise.resolve(void 0)):S?.isLocal?this.localHold(m,S,v):this.holdWithRenegotiate(m,S)}async holdWithRenegotiate(g,m){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,g,m):(this.logger.logFailure(`[Hold][${g}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async localHold(g,m,S){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,g,m,S):(this.logger.logFailure(`[LocalHold][${g}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async unhold(g,m=generateCauseId()){const S=this.logger.createFnLogger("Unhold",m);return 3===this.state?(S.logFailure("Trying to resume a call which is already in connected state, early resolving the promise"),Promise.resolve(void 0)):4===this.state?(S.info(`current hold state ${this.requestedHoldState}`),this.setHold(!1,m)):(S.logFailure(`Trying to resume a call in an invalid state: ${this.state}`),Promise.reject(`Trying to resume a call in an invalid state: ${this.state}`))}canMerge(g,m){const S=g.isOneToOneCall(),v=3===this.state,C=4===g.state,_=S&&v&&C;return this.logger.info(`[${m}][canMerge] Call ${g.callId} isOneToOne ${S} isCallConnected ${v} call.state ${this.state} isMergeOnHold ${C} mergeCall.state ${g.state} CanMerge result: ${_}`),_}async updateEndpointMetadata(g,m=generateCauseId()){return this.signalingSession.updateEndpointMetadata(g,m)}async sendDtmfTone(g){if(this.mediaSession){const m=this.toneToString(g);return m?(this.logger.info(`[${causeId}][sendDtmfTone]DtmfTone: <omitted>`),Promise.resolve(this.mediaSession.sendDtmf(m))):Promise.reject(new Error("Unsupported DtmfTone"))}return Promise.reject(new Error("no mediaSession"))}async setAudioUsageMode(g){return Promise.reject(60)}async setAudioMidcallConfig(g,m){return Promise.reject(60)}async setAudioMidcallConfigJson(g,m=generateCauseId()){if(!g)return Promise.reject(60);isDefined(g.enableSpatialAudio)&&this.mediaSession?.configureSpatialAudio(g.enableSpatialAudio,m),g.noiseSuppressionMode&&await this.setNoiseSuppressionMode(g.noiseSuppressionMode,g.enableAEC)}async setParticipantSpatialAudioPositions(g,m=generateCauseId()){const S=g.map((g=>({sourceId:this.participants.find((m=>m.id===g.participantId))?.audio.id,x:g.x,y:g.y})));return this.mediaSession?.setParticipantSpatialAudioPositions(S,m)}async setNoiseSuppressionMode(g,m){return this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe||this.mediaSession.getSessionConfig().config.wasmdns.enableNoiseSuppression?"Auto"===g?this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaSession.getSessionConfig().config.wasmvqe.defaultVqeMode)):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(this.mediaSession.getSessionConfig().config.wasmdns.noiseSuppressionMode,m))):this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(g,this.mediaSession.getSessionConfig().config.wasmvqe.enableAec))):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(g,m))):Promise.resolve()}setInitialTelemetry(g,m,S,v){let C,_,E,T,I;switch(g){case"Subscribe":case"SubscribeWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("SUBSCRIBE"),S||this.callTelemetry.setOperationVariant(g,"CCWM"),this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:v,conversationServiceUrl:S});break;case"Acknowledge":0!==this.state&&8!==this.state&&this.callTelemetry.maybeRecordOperationSuccess(g,{code:4}),this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("callee"),this.signalingSession.setInitialTelemetry(g,{causeId:v});break;case"JoinCall":case"JoinWithMeetingData":this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("join"),1&m.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(g,"Preheat"),C=this.telemetryDataFromCallStartOptions(m.callStartOptions),C&&this.callTelemetry.updateOperationData(g,C,v),_=1==(1&m.callStartOptions.muteFlags),E=1==(1&m.callStartOptions.preheatFlags),T={muted:_,isPreheatOnly:E},this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:v,conversationServiceUrl:S,joinCallOptions:T,offerGenerationTime:Date.now()-m.callStartTime});break;case"StartCall":case"StartWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),1&m.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(g,"Preheat"),C=this.telemetryDataFromCallStartOptions(m.callStartOptions),C&&this.callTelemetry.updateOperationData(g,C,v),I=m.callStartOptions,this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:v,conversationServiceUrl:S,callStartOptions:I,offerGenerationTime:Date.now()-m.callStartTime});break;case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:v,conversationServiceUrl:S,startCallOptions:m.callStartOptions,offerGenerationTime:Date.now()-m.callStartTime})}}async setHold(g,m,S,v){const C=this.logger.createFnLogger("setHold",m,`hold=${g}`);if(!this.canToggleAudio||this.callHoldResumeDeferred)return Promise.reject(new Error("can not set hold as it is already in progress"));this.callHoldResumeDeferred=defer(),this.isHoldInProgress=g,this.canToggleAudio=!1,this.canToggleVideo=!1,this.canToggleScreenSharing=!1,this.requestedHoldState=g;const always=()=>{this.canToggleAudio=!0,this.canToggleScreenSharing=!0,this.canToggleVideo=!0};C.info(`start, holdOptions: ${JSON.stringify(S)}`);const _=this.callHoldResumeDeferred.promise,E=g?"Hold":"Unhold",T={debugContent:{clientScenario:this.convertClientScenario(v)}};try{if(g?this.isMuteOnHold=S&&S.isLocal&&5!==this.state:this.prepareModalitiesForResume(m),!this.isMuteOnHold){const g=await this.updateMediaModalities(void 0,m);this.updateMediaState(g,m),this.updateScreenSharingState(g,m)}g&&(this.prepareModalitiesForHold(m),5===this.state&&this.finishCallHoldResume(),this.setCallState(4,m)),this.isMuteOnHold&&this.setMuteOnHold(g,m),always();const v={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(E,v,null,m,T)}catch(S){this.callTelemetry.recordOperationFailure(E,{error:getPIISafeObject(S)},null,m,T),C.logFailure(S),always(),this.callHoldResumeDeferred?.reject(new Error(`Failed setting hold state to ${g}`)),this.callHoldResumeDeferred=null}return _}transferCall(g){return this.logger.warn("transferCall is deprecated, please use callBlindTransfer instead"),this.callBlindTransfer(g)}callBlindTransfer(g,m=generateCauseId(),S){return this.executeCallTransfer(g,m,0,S)}callSafeTransfer(g,m=generateCauseId(),S){return this.executeCallTransfer(g,m,0,S)}transferCallToVoicemail(g,m=generateCauseId()){return this.executeCallTransfer(g.transferTargetMri,m,2,void 0)}callConsultativeTransfer(g,m=generateCauseId(),S,v){const C=this.logger.createFnLogger("ConsultativeTransfer",m),_=g.participants[0],E=_&&_.acceptedBy||_&&_.id;return C.info(`transferTargetParticipantLegId: ${S} targetMri: ${scrubMriOrOmit(E)}`),this.executeConsultCallTransfer(g.callId,E,S,m,v)}async consultativeTransferWithPickupCode(g,m){const S=this.logger.createFnLogger("ConsultativeTransferWithPickupCode",m);if(S.info(`pickup code: ${g}`),!g||isNaN(Number(g)))return S.info("pickup code cannot be empty"),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));const v=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,m,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),C=`4:${$t.SERVER_HOLD}`,_={unparkContent:{pickupCode:Number(g)}},E={disableForwardingAndUnanswered:!1};return this.signalingSession.transferCallAsync(C,"TransferTypeStandard",_,E,m),v}callRedirect(g,m=generateCauseId()){return this.logger.createFnLogger("CallRedirect",m).info(`redirectOptions: ${JSON.stringify(g)}`),this.stopInternal({terminatedReason:75,redirectOptions:g,causeId:m}).then((()=>({code:li.CallRedirected,subCode:ci.CallRedirectedSuccess,phrase:fi.CallEndReasonRedirected,resultCategories:["Success"]})))}convertParkContext(g){switch(g){case 1:return"sharedLinePark";case 4:return"sharedLineParkV2";case 0:return"teamPark";case 3:return"serverHoldV2";case 5:return"callPark";default:return"serverHold"}}convertClientScenario(g){switch(g){case 0:return"breakoutRoom";case 1:return"musicOnHoldV2";case 2:return"sharedLineAppearanceV2";default:return}}park(g,m=generateCauseId()){const S=this.convertParkContext(g);return this.logger.info(`[${m}] [ParkCall] start -  context ${g} parkType ${S}`),5===g?(this.callTelemetry.recordOperation(`${getParkTypeName(S)}`,m),this._pendingParkPromise=this._callOperationHandler.createPendingOperation("CallParkV2",void 0,m)):this._pendingParkPromise=this._callOperationHandler.waitForOperation("ParkCall"),"serverHoldV2"!==S&&"callPark"!==S&&this._setParkState(1),this.signalingSession.parkCallAsync(S,m).catch((g=>{this.logger.info(`[${m}] [ParkCall] error in parkCallAsync (synchronous error) : ${getPIISafeObject(g)}. Hold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("ParkCall",{error:getPIISafeObject(g)},m)})),this._pendingParkPromise}async unpark(g,m){const S=this.convertParkContext(g);return this.logger.info(`[${m}] [UnparkCall] start -  context ${g} parkType ${S}`),this._pendingUnparkPromise=this._callOperationHandler.waitForOperation("UnparkCall"),this.signalingSession.unparkAsync(S,m).catch((g=>{this.logger.info(`[${m}] [UnparkCall] error in unparkAsync (synchronous error) : ${getPIISafeObject(g)}. Unhold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UnparkCall",{error:getPIISafeObject(g)},m)})),this._pendingUnparkPromise}getServerHoldLocation(){return this._pendingParkPromise.then((()=>(this.logger.info(`getServerHoldLocation ${this.serverHoldLocation}`),this.serverHoldLocation)))}getParkAdditionalContextJson(){return this._pendingParkPromise.then((()=>(this.logger.info(`getParkAdditionalContextJson ${this.parkAdditionalContextJson}`),this.parkAdditionalContextJson)))}getJoinBlob(){return Promise.resolve(JSON.stringify({conversationUrl:this.signalingSession.getConversationUrl(),conversationId:this.callId}))}getTechnicalInformationJson(){return Promise.resolve(JSON.stringify(this.mediaSession.getCallTechnicalInfo()))}isOneToOneCall(){return 1===this.callType&&1===this.participants.length}setMuteOnHold(g,m){this.mediaSession.muteHold(g,m),g||(this.computeCallState(m),this.isMuteOnHold=!1),this.finishCallHoldResume()}finishCallHoldResume(g){g?this.callHoldResumeDeferred?.reject(g):this.callHoldResumeDeferred?.resolve(),this.isHoldInProgress=!1,this.callHoldResumeDeferred=null}computeCallState(g){let m=3;this._callInLobby?m=10:this.signalingSession.participantManager.localParticipant.isStaging&&(m=13),this.logger.info(`[${g}][computeCallState] the call state will be set to ${m}`),this.setCallState(m,g)}async prepareModalitiesForResume(g){this.mediaStateConfigurationHelper.isSending(1)&&await this.turnOnLocalVideoPreview(g)}async prepareModalitiesForHold(g){await this.turnOffLocalVideoPreview(g)}updateMediaState(g,m){this.setVideoOn(g.video===this.mediaAgent.constants.MEDIA_STATE.sendReceive||g.video===this.mediaAgent.constants.MEDIA_STATE.send,m),this.setAudioOn(g.audio===this.mediaAgent.constants.MEDIA_STATE.sendReceive||g.audio===this.mediaAgent.constants.MEDIA_STATE.send,m)}updateScreenSharingState(g,m){this.setScreenSharingOn(g.sharing===this.mediaAgent.constants.MEDIA_STATE.send,m)}subscribeOnSharedScreenHandleEvents(g){this.sharedHandleSubs=g.on("onStreamStateChanged",((g,m)=>this.onSharingStreamStateChanged(g)))}unsubscribeFromSharedScreenHandleEvents(){this.sharedHandleSubs.dispose(),this.sharedHandleSubs=null}onSharingStreamStateChanged(g){const m=generateCauseId();this.logger.info(`[${m}] Sharing stream state moved to ${g}`);const S={mediaType:2,mediaDirection:1,mediaStreamState:_PluginlessCall.streamingStatetoMediaStreamState(g)};this.event("mediaStreamStateChanged").raise(S),this.callStats.localStats.screenShare.streamStateChanged(g),"stopped"===g&&(this.canToggleScreenSharing=!0,this.stopScreenSharing(),"screenSharingCall"!==this.conversationType||this.participants.some((g=>3===g.state))||this.stop(!0,m))}async startScreenSharing(g,m,S,v=generateCauseId()){this.allowScreenSharingControl()&&(this.screenSharingControl.shutdownControlForViewer(),this.screenSharingControl.initControlForSharer(S));const C=this.logger.createFnLogger("StartScreenSharing",v);if(C.info("started"),!this.canToggleScreenSharing)return Promise.reject(new Error("cannot start screen sharing"));if(this.isScreenSharingOn)return C.logSuccess("Resolving early because screen sharing is already on"),Promise.resolve();this.screenSharingRenegotiationDeferred&&(C.logFailure("called before the renegotiation deferred for the previous one has been closed"),this.screenSharingRenegotiationDeferred.resolve()),this.screenSharingRenegotiationDeferred=defer(),this.callStats.localStats.newSession(2),this.callStats.localStats.screenShare.start(),this.mediaStateConfigurationHelper.isDisabled(2)&&C.info("sharing modality was skipped till now. Adding it now"),this.canToggleScreenSharing=!1;const restoreToggle=()=>{this.canToggleScreenSharing=!0};this.callStats.localStats.screenShare.event(0);try{const m=await this.getScreenHandle(g);await m.acquire(),C.logSuccess("sharing stream acquired"),this.mediaStateConfigurationHelper.enableModality(2),this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),await this.updateMediaModalities(void 0,v),C.logSuccess("updateMediaModalities done"),this.callStats.localStats.screenShare.negotiationStateChanged("started"),this.setScreenSharingOn(!0,v),restoreToggle(),await this.screenSharingRenegotiationDeferred.promise,this.enableControlInjector(),this.callStats.localStats.screenShare.negotiationStateChanged("completed")}catch(g){this.callTelemetry.updateOperationData("StartScreenSharing",{error:getPIISafeObject(g)},v),this.setScreenSharingOn(!1,v),this.mediaStateConfigurationHelper.removeModality(2),restoreToggle(),this.disposeSharingScreenHandle();const m=g.error;throw m&&m.code===li.GlareError?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),C.logFailure("starting screen sharing failure with reason glare")):"ScreenSharingStopped"===g.reason?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","sharingStopped"),C.logFailure("expectedstarting screen sharing failure with reason stopped")):(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","other"),C.logFailure(g)),g}}async stopScreenSharing(g,m,S=generateCauseId()){const v=this.logger.createFnLogger("StopScreenSharing",S);if(v.info("started"),!this.canToggleScreenSharing)return v.logFailure("cannot stop screen sharing"),Promise.reject(new Error("cannot stop screen sharing"));if(!this.isScreenSharingOn&&!this._callOperationHandler.hasPendingOperation("StartScreenSharing"))return v.logFailure("screensharing is not on, ignore this operation"),Promise.resolve();this.screenSharingRenegotiationDeferred&&(this.screenSharingRenegotiationDeferred.reject({reason:"ScreenSharingStopped"}),this.screenSharingRenegotiationDeferred=null),this.mediaStateConfigurationHelper.removeModality(2),this.canToggleScreenSharing=!1;const always=()=>{this.canToggleScreenSharing=!0,this.callStats.localStats.screenShare.stop(),this.disposeSharingScreenHandle(),this.mediaAgent.getDeviceManager().shareSystemSound(!1),this.mediaAgent.getDeviceManager().setAudioSharingRequested(!1)};return this.allowScreenSharingControl()&&this.screenSharingControl.shutdownControlForSharer(),this.updateMediaModalities(void 0,S).then((()=>this.setScreenSharingOn(!1,S))).then(always,(g=>{throw v.logFailure(g),this.callTelemetry.updateOperationData("StopScreenSharing",{error:getPIISafeObject(g)},S),always(),g}))}async startDataChannel(g,m=generateCauseId()){if(!this.allowDataChannel())throw new Error("startDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.enableModality(3),await this.updateMediaModalities({},m)}async stopDataChannel(g,m=generateCauseId()){if(!this.allowDataChannel())throw new Error("stopDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.removeModality(3),await this.updateMediaModalities({},m)}allowDataChannel(){return this.mediaSession?!!this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&(this.isOneToOnePSTNCall()?this.mediaSession.getSessionConfig().config.enableDataChannelPstn:this.mediaSession.getSessionConfig().config.enableDataChannel):(this.logger.warn("datachannel not allowed as there is no mediaSession"),!1)}isGiveControlEnabled(){const g=this.mediaSession?.getSessionConfig()?.config;return g?g.enableGiveControl:(this.logger.warn("Give take control is not enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!1)}isInitialSignalingDSHSubscriptionEnabled(){const g=this.mediaSession?.getSessionConfig()?.config;return g?!this.allowDataChannel()||g.enableInitialSignalingDSHSubscription:(this.logger.warn("Initial signaling dsh subscription is enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}isSignalingDSHFallbackEnabled(){const g=this.mediaSession?.getSessionConfig()?.config;return g?g.enableSignalingDSHFallback:(this.logger.warn("Falling back to Signaling DSH is disabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}allowScreenSharingControl(){return this.screenSharingControl?.isScreenSharingControlEnabled()&&this.allowDataChannel()}updateSignalingDSHMessageSubscription(g){this.signalingSession.updateDominantSpeakerHistoryMessageSubscription(g),g&&this.mediaSession?.getDiagnostics?.().dshDiagnostics.setCurrentActiveStrategy("signaling")}async sendUserEvents(g,m){return this.dataChannel.sendUserEvents(g,m)}async shareSystemSound(g,m=generateCauseId()){const S=this.logger.createFnLogger("ShareSystemSounds",m,`shareSystemSound=${g}`);if(!(!!this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing))return S.error("shareSystemSound not allowed"),Promise.reject(60);try{return void this.mediaAgent.getDeviceManager().shareSystemSound(g)}catch{return S.error("shareSystemSound failed with device error"),Promise.reject(58)}}async mute(g=generateCauseId()){return this.isMuted?Promise.reject(getRejectTransactionEnd("TransactionDisallowed")):this.muteUnmute(!0,g)}async unmute(g=generateCauseId()){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")&&await this._callOperationHandler.waitForOperation("_PromotionToRealtime"),this.muteUnmute(!1,g)}async muteSpeaker(g=generateCauseId()){return this.muteUnmuteSpeaker(!0,g)}async unmuteSpeaker(g=generateCauseId()){return this.muteUnmuteSpeaker(!1,g)}async muteParticipants(g,m,S=generateCauseId()){const v=this.logger.createFnLogger("MuteParticipants",S,`muteScope=${g}`);v.info(`callParticipants count=${m.length}`);const C=_PluginlessCall.convertMuteScope(g);if(void 0===C)return v.logFailure(`Unrecognized ${g}`),Promise.reject(new Error("Unrecognized muteScope"));if(callStateIsAnyOf(this.state,[11,12]))return v.logFailure("Can not mute/unmute during preheat call"),Promise.reject(60);const _=[];return m.forEach((g=>{_.push(g.id)})),this.signalingSession.muteAsync(C,_,S).then((g=>this.handleParticipantsMutedUpdated(g))).catch((g=>(this.callTelemetry.updateOperationData("MuteParticipants",{error:getPIISafeObject(g)},S),v.logFailure(g),g?.endCode?Promise.reject(g.endCode):Promise.reject(g))))}async startAudio(g,m=generateCauseId()){const S=this.logger.createFnLogger("StartAudio",m);if(this.receiveOnlyAudioOnCallStart=!1,3!==this.state)return S.logFailure("Cannot startAudio when call is not connected"),Promise.reject(60);if(this.mediaStateConfigurationHelper.enableModality(0),this.callUsesMixer&&this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.isSending(1))try{await this.turnOnLocalVideoPreview(m)}catch(g){return S.logFailure(g),Promise.reject(25)}const v=await this.startStopAudio(!0,m);return await this.signalingSession.recordTelemetryForStartAudio(v),{code:v}}async stopAudio(g,m=generateCauseId()){const S=this.logger.createFnLogger("StopAudio",m);if(3!==this.state)return S.logFailure("Cannot stopAudio when call is not connected"),Promise.reject(60);this.mediaStateConfigurationHelper.removeModality(0);const v=await this.startStopAudio(!1,m);return await this.turnOffLocalVideoPreview(m),await this.signalingSession.recordTelemetryForStopAudio(v),{code:v}}assimilate(g,m,S,v=generateCauseId()){return Promise.reject(new Error("Not implemented"))}async merge(g,m,S=generateCauseId()){const v=this.logger.createFnLogger("MergeCall",S);v.error(`merge callId ${g.callId} callMergeOptions ${JSON.stringify(m)}`);const C=this.canMerge(g,S);if(!C)return v.info(`Error. ${getPrintableObject(C)}`),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));const _=[];g.participants.forEach((g=>{_.push(this._callOperationHandler.createPendingOperation("MergeCall",g.id,S))}));return(await this.mergeCallByAddParticipantWithReplaces(m,g.participants,g,1,"MergeCall",S,_,void 0))[0]}async mergeParticipants(g,m,S,v,C){const _=this.logger.createFnLogger("MergeParticipants",v),E=[];if(!g)return Promise.reject(getRejectTransactionEnd("Invalid callToMerge"));if(0===m.length)return Promise.reject(getRejectTransactionEnd("Invalid participantIds"));const T=[];for(const S of m){let m=findParticipantUsingParticipantLegId(g,S);if(!m&&findSelfEndpointDetailUsingParticipantLegId(g,S)&&(_.info("found self endpoint, use localSignalingParticipant"),m=this.localSignalingParticipant),m){const g=generateGuid(),C={id:m.id,participantId:g,replacementParticipantId:S,nonMaskedId:m.nonMaskedId};E.push(C),T.push(this._callOperationHandler.createPendingOperation("MergeParticipant",g,v))}else{const g={code:406,subCode:5201,phrase:`participantLegId ${S} is invalid!`};T.push(Promise.reject(getRejectTransactionEnd(g)))}}return this.mergeCallByAddParticipantWithReplaces(S,E,g,3,"MergeParticipant",v,T,C)}async mergeWithPickupCode(g,m,S=generateCauseId()){const v=this.logger.createFnLogger("MergeWithPickupCode",S);if(v.info(`mergeWithPickupCode: pickup code: ${g}, groupId: ${scrubMriOrOmit(m.groupId)}, threadId: ${getLoggableThreadId(m.threadId)} messageId: ${m.messageId}`),!g||isNaN(Number(g)))return v.info("mergeWithPickupCode: pickup code cannot be empty"),Promise.reject(getRejectTransactionEnd("mergeWithPickupCode: pickup code cannot be empty"));const C={additionalData:m.additionalData,groupId:m.groupId,threadId:m.threadId,messageId:m.messageId,replacementType:2,pickupCode:Number(g)},_={id:`4:${$t.SERVER_HOLD}`};return Promise.resolve().then((()=>Promise.all(this.signalingSession.addParticipantsAsync([_],C,S)))).then((g=>(g.length>0&&this.signalingNotifications.onParticipantJoined(g[0],S),Promise.resolve({code:0,subCode:0,phrase:"TransactionComplete"})))).catch((g=>{v.logFailure(`Participant was not added to call, error=${getPrintableObject(g)}`);const m=this._handleParticipantOperationFailure("MergeWithPickupCode",g,S,null,!0).reason;return Promise.reject(g?g.endCode:m||0)}))}async setMaxVideoChannels(g){return Promise.reject(60)}async stop(g=!1,m=generateCauseId(),S,v){const C=this.logger.createFnLogger("StopAudio",m);if(6===this.state)return C.logFailure("Trying to stop a call which is already Disconnecting"),Promise.reject(new Error("cannot stop call in Disconnecting state"));if(7===this.state)return C.logFailure("Trying to stop a call which is already Disconnected"),Promise.reject(new Error("cannot stop call in Disconnected state"));if(this.disposedPromise)return Promise.reject("Call already ended");let _=0;1===this.state&&(_=10);const E=v?{clientReasonSubCode:v.clientSubCode,clientReasonPhrase:v.clientPhrase}:{};v?.clientSubCode===Qt.SUB_CODE.VDI_DISCONNECTED&&this.mediaSession?.getSessionConfig()?.config.vdiDisconnectedTracking.enabled&&this.mediaSession?.getSessionConfig()?.config.vdiDisconnectedTracking.clientPhrases.includes(v?.clientPhrase)&&(E.code=Qt.CODE.MEDIA_ERROR,E.subCode=Qt.SUB_CODE.VDI_DISCONNECTED,E.phrase=fi.CallEndReasonVDIdisconnect,E.resultCategories=["UnexpectedClientError"],_=4);const T={terminatedReason:_,forEveryone:g,causeId:m,...S,rejectReason:E};return this.stopInternal(T)}publishState(g,m){const S=getPluginlessStateType(g.type),v=this.getPluginlessPublishLevel(g.level),C=g.participantIds&&g.participantIds.length>0?"specified":void 0;return this.callTelemetry.setOperationVariant("PublishState","specified"===C?`${S}Specified`:`${S}None`,m),this.signalingSession.publishStateAsync(S,v,m,g.content,C,g.participantIds)}publishStatesForEveryone(g,m){const S=getPluginlessStateType(g.type),v=this.getPluginlessPublishLevel(g.level),C="all";return this.callTelemetry.setOperationVariant("PublishState",`${S}All`),this.signalingSession.publishStateAsync(S,v,m,g.content,C)}removeState(g,m){return this.signalingSession.removeStateAsync(m,"specified",void 0,g.stateIds).then((g=>Promise.resolve()))}removeStatesForEveryone(g,m){const S=getPluginlessStateType(g.type);return this.signalingSession.removeStateAsync(m,"all",S,void 0).then((g=>Promise.resolve()))}updateMeetingSettings(g,m){return this.signalingSession.updateMeetingSettingsAsync({allowRaiseHands:g.allowRaiseHands,attendeeRestrictions:g.attendeeRestrictions,lockMeeting:g.lockMeeting,breakoutRoomsEnabled:g.breakoutRoomsEnabled,allowPresentersToManageBreakoutRooms:g.allowPresentersToManageBreakoutRooms,disableMdpClientAudioRecording:g.disableMdpClientAudioRecording,refreshSettings:g.refreshSettings},m)}updateMeetingGroups(g,m){this.logger.info(`[UpdateMeetingGroups][${g}] options ${safeJsonStringify(m)}`);const S=this._callOperationHandler.waitForOperation("UpdateMeetingGroups",g),v={fromGroup:m.fromGroup,toGroup:m.toGroup,scope:mapParticipantScope(m.scope)};return m.participants&&(v.participants=createParticipantListFromMriMap(m.participants)),this.signalingSession.updateMeetingsGroupsAsync(g,v).catch((m=>{this.logger.info(`[${g}] [UpdateMeetingGroups] error in updateMeetingGroups (synchronous error) : ${getPIISafeObject(m)}. updateMeetingGroupsPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingGroups",{error:getPIISafeObject(m)},g)})),S}updateMeetingLiveState(g,m){return this.logger.info(`[UpdateMeetingLiveState][${g}] options ${safeJsonStringify(m)}`),this.signalingSession.updateMeetingLiveStateAsync(g,m).catch((m=>{this.logger.info(`[${g}] [UpdateMeetingLiveState] error in updateMeetingLiveState (synchronous error) : ${getPIISafeObject(m)}. promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingLiveState",{error:getPIISafeObject(m)},g)})),this._callOperationHandler.waitForOperation("UpdateMeetingLiveState",g)}updateMeetingStates(g,m=generateCauseId()){var S;this.logger.info(`[UpdateMeetingStates][${m}]`);const v={},C=[];g.operationId=g.operationId||m;for(const _ of Object.keys(g.meetingStates)){const E=g.operationId+"_"+_;C.push(E);const T=this._callOperationHandler.createPendingOperation("UpdateMeetingStates",E,m);v[S=g.operationId]??(v[S]={}),v[g.operationId][_]=T,this.callTelemetry.recordOperation("UpdateMeetingStates",m,E)}return Promise.resolve().then((()=>this.signalingSession.updateMeetingStatesAsync(m,g))).then((g=>{for(const S of C)this.callTelemetry.updateOperationData("UpdateMeetingStates",{data:getPIISafeObject(g)},m,S)})).catch((g=>{for(const S of C)this.callTelemetry.updateOperationData("UpdateMeetingStates",{error:getPIISafeObject(g)},m,S);this.logger.logFailure(g)})).then((()=>v))}async updateParticipantInterpretationState(g,m){if(this.logger.info(`[UpdateParticipantInterpretationState][${g}] options ${safeJsonStringify(m)}`),0===m.length)return Promise.reject(getRejectTransactionEnd("Invalid UpdateParticipantInterpretationState options"));const S=this.signalingSession.updateParticipantInterpretationStateAsync(g,m),v=[];m.forEach((m=>{v.push(this._callOperationHandler.createPendingOperation("UpdateParticipantInterpretationState",m.id,g))}));for(let v=0;v<S.length;v++){const C=S[v],_=m[v];C.then((()=>{this.logger.logSuccess(`updateParticipantInterpretationState succeeded for [id=${scrubMriOrOmit(_.id)}]`);const m={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess("UpdateParticipantInterpretationState",m,_.id,g),this._callOperationHandler.maybeResolveOperation("UpdateParticipantInterpretationState",m,_.id,g)})).catch((m=>{this.logger.error(`[${g}] [UpdateParticipantInterpretationState] error in updateParticipantInterpretationState (synchronous error) : ${getPIISafeObject(m)}. updateParticipantInterpretationStatePromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateParticipantInterpretationState",{error:getPIISafeObject(m)},g);const S=this._handleParticipantOperationFailure("UpdateParticipantInterpretationState",m,g,_.id).reason,v=m?.endCode||S||0;this._callOperationHandler.maybeRejectOperation("UpdateParticipantInterpretationState",v,_.id,g)}))}return Promise.resolve(v)}async updateParticipantsProperties(g,m){const S=this.logger.createFnLogger("UpdateParticipantsProperties",m);if(S.info(`options ${scrubMriOrOmit(safeJsonStringify(g))}`),!g)return Promise.reject(getRejectTransactionEnd("Invalid input: UpdateParticipantsPropertiesContext"));const v={},C=g.scope,_=g.operationId,E=new Set;if("self"===C){const S=this.signalingSession.participantManager.localParticipant.id;for(const C in g.propertyBag){const g=mapMriAndPropertyNameToResolveString(S,_,C),T=this.createUpdateParticipantPromise(g,m);v[g]={[S]:T},E.add(g),this.callTelemetry.recordOperation("UpdateParticipantsProperties",m,scrubMriOrOmit(g))}}else{if("specified"!==C||!this._isUpdatePropertiesSpecifiedAllowedByEcs)return Promise.reject("This scope is not supported.");{const S=g.participants;for(const g of S){const S=g.id;for(const C in g.propertyBag){const g=mapMriAndPropertyNameToResolveString(S,_,C),T=this.createUpdateParticipantPromise(g,m);v[g]={[S]:T},E.add(g),this.callTelemetry.recordOperation("UpdateParticipantsProperties",m,scrubMriOrOmit(g))}}}}return S.info(`promises created: ${scrubMriOrOmit(safeJsonStringify(v))}`),this.signalingSession.updateParticipantsPropertiesAsync(g,E,_,m).catch((g=>{const C=getPrintableObject(g);S.info(`[failed][reason=${C}]`);const _={...g};this.callTelemetry.updateOperationData("UpdateParticipantsProperties",{error:getPIISafeObject(C)},m);for(const g of Object.keys(v))this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",_,g,m)})),Promise.resolve().then((()=>v))}joinMeetingGroup(g,m){this.logger.info(`[JoinMeetingGroup][${g}] options ${safeJsonStringify(m)}`);const S=this._callOperationHandler.waitForOperation("JoinMeetingGroup",g),v={meetingGroupId:m.meetingGroupId,...m.groupPreferences&&{groupPreferences:m.groupPreferences}};return this.signalingSession.joinMeetingGroupAsync(g,v).catch((m=>{const S=getPIISafeObject(m);this.logger.info(`[${g}] [JoinMeetingGroup] error in joinMeetingGroup (synchronous error) : ${S}. joinMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("JoinMeetingGroup",{error:S},g)})),S}leaveMeetingGroup(g,m){this.logger.info(`[LeaveMeetingGroup][${g}] options ${safeJsonStringify(m)}`);const S=this._callOperationHandler.waitForOperation("LeaveMeetingGroup",g),v={meetingGroupId:m.meetingGroupId};return this.signalingSession.leaveMeetingGroupAsync(g,v).catch((m=>{const S=getPIISafeObject(m);this.logger.info(`[${g}] [LeaveMeetingGroup] error in leaveMeetingGroup (synchronous error) : ${S}. leaveMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("LeaveMeetingGroup",{error:S},g)})),S}sendMessages(g,m){var S,v;this.logger.info(`[SendMessages][${g}]`);const C={};for(const _ of m)if(0===_.scope){const m=this._callOperationHandler.createPendingOperation("SendMessages",_.operationId,g);C[_.operationId]={all:m},this.callTelemetry.recordOperation("SendMessages",g,_.operationId)}else if(1===_.scope)for(const m in _.to)if("participant"===_.to[m].level){const v=mapMriToResolveString(m,_.operationId),E=this._callOperationHandler.createPendingOperation("SendMessages",v,g);C[S=_.operationId]??(C[S]={}),C[_.operationId][m]=E,this.callTelemetry.recordOperation("SendMessages",g,v)}else if("endpoint"===_.to[m].level)for(const S in _.to[m].participantLegIdMap){const m=mapLegIdToResolveString(S,_.operationId),E=this._callOperationHandler.createPendingOperation("SendMessages",m,g);C[v=_.operationId]??(C[v]={}),C[_.operationId][S]=E,this.callTelemetry.recordOperation("SendMessages",g,m)}return this.signalingSession.sendProxiedMessageAsync(g,m).then((g=>{for(const m of g)m.then((g=>{this._callOperationHandler.maybeResolveOperation("SendMessages",g.transactionEnd,g.resolveString,g.causeId)})).catch((g=>{this._callOperationHandler.maybeRejectOperation("SendMessages",g.transactionEnd,g.resolveString,g.causeId)}));return C}))}updateMonitorSession(g,m=generateCauseId()){return Promise.reject(new Error("Not implemented"))}async updateMeetingRoles(g,m,S=generateCauseId()){return 3===this.state&&this.signalingSession.hasOwnProperty("updateMeetingRolesAsync")?this.signalingSession.updateMeetingRolesAsync(g,m,S):Promise.reject({code:Qt.CODE.CLIENT_ERROR_CODE,subCode:Qt.SUB_CODE.ACTION_NOT_ALLOWED,phrase:"ActionNotAllowed"})}stopInternal(g){const m=this.logger.createFnLogger("stopInternal",g.causeId),S=g.terminatedReason||0;let v=g.rejectReason&&(g.rejectReason.code||g.rejectReason.subCode)?g.rejectReason:this.getRejectionInfoFromTerminatedReason(S);if(g.rejectReason&&(v||(v={}),v.clientReasonSubCode=g.rejectReason.clientReasonSubCode,v.clientReasonPhrase=g.rejectReason.clientReasonPhrase),m.info(`started, terminatedReason=${S}, rejectReason=${safeJsonStringify(v)}`),6===this.state)return m.logFailure("Trying to stop a call which is already Disconnecting"),this.disconnectingPromise;if(7===this.state)return m.logFailure("Trying to stop a call which is already Disconnected"),this.disconnectingPromise;this.setCallState(6,g.causeId,S);const C={causeId:g.causeId,forEveryone:g.forEveryone,scope:this.mapEndpointScope(g.scope),redirectOptions:g.redirectOptions&&convertRedirectOptions(g.redirectOptions)};return 1===g.scope&&(v.code=Qt.CODE.SUCCESS,v.subCode=Qt.SUB_CODE.ENDED_BY_REMOTE_ENDPOINT,v.phrase=fi.EndedByRemoteEndpoint),this.disconnectingPromise=Promise.all([this.cleanUpMedia(g.causeId,v).catch((g=>{throw m.logFailure(`cleanUpMedia failed with reason=${getPrintableObject(g)}`),g})),this.signalingSession.endAsync(v,C).catch((g=>{throw m.logFailure(`endAsync failed with reason=${getPrintableObject(g)}`),g}))]).catch((S=>{throw m.logFailure(S),this.cleanUp(g.causeId,v),S})).then((()=>this.cleanUp(g.causeId,v))).catch((m=>{throw this.callTelemetry.updateOperationData("StopCall",{error:getPIISafeObject(m)},g.causeId),this.setCallState(7,g.causeId,S),m})),this.disconnectingPromise}async cleanUp(g,m){return this.logger.info(`[${g}][cleanup]start`),this.disposedPromise||(this.disposedPromise=this.cleanUpFinalize(g,m),this._getCallEndOperation().catch(noop).then((()=>{const m={code:Qt.CODE.CLIENT_ERROR_CODE,subCode:Qt.SUB_CODE.ABANDONED};this._callOperationHandler.rejectPendingOperations(61,g,m),this._participantOperationHandler.rejectPendingOperations(47,g,m)}))),this.disposedPromise}async cleanUpMedia(g,m){return this.mediaDisposedPromise||(this.mediaDisposedPromise=(async()=>{this.callDeviceManager?.dispose(),this.callDeviceManager=null,this.turnOffLocalVideoPreview(g),this.localVideoContainer=null,this.disposeContentSharingSessions(),this.disposeSharingScreenHandle();const S=this.mediaSession;if(this.reportMediaStats=!!S,!S)return;this.unmixedAudioProvider.dispose(),this.mediaControlPlane.dispose(),this.dataChannel.dispose(),this.screenSharingControl.dispose(g),this.mediaSession=null,this.streamManager.setMediaSession(null,g),this.participants?.forEach((m=>{m.setMediaSession(null,g)}));const v=S.terminate(g,m);this.isVideoOn=!1,this.setMediaStream(this.isVideoOn,!1,1),this.setMediaStream(!1,!1,2),this.setMediaStream(!1,!1,0),this.isScreenSharingOn=!1,this.screenSharingRenegotiationDeferred?.reject(m),this.screenSharingRenegotiationDeferred=null,this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.removeModality(0),this.mediaStateConfigurationHelper.removeModality(3),this.mediaStateConfigurationHelper.removeModality(2),S?.getSessionConfig()?.config?.useOneDsLogger&&S.getSessionConfig().config.addTelemetryReportingCallback&&window.removeEventListener("beforeunload",this.beforeUnloadTelemetrySender);try{await v}finally{await this.collectCallStats(S)}})()),this.mediaDisposedPromise}async cleanUpFinalize(g,m){try{await this.cleanUpMedia(g,m)}catch(m){this.logger.info(`[${g}][cleanUpMedia] failure: ${getPrintableObject(m)}`)}const S=this.reportCallEndStats(this.reportMediaStats);this.mediaSession?.getSessionConfig().config.waitReportStatsAtCallStop&&await S}async createContentSharingSession(g,m,S,v,C=generateCauseId()){if("attendee"===(this.advancedMeetingRole||this.meetingRole)){const g={terminatedReason:8,terminatedReasonCode:403,terminatedReasonSubCode:0,errorMessage:"Failed due to insufficient permissions"};return Promise.reject(g)}const _=new zr(this.callTelemetry,this.logger,this.signalingSession,g,m,v,S);return this.contentSharingSessions.push(_),_.changed((()=>this.removeContentSessionIfEnded(_))),this.event("contentSharingChanged").raise(),Promise.resolve(_)}stopWithBeacon(g=generateCauseId()){return 6===this.state||7===this.state||this.signalingSession.endWithBeacon(g)}disposeContentSharingSessions(){this.contentSharingSessions.forEach((g=>{g.dispose(),this.removeContentSessionIfEnded(g)})),this.event("contentSharingChanged").raise()}isPreheatedOnly(){return!!(12===this.state||2===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall")||9===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))}removeContentSessionIfEnded(g){7!==g.contentSharingStatus&&8!==g.contentSharingStatus||(this.logger.info("stopping the content sharing session."),(0,_i.remove)(this.contentSharingSessions,(m=>m.contentSharingGuid===g.contentSharingGuid)).length&&this.event("contentSharingChanged").raise())}getRejectionInfoFromTerminatedReason(g){switch(g){case 53:return{code:li.MediaError,subCode:ci.MediaWhiteListingIssue,phrase:fi.MediaWhiteListingIssue};case 4:return{code:li.MediaError,subCode:this._wasAudioStreamConnected?ci.MediaDropAfterConnect:ci.MediaDropDuringConnect,phrase:this._wasAudioStreamConnected?fi.MediaDropAfterConnect:fi.MediaDropDuringConnect};case 47:return{code:li.MediaError,subCode:ci.MediaOfferProcessingError,phrase:fi.MediaOfferProcessingError};case 38:return{code:li.MediaError,subCode:ci.MediaRenegotiationError,phrase:fi.RetargetNotSupported};case 10:return{code:li.Reject,subCode:ci.Success,phrase:fi.CallEndReasonLocalUserInitiated};case 25:return{code:li.UnknownError,subCode:ci.MediaUnknownError,phrase:fi.MediaError};case 58:return{code:li.MediaError,subCode:ci.MediaPermissionError,phrase:fi.MediaPermissionError};case 7:return{code:li.UnknownError,subCode:ci.Success,phrase:fi.Unknown};case 0:case 1:return{code:li.Success,subCode:ci.Success,phrase:fi.CallEndReasonLocalUserInitiated};case 75:return{code:li.CallRedirected,subCode:ci.CallRedirectedSuccess,phrase:fi.CallEndReasonRedirected,resultCategories:["Success"]}}return null}async acknowledge(g,m,S=generateCauseId()){const v=this.logger.createFnLogger("Acknowledge",S),C=Date.now();if(this.setInitialTelemetry("Acknowledge",{callStartTime:C},"",S),0!==this.state&&8!==this.state)throw new Error(`Trying to acknowledge a call that has already been acted on ${this.state}`);v.info(`isMultiParty=${g.isMultiParty}`),v.info(`fromMixer=${g.fromMixer}`),v.info(`participantId=${g.participantId}`),v.info(`callType=${g.callType}`),this.attachToCallAndGetOffer=defer(),this.setCallType(g.isMultiParty?2:1,S),this.setCallUsesMixer(!!g.fromMixer,S),this.setCallerMri(stripMriAliases(g.callerId)),this.setTransferorMri(g.transferorId),this.transferorType=g.transferorType,this.transferorDisplayName=g.transferorDisplayName,this.incomingCallType=g.callType,this.consultativeCallId=g.consultativeCallId,this.callQueueInfo=g.callQueueInfo,this.setFromApplicationType(g.fromApplicationType,S),this.callStats.localStats.startCall();const _=createPhaseExecutor(v);try{_.executeSync("ProcessIncomingCallRequest",(()=>this.signalingSession.processIncomingCallRequest(g,m,S))),this.setParticipantId(this.participantId);if(_.executeSync("ResolvePotentialConflict",(()=>this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)))===this.signalingSession)return Promise.reject({code:7,success:!1});const mediaSetup=async()=>{_.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(S))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled());const g=this.signalingSession.getInitialMediaOfferFromIncomingCallPayload();this.callStats.setParticipantId(this.participantId),this.onBehalfOfMri=this.signalingSession.onBehalfOf,this.onBehalfOfUserDisplayName=this.signalingSession.onBehalfOfUserDisplayName,this.callPhoneLineType=this.signalingSession.callPhoneLineType;const m=await _.execute("WaitForMediaOffer",(()=>g?Promise.resolve(g):this.attachToCallAndGetOffer.promise));let C;try{C=await _.execute("ProcessOffer",(()=>this.mediaSession.processOfferAsync(m,S)))}catch(g){C=await this._handleOfferProcessingError(g,S,v)}await _.execute("ProcessOfferedModalities",(()=>this._processOfferedModalities(C,S))),await _.execute("TrySendingProvisionalAnswer",(()=>this._trySendProvisionalMediaAnswer(S)))},C=(()=>_.execute("SendAttach",(()=>this.signalingSession.sendAttachToCall(S))).then((()=>this.setCallState(1,S))))();return await Promise.all([C,mediaSetup()]).catch((async g=>{throw await C,g})),_.executeSync("OnAcknowledgeSuccess",(()=>this._onAcknowledgeSuccess(v,_.getTelemetryData(),S)))}catch(g){return this._onAcknowledgeError(g,S,v,_.getTelemetryData())}}async accept(g,m=generateCauseId()){const S=this.logger.createFnLogger("Accept",m);if(S.info(`accept, answerMediaType: ${g.answerMediaType},\n                            withVideo: ${g.withVideo},\n                            muted: ${g.muted},\n                            getSendMediaModalities: ${JSON.stringify(g.sendMediaModalities)},\n                            clientEndpointCapabilities: ${g.clientEndpointCapabilities},\n                            muteFlags: ${g.muteFlags}`),1!==this.state)throw new Error("Only calls in Notified state can be accepted");this.setCallOptions({callStartOptions:g,callStartTime:Date.now()}),this.setSessionIceTransportPolicy(g?.mediaConfiguration);const v=this._callOperationHandler.createPendingOperation("_ConnectCall",void 0,m);this.callStats.localStats.audio.start();const C=createPhaseExecutor(S);this.mediaSession.createAudioElement(m);const _=g.muted||1==(1&g.muteFlags);this.setMuted(_?2:this.isServerMuted?1:0,m),this.setCallState(2,m),this.connectCallPromise=this._callOperationHandler.waitForOperation("Accept");try{g.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient(),this.mediaStateConfigurationHelper.setCallAcceptOptions(g),this.mediaStateConfigurationHelper.isSending(1)&&await C.execute("StartVideoSafe",(()=>this.startVideoSafe(m))),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,m);const S=await C.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,m))),_=C.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(S)));await C.execute("handleEndpointStatesForAccept",(()=>this.handleEndpointStatesForAccept(2===this._muteState,g?.additionalEndpointProperties,m)));const E=await C.execute("CreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,m)));await C.execute("Accept",(()=>this.signalingSession.acceptAsync(E,_,g.clientEndpointCapabilities,m))),await C.execute("WaitForConnect",(()=>v)),this.handleRemoteParticipantStateInOneToOneCall(m),await C.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(m))),this.callTelemetry.updateOperationData("Accept",{phases:C.getTelemetryData()},m)}catch(g){let v=7,C={};throw this.callTelemetry.updateOperationData("Accept",this.getTelemetryFromPhaseExecution(g),m),g?.error&&(C={...g.error}),isOneOfPhaseErrors(vi,g)&&(v=47),this.mediaSession?.getSessionConfig().config.stopCallOnAcceptFailure&&this.stopInternal({terminatedReason:v,causeId:m,rejectReason:C}),g.terminatedReason=v,S.logFailure(g),g}}async reject(g=generateCauseId(),m){const S=m?{clientReasonSubCode:m.clientSubCode,clientReasonPhrase:m.clientPhrase}:{};return 1!==this.state?Promise.reject(60):this.stopInternal({terminatedReason:10,causeId:g,rejectReason:S})}async join(g,m={},S=generateCauseId()){const v=Date.now();return this.setInitialTelemetry("JoinCall",{callStartOptions:m,callStartTime:v},g.conversationUrl,S),this.setCallerMri(stripMriAliases(g.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinCall"),this.joinOrStartCall({callStartOptions:getCallStartOptions(m),callStartTime:v},this.joinGivenConversation,S,g.conversationUrl)}async joinPreheatedCall(g,m){const S=this.logger.createFnLogger("JoinPreheatedCall",m),v=this.isServerMuted||1==(1&g.muteFlags),C=2==(2&g.muteFlags),_=createPhaseExecutor(S);this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinPreheatedCall");try{const S={endpointProperties:{preheatProperties:0}};this.setCallState(2,m),this.isCallModeStreaming()||(v?S.state={isMuted:!0}:(await _.execute("UnmuteInput",(()=>this.mediaSession.unmuteInputAsync(m))),this.setMuted(0,m)),C||(await _.execute("UnmuteOutput",(()=>this.mediaSession.unmuteOutputAsync(m))),this.setSpeakerMuted(!1,m))),await this.signalingSession.updateEndpointState(S,m,g.publishedStates),this.computeCallState(m)}catch(g){const v=7;let C;return S.logFailure(` error: ${v} ${getPrintableObject(g)}`),isTransactionEnd(g)?C=g:isPhaseError("UnmuteInput",g)?C={code:li.LocalError,subCode:ci.MediaUnmuteMicrophoneError,phrase:getPrintableObject(g),causeId:m}:isPhaseError("UnmuteOutput",g)&&(C={code:li.LocalError,subCode:ci.MediaUnmuteSpeakerError,phrase:getPrintableObject(g),causeId:m}),this.callTelemetry.updateOperationData("JoinPreheatedCall",{phases:_.getTelemetryData(),error:getPIISafeObject(g)},m),this.stopInternal({causeId:m,terminatedReason:v,rejectReason:C}),Promise.reject(C)}}async start(g={},m=generateCauseId()){const S=Date.now();return this.setCallerMri(On+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCall",{callStartOptions:g,callStartTime:S},"",m),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCall"),this.joinOrStartCall({callStartOptions:getCallStartOptions(g),callStartTime:S},this.startOutgoingCall,m)}async startCallToVoicemail(g,m=generateCauseId()){const S=Date.now();return this.setCallerMri(On+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCallToVoiceMail",{callVoicemailStartOptions:g,callStartTime:S},"",m),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallToVoiceMail"),this.joinOrStartCall({callVoicemailStartOptions:g,callStartTime:S},this.startVM,m)}async joinCallWithoutCallModality(g,m={},S=generateCauseId()){const v=Date.now();this.setCallerMri(g.groupCallInitiator),this.setCallType(2,S);const C={callStartOptions:getCallStartOptions(m),callStartTime:v};return this.setInitialTelemetry("Subscribe",C,g.conversationUrl,S),0!==this.state?(this.logger.info(`[${S}][joinCallWithoutCallModality]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(C),this.setCallState(8,S),this.signalingSession.subscribeToCall(g.conversationUrl,this.callId,m.clientEndpointCapabilities,{meetingRegistrationId:m.meetingRegistrationId,participantPin:m.participantPin,clientEndpointDebugContent:m.clientEndpointDebugContent,additionalEndpointProperties:m.additionalEndpointProperties},S).catch((g=>isTransactionEnd(g)?(this.logger.info(`[${S}][joinCallWithoutCallModality] ${getPrintableObject(g)}`),Promise.reject(g)):Promise.reject(convertReason(g)))),this._callOperationHandler.waitForOperation("Subscribe",void 0,S))}startWithMeetingData(g,m){const S=Date.now();return this.setCallerMri(On+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartWithMeetingData",{callStartOptions:m,callStartTime:S},"",g),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartWithMeetingData"),this.joinOrStartCall({callStartOptions:getCallStartOptions(m),callStartTime:S,meetingPreferences:{shouldResurrect:m.shouldResurrect}},this.startOutgoingCall,g)}joinWithMeetingData(g,m,S){const v=Date.now();return this.setInitialTelemetry("JoinWithMeetingData",{callStartOptions:S,callStartTime:v},m.conversationUrl,g),this.setCallerMri(stripMriAliases(m.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinWithMeetingData"),this.joinOrStartCall({callStartOptions:getCallStartOptions(S),callStartTime:v,meetingPreferences:{shouldResurrect:S.shouldResurrect}},this.joinGivenConversation,g,m.conversationUrl)}subscribeWithMeetingData(g,m,S){const v=Date.now();this.setCallerMri(m.groupCallInitiator),this.setCallType(2,g);const C={callStartOptions:getCallStartOptions(S),callStartTime:v};return this.setInitialTelemetry("SubscribeWithMeetingData",C,m.conversationUrl,g),0!==this.state?(this.logger.info(`[${g}][subscribeWithMeetingData]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(C),this.setCallState(8,g),this.signalingSession.subscribeToCall(m.conversationUrl,this.callId,S.clientEndpointCapabilities,{meetingPreferences:{shouldResurrect:S.shouldResurrect},meetingData:this.meetingData,meetingRegistrationId:S.meetingRegistrationId,participantPin:S.participantPin,additionalEndpointProperties:S.additionalEndpointProperties},g).catch((m=>isTransactionEnd(m)?(this.logger.info(`[${g}][subscribeWithMeetingData] ${getPrintableObject(m)}`),Promise.reject(m)):Promise.reject(convertReason(m)))),this._callOperationHandler.waitForOperation("SubscribeWithMeetingData",void 0,g))}async startCallWithNudge(g,m={},S=generateCauseId()){this.setCallerMri(On+this.currentUserSkypeIdentity.id),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallWithNudge");const v=Date.now();if(this.logger.info(`[${S}][startCallWithNudge]startCallWithNudge for participants: ${scrubMriOrOmitList(g)}`),this.participants.length)return Promise.reject(48);if(m.isCast&&m.isHuddleGroupCall)return this.logger.logFailure(`isCast: ${m.isCast} isHuddleGroupCall: ${m.isHuddleGroupCall}`),Promise.reject(new Error("isCast or isHuddleGroupCall can only be set exclusively."));const C={};return C.callStartOptions=getCallStartOptions(m),C.invitationType=Di.INVITATION_TYPE.NUDGE,C.participantsToNudge=g,C.callStartTime=v,this.setInitialTelemetry("StartCallWithNudge",C,"",S),this.joinOrStartCall(C,this.startOutgoingCall,S)}async startAndUnpark(g,m,S={},v=generateCauseId()){this.setCallerMri(On+this.currentUserSkypeIdentity.id);const C=this.logger.createFnLogger("StartCallAndUnpark",v),_=Date.now();this.setInitialTelemetry("StartCallAndUnpark",{callStartTime:_},"",v),C.info(`startAndUnpark for context: ${g}, pickupCode :${m}`),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallAndUnpark");const E={};switch(E.callStartOptions=getCallStartOptions(S),E.pickupCode=m,E.parkContext=$t.SERVER_HOLD,g){case 0:E.parkContext=$t.PARK;break;case 1:E.parkContext=$t.SHARED_LINE;break;case 5:E.parkContext=$t.CALL_PARK;break;case 2:E.parkContext=$t.SERVER_HOLD;break;default:throw new Error(`[startAndUnpark] unsupported ParkContext name: ${g}`)}return this.addParticipant(`4:${E.parkContext}`).catch((g=>C.logFailure("Failed to add participant to unparked call"))),this.joinOrStartCall(E,this.startOutgoingCall,v)}async admitParticipant(g,m=generateCauseId()){const S=generateAliasedMri(g),v=this.getParticipant(S),C=this._getParticipantLegId(v),_=C?{participantLegId:C}:{};if(v&&7!==v.state){const S={code:0,subCode:3552,phrase:"Participant is not in lobby state"};return this.callTelemetry.maybeRecordOperationSuccess("AdmitParticipant",S,g,m,_),Promise.reject(S)}return this.admitParticipantToCall(S,m,C)}admit(g,m){return this.signalingSession.admitAsync(m)}async callMeBack(g,m,S=generateCauseId()){const v=generateAliasedMri(`${On}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri);return this.addCallMeBackParticipant(g,m||v,S)}async addParticipant(g,m={},S=generateCauseId()){return(await this.addParticipantsImpl([g],m,S,"addParticipant"))[0]}async addParticipants(g,m={},S=generateCauseId()){return this.addParticipantsImpl(g,m,S,"addParticipants")}async addParticipantsImpl(g,m={},S=generateCauseId(),v){if(this.logger.info(`[${S}][${v}] start`),this.isEmergency&&0===this.state&&(0!==this.participants.length||1!==g.length))return Promise.reject(new Error("Only 1 participant (the emergency operator) may be added to unstarted emergency calls"));if(m.participantInvitationData)try{JSON.stringify(m.participantInvitationData)}catch(g){throw this.logger.info(`[${S}][${v}] ${g}`),g}const C=[],_=[];if(g.forEach((g=>{const m=this.getOrCreateParticipant(g,S,!0);0===m.state||4===m.state?(_.push(m),C.push(this._participantOperationHandler.createPendingOperation("AddParticipant",m.id,S))):3===m.state?C.push(Promise.resolve(m)):this._participantOperationHandler.hasPendingOperationWithOperationId("AddParticipant",m.id)&&C.push(this._participantOperationHandler.waitForOperation("AddParticipant",m.id))})),0===_.length)return Promise.resolve(C);const E=!!m.disableUnmute,T=this.addParticipantsToCall(_,S,m.participantInvitationData,m.groupId,m.threadId,m.messageId,E,m.alternateId);return(0,_i.zip)(T,_).forEach((async([g,m])=>{try{await g;const v=this._getParticipantLegId(this.getParticipant(m.id)),C=v?{participantLegId:v}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},m.id,S,C),this._participantOperationHandler.maybeResolveOperation("AddParticipant",m,m.id,S)}catch(g){this._participantOperationHandler.maybeRejectOperation("AddParticipant",g,m.id,S)}})),this.raiseChanged(this._participantChangedEventSkipConfig),Promise.resolve(C)}async nudgeParticipants(g,m,S={},v=generateCauseId()){return 2!==this.state&&3!==this.state?Promise.reject(48):this.signalingSession.nudgeParticipantsAsync({participantsIds:m,causeId:v,invitationData:S.participantInvitationData,newGroupId:S.groupId,newThreadId:S.threadId,newMessageId:S.messageId})}mapEndpointScope(g){let m="none";switch(g){case 0:m="specified";break;case 1:case 1:m="all";break;default:m="none"}return m}async removeParticipant(g,m=generateCauseId(),S,v){const C=this.logger.createFnLogger("removeParticipant",m);C.info("start");const _=this.mapEndpointScope(v);return this.signalingSession.removeParticipantAsync({id:g,endpointId:S},m,_).catch((S=>{C.logFailure(`Participant was not removed from call, error=${S}`);const v=this._handleParticipantOperationFailure("RemoveParticipant",S,m,g).reason;return Promise.reject(v||38)}))}async searchParticipants(g,m){return this.signalingSession.searchParticipantsAsync(g.searchQueryOptions,m)}async getAllParticipants(g,m){return this.signalingSession.getAllParticipantsAsync(g.scope,m)}set dominantSpeakerInfo(g){this.internalDominantSpeakerInfo=g}get dominantSpeakerInfo(){return this.internalDominantSpeakerInfo?this.internalDominantSpeakerInfo:this.mediaSession?.getSessionConfig().config.emptyInitialDSH?{speakerList:[],timestamp:null,noCurrentDominantSpeaker:!1}:{speakerList:this.participants.filter((g=>3===g.state)).map((g=>g.id)),timestamp:null,noCurrentDominantSpeaker:!1}}set slowedDownActiveTalkerInfo(g){(0,_i.isEqual)(this.internalSlowedDownActiveTalkerInfo?.speakerList,g.speakerList)||(this.internalSlowedDownActiveTalkerInfo=g,this.raiseChanged())}get slowedDownActiveTalkerInfo(){return this.internalSlowedDownActiveTalkerInfo}startVideoSafe(g){return this.startVideo(g).catch((m=>{this.logger.info(JSON.stringify(m),"startVideoSafe",g)}))}async joinOrStartCall(g,m,S,v){const C=this.logger.createFnLogger("joinOrStartCall",S);if(0!==this.state&&8!==this.state&&!g.isPromotingToRealtime){const g="Trying to start a call that has already been acted on";return C.logFailure(g),Promise.reject(60)}if(this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)===this.signalingSession)return Promise.reject(57);this.callStats.localStats.startCall();const _=8===this.state||1!==this.participants.length;C.info(`isMultiparty=${_}, reason: participants.length=${this.participants.length}`),this.setCallType(_?2:1,S),this.setCallUsesMixer(_,S),this.setCallOptions(g);const E=g.callStartOptions||{};if(1==(1&E.preheatFlags))this.setMuted(2,S),this.setSpeakerMuted(!0,S),this.setCallState(11,S);else{const g=!!E&&(E.muted||1==(1&E.muteFlags));this.setMuted(g?2:this.isServerMuted?1:0,S),this.setCallState(2,S)}const T=calculateJoinedFromForTelemetry(this.meetingData,this.threadId,this.messageId,this.groupId,!!v);this.callTelemetry.setJoinedFrom(T),this.signalingSession.setJoinedFrom(T),this.setHuddleGroupCall(!!g.callStartOptions?.isHuddleGroupCall);const I=this._callOperationHandler.createPendingOperation("_ConnectCall","",S);return I.catch(noop),await this.joinOrStartWithMedia(g,m,g.callStartTime,I,S,v),g.callStartOptions?.meetingRegistrationId&&this.callTelemetry.setHasMeetingRegistrationId(!0),g.callStartOptions?.participantPin&&this.callTelemetry.setHasParticipantPin(!0),I}setSessionIceTransportPolicy(g){const m=g?.connectionType;let S=Ke.ICE_TRANSPORT_POLICY.all;switch(m){case"AllSupported":S=Ke.ICE_TRANSPORT_POLICY.all;break;case"NoDirectConnection":S=Ke.ICE_TRANSPORT_POLICY.relay}this.mediaSession?.getSessionConfig().setIceTransportPolicy?.(S)}async joinOrStartWithMedia(g,m,S,v,C,_){const E=this.logger.createFnLogger("joinOrStartWithMedia",C);this.callStats.localStats.audio.start();const T=g.callStartOptions,I=T&&1&T.preheatFlags,b=createPhaseExecutor(E);if(g.callStartOptions?.sendMediaModalities&&(this.mediaStateConfigurationHelper=new ar(g.callStartOptions.sendMediaModalities)),this._preferredMpLocation){g.callStartOptions=g.callStartOptions||{};const m=g.callStartOptions.clientEndpointDebugContent?JSON.parse(g.callStartOptions.clientEndpointDebugContent):{};g.callStartOptions.clientEndpointDebugContent=JSON.stringify({preferredMpLocation:this._preferredMpLocation,...m})}try{T&&!I&&this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)&&this.mediaStateConfigurationHelper.isSending(2)&&(this.setCallUsesMixer(!0,C),await(await this.getScreenHandle()).acquire()),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,C),this.callUsesMixer||this.mediaStateConfigurationHelper.disableModality(2),E.info(`skipSharingModality=${!this.callUsesMixer}`),b.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(C))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.getSessionConfig().config.alwaysNegotiateDataChannel&&this.mediaStateConfigurationHelper.enableModality(3),this.setSessionIceTransportPolicy(g?.callStartOptions?.mediaConfiguration),this.mediaSession.createAudioElement(C),this.callUsesMixer||_||this.isOneToOnePSTNCall()||g.callVoicemailStartOptions||(this.isSomeoneStreamingVideo=!0);const A=this._callOperationHandler.createPendingOperation("_WaitForAnswer","",C,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});A.catch(noop);let R=!1;g.isPromotingToRealtime?(this.isSpeakerMuted=!0,R=!0,await b.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(C))),await b.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(C)))):T&&(I?(R=!0,await b.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(C))),await b.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(C))),this.setMuted(2,C),this.setCallUsesMixer(!0,C)):this.mediaStateConfigurationHelper.isSending(1)&&await b.execute("StartVideoSafe",(()=>this.startVideoSafe(C)))),T?.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient();const P=await b.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,C))),M=await b.execute("CreateOffer",(()=>this.mediaSession.createOfferAsync(C))),w=b.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(this.calculateModalityDirections({},C))));if(this.mediaStateConfigurationHelper.isSending(2)&&this.updateScreenSharingState(P,C),R||(await b.execute("MuteUnmute",(()=>this.muteUnmute(2===this._muteState,C))),await b.execute("MuteUnmuteSpeakers",(()=>this.muteUnmuteSpeaker(this.isSpeakerMuted,C)))),b.executeSync("CallStart",(()=>m(C,g,M,w,S,_))),await b.execute("WaitForConnect",(()=>v)),!this.isCallModeStreaming()||g.isPromotingToRealtime){const g=await b.execute("WaitForAnswer",(()=>A));if(!this.mediaSession?.processAnswerAsync)throw{error:"NoMediaSession",phase:"ProcessAnswer"};await b.execute("ProcessAnswer",(()=>this.mediaSession.processAnswerAsync(g,C,!1))),await b.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(C)))}this.callTelemetry.updateOperationData("_ConnectCall",{phases:b.getTelemetryData()},C),2!==T?.screenshareDirection&&4!==T?.screenshareDirection||(this.screenSharingControl.initControlForSharer(""),this.enableControlInjector())}catch(g){this.catchJoinOrStartCallError(g,C,E,b.getTelemetryData())}}catchJoinOrStartCallError(g,m,S,v){let C,_=0;throw S.logFailure(getPrintableObject(g)),g?.error&&(C={...g.error}),isPhaseError("MuteInput",g)?(_=7,C={code:li.LocalError,subCode:ci.MediaMuteMicrophoneError,phrase:getPrintableObject(g),causeId:m}):isPhaseError("MuteOutput",g)?(_=7,C={code:li.LocalError,subCode:ci.MediaMuteSpeakerError,phrase:getPrintableObject(g),causeId:m}):g?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer||isOneOfPhaseErrors(vi,g)?_=47:g?.type===this.mediaAgent.constants.MEDIA_ERROR.permissionDeniedError?(_=58,C={code:li.MediaError,subCode:ci.MediaPermissionError,phrase:getPrintableObject(g),causeId:m}):isPhaseError("WaitForAnswer",g)||isPhaseError("WaitForConnect",g)?_=g.error:isOneOfPhaseErrors(Si,g)&&(_=7),this.callTelemetry.updateOperationData("_ConnectCall",this.getTelemetryFromPhaseExecution(g),m),this.callSetupFailed=!0,Promise.all([this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",_,"",m),this._callOperationHandler.maybeRejectOperation("_ConnectCall",_,"",m)]).then((()=>{this.isPromotingToRealtime()||this.stopInternal({causeId:m,terminatedReason:_,rejectReason:C})})).catch(noop),_}addCallMeBackParticipant(g,m,S){const v=this._participantOperationHandler.waitForOperation("CallMeBack",g),C=this.logger.createFnLogger("CallMeBack",S),_={id:g,assertedId:m};return this.signalingSession.callMeBackAsync(_).then((()=>{C.logSuccess(`successfully executed call me back, participantId = ${scrubMriOrOmit(g)}`),this._participantOperationHandler.resolveOperation("CallMeBack",0,g)})).catch((v=>{C.logFailure(`Call me back failed, participantId = ${scrubMriOrOmit(g)}, error = ${v}`),this._handleParticipantOperationFailure("CallMeBack",v,S,m,!1);const _=this._processError(v);let E={};_&&(E={..._}),E.failureReason=_.reason?_.reason:11,this._participantOperationHandler.rejectOperation("CallMeBack",E,g)})),v}addParticipantsToCall(g,m,S,v,C,_,E,T){const I=this.logger.createFnLogger("addParticipantsToCall",m);g.forEach((g=>{g.setState(1,void 0,m)}));const b=g.map((g=>({id:g.mri})));I.info(`participantIds=${g.map((g=>scrubMriOrOmit(g.id)))}, disableUnmute=${E}`);const A={additionalData:S,groupId:v,threadId:C,messageId:_,disableUnmute:E,alternateId:T};try{const g=this.signalingSession.addParticipantsAsync(b,A,m);return(0,_i.zip)(g,b).map((async([g,S])=>{try{const v=await g;this.signalingNotifications.onParticipantJoined(v,m);const C=this._getParticipantLegId(this.getParticipant(S.id)),_=C?{participantLegId:C}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},v.id,m,_)}catch(g){const v=this._handleParticipantOperationFailure("AddParticipant",g,m,S.id).reason;throw this._removeParticipant(S,m,v),v}}))}catch(g){return I.logFailure(`Participants was not added to call, error=${g}`),(0,_i.range)(b.length).map((()=>Promise.reject(1)))}}async mergeCallByAddParticipantWithReplaces(g,m,S,v,C,_,E,T){const I=this.logger.createFnLogger("mergeCallByAddParticipantWithReplaces",_),b=this.convertClientScenario(T),A={additionalData:g.additionalData,groupId:g.groupId,threadId:g.threadId,messageId:g.messageId,callIdToReplace:S.callId,replacementType:v,clientScenario:b},R=await this.signalingSession.addParticipantsAsync(m,A,_);for(let g=0;g<R.length;g++){const S=3===v?m[g].participantId:m[g].id;try{await R[g],I.logSuccess(` [participantInfos id =${scrubMriOrOmit(m[g].id)}]`);const v={debugContent:{replacementParticipantLegId:m[g].replacementParticipantId||void 0,clientScenario:b},participantLegId:m[g].participantId},E={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(C,E,S,_,v),this._callOperationHandler.maybeResolveOperation(C,E,S,_)}catch(v){I.logFailure(`Participant was not added to call, error=${safeJsonStringify(v)}`);const E=this._handleParticipantOperationFailure(C,v,_,S,!0,b).reason;this._removeParticipant(m[g],_,E);const T=v?v.endCode:E||0;this._callOperationHandler.maybeRejectOperation(C,T,S,_)}}return Promise.resolve(E)}admitParticipantToCall(g,m,S){const v=this.logger.createFnLogger("admitParticipantToCall",m),C={id:g};return v.info("start"),this.signalingSession.admitParticipantAsync(C,m).then((C=>{v.info(`successfully admitted participant to call, participantId = ${scrubMriOrOmit(g)}`);const _=S?{participantLegId:S}:{},E={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess("AdmitParticipant",E,g,m,_)})).catch((S=>{v.logFailure(`Participant was not admitted to call, error=${S}`);const C=this._handleParticipantOperationFailure("AdmitParticipant",S,m,g);return Promise.reject(C)}))}_processError(g){let m;const S={reason:m};if(g?.endCode){const v=getTerminationCode(g.endCode.code,g.endCode.subCode);m=_PluginlessCall.getParticipantReasonFromTerminatedReason(v),S.reason=m,S.code=g.endCode.code,S.subCode=g.endCode.subCode,S.resultCategories=g.endCode.resultCategories,S.phrase=g.endCode.phrase}else S.phrase=`${g}`;return this.logger.info(`_processError error=${g} telemetryData=${JSON.stringify(S)}`),S}_handleParticipantOperationFailure(g,m,S,v,C=!0,_){this.callTelemetry.updateOperationData(g,{error:getPIISafeObject(m)},S,v);const E=this._processError(m),T=this.getParticipant(v);E.code&&T&&(T.callEndDiagnosticsInfo={callControllerCode:E.code,callControllerSubCode:E.subCode,phrase:E.phrase,resultCategories:E.resultCategories});try{if(C){const m={debugContent:{clientScenario:_},participantLegId:this._getParticipantLegId(T)||void 0};this.callTelemetry.recordOperationFailure(g,E,v,S,m)}}catch(g){this.logger.info(`_handleParticipantOperationFailure errow during recordOperationFailure ${g}`)}return E}_getParticipantLegId(g){return(0,_i.has)(g,"endpoints.endpointDetails")&&g.endpoints.endpointDetails.length&&g.endpoints.endpointDetails[0].participantId?g.endpoints.endpointDetails[0].participantId:null}isOneToOnePSTNCall(){const g=this.signalingSession.isIncomingCall?this.callerMri:this.participants.length>0?this.participants[0].id:"";return this.isOneToOneCall()&&(0,_i.startsWith)(g,Ln)&&(!this.incomingCallType||!this.callUsesMixer)}isParkedCall(){return this.isOneToOnePSTNCall()&&!!this.callOptions?.parkContext}async updateMediaModalities(g={},m=generateCauseId()){let S;const v=this.logger.createFnLogger("updateMediaModalities",m);return v.info(`callUsesMixer=${this.callUsesMixer},isSomeoneSharing=${this.isSomeoneSharing},isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),v.info(`options=${safeJsonStringify(g)},requestHoldState=${this.requestedHoldState},requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}`),S=g.modalityOverride?g.modalityOverride:this.requestedHoldState&&!this.isMuteOnHold?this.getMediaModalitiesForHold(m):this.calculateModalityDirections(g?.offered,m),v.info(`modalities=${safeJsonStringify(S)}`),await this.mediaSession.configureModalitiesAsync(S,m),S}calculateModalityDirections(g={},m){const S=this.logger.createFnLogger("calculateModalityDirections",m);S.info(`callUsesMixer=${this.callUsesMixer}, isEscalationInProgress=${this.isEscalationInProgress}`);const v={audio:this.calculateAudioDirection(g.audio,S),video:this.calculateVideoDirection(g.video,S),sharing:this.calculateSharingDirection(g.sharing,S),data:this.calculateDataDirection(g.data,S)};return S.info(`done, modalities=${safeJsonStringify(v)}`),this.deleteExtraneousModalities(v,m),v}calculateAudioDirection(g,m){if(m.info(`calculateAudioDirection, offer=${g}, requestedAudioState=${this.mediaStateConfigurationHelper.isSending(0)}`),this.receiveOnlyAudioOnCallStart)return m.info("calculateAudioDirection, direction=recvonly, receiveOnlyAudioOnCallStart=true"),"recvonly";if(this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)||"inactive"===g)return"inactive";return this.mediaSession.getAllowedModalities().audio.some((g=>g===Er.send||g===Er.sendReceive))?"sendrecv":"sendonly"===g?"inactive":"recvonly"}calculateVideoDirection(g,m){const S=this.mediaStateConfigurationHelper.isSending(1);if(m.info(`calculateVideoDirection, offer=${g}, requestedVideoState=${S}, isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),this.mediaStateConfigurationHelper.isInactiveOrDisabled(0))return"inactive";let v=S,C=this.isSomeoneStreamingVideo||this.callUsesMixer||this.isEscalationInProgress;return g&&(v=v&&("sendrecv"===g||"sendonly"===g),C=C&&("sendrecv"===g||"recvonly"===g)),v?"sendrecv":C?"recvonly":"inactive"}calculateSharingDirection(g,m){return m.info(`calculateSharingDirection, offer=${g}, requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}, isSomeoneSharing=${this.isSomeoneSharing}`),"inactive"===g?"inactive":this.mediaStateConfigurationHelper.isSending(2)?"sendonly":this.isSomeoneSharing||this.callUsesMixer||this.isEscalationInProgress?"recvonly":void 0}calculateDataDirection(g,m){const S=this.mediaStateConfigurationHelper.isSending(3);if(m.info(`calculateDataDirection, offer=${g}, dataEnabled=${S}`),this.allowDataChannel())return S?"inactive"===g?"inactive":"sendrecv":void 0;m.info("calculateDataDirection, disabling data since ECS flag prohibits it")}getMediaModalitiesForHold(g){this.logger.info(`[${g}][getMediaModalitiesForHold]`);const m="inactive",S={audio:m,video:m,data:this.allowDataChannel()?m:void 0,sharing:m};return this.deleteExtraneousModalities(S,g),S}deleteExtraneousModalities(g,m){!hasSendDirectionality(g.video)&&this.mediaStateConfigurationHelper.isDisabled(1)&&(this.logger.info(`[${m}][deleteExtraneousModalities] skipping videoModality`),delete g.video),!hasSendDirectionality(g.sharing)&&this.mediaStateConfigurationHelper.isDisabled(2)&&(this.logger.info(`[${m}][deleteExtraneousModalities] skipping sharingModality`),delete g.sharing)}getSignalingMediaTypes(g){const isSendActive=g=>g===this.mediaAgent.constants.MEDIA_STATE.send||g===this.mediaAgent.constants.MEDIA_STATE.sendReceive,m=[];return g.audio&&g.audio!==this.mediaAgent.constants.MEDIA_STATE.inactive&&m.push("Audio"),isSendActive(g.video)&&m.push("Video"),g.sharing===this.mediaAgent.constants.MEDIA_STATE.send?m.push("ScreenSharer"):g.sharing===this.mediaAgent.constants.MEDIA_STATE.receive&&m.push("ScreenViewer"),m}enableControlInjector(){if(this.allowScreenSharingControl()){if(this.getlocalScreenShareStream()){const g=this.mediaSession?.getLocalMediaTrackId("ScreenShare")??"";this.screenSharingControl.enableControlInjector(g)}else this.logger.warn("enableControlInjector: no local screenshare stream found")}}createCallDeviceManager(){return new Gs(this.mediaAgent.getConfigProvider().config.allowVirtualDeviceInCall,this.mediaAgent.getDeviceManager(),this.logger.createChild("CallDeviceManager"),this.callStats,(g=>this.isMediaSending(g)))}initializeSignalingSession(g){if(this.signalingSession)return void this.logger.info("Session already exists!");const m=Di.CALL_STATUS;if(this.localSignalingParticipant={id:generateAliasedMri(`${On}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri),displayName:this.currentUserSkypeIdentity.displayName,endpointDetails:[],languageId:null,participantId:g,endpointId:null},this.accountConfiguration){if(this.localSignalingParticipant.applicationType=this.accountConfiguration.applicationType,this.callTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.localSignalingParticipant.ring=this.accountConfiguration.ring,this.callTelemetry.setRing(this.accountConfiguration.ring),this.localSignalingParticipant.region=this.accountConfiguration.region,this.callTelemetry.setRegion(this.accountConfiguration.region),this.localSignalingParticipant.userHexCID=this.accountConfiguration.userHexCID,this.callTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.localSignalingParticipant.partition=this.accountConfiguration.partition,this.callTelemetry.setPartition(this.accountConfiguration.partition),this.localSignalingParticipant.acsResourceId=this.accountConfiguration.acsResourceId,this.callTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.callStats.setAcsResourceId(this.accountConfiguration.acsResourceId),this.accountConfiguration.serviceUrls){const g=this.accountConfiguration.serviceUrls.calling_conversationServiceUrl,m=this.accountConfiguration.serviceUrls.calling_uploadLogRequestUrl;this.signalingAgent.updateUrls(g,m,this.accountConfiguration.enforceUrls)}this.localSignalingParticipant.clientType=this.accountConfiguration.clientType,this.callTelemetry.setClientType(this.accountConfiguration.clientType)}this.callStats.localStats.setLocalUserId(this.localSignalingParticipant.id),this._callOperationHandler&&this._callOperationHandler.resetOperationChain(),this.signalingNotifications={onPromotionCompleted:(g,m,S)=>{this.logger.info(`[${S}][onPromotionCompleted] isFailed=${g} reason=${safeJsonStringify(m)} callMode=${this.callMode}`);const v=g?m:{code:0,subCode:0};if(this.callTelemetry.recordEvent("PromotionCompleted",{reason:v},S),g){const g=convertReason(m);this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",g,"",S),this._callOperationHandler.maybeRejectOperation("_CallStartOrJoinInitiated",g,"",S),this._callOperationHandler.maybeRejectOperation("_ConnectCall",g,"",S),this.promotionCompletedDeferred?.reject(g)}else this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,S),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,S);this.participants.forEach((g=>{g.applyCachedMediaStreams(S)}))},onCallStatusChanged:(g,S,v=generateCauseId())=>{const C=this.logger.createFnLogger("onCallStatusChanged",v);let _=`[status=${g}]`;if(S&&(_+=`[reason=${safeJsonStringify(S)}]`,void 0!==S.code&&(this.callEndDiagnosticsInfo={callControllerCode:S.code,callControllerSubCode:S.subCode,phrase:S.phrase,resultCategories:S.resultCategories},(S.overflowJoinInformation||S.registrationInformation)&&(this.callEndDiagnosticsInfo.additionalDiagnostics={overflowInformation:S.overflowJoinInformation,registrationInformation:S.registrationInformation}))),C.info(_),this.callTelemetry.recordEvent("_SignalingStateChanged",{status:g,reason:S},v),g===m.CONNECTING)!this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(C.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback()),this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,v);else if(g===m.RINGING)2===this.audioStreamState?(this.setCallState(9,v),this.participants.forEach((g=>g.setState(6,void 0,v)))):this.participants.forEach((g=>g.setState(2,void 0,v))),this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,v);else if(g===m.CONNECTED_FOR_ROSTER_ONLY)this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,v),this._callOperationHandler.maybeResolveOperation("SubscribeWithMeetingData",void 0,void 0,v);else if(g===m.CONNECTED){this._callIsSetupComplete=!0;const g=this.getLocalSignalingEndpointDetails();(g?.isLobby||g?.streamLobby)&&(this._callInLobby=!0,this.updateCapabilities(v,!0));const m=this.signalingSession.participantManager.localParticipant.isStaging;if(11===this.state)this.setCallState(12,v);else if(this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))C.info("wait for joinPreheatedCall to resolved");else if(this._callInLobby)C.info("[inLobby] Override Connected state from signaling agent"),this.setCallState(10,v);else if(m)this.setCallState(13,v);else{if(3===this.state&&!this._callOperationHandler.hasPendingOperation("_CallStartOrJoinInitiated")&&!this._callOperationHandler.hasPendingOperation("_ConnectCall"))return void C.info("Return: Don't re-send setup telemetry if call was already connected and operations are completed");this.setCallState(3,v),this.handleRemoteParticipantStateInOneToOneCall(v)}this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,v),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,v),this.reportTsCallingTelemetry(!0)}else if(g===m.LOCAL_TERMINATED||g===m.REMOTE_TERMINATED){let _=this.callSetupFailed?7:convertReason(S);if(8===this.state&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData"]))return this.signalingSession.resetState(),this._callOperationHandler.maybeRejectOperation("Subscribe",_,void 0,v),this._callOperationHandler.maybeRejectOperation("SubscribeWithMeetingData",_,void 0,v),void C.info("Subscribe failed, there is pending start/join operation, ignore call end message");if((2===this.state||6===this.state||8===this.state)&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData","Subscribe","SubscribeWithMeetingData"])){const g={code:this.callEndDiagnosticsInfo.callControllerCode,subCode:this.callEndDiagnosticsInfo.callControllerSubCode,phrase:this.callEndDiagnosticsInfo.phrase,reason:_};this._callOperationHandler.maybeRejectOperations(["Accept","JoinCall","JoinWithMeetingData","JoinPreheatedCall","StartCall","StartCallAndUnpark","StartCallToVoiceMail","StartCallWithNudge","StartWithMeetingData","Subscribe","SubscribeWithMeetingData"],_,void 0,v,g)}this.signalingSession.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:this.signalingSession.acceptedElsewhereBy.id,displayName:this.signalingSession.acceptedElsewhereBy.displayName}),this.signalingSession.parkAdditionalContextJson&&(this.parkAdditionalContextJson=this.signalingSession.parkAdditionalContextJson),this.signalingSession.serverHoldLocation&&(this.serverHoldLocation=this.signalingSession.serverHoldLocation),this._callOperationHandler.hasPendingOperation("CallParkV2")&&S.pickupCode&&0===S.code&&this._callOperationHandler.resolveOperation("CallParkV2",""+S.pickupCode,void 0,v),1!==_&&(this.mediaRelayWhiteListingIssue&&(_=53),S?.code===li.MediaError&&S?.subCode===ci.MediaPermissionError&&(_=58),C.info(`[terminated][reason=${safeJsonStringify(S)}]`)),this._callOperationHandler.maybeRejectOperation("CallParkV2",_,"",v),this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",_,"",v),this._callOperationHandler.maybeRejectOperation("_ConnectCall",_,"",v);const E=this.mediaSession?.getSessionConfig().config.setDisconnectAfterCleanUp;if(E?this.setTerminatedReason(_):this.setCallState(7,v,_),this.participants.forEach((g=>g.setState(4,void 0,v))),!this.disconnectingPromise){const _={...S,remoteTerminated:g===m.REMOTE_TERMINATED};this.disconnectingPromise=this.cleanUp(v,_).catch((g=>{C.logFailure(`Error when cleaning up the call, callId = ${this.callId}, error = ${g}`)}))}E&&this.disconnectingPromise.finally((()=>{7!==this.state&&this.setCallState(7,v,_)}))}},onOffer:(g,m=generateCauseId())=>{const S=this.logger.createFnLogger("onOffer",m);S.info(`${safeJsonStringify((0,_i.omit)(g,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(g.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnOffer",this.prepareTelemetryForOfferAnswer(g),m),g.transferor?.details?.id&&this.setTransferorMri(g.transferor.details.id),g.transferor?.transferorType&&(this.transferorType=g.transferor.transferorType),g.transferor?.details?.displayName&&(this.transferorDisplayName=g.transferor.details.displayName),this.clientTransferContext=g.clientTransferContext,this.invitationData=g.invitationData,this.spamRiskLevel=g.riskLevel,this.spamStirAttestation=g.stirAttestation,g.mediaContent.isTwoPartyToMultiPartyEscalation&&this.setIsEscalationInProgress(!0,m),g.renegotiation?this.requestedHoldState&&this._pendingParkPromise?this.renegotiateIncoming(g.mediaContent,m):this._callOperationHandler.executeChained((()=>this.renegotiateIncoming(g.mediaContent,m)),"_RenegotiateIncoming",m,m,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}):(S.info("resolving attach / offer promise"),this.attachToCallAndGetOffer.resolve(g.mediaContent))},onNewOffer:(g,m=generateCauseId())=>{const S=this.logger.createFnLogger("onNewOffer",m);this.newOfferRequestDeferred?(S.info("onNewOffer"),this.newOfferRequestDeferred.resolve(g.mediaContent)):S.info("callback received but new offer was not requested")},onAnswer:(g,m=generateCauseId())=>{const S=this.logger.createFnLogger("onAnswer",m);if(S.info(`${safeJsonStringify((0,_i.omit)(g,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(g.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnAnswer",this.prepareTelemetryForOfferAnswer(g),m),g.renegotiation)S.info("resolving previous renegotiation promise"),this.renegotiationAnswerDeferred.resolve(g.mediaContent);else if(S.info("resolving final answer promise"),g.provisional){const S=this.isOneToOnePSTNCall()&&(0,_i.startsWith)(g.remoteParticipantId,Ln);this.mediaSession.processAnswerAsync(g.mediaContent,m,!0,S)}else this._callOperationHandler.maybeResolveOperation("_WaitForAnswer",g.mediaContent,void 0,m),this.handleRemoteParticipantStateInOneToOneCall(m);g.provisional||!g.mediaContent.fromMixer||this.callUsesMixer||this._callOperationHandler.executeChained((async()=>{this.setCallUsesMixer(!0,m),this.mediaStateConfigurationHelper.isDisabled(2)&&this.mediaStateConfigurationHelper.removeModality(2),await this.updateMediaModalities(void 0,m);const g=!(this.isSomeoneSharing||this.isScreenSharingOn||this.isVideoOn);return this.mediaSession.getSessionConfig().config.disableImmidiateEscalationReconnect&&g?(S.info("Delaying reconnect"),this._hasDelayedReconnect=!0,Promise.resolve()):this.mediaSession.reconnectAsync(m,!0)}),"_CallEscalatedToConference",m,m,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})},onMediaAcknowledgementSuccess:(g,m=generateCauseId())=>{this.logger.info(`isRenegotiation: ${g}`,"onMediaAcknowledgementSuccess",m),this._callOperationHandler.resolveOperation("_MediaAcknowledgment",void 0,void 0,m)},onMediaAcknowledgementFailure:(g,m,S=generateCauseId())=>{this.logger.createFnLogger("onMediaAcknowledgementFailure",S).logFailure(safeJsonStringify(m)),this._callOperationHandler.rejectOperation("_MediaAcknowledgment",m,S)},onMediaRenegotiationRejection:(g,m=generateCauseId())=>{this.logger.createFnLogger("onMediaRenegotiationRejection",m).logFailure(safeJsonStringify(g)),this.renegotiationAnswerDeferred.reject(g)},onRosterHandlingComplete:()=>{this.logger.info(`[onRosterHandlingComplete] ${this._publishedStatesModified}`),0!==this._publishedStatesModified&&(this.processPublishedStates(),this._publishedStatesModified=0)},onMeetingGroupDetailsUpdated:(g,m=generateCauseId())=>{this.meetingGroupDetails!==g&&(this.callTelemetry.recordEvent("_UpdateMeetingGroupDetails",g,m),this.logger.info(`[${m}][onMeetingGroupDetailsUpdated] update meetingGroupDetails from ${JSON.stringify(this.meetingGroupDetails)} to ${JSON.stringify(g)}`),this.meetingGroupDetails=g,this.raiseChanged())},onSelfParticipantUpdated:(g,m=generateCauseId())=>{this.logger.info(`[${m}][onSelfParticipantUpdated]`),this.updateLocalParticipant(g,m),this.raiseChanged()},onParticipantMriUpdated:(g,m,S=generateCauseId())=>{this.logger.info(`[${S}][onParticipantMriUpdated]`);const v=this.getParticipant(g);v&&(v.id=m,this.raiseChangedDeferred())},onParticipantUpdated:(g,m=generateCauseId())=>{this.logger.info(`[${m}][onParticipantUpdated]: ${scrubSignalingParticipant(g)}`);const S=this.getOrCreateParticipant(g.id,m,!0);S.displayName=g.displayName;const v=_PluginlessCall.getStreamsFromEndpoints(g.endpointDetails),C=(0,_i.some)(g.endpointDetails,(g=>g?.streamInformation));this.callUsesMixer||v.length>0||C?(this.updateParticipantStreams(S,g,v,m),this.updateCallParticipantFromSignalingParticipant(S,g,m)):S.setState(3,void 0,m),S.processParticipantDetails(g,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(g),this.calculateIsSomeoneStreaming(m),this.raiseChangedDeferred()},onParticipantRemoved:(g,m=generateCauseId(),S=!1)=>{if(this.logger.info(`[${m}][onParticipantRemoved]`),S){const S=this.getParticipant(g.id);this.callTelemetry.recordOperationSuccess("_ParticipantJoined",null,S?.id,m,{participantJoinedButReplaced:"Participant joined with original MRI and replaced with participant of RNL MRI"})}else this.callTelemetry.recordOperationSuccess("RemoveParticipant",null,g.id,m),this._participantOperationHandler.maybeRejectOperation("AddParticipant",1,g.id,m);this._removeParticipant(g,m),this.removePublishedStatesByParticipant(g.id),this.calculateIsSomeoneStreaming(m)},onParticipantJoined:(g,m=generateCauseId())=>{this.logger.info(`[${m}][onParticipantJoined]`);const S=!this.getParticipant(g.id),v=this.getOrCreateParticipant(g.id,m,!1);v.displayName=g.displayName,0===v.state&&v.setState(1,void 0,m);const C=_PluginlessCall.filterVirtualEndpoints(g.endpointDetails),_=_PluginlessCall.getStreamsFromEndpoints(C),E=(0,_i.some)(g.endpointDetails,(g=>g?.streamInformation));this.callUsesMixer||_.length>0||E?(this.updateParticipantStreams(v,g,_,m),this.updateCallParticipantFromSignalingParticipant(v,g,m),this.calculateIsSomeoneStreaming(m)):(this.handleRemoteParticipantJoinedInOneToOneCall(g,m),this.handleRemoteParticipantStateInObservingCall(v,g,m),g.acceptedBy&&g.acceptedBy!==g.id&&(v.acceptedBy=g.acceptedBy)),this.callTelemetry.recordOperationSuccess("_ParticipantJoined",getEndpointInformationForTelemetry(g.endpointDetails),v.id,m),v.processParticipantDetails(g,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(g),S&&this.event("participantAdded").raise(v),this.raiseChangedDeferred()},onCallModeChanged:(g,m)=>{this.callTelemetry.recordEvent("_CallModeChanged",{newCallMode:g,oldCallMode:this._callMode},m),this.logger.info(`onCallModeChanged[${m}]: new=${g} old=${this._callMode} `),g&&this._callMode!==g&&(this._callMode=g,this.isCallModeStreaming()&&this.cleanUpDueToStreaming(m),1===this._callMode&&(this.participants.forEach((g=>{g.applyCachedMediaStreams(m)})),this.promotionCompletedDeferred?.resolve()),this.monitorCallStart(),this.updateCapabilities(m),this.raiseChanged())},getRemoteParticipantCollection:()=>this.participants.map((g=>g.toCafeParticipant())),onReTargetCompletedSuccess:g=>{const m=this.logger.createFnLogger("onReTargetCompletedSuccess",g);m.info(`started, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetSuccess",void 0,g),this.callStats.localStats.call.event(3);const S=this.isEscalationInProgress;this.screenSharingControl&&this.screenSharingControl.shutdownControlForViewer(),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.completeEscalationAsync(g).then((()=>(m.logSuccess("completeEscalationAsync"),this.callTelemetry.recordEvent("_WebOnEscalationSuccess",void 0,g),this.handleCallEscalation(S,g),this.updateMediaStatus(g)))).catch((S=>{m.logFailure(`completeEscalationAsync, error=${getPrintableObject(S)}`),this.setIsEscalationInProgress(!1,g),this.callTelemetry.recordEvent("_WebOnEscalationFailure",getPIISafeObject(S),g),this.stopInternal({causeId:g,terminatedReason:47})}))},onReTargetCompletedFailure:(g,m)=>{this.logger.createFnLogger("onReTargetCompletedFailure",m).logFailure(`reason=${getPrintableObject(g)}, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetFailure",getPIISafeObject(g),m),this.isEscalationInProgress&&(this.setIsEscalationInProgress(!1,m),this.setCallUsesMixer(!1,m),this.updateMediaStatus(m)),this.callStats.localStats.call.event(4),this.mediaSession.rejectEscalationAsync(g,m)},onChatModalitySetupFailed:g=>{this.logger.debug(`onChatModalitySetupFailed: ${g}`)},onConversationUpdated:(g,m)=>{this.logger.info(`onConversationUpdated[${m}]: ${safeJsonStringify(g)}`),this.setConversationType(g.conversationType,m),this.setMessageId(g.teamsMessageId,m),this.setGroupId(g.groupId,m),this.setThreadId(g.threadId,m),this.setBackroomThreadId(g.backroomThreadId,m),this.setCallType(g.isMultiParty?2:1,m),this._commandUrlPresence=g.commandUrlPresence,this.updateCapabilities(m),this.region=g.region,this.setMeetingData(g.meetingData),this.meetingInfo=g.meetingInfo,this.callLimits=g.callLimits,this.setComplianceRecordingContent(m,g.complianceRecordingContent),this.setHuddleGroupCall(g.isHuddleGroupCall),this.raiseChanged()},onMeetingDetailsUpdated:g=>{this.meetingDetails=g,this.mediaSession&&!this.enableRealtimeTelemetry&&this.meetingDetails.meetingCapability?.enableRealtimeTelemetry&&(this.mediaSession.enableTeamsRealTimeTelemetry(),this.enableRealtimeTelemetry=!0),this.raiseChanged()},onMeetingStatesUpdated:g=>{(0,_i.isEqual)(g,this.meetingStates)||(this.meetingStates=g,this.logger.info(`[onMeetingStatesUpdated] meetingStates updated to ${JSON.stringify(this.meetingStates)}`),this.raiseChanged())},onParticipantCountsUpdated:g=>{(0,_i.isEqual)(g,this.participantCounts)||(this.participantCounts={...Gt,...g},this.event("participantCountsUpdated").raise(this.participantCounts),this.mediaSession?.processNotification("ParticipantCountChanged",{count:g.totalParticipants}))},updateIsSharedLineAppearanceV2Activated:g=>{this.isSharedLineAppearanceV2Activated!==g&&(this.logger.info(`_updateIsSharedLineAppearanceV2Activated: new value is ${g}`),this.isSharedLineAppearanceV2Activated=g,this.event("sharedLineAppearanceV2ActivatedChanged").raise(this.isSharedLineAppearanceV2Activated))},onBroadcastMeetingUpdated:g=>{g&&(this.broadcastMeeting&&this.broadcastMeeting.metadataChanged(JSON.stringify(g)),this.broadcastMetadata=g,this.raiseChanged())},onBroadcastMeetingConnected:(g,m)=>{this.logger.info(`[${m}][onBroadcastMeetingConnected]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&(0===g.code?this._callOperationHandler.resolveOperation("AddBroadcastModality",g,m):this._callOperationHandler.rejectOperation("AddBroadcastModality",g,m))},onBroadcastMeetingEnded:(g,m)=>{this.logger.info(`[${m}][onBroadcastMeetingEnded]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&this._callOperationHandler.rejectOperation("AddBroadcastModality",g,m),this.signalingSession.endBroadcastMeeting(m)},onTransferRequested:(g,m)=>{const S=this.logger.createFnLogger("onTransferRequested",m);S.info("Transfer: onTransferRequested, target participant",scrubSignalingParticipant(g.target));let v="",C="",_=0;"voicemail"===g.target.endpointType&&(_=2);try{v=g.target.id,C=g.transferor.details.id,g&&g.parkType&&"none"!==g.parkType&&(_=1)}catch(g){return S.logFailure(g),this.callTelemetry.recordEvent("_OnTransferRequestedInvalid"),void this.signalingSession.signalTransferCompletedAsync({code:getCSAEndCode(7)})}const E=this.convertToTransferType(_,g.parkType),T={transferContext:{transferorMri:C,targetMri:v,transferType:_,context:{target:g.target,transferor:g.transferor,transferContext:g.transferContext,newCallModalities:g.newCallModalities,links:g.links,replacementDetails:g.replacementDetails,isConsultative:g.isConsultative,callAcceptanceCallback:()=>{S.logSuccess("Transfer: callAcceptanceCallback called"),this.signalingSession.signalTransferAcceptedAsync(E)}}},onCompleted:g=>{S.logSuccess("Transfer: onCompleted called"),this.signalingSession.signalTransferCompletedAsync({code:getCSAEndCode(g)})}};this.callTelemetry.recordEvent("_OnTransferRequested",{transferType:_}),this.event("transferRequested").raise(T)},onTransferredCallAcceptance:g=>{const m=this.logger.createFnLogger("onTransferredCallAcceptance",g);this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(m.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback())},onTransferAccepted:g=>{this.logger.info("Transfer: onTransferAccepted"),this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&this._setTransferState(2),this._callOperationHandler.hasPendingOperation("BlindTransfer")&&this._callOperationHandler.maybeResolveOperation("_CallTransferInProgress",void 0,void 0,g),this._callOperationHandler.hasPendingOperation("ParkCall")&&this._setParkState(2)},onTransferCompleted:(g,m)=>{const S=this.logger.createFnLogger("onTransferCompleted",m);S.info("Transfer: onTransferCompleted");const v=g.transferCompletion,C=convertReason(v);if(v&&(S.info(`Transfer: Call Transfer Code: ${v.code}`),0===v.code)){if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.resolveOperation("_CallTransferInProgress",void 0,void 0,m),this._setTransferState(3)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const g={code:0,subCode:0,phrase:"TransactionComplete"};this._callOperationHandler.resolveOperation("ConsultativeTransferWithPickupCode",g,void 0,m),this._setTransferState(3)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(g.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation&&(this.serverHoldLocation=g.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),void 0!==g.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("ParkCall",g.unparkContent.pickupCode,void 0,m),S.logSuccess(`pickupCode=${g.unparkContent.pickupCode}`),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",32,m),S.logFailure(`terminatedReason=${C}`),this._setParkState(4)))}else{if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.rejectOperation("_CallTransferInProgress",C,void 0,m),S.logFailure(`terminatedReason=${C}`),this.transferDiagnosticsInfo={callControllerCode:v.code,callControllerSubCode:v.subCode,phrase:v.phrase,resultCategories:v.resultCategories},this._setTransferState(4)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const g={code:v.code,subCode:v.subCode,resultCategories:v.resultCategories};this._callOperationHandler.rejectOperation("ConsultativeTransferWithPickupCode",g,void 0,m)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(this._callOperationHandler.rejectOperation("ParkCall",C,void 0,m),S.logFailure(`terminatedReason=${C}`),this.transferDiagnosticsInfo={callControllerCode:v.code,callControllerSubCode:v.subCode,phrase:v.phrase,resultCategories:v.resultCategories},this._setParkState(4))}},onParkCompleted:(g,m)=>{this.logger.createFnLogger("onParkCompleted",m).info(`transactionEnd ${getPrintableObject(g)}`),this._callOperationHandler.hasPendingOperation("CallParkV2")?0===g.code&&void 0!==g.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("CallParkV2",""+g.unparkContent?.pickupCode,void 0,m),this.callTelemetry.maybeRecordOperationSuccess("CallParkV2"),this.serverHoldLocation=g.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation,this.parkAdditionalContextJson=JSON.stringify(g.unparkContent.CallParkAdditionalContext)):this._callOperationHandler.rejectOperation("CallParkV2",g,m):this._callOperationHandler.hasPendingOperation("ParkCall")&&(0===g.code?(this._callOperationHandler.resolveOperation("ParkCall","",void 0,m),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",g,m),this._setParkState(4)))},onUnparkCompleted:(g,m)=>{this.logger.createFnLogger("onUnparkCompleted",m).info(`transactionEnd ${getPrintableObject(g)}`),this._callOperationHandler.hasPendingOperation("UnparkCall")&&(0===g.code?this._callOperationHandler.resolveOperation("UnparkCall",g,void 0,m):this._callOperationHandler.rejectOperation("UnparkCall",g,m))},onIncomingCallReplacement:(g,m)=>{const S=this.logger.createFnLogger("onIncomingCallReplacement",m);this.callTelemetry.recordEvent("_onIncomingCallReplacement",{},m),g.callNotification.callType="replaces",g.callNotification.consultativeCallId=this.callId,S.info(`consultativeCallId=${this.callId}`),g.body={gp:g,evt:gi.INCOMING_SKYPE_NGC_CALL,nsp:void 0},this.event("replacementRequested").raise(g)},onContentSharingStopped:g=>{this.logger.debug("ScreenSharing: onContentSharingStopped");for(const m of this.contentSharingSessions)m.contentSharingGuid===g.correlationId&&(m.contentSharingStatus=7)},onContentSharingStarted:g=>{this.logger.debug("ScreenSharing: onContentSharingStarted");const m=new zr(this.callTelemetry,this.logger.createChild("ContentSharingSession"),this.signalingSession,g.correlationId||generateGuid(),g.contentIdentifier,g.sessionState,g.subject,g.sessionId);m.contentSharingStatus=2,this.contentSharingSessions.push(m),m.changed((()=>this.removeContentSessionIfEnded(m))),this.event("contentSharingChanged").raise()},onContentSharingUpdated:g=>{this.logger.debug("ScreenSharing: onContentSharingUpdated");const m=(0,_i.find)(this.contentSharingSessions,(m=>m.contentSharingGuid===g.correlationId));m?(g.presenter&&(m.presenterId=g.presenter),g.subject&&m.subject!==g.subject&&(m.subject=g.subject),g.sessionState&&m.contentSharingState!==g.sessionState&&(m.contentSharingState=g.sessionState),3===m.contentSharingStatus&&this.localSignalingParticipant.id!==g.presenter?m.contentSharingStatus=5:5===m.contentSharingStatus&&this.localSignalingParticipant.id===g.presenter&&(m.contentSharingStatus=3)):this.logger.warn("onContentSharingUpdated: session not found")},onWebRtcMediaNotification:(g,m)=>{this.mediaSession?.processNotification(g,m);const S=this.mediaSession&&this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null;S&&S.processNotification(g,m)},onCorrelationIdUpdated:(g,m)=>this.checkForCallIdUpdate(g,m),onUnmuteRequested:g=>{},onCallForwarded:g=>{g&&g.destinationType!==this.forwardingDestinationType&&(this.forwardingDestinationType=g.destinationType,this.raiseChanged())},onPSTNBalanceUpdate:g=>{},isOneToOnePstnCall:()=>this.isOneToOnePSTNCall(),onUpdateMeetingLiveStateCompleted:(g,m,S)=>{this.logger.info(`[onUpdateMeetingLiveStateCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"UpdateMeetingLiveState",S)},onUpdateMeetingStatesCompleted:(g,m,S)=>{this.logger.info(`[onUpdateMeetingStatesCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"UpdateMeetingStates",S)},onUpdateMeetingGroupsCompleted:(g,m,S)=>{this.logger.info(`[onUpdateMeetingGroupsCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"UpdateMeetingGroups",S)},onSetMeetingLayoutCompleted:(g,m,S)=>{this.logger.info(`[onSetMeetingLayoutCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"SetMeetingLayout",S)},onJoinMeetingGroupCompleted:(g,m,S)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"JoinMeetingGroup",S)},onLeaveMeetingGroupCompleted:(g,m,S)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"LeaveMeetingGroup",S)},onBreakoutDetailsUpdated:(g,m)=>{this.logger.info(`[onBreakoutDetailsUpdated] [${m}]`),this.breakoutDetails=g,this.raiseChanged()},onIncomingProxiedMessages:(g,m)=>{this.logger.info(`[onIncomingProxiedMessages] [${m}] payload ${getPrintableObject(g,!0)}`),this.event("incomingProxiedMessages").raise(g)},onUpdateParticipantsPropertiesCompleted:(g,m,S)=>{this.logger.createFnLogger("onUpdateParticipantsPropertiesCompleted",S).info(`promisesToResolve ${scrubMriOrOmit(safeJsonStringify(g))}`);for(const m of Object.keys(g)){g[m].code===Qt.CODE.SUCCESS?this._callOperationHandler.maybeResolveOperation("UpdateParticipantsProperties",g[m],m,S):this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",g[m],m,S)}},onNudgeToJoinRealtime:g=>{this.logger.info("[onNudgeToJoinRealtime]",g),this.callTelemetry.recordEvent("NudgeToJoinRealTime",g),this.canPromoteToRealTime(1)&&this.promoteToRealtime(1,g).then((()=>this.logger.info(`[onNudgeToJoinRealtime][${g}] completed`))).catch((m=>this.logger.info(`[onNudgeToJoinRealtime][${g}] failed to auto promote: ${getPrintableObject(m)}`)))}};const S=Object.create(this.localSignalingParticipant);this.signalingSession=this.signalingAgent.getNewSignalingSession(S,this.signalingNotifications,this.callId,this._callCreationTime),this.signalingSession.participantManager.setStaleCheckForFullRoster(this._staleRosterCheckFixForPluginless),this.accountConfiguration&&this.accountConfiguration.deviceType&&this.signalingSession.setDeviceType(this.accountConfiguration.deviceType),this.setCallId(this.callId||this.signalingSession.correlationId),this.signalingSession.participantManager&&this.signalingSession.participantManager.localParticipant&&(this.setEndpointId(this.signalingSession.participantManager.localParticipant.endpointId),this.setParticipantId(this.signalingSession.participantManager.localParticipant.participantId),this.callStats.setParticipantId(this.participantId))}updateParticipantStreams(g,m,S,v){g.updateStreams(S,v,this.isCallModeStreaming());const C=this.getStreamInformationMap(m);this.logger.info(`[updateParticipantStreams]: streaming mode with new streamInfoMap: ${safeJsonStringify(C)}`);const _={callId:this.callId,participantId:this.participantId,endpointId:this.endpointId};this.meetingData&&(_.meetingId=this.meetingData.meetingCode);const E=this.telemetryLoggers?this.telemetryLoggers.tlePlayer:null;g.useUmsStream(C,this._liveStreamConfigProvider,_,this.threadId,E,v)}cleanUpDueToStreaming(g){this.logger.info(`cleanUpDueToStreaming[${g}]: cleaning streams and media and canceling cc operations`),this.cancelAllCallingOperationsDueToStreaming(g);const m={code:li.Success,subCode:ci.DowngradeToStreamingClient,phrase:fi.DowngradeToStreamingClient};this.participants.forEach((m=>m.updateStreams([],g))),this.cleanUpMedia(g,m).finally((()=>{this.mediaDisposedPromise=null})),this.finishCallHoldResume(m),this.renegotiationAnswerDeferred?.reject(m),this.newOfferRequestDeferred?.reject(m),this._parkState=0,this._transferState=0,this.isServerMuted||(this._muteState=0),this.isSpeakerMuted=!1,this.requestedHoldState=!1,this.isMuteOnHold=!1}cancelAllCallingOperationsDueToStreaming(g){this._callOperationHandler.maybeRejectPendingOperationsWithPredicate(74,g,((g,m)=>(0,_i.some)(m?.preconditionTags,(g=>"NOT_SUPPORTED_IN_STREAMING_MODE"===g))))}onOperationCompleteCommonHandler(g,m,S,v){0===g.code?this._callOperationHandler.maybeResolveOperation(S,g,v,m):this._callOperationHandler.maybeRejectOperation(S,g,v,m)}convertToTransferType(g,m){let S="none";return 1===g&&m&&"none"!==m?"teamPark"===m?S="TransferTypeTeamPark":"sharedLinePark"===m?S="TransferTypeSharedLinePark":"serverHold"===m&&(S="TransferTypeServerHold"):0===g?S="TransferTypeStandard":2===g?S="TransferTypeVoicemail":this.logger.info(`Irrelevant combination of transferTye: ${g} and parkType: ${m}`),S}raiseChangedDeferred(g){(!this.raiseChangedDefer||this.raiseChangedDefer.isSkippable&&!g)&&(_r.instance.runDeferredWithoutDedup((()=>{delete this.raiseChangedDefer,this.raiseChanged(g)}),"Call.raiseChanged"),this.raiseChangedDefer={isSkippable:!!g})}static getStreamsFromEndpoints(g){if(!g)return[];const m=_PluginlessCall.filterVirtualEndpoints(g);return m.forEach((g=>(0,_i.forEach)(g.mediaStreams,(m=>{m.participantId=g.participantId,m.endpointId=g.endpointId})))),(0,_i.flatMap)(m,(g=>g&&g.mediaStreams||[]))}preconditions(g,m){this.logger.info(`check call mode currentMode is ${this.callMode} operationName is ${g}`),(0,_i.some)(m,(g=>"NOT_SUPPORTED_IN_STREAMING_MODE"===g))&&this.isCallModeStreaming(!0)}mapCallSetupIntent(g){switch(g){case 0:return"None";case 1:return"AutoPromotion";case 2:return"PromotionWithAudio";case 3:return"PromotionWithVideo";default:return"Unknown"}}async promoteToRealtime(g,m){this.logger.info(`[${m}][promoteToRealtime] started with intent=${g}`);const S=this.getPromoteToRealtimeCallOptions(g,this.callOptions);this.callTelemetry.updateOperationData("_PromotionToRealtime",{intent:g},m),this.callTelemetry.recordEvent("StartPromotion",{intent:this.mapCallSetupIntent(g)},m);try{this.promotionCompletedDeferred=defer(),await Promise.all([this.joinOrStartCall(S,this.joinGivenConversation,m,void 0),this.promotionCompletedDeferred.promise])}catch(g){throw this.logger.logFailure(`[${m}][promoteToRealtime] failed with reason=${getPrintableObject(g)}`),this.cleanUpDueToStreaming(m),this.signalingSession.cleanUpDueToStreaming(m),g}}async promoteToRealtimeAndUnmute(g){return this.logger.info(`[${g}][promoteToRealtimeAndUnmute]`),this.isPromotingToRealtime()?(this.logger.info(`[${g}][promoteToRealtimeAndUnmute] already promoting to realtime.`),this._callOperationHandler.waitForOperation("_PromotionToRealtime").then((()=>this.muteUnmute(!1,g)))):this.canPromoteToRealTime(2)?(this.unmutePendingPromise=defer(),setTimeout((()=>{this.unmutePendingPromise?.reject("promoteToRealtime unmute timed out")}),1e3*this.signalingSession.signalingAgentConfig.csaTimeoutConfiguration.promotionUnmuteTimeoutSec),Promise.all([this.promoteToRealtime(2,g),this.unmutePendingPromise.promise]).then((()=>{})).finally((()=>this.unmutePendingPromise=null))):Promise.reject("manual promotion with audio is not allowed")}isPromotingToRealtime(){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")}getPromoteToRealtimeCallOptions(g,m){let S,v=1;1===g?S={value:!0,mediaTypes:["audio"]}:3===g?(S={value:!0,mediaTypes:["audio"]},v=4):2===g&&(S={value:!1});const C={...m.callStartOptions,sendMediaModalities:{mediaStates:[getMediaState(0,4),getMediaState(1,v)].filter((g=>null!=g))},preheatFlags:0};return{...m,callStartOptions:C,applyServerMute:S,isPromotingToRealtime:!0,callStartTime:Date.now()}}canPromoteToRealTime(g){const m=this.logger.createChild("[canPromoteToRealTime]");return m.info(`[promoteType:${g}]`),this.isCallModeStreaming()?this.isPromotingToRealtime()?(m.info("already promoting to realtime"),!1):1===g||2===g:(m.info("cant promote since call mode is not streaming"),!1)}isCallModeStreaming(g=!1){if(2===this.callMode){if(!g)return!0;throw this.logger.info("reject check callmode"),{code:499,subCode:3551,phrase:"TransactionNotAllowedForStreamMode"}}return!1}setCallOptions(g){this.receiveOnlyAudioOnCallStart=!!g.callStartOptions?.receiveOnlyAudioOnCallStart,this.callOptions=g,this.logger.info(`callOptions: ${safeJsonStringify(scrubCallOptions(g))}`)}getSelfClientEndpointCapabilities(){return this.callOptions?.callStartOptions?.clientEndpointCapabilities}getLocalSignalingEndpointDetails(){return(0,_i.find)(this.localSignalingParticipant.endpointDetails,(g=>g?.endpointId===this._endpointId))}getStreamInformationMap(g){const m={};return g&&this.accountConfiguration?.clientSupportsUms&&(0,_i.forEach)(g.endpointDetails,(g=>{g?.streamInformation&&g.participantId&&g.participantId!==this._participantId&&(m[g.participantId]=g.streamInformation)})),m}updateSATInfo(g=[]){const m=this.mediaSession?.getSessionConfig().config.slowedDownTalkerInfoAggregationTime;if(!m||m<0)return;const S=Date.now(),v=S-1e3*m;this.activeTalkersHistory=this.activeTalkersHistory.filter((({timestamp:g})=>g>v)).concat({speakers:g.map((g=>g.id)),timestamp:S});const C=Object.entries(this.activeTalkersHistory.reduce(((g,{speakers:m})=>{for(const S of m)g[S]??(g[S]=0),g[S]++;return g}),{})).sort((([,g],[,m])=>m-g)).map((([g])=>g));this.slowedDownActiveTalkerInfo={speakerList:C,timestamp:new Date(S)}}setPlatformCallConstraints(g){this.setCallConstraints(g).catch((g=>{this.logger.error(g)}))}setCallConstraints(g){return this.mediaSession?(this.logger.info(`Applying platform constraints to current call ${JSON.stringify(g)}`),this.mediaSession.setCallConstraints(g,generateCauseId())):(this.logger.info("Saving platform constraints until media session is created"),this.temporaryCallConstraints=g,new Promise(((g,m)=>{this.resolveTemporaryCallConstraints=g,this.rejectTemporaryCallConstraints=m})))}initializeMediaSession(g){if(this.mediaSession)return;const m=this.logger.createFnLogger("initializeMediaSession",g),S=((g,m)=>{const S={};return Object.keys(m).forEach((v=>{S[v]=(...S)=>m[v]&&g()&&m[v](...S)})),S})((()=>!this.isCallModeStreaming()||this.isPromotingToRealtime()),{onSessionErrorOccurred:(g,S=generateCauseId())=>{m.error(`[${S}][onSessionErrorOccurred]: ${safeJsonStringify(g)}`);const v=[this.mediaAgent.constants.MEDIA_ERROR.iceConnectionError,this.mediaAgent.constants.MEDIA_ERROR.internalError];(0,_i.includes)(v,g.type)&&this.event("mediaConnectionFailed").raise(),this.callTelemetry.recordEvent("SessionError",{type:g.type},S)},onNegotiationRequired:(g=generateCauseId())=>{this.executeNegotiation(g,"onNegotiationRequired",!0)},onContributingSourcesChanged:g=>{const S=this.mediaSession?.getSessionConfig().config.contributingSourcesLogInterval,v=S&&Date.now()>=this.lastContibutingSourceReport+S,C=v?new Map(g.map((g=>[g,"<unknown>"]))):new Map,_=[];for(const m of this.participants){const S=g.some((g=>m.hasAudioSource(g))),E=S?1:0;m.updateVoiceLevel(E),S&&(_.push(m),v&&C.set(m.audio.id,scrubMriOrOmit(m.id)))}this.updateSATInfo(_),v&&(m.info(`[onContributingSourcesChanged], ${g.length?Array.from(C).join(";"):"none"}`),this.lastContibutingSourceReport=Date.now())},onDominantSpeakerChanged:(g,S)=>{const v=generateCauseId(),C=[],_=[];g.forEach((g=>{const m=(0,_i.find)(this.participants,(m=>m.hasAudioSource(g)));m?(C.push(m.id),_.push(scrubMriOrOmit(m.id))):_.push(this.streamManager.audio.id===g?"<self>":"<unknown>")})),m.info(`[${v}][onDominantSpeakerChanged], msidList = ${g} => speakerList = ${_}, timestamp = ${S}`),this.dominantSpeakerInfo={speakerList:C,timestamp:S,noCurrentDominantSpeaker:!1},this.event("dominantSpeakerChanged").raise(),this.raiseChanged(this._dominantSpeakerChangedEventSkipConfig)},onAudioStateChanged:(g,m)=>{const S=generateCauseId(),v=this.logger.createFnLogger("onAudioStateChanged",S);v.info(safeJsonStringify(g)),this.callStats.localStats.audio.streamStateChanged(g.stream,g.direction);const C=_PluginlessCall.streamingStatetoMediaStreamState(g.stream);if(this.audioStreamState=C,!C)return;this.callTelemetry.recordEvent("AudioStateChanged",{state:g,reason:m},S),2===C&&2===this.state&&(this.setCallState(9,S),this.participants.forEach((g=>g.setState(6,void 0,S))));const _={mediaType:0,mediaDirection:_PluginlessCall.streamingDirectionToMediaDirectionMapping(g.direction),mediaStreamState:C};this.event("mediaStreamStateChanged").raise(_),!this.isCallSetupTelemetrySent&&this.mediaSession?.getSessionConfig().config.sendCallStartupTelemetry&&this.sendCallSetupTelemetry(),0===_.mediaDirection&&(this.isAudioStreamConnected=(0,_i.includes)([2,1],_.mediaStreamState));if((0,_i.includes)([3,4],_.mediaStreamState)){v.logFailure(`audio stream state changed to ${g.stream} with reason ${m}`);if(!m||["timeout","connection-dropped","connectivity-check-failure"].indexOf(m)>=0){this.event("mediaConnectionFailed").raise();const g=this.mediaRelayWhiteListingIssue?53:4;this.mediaRelayWhiteListingIssue&&this.callTelemetry.recordEvent("_MediaWhiteListingIssueDetected"),this.stopInternal({causeId:S,terminatedReason:g})}}},onQualityChanged:g=>{const m={type:_PluginlessCall.convertQualityEventType(g.type),value:_PluginlessCall.convertQualityLevel(g.value),isLocalSource:g.isLocalSource,mediaType:_PluginlessCall.convertMediaType(g.mediaType)};this.muteUnmuteWorkaround(m),32===m.type&&(this.mediaRelayWhiteListingIssue=3===m.value,this.mediaRelayWhiteListingIssue&&this.event("mediaConnectionWhitelistingWarning").raise()),5===m.type&&3===m.value&&this.trouterService.checkConnection(!0),this.callTelemetry.recordEvent("AudioQualityChanged",m),this.event("callQualityChanged").raise(m)},onOptimalVideoReceiversCountChanged:g=>{m.debug(`onOptimalVideoReceiversCountChanged: ${g}`),this.optimalVideoCount!==g&&(this.optimalVideoCount=g,this.raiseChanged())},onDataChannelUpdated:g=>{const S=generateCauseId();m.debug(`[${S}] onDataChannelUpdated`),this.dataChannel.registerSessionDataChannel(g,S)},onUpdateMediaDescriptionsRequired:g=>{this.executeNegotiation(g,"onUpdateMediaDescriptionsRequired",!1)},onRealtimeTelemetryReport:()=>{this.reportTelemetryEvents([{eventName:"realtimetelemetry",props:{user_object_id:{value:On+this.currentUserSkypeIdentity.id,piiKind:10},call_context_id:{value:this.signalingSession.correlationId,piiKind:0},participant_id:{value:this.participantId,piiKind:0},media_leg_id:{value:this.mediaLegId,piiKind:0},DiagnosticLevel:{value:255,piiKind:0},eventpdclevel:{value:2,piiKind:0},eventpriority:{value:5,piiKind:0},call_technical_info:{value:JSON.stringify(this.mediaSession.getCallTechnicalInfo()),piiKind:0}}}],"realtimeMedia","mdsc")},onTransportConnected:()=>{this.mediaStateConfigurationHelper.isSending(3)&&this.allowDataChannel()?this.mediaControlPlane.onTransportConnected():!this.isInitialSignalingDSHSubscriptionEnabled()&&this.callUsesMixer&&this.updateSignalingDSHMessageSubscription(!0),this.unmixedAudioProvider.setSessionStreamsProvider(this.mediaSession.getUnmixedAudioProvider())}});this.callTelemetry.recordEvent("CreatingConference","",g),this.callDeviceManager||(m.info(`[${g}][initializeMediaSession] Creating new callDeviceManager`),this.callDeviceManager=this.createCallDeviceManager());const v=new qs(this.mediaControlPlane,this.signalingSession,m.createChild("SourceRequestSender"),this.mediaControlPlane.getTelemetryLogger().getSourceRequestSenderDiagnostics),C={maxReinvitelessMediaForVBSSMultiparty:this.signalingSession.getMaxReinvitelessMediaForVBSSForWeb(),maxReinvitelessMediaForVideoMultiparty:this.signalingSession.getMaxReinvitelessMediaForVideoForWeb()};this.callTelemetry.recordEvent("_ReinvitelessConfig",{reinvitelessConfig:C},g),this.mediaSession=new pr(this.mediaAgent.createSession(S,this.signalingSession.correlationId,{isConference:this.callUsesMixer,isPstnCall:this.isOneToOnePSTNCall(),isParkedCall:this.isParkedCall(),reinvitelessConfig:C},this.callDeviceManager),this.signalingSession,v),this.temporaryCallConstraints&&(m.info(`Applying saved call constraints to current call ${JSON.stringify(this.temporaryCallConstraints)}`),this.mediaSession.setCallConstraints(this.temporaryCallConstraints,generateCauseId()).then(this.resolveTemporaryCallConstraints).catch(this.rejectTemporaryCallConstraints).finally((()=>{this.temporaryCallConstraints=void 0,this.rejectTemporaryCallConstraints=void 0,this.resolveTemporaryCallConstraints=void 0}))),this.dataChannel.setConfigProviderView(this.mediaSession.getSessionConfig()),this.callTelemetry.recordEvent("CreatedConference","",g),this.streamManager.setMediaSession(this.mediaSession,g),this.participants.forEach((m=>{m.setMediaSession(this.mediaSession,g)}));const _=this.mediaSession.getSessionConfig()?.config;_?.useOneDsLogger&&_?.addTelemetryReportingCallback&&(this.beforeUnloadTelemetrySender=()=>{this.sendLastKnownStats()},window.addEventListener("beforeunload",this.beforeUnloadTelemetrySender)),this.screenSharingControl&&this.allowDataChannel()&&(this.screenSharingControl.setGiveControlEnabled(this.isGiveControlEnabled()),this.screenSharingControl.setupDataHandlers()),this.unmixedAudioProvider=new $s}executeNegotiation(g,m,S){const v=this.logger.createFnLogger(m,g);if(this.isCallModeStreaming()||this.isEscalationInProgress)return void v.info(`ignored due to being in streaming=${this.isCallModeStreaming()},\n                isEscalationInProgress=${this.isEscalationInProgress}`);const C=generateCauseId();3===this.state||4===this.state||5===this.state||10===this.state||this.isPreheatedOnly()?(v.info(`started, state: ${this.state}, runNegotiation: ${S}`),S?(this.callTelemetry.recordEvent("NegotiationRequired","",g),this._callOperationHandler.executeChained((()=>this.renegotiateOutgoing(g)),"_RenegotiateOutgoing",C,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})):(this.callTelemetry.recordEvent("UpdateMediaDescriptions","",g),this._callOperationHandler.executeChained((()=>this.updateMediaDescriptions(g)),"_UpdateMediaDescriptions",void 0,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}))):v.info(`not started, state: ${this.state}`)}async muteUnmuteWorkaround(g){if(this.mediaSession?.getSessionConfig().config.enableMuteSpeakerUnmuteSpeakerWorkaround&&!this.isSpeakerMuted&&25===g.type&&3===g.value&&0===g.mediaType){this.logger.log("Performing muteSpeaker->unmuteSpeaker workaround");const g=generateCauseId();await this.muteSpeaker(g),await this.unmuteSpeaker(g)}}sendLastKnownStats(){if(!this.tsCallingTelemetryReported){const g=this.mediaSession.getLastKnownStats(!0);this.callStats.setMediaStats(g),this.reportTelemetryEvents(this.callStats.buildShortBeaconEvent(),"media","mdsc"),this.reportTelemetryEvents(this.callStats.buildShortCallModalityStats(),"signaling"),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo);const m="in_call_session";this.reportTelemetryEvents([{eventName:m,props:this.callTelemetry.getEvent(!0)}],"signaling","skypecosi_concore_web_ts_calling")}}invertDirectionality(g){switch(g){case this.mediaAgent.constants.MEDIA_STATE.sendReceive:return Er.sendReceive;case this.mediaAgent.constants.MEDIA_STATE.send:return Er.receive;case this.mediaAgent.constants.MEDIA_STATE.receive:return Er.send;default:return null}}completeNegotiationAsync(g){const m=this.logger.createFnLogger("completeNegotiationAsync",g),S=this.mediaSession.completeNegotiationAsync(g).then((S=>{m.info(`activeModalities=${S&&Object.keys(S.activeModalities)}`);const v=this.participants[0],C=v?.endpoints?.endpointDetails.length&&v.endpoints.endpointDetails[0].mediaStreams?.length,_=this.mediaSession.getSessionConfig().config.avoidFakeStreamsDuringEscalation&&this.isEscalationInProgress;if(v&&!this.callUsesMixer&&!_&&!C){const prepareStreamData=(g,m,S)=>({participantId:Ks,endpointId:zs,type:g,direction:this.invertDirectionality(m),sourceId:S,serverMuted:!1}),m=[];m.push(prepareStreamData(Tr.audio,S.activeModalities.audio,Br)),S.activeModalities.video&&m.push(prepareStreamData(Tr.video,S.activeModalities.video,Hr)),S.activeModalities.sharing&&m.push(prepareStreamData(Tr.sharing,S.activeModalities.sharing,$r)),v.updateStreams(m,g)}return m.logSuccess(safeJsonStringify(S)),S}));return S.catch((S=>{m.logFailure(S),this.callTelemetry.recordEvent("_CompleteNegotiationFailed",{e:S},g)})),S}async renegotiateOutgoing(g){let m;this.renegotiationAnswerDeferred=defer();const S=this.logger.createFnLogger("renegotiateOutgoing",g);if(this._hasDelayedReconnect)return S.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,void await this.mediaSession.reconnectAsync(g,!0);S.info("start");const v=createPhaseExecutor(S);try{try{m=this.inLocalHold()?this.getMediaModalitiesForHold(g):this.calculateModalityDirections({},g);const S=await v.execute("MediaCreateOffer",(()=>this.mediaSession.createOfferAsync(g))),C=this.getSignalingMediaTypes(m);await v.execute("SignalingStartNegotiation",(()=>this.signalingSession.startRenegotiationAsync(S,C,g)));const _=await v.execute("SignalingRenegotiationAnswer",(()=>this.renegotiationAnswerDeferred.promise));await v.execute("MediaProcessAnswer",(()=>this.mediaSession.processAnswerAsync(_,g,!1)));const E=await v.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(g)));this.onNegotiationCompletion(E,!0,m,g,v.getTelemetryData())}catch(v){if(S.logFailure(v),!v.phase)throw this.callTelemetry.recordEvent("OutgoingNegotiationFailure",v,g),v;let C="unknown";const _=this.mediaAgent.constants.RENEGOTIATION_ERROR;if(C=_.local,"SignalingRenegotiationAnswer"===v.phase||"SignalingStartNegotiation"===v.phase){const g=415;C=v.error.code===li.GlareError?_.glare:v.error.code===g?_.media:_.signaling}else"MediaCreateOffer"===v.phase&&v.error.type===this.mediaAgent.constants.MEDIA_ERROR.noNetworkError&&(C=_.media);if(this.callTelemetry.recordEvent("OutgoingNegotiationFailure",this.getTelemetryFromPhaseExecution(v),g),v.error.message?.includes("The requested call does not exist"))throw new Error("Call drop due to remote replying with call not found");S.logFailure(C);const E={type:C,detail:v.error};await this.mediaSession.rejectNegotiationAsync(E,g),this.onNegotiationFailure(v,C,g,m)}}catch(m){S.logFailure(m),this.callTelemetry.recordEvent("NegotiationFatalError",getPIISafeObject(m),g),this.stopInternal({causeId:g,terminatedReason:47})}}async renegotiateIncoming(g,m){this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",null,m,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.mediaAcknowledgmentOperation.catch(noop);const S=this.logger.createFnLogger("renegotiateIncoming",m);if(S.info("start"),g.newOffer&&!this.mediaAgent.getCapabilities().retargeting)return S.logFailure("Retarget offer received, but pluginless has no support for retarget"),void this.stopInternal({causeId:m,terminatedReason:38});const v=createPhaseExecutor(S);try{const S=await v.execute("MediaProcessOffer",(()=>this.mediaSession.processOfferAsync(g,m)));this.handleOfferedModalities(S,m),2===this.getRenegotiationOfferType(S)&&await this.prepareModalitiesForResume(m);const C=await this.updateMediaModalities({offered:S},m);1===this.getRenegotiationOfferType(S)&&await this.prepareModalitiesForHold(m),this.updateMediaState(C,m),this.isRenegotiationHoldOrResume(C)&&this.updateScreenSharingState(C,m);const _=await v.execute("MediaCreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,m))),E=this.getSignalingMediaTypes(C);await v.execute("SignalingAcceptRenegotiation",(()=>this.signalingSession.acceptRenegotiationAsync(_,E,m))),await v.execute("SignalingMediaAcknowledgement",(()=>this.mediaAcknowledgmentOperation));const T=await v.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(m)));this.onNegotiationCompletion(T,!1,S,m,v.getTelemetryData())}catch(g){try{if(!g.phase||"CompleteNegotiation"===g.phase)throw this.callTelemetry.recordEvent("IncomingNegotiationFailure",g,m),g;const v=g;this.callTelemetry.recordEvent("IncomingNegotiationFailure",this.getTelemetryFromPhaseExecution(g),m);const C={type:this.mediaAgent.constants.RENEGOTIATION_ERROR.local,detail:g.error};if("SignalingAcceptRenegotiation"===v.phase||"SignalingMediaAcknowledgement"===v.phase)return S.logFailure("Error in renegotiateIncoming() -> rejecting media negotiation"),C.type=this.mediaAgent.constants.RENEGOTIATION_ERROR.signaling,this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",C,void 0,m),void await this.mediaSession.rejectNegotiationAsync(C,m);this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",C,void 0,m),await this.mediaSession.rejectNegotiationAsync(C,m),await this.signalingSession.rejectRenegotiationAsync(void 0,m)}catch(g){S.logFailure(g),this.callTelemetry.recordEvent("NegotiationFatalError",getPIISafeObject(g),m),this.stopInternal({causeId:m,terminatedReason:47})}}}async updateMediaDescriptions(g){const m=this.logger.createFnLogger("updateMediaDescriptions",g);m.info("start");try{const S=await this.mediaSession.startMediaDescriptionsUpdateAsync(g);m.info(`send updateMediaDesriptions, descriptions=${safeJsonStringify(S)}`),await this.signalingSession.updateMediaDescriptionsAsync(g,S);const v=await this.mediaSession.completeMediaDescriptionsUpdateAsync(g);this.onUpdateMediaDescriptionsCompletion(v,g)}catch(S){m.logFailure(S),this.callTelemetry.recordEvent("UpdateMediaDescriptionsFailure",S,g);const v=await this.mediaSession.rejectMediaDescriptionsUpdateAsync(g,!0);this.onUpdateMediaDescriptionsFailure(S,v,g)}}handleCallEscalation(g,m){const S=this.logger.createFnLogger("handleCallEscalation",m);if(S.info(`current callType=${this.callType}, escalationInProgress=${g}, isEscalationInProgress=${this.isEscalationInProgress}`),g){const g=this.participants[0];g&&g.audio.participantId===Ks?g.updateStreams([{type:Tr.audio,direction:"inactive",sourceId:null,serverMuted:!1},{type:Tr.video,direction:"inactive",sourceId:null,serverMuted:!1},{type:Tr.sharing,direction:"inactive",sourceId:null,serverMuted:!1}],m):S.info("no 1-1 participant found, stream update ignored"),this.setCallType(2,m),this.setCallUsesMixer(!0,m),this.setIsEscalationInProgress(!1,m),this.callTelemetry.recordEvent("_EscalationCompleted",void 0,m),this.raiseChanged()}}async reportTsCallingTelemetry(g){if(this.tsCallingTelemetryReported)return;await this.connectCallPromise.catch(noop);const m=g?"call_setup_session":"in_call_session";this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo),this.reportTelemetryEvents([{eventName:m,props:this.callTelemetry.getEvent(g)}],"signaling","skypecosi_concore_web_ts_calling"),g?this.callTelemetry.switchToInCallTelemetry():this.tsCallingTelemetryReported=!0}async sendMidCallTelemetry(g){this.mediaSession&&g?.length&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(!0)),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildMidCallTelemetry(g),"media","mdsc_mid_call_telemetry"))}sendCallSetupTelemetry(){this.mediaSession&&(this.collectCallStats(this.mediaSession),this.reportCallSetupStats(),this.isCallSetupTelemetrySent=!0)}collectCallStats(g){const always=()=>this.collectMediaStatsDeferred.resolve();return g.getStatsAsync(!1).then((g=>this.callStats.setMediaStats(g))).then(always,always)}reportCallSetupStats(){this.collectMediaStatsDeferred.promise.then((()=>{this.reportTelemetryEvents(this.callStats.buildFromCallSetupStats(),"media","mdsc"),this.event("statsReported").raise(),this.collectMediaStatsDeferred=defer()}))}async reportCallEndStats(g){this.callTelemetry.setTerminationState(this.state),this.callTelemetry.setTerminationReason(this.terminatedReason),this.callStats.localStats.endCall(this.terminatedReason),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.reportTsCallingTelemetry(!this._callIsSetupComplete),g&&(await this.collectMediaStatsDeferred.promise,this.callStats.appendTerminationInfo(this.terminatedReason,this.state),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildFromMediaStats(),"media","mdsc")),this.event("statsReported").raise(),this.collectMediaStatsDeferred=defer()}reportTelemetryEvents(g,m,S){const v=this.telemetryLoggers?this.telemetryLoggers[m]:null;v?g.forEach((g=>v.sendEvent({eventName:`${S?`${S}_`:""}${g.eventName}`,props:g.props}))):this.logger.debug(`reportTelemetryEvents no logger for tenant ${m}`)}onLocalPreviewSizeChanged(g,m){this.logger.debug(`onLocalPreviewSizeChanged: ${g}x${m}`)}onLocalPreviewStateChanged(g){this.logger.debug(`onLocalPreviewStateChanged: ${g}`),this.callStats.localStats.video.streamStateChanged(g.stream)}async configureVideoModalitiesAsync(g,m){if(!this.mediaSession)return this.logger.warn("Tried to configure modalities after call end"),Promise.resolve();await this.updateMediaModalities(void 0,m),g||this.turnOffLocalVideoPreview(m),this.setVideoOn(g,m)}turnOffLocalVideoPreview(g){return this.localVideoRenderer&&(this.localVideoRenderer.dispose(),this.localVideoRenderer=null),Promise.resolve(void 0)}turnOnLocalVideoPreview(g){const m=this.logger.createFnLogger("_StartPreviewVideo",g),S=this.mediaStateConfigurationHelper.isSending(1);if(!S||!this.localVideoContainer)return Promise.reject(`could not start video preview: requestedVideoState=${S}, localVideoContainer=${this.localVideoContainer}`);this.turnOffLocalVideoPreview(g);const v=asap((()=>{this.localVideoRenderer=this.callDeviceManager.getDeviceManager(getAgentMediaType(1)).createPreviewRenderer(this.localVideoContainer),this.localVideoRenderer.on("onVideoSizeChanged",((g,m)=>this.onLocalPreviewSizeChanged(g,m))),this.localVideoRenderer.on("onVideoStateChanged",(g=>this.onLocalPreviewStateChanged(g)))})).then((()=>this.localVideoRenderer.startVideoAsync(g)));return v.catch((g=>m.logFailure(g))),v}startStopVideo(g,m){const S=this.logger.createFnLogger(g?"startVideo":"stopVideo",m);if(S.info("start"),!this.canToggleVideo)return g===this.mediaStateConfigurationHelper.isSending(1)?this.videoTogglePromise.then((()=>{this.turnOnLocalVideoPreview(m)})):(S.logFailure(`video switching is in progress ${g}]`),Promise.reject({reason:1}));g?(this.callStats.localStats.newSession(1),this.callStats.localStats.video.start()):this.callStats.localStats.video.stop(),g&&this.mediaStateConfigurationHelper.isDisabled(1)&&S.info("Video modality was skipped till now. Adding it now."),g?this.mediaStateConfigurationHelper.enableModality(1):this.mediaStateConfigurationHelper.removeModality(1),this.canToggleVideo=!1;const always=()=>{this.canToggleVideo=!0};return this.videoTogglePromise=Promise.resolve().then((()=>!!g&&(this.localVideoContainer||(this.localVideoContainer=document.createElement("div")),this.turnOnLocalVideoPreview(m).then((()=>!0))))).then((g=>this.configureVideoModalitiesAsync(g,m))).catch((g=>(S.logFailure(g),this.mediaStateConfigurationHelper.removeModality(1),this.configureVideoModalitiesAsync(!1,m).then((()=>{throw g}))))).then(always,(g=>{throw S.logFailure(g),always(),g})),this.videoTogglePromise}async startStopAudio(g,m){const S=this.logger.createFnLogger(g?"startAudio":"stopAudio",m);try{const g=await this.updateMediaModalities(void 0,m);this.updateMediaState(g,m)}catch(g){return S.logFailure(g),9}return 0}updateEndpointStateForMute(g,m){try{this.signalingSession.updateEndpointState({state:{isMuted:g}},m).catch((g=>{this.logger.logFailure(`updateEndpointStateForMute failure: ${g}`)}))}catch(g){this.logger.logFailure(`updateEndpointStateForMute failure: ${g}`)}}async handleServerMutedState(g){const m=this.logger.createFnLogger(`handleServerMutedState, isServerMuted=${!!this.isServerMuted}`,g);if(!this.isServerMuted){const S=3===this._muteState;if(1===this._muteState||S)try{m.info("is unmuting, as we are no longer server muted"),await this.handleMuteUnmuteOnMediaSession(!1,g),this.setMuted(0,g),this.unmutePendingPromise?.resolve(),S&&this.updateEndpointStateForMute(!1,g)}catch(g){throw m.logFailure(g),g}}if(this.isServerMuted&&0===this._muteState){m.info("is muting, as we are unmuted");try{await this.handleMuteUnmuteOnMediaSession(!0,g),this.setMuted(1,g)}catch(g){throw m.logFailure(g),g}}}async handleMuteUnmuteOnMediaSession(g,m){const S=this.logger.createFnLogger(`handleMuteUnmuteOnMediaSession, value=${!!g}`,m);if(this.mediaSession&&this.mediaSession.getAllowedModalities&&!this.isServerMuted){const v=this.isMuted||this.isServerMuted,C=this.mediaSession.getAllowedModalities().audio.some((g=>g===Er.send||g===Er.sendReceive));(v&&C||!v&&!C)&&(S.info(`updating audio modalities: Muted ${v} -> ${g}; audioAllowed = ${C}`),await this.updateMediaModalities(void 0,m))}return g?(S.info("mediaSession.muteInputAsync"),await this.mediaSession.muteInputAsync(m)):g||(S.info("mediaSession.unmuteInputAsync"),await this.mediaSession.unmuteInputAsync(m)),Promise.resolve()}updateCapabilities(g,m=!1){let S=!1,v=!1;if(!callStateIsAnyOf(this.state,[11,12])){const g="attendee"===(this.advancedMeetingRole||this.meetingRole);this.isServerMuted&&!this._callInLobby?2&this._commandUrlPresence&&(S=!0):this.isMuted&&(S=!0),v=!!(1&this._commandUrlPresence)&&!g}this._capabilities.canUnmuteSelf===S&&this._capabilities.canMuteOthers===v||(this._capabilities.canUnmuteSelf=S,this._capabilities.canMuteOthers=v,this.logger.info(`[${g}][updateCapabilities] Computed self capabilities: ${JSON.stringify(this._capabilities)}`),m&&this.raiseChanged())}async handleEndpointStatesForAccept(g,m,S){const v=this.logger.createFnLogger(`handleEndpointStatesForAccept, isMuted=${!!g}`,S);try{const C={};await this.handleMuteUnmuteOnMediaSession(g,S),Object.assign(C,{state:{isMuted:g}}),v.info("is updating endpointState for mute"),m&&(Object.assign(C,{endpointProperties:{additionalEndpointProperties:m}}),v.info("is updating endpointState for additionalEndpointProperties")),await this.signalingSession.updateEndpointState(C,S)}catch(g){throw v.logFailure(g),getRejectTransactionEnd(g)}}async muteUnmute(g,m){const S=this.logger.createFnLogger(`muteUnmute, value=${!!g} isServerMuted=${this.isServerMuted} inLobby=${this._callInLobby}`,m);if(callStateIsAnyOf(this.state,[11,12]))return S.logFailure("Can not mute/unmute during preheat call"),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));const v=!g&&(!this.isServerMuted||this._callInLobby);try{if((g||v)&&await this.handleMuteUnmuteOnMediaSession(g,m),g)this.setMuted(2,m),S.info("is updating endpointState for mute"),this.updateEndpointStateForMute(!0,m);else{if(!v)return S.info("is unmuting on server"),2===this._muteState&&this.setMuted(3,m),this.isCallModeStreaming()?this.promoteToRealtimeAndUnmute(m):this.signalingSession.unmuteAsync().then((g=>{this.handleSelfUnmuteUpdatedInfo(g,m)}));S.info("is updating endpointState for unmute"),this.setMuted(0,m),this.updateEndpointStateForMute(!1,m)}}catch(g){throw S.logFailure(g),getRejectTransactionEnd(g)}}async muteUnmuteSpeaker(g,m){this.setSpeakerMuted(g,m),this.mediaSession&&(g?await this.mediaSession.muteOutputAsync(m):await this.mediaSession.unmuteOutputAsync(m))}getParticipant(g){return this.participants.filter((m=>m.isSameParticipantsMri(g)))[0]}getOrCreateParticipant(g,m,S){let v=this.getParticipant(g);return v||(v=new Wr(g,this.mediaSession,this.logger,this.callStats.localStats,this.callTelemetry,m),v.changed((()=>this.onParticipantChanged(v))),this.participants.push(v),S&&this.event("participantAdded").raise(v),this.monitorCallStart(),v)}onParticipantChanged(g){this.event("participantUpdated").raise(g),this.raiseChangedDeferred(this._participantChangedEventSkipConfig)}setCallState(g,m,S=0){if(this.state===g)return;const v=this.logger.createFnLogger("setCallState",m);v.info(`currentState=${this.state}, newState=${g}, terminatedReason=${this.terminatedReason}`);(Vn[this.state].indexOf(g)>=0||(v.logFailure("invalid state transition"),7===g))&&(this.callTelemetry.recordEvent("_SetCallState",{state:g,reason:S},m),this.state=g,this.callStats.localStats.call.callStateChanged(g),7===g&&this.setTerminatedReason(S),3===g&&(this.callGotConnected=!0,this.callHeldAt=null),this.callIsHeld()&&!this.callHeldAt&&(this.callHeldAt=new Date),v.logSuccess(`changed to ${g}, terminatedReason: ${this.terminatedReason}, failureType=${this.failureType}`),this.screenSharingControl.callStateChanged(this.state),this.monitorCallStart(),this.event("callStateChanged").raise(),this.updateCapabilities(m),this.raiseChanged(),this.callTelemetry.recordEvent("_RaiseCallStateChangeEvent",{state:g,reason:S},m))}setTerminatedReason(g){if(this.terminatedReason=g,!(0,_i.includes)(Ws,g)){const g=44===this.terminatedReason,m=55===this.terminatedReason,S=56===this.terminatedReason;this.setFailureType(!this.callGotConnected||!this._wasAudioStreamConnected||g||m||S?0:1)}}setMediaStream(g,m,S){if(g){if(!(0,_i.find)(this.localMediaStreams,(g=>g.mediaType===S))){const g=new Js(m,S);this.logger.info(`setMediaStream ${JSON.stringify(g)}`),this.localMediaStreams.push(g)}}else this.logger.info(`setMediaStream removing ${S}`),(0,_i.remove)(this.localMediaStreams,(g=>g.mediaType===S))}setVideoOn(g,m){this.logger.info(`[${m}]videoOn=${g}`),this.isVideoOn=g,this.setMediaStream(this.isVideoOn,!0,1),this.callTelemetry.recordEvent("_SetLocalVideo",{value:g},m),this.raiseChanged()}setAudioOn(g,m){this.logger.info(`[${m}]audioOn=${g}`),this.setMediaStream(g,!0,0),this.callTelemetry.recordEvent("_SetLocalAudio",{value:g},m)}setScreenSharingOn(g,m){this.logger.info(`[${m}]screenSharingOn=${g}`),this.isScreenSharingOn=g,this.setMediaStream(this.isScreenSharingOn,this.isScreenSharingOn,2),this.callTelemetry.recordEvent("_SetScreenSharing",{screenSharingOn:g},m),this.event("userActivityChanged").raise(),this.raiseChanged()}disposeSharingScreenHandle(){this.sharedScreenHandle&&(this.unsubscribeFromSharedScreenHandleEvents(),this.sharedScreenHandle.dispose(),this.sharedScreenHandle=null)}setMuted(g,m){this._muteState!==g&&(this._muteState=g,this.callTelemetry.recordEvent("_SetMuted",{isMuted:g},m),this.logger.info(`[${m}]participantMuteState:${g}, isMuted: ${this.isMuted}`),this.updateCapabilities(m),this.raiseChanged(),this.event("muteStateChanged").raise(this.isMuted,m))}setSpeakerMuted(g,m){this.logger.info(`[${m}]speakerMute=${g}]`),this.isSpeakerMuted=g,this.raiseChanged()}monitorCallStart(){3!==this.state||!this.participants.length&&2!==this.callMode||this.callStartedAt||(this.callStartedAt=new Date)}_removeParticipant(g,m,S=0){const v=this.logger.createFnLogger("removeParticipant",m);v.info(`mri=${scrubSignalingParticipant(g)}`);const C=(0,_i.remove)(this.participants,(m=>m.isSameParticipantsMri(g.id)))[0];C?(C.setState(4,S,m),this.event("participantRemoved").raise(C)):v.logFailure(`unable to remove participant ${scrubMriOrOmit(g.id)}`),this.raiseChanged(this._participantChangedEventSkipConfig)}setIsSomeoneSharing(g,m){const S=this.isSomeoneSharing!==g&&!(g&&this.screenSharingRenegotiationDeferred&&this.callUsesMixer);S&&(this.isSomeoneSharing=g);let v=S;if(this.callUsesMixer&&this.mediaSession?.getSessionConfig().config.enableStopSharingWithIncomingOffer&&(v||(v=m)),v&&this.isSomeoneSharing&&this.isScreenSharingOn&&(this.stopScreenSharing(),this.logger.info("sharingStolen: Cleaning up local screenshare because remote screenshare is running"),this.event("sharingStolen").raise()),this.allowScreenSharingControl()){const g=this.localSignalingParticipant.endpointDetails.find((g=>this._endpointId===g.endpointId)),m=this.participants.find((g=>g.streams[1].some((g=>g.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,m,g)}}handleOfferedModalities(g,m){const S=this.mediaAgent.constants.MEDIA_STATE,v=this.logger.createFnLogger("handleOfferedModalities",m);try{v.info(`offeredModalities=${safeJsonStringify(g)}`)}catch(g){v.logFailure(g)}g.hasOwnProperty("video")||this.mediaStateConfigurationHelper.isSending(1)?g.hasOwnProperty("video")&&!this.mediaStateConfigurationHelper.isSending(1)&&this.mediaStateConfigurationHelper.removeModality(1):this.mediaStateConfigurationHelper.disableModality(1),g.hasOwnProperty("sharing")||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.disableModality(2),g.sharing!==S.receive||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.removeModality(2),g.data===S.sendReceive&&this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),this.setIsSomeoneSharing(g.sharing===S.receive,!0),this.isSomeoneStreamingVideo=g.video===S.receive||g.video===S.sendReceive}getRenegotiationOfferType(g){if(g)if(5===this.state){if("sendrecv"===g.audio)return 2}else if(this.modalitiesAreHold(g))return 1;return 0}isRenegotiationHoldOrResume(g){return 1===this.getRenegotiationOfferType(g)||2===this.getRenegotiationOfferType(g)}isValidHoldResumeCallState(g){return[3,5,10,13].includes(g)}onNegotiationCompletion(g,m,S={},v,C){const _=this.logger.createFnLogger("onNegotiationCompletion",v);_.info(`byLocal=${m}, result=${safeJsonStringify(g)}`),this.callTelemetry.recordEvent("NegotiationCompletion",{phaseTelemetryBag:C,...this.prepareNegotiationResultForTelemtry(g)},v);const E=this.isOneToOneCall();if(E){const m=this.modalitiesAreHold(g.activeModalities)?5:3;this.participants[0].setState(m,void 0,v),_.info(`isOneToOneCall: participant[0] state set to ${m}`)}const T=this.modalitiesAreHold(g.configuredModalities),I=this.modalitiesAreHold(g.activeModalities);let b;const A=this.signalingSession.participantManager.localParticipant.isStaging;_.info(`isStaging= ${A}`),this.requestedHoldState?(T&&I||_.info(`Not expected modalities when processing local hold: ${T} ${I}`),4!==this.state&&_.info(`Not expected state when processing local hold: ${this.state}, switching back to LocalHold`)):m||this.callHoldResumeDeferred?!T&&I?b=5:T||I||this._callInLobby||this.isPreheatedOnly()||(b=A?13:3):4===this.state||this._callInLobby||this.isPreheatedOnly()||(b=E&&5===this.participants[0].state?5:A?13:3),b&&this.setCallState(b,v),this.callHoldResumeDeferred&&(_.info(`isHoldInProgress=${this.isHoldInProgress}, state=${this.state}, completed=${I}`),this.isHoldInProgress?I&&this.finishCallHoldResume():this.inLocalHold()||this.finishCallHoldResume(this.isValidHoldResumeCallState(b)?void 0:new Error(`Call state changed to ${b} instead of Connected, Lobby, Staging or RemoteHold`))),this.requestedHoldState||(this.setIsSomeoneSharing((0,_i.some)(this.participants,(g=>(0,_i.some)(g.streams[1],(g=>g.isAvailable))))),this.isSomeoneStreamingVideo=(0,_i.some)(this.participants,(g=>(0,_i.some)(g.streams[0],(g=>g.isAvailable)))));const R=S&&S.sharing===this.mediaAgent.constants.MEDIA_STATE.send,P=g?.activeModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(this.resolveScreenSharingRenegotiation(v,R,P,g.isComplete),this.retryOutgoingRenegotiation.retry){const g=this.retryOutgoingRenegotiation.causeId;this._callOperationHandler.executeChained((()=>this.updateMediaModalities(void 0,g)),"_Renegotiate",g,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.retryOutgoingRenegotiation.retry=!1}}onUpdateMediaDescriptionsFailure(g,m,S){const v=m?.requestedModalities.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.screenSharingRenegotiationDeferred&&v&&(this.screenSharingRenegotiationDeferred.reject(g),this.screenSharingRenegotiationDeferred=null)}onUpdateMediaDescriptionsCompletion(g,m){this.logger.createFnLogger("onUpdateMediaDescriptionsCompletion",m).info(`result=${safeJsonStringify(g)}`),this.callTelemetry.recordEvent("UpdateMediaDescriptionsCompletion",g,m);const S=g?.requestedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send,v=g?.appliedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.resolveScreenSharingRenegotiation(m,S,v,!0)}resolveScreenSharingRenegotiation(g,m,S,v){const C=this.logger.createFnLogger("resolveScreenShareRenegotiation",g);if(C.info(`invoked with wasSharingOfferred: ${m}, isSharingActive: ${S}, isComplete: ${v}`),this.screenSharingRenegotiationDeferred)if(m&&S)C.info("resolving screenSharingRenegotiationDeferred"),this.screenSharingRenegotiationDeferred.resolve(),this.screenSharingRenegotiationDeferred=null;else if(this._enableResolveScreenSharingWhenNegotiationComplete&&v&&!this.retryOutgoingRenegotiation.retry&&this.canToggleScreenSharing){const g=new Error(`screenSharing error: wasSharingOfferred: ${m}, isSharingActive: ${S}`);C.info(`reject screenSharingRenegotiationDeferred ${g}`),this.screenSharingRenegotiationDeferred.reject(g),this.screenSharingRenegotiationDeferred=null}}async updateMediaStatus(g){if(this.calculateIsSomeoneStreaming(g),this.mediaSession){const m=await this.updateMediaModalities(void 0,g);this.callTelemetry.updateOperationData("_UpdateLocalMediaStatus",m,g)}}calculateIsSomeoneStreaming(g){let m=!1,S=!1;for(const g of this.participants)if(m||(m=(0,_i.some)(g.streams[1],(g=>g.isAvailable))),S||(S=(0,_i.some)(g.streams[0],(g=>g.isAvailable))),m&&S)break;this._hasDelayedReconnect&&(m||S)&&(this.logger.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,this._callOperationHandler.executeChained((()=>this.mediaSession.reconnectAsync(g,!0)),"_RenegotiateOutgoing",g,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})),this.setIsSomeoneSharing(m),this.isSomeoneStreamingVideo=S}onNegotiationFailure(g,m,S,v){const C=v&&v.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(m===this.mediaAgent.constants.RENEGOTIATION_ERROR.glare)return this.screenSharingRenegotiationDeferred&&C&&this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),void(this.retryOutgoingRenegotiation={retry:!0,causeId:S});const _=new Error(`Error in renegotiateOutgoing() -> rejecting hold for callId = ${this.callId}, reason=${m}`);_.innerError=g,this.finishCallHoldResume(_),this.screenSharingRenegotiationDeferred&&C&&(this.screenSharingRenegotiationDeferred.reject(g),this.screenSharingRenegotiationDeferred=null)}static getParticipantReasonFromTerminatedReason(g){switch(g){case 1:return 0;case 9:return 2;case 10:return 3;case 2:return 4;case 24:return 8;case 3:return 9;case 4:return 10;case 14:return 12;case 0:default:return 11;case 15:return 13;case 16:return 14;case 17:return 15;case 18:return 16;case 19:return 17;case 20:return 18;case 11:return 19;case 21:return 20;case 22:return 21;case 23:return 22;case 33:return 25;case 36:return 26;case 37:return 27;case 41:return 30;case 39:return 28;case 42:return 31;case 40:return 29;case 43:return 32;case 44:return 33;case 45:return 34;case 46:return 35;case 47:return 36;case 48:return 37;case 49:return 38;case 50:return 39;case 51:return 40;case 52:return 41;case 54:return 42;case 55:return 44;case 56:return 45;case 12:return 23;case 59:return 46;case 73:return 59;case 61:return 47;case 60:return 48;case 62:return 49;case 63:return 50;case 64:return 5;case 65:return 51;case 8:return 52}}isRemoteParticipantInStaging(g){if(!g.endpointDetails)return!1;for(const m of g.endpointDetails)if(!hasStagingGroup(m))return!1;return!0}updateCallParticipantFromSignalingParticipant(g,m,S){if((0,_i.every)(m.endpointDetails,(g=>g?.isLobby||g?.streamLobby)))return void g.setState(7,void 0,S);const v=(0,_i.some)(m.endpointDetails,(g=>g?.streamInformation)),C=m.endpointDetails&&(0,_i.some)(m.endpointDetails,(g=>g.mappedTo)),_=_PluginlessCall.filterVirtualEndpoints(m.endpointDetails),E=_&&_[0].mediaStreams,T=this.isRemoteParticipantInStaging(m);if(E&&E.length>0){const m=E.every((g=>"inactive"===g.direction));let v=m?5:T?8:3;1!==this.state||m||this.callUsesMixer||(v=2),this.logger.info(`[updateCallParticipantFromSignalingParticipant]: with mediaStreams is not empty, ParticipantState is set to ${v}`),g.setState(v,void 0,S)}else if(E||C||v){const m=T?8:3;this.logger.info(`[updateCallParticipantFromSignalingParticipant]: ParticipantState is set to ${m}, mediaStreams=${!!E}, hasMappedEndpoints=${C}, hasPlayerStreams=${v}`),g.setState(m,void 0,S)}}handleSelfServerMutedState(g){const m=_PluginlessCall.filterVirtualEndpoints(this.localSignalingParticipant.endpointDetails),S=(0,_i.find)(m,(g=>this._endpointId===g.endpointId)),v=S&&S.mediaStreams,C=v&&v.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type)),_=S&&(S.stream||S.streamLobby);if(_){const m=_.serverMuted??!1;S.serverMuteVersion=0,m!==this.isServerMuted&&(this.isServerMuted=m,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${m}`),this.event("serverMutedChanged").raise(m,g),this.updateCapabilities(g,!0),this.isServerMuted&&this.setMuted(1,g))}else if(C&&C.length>0){const m=C.some((g=>g.serverMuted));m!==this.isServerMuted&&(this.isServerMuted=m,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${m}`),this.event("serverMutedChanged").raise(m,g),this.updateCapabilities(g,!0),this.handleServerMutedState(g))}}checkIfIncomingServerMutedIsUpdated(g){const m=(0,_i.find)(this.localSignalingParticipant.endpointDetails,(g=>g.participantId===this.localSignalingParticipant.participantId));if(void 0===m)return;const S=(0,_i.find)(g.endpointDetails,(g=>g.participantId===this.localSignalingParticipant.participantId));handleServerMutedVersion(this.logger,m,S)}convertWiredPublishedState(g){if(!g)return;const m=getPluginlessStateTypeFromWire(g.stateType);return{content:g.content,stateType:m,typeRank:g.typeRank,stateId:g.stateId}}updatePublishedStateModified(g,m){g!==this.currentUserSkypeIdentity.id||m&&m!==this.participantId?this._publishedStatesModified=2|this._publishedStatesModified:this._publishedStatesModified=1|this._publishedStatesModified}updatePublishedStates(g){try{let m=[];(0,_i.forEach)(g.publishedStates,(g=>{m.push(this.convertWiredPublishedState(g))})),(0,_i.isEqual)(this._participantPublishedStatesMap[g.id],m)||(0!==m.length||void 0!==this._participantPublishedStatesMap[g.id]&&null!==this._participantPublishedStatesMap[g.id])&&(this._participantPublishedStatesMap[g.id]=m,this.updatePublishedStateModified(g.id));const S=[];(0,_i.forEach)(g.endpointDetails,(v=>{S.push(v.participantId),m=[],(0,_i.forEach)(v.publishedStates,(S=>{const C=this.convertWiredPublishedState(S);this._endpointPublishedStatesMap[g.id]||(this._endpointPublishedStatesMap[g.id]={},this._endpointPublishedStatesMap[g.id][v.participantId]=[]),m.push(C)})),this._endpointPublishedStatesMap[g.id]&&!(0,_i.isEqual)(this._endpointPublishedStatesMap[g.id][v.participantId],m)&&(0!==m.length||null!==this._endpointPublishedStatesMap[g.id][v.participantId]&&void 0!==this._endpointPublishedStatesMap[g.id][v.participantId])&&(this._endpointPublishedStatesMap[g.id][v.participantId]=m,this.updatePublishedStateModified(g.id,v.participantId))})),this._endpointPublishedStatesMap[g.id]&&Object.keys(this._endpointPublishedStatesMap[g.id]).forEach((m=>{S.some((g=>g===m))||(delete this._endpointPublishedStatesMap[g.id][m],this.updatePublishedStateModified(g.id,m))}))}catch(g){this.logger.error(`updatePublishedStates ${JSON.stringify(g)}`)}this.logger.info(`updatePublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`updatePublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`)}removePublishedStatesByParticipant(g){this._endpointPublishedStatesMap[g]&&delete this._endpointPublishedStatesMap[g],this._participantPublishedStatesMap[g]&&delete this._participantPublishedStatesMap[g],this.updatePublishedStateModified(g)}findOrCreateTypeState(g){let m=this._publishedStates.typeStates.findIndex((m=>m.type===g));if(-1===m){const S={participantStates:[],type:g};this._publishedStates.typeStates.push(S),m=this._publishedStates.typeStates.length-1}return m}processPublishedStates(){this.logger.info(`processPublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`processPublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`);try{this._publishedStates||(this._publishedStates={typeStates:[]}),this._publishedStates.typeStates=[];for(const g of Object.keys(this._participantPublishedStatesMap)){const m=this._participantPublishedStatesMap[g];(0,_i.forEach)(m,(m=>{const S=this.findOrCreateTypeState(m.stateType),v={id:g,publishedState:{content:m.content,stateId:m.stateId,typeRank:m.typeRank}};this._publishedStates.typeStates[S].participantStates.push(v)}))}for(const g of Object.keys(this._endpointPublishedStatesMap))for(const m of Object.keys(this._endpointPublishedStatesMap[g])){this._endpointPublishedStatesMap[g][m].forEach((S=>{const v=this.findOrCreateTypeState(S.stateType),C={id:m,publishedState:{content:S.content,stateId:S.stateId,typeRank:S.typeRank}},_={id:g,endpoints:[C]},E=this._publishedStates.typeStates[v].participantStates.filter((m=>m.id===g));E&&E.length>0?(E[0].endpoints||(E[0].endpoints=[]),E[0].endpoints.push(C)):this._publishedStates.typeStates[v].participantStates.push(_)}))}this.event("publishedStatesChanged").raise(this._publishedStates),this.raiseChanged()}catch(g){this.logger.error(`processPublishedStates ${g}}`)}}updateLocalParticipant(g,m){const S=this.logger.createFnLogger("updateLocalParticipant",m);this.checkIfIncomingServerMutedIsUpdated(g),this.localSignalingParticipant.endpointDetails=g.endpointDetails,this.localSignalingParticipant.role=g.role,this.setMeetingRole(g.meetingRole),this.setAdvancedMeetingRole(g.advancedMeetingRole),this.setParticipantType(g.participantType),this.setPropertyBag(g.propertyBag),this.setPropertyRosterVersion(g.version),this.setMaskedIdentityDetails(g.isIdentityMasked,g.maskedIdSeqNumber,g.maskedId),this.localSignalingParticipant.tenantId=g.tenantId,this.localSignalingParticipant.isLobby=g.isLobby,this.callTelemetry.setTenantId(g.tenantId),this.callStats.setTenantId(g.tenantId);const v=this.localSignalingParticipant.isLobby;g.endpointDetails&&this.updateLocalParticipantEndpoints(g.endpointDetails),this.updatePublishedStates(g),this.handleSelfServerMutedState(m);const C=this.getLocalSignalingEndpointDetails();this._callInLobby=v||!!C?.streamLobby,this.signalingSession.participantManager.localParticipant.isStaging=g.isStaging;const _=this.signalingSession.participantManager.localParticipant.isStaging;S.info(`callInLobby = ${v}, callSetupComplete = ${this._callIsSetupComplete}, callIsHeld = ${this.callIsHeld()}, isStaging = ${_}`),!this._callIsSetupComplete||this.callIsHeld()||callStateIsAnyOf(this.state,[11,12])||(v?this.setCallState(10,m):_&&callStateIsAnyOf(this.state,[3,13,10,9,2])?this.setCallState(13,m):this.setCallState(3,m));const E=_PluginlessCall.getStreamsFromEndpoints(g.endpointDetails);if(this.callTelemetry.recordEvent("_UpdateLocalParticipantStream",getStreamInformation(E),m),this.streamManager.updateStreams(E,m),this.updateCapabilities(m,!0),this.allowScreenSharingControl()){const m=g.endpointDetails.find((g=>this._endpointId===g.endpointId)),S=this.participants.find((g=>g.streams[1].some((g=>g.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,S,m)}}modalitiesAreHold(g){return!(g.audio&&"inactive"!==g.audio||g.video&&"inactive"!==g.video||g.sharing&&"inactive"!==g.sharing)}toneToString(g){switch(g){case 0:return"0";case 1:return"1";case 2:return"2";case 3:return"3";case 4:return"4";case 5:return"5";case 6:return"6";case 7:return"7";case 8:return"8";case 9:return"9";case 10:return"*";case 11:return"#";default:return null}}static streamingStatetoMediaStreamState(g){switch(g){case"started":return 0;case"active":return 2;case"inactive":return 1;case"stopped":return 3;default:return 4}}static streamingDirectionToMediaDirectionMapping(g){switch(g){case"send":return 1;case"receive":return 0;default:return}}static convertMuteScope(g){switch(g){case 0:return"EveryoneElse";case 1:return"SpecifiedParticipants";default:return}}callIsHeld(){return 4===this.state||5===this.state}inLocalHold(){return this.isHoldInProgress||4===this.state}telemetryDataFromCallStartOptions(g){const m={};return g.muteFlags&&(m.muteMicrophone=!!(1&g.muteFlags),m.muteSpeaker=!!(2&g.muteFlags)),Object.keys(m).length?m:void 0}reconnect(){const g=generateCauseId();return this.mediaSession.reconnectAsync(g)}async provideCallQualityFeedback(g,m,S,v){}async showCQFInfo(g,m){throw new Error("Not implemented")}async isCqfRendered(g){}async provideCallQualityFeedbackEx(g,m,S,v,C,_){}testTriggerMediaRelayWhiteListingIssue(){this.logger.info("Simulating media relay whitelisting issue for test purposes");const g=this.mediaSession.mediaSession.callback,m={type:"NetworkRelaysNotReachable",value:"Bad",isLocalSource:!0,mediaType:"Audio"};g.onQualityChanged(m);const S={direction:"send",stream:"failed",content:"audio"};g.onAudioStateChanged(S)}async getMediaTelemetry(g=!1){return this.mediaSession&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(g)),this.appendInfoToCallStats()),this.callStats.buildMediaTelemetry()}getMediaSessionStats(){return this.mediaSession?.getMediaStatsReport()}getDiagnosticsForE2E(){return this.mediaSession?.getDiagnostics().e2eDiagnostics}appendInfoToCallStats(){this.callStats.appendDataChannelInfo(this.dataChannel.getTelemetry()),this.callStats.appendSharingControlInfo(this.screenSharingControl?.isScreenSharingControlEnabled()),this.callStats.appendMediaControlPaneInfo(JSON.stringify(this.mediaControlPlane.getTelemetryReport()))}getMediaLogs(){return this.mediaAgent.getMediaLogs()}testSetCallState(g){this.logger.info(`Overwriting call state for test purposes: ${this.state} -> ${g} `),this.state=g}testSetCallType(g){this.logger.info(`Overwriting call state for test purposes: ${this.callType} -> ${g} `),this.callType=g}addGroupModality(g,m=generateCauseId()){const S=this.logger.createFnLogger("AddGroupModality",m);if(!g.threadId&&!g.groupId)return Promise.reject(getRejectTransactionEnd("No threadId/groupId was provided."));if(6===this.state||7===this.state)return S.info(`Not adding modality because CallState is ${this.state} groupId=${scrubMriOrOmit(g.groupId)}, threadId = ${getLoggableThreadId(g.threadId)} messageId = ${g.messageId}`),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));let v;if(g.additionalData)try{v=JSON.stringify(g.additionalData)}catch(m){S.logFailure(`additionalData: ${g.additionalData} is not valid Json, error: ${m}`);const v={code:li.BadRequest,subCode:0,phrase:`additionalData is not valid Json, error: ${m}`};return Promise.reject(v)}S.info(`groupId=${scrubMriOrOmit(g.groupId)}, threadId = ${getLoggableThreadId(g.threadId)} messageId = ${g.messageId} additionalData = ${scrubMriOrOmit(v)}`);const C={groupId:g.groupId,threadId:g.threadId,messageId:g.messageId,additionalData:v};return this.signalingSession.addGroupModalityAsync(C,m).catch((g=>(S.logFailure(getPrintableObject(g)),Promise.reject(g))))}addBroadcastModality(g,m){const S=this.logger.createFnLogger("AddBroadcastModality",m);return Promise.resolve().then((()=>{this.signalingSession.addBroadcastModalityAsync(g,m)})).catch((g=>(S.logFailure(getPrintableObject(g)),Promise.reject(getRejectTransactionEnd(g))))).then((()=>this._callOperationHandler.waitForOperation("AddBroadcastModality"))).catch((g=>{throw this.callTelemetry.updateOperationData("AddBroadcastModality",{error:getPIISafeObject(g)},m),S.logFailure(g),g}))}static convertQualityEventType(g){switch(g){case"NetworkSendQuality":return 1;case"NetworkRecvQuality":return 2;case"NetworkDelay":return 3;case"NetworkBandwidthLow":return 4;case"NetworkReconnect":return 5;case"NetworkPacketLoss":return 6;case"NetworkJitter":return 7;case"NetworkRateMatching":return 8;case"DeviceCaptureNotFunctioning":return 9;case"DeviceRenderNotFunctioning":return 10;case"DeviceRenderGlitches":return 11;case"DeviceLowSNR":return 12;case"DeviceLowSpeechLevel":return 13;case"DeviceClipping":return 14;case"DeviceEcho":return 15;case"DeviceNearEndToEchoRatio":return 16;case"DeviceHalfDuplexAec":return 17;case"DeviceMultipleEndpoints":return 18;case"DeviceHowling":return 19;case"DeviceRenderZeroVolume":return 20;case"DeviceRenderMute":return 21;case"NetworkSendCatastrophic":return 22;case"NetworkRecvCatastrophic":return 23;case"CpuInsufficient":return 24;case"DeviceCaptureMute":return 25;case"DeviceCaptureNotMuteButSilent":return 26;case"DeviceSpeakWhileMuted":return 27;case"VideoVbssRendered":return 28;case"NetworkEthernetInterfaceUsed":return 29;case"NetworkWlanInterfaceUsed":return 30;case"NetworkWwanInterfaceUsed":return 31;case"NetworkRelaysNotReachable":return 32;case"VideoCapturerDeviceStartFailed":return 33;case"VideoCapturerDeviceStartTimedOut":return 34;case"VideoCapturerDeviceStartFailureLackSystemRes":return 35;case"VideoCapturerDeviceStartFailureMFResConflict":return 36;case"NoNetwork":return 37;case"NetworkNotWorking":return 38;case"DeviceCaptureNotFunctioningDeviceInUse":return 39;case"DeviceRenderNotFunctioningDeviceInUse":return 40;case"VideoCaptureDeviceFreeze":return 45;case"ZeroCaptureDevicesEnumerated":return 43;case"ZeroRenderDevicesEnumerated":return 44;case"VideoCapturePermissionDenied":return 47;case"ScreenshareRecordingDisabled":return 55;case"AudioCapturePermissionDenied":return 46;case"VideoCaptureFreezeRecovered":return 48;case"DeviceRenderHowling":return 49;case"PresentationAudioLoopbackDeviceState":return 53;case"RemoteNetworkConnectivityIssue":return 52;case"AudioCaptureUltrasoundDetected":return 54;case"MusicModeNotAvailable":return 57;case"CameraLighting":return 61;case"AudioLoopbackDeviceReady":return 63;case"NoRequiredVideoCodecs":return 64;case"SpatialAudioMUCHUnavailable":return 65;default:return}}static convertQualityLevel(g){switch(g){case"Unknown":return 0;case"Good":return 1;case"Poor":return 2;case"Bad":return 3;default:return}}static convertMediaType(g){switch(g){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2;case"Data":return 3;default:return}}getPluginlessPublishLevel(g){switch(g){case"user":return"user";case"endpoint":return"endpoint";default:throw"Invalid level type."}}setIsEmergency(g){this.logger.info(`Set isEmergency:${g}`),this.isEmergency=g,this.callTelemetry.setIsEmergency(g)}static filterVirtualEndpoints(g){return g&&(0,_i.filter)(g,(g=>!g.mappedTo))}mapDataChannelSourceIdToParticipant(g){let m=null;return m=1===this.callType?this.participants[0]:(0,_i.find)(this.participants,(m=>m.hasSourceId(3,g))),m?.id?this.logger.info(`ParticipantId: ${scrubMriOrOmit(m.id)} to SourceId: ${g}`):this.logger.warn(`No Participant found for SourceId: ${g}`),m}getDataChannelSourceId(){const g=(0,_i.find)(this.endpoints.endpointDetails,(g=>null!==g&&g.participantId===this._participantId));if(!g)return this.logger.warn(`No participantLeg found for participantId: ${this._participantId}`),-1;if(!g.mediaStreams)return this.logger.warn(`ParticipantLeg ${this._participantId} does not have valid mediaStreams`),-1;const m=(0,_i.find)(g.mediaStreams,(g=>3===mapMediaTypeStringToMediaType(g.type)));return m?m.sourceId:(this.logger.warn(`participantLeg ${this._participantId} has no data channel`),-1)}initializeMediaControlPlane(){this.mediaControlPlane=new ur(this.dataChannel,this.logger.createChild("MediaControlPlane"),this.mediaAgent.getConfigProvider().config.mediaControlPlaneConfig),this.mediaControlPlane.on("mpSendBandwidthChanged",(g=>{this.mediaSession?.processNotification("BandwithNotification",{bw:g});const m=this.mediaSession?.getExtensionsManager();m?.processNotification("BandwithNotification",{bw:g})})),this.mediaControlPlane.on("mpDshStatusChanged",(g=>{this.updateSignalingDSHMessageSubscription(!g),g&&this.mediaSession?.getDiagnostics()?.dshDiagnostics.setCurrentActiveStrategy("server")})),this.mediaControlPlane.on("onHandshakeTimeout",(()=>{this.isSignalingDSHFallbackEnabled()&&this.updateSignalingDSHMessageSubscription(!0)})),this.mediaControlPlane.on("mpDshChanged",(g=>{const m=this.mediaSession?.getExtensionsManager();m?.processNotification("McpDominantSpeakerInfo",{history:g})}))}initializeLiveStreamConfigProvider(){const g="MDN_MIDDLELANE_TEAMS",m="liveStream",S=this.ecsProvider.getEcsConfig(g,m),v=this.ecsProvider.getEcsConfig("ConfigIDs",g);this._liveStreamConfigProvider=new st(S,null,v,this.logger.createChild("LiveStreamConfigProvider"))}isMediaSending(g){return this.mediaStateConfigurationHelper.isSending(g)}};Ys.instanceCount=0,__decorateClass([callOperation("Initialize",{type:"Sync",convertError:!0,idempotencyLevel:"NoOp"})],Ys.prototype,"init",1),__decorateClass([callOperation("StartVideo",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"startVideo",1),__decorateClass([callOperation("StopVideo",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"stopVideo",1),__decorateClass([callOperation("DumpVideoSourceImages")],Ys.prototype,"dumpVideoSourceImages",1),__decorateClass([__decorateParam(1,causeId)],Ys.prototype,"hold",1),__decorateClass([callOperation("Hold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],Ys.prototype,"holdWithRenegotiate",1),__decorateClass([callOperation("LocalHold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],Ys.prototype,"localHold",1),__decorateClass([callOperation("Unhold",{waitFor:["Hold","LocalHold"],preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"unhold",1),__decorateClass([callOperation("UpdateEndpointMetadata"),__decorateParam(1,causeId)],Ys.prototype,"updateEndpointMetadata",1),__decorateClass([callOperation("SendDtmfTone",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],Ys.prototype,"sendDtmfTone",1),__decorateClass([callOperation("SetAudioUsage")],Ys.prototype,"setAudioUsageMode",1),__decorateClass([callOperation("SetAudioMidcallConfig")],Ys.prototype,"setAudioMidcallConfig",1),__decorateClass([callOperation("SetAudioMidcallConfigJon",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"setAudioMidcallConfigJson",1),__decorateClass([callOperation("SetParticipantSpatialAudioPositions",{waitFor:"_ElectronSlimcoreReady",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"setParticipantSpatialAudioPositions",1),__decorateClass([callOperation("BlindTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"callBlindTransfer",1),__decorateClass([callOperation("SafeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"callSafeTransfer",1),__decorateClass([callOperation("TransferToVoicemail",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"transferCallToVoicemail",1),__decorateClass([callOperation("ConsultativeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"callConsultativeTransfer",1),__decorateClass([callOperation("ConsultativeTransferWithPickupCode",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],Ys.prototype,"consultativeTransferWithPickupCode",1),__decorateClass([callOperation("CallRedirect",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"callRedirect",1),__decorateClass([callOperation("ParkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"park",1),__decorateClass([callOperation("UnparkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"unpark",1),__decorateClass([callOperation("getTechnicalInformationJson",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],Ys.prototype,"getTechnicalInformationJson",1),__decorateClass([callOperation("StartScreenSharing",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(3,causeId)],Ys.prototype,"startScreenSharing",1),__decorateClass([callOperation("StopScreenSharing",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(2,causeId)],Ys.prototype,"stopScreenSharing",1),__decorateClass([callOperation("StartDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"startDataChannel",1),__decorateClass([callOperation("StopDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"stopDataChannel",1),__decorateClass([callOperation("ShareSystemSounds",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"shareSystemSound",1),__decorateClass([callOperation("Mute",{waitFor:"JoinPreheatedCall",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],Ys.prototype,"mute",1),__decorateClass([callOperation("Unmute",{waitFor:["JoinPreheatedCall"]}),__decorateParam(0,causeId)],Ys.prototype,"unmute",1),__decorateClass([callOperation("MuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],Ys.prototype,"muteSpeaker",1),__decorateClass([callOperation("UnmuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],Ys.prototype,"unmuteSpeaker",1),__decorateClass([callOperation("MuteParticipants"),__decorateParam(2,causeId)],Ys.prototype,"muteParticipants",1),__decorateClass([callOperation("StartAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"startAudio",1),__decorateClass([callOperation("StopAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"stopAudio",1),__decorateClass([callOperation("Assimilate"),__decorateParam(3,causeId)],Ys.prototype,"assimilate",1),__decorateClass([__decorateParam(2,causeId)],Ys.prototype,"merge",1),__decorateClass([callOperation("MergeParticipants"),__decorateParam(1,operationId),__decorateParam(3,causeId)],Ys.prototype,"mergeParticipants",1),__decorateClass([callOperation("MergeWithPickupCode"),__decorateParam(0,operationId),__decorateParam(2,causeId)],Ys.prototype,"mergeWithPickupCode",1),__decorateClass([callOperation("SetMaxVideoChannels")],Ys.prototype,"setMaxVideoChannels",1),__decorateClass([callOperation("StopCall"),__decorateParam(1,causeId),__decorateParam(3,reason)],Ys.prototype,"stop",1),__decorateClass([callOperation("PublishState"),__decorateParam(1,operationId)],Ys.prototype,"publishState",1),__decorateClass([callOperation("PublishState"),__decorateParam(1,operationId)],Ys.prototype,"publishStatesForEveryone",1),__decorateClass([callOperation("RemoveState"),__decorateParam(1,operationId)],Ys.prototype,"removeState",1),__decorateClass([callOperation("RemoveState"),__decorateParam(1,operationId)],Ys.prototype,"removeStatesForEveryone",1),__decorateClass([callOperation("UpdateMeetingSettings"),__decorateParam(1,operationId)],Ys.prototype,"updateMeetingSettings",1),__decorateClass([callOperation("UpdateMeetingGroups"),__decorateParam(0,operationId)],Ys.prototype,"updateMeetingGroups",1),__decorateClass([callOperation("UpdateMeetingLiveState"),__decorateParam(0,operationId)],Ys.prototype,"updateMeetingLiveState",1),__decorateClass([callOperation("UpdateMeetingStates"),__decorateParam(1,operationId)],Ys.prototype,"updateMeetingStates",1),__decorateClass([callOperation("UpdateParticipantInterpretationState"),__decorateParam(0,operationId)],Ys.prototype,"updateParticipantInterpretationState",1),__decorateClass([callOperation("UpdateParticipantsProperties")],Ys.prototype,"updateParticipantsProperties",1),__decorateClass([callOperation("JoinMeetingGroup"),__decorateParam(0,operationId)],Ys.prototype,"joinMeetingGroup",1),__decorateClass([callOperation("LeaveMeetingGroup"),__decorateParam(0,operationId)],Ys.prototype,"leaveMeetingGroup",1),__decorateClass([callOperation("SendMessages"),__decorateParam(0,operationId)],Ys.prototype,"sendMessages",1),__decorateClass([callOperation("UpdateMonitorSession"),__decorateParam(1,causeId)],Ys.prototype,"updateMonitorSession",1),__decorateClass([callOperation("UpdateMeetingRole")],Ys.prototype,"updateMeetingRoles",1),__decorateClass([callOperation("CreateContentSharingSession"),__decorateParam(4,causeId)],Ys.prototype,"createContentSharingSession",1),__decorateClass([callOperation("StopCallWithBeacon",{type:"Sync"}),__decorateParam(0,causeId)],Ys.prototype,"stopWithBeacon",1),__decorateClass([callOperation("Acknowledge",{type:"Chained",convertError:!0,idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(2,causeId)],Ys.prototype,"acknowledge",1),__decorateClass([callOperation("Accept",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],Ys.prototype,"accept",1),__decorateClass([callOperation("Reject",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId),__decorateParam(1,reason)],Ys.prototype,"reject",1),__decorateClass([callOperation("JoinCall",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(1,callStartOptions),__decorateParam(2,causeId)],Ys.prototype,"join",1),__decorateClass([callOperation("JoinPreheatedCall",{waitFor:"_CallStartOrJoinInitiated"})],Ys.prototype,"joinPreheatedCall",1),__decorateClass([callOperation("StartCall",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(0,callStartOptions),__decorateParam(1,causeId)],Ys.prototype,"start",1),__decorateClass([callOperation("StartCallToVoiceMail",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(1,causeId)],Ys.prototype,"startCallToVoicemail",1),__decorateClass([callOperation("Subscribe",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(2,causeId)],Ys.prototype,"joinCallWithoutCallModality",1),__decorateClass([callOperation("StartWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],Ys.prototype,"startWithMeetingData",1),__decorateClass([callOperation("JoinWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],Ys.prototype,"joinWithMeetingData",1),__decorateClass([callOperation("SubscribeWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],Ys.prototype,"subscribeWithMeetingData",1),__decorateClass([callOperation("StartCallWithNudge",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(1,callStartOptions),__decorateParam(2,causeId)],Ys.prototype,"startCallWithNudge",1),__decorateClass([callOperation("StartCallAndUnpark",{type:"Chained",idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(2,callStartOptions),__decorateParam(3,causeId)],Ys.prototype,"startAndUnpark",1),__decorateClass([participantOperation("AdmitParticipant"),__decorateParam(0,operationId),__decorateParam(1,causeId)],Ys.prototype,"admitParticipant",1),__decorateClass([callOperation("Admit")],Ys.prototype,"admit",1),__decorateClass([participantOperation("CallMeBack"),__decorateParam(0,operationId),__decorateParam(2,causeId)],Ys.prototype,"callMeBack",1),__decorateClass([__decorateParam(0,operationId),__decorateParam(2,causeId)],Ys.prototype,"addParticipant",1),__decorateClass([participantOperation("AddParticipants"),__decorateParam(0,operationId),__decorateParam(2,causeId)],Ys.prototype,"addParticipants",1),__decorateClass([__decorateParam(0,operationId),__decorateParam(2,causeId)],Ys.prototype,"addParticipantsImpl",1),__decorateClass([participantOperation("NudgeParticipants"),__decorateParam(0,operationId),__decorateParam(3,causeId)],Ys.prototype,"nudgeParticipants",1),__decorateClass([participantOperation("RemoveParticipant"),__decorateParam(0,operationId),__decorateParam(1,causeId)],Ys.prototype,"removeParticipant",1),__decorateClass([callOperation("SearchParticipants"),__decorateParam(1,operationId),__decorateParam(1,causeId)],Ys.prototype,"searchParticipants",1),__decorateClass([callOperation("GetAllParticipants"),__decorateParam(1,operationId),__decorateParam(1,causeId)],Ys.prototype,"getAllParticipants",1),__decorateClass([callOperation("_PromotionToRealtime"),__decorateParam(1,causeId)],Ys.prototype,"promoteToRealtime",1),__decorateClass([__decorateParam(0,causeId)],Ys.prototype,"turnOffLocalVideoPreview",1),__decorateClass([callOperation("_StartPreviewVideo"),__decorateParam(0,causeId)],Ys.prototype,"turnOnLocalVideoPreview",1),__decorateClass([callOperation("_UpdateLocalMediaStatus",{type:"Chained"}),__decorateParam(0,causeId)],Ys.prototype,"updateMediaStatus",1),__decorateClass([__decorateParam(0,causeId)],Ys.prototype,"calculateIsSomeoneStreaming",1),__decorateClass([callOperation("_Reconnect")],Ys.prototype,"reconnect",1),__decorateClass([callOperation("AddGroupModality"),__decorateParam(1,causeId)],Ys.prototype,"addGroupModality",1),__decorateClass([callOperation("AddBroadcastModality")],Ys.prototype,"addBroadcastModality",1);var Qs=Ys;function decode(g){const m=new TextDecoder("utf-8"),S=atob(g),v=Uint8Array.from(S,(g=>g.charCodeAt(0)));return m.decode(v)}var Xs=__toESM(Ce()),Zs=new RegExp("/callAgent/","i"),ea=class{constructor(g,m){this.signalingAgentProvider=g,this.callRegistry=m}handleMessage(g){if(!g.eventId){if(g.url.search(Zs)>-1){const m=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(g);return"number"==typeof m?{isHandled:!0,resultCode:m}:{isHandled:!0,resultCode:m.resultCode,responseBody:m.responseBody,responseHeaders:m.responseHeaders}}return{isHandled:!1}}if(g.eventId in mi){this.callRegistry.logUploadNotification(g);const m=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(g);return"number"==typeof m?{isHandled:!0,resultCode:m}:{isHandled:!0,resultCode:m.resultCode,responseBody:m.responseBody,responseHeaders:m.responseHeaders}}return{isHandled:!1}}},ta=class{constructor(g,m,S){this.callRegistry=g,this.recentInvitations=[],this.logger=m.createChild("IncomingCallMessageHandler"),this.ecsProvider=S,this.useExperimentalDecode=this.ecsProvider?.getEcsConfig("SkypeCalling","useExperimentalDecode")}handleMessage(g){const m=this.handleIncomingCall(g);return m?{isHandled:m,resultCode:200}:{isHandled:m}}handleIncomingCall(g){const m=generateCauseId(),S=this.logger.createFnLogger("handleIncomingCall",m);if(this.isProxiableNotification(g))return this.callRegistry.proxyPushNotification(g),!0;if(!this.isIncomingCallMessage(g))return!1;let v;try{if(g?.body?.gp&&!isStringBase64(g.body.gp))S.info("unencoded payload, skipping decoding."),v=g.body.gp;else{const m=decodeNotificationPayload(g,S,this.useExperimentalDecode);v=JSON.parse(m)}v.body=g.body}catch(g){return S.logFailure(`Error parsing notification payload: ${g}`),!1}const C=this.isCallTransferNotification(g)?this.buildTransferCallPayload(v):this.buildNGCCallPayload(v);if(!C)return!1;if(this.callRegistry.calls.some((g=>g.callId===C.convoCallId&&g.participantId===C.participantId)))return S.logFailure(`Duplicate call filtered because it was in the call registry, callId = ${C.convoCallId}, participantId = ${C.participantId}`),!1;const _=this.isCallReplacementNotification(g);if(S.log(`replacementCall=${_}`),!_&&this.recentInvitations.some((g=>g.convoCallId===C.convoCallId&&g.participantId===C.participantId)))return S.logFailure(`Duplicate call filtered because it was in the recent calls list, callId = ${C.convoCallId}, participantId = ${C.participantId}`),!1;5===this.recentInvitations.length&&this.recentInvitations.shift(),this.recentInvitations.push({convoCallId:C.convoCallId,participantId:C.participantId});let E=this.callRegistry.calls.find((g=>g.callId===C.convoCallId&&8===g.state));return E||(E=C.groupId?this.callRegistry.createCallWithGroupId(C.groupId,C.convoCallId,C.participantId,m):this.callRegistry.createCall(C.conversationId,C.convoCallId,C.participantId,void 0,m)),E.init({threadId:C.conversationId,messageId:C.messageId,mediaPeerType:2}),this.callRegistry.testEndpointMetadata?E.acknowledge(C,this.callRegistry.testEndpointMetadata,m):E.acknowledge(C,void 0,m),!0}isIncomingCallMessage(g){return Object.keys(gi).some((m=>gi[m]===g.eventId))?g.eventId!==gi.INCOMING_TFL_TFW_CALL||this.ecsProvider?.getEcsConfig("SkypeCalling","enableTFWTFLOneToOneCall"):this.isCallTransferNotification(g)}isCallTransferNotification(g){return g.callNotification&&("transfer"===g.callNotification.callType||"replaces"===g.callNotification.callType)}isCallReplacementNotification(g){return g.callNotification&&"replaces"===g.callNotification.callType}isProxiableNotification(g){return Object.keys(pi).some((m=>pi[m]===g.eventId))}buildTransferCallPayload(g){const m={body:g.body,callerId:g.callNotification.from.id,groupId:null,conversationId:null,convoCallId:g.debugContent.callId,isMultiParty:g.conversationInvitation?.isMultiParty,fromMixer:g.callNotification.fromMixer,ngcCall:!0,participantId:g.callNotification.to.participantId,transferorId:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.id,transferorType:g.callNotification.transferor&&g.callNotification.transferor.transferorType,transferorDisplayName:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.displayName,callType:g.callNotification.callType,consultativeCallId:g.callNotification.consultativeCallId,messageId:null,callQueueInfo:g.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0};return this.logger.info("Incoming transfer paylod",m),m}buildNGCCallPayload(g){if(!g.callNotification)return this.logger.error("Missing callNotification in parsed incoming NGC call payload"),null;const m={groupId:g.groupContext?.id,conversationId:g.groupChat?.threadId,messageId:g.groupChat?.messageId,callerId:g.callNotification.from.id,isMultiParty:g.conversationInvitation.isMultiParty,fromMixer:g.callNotification.fromMixer,convoCallId:g.debugContent.callId,participantId:g.debugContent.participantId,ngcCall:!0,body:g.body,transferorId:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.id,transferorType:g.callNotification.transferor&&g.callNotification.transferor.transferorType,transferorDisplayName:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.displayName,callType:g.callNotification.callType,callQueueInfo:g.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0,fromApplicationType:g.callNotification.fromApplicationType};return this.logger.info("Incoming NGC payload",m),m}},ia=class extends Ge{constructor(g,m,S,v,C,_=null,E,T){super(),this.trouterService=g,this.signalingAgentProvider=m,this.mediaAgent=S,this.callingLogger=v,this.telemetryLoggers=C,this.ecsProvider=_,this.skypeIdentity=E,this.oneDsTelemetryLoggers=T,this.calls=[],this.isDisposing=!1,this._disposedPromise=defer(),this.testEndpointMetadata=null,this._disconnectingPromiseDefers=new Map,this.skypeIdentity&&(this.identity=this.skypeIdentity.id),this.callSubscriptionsMap=new Map,this.logger=new Ze(this.callingLogger).createChild(`CallRegistry/${generateCauseId()}`),this.registryTelemetry=new Jt(this.logger,(new Date).getTime()),this._callOperationHandler||(this._callOperationHandler=new oi(this.logger,this.registryTelemetry,{},(g=>{this._publishTelemetry(g)})));const I=this.mediaAgent.getConfig().disconnectOnPageHide;this._windowUninitEvent=I?"pagehide":"beforeunload",this.signalingAgentProvider.getSignalingAgent().setTokenRequiredCallBack(this.onTokenRequired.bind(this)),this._createNewCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","createNewCallInDisconnectedState"),this._invokeDeleteCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","invokeDeleteCallInDisconnectedState"),this._useExperimentalDecode=this.ecsProvider.getEcsConfig("SkypeCalling","useExperimentalDecode")}init(g,m,S=generateCauseId()){return this.logger.createFnLogger("init",S).info("init"),this.login(g)}uninit(){return this.logout()}login(g,m=generateCauseId()){return this.logger.createFnLogger("login",m).info("login"),this.skypeIdentity=g,this.identity=this.skypeIdentity.id,this.initialize(m)}initialize(g=generateCauseId(),m){const S=this.logger.createFnLogger("initialize",g),v=m&&m.applicationType?m.applicationType:"null";S.info(`initialize with applicationType: ${v}`),this.accountConfiguration=m,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(m),this.incomingCallMessageHandler=new ta(this,this.logger,this.ecsProvider),this.trouterService.registerMessageHandler(new ea(this.signalingAgentProvider,this)),this.trouterService.registerMessageHandler(this.incomingCallMessageHandler),S.info("Call registry init, endpointMetadata",this.testEndpointMetadata);try{this.windowUninitListener=()=>{this._disregardWindowUninitEvents||this.stopCallsWithBeacon()},window.addEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(g){S.logFailure(`Not adding beforeunload listener: ${g}`)}return Promise.resolve(void 0)}logout(g=generateCauseId()){const m=this.logger.createFnLogger("logout",g);m.info("logout");try{this.trouterService.clearMessageHandlers(),window.removeEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(g){m.info(`Not removing beforeunload listener: ${g}`)}return Promise.resolve(void 0)}_publishTelemetry(g){if(!this.telemetryLoggers?.signaling)return;this.registryTelemetry.setSkypeId(this.identity);try{const g=this.signalingAgentProvider.getSignalingAgent();this.registryTelemetry.setEndpointId(g.endpointId)}catch(g){this.logger.warn("Could not get end point ID from signaling agent for call registry telemetry.")}this.accountConfiguration&&(this.registryTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.registryTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.registryTelemetry.setPartition(this.accountConfiguration.partition),this.registryTelemetry.setRegion(this.accountConfiguration.region),this.registryTelemetry.setRing(this.accountConfiguration.ring),this.registryTelemetry.setTenantId(this.accountConfiguration.tenantId),this.registryTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.registryTelemetry.setClientType(this.accountConfiguration.clientType));const m=Ht.REGISTRY_WEB;this.telemetryLoggers.signaling.sendEvent({eventName:m,props:this.registryTelemetry.getEvent(null,g)})}async dispose(g=generateCauseId()){const m=this.logger.createFnLogger("dispose",g);if(m.info("dispose"),this.isDisposing)return m.warn("call registry is already in disposing stage!"),this._disposedPromise.promise;this.isDisposing=!0;const always=()=>{this.calls=[],this.event("disposed").raise(),super.dispose(),this._disposedPromise.resolve()},S=this.calls.map((g=>g.stop())),logout=()=>this.logout();return this.clearCallSubscription(),this.signalingAgentProvider.getSignalingAgent().resetAuthTokenManager(),Promise.all(S).then(logout,logout).then(always,always),this._disposedPromise.promise}get disposePromise(){return this._disposedPromise.promise}createCallAsync(g){const m=this.logger.createFnLogger("createCallAsync",g.causeId),S=`callId:${g.callId}, localParticipantId: ${scrubMriOrOmit(g.localParticipantId)},\n            causeId:${g.causeId}, type:${g.type}, `;switch(g.type){case"MeetingData":S.concat(`meetingUrl:${!!g.meetingData?.meetingUrl}, meetingCode:${!!g.meetingData?.meetingCode}`);break;case"GroupId":S.concat(`groupId:${scrubMriOrOmit(g.groupId)}`);break;case"ThreadId":S.concat(`threadId:${getLoggableThreadId(g.threadId)}, messageId:${g.messageId}`);break;default:throw new Error("Invalid type in passing parameter.")}m.info(S);const v=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers,C=this._getCurrentCall(g,m);if(C){if(6===C.state){const g=defer();return this._disconnectingPromiseDefers.set(C.callId,g),g.promise}return Promise.resolve(C)}return Promise.resolve(this._createNewCall(g,v,m))}createCallWithMeetingData(g,m,S,v){const C=this.logger.createFnLogger("createCallWithMeetingData",v);if(C.info(`meetingData:${safeJsonStringify(g)}, callId:${m}, localParticipantId: ${scrubMriOrOmit(S)}`),!g)return C.info("meetingData cannot be null"),null;const _=this._generateCreateCallOptions(v,m,S,null,null,null,g),E=this._getCurrentCall(_,C);if(E)return E;const T=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(_,T,C)}createCall(g,m,S,v,C=generateCauseId()){return this._createCall(g,m,S,v,C)}createCallWithGroupId(g,m,S,v){return this._createCall("",m,S,void 0,v,g)}_createNewCall(g,m,S){let v=null,C=null,_=null,E=null;switch(g.type){case"MeetingData":E=g.meetingData;break;case"GroupId":v=g.groupId;break;case"ThreadId":C=g.threadId,_=g.messageId}const T=new Qs(this.signalingAgentProvider.getSignalingAgent(),this.mediaAgent,new Ze(this.callingLogger),m,this.skypeIdentity,v,C,g.callId,g.localParticipantId,this.ecsProvider,this.trouterService,this.accountConfiguration,_,this.locationInfoContent,this.networkInfoContent,E,this.areaContent);T.on("callStateChanged",(async()=>{if(7===T.state&&this._createNewCallInDisconnectedState){const v=this._disconnectingPromiseDefers.get(T.callId);v&&(this._disconnectingPromiseDefers.delete(T.callId),v.resolve(this._createNewCall(g,m,S))),this._invokeDeleteCallInDisconnectedState&&setTimeout((()=>{this.deleteCall(T)}),0)}})),this.calls.push(T),this.event("callAdded").raise(T),this.raiseChanged(),S.info(`creating new call, ${T.callId}, ${safeJsonStringify(E)}, ${safeJsonStringify(T.meetingData)}`);const I=T.on("replacementRequested",(g=>{this.incomingCallMessageHandler.handleMessage(g)}));return this.addCallSubscriptionToMap(T,I),T}_getCurrentCall(g,m){let S=null;return"MeetingData"===g.type&&(S=this.getCallUsingMeetingData(g.meetingData,g.callId,g.localParticipantId,void 0,void 0,g.causeId),S)?(m.info("Call Registry has an entry for this call's meeting data"),S):(S=this.getCall(g.callId,g.localParticipantId,g.causeId),S?(m.info("Call Registry has an entry for this callId, participantId"),S):"ThreadId"===g.type&&(S=this.getCallUsingThreadIdMessageId(g.threadId,g.callId,g.messageId,g.causeId),S)?(m.info("Call Registry has an entry for this threadId, messageId"),S):"GroupId"===g.type&&(S=this.calls.find((m=>m.groupId===g.groupId)),S)?(m.info("Call Registry has an entry for this groupId"),S):S)}_generateCreateCallOptions(g,m,S,v,C,_,E){let T=null;return T=v?{type:"GroupId",callId:m,localParticipantId:S,causeId:g,groupId:v}:C?{type:"ThreadId",callId:m,localParticipantId:S,causeId:g,threadId:C,messageId:_}:{type:"MeetingData",callId:m,localParticipantId:S,causeId:g,meetingData:E},T}_createCall(g,m,S,v,C=generateCauseId(),_){const E=this.logger.createFnLogger("createCall",C);E.info(`threadId:${getLoggableThreadId(g)}, callId:${m}, localParticipantId: ${scrubMriOrOmit(S)}, messageId:${v}, groupId:${scrubMriOrOmit(_)}`);const T=this._generateCreateCallOptions(C,m,S,_,g,v,null),I=this._getCurrentCall(T,E);if(I)return I;const b=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(T,b,E)}getCall(g,m,S=generateCauseId()){const v=this.logger.createFnLogger(`getCall[callId=${g}][participantId=${scrubMriOrOmit(m)}]`,S);if(!g)return v.logFailure("callId is undefined"),null;const C=this.calls.find((m=>m.callId===g));return C&&v.info("Call Registry already has an entry for this call"),C}async deleteCallAsync(g){return asap((()=>this.deleteCall(g)))}deleteCall(g){const m=this.calls.indexOf(g);return-1!==m&&(this.callSubscriptionsMap.get(g).forEach((g=>{g.dispose()})),this.callSubscriptionsMap.delete(g),this.calls.splice(m,1),this.event("callRemoved").raise(g),this.raiseChanged(),!0)}async setConfiguration(g){this.accountConfiguration=g,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(g)}updateDisplayName(g){return this.skypeIdentity.displayName=g,this.calls.forEach((m=>{m.updateDisplayName(g)})),Promise.resolve()}fireIntent(g,m){return Promise.resolve()}getCallState(g,m){return Promise.reject("Not implemented")}getSetup(){}getEcsConfig(){return Promise.reject()}updateSkypeToken(g){this.logger.debug("CallRegistry.updateSkypeToken() called but not supported in the current set up.")}updateToken(g,m,S,v,C){this.logger.info(`[updateToken], causeId = ${v} tokenType = ${m.tokenType}, factorsJson = ${g}, tokenExpiredTime = ${C}`);try{return this.signalingAgentProvider.getSignalingAgent().updateToken(g,m,S,v,C),Promise.resolve(getSuccessTransactionEnd())}catch(m){return this.logger.info(`Failed to update token with ${g}, error is ${m}`),Promise.reject(getRejectTransactionEnd(`Failed to update token with ${g}, error is ${m}`))}}onTokenRequired(g){const{requestMetadataJson:m,factorsJson:S,tokenType:v,invalidToken:C}=g;this.logger.info(`[onTokenRequired], tokenType ${v}, factorsJson ${S}, requestMetadataJson ${JSON.stringify(m)}`),this.event("tokenRequired").raise(S,v,m,C)}debugInformation(g){const m=g?`CallInformation\n * CallId=${g.callId}`:void 0;return Promise.resolve(m)}setLocationInfo(g,m,S=generateCauseId()){if(this.logger.info(`setLocationInfo, ${S}, infoType:${g}, contentJson ${m?"is set":"is undefined"}`),m)try{JSON.parse(m)}catch(g){return Promise.reject(`invalid contentJson: ${g}`)}return this.locationInfoType=g,1===this.locationInfoType&&(this.locationInfoContent=m,this.logger.info(`locationInfoContent set to ${this.locationInfoContent}`)),2===this.locationInfoType&&(this.networkInfoContent=m,this.logger.info(`networkInfoContent set to ${this.networkInfoContent}`)),3===this.locationInfoType&&(this.areaContent=m,this.logger.info(`areaContent set to ${this.areaContent}`)),this.event("locationInfoSet").raise(g,m),Promise.resolve()}createDownloader(){return null}extendBrbFeedback(g,m){return Promise.reject("Not implemented")}proxyPushNotification(g){this.logger.info(`Proxying push notification with event ID ${g.eventId}`);try{const m={eventId:g.eventId,payload:decodeNotificationPayload(g,this.logger,this._useExperimentalDecode)};this.event("proxiedPushNotification").raise(m)}catch(g){this.logger.error(`Error proxying push notification: ${g}`)}}logUploadNotification(g){this.logger.info(`Log upload notification with event ID ${g.eventId}`);try{const m={eventId:g.eventId,payload:decodeNotificationPayload(g,this.logger,this._useExperimentalDecode)};this.event("logUploadNotification").raise(m)}catch(g){this.logger.error(`Error raising log upload notification: ${g}`)}}sendPush(g,m,S,v){const C={id:g},_=[];return m.forEach((g=>{_.push({id:g})})),this.signalingAgentProvider.getSignalingAgent().sendPushAsync(C,_,S,v)}enableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!1}disableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!0}getCallUsingThreadIdMessageId(g,m,S,v){this.logger.info(`[getCallUsingThreadIdMessageId][${v}] threadID: ${getLoggableThreadId(g)} callId: ${m} messageId: ${S}`);let C=null;return g&&(C=this.calls.find((v=>v.threadId===g&&(m&&v.callId===m||S&&v.messageId===S))),C)?(this.logger.logFailure(`[getCallUsingThreadIdMessageId][${v}]Call Registry already has an entry for threadId: ${getLoggableThreadId(C.threadId)}, callId: ${C.callId}, messageId: ${C.messageId}`),C):C}getCallUsingMeetingData(g,m,S,v,C,_=generateCauseId()){const E=this.logger.createFnLogger("getCallUsingMeetingData",_);if(E.info(`[callId=${m}][participantId=${scrubMriOrOmit(S)}] meetingData: ${safeJsonStringify(g)} threadId: ${getLoggableThreadId(v)} messageId: ${C}`),!m)return E.logFailure("callId is undefined"),null;let T;for(const S of this.calls){if(S.callId===m){T=S;break}if(compareMeetingData(S.meetingData,g,_,this.logger)){T=S;break}}return T}stopCallsWithBeacon(){for(const g of this.calls)g.stopWithBeacon()}addCallSubscriptionToMap(g,m){this.callSubscriptionsMap.set(g,(this.callSubscriptionsMap.get(g)||[]).concat(m))}clearCallSubscription(){this.callSubscriptionsMap.forEach((g=>{g.forEach((g=>{g.dispose()}))})),this.callSubscriptionsMap.clear()}};function decodeNotificationPayload(g,m,S=!1){const v=m.createFnLogger("decodeNotificationPayload");v.info(`useExperimentalDecode:${S}`);const C=S?decode:atob;let _="{}";if(g?.body?.gp)v.info("using notification.body.gp"),_=C(g.body.gp);else if(g?.body?.cp){v.info("using notification.body.cp");const m=atob(g.body.cp);_=Xs.inflate(m,{to:"string"})}return _}__decorateClass([callOperation("Initialize",{enableInstantTelemetry:!0})],ia.prototype,"initialize",1),__decorateClass([callOperation("Logout",{enableInstantTelemetry:!0})],ia.prototype,"logout",1);var na=P,ra=class{constructor(g){this.deviceManager=g}get childDeviceManagers(){return this.deviceManager.getRegisteredDevices()}createPreview(g,m,S,v){return this.executeOnVirtualDeviceManager((v=>S(g,m,v)),v)}getRawDeviceMediaStream(g,m,S){return this.executeOnVirtualDeviceManager((S=>S.getRawDeviceMediaStream(g,m)),S)}setDeviceEffectsAsync(g,m){return this.executeOnVirtualDeviceManager((g=>g.setVideoEffects(m)),g)}setRawMediaStream(g,m,S){this.executeOnVirtualDeviceManager((S=>S.setRawMediaStream(g,m)),S)}unsetRawMediaStream(g,m){this.executeOnVirtualDeviceManager((m=>m.unsetRawMediaStream(g)),m)}getVirtualDevice(g){return this.childDeviceManagers.find((m=>m.id===g))}executeOnVirtualDeviceManager(g,m){return this.getVirtualDevice(m).getDeviceManagers().map((m=>g(m)))}},sa="default_output_device",aa=class _DeviceManagerAdapter extends Ge{constructor(g){super(),this._deviceManager=g,this.virtualDeviceAdapter=new ra(this._deviceManager),g.on("onDevicesChanged",(g=>{const m=this._deviceManager.getDeviceDescriptions(g),S=this._mapDevices(m);this._raiseDevicesChanged(S)})),g.on("onSelectedDevicesChanged",(g=>this._raiseDevicesChanged())),g.on("onPermissionStateChanged",(()=>this.event("onPermissionStateChanged").raise())),g.on("onVideoEffectsEvent",((g,m)=>this.event("videoEffectsEvent").raise(g,m))),g.on("onVideoEffectApplied",(()=>this.event("videoEffectApplied").raise()))}get isAudioOutputSelectionSupported(){return this._deviceManager.isAudioOutputSelectionSupported}getPermissionState(g){return"camera"===g?this.getPermissionStateHelper(this._deviceManager.getPermissionState("camera")):"microphone"===g?this.getPermissionStateHelper(this._deviceManager.getPermissionState("microphone")):"unknown"}askDevicePermission(g){return this._deviceManager.askDevicePermission?this._deviceManager.askDevicePermission(g):Promise.resolve({audio:!0,video:!0})}enumerateDevicesAsync(){return this._deviceManager.enumerateDevicesAsync().then((g=>this._mapDevices(g)))}getPreferredCamera(){throw new Error("Not implemented")}selectDevices(g){if(Object.keys(g).some((g=>this.isVirtualDevice(g))))throw new Error("Virtual Device selection on DM is not supported");const m=(0,na.assign)({},this._deviceManager.getSelectedDevices(),g);this._deviceManager.selectDevices(m)}selectDevicesAsync(g){return asap((()=>this.selectDevices(g)))}getSelectedDevices(){return this._deviceManager.getSelectedDevices()}getSelectedDevicesAsync(){return asap((()=>this.getSelectedDevices()))}getDeviceNameAsync(g){return this._deviceManager.getDeviceNameAsync(g)}getSpeakerDeviceDomIdAsync(g,m){return this._deviceManager.getSpeakerDeviceDomIdAsync(g)}async setDeviceEffectsAsync(g,m){if(!this.isVirtualDevice(g))return this._deviceManager.setVideoEffects(m);Promise.all(this.virtualDeviceAdapter.setDeviceEffectsAsync(g,m))}getDeviceEffectsCapabilityAsync(g,m){return this._deviceManager.effectsManager.getEffectsCapability("Video")}setBackgroundImageAsync(g,m,S){return this._deviceManager.effectsManager.configure("Video",{imagePath:m,headers:S})}getImagePropertyAsync(g){return Promise.reject(new Error("Not implemented"))}getMicrophoneGeometryArrayInfoAsync(g){return Promise.reject(new Error("Not implemented"))}transformImageAsync(g,m,S,v){return Promise.reject(new Error("Not implemented"))}setAudioProcessingFlags(g){return this._deviceManager.setAudioProcessingFlags(g)}sendMessageDeviceVideoEffectsAsync(g,m){return Promise.reject(new Error("Not implemented"))}sendMessageDeviceVideoExtensibilityAsync(g,m){return Promise.reject(new Error("Not implemented"))}setVideoCaptureConfigAsync(g,m){return Promise.reject(new Error("Not implemented"))}captureVideoFrameWithoutEffectsAsync(g,m,S){return Promise.reject(new Error("Not implemented"))}getSpeakerVolume(){return Promise.reject(new Error("Not implemented"))}getSpeakerSystemVolume(){return Promise.reject(new Error("Not implemented"))}setSpeakerVolume(g){return Promise.reject(new Error("Not implemented"))}setSpeakerSystemVolume(g){return Promise.reject(new Error("Not implemented"))}unmuteMicrophone(){return Promise.reject(new Error("Not implemented"))}unmuteSpeaker(){return Promise.reject(new Error("Not implemented"))}getNrgLevelsForDeviceTuner(g){return Promise.reject(new Error("Not implemented"))}setAudioEffectsAsync(g,m){return this._deviceManager.setAudioEffects(m)}getAudioFeatureCapability(g){return this._deviceManager.effectsManager.getEffectsCapability("Audio")}getMicrophoneVolume(){return Promise.reject(new Error("Not implemented"))}setMicrophoneVolume(g){return Promise.reject(new Error("Not implemented"))}setDeviceTelemetryData(g,m,S,v=0){return Promise.reject(new Error("Not implemented"))}getSourceFormats(g){return Promise.reject(new Error("Not implemented"))}enableShellSharing(){return Promise.reject(new Error("Not implemented"))}disableShellSharing(){return Promise.reject(new Error("Not implemeted"))}enableParticipantCameras(){return Promise.reject(new Error("Not implemeted"))}async createPreview(g,m,S){return"camera"===m.kind&&this.isVirtualDevice(m.device)?this.virtualDeviceAdapter.createPreview(g,S,this.getRenderer,m.device)[0]:"camera"===m.kind&&(0,na.isUndefined)(m.device)?this.createPreviewRenderer(g,S):Promise.reject(new Error("Not yet supported"))}async createPreviewRenderer(g,m){return this.getRenderer(g,m,this._deviceManager)}createScreenSharingPreviewRenderer(g,m){return Promise.reject(new Error("Not yet supported"))}getRawDeviceMediaStream(g,m,S){const v=getAgentMediaType(g);return this.isVirtualDevice(S)?this.virtualDeviceAdapter.getRawDeviceMediaStream(v,m,S)[0]:this._deviceManager.getRawDeviceMediaStream(v,m)}setRawMediaStream(g,m,S){const v=getAgentMediaType(m);return this.isVirtualDevice(S)?this.virtualDeviceAdapter.setRawMediaStream(g,v,S):this._deviceManager.setRawMediaStream(g,v)}unsetRawMediaStream(g,m){const S=getAgentMediaType(g);return this.isVirtualDevice(m)?this.virtualDeviceAdapter.unsetRawMediaStream(S,m):this._deviceManager.unsetRawMediaStream(S)}createAudioRenderer(){return this._deviceManager.createAudioRenderer()}startAudioLoopbackDevice(g){return Promise.reject(new Error("Not implemented"))}async dispose(g){return this._deviceManager.dispose(g)}async registerCompositeVideoDevice(g,m,S){return this._deviceManager.registerVirtualDevice(g,m,S)}async unregisterCompositeVideoDevice(g){return this._deviceManager.unregisterVirtualDevice(g)}async createAudioPlayer(){return Promise.reject(new Error("Not implemented"))}_raiseDevicesChanged(g){(g?Promise.resolve(g):this.enumerateDevicesAsync()).then((g=>{this.raiseChanged(),this.event("devicesChanged").raise(g)}))}getPermissionStateHelper(g){switch(g){case"granted":return"granted";case"denied":return"denied";case"prompt":return"prompt";default:return"unknown"}}_mapDevices(g){return g?.map((g=>this._mapDeviceDesc(g)))}_mapDeviceDesc(g){const m=_DeviceManagerAdapter._mapDeviceType(g.kind);if(6===m){return{id:g.id,label:g.label,kind:m,position:0,defaultVideoId:g.id,devicesIds:[]}}if(1===m){return{id:g.id,browserId:g.browserId,label:g.label,kind:m,position:_DeviceManagerAdapter._mapCameraPosition(g.position)}}if(4===m){return{id:null,browserId:null,label:g.label,kind:m,formFactor:g.formFactor,isPcInternalDevice:g.isPcInternalDevice,microphoneId:g.microphoneId,speakerId:g.speakerId}}return{id:g.id,browserId:g.browserId===sa?"default":g.browserId,label:g.label,kind:m,isSystemDefault:!!g.isSystemDefault}}static _mapDeviceType(g){switch(g){case"camera":return 1;case"microphone":return 2;case"speaker":return 3;case"compositeAudio":return 4;case"virtualDevice":return 6;default:throw new Error(`Invalid device type '${g}'`)}}static _mapCameraPosition(g){switch(g){case"front":return 1;case"back":return 2;case"external":return 3;default:return 0}}isVirtualDevice(g){return g&&this._deviceManager.getRegisteredDevices().some((m=>m.id===g))}async getRenderer(g,m,S){const v=new Mr(g,S);try{await v.startVideoAsync(),m&&(v.setScalingMode(m.scalingMode),v.setVideoMirroring(!m.ignoreMirroring))}catch(g){throw v.dispose(),g}return v}},oa=R,la=R,ca=class extends la.AbstractLogAppender{constructor(g){super(new la.StandardLogFormatter(la.SLF_Flags.Component)),this._logger=g}log(g,m,S,v){if(!this._logger)return;const C=g.level<=la.LogLevel.Debug4?this._logger.debug:g.level<=la.LogLevel.Debug2?this._logger.log:g.level<=la.LogLevel.Debug1?this._logger.info:g.level<=la.LogLevel.Warning?this._logger.warn:this._logger.error;C&&C.apply(this._logger,[this.formatter().format(g,m,S,v)])}},da=R,ha=__toESM(be()),ua=["CorrelationId","agent_environment_id","UserInfo_TenantId","participant_id","endpoint_id","mediaLegId","metrics_ConfigIds","ts_calling_version","uiVersion"],ga={video:[...ua,"Extensions_WebRTCStats_ssrc_video_recv_framesDecoded","Extensions_WebRTCStats_ssrc_video_recv_packetsReceived","Extensions_WebRTCStats_ssrc_video_recv_ssrc","Extensions_WebRTCStats_ssrc_video_recv_bytesReceived","Extensions_WebRTCStats_ssrc_video_recv_googFrameRateDecoded","Extensions_Video_SubscriptionEvents","Extensions_Video_recv_ResolutionDurations","Extensions_Video_recv_StreamsMax","Extensions_Video_recv_frameRateAvg","Extensions_Video_recv_DurationSeconds","Extensions_Video_recv_FreezeHistogram","Extensions_Video_recv_FreezeTimestamps","Extensions_WebRTCStats_ssrc_video_recv_keyFramesDecoded","Extensions_Video_recv_TotalFreezeDurationMs","Extensions_Video_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"],sharing:[...ua,"Extensions_WebRTCStats_ssrc_sharing_recv_framesDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_packetsReceived","Extensions_WebRTCStats_ssrc_sharing_recv_ssrc","Extensions_WebRTCStats_ssrc_sharing_recv_bytesReceived","Extensions_WebRTCStats_ssrc_sharing_recv_googFrameRateDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_keyFramesDecoded","Extensions_Sharing_SubscriptionEvents","Extensions_Sharing_recv_ResolutionDurations","Extensions_Sharing_recv_StreamsMax","Extensions_Sharing_recv_frameRateAvg","Extensions_Sharing_recv_DurationSeconds","Extensions_Sharing_recv_FreezeHistogram","Extensions_Sharing_recv_FreezeTimestamps","Extensions_Sharing_recv_TotalFreezeDurationMs","Extensions_Sharing_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"]},pa=class extends Ge{constructor(){super(...arguments),this.stabilizationTimeInAvg=2e4}send(g){g&&setTimeout((()=>{this.event("sendMidCallTelemetry").raise(ga[g])}),this.stabilizationTimeInAvg)}},ma=class extends Ge{constructor(g,m){super(),this._telemetryService=g,this._ecsProvider=m,this._ecsProvider.on("OnECSChanged",(()=>da.RootToolsManager.OnEcsChange()))}fetchEcsConfig(g,m){return ha.Resolved().then((()=>this._ecsProvider.getEcsConfig(g,m)))}sendTelemetry(g,m){this._telemetryService.getGenericTelemetryLogger&&g?this._telemetryService.getGenericTelemetryLogger(g).sendEvent({eventName:"rt_log",props:m}):this._telemetryService.sendEvents([{eventName:"rt_log",props:m}])}sendMidCallTelemetry(g){Object.keys(ga).includes(g)&&this.event("onMidCallTelemetry").raise(g)}};function initLogger(g,m,S){if(!oa.RootToolsManager.isDelegateSet()){const v=new ma(g.telemetryService,m);if(oa.RootToolsManager.setDelegate(v),v.on("onMidCallTelemetry",(g=>S.send(g))),g.logger){const m=new ca(g.logger);oa.LogFactory.instance().addAppender(m)}}g.logger=new Le("JS.TsCalling.Pluginless",!0),g.mediaAgentFactoryConfig.logger=new Le("JS.TsCalling.MediaAgentUnsafe",!1),g.mediaAgentFactoryConfig.safeLogger=new Le("JS.TsCalling.MediaAgent",!0),g.signalingAgentConfig.logger=new Le("JS.TsCalling.SignalingAgent",!0)}var fa=P,Sa=class _NoopLogger{constructor(g){this._prefix=g,this._children=[],this._useConsoleLogger=!1,this.createChild=(g,m)=>{const S="function"==typeof g?"":g,v=new _NoopLogger((this._prefix||"")+S);return this._children.push(v),this._useConsoleLogger&&v.useConsoleLogger(),v},this.createFnLogger=(g,m,...S)=>{const v=`[${m}][${g}]`,C=new _NoopLogger((this._prefix||"")+v);return this._children.push(C),this._useConsoleLogger&&C.useConsoleLogger(),C}}logInfo(){}logFailure(){}logSuccess(){}log(...g){}debug(...g){}info(...g){}warn(...g){}error(...g){}useConsoleLogger(){this._useConsoleLogger=!0;const logWithConsole=(...g)=>{console.info(this._prefix||"",...g)};this.log=logWithConsole,this.debug=logWithConsole,this.info=logWithConsole,this.warn=logWithConsole,this.error=logWithConsole,(0,fa.each)(this._children,(g=>g.useConsoleLogger()))}},va=class{constructor(g){this.configProvider=g,this.window=Us.window,this.updateCapabilityOverrides(),this.configProviderSub=g.on("configUpdated",(()=>this.updateCapabilityOverrides()))}get audio(){return this.getCapability("audio")}get video(){return this.getCapability("video")}get screensharing(){return this.getCapability("screensharing")}get retargeting(){return this.getCapability("retargeting")}dispose(){this.configProviderSub&&this.configProviderSub.dispose()}updateCapabilityOverrides(){let g;this.configProvider.config.capabilities&&(g=this.configProvider.config.capabilities),this.overrides=g||{}}hasMediaCapture(){return!!this.window.navigator.getUserMedia}getCapability(g){return void 0!==this.overrides[g]?!!this.overrides[g]:this.hasMediaCapture()&&this.hasWebRtc()}hasWebRtc(){return void 0!==this.window.RTCPeerConnection}},Ca=class _UFDManager extends je{constructor(g,m){super(g),this.logger=g,this.configProvider=m,this.eventStates=new Map,this.swMuted=!1,this.logger.safe.info("Initialized")}signalEvent(g,m,S="Audio",v=!0,C=generateCauseId(),_,E){const T={type:g,value:m,isLocalSource:v,mediaType:S,deviceManagerId:_,diagnosticData:E},I=this.getEventKey(T),b=this.eventStates.get(I);(!b||b.value!==m||this.configProvider.config.alwaysRaiseBadDeviceEvents&&"Good"!==m)&&(b||"Good"!==m)&&(this.eventStates.set(I,T),this.shouldRaiseEvent(T,b)&&(this.logger.safe.info(`[${C}] Raising UFD ${g} for ${S}: ${m}`),this.event("onQualityChanged").raise(T)))}signalDeviceEvent(g,m,S,v){const C=_UFDManager.getQualityEventType(g,S,this.configProvider);C?this.signalEvent(C,m,S,void 0,generateCauseId(),v):this.logger.warn(`Unknown device quality event type: ${g}`)}raisePendingWhitelistingUFD(){this.lastWhitelistingUFD&&(this.logger.safe.debug(`Raising whitelisting UFD ${this.lastWhitelistingUFD.type}: ${this.lastWhitelistingUFD.value}`),this.event("onQualityChanged").raise(this.lastWhitelistingUFD),this.cancelPendingWhitelistingUFD())}cancelPendingWhitelistingUFD(){if(this.lastWhitelistingUFD){const g=this.getEventKey(this.lastWhitelistingUFD);this.eventStates.delete(g)}this.lastWhitelistingUFD=void 0}setSwMute(g){if(this.swMuted=g,g){const g=this.eventStates.get(this.getEventKey({type:"DeviceSpeakWhileMuted",mediaType:"Audio"}));g&&"Good"!==g.value&&this.event("onQualityChanged").raise(g)}}applyCurrentState(g){this.cancelPendingWhitelistingUFD();let m=0;for(const S of this.eventStates.values())"Good"!==S.value&&(g(S),m++);m>0&&this.logger.safe.info(`Applied ${m} UFDs`)}reset(){this.logger.safe.info("Resetting UFD states");for(const[g,m]of this.eventStates.entries())_UFDManager.persistent.has(m.type)||this.eventStates.delete(g);this.lastWhitelistingUFD=void 0,this.swMuted=!1}getEventKey(g){return`${g.type}:${g.mediaType}`}shouldRaiseEvent(g,m){return"NetworkRelaysNotReachable"===g.type?(this.lastWhitelistingUFD=g,!1):!!("DeviceSpeakWhileMuted"!==g.type||this.swMuted||"Good"===g.value&&"Good"!==m?.value)&&(!("NetworkRecvQuality"===g.type&&!this.configProvider.config.webrtcStatNetworkDetectionEnabled)&&!(this.configProvider.config.alwaysRaiseBadDeviceEvents&&!_UFDManager.deviceQualityEvents.has(g.type)&&g.value===m?.value))}static getQualityEventType(g,m,S){switch(g){case 0:return"Audio"===m?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartFailed";case 1:return"Audio"===m?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartTimedOut";case 2:return"DeviceCaptureMute";case 3:switch(m){case"ScreenShare":return"ScreenshareRecordingDisabled";case"Audio":return S.config.enableSignalingAudioPermissionDeniedUFD?"AudioCapturePermissionDenied":"DeviceCaptureNotMuteButSilent";case"Video":return"VideoCapturePermissionDenied";default:return}default:return}}};Ca.persistent=new Set(["ZeroCaptureDevicesEnumerated","ZeroRenderDevicesEnumerated"]),Ca.deviceQualityEvents=new Set(["DeviceCaptureNotFunctioning","VideoCapturerDeviceStartFailed","DeviceCaptureNotFunctioning","VideoCapturerDeviceStartTimedOut","DeviceCaptureMute","ScreenshareRecordingDisabled","DeviceCaptureNotMuteButSilent","VideoCapturePermissionDenied"]);var _a=Ca,ya=P,Ea=P,Ta=P,Ia={maxOutgoingResolution:({settings:g})=>getMaxOutgoingResolution(g),maxParticipantResolutions:({settings:g})=>getMaxParticipantResolutions2(g),maxIncomingStreams:({settings:g})=>getMaxIncomingStreams2(g),maxSimulcastLayers:({settings:g})=>getMaxSimulcastLayers2(g),outgoingVideoLimit:({settings:g,constraints:m})=>getOutgoingVideoLimit2(g,m)},convertSettingsToCallConstraints=(g,m,S)=>(g.info(`Converting settings to constraints and mapping, [requestedConstraints=${JSON.stringify(S)}], [settings=${JSON.stringify(m)}]`),convertConstraints((0,Ta.cloneDeep)(S),(0,Ta.cloneDeep)(m))),convertConstraints=(g,m)=>Object.keys(g).reduce(((S,v)=>{const C=Ia[v]?Ia[v]({constraints:g,settings:m}):void 0;return C&&(S[v]=C),S}),{}),getMaxParticipantResolutions2=g=>g.multiviewResolutionLimits,getMaxOutgoingResolution=g=>g.outgoingVideoLimit?.maxResolution,getOutgoingVideoLimit2=(g,m)=>{const S=m?.outgoingVideoLimit;if(!S)return;const{outgoingVideoLimit:v={}}=deepClone(g);if("number"==typeof S)return v?.maxResolution;const C=Object.keys(S).reduce(((g,m)=>{const S=v?.[m];return S&&(g[m]=S),g}),{});return Object.keys(C).length?C:void 0},getMaxIncomingStreams2=g=>g.numVideoChannelsGvc,getMaxSimulcastLayers2=g=>{const m=g.specCompliantSimulcast,S=m.video?.layerScaleFactors,v=m.sharing?.layerScaleFactors,C=S?.length?Math.max(...S):1,_=v?.length?Math.max(...S):1;return Math.min(C,_)},ba=P,isVideoLimit=g=>{const m=["maxResolution","maxBitrate","maxFramerate"],isValidVideoLimitKey=g=>m.includes(g),S=Object.entries(g);return 0!==S.length&&S.every((([g,m])=>(0,ba.isNumber)(m)&&isValidVideoLimitKey(g)))},isVideoLimitOrResolution=g=>!!(0,ba.isNumber)(g)||!!isVideoLimit(g)&&!isEmpty(g),Aa={maxIncomingStreams:ba.isNumber,maxSimulcastLayers:ba.isNumber,maxOutgoingResolution:ba.isNumber,maxParticipantResolutions:g=>!!isDefined(g)&&(!!(0,ba.isNumber)(g)||"more"in g&&Object.values(g).every((g=>(0,ba.isNumber)(g)))),outgoingVideoLimit:g=>!!isDefined(g)&&isVideoLimitOrResolution(g),incomingVideoLimit:g=>!!isDefined(g)&&(!!isVideoLimitOrResolution(g)||"more"in g&&Object.values(g).every((g=>isVideoLimitOrResolution(g))))},removeInvalidConstraints=g=>(g=JSON.parse(JSON.stringify(g)),Object.entries(Aa).reduce(((m,[S,v])=>(v(g[S])&&(m[S]=g[S]),m)),{})),deepMergeConstraints=(g,m)=>{for(const S in m){const v=g[S],C=m[S];g[S]="object"==typeof C?deepMergeConstraints({...v},C):getMinDefined(v,C)}return g},Ra=class{constructor(g,m,S,v,C,_,E){this.logger=g,this.defaultSettings=m,this._mediaConfig=S,this._userAgentConfig=v,this._countryCode=C,this.platformCallConstraintsProvider=_,this.currentCallConstraints=E,this.mergedConstraints={},this.callConstraintsTelemetry=[],this.iceTransportPolicy=Ke.ICE_TRANSPORT_POLICY.all,this.validIceTransportPolicies=[Ke.ICE_TRANSPORT_POLICY.all,Ke.ICE_TRANSPORT_POLICY.relay],this.mergeConstraintsTelemetryWithGlobal(),this.mergedConstraints=this.mergeConstraintsWithGlobal(this.currentCallConstraints),this.settings=this.mergeSettings((0,Ea.cloneDeep)(this.defaultSettings))}get config(){return this.settings}get mediaConfig(){return this._mediaConfig}get userAgentConfig(){return this._userAgentConfig}get countryCode(){return this._countryCode}addCallConstraintsTelemetryEvent(g,m){const S={timestamp:(new Date).getTime(),type:m,value:g};arrayLimitedPush(this.callConstraintsTelemetry,S,this.config.numCallConstraintsEvents)}getCallConstraintsTelemetry(){return this.callConstraintsTelemetry}getCallConstraints(){return this.mergedConstraints}setCallConstraints(g={}){this.addCallConstraintsTelemetryEvent(g,"requested"),this.logger.safe.debug("Saving new call constraints",JSON.stringify(g));const m=this.transformConstraints(removeInvalidConstraints(g));return this.logger.safe.debug("Validated call constraints",JSON.stringify(m)),this.mergedConstraints=this.mergeConstraintsWithGlobal(m),this.settings=this.mergeSettings((0,Ea.cloneDeep)(this.defaultSettings)),convertSettingsToCallConstraints(this.logger,this.settings,m)}getIceTransportPolicy(){return this.settings.iceTransportPolicyForced||this.iceTransportPolicy}setIceTransportPolicy(g){this.validIceTransportPolicies.includes(g)?(this.logger.info(`Setting transport policy to ${this.iceTransportPolicy}`),this.iceTransportPolicy=g):this.logger.debug(`Unknown incoming transport policy, using ${this.iceTransportPolicy}`)}transformConstraints(g){const m=(0,Ea.cloneDeep)(g);return"maxOutgoingResolution"in m&&(m.outgoingVideoLimit={maxResolution:m.maxOutgoingResolution},delete m.maxOutgoingResolution),"number"==typeof m.outgoingVideoLimit&&(m.outgoingVideoLimit={maxResolution:m.outgoingVideoLimit}),m}mergeConstraintsTelemetryWithGlobal(){this.platformCallConstraintsProvider.callConstraintsTelemetry.forEach((g=>arrayLimitedPush(this.callConstraintsTelemetry,g,this.defaultSettings.numCallConstraintsEvents)))}mergeConstraintsWithGlobal(g={}){const m=this.transformConstraints(this.platformCallConstraintsProvider.constraints);if(!Object.keys(m).length)return g;const S=(0,Ea.cloneDeep)(g);return deepMergeConstraints(S,m),this.logger.safe.debug(`Merging call constraints ${JSON.stringify(g)} and global constraints ${JSON.stringify(m)}. Result: ${JSON.stringify(S)}`),S}mergeSettings(g){if(!g.enablePlatformCallConstraints||!g.enablePlatformCallConstraintsPerCall)return g;const m=convertCallConstraintsToSettings(this.logger,g,this.mergedConstraints);return this.logger.safe.info(`Merging settings with platform call constraints: ${stringifyObject(m)}`),(0,Ea.assign)({},g,m,arrayMergeCustomizer2)}},Pa="function",Ma="object",wa="undefined",Da="prototype",Oa="hasOwnProperty",Na=Object,ka=Na[Da],La=Na.assign,Fa=Na.create,xa=Na.defineProperty,Ua=ka[Oa],Va=null;function getGlobal(g){void 0===g&&(g=!0);var m=!1===g?null:Va;return m||(typeof globalThis!==wa&&(m=globalThis),m||typeof self===wa||(m=self),m||typeof window===wa||(m=window),m||typeof S===wa||(m=S),Va=m),m}function throwTypeError(g){throw new TypeError(g)}function objCreateFn(g){if(Fa)return Fa(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==Ma&&m!==Pa&&throwTypeError("Object prototype may only be an Object:"+g),tmpFunc[Da]=g,new tmpFunc}(getGlobal()||{}).Symbol,(getGlobal()||{}).Reflect;var Ba,__objAssignFnImpl=function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])ka[Oa].call(m,C)&&(g[C]=m[C]);return g},Ha=La||__objAssignFnImpl,extendStaticsFn=function(g,m){return(extendStaticsFn=Na.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m[Oa](S)&&(g[S]=m[S])})(g,m)};function __extendsFn(g,m){function __(){this.constructor=g}typeof m!==Pa&&null!==m&&throwTypeError("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn(g,m),g[Da]=null===m?objCreateFn(m):(__[Da]=m[Da],new __)}function __spreadArrayFn(g,m){for(var S=0,v=m.length,C=g.length;S<v;S++,C++)g[C]=m[S];return g}var $a="undefined",Ga="constructor",ja="prototype",qa="function",Wa="_dynInstFuncs",za="_isDynProxy",Ka="_dynClass",Ja="_dynCls$",Ya="_dynInstChk",Qa=Ya,Xa="_dfOpts",Za="_unknown_",eo="__proto__",to="_dyn"+eo,io="__dynProto$Gbl",no="_dynInstProto",ro="useBaseInst",so="setInstFuncs",ao=Object,oo=ao.getPrototypeOf,lo=ao.getOwnPropertyNames;function _getGlobal(){var g;return typeof globalThis!==$a&&(g=globalThis),g||typeof self===$a||(g=self),g||typeof window===$a||(g=window),g||typeof S===$a||(g=S),g||{}}var co=_getGlobal(),ho=co[io]||(co[io]={o:(Ba={},Ba[so]=!0,Ba[ro]=!0,Ba),n:1e3});function _hasOwnProperty(g,m){return g&&ao[ja].hasOwnProperty.call(g,m)}function _isObjectOrArrayPrototype(g){return g&&(g===ao[ja]||g===Array[ja])}function _isObjectArrayOrFunctionPrototype(g){return _isObjectOrArrayPrototype(g)||g===Function[ja]}function _getObjProto(g){var m;if(g){if(oo)return oo(g);var S=g[eo]||g[ja]||(g[Ga]?g[Ga][ja]:null);m=g[to]||S,_hasOwnProperty(g,to)||(delete g[no],m=g[to]=g[no]||g[to],g[no]=S)}return m}function _forEachProp(g,m){var S=[];if(lo)S=lo(g);else for(var v in g)"string"==typeof v&&_hasOwnProperty(g,v)&&S.push(v);if(S&&S.length>0)for(var C=0;C<S.length;C++)m(S[C])}function _isDynamicCandidate(g,m,S){return m!==Ga&&typeof g[m]===qa&&(S||_hasOwnProperty(g,m))}function _throwTypeError(g){throw new TypeError("DynamicProto: "+g)}function _getInstanceFuncs(g){var m={};return _forEachProp(g,(function(S){!m[S]&&_isDynamicCandidate(g,S,!1)&&(m[S]=g[S])})),m}function _hasVisited(g,m){for(var S=g.length-1;S>=0;S--)if(g[S]===m)return!0;return!1}function _getBaseFuncs(g,m,S,v){function _instFuncProxy(g,m,S){var C=m[S];if(C[za]&&v){var _=g[Wa]||{};!1!==_[Qa]&&(C=(_[m[Ka]]||{})[S]||C)}return function(){return C.apply(g,arguments)}}var C={};_forEachProp(S,(function(g){C[g]=_instFuncProxy(m,S,g)}));for(var _=_getObjProto(g),E=[];_&&!_isObjectArrayOrFunctionPrototype(_)&&!_hasVisited(E,_);)_forEachProp(_,(function(g){!C[g]&&_isDynamicCandidate(_,g,!oo)&&(C[g]=_instFuncProxy(m,_,g))})),E.push(_),_=_getObjProto(_);return C}function _getInstFunc(g,m,S,v){var C=null;if(g&&_hasOwnProperty(S,Ka)){var _=g[Wa]||{};if((C=(_[S[Ka]]||{})[m])||_throwTypeError("Missing ["+m+"] "+qa),!C[Ya]&&!1!==_[Qa]){for(var E=!_hasOwnProperty(g,m),T=_getObjProto(g),I=[];E&&T&&!_isObjectArrayOrFunctionPrototype(T)&&!_hasVisited(I,T);){var b=T[m];if(b){E=b===v;break}I.push(T),T=_getObjProto(T)}try{E&&(g[m]=C),C[Ya]=1}catch(g){_[Qa]=!1}}}return C}function _getProtoFunc(g,m,S){var v=m[g];return v===S&&(v=_getObjProto(m)[g]),typeof v!==qa&&_throwTypeError("["+g+"] is not a "+qa),v}function _populatePrototype(g,m,S,v,C){function _createDynamicPrototype(g,m){var dynProtoProxy=function(){return(_getInstFunc(this,m,g,dynProtoProxy)||_getProtoFunc(m,g,dynProtoProxy)).apply(this,arguments)};return dynProtoProxy[za]=1,dynProtoProxy}if(!_isObjectOrArrayPrototype(g)){var _=S[Wa]=S[Wa]||{},E=_[m]=_[m]||{};!1!==_[Qa]&&(_[Qa]=!!C),_forEachProp(S,(function(m){_isDynamicCandidate(S,m,!1)&&S[m]!==v[m]&&(E[m]=S[m],delete S[m],(!_hasOwnProperty(g,m)||g[m]&&!g[m][za])&&(g[m]=_createDynamicPrototype(g,m)))}))}}function _checkPrototype(g,m){if(oo){for(var S=[],v=_getObjProto(m);v&&!_isObjectArrayOrFunctionPrototype(v)&&!_hasVisited(S,v);){if(v===g)return!0;S.push(v),v=_getObjProto(v)}return!1}return!0}function _getObjName(g,m){return _hasOwnProperty(g,ja)?g.name||m||Za:((g||{})[Ga]||{}).name||m||Za}function dynamicProto(g,m,S,v){_hasOwnProperty(g,ja)||_throwTypeError("theClass is an invalid class definition.");var C=g[ja];_checkPrototype(C,m)||_throwTypeError("["+_getObjName(g)+"] not in hierarchy of ["+_getObjName(m)+"]");var _=null;_hasOwnProperty(C,Ka)?_=C[Ka]:(_=Ja+_getObjName(g,"_")+"$"+ho.n,ho.n++,C[Ka]=_);var E=dynamicProto[Xa],T=!!E[ro];T&&v&&void 0!==v[ro]&&(T=!!v[ro]);var I=_getInstanceFuncs(m);S(m,_getBaseFuncs(C,m,I,T));var b=!!oo&&!!E[so];b&&v&&(b=!!v[so]),_populatePrototype(C,_,m,I,!1!==b)}dynamicProto[Xa]=ho.o;var uo="initialize",go="name",po="getNotifyMgr",mo="identifier",fo="push",So="isInitialized",vo="config",Co="instrumentationKey",_o="logger",yo="length",Eo="time",To="processNext",Io="getProcessTelContext",bo="addNotificationListener",Ao="removeNotificationListener",Ro="stopPollingInternalLogs",Po="onComplete",Mo="getPlugin",wo="flush",Do="_extensions",Oo="splice",No="teardown",ko="messageId",Lo="message",Fo="isAsync",xo="_doTeardown",Uo="update",Vo="getNext",Bo="diagLog",Ho="setNextPlugin",$o="createNew",Go="cookieCfg",jo="indexOf",qo="substring",Wo="userAgent",zo="split",Ko="setEnabled",Jo="substr",Yo="nodeType",Qo="apply",Xo="replace",Zo="enableDebugExceptions",el="logInternalMessage",tl="toLowerCase",il="call",nl="type",rl="handler",sl="listeners",al="isChildEvt",ol="getCtx",ll="setCtx",cl="complete",dl="traceId",hl="spanId",ul="traceFlags",gl="",pl="channels",ml="core",fl="createPerfMgr",Sl="disabled",vl="extensionConfig",Cl="extensions",_l="processTelemetry",yl="priority",El="eventsSent",Tl="eventsDiscarded",Il="eventsSendRequest",bl="perfEvent",Al="errorToConsole",Rl="warnToConsole",Pl="getPerfMgr",Ml="toISOString",wl="endsWith",Dl="startsWith",Ol="indexOf",Nl="trim",kl="toString",Ll="__proto__",Fl="constructor",xl=xa,Ul=Na.freeze,Vl=Na.keys,Bl=String[Da],Hl=Bl[Nl],$l=Bl[wl],Gl=Bl[Dl],jl=Date[Da][Ml],ql=Array.isArray,Wl=ka[kl],zl=Ua[kl],Kl=zl[il](Na),Jl=/-([a-z])/g,Yl=/([^\w\d_$])/g,Ql=/^(\d+[\w\d_$])/,Xl=Object.getPrototypeOf;function _getObjProto2(g){if(g){if(Xl)return Xl(g);var m=g[Ll]||g[Da]||g[Fl];if(m)return m}return null}function isUndefined3(g){return void 0===g||typeof g===wa}function isNullOrUndefined(g){return null===g||isUndefined3(g)}function isNotNullOrUndefined(g){return!isNullOrUndefined(g)}function hasOwnProperty(g,m){return!(!g||!Ua[il](g,m))}function isObject3(g){return!(!g||typeof g!==Ma)}function isFunction2(g){return!(!g||typeof g!==Pa)}function normalizeJsName(g){var m=g;return m&&isString2(m)&&(m=(m=(m=m[Xo](Jl,(function(g,m){return m.toUpperCase()})))[Xo](Yl,"_"))[Xo](Ql,(function(g,m){return"_"+m}))),m}function objForEachKey(g,m){if(g)for(var S in g)Ua[il](g,S)&&m[il](g,S,g[S])}function strEndsWith(g,m){var S=!1;return g&&m&&!(S=g===m)&&(S=$l?g[wl](m):_strEndsWithPoly(g,m)),S}function _strEndsWithPoly(g,m){var S=!1,v=m?m[yo]:0,C=g?g[yo]:0;if(v&&C&&C>=v&&!(S=g===m)){for(var _=C-1,E=v-1;E>=0;E--){if(g[_]!=m[E])return!1;_--}S=!0}return S}function strStartsWith(g,m){var S=!1;return g&&m&&!(S=g===m)&&(S=Gl?g[Dl](m):_strStartsWithPoly(g,m)),S}function _strStartsWithPoly(g,m){var S=!1,v=m?m[yo]:0;if(g&&v&&g[yo]>=v&&!(S=g===m)){for(var C=0;C<v;C++)if(g[C]!==m[C])return!1;S=!0}return S}function strContains(g,m){return!(!g||!m)&&-1!==g[jo](m)}var Zl=ql||_isArrayPoly;function _isArrayPoly(g){return!(!g||"[object Array]"!==Wl[il](g))}function isError(g){return!(!g||"[object Error]"!==Wl[il](g))}function isString2(g){return"string"==typeof g}function isNumber3(g){return"number"==typeof g}function isBoolean2(g){return"boolean"==typeof g}function isPlainObject(g){var m=!1;if(g&&"object"==typeof g){var S=Xl?Xl(g):_getObjProto2(g);S?(S[Fl]&&Ua[il](S,Fl)&&(S=S[Fl]),m=typeof S===Pa&&zl[il](S)===Kl):m=!0}return m}function toISOString(g){if(g)return jl?g[Ml]():_toISOStringPoly(g)}function _toISOStringPoly(g){if(g&&g.getUTCFullYear){var pad=function(g){var m=String(g);return 1===m[yo]&&(m="0"+m),m};return g.getUTCFullYear()+"-"+pad(g.getUTCMonth()+1)+"-"+pad(g.getUTCDate())+"T"+pad(g.getUTCHours())+":"+pad(g.getUTCMinutes())+":"+pad(g.getUTCSeconds())+"."+String((g.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}function arrForEach(g,m,S){var v=g[yo];try{for(var C=0;C<v&&(!(C in g)||-1!==m[il](S||g,g[C],C,g));C++);}catch(g){}}function arrIndexOf(g,m,S){if(g){if(g[Ol])return g[Ol](m,S);var v=g[yo],C=S||0;try{for(var _=Math.max(C>=0?C:v-Math.abs(C),0);_<v;_++)if(_ in g&&g[_]===m)return _}catch(g){}}return-1}function strTrim(g){return g&&(g=Hl&&g[Nl]?g[Nl]():g[Xo]?g[Xo](/^\s+|(?=\s)\s+$/g,gl):g),g}var ec=!{toString:null}.propertyIsEnumerable("toString"),tc=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function objKeys(g){var m=typeof g;if(m===Pa||m===Ma&&null!==g||throwTypeError("objKeys called on non-object"),!ec&&Vl)return Vl(g);var S=[];for(var v in g)g&&Ua[il](g,v)&&S[fo](v);if(ec)for(var C=tc[yo],_=0;_<C;_++)g&&Ua[il](g,tc[_])&&S[fo](tc[_]);return S}function objDefineAccessors(g,m,S,v){if(xl)try{var C={enumerable:!0,configurable:!0};return S&&(C.get=S),v&&(C.set=v),xl(g,m,C),!0}catch(g){}return!1}function _doNothing(g){return g}function deepFreeze(g){return Ul&&objForEachKey(g,(function(g,m){(Zl(m)||isObject3(m))&&Ul(m)})),ic(g)}var ic=Ul||_doNothing;function dateNow(){var g=Date;return g.now?g.now():(new g).getTime()}function getExceptionName(g){return isError(g)?g[go]:gl}function setValue(g,m,S,v,C){var _=S;return g&&((_=g[m])===S||C&&!C(_)||v&&!v(S)||(_=S,g[m]=_)),_}function getSetValue(g,m,S){var v;return g?!(v=g[m])&&isNullOrUndefined(v)&&(v=isUndefined3(S)?{}:S,g[m]=v):v=isUndefined3(S)?{}:S,v}function getCfgValue(g,m){return isNullOrUndefined(g)?m:g}function isTruthy(g){return!!g}function throwError(g){throw new Error(g)}function _createProxyFunction(g,m){var S=null,v=null;return isFunction2(g)?S=g:v=g,function(){var g=arguments;if(S&&(v=S()),v)return v[m][Qo](v,g)}}function proxyFunctionAs(g,m,S,v,C){g&&m&&S&&(!1!==C||isUndefined3(g[m]))&&(g[m]=_createProxyFunction(S,v))}function proxyFunctions(g,m,S,v){return g&&m&&isObject3(g)&&Zl(S)&&arrForEach(S,(function(S){isString2(S)&&proxyFunctionAs(g,S,m,S,v)})),g}function optimizeObject(g){return g&&La&&(g=Na(La({},g))),g}function objExtend(g,m,S,v,C,_){var E=arguments,T=E[0]||{},I=E[yo],b=!1,A=1;for(I>0&&isBoolean2(T)&&(b=T,T=E[A]||{},A++),isObject3(T)||(T={});A<I;A++){var R=E[A],P=Zl(R),M=isObject3(R);for(var w in R){if(P&&w in R||M&&Ua[il](R,w)){var D=R[w],O=void 0;if(b&&D&&((O=Zl(D))||isPlainObject(D))){var N=T[w];O?Zl(N)||(N=[]):isPlainObject(N)||(N={}),D=objExtend(b,N,D)}void 0!==D&&(T[w]=D)}}}return T}function createEnumStyle(g){var m={};return objForEachKey(g,(function(g,S){m[g]=S,m[S]=g})),deepFreeze(m)}function createValueMap(g){var m={};return objForEachKey(g,(function(g,S){m[g]=S[1],m[S[0]]=S[1]})),deepFreeze(m)}var nc=createEnumStyle({Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5}),rc="window",sc="document",ac="navigator",oc="location",lc="console",cc="performance",dc="JSON",hc="crypto",uc="msCrypto",gc="ReactNative",pc="msie",mc="trident/",fc="XMLHttpRequest",Sc=null,vc=null,Cc=!1,_c=null,yc=null;function _hasProperty(g,m){var S=!1;if(g){try{if(!(S=m in g)){var v=g[Da];v&&(S=m in v)}}catch(g){}if(!S)try{S=!isUndefined3((new g)[m])}catch(g){}}return S}function getGlobalInst(g){var m=getGlobal();return m&&m[g]?m[g]:g===rc&&hasWindow()?window:null}function hasWindow(){return Boolean(typeof window===Ma&&window)}function getWindow(){return hasWindow()?window:getGlobalInst(rc)}function hasDocument(){return Boolean(typeof document===Ma&&document)}function getDocument(){return hasDocument()?document:getGlobalInst(sc)}function hasNavigator(){return Boolean(typeof navigator===Ma&&navigator)}function getNavigator(){return hasNavigator()?navigator:getGlobalInst(ac)}function getLocation(g){if(g&&Cc){var m=getGlobalInst("__mockLocation");if(m)return m}return typeof location===Ma&&location?location:getGlobalInst(oc)}function getConsole(){return typeof console!==wa?console:getGlobalInst(lc)}function getPerformance(){return getGlobalInst(cc)}function hasJSON(){return Boolean(typeof JSON===Ma&&JSON||null!==getGlobalInst(dc))}function getJSON(){return hasJSON()?JSON||getGlobalInst(dc):null}function getCrypto(){return getGlobalInst(hc)}function getMsCrypto(){return getGlobalInst(uc)}function isReactNative(){var g=getNavigator();return!(!g||!g.product)&&g.product===gc}function isIE(){var g=getNavigator();if(g&&(g[Wo]!==vc||null===Sc)){var m=((vc=g[Wo])||gl)[tl]();Sc=strContains(m,pc)||strContains(m,mc)}return Sc}function dumpObj(g){var m=Object[Da].toString[il](g),S=gl;return"[object Error]"===m?S="{ stack: '"+g.stack+"', message: '"+g.message+"', name: '"+g[go]+"'":hasJSON()&&(S=getJSON().stringify(g)),m+S}function isBeaconsSupported(){return null===yc&&(yc=hasNavigator()&&Boolean(getNavigator().sendBeacon)),yc}function isFetchSupported(g){var m=!1;try{m=!!getGlobalInst("fetch");var S=getGlobalInst("Request");m&&g&&S&&(m=_hasProperty(S,"keepalive"))}catch(g){}return m}function useXDomainRequest(){return null===_c&&(_c=typeof XDomainRequest!==wa)&&isXhrSupported()&&(_c=_c&&!_hasProperty(getGlobalInst(fc),"withCredentials")),_c}function isXhrSupported(){var g=!1;try{g=!!getGlobalInst(fc)}catch(g){}return g}var Ec,Tc=["eventsSent","eventsDiscarded","eventsSendRequest","perfEvent"],Ic=null;function _listenerProxyFunc(g,m){return function(){var S=arguments,v=getDebugExt(m);if(v){var C=v.listener;C&&C[g]&&C[g][Qo](C,S)}}}function _getExtensionNamespace(){var g=getGlobalInst("Microsoft");return g&&(Ic=g.ApplicationInsights),Ic}function getDebugExt(g){var m=Ic;return m||!0===g.disableDbgExt||(m=Ic||_getExtensionNamespace()),m?m.ChromeDbgExt:null}function getDebugListener(g){if(!Ec){Ec={};for(var m=0;m<Tc[yo];m++)Ec[Tc[m]]=_listenerProxyFunc(Tc[m],g)}return Ec}var bc="AI (Internal): ",Ac="AI: ",Rc="AITR_";function _sanitizeDiagnosticText(g){return g?'"'+g[Xo](/\"/g,gl)+'"':gl}function _logToConsole(g,m){var S=getConsole();if(S){var v="log";S[g]&&(v=g),isFunction2(S[v])&&S[v](m)}}var Pc=function(){function _InternalLogMessage2(g,m,S,v){void 0===S&&(S=!1);var C=this;C[ko]=g,C[Lo]=(S?Ac:bc)+g;var _=gl;hasJSON()&&(_=getJSON().stringify(v));var E=(m?" message:"+_sanitizeDiagnosticText(m):gl)+(v?" props:"+_sanitizeDiagnosticText(_):gl);C[Lo]+=E}return _InternalLogMessage2.dataType="MessageData",_InternalLogMessage2}();function safeGetLogger(g,m){return(g||{})[_o]||new Mc(m)}var Mc=function(){function DiagnosticLogger2(g){this.identifier="DiagnosticLogger",this.queue=[];var m,S,v,C,_=0,E={};dynamicProto(DiagnosticLogger2,this,(function(T){function _logInternalMessage2(g,m){if(!_areInternalMessagesThrottled()){var C=!0,I=Rc+m[ko];if(E[I]?C=!1:E[I]=!0,C&&(g<=S&&(T.queue[fo](m),_++,_debugExtMsg(1===g?"error":"warn",m)),_===v)){var b="Internal events throttle limit per PageView reached for this app.",A=new Pc(23,b,!1);T.queue[fo](A),1===g?T[Al](b):T[Rl](b)}}}function _setDefaultsFromConfig(g){m=getCfgValue(g.loggingLevelConsole,0),S=getCfgValue(g.loggingLevelTelemetry,1),v=getCfgValue(g.maxMessageLimit,25),C=getCfgValue(g[Zo],!1)}function _areInternalMessagesThrottled(){return _>=v}function _debugExtMsg(m,S){var v=getDebugExt(g||{});v&&v[Bo]&&v[Bo](m,S)}_setDefaultsFromConfig(g||{}),T.consoleLoggingLevel=function(){return m},T.telemetryLoggingLevel=function(){return S},T.maxInternalMessageLimit=function(){return v},T[Zo]=function(){return C},T.throwInternal=function(g,S,v,_,I){void 0===I&&(I=!1);var b=new Pc(S,v,I,_);if(C)throw dumpObj(b);var A=1===g?Al:Rl;if(isUndefined3(b[Lo]))_debugExtMsg("throw"+(1===g?"Critical":"Warning"),b);else{if(I){var R=+b[ko];!E[R]&&m>=g&&(T[A](b[Lo]),E[R]=!0)}else m>=g&&T[A](b[Lo]);_logInternalMessage2(g,b)}},T[Rl]=function(g){_logToConsole("warn",g),_debugExtMsg("warning",g)},T[Al]=function(g){_logToConsole("error",g),_debugExtMsg("error",g)},T.resetInternalMessageCount=function(){_=0,E={}},T[el]=_logInternalMessage2}))}return DiagnosticLogger2.__ieDyn=1,DiagnosticLogger2}();function _getLogger(g){return g||new Mc}function _throwInternal(g,m,S,v,C,_){void 0===_&&(_=!1),_getLogger(g).throwInternal(m,S,v,C,_)}function _warnToConsole(g,m){_getLogger(g)[Rl](m)}var wc="ctx",Dc="ParentContextKey",Oc="ChildrenContextKey",Nc=null,kc=function(){function PerfEvent2(g,m,S){var v,C=this,_=!1;(C.start=dateNow(),C[go]=g,C[Fo]=S,C[al]=function(){return!1},isFunction2(m))&&(_=objDefineAccessors(C,"payload",(function(){return!v&&isFunction2(m)&&(v=m(),m=null),v})));C[ol]=function(g){return g?g===PerfEvent2[Dc]||g===PerfEvent2[Oc]?C[g]:(C[wc]||{})[g]:null},C[ll]=function(g,m){if(g)if(g===PerfEvent2[Dc])C[g]||(C[al]=function(){return!0}),C[g]=m;else if(g===PerfEvent2[Oc])C[g]=m;else{(C[wc]=C[wc]||{})[g]=m}},C[cl]=function(){var g=0,S=C[ol](PerfEvent2[Oc]);if(Zl(S))for(var v=0;v<S[yo];v++){var E=S[v];E&&(g+=E[Eo])}C[Eo]=dateNow()-C.start,C.exTime=C[Eo]-g,C[cl]=function(){},!_&&isFunction2(m)&&(C.payload=m())}}return PerfEvent2.ParentContextKey="parent",PerfEvent2.ChildrenContextKey="childEvts",PerfEvent2}(),Lc=function(){function PerfManager2(g){this.ctx={},dynamicProto(PerfManager2,this,(function(m){m.create=function(g,m,S){return new kc(g,m,S)},m.fire=function(m){m&&(m[cl](),g&&isFunction2(g[bl])&&g[bl](m))},m[ll]=function(g,S){g&&((m[wc]=m[wc]||{})[g]=S)},m[ol]=function(g){return(m[wc]||{})[g]}}))}return PerfManager2.__ieDyn=1,PerfManager2}(),Fc="CoreUtils.doPerf";function doPerf(g,m,S,v,C){if(g){var _=g;if(_[Pl]&&(_=_[Pl]()),_){var E=void 0,T=_[ol](Fc);try{if(E=_.create(m(),v,C)){if(T&&E[ll]&&(E[ll](kc[Dc],T),T[ol]&&T[ll])){var I=T[ol](kc[Oc]);I||(I=[],T[ll](kc[Oc],I)),I[fo](E)}return _[ll](Fc,E),S(E)}}catch(g){E&&E[ll]&&E[ll]("exception",g)}finally{E&&_.fire(E),_[ll](Fc,T)}}}return S()}function getGblPerfMgr(){return Nc}var xc=4294967296,Uc=4294967295,Vc=!1,Bc=123456789,Hc=987654321;function _mwcSeed(g){g<0&&(g>>>=0),Bc=123456789+g&Uc,Hc=987654321-g&Uc,Vc=!0}function _autoSeedMwc(){try{var g=2147483647&dateNow();_mwcSeed((Math.random()*xc^g)+g)}catch(g){}}function random32(g){var m=0,S=getCrypto()||getMsCrypto();return S&&S.getRandomValues&&(m=S.getRandomValues(new Uint32Array(1))[0]&Uc),0===m&&isIE()&&(Vc||_autoSeedMwc(),m=mwcRandom32()&Uc),0===m&&(m=Math.floor(xc*Math.random()|0)),g||(m>>>=0),m}function mwcRandom32(g){var m=((Hc=36969*(65535&Hc)+(Hc>>16)&Uc)<<16)+(65535&(Bc=18e3*(65535&Bc)+(Bc>>16)&Uc))>>>0&Uc|0;return g||(m>>>=0),m}function newId(g){void 0===g&&(g=22);for(var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",S=random32()>>>0,v=0,C=gl;C[yo]<g;)v++,C+=m.charAt(63&S),S>>>=6,5===v&&(S=(random32()<<2&4294967295|3&S)>>>0,v=0);return C}var $c=xa,Gc="2.8.10",jc="."+newId(6),qc=0;function _createAccessor(g,m,S){if($c)try{return $c(g,m,{value:S,enumerable:!1,configurable:!0}),!0}catch(g){}return!1}function _canAcceptData(g){return 1===g[Yo]||9===g[Yo]||!+g[Yo]}function _getCache(g,m){var S=m[g.id];if(!S){S={};try{_canAcceptData(m)&&(_createAccessor(m,g.id,S)||(m[g.id]=S))}catch(g){}}return S}function createUniqueNamespace(g,m){return void 0===m&&(m=!1),normalizeJsName(g+qc+++(m?"."+Gc:gl)+jc)}function createElmNodeData(g){var m={id:createUniqueNamespace("_aiData-"+(g||gl)+"."+Gc),accept:function(g){return _canAcceptData(g)},get:function(g,S,v,C){var _=g[m.id];return _?_[normalizeJsName(S)]:(C&&((_=_getCache(m,g))[normalizeJsName(S)]=v),v)},kill:function(g,m){if(g&&g[m])try{delete g[m]}catch(g){}}};return m}var Wc="toGMTString",zc="toUTCString",Kc="cookie",Jc="expires",Yc="enabled",Qc="isCookieUseDisabled",Xc="disableCookiesUsage",Zc="_ckMgr",ed=null,td=null,id=null,nd=getDocument(),rd={},sd={};function _gblCookieMgr(g,m){var S=createCookieMgr[Zc]||sd[Zc];return S||(S=createCookieMgr[Zc]=createCookieMgr(g,m),sd[Zc]=S),S}function _isMgrEnabled(g){return!g||g.isEnabled()}function _createCookieMgrConfig(g){var m=g[Go]=g[Go]||{};if(setValue(m,"domain",g.cookieDomain,isNotNullOrUndefined,isNullOrUndefined),setValue(m,"path",g.cookiePath||"/",null,isNullOrUndefined),isNullOrUndefined(m[Yc])){var S=void 0;isUndefined3(g[Qc])||(S=!g[Qc]),isUndefined3(g[Xc])||(S=!g[Xc]),m[Yc]=S}return m}function _isIgnoredCookie(g,m){return!!(m&&g&&Zl(g.ignoreCookies))&&-1!==g.ignoreCookies[jo](m)}function _isBlockedCookie(g,m){return!!(m&&g&&Zl(g.blockedCookies)&&-1!==g.blockedCookies[jo](m))||_isIgnoredCookie(g,m)}function safeGetCookieMgr(g,m){var S;if(g)S=g.getCookieMgr();else if(m){var v=m[Go];S=v[Zc]?v[Zc]:createCookieMgr(m)}return S||(S=_gblCookieMgr(m,(g||{})[_o])),S}function createCookieMgr(g,m){var S,v=_createCookieMgrConfig(g||sd),C=v.path||"/",_=v.domain,E=!1!==v[Yc],T=((S={isEnabled:function(){var g=E&&areCookiesSupported(m),S=sd[Zc];return g&&S&&T!==S&&(g=_isMgrEnabled(S)),g}})[Ko]=function(g){E=!1!==g},S.set=function(g,m,S,E,I){var b=!1;if(_isMgrEnabled(T)&&!_isBlockedCookie(v,g)){var A={},R=strTrim(m||gl),P=R[jo](";");if(-1!==P&&(R=strTrim(m[qo](0,P)),A=_extractParts(m[qo](P+1))),setValue(A,"domain",E||_,isTruthy,isUndefined3),!isNullOrUndefined(S)){var M=isIE();if(isUndefined3(A[Jc])){var w=dateNow()+1e3*S;if(w>0){var D=new Date;D.setTime(w),setValue(A,Jc,_formatDate(D,M?Wc:zc)||_formatDate(D,M?Wc:zc)||gl,isTruthy)}}M||setValue(A,"max-age",gl+S,null,isUndefined3)}var O=getLocation();O&&"https:"===O.protocol&&(setValue(A,"secure",null,null,isUndefined3),null===td&&(td=!uaDisallowsSameSiteNone((getNavigator()||{})[Wo])),td&&setValue(A,"SameSite","None",null,isUndefined3)),setValue(A,"path",I||C,null,isUndefined3),(v.setCookie||_setCookieValue)(g,_formatCookieValue(R,A)),b=!0}return b},S.get=function(g){var m=gl;return _isMgrEnabled(T)&&!_isIgnoredCookie(v,g)&&(m=(v.getCookie||_getCookieValue)(g)),m},S.del=function(g,m){var S=!1;return _isMgrEnabled(T)&&(S=T.purge(g,m)),S},S.purge=function(g,S){var C,_=!1;if(areCookiesSupported(m)){var E=((C={}).path=S||"/",C[Jc]="Thu, 01 Jan 1970 00:00:01 GMT",C);isIE()||(E["max-age"]="0"),(v.delCookie||_setCookieValue)(g,_formatCookieValue(gl,E)),_=!0}return _},S);return T[Zc]=T,T}function areCookiesSupported(g){if(null===ed){ed=!1;try{ed=void 0!==(nd||{})[Kc]}catch(m){_throwInternal(g,2,68,"Cannot access document.cookie - "+getExceptionName(m),{exception:dumpObj(m)})}}return ed}function _extractParts(g){var m={};g&&g[yo]&&arrForEach(strTrim(g)[zo](";"),(function(g){if(g=strTrim(g||gl)){var S=g[jo]("=");-1===S?m[g]=null:m[strTrim(g[qo](0,S))]=strTrim(g[qo](S+1))}}));return m}function _formatDate(g,m){return isFunction2(g[m])?g[m]():null}function _formatCookieValue(g,m){var S=g||gl;return objForEachKey(m,(function(g,m){S+="; "+g+(isNullOrUndefined(m)?gl:"="+m)})),S}function _getCookieValue(g){var m=gl;if(nd){var S=nd[Kc]||gl;id!==S&&(rd=_extractParts(S),id=S),m=strTrim(rd[g]||gl)}return m}function _setCookieValue(g,m){nd&&(nd[Kc]=g+"="+m)}function uaDisallowsSameSiteNone(g){return!!isString2(g)&&(!(!strContains(g,"CPU iPhone OS 12")&&!strContains(g,"iPad; CPU OS 12"))||(!!(strContains(g,"Macintosh; Intel Mac OS X 10_14")&&strContains(g,"Version/")&&strContains(g,"Safari"))||(!(!strContains(g,"Macintosh; Intel Mac OS X 10_14")||!strEndsWith(g,"AppleWebKit/605.1.15 (KHTML, like Gecko)"))||(!(!strContains(g,"Chrome/5")&&!strContains(g,"Chrome/6"))||(!(!strContains(g,"UnrealEngine")||strContains(g,"Chrome"))||!(!strContains(g,"UCBrowser/12")&&!strContains(g,"UCBrowser/11")))))))}var ad="on",od="attachEvent",ld="addEventListener",cd="detachEvent",dd="removeEventListener",hd="events",ud="visibilitychange",gd="pagehide",pd="pageshow",md="unload",fd="beforeunload",Sd=createUniqueNamespace("aiEvtPageHide"),vd=createUniqueNamespace("aiEvtPageShow"),Cd=/\.[\.]+/g,_d=/[\.]+$/,yd=1,Ed=createElmNodeData("events"),Td=/^([^.]*)(?:\.(.+)|)/;function _normalizeNamespace(g){return g&&g[Xo]?g[Xo](/^[\s\.]+|(?=[\s\.])[\.\s]+$/g,gl):g}function _getEvtNamespace(g,m){var S;if(m){var v=gl;Zl(m)?(v=gl,arrForEach(m,(function(g){(g=_normalizeNamespace(g))&&("."!==g[0]&&(g="."+g),v+=g)}))):v=_normalizeNamespace(m),v&&("."!==v[0]&&(v="."+v),g=(g||gl)+v)}var C=Td.exec(g||gl)||[];return(S={})[nl]=C[1],S.ns=(C[2]||gl).replace(Cd,".").replace(_d,gl)[zo](".").sort().join("."),S}function _getRegisteredEvents(g,m,S){void 0===S&&(S=!0);var v=Ed.get(g,hd,{},S),C=v[m];return C||(C=v[m]=[]),C}function _doDetach(g,m,S,v){g&&m&&m[nl]&&(g[dd]?g[dd](m[nl],S,v):g[cd]&&g[cd](ad+m[nl],S))}function _doAttach(g,m,S,v){var C=!1;return g&&m&&m[nl]&&S&&(g[ld]?(g[ld](m[nl],S,v),C=!0):g[od]&&(g[od](ad+m[nl],S),C=!0)),C}function _doUnregister(g,m,S,v){for(var C=m[yo];C--;){var _=m[C];_&&(S.ns&&S.ns!==_.evtName.ns||v&&!v(_)||(_doDetach(g,_.evtName,_[rl],_.capture),m[Oo](C,1)))}}function _unregisterEvents(g,m,S){if(m[nl])_doUnregister(g,_getRegisteredEvents(g,m[nl]),m,S);else{var v=Ed.get(g,hd,{});objForEachKey(v,(function(v,C){_doUnregister(g,C,m,S)})),0===objKeys(v)[yo]&&Ed.kill(g,hd)}}function mergeEvtNamespace(g,m){return m?_getEvtNamespace("xx",Zl(m)?[g].concat(m):[g,m]).ns[zo]("."):g}function eventOn(g,m,S,v,C){var _;void 0===C&&(C=!1);var E=!1;if(g)try{var T=_getEvtNamespace(m,v);if((E=_doAttach(g,T,S,C))&&Ed.accept(g)){var I=((_={guid:yd++,evtName:T})[rl]=S,_.capture=C,_);_getRegisteredEvents(g,T.type)[fo](I)}}catch(g){}return E}function eventOff(g,m,S,v,C){if(void 0===C&&(C=!1),g)try{var _=_getEvtNamespace(m,v),E=!1;_unregisterEvents(g,_,(function(g){return!((!_.ns||S)&&g[rl]!==S)&&(E=!0,!0)})),E||_doDetach(g,_,S,C)}catch(g){}}function addEventHandler(g,m,S){var v=!1,C=getWindow();C&&(v=eventOn(C,g,m,S),v=eventOn(C.body,g,m,S)||v);var _=getDocument();return _&&(v=eventOn(_,g,m,S)||v),v}function removeEventHandler(g,m,S){var v=getWindow();v&&(eventOff(v,g,m,S),eventOff(v.body,g,m,S));var C=getDocument();C&&eventOff(C,g,m,S)}function _addEventListeners(g,m,S,v){var C=!1;return m&&g&&g[yo]>0&&arrForEach(g,(function(g){g&&(S&&-1!==arrIndexOf(S,g)||(C=addEventHandler(g,m,v)||C))})),C}function addEventListeners(g,m,S,v){var C=!1;return m&&g&&Zl(g)&&!(C=_addEventListeners(g,m,S,v))&&S&&S[yo]>0&&(C=_addEventListeners(g,m,null,v)),C}function removeEventListeners(g,m,S){g&&Zl(g)&&arrForEach(g,(function(g){g&&removeEventHandler(g,m,S)}))}function addPageUnloadEventListener(g,m,S){return addEventListeners([fd,md,gd],g,m,S)}function removePageUnloadEventListener(g,m){removeEventListeners([fd,md,gd],g,m)}function addPageHideEventListener(g,m,S){function _handlePageVisibility(m){var S=getDocument();g&&S&&"hidden"===S.visibilityState&&g(m)}var v=mergeEvtNamespace(Sd,S),C=_addEventListeners([gd],g,m,v);return m&&-1!==arrIndexOf(m,ud)||(C=_addEventListeners([ud],_handlePageVisibility,m,v)||C),!C&&m&&(C=addPageHideEventListener(g,null,S)),C}function removePageHideEventListener(g,m){var S=mergeEvtNamespace(Sd,m);removeEventListeners([gd],g,S),removeEventListeners([ud],null,S)}function addPageShowEventListener(g,m,S){function _handlePageVisibility(m){var S=getDocument();g&&S&&"visible"===S.visibilityState&&g(m)}var v=mergeEvtNamespace(vd,S),C=_addEventListeners([pd],g,m,v);return!(C=_addEventListeners([ud],_handlePageVisibility,m,v)||C)&&m&&(C=addPageShowEventListener(g,null,S)),C}function removePageShowEventListener(g,m){var S=mergeEvtNamespace(vd,m);removeEventListeners([pd],g,S),removeEventListeners([ud],null,S)}function newGuid2(){var g=generateW3CId();return g[qo](0,8)+"-"+g[qo](8,12)+"-"+g[qo](12,16)+"-"+g[qo](16,20)+"-"+g[qo](20)}function perfNow(){var g=getPerformance();return g&&g.now?g.now():dateNow()}function generateW3CId(){for(var g,m=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],S=gl,v=0;v<4;v++)S+=m[15&(g=random32())]+m[g>>4&15]+m[g>>8&15]+m[g>>12&15]+m[g>>16&15]+m[g>>20&15]+m[g>>24&15]+m[g>>28&15];var C=m[8+(3&random32())|0];return S[Jo](0,8)+S[Jo](9,4)+"4"+S[Jo](13,3)+C+S[Jo](16,3)+S[Jo](19,12)}var Id="00000000000000000000000000000000",bd="0000000000000000";function _isValid(g,m,S){return!(!g||g[yo]!==m||g===S)&&!!g.match(/^[\da-f]*$/)}function isValidTraceId(g){return _isValid(g,32,Id)}function isValidSpanId(g){return _isValid(g,16,bd)}var Ad=createElmNodeData("plugin");function _getPluginState(g){return Ad.get(g,"state",{},!0)}function initializePlugins(g,m){for(var S,v=[],C=null,_=g[Vo]();_;){var E=_[Mo]();if(E){C&&isFunction2(C[Ho])&&isFunction2(E[_l])&&C[Ho](E);(isFunction2(E[So])?E[So]():(S=_getPluginState(E))[So])||v[fo](E),C=E,_=_[Vo]()}}arrForEach(v,(function(v){var C=g[ml]();v[uo](g.getCfg(),C,m,g[Vo]()),S=_getPluginState(v),v[ml]||S[ml]||(S[ml]=C),S[So]=!0,delete S[No]}))}function sortPlugins(g){return g.sort((function(g,m){var S=0;if(m){var v=isFunction2(m[_l]);isFunction2(g[_l])?S=v?g[yl]-m[yl]:1:v&&(S=-1)}else S=g?1:-1;return S}))}function createDistributedTraceContext(g){var m={};return{getName:function(){return m[go]},setName:function(S){g&&g.setName(S),m[go]=S},getTraceId:function(){return m[dl]},setTraceId:function(S){g&&g.setTraceId(S),isValidTraceId(S)&&(m[dl]=S)},getSpanId:function(){return m[hl]},setSpanId:function(S){g&&g.setSpanId(S),isValidSpanId(S)&&(m[hl]=S)},getTraceFlags:function(){return m[ul]},setTraceFlags:function(S){g&&g.setTraceFlags(S),m[ul]=S}}}var Rd="TelemetryPluginChain",Pd="_hasRun",Md="_getTelCtx",wd=0;function _getNextProxyStart(g,m,S){for(;g;){if(g[Mo]()===S)return g;g=g[Vo]()}return createTelemetryProxyChain([S],m[vo]||{},m)}function _createInternalContext(g,m,S,v){var C=null,_=[];null!==v&&(C=v?_getNextProxyStart(g,S,v):g);var E={_next:_moveNext,ctx:{core:function(){return S},diagLog:function(){return safeGetLogger(S,m)},getCfg:function(){return m},getExtCfg:_getExtCfg,getConfig:_getConfig,hasNext:function(){return!!C},getNext:function(){return C},setNext:function(g){C=g},iterate:_iterateChain,onComplete:_addOnComplete}};function _addOnComplete(g,m){for(var S=[],v=2;v<arguments.length;v++)S[v-2]=arguments[v];g&&_[fo]({func:g,self:isUndefined3(m)?E.ctx:m,args:S})}function _moveNext(){var g=C;if(C=g?g[Vo]():null,!g){var m=_;m&&m[yo]>0&&(arrForEach(m,(function(g){try{g.func[il](g.self,g.args)}catch(g){_throwInternal(S[_o],2,73,"Unexpected Exception during onComplete - "+dumpObj(g))}})),_=[])}return g}function _getExtCfg(g,S,v){var C;if(void 0===S&&(S={}),void 0===v&&(v=0),m){var _=m[vl];_&&g&&(C=_[g])}if(C){if(isObject3(S)&&0!==v){var E=objExtend(!0,S,C);m&&2===v&&objForEachKey(S,(function(g){if(isNullOrUndefined(E[g])){var S=m[g];isNullOrUndefined(S)||(E[g]=S)}})),C=E}}else C=S;return C}function _getConfig(g,S,v){var C;void 0===v&&(v=!1);var _=_getExtCfg(g,null);return _&&!isNullOrUndefined(_[S])?C=_[S]:m&&!isNullOrUndefined(m[S])&&(C=m[S]),isNullOrUndefined(C)?v:C}function _iterateChain(g){for(var m;m=E._next();){var S=m[Mo]();S&&g(S)}}return E}function createProcessTelemetryContext(g,m,S,v){var C=_createInternalContext(g,m,S,v),_=C.ctx;function _processNext(g){var m=C._next();return m&&m[_l](g,_),!m}function _createNew(g,v){return void 0===g&&(g=null),Zl(g)&&(g=createTelemetryProxyChain(g,m,S,v)),createProcessTelemetryContext(g||_[Vo](),m,S,v)}return _[To]=_processNext,_[$o]=_createNew,_}function createProcessTelemetryUnloadContext(g,m,S){var v=m[vo]||{},C=_createInternalContext(g,v,m,S),_=C.ctx;function _processNext(g){var m=C._next();return m&&m.unload(_,g),!m}function _createNew(g,S){return void 0===g&&(g=null),Zl(g)&&(g=createTelemetryProxyChain(g,v,m,S)),createProcessTelemetryUnloadContext(g||_[Vo](),m,S)}return _[To]=_processNext,_[$o]=_createNew,_}function createProcessTelemetryUpdateContext(g,m,S){var v=m[vo]||{},C=_createInternalContext(g,v,m,S).ctx;function _processNext(g){return C.iterate((function(m){isFunction2(m[Uo])&&m[Uo](C,g)}))}function _createNew(g,S){return void 0===g&&(g=null),Zl(g)&&(g=createTelemetryProxyChain(g,v,m,S)),createProcessTelemetryUpdateContext(g||C[Vo](),m,S)}return C[To]=_processNext,C[$o]=_createNew,C}function createTelemetryProxyChain(g,m,S,v){var C=null,_=!v;if(Zl(g)&&g[yo]>0){var E=null;arrForEach(g,(function(g){if(_||v!==g||(_=!0),_&&g&&isFunction2(g[_l])){var T=createTelemetryPluginProxy(g,m,S);C||(C=T),E&&E._setNext(T),E=T}}))}return v&&!C?createTelemetryProxyChain([v],m,S):C}function createTelemetryPluginProxy(g,m,S){var v,C=null,_=isFunction2(g[_l]),E=isFunction2(g[Ho]),T={getPlugin:function(){return g},getNext:function(){return C},processTelemetry:_processTelemetry,unload:_unloadPlugin,update:_updatePlugin,_id:v=g?g[mo]+"-"+g[yl]+"-"+wd++:"Unknown-0-"+wd++,_setNext:function(g){C=g}};function _getTelCtx(){var v;return g&&isFunction2(g[Md])&&(v=g[Md]()),v||(v=createProcessTelemetryContext(T,m,S)),v}function _processChain(m,S,_,E,T){var I=!1,b=g?g[mo]:Rd,A=m[Pd];return A||(A=m[Pd]={}),m.setNext(C),g&&doPerf(m[ml](),(function(){return b+":"+_}),(function(){A[v]=!0;try{var g=C?C._id:gl;g&&(A[g]=!1),I=S(m)}catch(g){var E=!C||A[C._id];E&&(I=!0),C&&E||_throwInternal(m[Bo](),1,73,"Plugin ["+b+"] failed during "+_+" - "+dumpObj(g)+", run flags: "+dumpObj(A))}}),E,T),I}function _processTelemetry(m,S){function _callProcessTelemetry(S){if(!g||!_)return!1;var v=_getPluginState(g);return!v[No]&&!v[Sl]&&(E&&g[Ho](C),g[_l](m,S),!0)}_processChain(S=S||_getTelCtx(),_callProcessTelemetry,"processTelemetry",(function(){return{item:m}}),!m.sync)||S[To](m)}function _unloadPlugin(m,S){function _callTeardown(){var v=!1;if(g){var C=_getPluginState(g),_=g[ml]||C[ml];!g||_&&_!==m.core()||C[No]||(C[ml]=null,C[No]=!0,C[So]=!1,g[No]&&!0===g[No](m,S)&&(v=!0))}return v}_processChain(m,_callTeardown,"unload",(function(){}),S[Fo])||m[To](S)}function _updatePlugin(m,S){function _callUpdate(){var v=!1;if(g){var C=_getPluginState(g),_=g[ml]||C[ml];!g||_&&_!==m.core()||C[No]||g[Uo]&&!0===g[Uo](m,S)&&(v=!0)}return v}_processChain(m,_callUpdate,"update",(function(){}),!1)||m[To](S)}return ic(T)}var Dd=function(){function ProcessTelemetryContext2(g,m,S,v){var C=this,_=createProcessTelemetryContext(g,m,S,v);proxyFunctions(C,_,objKeys(_))}return ProcessTelemetryContext2}(),Od=500,Nd="Channel has invalid priority - ";function _addChannelQueue(g,m,S){m&&Zl(m)&&m[yo]>0&&(arrForEach(m=m.sort((function(g,m){return g[yl]-m[yl]})),(function(g){g[yl]<Od&&throwError(Nd+g[mo])})),g[fo]({queue:ic(m),chain:createTelemetryProxyChain(m,S[vo],S)}))}function createChannelControllerPlugin(g,m){function _getTelCtx(){return createProcessTelemetryContext(null,m[vo],m,null)}function _processChannelQueue(g,m,S,v){var C=g?g[yo]+1:1;function _runChainOnComplete(){0===--C&&(v&&v(),v=null)}C>0&&arrForEach(g,(function(g){if(g&&g.queue[yo]>0){var v=g.chain,_=m[$o](v);_[Po](_runChainOnComplete),S(_)}else C--})),_runChainOnComplete()}function _doUpdate(m,S){var v=S||{reason:0};return _processChannelQueue(g,m,(function(g){g[To](v)}),(function(){m[To](v)})),!0}function _doTeardown(m,v){var C=v||{reason:0,isAsync:!1};return _processChannelQueue(g,m,(function(g){g[To](C)}),(function(){m[To](C),S=!1})),!0}function _getChannel(m){var S=null;return g&&g[yo]>0&&arrForEach(g,(function(g){if(g&&g.queue[yo]>0&&(arrForEach(g.queue,(function(g){if(g[mo]===m)return S=g,-1})),S))return-1})),S}var S=!1;return{identifier:"ChannelControllerPlugin",priority:Od,initialize:function(m,v,C,_){S=!0,arrForEach(g,(function(g){g&&g.queue[yo]>0&&initializePlugins(createProcessTelemetryContext(g.chain,m,v),C)}))},isInitialized:function(){return S},processTelemetry:function(m,S){_processChannelQueue(g,S||_getTelCtx(),(function(g){g[To](m)}),(function(){S[To](m)}))},update:_doUpdate,pause:function(){_processChannelQueue(g,_getTelCtx(),(function(g){g.iterate((function(g){g.pause&&g.pause()}))}),null)},resume:function(){_processChannelQueue(g,_getTelCtx(),(function(g){g.iterate((function(g){g.resume&&g.resume()}))}),null)},teardown:_doTeardown,getChannel:_getChannel,flush:function(m,S,v,C){var _=1,E=!1,T=null;function doCallback(){_--,E&&0===_&&(T&&(clearTimeout(T),T=null),S&&S(E),S=null)}return C=C||5e3,_processChannelQueue(g,_getTelCtx(),(function(g){g.iterate((function(g){if(g[wo]){_++;var S=!1;g[wo](m,(function(){S=!0,doCallback()}),v)||S||(m&&null==T?T=setTimeout((function(){T=null,doCallback()}),C):doCallback())}}))}),(function(){E=!0,doCallback()})),!0},_setQueue:function(m){g=m}}}function createChannelQueues(g,m,S){var v=[];if(g&&arrForEach(g,(function(g){return _addChannelQueue(v,g,S)})),m){var C=[];arrForEach(m,(function(g){g[yl]>Od&&C[fo](g)})),_addChannelQueue(v,C,S)}return v}function createUnloadHandlerContainer(){var g=[];function _addHandler(m){m&&g[fo](m)}function _runHandlers(m,S){arrForEach(g,(function(g){try{g(m,S)}catch(g){_throwInternal(m[Bo](),2,73,"Unexpected error calling unload handler - "+dumpObj(g))}})),g=[]}return{add:_addHandler,run:_runHandlers}}var kd="getPlugin",Ld=function(){function BaseTelemetryPlugin2(){var g,m,S,v,C,_=this;function _getTelCtx(g){void 0===g&&(g=null);var v=g;if(!v){var C=m||createProcessTelemetryContext(null,{},_[ml]);v=S&&S[kd]?C[$o](null,S[kd]):C[$o](null,S)}return v}function _setDefaults(g,v,C){g&&setValue(g,vl,[],null,isNullOrUndefined),!C&&v&&(C=v[Io]()[Vo]());var E=S;S&&S[kd]&&(E=S[kd]()),_[ml]=v,m=createProcessTelemetryContext(C,g,v,E)}function _initDefaults(){g=!1,_[ml]=null,m=null,S=null,C=[],v=createUnloadHandlerContainer()}_initDefaults(),dynamicProto(BaseTelemetryPlugin2,_,(function(m){m[uo]=function(m,S,v,C){_setDefaults(m,S,C),g=!0},m[No]=function(g,_){var E,T=m[ml];if(T&&(!g||T===g[ml]())){var I,b=!1,A=g||createProcessTelemetryUnloadContext(null,T,S&&S[kd]?S[kd]():S),R=_||((E={reason:0})[Fo]=!1,E);return m[xo]&&!0===m[xo](A,R,_unloadCallback)?I=!0:_unloadCallback(),I}function _unloadCallback(){if(!b){b=!0,v.run(A,_);var g=C;C=[],arrForEach(g,(function(g){g.rm()})),!0===I&&A[To](R),_initDefaults()}}},m[Uo]=function(g,v){var C=m[ml];if(C&&(!g||C===g[ml]())){var _,E=!1,T=g||createProcessTelemetryUpdateContext(null,C,S&&S[kd]?S[kd]():S),I=v||{reason:0};return m._doUpdate&&!0===m._doUpdate(T,I,_updateCallback)?_=!0:_updateCallback(),_}function _updateCallback(){E||(E=!0,_setDefaults(T.getCfg(),T.core(),T[Vo]()))}},m._addHook=function(g){g&&(Zl(g)?C=C.concat(g):C[fo](g))},proxyFunctionAs(m,"_addUnloadCb",(function(){return v}),"add")})),_[Bo]=function(g){return _getTelCtx(g)[Bo]()},_[So]=function(){return g},_.setInitialized=function(m){g=m},_[Ho]=function(g){S=g},_[To]=function(g,m){m?m[To](g):S&&isFunction2(S[_l])&&S[_l](g,null)},_._getTelCtx=_getTelCtx}return BaseTelemetryPlugin2.__ieDyn=1,BaseTelemetryPlugin2}(),Fd=function(g){function TelemetryInitializerPlugin2(){var m,S,v=g.call(this)||this;function _initDefaults(){m=0,S=[]}return v.identifier="TelemetryInitializerPlugin",v.priority=199,_initDefaults(),dynamicProto(TelemetryInitializerPlugin2,v,(function(g,v){g.addTelemetryInitializer=function(g){var v={id:m++,fn:g};return S[fo](v),{remove:function(){arrForEach(S,(function(g,m){if(g.id===v.id)return S[Oo](m,1),-1}))}}},g[_l]=function(m,v){for(var C=!1,_=S[yo],E=0;E<_;++E){var T=S[E];if(T)try{if(!1===T.fn[Qo](null,[m])){C=!0;break}}catch(g){_throwInternal(v[Bo](),1,64,"One of telemetry initializers failed, telemetry item will not be sent: "+getExceptionName(g),{exception:dumpObj(g)},!0)}}C||g[To](m,v)},g[xo]=function(){_initDefaults()}})),v}return __extendsFn(TelemetryInitializerPlugin2,g),TelemetryInitializerPlugin2.__ieDyn=1,TelemetryInitializerPlugin2}(Ld),xd="Plugins must provide initialize method",Ud="_notificationManager",Vd="SDK is still unloading...",Bd="SDK is not initialized",Hd={loggingLevelConsole:1};function _createPerfManager(g,m){return new Lc(m)}function _validateExtensions(g,m,S){var v,C=[],_={};return arrForEach(S,(function(S){(isNullOrUndefined(S)||isNullOrUndefined(S[uo]))&&throwError(xd);var v=S[yl],E=S[mo];S&&v&&(isNullOrUndefined(_[v])?_[v]=E:_warnToConsole(g,"Two extensions have same priority #"+v+" - "+_[v]+", "+E)),(!v||v<m)&&C[fo](S)})),(v={all:S})[ml]=C,v}function _isPluginPresent(g,m){var S=!1;return arrForEach(m,(function(m){if(m===g)return S=!0,-1})),S}function _createDummyNotificationManager(){var g;return objCreateFn(((g={})[bo]=function(g){},g[Ao]=function(g){},g[El]=function(g){},g[Tl]=function(g,m){},g[Il]=function(g,m){},g))}var $d=function(){function BaseCore2(){var g,m,S,v,C,_,E,T,I,b,A,R,P,M,w,D,O,N,k,L,F=0;dynamicProto(BaseCore2,this,(function(x){function _initDefaults(){m=!1,g=objExtend(!0,{},Hd),x[vo]=g,x[_o]=new Mc(g),x[Do]=[],w=new Fd,S=[],v=null,C=null,_=null,E=null,T=null,b=null,I=[],A=null,R=null,P=null,M=!1,D=null,O=createUniqueNamespace("AIBaseCore",!0),N=createUnloadHandlerContainer(),L=null}function _createTelCtx(){return createProcessTelemetryContext(_getPluginChain(),g,x)}function _initPluginChain(m){var S=_validateExtensions(x[_o],Od,I);b=S[ml],T=null;var v=S.all;if(P=ic(createChannelQueues(R,v,x)),A){var C=arrIndexOf(v,A);-1!==C&&v[Oo](C,1),-1!==(C=arrIndexOf(b,A))&&b[Oo](C,1),A._setQueue(P)}else A=createChannelControllerPlugin(P,x);v[fo](A),b[fo](A),x[Do]=sortPlugins(v),A[uo](g,x,v),initializePlugins(_createTelCtx(),v),x[Do]=ic(sortPlugins(b||[])).slice(),m&&_doUpdate(m)}function _getPlugin(g){var m,S=null,v=null;return arrForEach(x[Do],(function(m){if(m[mo]===g&&m!==A&&m!==w)return v=m,-1})),!v&&A&&(v=A.getChannel(g)),v&&((m={plugin:v})[Ko]=function(g){_getPluginState(v)[Sl]=!g},m.isEnabled=function(){var g=_getPluginState(v);return!g[No]&&!g[Sl]},m.remove=function(g,m){var S;void 0===g&&(g=!0);var C=[v],_=((S={reason:1})[Fo]=g,S);_removePlugins(C,_,(function(g){g&&_initPluginChain({reason:32,removed:C}),m&&m(g)}))},S=m),S}function _getPluginChain(){if(!T){var m=(b||[]).slice();-1===arrIndexOf(m,w)&&m[fo](w),T=createTelemetryProxyChain(sortPlugins(m),g,x)}return T}function _removePlugins(m,S,v){if(m&&m[yo]>0){var C=createProcessTelemetryUnloadContext(createTelemetryProxyChain(m,g,x),x);C[Po]((function(){var g=!1,S=[];arrForEach(I,(function(v,C){_isPluginPresent(v,m)?g=!0:S[fo](v)})),I=S;var C=[];R&&(arrForEach(R,(function(S,v){var _=[];arrForEach(S,(function(S){_isPluginPresent(S,m)?g=!0:_[fo](S)})),C[fo](_)})),R=C),v&&v(g)})),C[To](S)}else v(!1)}function _flushInternalLogs(){var m=x[_o]?x[_o].queue:[];m&&(arrForEach(m,(function(m){var S,v=((S={})[go]=D||"InternalMessageId: "+m[ko],S.iKey=getCfgValue(g[Co]),S.time=toISOString(new Date),S.baseType=Pc.dataType,S.baseData={message:m[Lo]},S);x.track(v)})),m[yo]=0)}function _flushChannels(g,m,S,v){return A?A[wo](g,m,S||6,v):(m&&m(!1),!0)}function _initDebugListener(){var m=getCfgValue(g.disableDbgExt);!0===m&&k&&(v[Ao](k),k=null),v&&!k&&!0!==m&&(k=getDebugListener(g),v[bo](k))}function _initPerfManager(){var m=getCfgValue(g.enablePerfMgr);!m&&_&&(_=null),m&&getSetValue(g,fl,_createPerfManager)}function _initExtConfig(){getSetValue(g,vl,{}).NotificationManager=v}function _doUpdate(g){var m=createProcessTelemetryUpdateContext(_getPluginChain(),x);x._updateHook&&!0===x._updateHook(m,g)||m[To](g)}function _logOrThrowError(g){var m=x[_o];m?_throwInternal(m,2,73,g):throwError(g)}_initDefaults(),x[So]=function(){return m},x[uo]=function(S,C,_,E){M&&throwError(Vd),x[So]()&&throwError("Core should not be initialized more than once"),g=S||{},x[vo]=g,isNullOrUndefined(S[Co])&&throwError("Please provide instrumentation key"),v=E,x[Ud]=E,_initDebugListener(),_initPerfManager(),_initExtConfig(),_&&(x[_o]=_);var T=getSetValue(g,Cl,[]);(I=[])[fo].apply(I,__spreadArrayFn(__spreadArrayFn([],C,!1),T)),R=getSetValue(g,pl,[]),_initPluginChain(null),P&&0!==P[yo]||throwError("No "+pl+" available"),m=!0,x.releaseQueue()},x.getTransmissionControls=function(){var g=[];return P&&arrForEach(P,(function(m){g[fo](m.queue)})),ic(g)},x.track=function(m){m.iKey=m.iKey||g[Co],m[Eo]=m[Eo]||toISOString(new Date),m.ver=m.ver||"4.0",!M&&x[So]()?_createTelCtx()[To](m):S[fo](m)},x[Io]=_createTelCtx,x[po]=function(){return v||(v=_createDummyNotificationManager(),x[Ud]=v),v},x[bo]=function(g){v&&v[bo](g)},x[Ao]=function(g){v&&v[Ao](g)},x.getCookieMgr=function(){return E||(E=createCookieMgr(g,x[_o])),E},x.setCookieMgr=function(g){E=g},x[Pl]=function(){if(!C&&!_&&getCfgValue(g.enablePerfMgr)){var m=getCfgValue(g[fl]);isFunction2(m)&&(_=m(x,x[po]()))}return C||_||getGblPerfMgr()},x.setPerfMgr=function(g){C=g},x.eventCnt=function(){return S[yo]},x.releaseQueue=function(){if(m&&S[yo]>0){var g=S;S=[],arrForEach(g,(function(g){_createTelCtx()[To](g)}))}},x.pollInternalLogs=function(m){D=m||null;var S=getCfgValue(g.diagnosticLogInterval);return S&&S>0||(S=1e4),F&&clearInterval(F),F=setInterval((function(){_flushInternalLogs()}),S)},x[Ro]=function(){F&&(clearInterval(F),F=0,_flushInternalLogs())},proxyFunctions(x,(function(){return w}),["addTelemetryInitializer"]),x.unload=function(g,S,v){var C;void 0===g&&(g=!0),m||throwError(Bd),M&&throwError(Vd);var _=((C={reason:50})[Fo]=g,C.flushComplete=!1,C),E=createProcessTelemetryUnloadContext(_getPluginChain(),x);function _doUnload(g){_.flushComplete=g,M=!0,N.run(E,_),x[Ro](),E[To](_)}E[Po]((function(){_initDefaults(),S&&S(_)}),x),_flushChannels(g,_doUnload,6,v)||_doUnload(!1)},x[Mo]=_getPlugin,x.addPlugin=function(g,m,S,v){if(!g)return v&&v(!1),void _logOrThrowError(xd);var C=_getPlugin(g[mo]);if(C&&!m)return v&&v(!1),void _logOrThrowError("Plugin ["+g[mo]+"] is already loaded!");var _={reason:16};function _addPlugin(m){I[fo](g),_.added=[g],_initPluginChain(_),v&&v(!0)}if(C){var E=[C.plugin];_removePlugins(E,{reason:2,isAsync:!!S},(function(g){g?(_.removed=E,_.reason|=32,_addPlugin()):v&&v(!1)}))}else _addPlugin()},x.evtNamespace=function(){return O},x[wo]=_flushChannels,x.getTraceCtx=function(g){return L||(L=createDistributedTraceContext()),L},x.setTraceCtx=function(g){L=g||null},proxyFunctionAs(x,"addUnloadCb",(function(){return N}),"add")}))}return BaseCore2.__ieDyn=1,BaseCore2}();function _runListeners(g,m,S,v){arrForEach(g,(function(g){if(g&&g[m])if(S)setTimeout((function(){return v(g)}),0);else try{v(g)}catch(g){}}))}var Gd,jd,qd=function(){function NotificationManager2(g){this.listeners=[];var m=!!(g||{}).perfEvtsSendAll;dynamicProto(NotificationManager2,this,(function(g){g[bo]=function(m){g.listeners[fo](m)},g[Ao]=function(m){for(var S=arrIndexOf(g[sl],m);S>-1;)g.listeners[Oo](S,1),S=arrIndexOf(g[sl],m)},g[El]=function(m){_runListeners(g[sl],El,!0,(function(g){g[El](m)}))},g[Tl]=function(m,S){_runListeners(g[sl],Tl,!0,(function(g){g[Tl](m,S)}))},g[Il]=function(m,S){_runListeners(g[sl],Il,S,(function(g){g[Il](m,S)}))},g[bl]=function(S){S&&(!m&&S[al]()||_runListeners(g[sl],bl,!1,(function(g){S[Fo]?setTimeout((function(){return g[bl](S)}),0):g[bl](S)})))}}))}return NotificationManager2.__ieDyn=1,NotificationManager2}(),Wd=function(g){function AppInsightsCore3(){var m=g.call(this)||this;return dynamicProto(AppInsightsCore3,m,(function(g,m){function _validateTelemetryItem(g){isNullOrUndefined(g[go])&&(_notifyInvalidEvent(g),throwError("telemetry name required"))}function _notifyInvalidEvent(m){var S=g[po]();S&&S[Tl]([m],2)}g[uo]=function(g,S,v,C){m[uo](g,S,v||new Mc(g),C||new qd(g))},g.track=function(S){doPerf(g[Pl](),(function(){return"AppInsightsCore:track"}),(function(){null===S&&(_notifyInvalidEvent(S),throwError("Invalid telemetry item")),_validateTelemetryItem(S),m.track(S)}),(function(){return{item:S}}),!S.sync)}})),m}return __extendsFn(AppInsightsCore3,g),AppInsightsCore3.__ieDyn=1,AppInsightsCore3}($d),zd="Failed",Kd=zd+"MonitorAjax",Jd="Track",Yd="Start",Qd="Stop",Xd="Event",Zd="AuthContext",eh="Exception",th="Local",ih="Session",nh="Storage",rh="Browser",sh="Cannot",ah="Buffer",oh="InstrumentationKey",lh=(createEnumStyle({CRITICAL:1,WARNING:2}),createEnumStyle(((Gd={})[rh+"DoesNotSupport"+th+nh]=0,Gd[rh+sh+"Read"+th+nh]=1,Gd[rh+sh+"Read"+ih+nh]=2,Gd[rh+sh+"Write"+th+nh]=3,Gd[rh+sh+"Write"+ih+nh]=4,Gd[rh+zd+"RemovalFrom"+th+nh]=5,Gd[rh+zd+"RemovalFrom"+ih+nh]=6,Gd[sh+"SendEmptyTelemetry"]=7,Gd.ClientPerformanceMathError=8,Gd["ErrorParsingAI"+ih+"Cookie"]=9,Gd.ErrorPVCalc=10,Gd[eh+"WhileLoggingError"]=11,Gd[zd+"AddingTelemetryTo"+ah]=12,Gd[Kd+"Abort"]=13,Gd[Kd+"Dur"]=14,Gd[Kd+"Open"]=15,Gd[Kd+"RSC"]=16,Gd[Kd+"Send"]=17,Gd[Kd+"GetCorrelationHeader"]=18,Gd[zd+"ToAddHandlerForOnBeforeUnload"]=19,Gd[zd+"ToSendQueuedTelemetry"]=20,Gd[zd+"ToReportDataLoss"]=21,Gd["Flush"+zd]=22,Gd.MessageLimitPerPVExceeded=23,Gd.MissingRequiredFieldSpecification=24,Gd.NavigationTimingNotSupported=25,Gd.OnError=26,Gd[ih+"RenewalDateIsZero"]=27,Gd.SenderNotInitialized=28,Gd[Yd+Jd+Xd+zd]=29,Gd[Qd+Jd+Xd+zd]=30,Gd[Yd+Jd+zd]=31,Gd[Qd+Jd+zd]=32,Gd.TelemetrySampledAndNotSent=33,Gd[Jd+Xd+zd]=34,Gd[Jd+eh+zd]=35,Gd[Jd+"Metric"+zd]=36,Gd[Jd+"PV"+zd]=37,Gd[Jd+"PV"+zd+"Calc"]=38,Gd[Jd+"Trace"+zd]=39,Gd["Transmission"+zd]=40,Gd[zd+"ToSet"+nh+ah]=41,Gd[zd+"ToRestore"+nh+ah]=42,Gd.InvalidBackendResponse=43,Gd[zd+"ToFixDepricatedValues"]=44,Gd.InvalidDurationValue=45,Gd.TelemetryEnvelopeInvalid=46,Gd.CreateEnvelopeError=47,Gd[sh+"SerializeObject"]=48,Gd[sh+"SerializeObjectNonSerializable"]=49,Gd.CircularReferenceDetected=50,Gd["Clear"+Zd+zd]=51,Gd[eh+"Truncated"]=52,Gd.IllegalCharsInName=53,Gd.ItemNotInArray=54,Gd.MaxAjaxPerPVExceeded=55,Gd.MessageTruncated=56,Gd.NameTooLong=57,Gd.SampleRateOutOfRange=58,Gd["Set"+Zd+zd]=59,Gd["Set"+Zd+zd+"AccountName"]=60,Gd.StringValueTooLong=61,Gd.StartCalledMoreThanOnce=62,Gd.StopCalledWithoutStart=63,Gd["TelemetryInitializer"+zd]=64,Gd.TrackArgumentsNotSpecified=65,Gd.UrlTooLong=66,Gd[ih+nh+ah+"Full"]=67,Gd[sh+"AccessCookie"]=68,Gd.IdTooLong=69,Gd.InvalidEvent=70,Gd[Kd+"SetRequestHeader"]=71,Gd["Send"+rh+"InfoOnUserInit"]=72,Gd["Plugin"+eh]=73,Gd["Notification"+eh]=74,Gd.SnippetScriptLoadFailure=99,Gd["Invalid"+oh]=100,Gd[sh+"ParseAiBlobValue"]=101,Gd.InvalidContentBlob=102,Gd[Jd+"PageAction"+Xd+zd]=103,Gd[zd+"AddingCustomDefinedRequestContext"]=104,Gd["InMemory"+nh+ah+"Full"]=105,Gd[oh+"Deprecation"]=106,Gd))),ch=(createEnumStyle({NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32}),createEnumStyle({Normal:1,CostDeferred:2,RealTime:3,Immediate:4})),dh=(createEnumStyle({Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9}),createEnumStyle({Normal:1,Critical:2})),hh=(createEnumStyle({NONE:0,ERROR:1,WARNING:2,INFORMATION:3}),ic(Ha(Ha({},lh),createEnumStyle({AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}))),""),uh="https://browser.events.data.microsoft.com/OneCollector/1.0/",gh="version",ph="properties",mh="1DS-Web-JS-"+"3.2.9",fh="Microsoft_ApplicationInsights_BypassAjaxInstrumentation",Sh="withCredentials",vh="timeout",Ch=((jd={})[0]=0,jd[2]=6,jd[1]=1,jd[3]=7,jd[4098]=6,jd[4097]=1,jd[4099]=7,jd);Boolean(getDocument()),Boolean(getWindow());function isValueAssigned(g){return!(g===hh||isNullOrUndefined(g))}function getTenantId(g){if(g){var m=g.indexOf("-");if(m>-1)return g.substring(0,m)}return hh}function isLatency(g){return!!(g&&isNumber3(g)&&g>=1&&g<=4)}function sanitizeProperty(g,m,S){if(!m&&!isValueAssigned(m)||"string"!=typeof g)return null;var v=typeof m;if("string"===v||"number"===v||"boolean"===v||Zl(m))m={value:m};else if("object"!==v||Ua.call(m,"value")){if(isNullOrUndefined(m.value)||m.value===hh||!isString2(m.value)&&!isNumber3(m.value)&&!isBoolean2(m.value)&&!Zl(m.value))return null}else m={value:S?JSON.stringify(m):m};if(Zl(m.value)&&!isArrayValid(m.value))return null;if(!isNullOrUndefined(m.kind)){if(Zl(m.value)||!isValueKind(m.kind))return null;m.value=m.value.toString()}return m}function getCommonSchemaMetaData(g,m,S){var v=-1;if(!isUndefined3(g))if(m>0&&(32===m?v=8192:m<=13&&(v=m<<5)),isDataType(S))-1===v&&(v=0),v|=S;else{var C=Ch[getFieldValueType(g)]||-1;-1!==v&&-1!==C?v|=C:6===C&&(v=C)}return v}function getCookieValue(g,m,S){var v;return void 0===S&&(S=!0),g&&(v=g.get(m),S&&v&&decodeURIComponent&&(v=decodeURIComponent(v))),v||hh}function createGuid(g){void 0===g&&(g="D");var m=newGuid2();return"B"===g?m="{"+m+"}":"P"===g?m="("+m+")":"N"===g&&(m=m.replace(/-/g,hh)),m}function extend(g,m,S,v,C){var _={},E=!1,T=0,I=arguments.length,b=arguments;for("[object Boolean]"===Object[Da].toString.call(b[0])&&(E=b[0],T++);T<I;T++){objForEachKey(b[T],(function(g,m){E&&m&&isObject3(m)?Zl(m)?(_[g]=_[g]||[],arrForEach(m,(function(m,S){m&&isObject3(m)?_[g][S]=extend(!0,_[g][S],m):_[g][S]=m}))):_[g]=extend(!0,_[g],m):_[g]=m}))}return _}var _h=perfNow;function isValueKind(g){return 0===g||g>0&&g<=13||32===g}function isDataType(g){return g>=0&&g<=9}function isArrayValid(g){return g.length>0}function setProcessTelemetryTimings(g,m){var S=g;S.timings=S.timings||{},S.timings.processTelemetryStart=S.timings.processTelemetryStart||{},S.timings.processTelemetryStart[m]=_h()}function getFieldValueType(g){var m=0;if(null!=g){var S=typeof g;"string"===S?m=1:"number"===S?m=2:"boolean"===S?m=3:S===Ma&&(m=4,Zl(g)?(m=4096,g.length>0&&(m|=getFieldValueType(g[0]))):Ua.call(g,"value")&&(m=8192|getFieldValueType(g.value)))}return m}function isChromium(){return!!getGlobalInst("chrome")}function openXhr(g,m,S,v,C,_){function _wrapSetXhrProp(g,m,S){try{g[m]=S}catch(g){}}void 0===v&&(v=!1),void 0===C&&(C=!1);var E=new XMLHttpRequest;return v&&_wrapSetXhrProp(E,fh,v),S&&_wrapSetXhrProp(E,Sh,S),E.open(g,m,!C),S&&_wrapSetXhrProp(E,Sh,S),!C&&_&&_wrapSetXhrProp(E,vh,_),E}var yh=function(g){function AppInsightsCore3(){var m=g.call(this)||this;return m.pluginVersionStringArr=[],dynamicProto(AppInsightsCore3,m,(function(g,m){g.logger&&g.logger.queue||(g.logger=new Mc({loggingLevelConsole:1})),g.initialize=function(S,v,C,_){doPerf(g,(function(){return"AppInsightsCore.initialize"}),(function(){var E=g.pluginVersionStringArr;if(S){S.endpointUrl||(S.endpointUrl=uh);var T=S.propertyStorageOverride;!T||T.getProperty&&T.setProperty||throwError("Invalid property storage override passed."),S.channels&&arrForEach(S.channels,(function(g){g&&arrForEach(g,(function(g){if(g.identifier&&g.version){var m=g.identifier+"="+g.version;E.push(m)}}))}))}g.getWParam=function(){return"undefined"!=typeof document||S.enableWParam?0:-1},v&&arrForEach(v,(function(g){if(g&&g.identifier&&g.version){var m=g.identifier+"="+g.version;E.push(m)}})),g.pluginVersionString=E.join(";"),g.pluginVersionStringArr=E;try{m.initialize(S,v,C,_),g.pollInternalLogs("InternalLog")}catch(m){var I=g.logger,b=dumpObj(m);-1!==b.indexOf("channels")&&(b+="\n - Channels must be provided through config.channels only!"),_throwInternal(I,1,514,"SDK Initialization Failed - no telemetry will be sent: "+b)}}),(function(){return{config:S,extensions:v,logger:C,notificationManager:_}}))},g.track=function(S){doPerf(g,(function(){return"AppInsightsCore.track"}),(function(){var v=S;if(v){v.timings=v.timings||{},v.timings.trackStart=_h(),isLatency(v.latency)||(v.latency=1);var C=v.ext=v.ext||{};C.sdk=C.sdk||{},C.sdk.ver=mh;var _=v.baseData=v.baseData||{};_[ph]=_[ph]||{};var E=_[ph];E[gh]=E[gh]||g.pluginVersionString||hh}m.track(v)}),(function(){return{item:S}}),!S.sync)}})),m}return __extendsFn(AppInsightsCore3,g),AppInsightsCore3.__ieDyn=1,AppInsightsCore3}(Wd),Eh=yh,Th=isFunction2;function _createPromiseAllOnResolvedFunction(g,m,S){return function(v){g[m]=v,S()}}var Ih=function(){function ESPromise2(g){var m=0,S=null,v=[];function _enqueue(g,C,_,E){v.push((function(){var v;try{(v=1===m?Th(g)?g(S):S:Th(C)?C(S):S)instanceof ESPromise2?v.then(_,E):2!==m||Th(C)?_(v):E(v)}catch(g){return void E(g)}})),0!==m&&_processQueue()}function _processQueue(){if(v.length>0){var g=v.slice();v=[],setTimeout((function(){for(var m=0,S=g.length;m<S;++m)try{g[m]()}catch(g){}}),0)}}function _resolve(g){0===m&&(S=g,m=1,_processQueue())}function _reject(g){0===m&&(S=g,m=2,_processQueue())}dynamicProto(ESPromise2,this,(function(g){g.then=function(g,m){return new ESPromise2((function(S,v){_enqueue(g,m,S,v)}))},g.catch=function(m){return g.then(null,m)}})),function _initialize(){if(!Th(g))throw new TypeError("ESPromise: resolvedFunc argument is not a Function");try{g(_resolve,_reject)}catch(g){_reject(g)}}()}return ESPromise2.resolve=function(g){return g instanceof ESPromise2?g:g&&Th(g.then)?new ESPromise2((function(m,S){try{g.then(m,S)}catch(g){S(g)}})):new ESPromise2((function(m){m(g)}))},ESPromise2.reject=function(g){return new ESPromise2((function(m,S){S(g)}))},ESPromise2.all=function(g){if(g&&g.length)return new ESPromise2((function(m,S){try{for(var v=[],C=0,_=0;_<g.length;_++){var E=g[_];E&&Th(E.then)?(C++,E.then(_createPromiseAllOnResolvedFunction(v,_,(function(){0==--C&&m(v)})),S)):v[_]=E}0===C&&setTimeout((function(){m(v)}),0)}catch(g){S(g)}}))},ESPromise2.race=function(g){return new ESPromise2((function(m,S){if(g&&g.length)try{for(var _loop_1=function(v){var C=g[v];C&&Th(C.then)?C.then(m,S):setTimeout((function(){m(C)}),0)},v=0;v<g.length;v++)_loop_1(v)}catch(g){S(g)}}))},ESPromise2}(),bh=Ih,Ah=6e5,Rh=0,Ph=[],Mh=[],wh=[];function _getTime(){return(new Date).getTime()}var Dh,Oh=function(){function ESPromiseScheduler2(g,m){var S=0,v=(g||"<unnamed>")+"."+Rh;function _debugLog2(g){var m=getGlobal();m&&m.QUnit&&console&&console.log("ESPromiseScheduler["+v+"] "+g)}function _warnLog2(g){_warnToConsole(m,"ESPromiseScheduler["+v+"] "+g)}Rh++,dynamicProto(ESPromiseScheduler2,this,(function(g){var m=null,C=0;function _removeQueuedEvent(g,m){for(var S=0;S<g.length;S++)if(g[S].id===m)return g.splice(S,1)[0];return null}g.scheduleEvent=function(g,_,E){var T=v+"."+C;C++,_&&(T+="-("+_+")");var I=T+"{"+S+"}";S++;var b={evt:null,tm:_getTime(),id:I,isRunning:!1,isAborted:!1};return b.evt=m?_waitForPreviousEvent(b,m):_startWaitingEvent(b),(m=b).evt._schId=I,b.evt;function _abortAndRemoveOldEvents(g){for(var m=_getTime(),S=m-Ah,v=g.length,C=0;C<v;){var _=g[C];if(_&&_.tm<S){var E=null;_.abort?(E="Aborting ["+_.id+"] due to Excessive runtime ("+(m-_.tm)+" ms)",_.abort(E)):E="Removing ["+_.id+"] due to Excessive runtime ("+(m-_.tm)+" ms)",_warnLog2(E),g.splice(C,1),v--}else C++}}function _cleanup(g,S){var v=!1,C=_removeQueuedEvent(Ph,g);if(C||(C=_removeQueuedEvent(wh,g),v=!0),C){C.to&&(clearTimeout(C.to),C.to=null);var _=_getTime()-C.tm;S?v?_warnLog2("Timed out event ["+g+"] finally complete -- "+_+" ms"):_debugLog2("Promise ["+g+"] Complete -- "+_+" ms"):(wh.push(C),_warnLog2("Event ["+g+"] Timed out and removed -- "+_+" ms"))}else _debugLog2("Failed to remove ["+g+"] from running queue");m&&m.id===g&&(m=null),_abortAndRemoveOldEvents(Ph),_abortAndRemoveOldEvents(Mh),_abortAndRemoveOldEvents(wh)}function _removeScheduledEvent(g,m){return function(S){return _cleanup(g,!0),m&&m(S),S}}function _waitForFinalResult(g,m,S,v){m.then((function(m){return m instanceof bh?(_debugLog2("Event ["+g+"] returned a promise -- waiting"),_waitForFinalResult(g,m,S,v),m):_removeScheduledEvent(g,S)(m)}),_removeScheduledEvent(g,v))}function _createScheduledEvent(g,m){var S=g.id;return new bh((function(v,C){_debugLog2("Event ["+S+"] Starting -- waited for "+(g.wTm||"--")+" ms"),g.isRunning=!0,g.abort=function(m){g.abort=null,g.isAborted=!0,_cleanup(S,!1),C(new Error(m))};var _=m(S);_ instanceof bh?(E&&(g.to=setTimeout((function(){_cleanup(S,!1),C(new Error("Timed out after ["+E+"] ms"))}),E)),_waitForFinalResult(S,_,(function(m){_debugLog2("Event ["+S+"] Resolving after "+(_getTime()-g.tm)+" ms"),v(m)}),C)):(_debugLog2("Promise ["+S+"] Auto completed as the start action did not return a promise"),v())}))}function _startWaitingEvent(m){var S=_getTime();return m.wTm=S-m.tm,m.tm=S,m.isAborted?bh.reject(new Error("["+T+"] was aborted")):(Ph.push(m),_createScheduledEvent(m,g))}function _waitForPreviousEvent(g,m){var S=new bh((function(S,v){var C=_getTime()-m.tm,_=m.id;_debugLog2("["+T+"] is waiting for ["+_+":"+C+" ms] to complete before starting -- ["+Mh.length+"] waiting and ["+Ph.length+"] running"),g.abort=function(m){g.abort=null,_removeQueuedEvent(Mh,T),g.isAborted=!0,v(new Error(m))},m.evt.then((function(m){_removeQueuedEvent(Mh,T),_startWaitingEvent(g).then(S,v)}),(function(m){_removeQueuedEvent(Mh,T),_startWaitingEvent(g).then(S,v)}))}));return Mh.push(g),S}}}))}return ESPromiseScheduler2.incomplete=function(){return Ph},ESPromiseScheduler2.waitingToStart=function(){return Mh},ESPromiseScheduler2}(),Nh="locale",kh="ver",Lh="browser",Fh="browserVer",xh="popSample",Uh="eventFlags",Vh="name",Bh="serviceName",Hh=createValueMap({UserExt:[0,"user"],DeviceExt:[1,"device"],TraceExt:[2,"trace"],WebExt:[3,"web"],AppExt:[4,"app"],OSExt:[5,"os"],SdkExt:[6,"sdk"],IntWebExt:[7,"intweb"],UtcExt:[8,"utc"],LocExt:[9,"loc"],CloudExt:[10,"cloud"],DtExt:[11,"dt"]}),$h=createValueMap({id:[0,"id"],ver:[1,kh],appName:[2,Vh],locale:[3,Nh],expId:[4,"expId"],env:[5,"env"]}),Gh=createValueMap({domain:[0,"domain"],browser:[1,Lh],browserVer:[2,Fh],screenRes:[3,"screenRes"],userConsent:[4,"userConsent"],consentDetails:[5,"consentDetails"]}),jh=createValueMap({locale:[0,Nh],localId:[1,"localId"],id:[2,"id"]}),qh=createValueMap({osName:[0,Vh],ver:[1,kh]}),Wh=createValueMap({ver:[0,kh],seq:[1,"seq"],installId:[2,"installId"],epoch:[3,"epoch"]}),zh=createValueMap({msfpc:[0,"msfpc"],anid:[1,"anid"],serviceName:[2,Bh]}),Kh=createValueMap({popSample:[0,xh],eventFlags:[1,Uh]}),Jh=createValueMap({tz:[0,"tz"]}),Yh=createValueMap({sessionId:[0,"sesId"]}),Qh=createValueMap({localId:[0,"localId"],deviceClass:[1,"deviceClass"],make:[2,"make"],model:[3,"model"]}),Xh=createValueMap({role:[0,"role"],roleInstance:[1,"roleInstance"],roleVer:[2,"roleVer"]}),Zh=createValueMap({traceId:[0,"traceID"],traceName:[1,Vh],parentId:[2,"parentID"]}),eu=createValueMap({traceId:[0,"traceId"],spanId:[1,"spanId"],traceFlags:[2,"traceFlags"]});function canUseLocalStorage(){return void 0===Dh&&(Dh=!!_getVerifiedStorageObject(0)),Dh}function _getLocalStorageObject(){return canUseLocalStorage()?_getVerifiedStorageObject(0):null}function _getVerifiedStorageObject(g){var m,S,v=null;try{var C=getGlobal();if(!C)return null;S=new Date,(v=0===g?C.localStorage:C.sessionStorage)&&isFunction2(v.setItem)&&(v.setItem(S,S),m=v.getItem(S)!==S,v.removeItem(S),m&&(v=null))}catch(g){v=null}return v}function setStorage(g,m,S){var v=_getLocalStorageObject();if(null!==v)try{return v.setItem(m,S),!0}catch(m){Dh=!1,_throwInternal(g,1,504,"Browser failed write to local storage. "+m)}return!1}function getStorage(g,m){var S=_getLocalStorageObject();if(null!==S)try{return S.getItem(m)}catch(m){Dh=!1,_throwInternal(g,1,503,"Browser failed read of local storage. "+m)}return null}function _getId(){return this.getId()}function _setId(g){this.setId(g)}var tu=function(){function Session3(){dynamicProto(Session3,this,(function(g){g.setId=function(m){g.customId=m},g.getId=function(){return isString2(g.customId)?g.customId:g.automaticId}}))}return Session3._staticInit=void objDefineAccessors(Session3.prototype,"id",_getId,_setId),Session3}(),iu="ai_session",nu=function(){function SessionManager2(g,m){var S,v,C=safeGetLogger(g),_=safeGetCookieMgr(g);dynamicProto(SessionManager2,this,(function(g){var E=getDefaultConfig(m);function getDefaultConfig(g){return{sessionRenewalMs:g.sessionRenewalMs&&function(){return g.sessionRenewalMs},sessionExpirationMs:g.sessionExpirationMs&&function(){return g.sessionExpirationMs},cookieDomain:g.cookieDomain&&function(){return g.cookieDomain},namePrefix:g.namePrefix&&function(){return g.namePrefix},sessionAsGuid:function(){return g.sessionAsGuid},idLength:function(){return g.idLength?g.idLength:22}}}function _initializeAutomaticSession(){var m=_.get(v());if(m&&isFunction2(m.split))_initializeAutomaticSessionWithData(m);else{var S=getStorage(C,v());S&&_initializeAutomaticSessionWithData(S)}g.automaticSession.getId()||_renew()}function _initializeAutomaticSessionWithData(m){var S=g.automaticSession,v=m.split("|");v.length>0&&S.setId(v[0]);try{if(v.length>1){var _=+v[1];S.acquisitionDate=+new Date(_),S.acquisitionDate=S.acquisitionDate>0?S.acquisitionDate:0}if(v.length>2){var E=+v[2];S.renewalDate=+new Date(E),S.renewalDate=S.renewalDate>0?S.renewalDate:0}}catch(g){_throwInternal(C,1,510,"Error parsing ai_session cookie, session will be reset: "+g)}0===S.renewalDate&&_throwInternal(C,2,517,"AI session renewal date is 0, session will be reset.")}function _renew(){var m=g.automaticSession,S=(new Date).getTime(),v=g.config.sessionAsGuid();!isUndefined3(v)&&v?isBoolean2(v)?m.setId(createGuid()):m.setId(createGuid(v)):m.setId(newId(E&&E.idLength?E.idLength():22)),m.acquisitionDate=S,m.renewalDate=S,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate),canUseLocalStorage()||_throwInternal(C,2,505,"Browser does not support local storage. Session durations will be inaccurate.")}function _setCookie(m,C,E){var T=C+g.config.sessionExpirationMs(),I=E+g.config.sessionRenewalMs(),b=new Date,A=[m,C,E];T<I?b.setTime(T):b.setTime(I);var R=g.config.cookieDomain?g.config.cookieDomain():null;_.set(v(),A.join("|")+";expires="+b.toUTCString(),null,R),S=(new Date).getTime()}function _setStorage(g,m,S){setStorage(C,v(),[g,m,S].join("|"))}isFunction2(m.sessionExpirationMs)||(E.sessionExpirationMs=function(){return SessionManager2.acquisitionSpan}),isFunction2(m.sessionRenewalMs)||(E.sessionRenewalMs=function(){return SessionManager2.renewalSpan}),g.config=E,v=function(){return g.config.namePrefix&&g.config.namePrefix()?iu+g.config.namePrefix():iu},g.automaticSession=new tu,g.update=function(){g.automaticSession.getId()||_initializeAutomaticSession();var m=g.automaticSession,v=g.config,C=(new Date).getTime(),_=C-m.acquisitionDate>v.sessionExpirationMs(),E=C-m.renewalDate>v.sessionRenewalMs();if(_||E)_renew();else{(!S||C-S>SessionManager2.cookieUpdateInterval)&&(m.renewalDate=C,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate))}},g.backup=function(){var m=g.automaticSession;_setStorage(m.getId(),m.acquisitionDate,m.renewalDate)}}))}return SessionManager2.acquisitionSpan=864e5,SessionManager2.renewalSpan=18e5,SessionManager2.cookieUpdateInterval=6e4,SessionManager2}(),ru=["AX","EX","SF","CS","CF","CT","CU","DC","DF","H5","HL","WS","WP"];function _validateAppExpId(g,m){void 0===m&&(m=ru);var S=null;if(g)for(var v=g.split(","),C=0;C<v.length;C++)_isValidAppFlightId(v[C],m)&&(S?S+=","+v[C]:S=v[C]);return S}function _isValidAppFlightId(g,m){if(void 0===m&&(m=ru),!g||g.length<4)return!1;for(var S=!1,v=256,C=g.substring(0,3).toString().toUpperCase(),_=0;_<m.length;_++)if(m[_]+":"===C&&g.length<=v){S=!0;break}return S}function _getExpId(){return this.getExpId()}var su=function(){function Application2(g,m){var S=null,v=ru.slice(0),C="Treatments",_=safeGetCookieMgr(m),E=g;dynamicProto(Application2,this,(function(m){if(hasDocument()){var T=getDocument().documentElement;T&&(m.locale=T.lang)}function _getMetaDataFromDOM(g){var m,S={},v=getDocument();if(v){m=v&&v.querySelectorAll("meta");for(var C=0;C<m.length;C++){var _=m[C];if(_.name)if(0===_.name.toLowerCase().indexOf(g))S[_.name.replace(g,"")]=_.content}}return S}function _setAppExpId(g){g!==S&&(S=_validateAppExpId(g,v))}function _readExpIdFromCookie(){return _setAppExpId(getCookieValue(_,C)),S}function _readExpIdFromCoreData(g){return _setAppExpId(g),S}m.env=g.env?g.env:_getMetaDataFromDOM("awa-").env,m.getExpId=function(){return E.expId?_readExpIdFromCoreData(E.expId):_readExpIdFromCookie()}}))}return Application2.validateAppExpId=_validateAppExpId,Application2._staticInit=void objDefineAccessors(Application2.prototype,"expId",_getExpId),Application2}(),au=function(){function Cloud2(){}return Cloud2}(),ou=function(){function Device3(){}return Device3}();function _getMsfpc(){return this.getMsfpc()}function _getAnid(){return this.getAnid()}var lu=function(){function IntWeb2(g,m){var S=safeGetCookieMgr(m);dynamicProto(IntWeb2,this,(function(m){g.serviceName&&(m.serviceName=g.serviceName),m.getMsfpc=function(){return getCookieValue(S,"MSFPC")},m.getAnid=function(){return getCookieValue(S,"ANON").slice(0,34)}}))}var g;return IntWeb2._staticInit=(objDefineAccessors(g=IntWeb2.prototype,"msfpc",_getMsfpc),void objDefineAccessors(g,"anid",_getAnid)),IntWeb2}(),cu=function(){function Loc2(){var g=(new Date).getTimezoneOffset(),m=g%60,S=(g-m)/60,v="+";S>0&&(v="-"),S=Math.abs(S),m=Math.abs(m),this.tz=v+(S<10?"0"+S:S.toString())+":"+(m<10?"0"+m:m.toString())}return Loc2}(),du={WIN:/(windows|win32)/i,WINRT:/ arm;/i,WINPHONE:/windows\sphone\s\d+\.\d+/i,OSX:/(macintosh|mac os x)/i,IOS:/(ipad|iphone|ipod)(?=.*like mac os x)/i,LINUX:/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,ANDROID:/android/i,CROS:/CrOS/i},hu={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},uu="([\\d,.]+)",gu="([\\d,_,.]+)",pu="Unknown",mu=[{r:du.WINPHONE,os:"Windows Phone"},{r:du.WINRT,os:"Windows RT"},{r:du.WIN,os:"Windows"},{r:du.IOS,os:"iOS"},{r:du.ANDROID,os:"Android"},{r:du.LINUX,os:"Linux"},{r:du.CROS,os:"Chrome OS"},{s:"x11",os:"Unix"},{s:"blackberry",os:"BlackBerry"},{s:"symbian",os:"Symbian"},{s:"nokia",os:"Nokia"},{r:du.OSX,os:"Mac OS X"}];function _getOsName(g){for(var m=0;m<mu.length;m++){var S=mu[m];if(S.r&&g.match(S.r))return S.os;if(S.s&&-1!==g.indexOf(S.s))return S.os}return pu}function _getOsVersion(g,m){return"Windows"===m?_getGenericOsVersion(g,"Windows NT"):"Android"===m?_getGenericOsVersion(g,m):"Mac OS X"===m?_getMacOsxVersion(g):"iOS"===m?_getIosVersion(g):pu}function _getGenericOsVersion(g,m){var S=g.match(new RegExp(m+" "+uu));return S?hu[S[1]]?hu[S[1]]:S[1]:pu}function _getMacOsxVersion(g){var m=g.match(new RegExp("Mac OS X "+gu));if(m){var S=m[1].replace(/_/g,".");if(S){var v=_getDelimiter(S);return v?S.split(v)[0]:S}}return pu}function _getIosVersion(g){var m=g.match(new RegExp("OS "+gu));if(m){var S=m[1].replace(/_/g,".");if(S){var v=_getDelimiter(S);return v?S.split(v)[0]:S}}return pu}function _getDelimiter(g){return g.indexOf(".")>-1?".":g.indexOf("_")>-1?"_":null}var fu=function(){function OperatingSystem2(g){if(g.populateOperatingSystemInfo){var m=this,S=getNavigator()||{},v=g.userAgent||S.userAgent||"",C=g.userAgentData||S.userAgentData||{};if(v){var _=_getOsName(v.toLowerCase());m.name=_,m.ver=_getOsVersion(v,_)}m.name&&m.name!==pu||!isString2(C.platform)||(m.name=C.platform)}}return OperatingSystem2}(),Su="MicrosoftApplicationsTelemetryDeviceId";function _saveData(g,m,S,v){m?m.setProperty(S,v):g.set(S,v,31536e3)}function _getData(g,m,S){return m?m.getProperty(S)||"":getCookieValue(g,S)}var vu=function(){function Sdk2(g,m){var S=0;dynamicProto(Sdk2,this,(function(v){var C=g.propertyStorageOverride;v.seq=S,v.epoch=random32(!1).toString();var _=safeGetCookieMgr(m,g);if(_.isEnabled()||C){var E=_getData(_,C,Su);E||(E=newGuid2()),_saveData(_,C,Su,E),v.installId=E}else _.purge(Su);v.getSequenceId=function(){return++S}}))}return Sdk2.__ieDyn=1,Sdk2}(),Cu=function(){function Trace2(g,m,S,v){var C=this;if(C.traceId=m||generateW3CId(),g.enableDistributedTracing&&!S&&(S=generateW3CId().substring(0,16)),C.parentId=S,g.enableApplicationInsightsTrace){C.name=v;var _=getLocation();_&&_.pathname&&(C.name=_.pathname)}}return Trace2}(),_u="setLocalId";function _getLocalId(){return this.getLocalId()}function _setLocalId(g){this[_u](g)}var yu=function(){function User2(g,m,S){var v,C=m,_=safeGetCookieMgr(S,g);dynamicProto(User2,this,(function(m){if(_&&_.isEnabled()&&(_populateMuidFromCookie(),C.enableApplicationInsightsUser)){var S=getCookieValue(_,User2.userCookieName);if(S){var E=S.split(User2.cookieSeparator);E.length>0&&(m.id=E[0])}if(!m.id){m.id=newId(g&&!isUndefined3(g.idLength)?g.idLength:22);var T=toISOString(new Date);m.accountAcquisitionDate=T;var I=[m.id,T],b=C.cookieDomain?C.cookieDomain:void 0;_.set(User2.userCookieName,I.join(User2.cookieSeparator),31536e3,b)}}if("undefined"!=typeof navigator){var A=navigator;m.locale=A.userLanguage||A.language}function _populateMuidFromCookie(){if(!C.hashIdentifiers&&!C.dropIdentifiers){var g=getCookieValue(_,"MUID");g&&(v="t:"+g)}return v}m.getLocalId=function(){return v||_populateMuidFromCookie()},m[_u]=function(g){v=g}}))}return User2.cookieSeparator="|",User2.userCookieName="ai_user",User2._staticInit=void objDefineAccessors(User2.prototype,"localId",_getLocalId,_setLocalId),User2}(),Eu=1048576,Tu=2097152,Iu=function(){function Utc2(g){var m=this;m.popSample=100,m.eventFlags=0,g.hashIdentifiers&&(m.eventFlags=m.eventFlags|Eu),g.dropIdentifiers&&(m.eventFlags=m.eventFlags|Tu)}return Utc2}(),bu="([\\d,.]+)",Au="Unknown",Ru="Edg/",Pu=[{ua:"OPR/",b:"Opera"},{ua:"PhantomJS",b:"PhantomJS"},{ua:"Edge",b:"Edge"},{ua:Ru,b:"Edge"},{ua:"Electron",b:"Electron"},{ua:"Chrome",b:"Chrome"},{ua:"Trident",b:"MSIE"},{ua:"MSIE ",b:"MSIE"},{ua:"Firefox",b:"Firefox"},{ua:"Safari",b:"Safari"},{ua:"SkypeShell",b:"SkypeShell"}],Mu=[{br:"Microsoft Edge",b:"Edge"},{br:"Google Chrome",b:"Chrome"},{br:"Opera",b:"Opera"}];function _userAgentContainsString(g,m){return m.indexOf(g)>-1}function _getBrandVersion(g,m){for(var S=0;S<m.length;S++)if(g==m[S].brand)return m[S].version;return null}function _getBrowserName(g){if(g)for(var m=0;m<Pu.length;m++){if(_userAgentContainsString(Pu[m].ua,g))return Pu[m].b}return Au}function _getBrowserVersion(g,m){return"MSIE"===m?_getIeVersion(g):_getOtherVersion(m,g)}function _getIeVersion(g){var m=g.match(new RegExp("MSIE "+bu));if(m)return m[1];var S=g.match(new RegExp("rv:"+bu));return S?S[1]:void 0}function _getOtherVersion(g,m){"Safari"===g?g="Version":"Edge"===g&&_userAgentContainsString(Ru,m)&&(g="Edg");var S=m.match(new RegExp(g+"/"+bu));return S||"Opera"===g&&(S=m.match(new RegExp("OPR/"+bu)))?S[1]:Au}function _getScreenResolution(){var g={h:0,w:0},m=getWindow();return m&&m.screen&&(g.h=screen.height,g.w=screen.width),g}function _getUserConsent(){return this.getUserConsent()}var wu=function(){function Web2(g,m){var S=safeGetCookieMgr(m),v=g||{};dynamicProto(Web2,this,(function(g){var m=getLocation();if(m){var C=m.hostname;C&&(g.domain="file:"===m.protocol?"local":C)}if(v.populateBrowserInfo){var _=v.userAgent,E=(v.userAgentData||{}).brands,T=getNavigator();T&&(_=_||T.userAgent||"",E=E||(T.userAgentData||{}).brands),_parseUserAgent(_,E);var I=_getScreenResolution();g.screenRes=I.w+"X"+I.h}function _parseUserAgent(m,S){if(Zl(S))try{for(var v=0;v<Mu.length;v++){var C=_getBrandVersion(Mu[v].br,S);if(C)return g.browser=Mu[v].b,void(g.browserVer=C)}}catch(g){}if(m){var _=_getBrowserName(m);g.browser=_,g.browserVer=_getBrowserVersion(m,_)}}g.getUserConsent=function(){return v.userConsented||!!getCookieValue(S,v.userConsentCookieName||"MSCC")},g.getUserConsentDetails=function(){try{var g=v.callback;if(g&&g.userConsentDetails){var m=g.userConsentDetails();if(m)return JSON.stringify({Required:m.Required||!1,Analytics:m.Analytics||!1,SocialMedia:m.SocialMedia||!1,Advertising:m.Advertising||!1})}}catch(g){}return null},objDefineAccessors(g,"userConsent",g.getUserConsent)}))}return Web2._staticInit=void objDefineAccessors(Web2.prototype,"userConsent",_getUserConsent),Web2}();function _applyExtValues(g,m,S,v,C){var _=m.ext[Hh[g]];return _&&objForEachKey(v,(function(g,m){if(isString2(m)||isNumber3(m)||isBoolean2(m)){var v=_[S[g]];!C&&(v||isString2(v)||isNumber3(v)||isBoolean2(v))&&(m=v),_[S[g]]=m}})),_}var Du=function(){function TelemetryContext4(g,m,S){dynamicProto(TelemetryContext4,this,(function(v){v.app=new su(m,S),v.cloud=new au,v.user=new yu(g,m,S),v.os=new fu(m),v.web=new wu(m,S);var C=new vu(g,S),_=new lu(m,S),E=new Iu(m);v.loc=new cu,v.device=new ou;var T=new nu(S,m);v.session=new tu;var I=createDistributedTraceContextFromTraceCtx(new Cu(m),_getTraceCtx()),b=!(m||{}).eventContainExtFields;function _getSessionId(){var g=v.session;if(g&&isString2(g.customId))return g.customId;T.update();var m=T.automaticSession;if(m){var S=m.getId();S&&isString2(S)&&(g.automaticId=S)}return g.automaticId}function _getTraceCtx(){var g=I;return S&&S.getTraceCtx&&(g=S.getTraceCtx(!1)||I),g}v.getTraceCtx=function(){return I},v.getSessionId=_getSessionId,v.applyApplicationContext=function(g){var m,S=v.app;_applyExtValues(4,g,$h,((m={})[0]=S.id,m[1]=S.ver,m[2]=S.name,m[3]=S.locale,m[4]=S.getExpId(),m[5]=S.env,m),b)},v.applyUserContext=function(g){var m,S=v.user;_applyExtValues(0,g,jh,((m={})[1]=S.getLocalId(),m[0]=S.locale,m[2]=S.id,m),b)},v.applyWebContext=function(g){var m,S=v.web;_applyExtValues(3,g,Gh,((m={})[0]=S.domain,m[1]=S.browser,m[2]=S.browserVer,m[3]=S.screenRes,m[5]=S.getUserConsentDetails(),m[4]=S.getUserConsent(),m),b)},v.applyOsContext=function(g){var m,S=v.os;_applyExtValues(5,g,qh,((m={})[0]=S.name,m[1]=S.ver,m),b)},v.applySdkContext=function(g){var m;_applyExtValues(6,g,Wh,((m={})[2]=C.installId,m[1]=C.getSequenceId(),m[3]=C.epoch,m),b)},v.applyIntWebContext=function(g){var m;_applyExtValues(7,g,zh,((m={})[0]=_.getMsfpc(),m[1]=_.getAnid(),m[2]=_.serviceName,m),b)},v.applyUtcContext=function(g){var m,S=((m={})[0]=E.popSample,m);E.eventFlags>0&&(S[1]=E.eventFlags),_applyExtValues(8,g,Kh,S,b)},v.applyLocContext=function(g){var m;_applyExtValues(9,g,Jh,((m={})[0]=v.loc.tz,m),b)},v.applySessionContext=function(g){var m;_applyExtValues(4,g,Yh,((m={})[0]=_getSessionId(),m),b)},v.applyDeviceContext=function(g){var m,S=v.device;_applyExtValues(1,g,Qh,((m={})[0]=S.localId,m[2]=S.make,m[3]=S.model,m[1]=S.deviceClass,m),b)},v.applyCloudContext=function(g){var m,S=v.cloud;_applyExtValues(10,g,Xh,((m={})[0]=S.role,m[1]=S.roleInstance,m[2]=S.roleVer,m),b)},v.applyAITraceContext=function(g){var S;if(m.enableApplicationInsightsTrace){var v=_getTraceCtx();v&&_applyExtValues(2,g,Zh,((S={})[0]=v.getTraceId(),S[1]=v.getName(),S[2]=v.getSpanId(),S),!1)}},v.applyDistributedTraceContext=function(g){var m,S=_getTraceCtx();if(S){var v=((m={})[0]=S.getTraceId(),m[1]=S.getSpanId(),m),C=S.getTraceFlags();isNullOrUndefined(C)||(v[2]=C),_applyExtValues(11,g,eu,v,!1)}}}))}return TelemetryContext4.__ieDyn=1,TelemetryContext4}();function createDistributedTraceContextFromTraceCtx(g,m){var S=g||{};return{getName:function(){return S.name},setName:function(g){m&&m.setName(g),S.name=g},getTraceId:function(){return S.traceId},setTraceId:function(g){m&&m.setTraceId(g),isValidTraceId(g)&&(S.traceId=g)},getSpanId:function(){return S.parentId},setSpanId:function(g){m&&m.setSpanId(g),isValidSpanId(g)&&(S.parentId=g)},getTraceFlags:function(){return S.traceFlags},setTraceFlags:function(g){m&&m.setTraceFlags(g),S.traceFlags=g}}}var Ou=[Hh[4],Hh[0],Hh[3],Hh[5],Hh[6],Hh[7],Hh[8],Hh[9],Hh[1],Hh[2],Hh[11],Hh[10]],Nu=function(g){function PropertiesPlugin2(){var m,S,v,C=g.call(this)||this;return C.identifier="SystemPropertiesCollector",C.priority=3,C.version="3.2.9",dynamicProto(PropertiesPlugin2,C,(function(g,C){function _initDefaults(){m=null,S={}}function _addPropertiesIfAbsent(g,m){g&&objForEachKey(g,(function(g,S){m[g]||(m[g]=S)}))}_initDefaults(),g.initialize=function(S,_,E){C.initialize(S,_,E),v=g._getTelCtx().getExtCfg(g.identifier),m=new Du(S,v,_),_&&_.setTraceCtx&&_.setTraceCtx(m.getTraceCtx())},g.processTelemetry=function(C,_){setProcessTelemetryTimings(C,g.identifier),_=g._getTelCtx(_);var E=C.ext=C.ext?C.ext:{};C.data=C.data?C.data:{},arrForEach(Ou,(function(g){E[g]=E[g]||{}})),m&&(m.applyApplicationContext(C),m.applyUserContext(C),m.applyWebContext(C),m.applyOsContext(C),m.applySdkContext(C),m.applyIntWebContext(C),m.applyUtcContext(C),m.applyLocContext(C),m.applySessionContext(C),m.applyDeviceContext(C),v.enableApplicationInsightsTrace&&m.applyAITraceContext(C),v.enableDistributedTracing&&m.applyDistributedTraceContext(C),m.applyCloudContext(C)),arrForEach(objKeys(E),(function(g){0===objKeys(E[g]).length&&delete E[g]})),_addPropertiesIfAbsent(S,C.data),g.processNext(C,_)},g.getPropertiesContext=function(){return m},g.setProperty=function(g,m){S[g]=m},g._doTeardown=function(g,S){var v=(g||{}).core();if(v&&v.getTraceCtx&&m){var C=v.getTraceCtx(!1);C&&C===m.getTraceCtx()&&v.setTraceCtx(null)}_initDefaults()}})),C}return __extendsFn(PropertiesPlugin2,g),PropertiesPlugin2.__ieDyn=1,PropertiesPlugin2}(Ld),ku=function(){function BaseContext2(g){this._setOverride=function(m,S){g.setOverride(m,S)},this._getOverride=function(m){return g.getOverride(m)}}return BaseContext2}(),Lu=function(g){function ApplicationContext2(m,S){var v=g.call(this,m)||this,C=v;return C.setId=function(g){C._setOverride($h.id,g)},C.getId=function(){return C._getOverride($h.id)},C.setVer=function(g){C._setOverride($h.ver,g)},C.getVer=function(){return C._getOverride($h.ver)},C.setName=function(g){C._setOverride($h.appName,g)},C.getName=function(){return C._getOverride($h.appName)},C.setLocale=function(g){C._setOverride($h.locale,g)},C.getLocale=function(){return C._getOverride($h.locale)},C.setEnv=function(g){C._setOverride($h.env,g)},C.getEnv=function(){return C._getOverride($h.env)},C.setExpId=function(g){C._setOverride($h.expId,su.validateAppExpId(g))},C.getExpId=function(){return C._getOverride($h.expId)},S&&(isUndefined3(S.env)||C.setEnv(S.env),isNullOrUndefined(S.expId)||C.setExpId(S.expId)),v}return __extendsFn(ApplicationContext2,g),ApplicationContext2}(ku),Fu=function(g){function CloudContext2(m){var S=g.call(this,m)||this,v=S;return v.setRole=function(g){v._setOverride(Xh.role,g)},v.getRole=function(){return v._getOverride(Xh.role)},v.setRoleInstance=function(g){v._setOverride(Xh.roleInstance,g)},v.getRoleInstance=function(){return v._getOverride(Xh.roleInstance)},v.setRoleVer=function(g){v._setOverride(Xh.roleVer,g)},v.getRoleVer=function(){return v._getOverride(Xh.roleVer)},S}return __extendsFn(CloudContext2,g),CloudContext2}(ku),xu=function(g){function DataContext2(m){var S=g.call(this,m)||this,v=S;return v.setProperty=function(g,m){v._setOverride(g,m)},v.getProperty=function(g){return v._getOverride(g)},S}return __extendsFn(DataContext2,g),DataContext2}(ku),Uu=function(g){function DeviceContext2(m){var S=g.call(this,m)||this,v=S;return v.setLocalId=function(g){v._setOverride(Qh.localId,g)},v.getLocalId=function(){return v._getOverride(Qh.localId)},v.setDeviceClass=function(g){v._setOverride(Qh.deviceClass,g)},v.getDeviceClass=function(){return v._getOverride(Qh.deviceClass)},v.setMake=function(g){v._setOverride(Qh.make,g)},v.getMake=function(){return v._getOverride(Qh.make)},v.setModel=function(g){v._setOverride(Qh.model,g)},v.getModel=function(){return v._getOverride(Qh.model)},S}return __extendsFn(DeviceContext2,g),DeviceContext2}(ku),Vu=function(g){function LocContext2(m){var S=g.call(this,m)||this,v=S;return v.setTz=function(g){v._setOverride(Jh.tz,g)},v.getTz=function(){return v._getOverride(Jh.tz)},S}return __extendsFn(LocContext2,g),LocContext2}(ku),Bu=function(g){function OperatingSystemContext2(m,S){var v=g.call(this,m)||this,C=v;if(C.setOsName=function(g){C._setOverride(qh.osName,g)},C.getOsName=function(){return C._getOverride(qh.osName)},C.setVer=function(g){C._setOverride(qh.ver,g)},C.getVer=function(){return C._getOverride(qh.ver)},S&&S.userAgent&&S.populateOperatingSystemInfo){var _=new fu(S);C.setOsName(_.name),C.setVer(_.ver)}return v}return __extendsFn(OperatingSystemContext2,g),OperatingSystemContext2}(ku);function _getEventRoot(g,m){if(g)for(var S=0;S<m.length;S++){var v=m[S];isNullOrUndefined(g[v])&&(g[v]={}),g=g[v]}return g}function _setOverride(g,m,S){if(g&&m){var v=m.split("."),C=v[v.length-1];v.length>1&&(g=_getEventRoot(g,v.slice(0,-1))),isNullOrUndefined(S)?isUndefined3(g[C])||delete g[C]:g[C]=S}}var Hu=function(){function OverrideContainer2(g){var m=this,S=[];m.setOverride=function(g,m){g&&S.push({key:g,value:m})},m.hasOverride=function(g){var m=!1;return arrForEach(S,(function(S){S.key===g&&(m=!0)})),m},m.getOverride=function(g){var m;return arrForEach(S,(function(S){S.key===g&&(m=S.value)})),m},m.applyOverrides=function(m,v){if(S.length>0)try{var C=_getEventRoot(m,g);arrForEach(S,(function(g){_setOverride(C,g.key,g.value)}))}catch(g){}}}return OverrideContainer2}(),$u=function(g){function UserContext2(m){var S=g.call(this,m)||this,v=S;return v.setLocalId=function(g){v._setOverride(jh.localId,g)},v.getLocalId=function(){return v._getOverride(jh.localId)},v.setLocale=function(g){v._setOverride(jh.locale,g)},v.getLocale=function(){return v._getOverride(jh.locale)},v.setId=function(g){v._setOverride(jh.id,g)},v.getId=function(){return v._getOverride(jh.id)},S}return __extendsFn(UserContext2,g),UserContext2}(ku),Gu=function(g){function WebContext2(m,S){var v=g.call(this,m)||this,C=v;return C.setDomain=function(g){C._setOverride(Gh.domain,g)},C.getDomain=function(){return C._getOverride(Gh.domain)},C.setBrowser=function(g){C._setOverride(Gh.browser,g)},C.getBrowser=function(){return C._getOverride(Gh.browser)},C.setBrowserVer=function(g){C._setOverride(Gh.browserVer,g)},C.getBrowserVer=function(){return C._getOverride(Gh.browserVer)},C.setScreenRes=function(g){C._setOverride(Gh.screenRes,g)},C.getScreenRes=function(){return C._getOverride(Gh.screenRes)},C.setUserConsent=function(g){C._setOverride(Gh.userConsent,g)},C.getUserContext=function(){return C._getOverride(Gh.userConsent)},S&&(isUndefined3(S.userConsented)||C.setUserConsent(S.userConsented)),v}return __extendsFn(WebContext2,g),WebContext2}(ku),ju="ext",qu="data",Wu=function(){function OverrideContext2(g,m,S){var v=this,C={};function _getContainer(g){for(var m="",S=0;S<g.length;S++)m&&(m+="_"),m+=g[S];return isUndefined3(C[m])&&(C[m]=new Hu(g)),m?C[m]:null}v.data=new xu(_getContainer([qu])),v.app=new Lu(_getContainer([ju,Hh.AppExt]),m),v.user=new $u(_getContainer([ju,Hh.UserExt])),v.os=new Bu(_getContainer([ju,Hh.OSExt]),m),v.web=new Gu(_getContainer([ju,Hh.WebExt]),m),v.device=new Uu(_getContainer([ju,Hh.DeviceExt])),v.loc=new Vu(_getContainer([ju,Hh.LocExt])),v.cloud=new Fu(_getContainer([ju,Hh.CloudExt])),v.applyOverrides=function(g,m){var S=objKeys(C);S&&S.length>0&&arrForEach(S,(function(S){C[S].applyOverrides(g,m)}))}}return OverrideContext2}(),zu=function(g){function OverridePropertiesPlugin2(){var m=g.call(this)||this;m.identifier="OverridePropertiesPlugin",m.priority=4,m.version="3.2.9";var S=null;return dynamicProto(OverridePropertiesPlugin2,m,(function(g,v){g.initialize=function(m,S,C){v.initialize(m,S,C),g._baseInit(m,S,C)},g.processTelemetry=function(S,v){setProcessTelemetryTimings(S,m.identifier),v=g._getTelCtx(v);var C=g.getOverrideContext();C&&C.applyOverrides(S,v),g.processNext(S,v)},g._baseInit=function(g,v,C){S=new Wu(g,m._getTelCtx().getExtCfg(m.identifier),v)},g.setProperty=function(g,m){S&&S.data.setProperty(g,m)},g.getOverrideContext=function(){return S}})),m}return __extendsFn(OverridePropertiesPlugin2,g),OverridePropertiesPlugin2.__ieDyn=1,OverridePropertiesPlugin2}(Ld),Ku="REAL_TIME",Ju="NEAR_REAL_TIME",Yu="BEST_EFFORT",Qu="",Xu="POST",Zu="Microsoft_ApplicationInsights_BypassAjaxInstrumentation",eg="drop",tg="send",ig="requeue",ng="rspFail",rg="oth",sg="no-cache, no-store",ag="application/x-json-stream",og="cache-control",lg="content-type",cg="kill-tokens",dg="kill-duration",hg="kill-duration-seconds",ug="time-delta-millis",gg="client-version",pg="client-id",mg="time-delta-to-apply-millis",fg="upload-time",Sg="apikey",vg="AuthMsaDeviceTicket",Cg="AuthXToken",_g="NoResponseBody",yg="msfpc",Eg="trace",Tg="user";function _getEventMsfpc(g){var m=(g.ext||{}).intweb;return m&&isValueAssigned(m[yg])?m[yg]:null}function _getMsfpc2(g){for(var m=null,S=0;null===m&&S<g.length;S++)m=_getEventMsfpc(g[S]);return m}var Ig=function(){function EventBatch2(g,m){var S=m?[].concat(m):[],v=this,C=_getMsfpc2(S);v.iKey=function(){return g},v.Msfpc=function(){return C||Qu},v.count=function(){return S.length},v.events=function(){return S},v.addEvent=function(g){return!!g&&(S.push(g),C||(C=_getEventMsfpc(g)),!0)},v.split=function(m,v){var _;if(m<S.length){var E=S.length-m;isNullOrUndefined(v)||(E=v<E?v:E),_=S.splice(m,E),C=_getMsfpc2(S)}return new EventBatch2(g,_)}}return EventBatch2.create=function(g,m){return new EventBatch2(g,m)},EventBatch2}(),bg=function(){function ClockSkewManager2(){var g=!0,m=!0,S=!0,v="use-collector-delta",C=!1;dynamicProto(ClockSkewManager2,this,(function(_){_.allowRequestSending=function(){return g},_.firstRequestSent=function(){S&&(S=!1,C||(g=!1))},_.shouldAddClockSkewHeaders=function(){return m},_.getClockSkewHeaderValue=function(){return v},_.setClockSkew=function(S){C||(S?(v=S,m=!0,C=!0):m=!1,g=!0)}}))}return ClockSkewManager2.__ieDyn=1,ClockSkewManager2}(),Ag=1e3,Rg=function(){function KillSwitch2(){var g={};function _normalizeTenants(g){var m=[];return g&&arrForEach(g,(function(g){m.push(strTrim(g))})),m}dynamicProto(KillSwitch2,this,(function(m){m.setKillSwitchTenants=function(m,S){if(m&&S)try{var v=_normalizeTenants(m.split(","));if("this-request-only"===S)return v;for(var C=parseInt(S,10)*Ag,_=0;_<v.length;++_)g[v[_]]=dateNow()+C}catch(g){return[]}return[]},m.isTenantKilled=function(m){var S=g,v=strTrim(m);return void 0!==S[v]&&S[v]>dateNow()||(delete S[v],!1)}}))}return KillSwitch2.__ieDyn=1,KillSwitch2}(),Pg=Rg,Mg=.8,wg=1.2,Dg=3e3,Og=6e5;function retryPolicyShouldRetryForStatus(g){return!(g>=300&&g<500&&408!=g&&429!=g||501==g||505==g)}function retryPolicyGetMillisToBackoffForRetry(g){var m=0,S=Dg*Mg,v=Dg*wg,C=Math.floor(Math.random()*(v-S))+S;return m=Math.pow(2,g)*C,Math.min(m,Og)}var Ng,kg=20,Lg=3984588,Fg=65e3,xg=2e6,Ug=Math.min(xg,Fg),Vg="metadata",Bg="f",Hg=/\./,$g=function(){function Serializer2(g,m,S,v){var C="data",_="baseData",E="ext",T=!!v,I=!0,b=m,A={};dynamicProto(Serializer2,this,(function(m){function _isReservedField(g,m){var S=A[g];return void 0===S&&(g.length>=7&&(S=strStartsWith(g,"ext.metadata")||strStartsWith(g,"ext.web")),A[g]=S),S}function _processPathKeys(g,m,v,C,_,E,I){objForEachKey(g,(function(g,A){var R=null;if(A||isValueAssigned(A)){var P=v,M=g,w=_,D=m;if(T&&!C&&Hg.test(g)){var O=g.split("."),N=O.length;if(N>1){w&&(w=w.slice());for(var k=0;k<N-1;k++){var L=O[k];D=D[L]=D[L]||{},P+="."+L,w&&w.push(L)}M=O[N-1]}}if(R=!(C&&_isReservedField(P))&&b&&b.handleField(P,M)?b.value(P,M,A,S):sanitizeProperty(M,A,S)){var F=R.value;if(D[M]=F,E&&E(w,M,R),I&&"object"==typeof F&&!Zl(F)){var x=w;x&&(x=x.slice()).push(M),_processPathKeys(A,F,P+"."+M,C,x,E,I)}}}}))}m.createPayload=function(g,m,S,v,C,_){return{apiKeys:[],payloadBlob:Qu,overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:g,isTeardown:m,isSync:S,isBeacon:v,sendType:_,sendReason:C}},m.appendPayload=function(S,v,C){var _=S&&v&&!S.overflow;return _&&doPerf(g,(function(){return"Serializer:appendPayload"}),(function(){for(var g=v.events(),_=S.payloadBlob,E=S.numEvents,T=!1,I=[],b=[],A=S.isBeacon,R=A?Fg:Lg,P=A?Ug:xg,M=0,w=0;M<g.length;){var D=g[M];if(D){if(E>=C){S.overflow=v.split(M);break}var O=m.getEventBlob(D);if(O&&O.length<=P){var N=O.length;if(_.length+N>R){S.overflow=v.split(M);break}_&&(_+="\n"),_+=O,++w>kg&&(_.substr(0,1),w=0),T=!0,E++}else O?I.push(D):b.push(D),g.splice(M,1),M--}M++}if(I&&I.length>0&&S.sizeExceed.push(Ig.create(v.iKey(),I)),b&&b.length>0&&S.failedEvts.push(Ig.create(v.iKey(),b)),T){S.batches.push(v),S.payloadBlob=_,S.numEvents=E;var k=v.iKey();-1===arrIndexOf(S.apiKeys,k)&&S.apiKeys.push(k)}}),(function(){return{payload:S,theBatch:{iKey:v.iKey(),evts:v.events()},max:C}})),_},m.getEventBlob=function(m){try{return doPerf(g,(function(){return"Serializer.getEventBlob"}),(function(){var g={};g.name=m.name,g.time=m.time,g.ver=m.ver,g.iKey="o:"+getTenantId(m.iKey);var S={},v=m[E];v&&(g[E]=S,objForEachKey(v,(function(g,m){_processPathKeys(m,S[g]={},"ext."+g,!0,null,null,!0)})));var T=g[C]={};T.baseType=m.baseType;var b=T[_]={};return _processPathKeys(m.baseData,b,_,!1,[_],(function(g,m,v){_addJSONPropertyMetaData(S,g,m,v)}),I),_processPathKeys(m.data,T,C,!1,[],(function(g,m,v){_addJSONPropertyMetaData(S,g,m,v)}),I),JSON.stringify(g)}),(function(){return{item:m}}))}catch(g){return null}}}))}return Serializer2.__ieDyn=1,Serializer2}();function _addJSONPropertyMetaData(g,m,S,v){if(v&&g){var C=getCommonSchemaMetaData(v.value,v.kind,v.propertyType);if(C>-1){var _=g[Vg];_||(_=g[Vg]={f:{}});var E=_[Bg];if(E||(E=_[Bg]={}),m)for(var T=0;T<m.length;T++){var I=m[T];E[I]||(E[I]={f:{}});var b=E[I][Bg];b||(b=E[I][Bg]={}),E=b}E=E[S]={},Zl(v.value)?E.a={t:C}:E.t=C}}}var Gg="sendAttempt",jg="&"+_g+"=true",qg=((Ng={})[1]=ig,Ng[100]=ig,Ng[200]="sent",Ng[8004]=eg,Ng[8003]=eg,Ng),Wg={},zg={};function _addCollectorHeaderQsMapping(g,m,S){Wg[g]=m,!1!==S&&(zg[m]=g)}function _getResponseText(g){try{return g.responseText}catch(g){}return Qu}function _hasHeader(g,m){var S=!1;if(g&&m){var v=objKeys(g);if(v&&v.length>0)for(var C=m.toLowerCase(),_=0;_<v.length;_++){var E=v[_];if(E&&hasOwnProperty(m,E)&&E.toLowerCase()===C){S=!0;break}}}return S}function _addRequestDetails(g,m,S,v){m&&S&&S.length>0&&(v&&Wg[m]?(g.hdrs[Wg[m]]=S,g.useHdrs=!0):g.url+="&"+m+"="+S)}function _prependTransports(g,m){return m&&(isNumber3(m)?g=[m].concat(g):Zl(m)&&(g=m.concat(g))),g}_addCollectorHeaderQsMapping(vg,vg,!1),_addCollectorHeaderQsMapping(gg,gg),_addCollectorHeaderQsMapping(pg,"Client-Id"),_addCollectorHeaderQsMapping(Sg,Sg),_addCollectorHeaderQsMapping(mg,mg),_addCollectorHeaderQsMapping(fg,fg),_addCollectorHeaderQsMapping(Cg,Cg);var Kg=function(){function HttpManager2(g,m,S,v,C){this._responseHandlers=[];var _,E,T,I,b,A,R,P,M,w,D="?cors=true&"+lg.toLowerCase()+"="+ag,O=new Pg,N=!1,k=new bg,L=!1,F=0,x=!0,U=[],V={},B=[],H=null,$=!1,G=!1,j=!1;dynamicProto(HttpManager2,this,(function(q){var W=!0;function _getSenderInterface(g,m){for(var S=0,v=null,C=0;null==v&&C<g.length;)1===(S=g[C])?useXDomainRequest()?v=_xdrSendPost:isXhrSupported()&&(v=_xhrSendPost):2===S&&isFetchSupported(m)&&(!m||m&&!P)?v=_fetchSendPost:L&&3===S&&isBeaconsSupported()&&(v=_beaconSendPost),C++;return v?{_transport:S,_isSync:m,sendPOST:v}:null}function _xdrSendPost(g,m,S){var v=new XDomainRequest;v.open(Xu,g.urlString),g.timeout&&(v.timeout=g.timeout),v.onload=function(){var g=_getResponseText(v);_doOnComplete(m,200,{},g),_handleCollectorResponse(g)},v.onerror=function(){_doOnComplete(m,400,{})},v.ontimeout=function(){_doOnComplete(m,500,{})},v.onprogress=function(){},S?v.send(g.data):C.set((function(){v.send(g.data)}),0)}function _fetchSendPost(g,m,S){var v,_=g.urlString,E=!1,T=!1,I=((v={body:g.data,method:Xu})[Zu]=!0,v);S&&(I.keepalive=!0,2===g._sendReason&&(E=!0,w&&(_+=jg))),W&&(I.credentials="include"),g.headers&&objKeys(g.headers).length>0&&(I.headers=g.headers),fetch(_,I).then((function(g){var S={},v=Qu,C=g.headers;C&&C.forEach((function(g,m){S[m]=g})),g.body&&g.text().then((function(g){v=g})),T||(T=!0,_doOnComplete(m,g.status,S,v),_handleCollectorResponse(v))})).catch((function(g){T||(T=!0,_doOnComplete(m,0,{}))})),E&&!T&&(T=!0,_doOnComplete(m,200,{})),!T&&g.timeout>0&&C.set((function(){T||(T=!0,_doOnComplete(m,500,{}))}),g.timeout)}function _xhrSendPost(g,m,S){var v=g.urlString;function _appendHeader(g,m,S){if(!g[S]&&m&&m.getResponseHeader){var v=m.getResponseHeader(S);v&&(g[S]=strTrim(v))}return g}function _getAllResponseHeaders(g){var m={};return g.getAllResponseHeaders?m=_convertAllHeadersToMap(g.getAllResponseHeaders()):(m=_appendHeader(m,g,ug),m=_appendHeader(m,g,dg),m=_appendHeader(m,g,hg)),m}function xhrComplete(g,S){_doOnComplete(m,g.status,_getAllResponseHeaders(g),S)}S&&g.disableXhrSync&&(S=!1);var C=openXhr(Xu,v,W,!0,S,g.timeout);objForEachKey(g.headers,(function(g,m){C.setRequestHeader(g,m)})),C.onload=function(){var g=_getResponseText(C);xhrComplete(C,g),_handleCollectorResponse(g)},C.onerror=function(){xhrComplete(C)},C.ontimeout=function(){xhrComplete(C)},C.send(g.data)}function _doOnComplete(g,m,S,v){try{g(m,S,v)}catch(g){_throwInternal(E,2,518,dumpObj(g))}}function _beaconSendPost(g,m,S){var v=200,C=g._thePayload,_=g.urlString+(w?jg:Qu);try{var T=getNavigator();if(!T.sendBeacon(_,g.data))if(C){var I=[];arrForEach(C.batches,(function(g){if(I&&g&&g.count()>0){for(var m=g.events(),S=0;S<m.length;S++)if(!T.sendBeacon(_,H.getEventBlob(m[S]))){I.push(g.split(S));break}}else I.push(g.split(0))})),_sendBatchesNotification(I,8003,C.sendType,!0)}else v=0}catch(g){_warnToConsole(E,"Failed to send telemetry using sendBeacon API. Ex:"+dumpObj(g)),v=0}finally{_doOnComplete(m,v,{},Qu)}}function _isBeaconPayload(g){return 2===g||3===g}function _adjustSendType(g){return G&&_isBeaconPayload(g)&&(g=2),g}function _hasIdleConnection(){return!N&&F<m}function _clearQueue(){var g=B;return B=[],g}function _canSendPayload(g,m,S){var v=!1;return g&&g.length>0&&!N&&T[m]&&H&&(v=0!==m||_hasIdleConnection()&&(S>0||k.allowRequestSending())),v}function _createDebugBatches(g){var m={};return g&&arrForEach(g,(function(g,S){m[S]={iKey:g.iKey(),evts:g.events()}})),m}function _sendBatches(m,S,v,C,_){if(m&&0!==m.length)if(N)_sendBatchesNotification(m,1,C);else{C=_adjustSendType(C);try{var b=m,A=0!==C;doPerf(I,(function(){return"HttpManager:_sendBatches"}),(function(E){E&&(m=m.slice(0));for(var I=[],b=null,R=_h(),P=T[C]||(A?T[1]:T[0]),w=P&&P._transport,D=M&&(G||_isBeaconPayload(C)||3===w||P._isSync&&2===w);_canSendPayload(m,C,S);){var N=m.shift();N&&N.count()>0&&(O.isTenantKilled(N.iKey())?I.push(N):(b=b||H.createPayload(S,v,A,D,_,C),H.appendPayload(b,N,g)?null!==b.overflow&&(m=[b.overflow].concat(m),b.overflow=null,_doPayloadSend(b,R,_h(),_),R=_h(),b=null):(_doPayloadSend(b,R,_h(),_),R=_h(),m=[N].concat(m),b=null)))}b&&_doPayloadSend(b,R,_h(),_),m.length>0&&(B=m.concat(B)),_sendBatchesNotification(I,8004,C)}),(function(){return{batches:_createDebugBatches(b),retryCount:S,isTeardown:v,isSynchronous:A,sendReason:_,useSendBeacon:_isBeaconPayload(C),sendType:C}}),!A)}catch(g){_throwInternal(E,2,48,"Unexpected Exception sending batch: "+dumpObj(g))}}}function _buildRequestDetails(g,m){var S={url:D,hdrs:{},useHdrs:!1};m?(S.hdrs=extend(S.hdrs,V),S.useHdrs=objKeys(S.hdrs).length>0):objForEachKey(V,(function(g,m){zg[g]?_addRequestDetails(S,zg[g],m,!1):(S.hdrs[g]=m,S.useHdrs=!0)})),_addRequestDetails(S,pg,"NO_AUTH",m),_addRequestDetails(S,gg,mh,m);var v=Qu;arrForEach(g.apiKeys,(function(g){v.length>0&&(v+=","),v+=g})),_addRequestDetails(S,Sg,v,m),_addRequestDetails(S,fg,dateNow().toString(),m);var C=_getMsfpc3(g);if(isValueAssigned(C)&&(S.url+="&ext.intweb.msfpc="+C),k.shouldAddClockSkewHeaders()&&_addRequestDetails(S,mg,k.getClockSkewHeaderValue(),m),I.getWParam){var _=I.getWParam();_>=0&&(S.url+="&w="+_)}for(var E=0;E<U.length;E++)S.url+="&"+U[E].name+"="+U[E].value;return S}function _setTimingValue(g,m,S){g[m]=g[m]||{},g[m][_.identifier]=S}function _doPayloadSend(g,m,S,v){if(g&&g.payloadBlob&&g.payloadBlob.length>0){var C=!!q.sendHook,_=T[g.sendType];!_isBeaconPayload(g.sendType)&&g.isBeacon&&2===g.sendReason&&(_=T[2]||T[3]||_);var b=j;(g.isBeacon||3===_._transport)&&(b=!1);var M=_buildRequestDetails(g,b);b=b||M.useHdrs;var w=_h();doPerf(I,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var T=0;T<g.batches.length;T++)for(var D=g.batches[T].events(),O=0;O<D.length;O++){var N=D[O];if($){var L=N.timings=N.timings||{};_setTimingValue(L,"sendEventStart",w),_setTimingValue(L,"serializationStart",m),_setTimingValue(L,"serializationCompleted",S)}N[Gg]>0?N[Gg]++:N[Gg]=1}_sendBatchesNotification(g.batches,1e3+(v||0),g.sendType,!0);var U={data:g.payloadBlob,urlString:M.url,headers:M.hdrs,_thePayload:g,_sendReason:v,timeout:A,disableXhrSync:R,disableFetchKeepAlive:P};b&&(_hasHeader(U.headers,og)||(U.headers[og]=sg),_hasHeader(U.headers,lg)||(U.headers[lg]=ag));var V=null;_&&(V=function(m){k.firstRequestSent();var onComplete=function(m,S){_retryRequestIfNeeded(m,S,g,v)},S=g.isTeardown||g.isSync;try{_.sendPOST(m,onComplete,S),q.sendListener&&q.sendListener(U,m,S,g.isBeacon)}catch(g){_warnToConsole(E,"Unexpected exception sending payload. Ex:"+dumpObj(g)),_doOnComplete(onComplete,0,{})}}),doPerf(I,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(V)if(0===g.sendType&&F++,C&&!g.isBeacon&&3!==_._transport){var m={data:U.data,urlString:U.urlString,headers:extend({},U.headers),timeout:U.timeout,disableXhrSync:U.disableXhrSync,disableFetchKeepAlive:U.disableFetchKeepAlive},S=!1;doPerf(I,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{q.sendHook(m,(function(g){S=!0,x||g._thePayload||(g._thePayload=g._thePayload||U._thePayload,g._sendReason=g._sendReason||U._sendReason),V(g)}),g.isSync||g.isTeardown)}catch(g){S||V(U)}}))}else V(U)}))}),(function(){return{thePayload:g,serializationStart:m,serializationCompleted:S,sendReason:v}}),g.isSync)}g.sizeExceed&&g.sizeExceed.length>0&&_sendBatchesNotification(g.sizeExceed,8003,g.sendType),g.failedEvts&&g.failedEvts.length>0&&_sendBatchesNotification(g.failedEvts,8002,g.sendType)}function _addEventCompletedTimings(g,m){$&&arrForEach(g,(function(g){_setTimingValue(g.timings=g.timings||{},"sendEventCompleted",m)}))}function _retryRequestIfNeeded(g,m,v,C){var _=9e3,E=null,T=!1,I=!1;try{var b=!0;if(typeof g!==wa){if(m){k.setClockSkew(m[ug]);var A=m[dg]||m["kill-duration-seconds"];arrForEach(O.setKillSwitchTenants(m[cg],A),(function(g){arrForEach(v.batches,(function(m){if(m.iKey()===g){E=E||[];var S=m.split(0);v.numEvents-=S.count(),E.push(S)}}))}))}if(200==g||204==g)return void(_=200);(!retryPolicyShouldRetryForStatus(g)||v.numEvents<=0)&&(b=!1),_=9e3+g%1e3}if(b){_=100;var R=v.retryCnt;0===v.sendType&&(R<S?(T=!0,_doAction((function(){0===v.sendType&&F--,_sendBatches(v.batches,R+1,v.isTeardown,G?2:v.sendType,5)}),G,retryPolicyGetMillisToBackoffForRetry(R))):(I=!0,G&&(_=8001)))}}finally{T||(k.setClockSkew(),_handleRequestFinished(v,_,C,I)),_sendBatchesNotification(E,8004,v.sendType)}}function _handleRequestFinished(g,m,S,v){try{v&&_._backOffTransmission(),200===m&&(v||g.isSync||_._clearBackOff(),_addCompleteTimings(g.batches)),_sendBatchesNotification(g.batches,m,g.sendType,!0)}finally{0===g.sendType&&(F--,5!==S&&q.sendQueuedRequests(g.sendType,S))}}function _addCompleteTimings(g){if($){var m=_h();arrForEach(g,(function(g){g&&g.count()>0&&_addEventCompletedTimings(g.events(),m)}))}}function _doAction(g,m,S){m?g():C.set(g,S)}function _convertAllHeadersToMap(g){var m={};isString2(g)&&arrForEach(strTrim(g).split(/[\r\n]+/),(function(g){if(g){var S=g.indexOf(": ");if(-1!==S){var v=strTrim(g.substring(0,S)).toLowerCase(),C=strTrim(g.substring(S+1));m[v]=C}else m[strTrim(g)]=1}}));return m}function _getMsfpc3(g){for(var m=0;m<g.batches.length;m++){var S=g.batches[m].Msfpc();if(S)return encodeURIComponent(S)}return Qu}function _handleCollectorResponse(g){var m=q._responseHandlers;try{for(var S=0;S<m.length;S++)try{m[S](g)}catch(g){_throwInternal(E,1,519,"Response handler failed: "+g)}if(g){var v=JSON.parse(g);isValueAssigned(v.webResult)&&isValueAssigned(v.webResult[yg])&&b.set("MSFPC",v.webResult[yg],31536e3)}}catch(g){}}function _sendBatchesNotification(g,m,S,C){if(g&&g.length>0&&v){var _=v[_getNotificationAction(m)];if(_){var T=0!==S;doPerf(I,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){_doAction((function(){try{_.call(v,g,m,T,S)}catch(g){_throwInternal(E,1,74,"send request notification failed: "+g)}}),C||T,0)}),(function(){return{batches:_createDebugBatches(g),reason:m,isSync:T,sendSync:C,sendType:S}}),!T)}}}function _getNotificationAction(g){var m=qg[g];return isValueAssigned(m)||(m=rg,g>=9e3&&g<=9999?m=ng:g>=8e3&&g<=8999?m=eg:g>=1e3&&g<=1999&&(m=tg)),m}q.initialize=function(g,m,S,v,C){var O;C||(C={}),D=g+D,j=!!isUndefined3(C.avoidOptions)||!C.avoidOptions,I=m,b=m.getCookieMgr(),$=!I.config.disableEventTimings;var N=!!I.config.enableCompoundKey;E=(_=S).diagLog();var k=C.valueSanitizer,F=C.stringifyObjects;isUndefined3(C.enableCompoundKey)||(N=!!C.enableCompoundKey),A=C.xhrTimeout,R=!!C.disableXhrSync,P=!!C.disableFetchKeepAlive,w=!1!==C.addNoResponse,L=!isReactNative(),H=new $g(I,k,F,N),isNullOrUndefined(C.useSendBeacon)||(L=!!C.useSendBeacon);var U=v,V=C.alwaysUseXhrOverride?v:null,B=C.alwaysUseXhrOverride?v:null,G=[3,2];if(!v){x=!1;var q=getLocation();q&&q.protocol&&"file:"===q.protocol.toLowerCase()&&(W=!1);var z=[];isReactNative()?(z=[2,1],G=[2,1,3]):z=[1,2,3],(v=_getSenderInterface(z=_prependTransports(z,C.transports),!1))||_warnToConsole(E,"No available transport to send events"),U=_getSenderInterface(z,!0)}V||(V=_getSenderInterface(G=_prependTransports(G,C.unloadTransports),!0)),M=!x&&(L&&isBeaconsSupported()||!P&&isFetchSupported(!0)),(O={})[0]=v,O[1]=U||_getSenderInterface([1,2,3],!0),O[2]=V||U||_getSenderInterface([1],!0),O[3]=B||_getSenderInterface([2,3],!0)||U||_getSenderInterface([1],!0),T=O},q._getDbgPlgTargets=function(){return[T[0],O,H,T]},q.addQueryStringParameter=function(g,m){for(var S=0;S<U.length;S++)if(U[S].name===g)return void(U[S].value=m);U.push({name:g,value:m})},q.addHeader=function(g,m){V[g]=m},q.canSendRequest=function(){return _hasIdleConnection()&&k.allowRequestSending()},q.sendQueuedRequests=function(g,m){isUndefined3(g)&&(g=0),G&&(g=_adjustSendType(g),m=2),_canSendPayload(B,g,0)&&_sendBatches(_clearQueue(),0,!1,g,m||0)},q.isCompletelyIdle=function(){return!N&&0===F&&0===B.length},q.setUnloading=function(g){G=g},q.addBatch=function(g){if(g&&g.count()>0){if(O.isTenantKilled(g.iKey()))return!1;B.push(g)}return!0},q.teardown=function(){B.length>0&&_sendBatches(_clearQueue(),0,!0,2,2)},q.pause=function(){N=!0},q.resume=function(){N=!1,q.sendQueuedRequests(0,4)},q.sendSynchronousBatch=function(g,m,S){g&&g.count()>0&&(isNullOrUndefined(m)&&(m=1),G&&(m=_adjustSendType(m),S=2),_sendBatches([g],0,!1,m,S||0))}}))}return HttpManager2.__ieDyn=1,HttpManager2}();function defaultSetTimeout(g,m){for(var S=[],v=2;v<arguments.length;v++)S[v-2]=arguments[v];return setTimeout(g,m,S)}function defaultClearTimeout(g){clearTimeout(g)}function createTimeoutWrapper(g,m){return{set:g||defaultSetTimeout,clear:m||defaultClearTimeout}}var Jg=.25,Yg=500,Qg=20,Xg=6,Zg=2,ep=4,tp=2,ip=1,np="eventsDiscarded",rp="overrideInstrumentationKey",sp="maxEventRetryAttempts",ap="maxUnloadEventRetryAttempts",op="addUnloadCb",lp=function(g){function PostChannel2(){var m,S=g.call(this)||this;S.identifier="PostChannel",S.priority=1011,S.version="3.2.9";var v,C,_,E,T,I,b,A=!1,R=[],P=null,M=!1,w=0,D=500,O=0,N=1e4,k={},L=Ku,F=null,x=null,U=0,V=0,B={},H=-1,$=!0,G=!1,j=Xg,q=Zg;return dynamicProto(PostChannel2,S,(function(g,S){function _hookWParam(g){var S=g.getWParam;g.getWParam=function(){var g=0;return m.ignoreMc1Ms0CookieProcessing&&(g|=2),g|S()}}function _handleUnloadEvents(g){"beforeunload"!==(g||getWindow().event).type&&(G=!0,C.setUnloading(G)),_releaseAllQueues(2,2)}function _handleShowEvents(g){G=!1,C.setUnloading(G)}function _addEventToQueues(g,m){if(g.sendAttempt||(g.sendAttempt=0),g.latency||(g.latency=1),g.ext&&g.ext[Eg]&&delete g.ext[Eg],g.ext&&g.ext[Tg]&&g.ext[Tg].id&&delete g.ext[Tg].id,$&&(g.ext=optimizeObject(g.ext),g.baseData&&(g.baseData=optimizeObject(g.baseData)),g.data&&(g.data=optimizeObject(g.data))),g.sync)if(U||M)g.latency=3,g.sync=!1;else if(C)return $&&(g=optimizeObject(g)),void C.sendSynchronousBatch(Ig.create(g.iKey,[g]),!0===g.sync?1:g.sync,3);var S=g.latency,v=O,_=N;4===S&&(v=w,_=D);var E=!1;if(v<_)E=!_addEventToProperQueue(g,m);else{var T=1,I=Qg;4===S&&(T=4,I=1),E=!0,_dropEventWithLatencyOrLess(g.iKey,g.latency,T,I)&&(E=!_addEventToProperQueue(g,m))}E&&_notifyEvents(np,[g],nc.QueueFull)}function _sendEventsForLatencyAndAbove(g,m,S){var v=_queueBatches(g,m,S);return C.sendQueuedRequests(m,S),v}function _hasEvents(){return O>0}function _scheduleTimer(){if(H>=0&&_queueBatches(H,0,T)&&C.sendQueuedRequests(0,T),w>0&&!x&&!M){var g=k[L][2];g>=0&&(x=_createTimer((function(){x=null,_sendEventsForLatencyAndAbove(4,0,1),_scheduleTimer()}),g))}var m=k[L][1];!F&&!P&&m>=0&&!M&&(_hasEvents()?F=_createTimer((function(){F=null,_sendEventsForLatencyAndAbove(0===V?3:1,0,1),V++,V%=2,_scheduleTimer()}),m):V=0)}function _initDefaults(){m=null,A=!1,R=[],P=null,M=!1,w=0,D=500,O=0,N=1e4,k={},L=Ku,F=null,x=null,U=0,V=0,v=null,B={},_=void 0,E=0,H=-1,T=null,$=!0,G=!1,j=Xg,q=Zg,I=null,b=createTimeoutWrapper(),C=new Kg(Yg,tp,ip,{requeue:_requeueEvents,send:_sendingEvent,sent:_eventsSentEvent,drop:_eventsDropped,rspFail:_eventsResponseFail,oth:_otherEvent},b),_initializeProfiles(),_clearQueues(),_setAutoLimits()}function _createTimer(g,m){0===m&&U&&(m=1);var S=1e3;return U&&(S=retryPolicyGetMillisToBackoffForRetry(U-1)),b.set(g,m*S)}function _clearScheduledTimer(){return null!==F&&(b.clear(F),F=null,V=0,!0)}function _releaseAllQueues(g,m){_clearScheduledTimer(),P&&(b.clear(P),P=null),M||_sendEventsForLatencyAndAbove(1,g,m)}function _clearQueues(){B[4]={batches:[],iKeyMap:{}},B[3]={batches:[],iKeyMap:{}},B[2]={batches:[],iKeyMap:{}},B[1]={batches:[],iKeyMap:{}}}function _getEventBatch(g,m,S){var v=B[m];v||(v=B[m=1]);var C=v.iKeyMap[g];return!C&&S&&(C=Ig.create(g),v.batches.push(C),v.iKeyMap[g]=C),C}function _performAutoFlush(m,S){C.canSendRequest()&&!U&&(_>0&&O>_&&(S=!0),S&&null==P&&g.flush(m,null,20))}function _addEventToProperQueue(g,m){$&&(g=optimizeObject(g));var S=g.latency,v=_getEventBatch(g.iKey,S,!0);return!!v.addEvent(g)&&(4!==S?(O++,m&&0===g.sendAttempt&&_performAutoFlush(!g.sync,E>0&&v.count()>=E)):w++,!0)}function _dropEventWithLatencyOrLess(g,m,S,v){for(;S<=m;){var C=_getEventBatch(g,m,!0);if(C&&C.count()>0){var _=C.split(0,v),E=_.count();if(E>0)return 4===S?w-=E:O-=E,_notifyBatchEvents(np,[_],nc.QueueFull),!0}S++}return _resetQueueCounts(),!1}function _resetQueueCounts(){for(var g=0,m=0,_loop_1=function(S){var v=B[S];v&&v.batches&&arrForEach(v.batches,(function(v){4===S?g+=v.count():m+=v.count()}))},S=1;S<=4;S++)_loop_1(S);O=m,w=g}function _queueBatches(m,S,v){var _=!1,E=0===S;return!E||C.canSendRequest()?doPerf(g.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var g=[],S=4;S>=m;){var v=B[S];v&&v.batches&&v.batches.length>0&&(arrForEach(v.batches,(function(m){C.addBatch(m)?_=_||m&&m.count()>0:g=g.concat(m.events()),4===S?w-=m.count():O-=m.count()})),v.batches=[],v.iKeyMap={}),S--}g.length>0&&_notifyEvents(np,g,nc.KillSwitch),_&&H>=m&&(H=-1,T=0)}),(function(){return{latency:m,sendType:S,sendReason:v}}),!E):(H=H>=0?Math.min(H,m):m,T=Math.max(T,v)),_}function _flushImpl(g,m){_sendEventsForLatencyAndAbove(1,0,m),_resetQueueCounts(),_waitForIdleManager((function(){g&&g(),R.length>0?P=_createTimer((function(){P=null,_flushImpl(R.shift(),m)}),0):(P=null,_scheduleTimer())}))}function _waitForIdleManager(g){C.isCompletelyIdle()?g():P=_createTimer((function(){P=null,_waitForIdleManager(g)}),Jg)}function _resetTransmitProfiles(){_clearScheduledTimer(),_initializeProfiles(),L=Ku,_scheduleTimer()}function _initializeProfiles(){(k={})[Ku]=[2,1,0],k[Ju]=[6,3,0],k[Yu]=[18,9,0]}function _requeueEvents(m,S){var v=[],C=j;G&&(C=q),arrForEach(m,(function(m){m&&m.count()>0&&arrForEach(m.events(),(function(m){m&&(m.sync&&(m.latency=4,m.sync=!1),m.sendAttempt<C?(setProcessTelemetryTimings(m,g.identifier),_addEventToQueues(m,!1)):v.push(m))}))})),v.length>0&&_notifyEvents(np,v,nc.NonRetryableStatus),G&&_releaseAllQueues(2,2)}function _callNotification(m,S){var v=g._notificationManager||{},C=v[m];if(C)try{C.apply(v,S)}catch(S){_throwInternal(g.diagLog(),1,74,m+" notification failed: "+S)}}function _notifyEvents(g,m){for(var S=[],v=2;v<arguments.length;v++)S[v-2]=arguments[v];m&&m.length>0&&_callNotification(g,[m].concat(S))}function _notifyBatchEvents(g,m){for(var S=[],v=2;v<arguments.length;v++)S[v-2]=arguments[v];m&&m.length>0&&arrForEach(m,(function(m){m&&m.count()>0&&_callNotification(g,[m.events()].concat(S))}))}function _sendingEvent(g,m,S){g&&g.length>0&&_callNotification("eventsSendRequest",[m>=1e3&&m<=1999?m-1e3:0,!0!==S])}function _eventsSentEvent(g,m){_notifyBatchEvents("eventsSent",g,m),_scheduleTimer()}function _eventsDropped(g,m){_notifyBatchEvents(np,g,m>=8e3&&m<=8999?m-8e3:nc.Unknown)}function _eventsResponseFail(g){_notifyBatchEvents(np,g,nc.NonRetryableStatus),_scheduleTimer()}function _otherEvent(g,m){_notifyBatchEvents(np,g,nc.Unknown),_scheduleTimer()}function _setAutoLimits(){E=m&&m.disableAutoBatchFlushLimit?0:Math.max(Yg*(tp+1),N/6)}_initDefaults(),g._getDbgPlgTargets=function(){return[C]},g.initialize=function(E,T,A){doPerf(T,(function(){return"PostChannel:initialize"}),(function(){var R=T;S.initialize(E,T,A);try{T[op];I=mergeEvtNamespace(createUniqueNamespace(g.identifier),T.evtNamespace&&T.evtNamespace());var P=g._getTelCtx();E.extensionConfig[g.identifier]=E.extensionConfig[g.identifier]||{},m=P.getExtCfg(g.identifier),b=createTimeoutWrapper(m.setTimeoutOverride,m.clearTimeoutOverride),$=!m.disableOptimizeObj&&isChromium(),_hookWParam(R),m.eventsLimitInMem>0&&(N=m.eventsLimitInMem),m.immediateEventLimit>0&&(D=m.immediateEventLimit),m.autoFlushEventsLimit>0&&(_=m.autoFlushEventsLimit),isNumber3(m[sp])&&(j=m[sp]),isNumber3(m[ap])&&(q=m[ap]),_setAutoLimits(),m.httpXHROverride&&m.httpXHROverride.sendPOST&&(v=m.httpXHROverride),isValueAssigned(E.anonCookieName)&&C.addQueryStringParameter("anoncknm",E.anonCookieName),C.sendHook=m.payloadPreprocessor,C.sendListener=m.payloadListener;var M=m.overrideEndpointUrl?m.overrideEndpointUrl:E.endpointUrl;g._notificationManager=T.getNotifyMgr(),C.initialize(M,g.core,g,v,m);var w=E.disablePageUnloadEvents||[];addPageUnloadEventListener(_handleUnloadEvents,w,I),addPageHideEventListener(_handleUnloadEvents,w,I),addPageShowEventListener(_handleShowEvents,E.disablePageShowEvents,I)}catch(m){throw g.setInitialized(!1),m}}),(function(){return{coreConfig:E,core:T,extensions:A}}))},g.processTelemetry=function(S,v){setProcessTelemetryTimings(S,g.identifier);var C=(v=g._getTelCtx(v)).getExtCfg(g.identifier),_=!!m.disableTelemetry;C&&(_=_||!!C.disableTelemetry);var E=S;_||A||(m[rp]&&(E.iKey=m[rp]),C&&C[rp]&&(E.iKey=C[rp]),_addEventToQueues(E,!0),G?_releaseAllQueues(2,2):_scheduleTimer()),g.processNext(E,v)},g._doTeardown=function(g,m){_releaseAllQueues(2,2),A=!0,C.teardown(),removePageUnloadEventListener(null,I),removePageHideEventListener(null,I),removePageShowEventListener(null,I),_initDefaults()},g.setEventQueueLimits=function(g,m){N=g>0?g:1e4,_=m>0?m:0,_setAutoLimits();var S=O>g;if(!S&&E>0)for(var v=1;!S&&v<=3;v++){var C=B[v];C&&C.batches&&arrForEach(C.batches,(function(g){g&&g.count()>=E&&(S=!0)}))}_performAutoFlush(!0,S)},g.pause=function(){_clearScheduledTimer(),M=!0,C.pause()},g.resume=function(){M=!1,C.resume(),_scheduleTimer()},g.addResponseHandler=function(g){C._responseHandlers.push(g)},g._loadTransmitProfiles=function(g){_resetTransmitProfiles(),objForEachKey(g,(function(g,m){var S=m.length;if(S>=2){var v=S>2?m[2]:0;if(m.splice(0,S-2),m[1]<0&&(m[0]=-1),m[1]>0&&m[0]>0){var C=m[0]/m[1];m[0]=Math.ceil(C)*m[1]}v>=0&&m[1]>=0&&v>m[1]&&(v=m[1]),m.push(v),k[g]=m}}))},g.flush=function(g,m,S){if(void 0===g&&(g=!0),!M)if(S=S||1,g)null==P?(_clearScheduledTimer(),_queueBatches(1,0,S),P=_createTimer((function(){P=null,_flushImpl(m,S)}),0)):R.push(m);else{var v=_clearScheduledTimer();_sendEventsForLatencyAndAbove(1,1,S),null!=m&&m(),v&&_scheduleTimer()}},g.setMsaAuthTicket=function(g){C.addHeader(vg,g)},g.hasEvents=_hasEvents,g._setTransmitProfile=function(g){L!==g&&void 0!==k[g]&&(_clearScheduledTimer(),L=g,_scheduleTimer())},g._backOffTransmission=function(){U<ep&&(U++,_clearScheduledTimer(),_scheduleTimer())},g._clearBackOff=function(){U&&(U=0,_clearScheduledTimer(),_scheduleTimer())},objDefineAccessors(g,"_setTimeoutOverride",(function(){return b.set}),(function(g){b=createTimeoutWrapper(g,b.clear)})),objDefineAccessors(g,"_clearTimeoutOverride",(function(){return b.clear}),(function(g){b=createTimeoutWrapper(b.set,g)}))})),S}return __extendsFn(PostChannel2,g),PostChannel2.__ieDyn=1,PostChannel2}(Ld),cp=lp,dp="_dropInst";function _copyObjProperties(g,m){if(m)for(var S=objKeys(m),v=0;v<S.length;v++){var C=S[v];hasOwnProperty(g,C)||(g[C]=m[C])}}function _isChannel(g){return g.pause&&g.teardown&&g.flush}function _getEndpointUrl(g,m){var S=null;if(m){m.endpointUrl&&(S=m.endpointUrl);var v=(m.extensionConfig||{})[g]||{};v.overrideEndpointUrl&&(S=v.overrideEndpointUrl)}return S}var hp=function(g){function ChildNotificationManager2(m,S){var v=g.call(this)||this;return dynamicProto(ChildNotificationManager2,v,(function(g,v){function _getEvents(g){var S=[];return g&&arrForEach(g,(function(g){g.iKey===m&&S.push(g)})),S}function _hasListeners(m){if(g[m]&&g.listeners)for(var S=0;S<g.listeners.length;S++){var v=g.listeners[S];if(v&&v[m])return!0}return!1}var C={eventsSent:function(m){if(_hasListeners("eventsSent")){var S=_getEvents(m);S.length>0&&g.eventsSent(S)}},eventsDiscarded:function(m,S){if(_hasListeners("eventsDiscarded")){var v=_getEvents(m);v.length>0&&g.eventsDiscarded(v,S)}},eventsSendRequest:function(m,S){_hasListeners("eventsSendRequest")&&g.eventsSendRequest(m,S)},perfEvent:function(m){_hasListeners("perfEvent")&&g.perfEvent(m)}};S.addNotificationListener(C)})),v}return __extendsFn(ChildNotificationManager2,g),ChildNotificationManager2.__ieDyn=1,ChildNotificationManager2}(qd),up=function(){function ApplicationInsightsManager2(){var g,m,S,v,C,_,E,T,I,b,A,R,P,M,w=null,D=null;dynamicProto(ApplicationInsightsManager2,this,(function(O){function _initDefaults(){g={},m=[],S=null,v=null,C=[],_=[],E={},T=null,I=null,b=null,A=null,R=null,P=null,M=!1}function _registerPlugin(m,S){if(void 0===S&&(S=null),m){(_isChannel(m)?_:C).push(m);var v=m.identifier;g.extensionConfig[v]=g.extensionConfig[v]||{},_copyObjProperties(g.extensionConfig[v],S)}return m}function _initializeSharedChannels(){var m=g.channels||[[]],S=new cp,v=S.identifier,C=!1;I=null,b=null,arrForEach(m,(function(g){arrForEach(g,(function(g){isFunction2(g)||(_registerPlugin(g),g.identifier===v&&(C=!0,I=g))}))})),C||(m[0].push(S),I=_registerPlugin(S,g.channelConfiguration)),g.channels=m}function _initializeSharedExtensions(S){m=[],T=_registerPlugin(new Nu,g.propertyConfiguration),m.push(T),g.extensions&&arrForEach(g.extensions,(function(g){isFunction2(g)||_registerPlugin(g)})),S&&arrForEach(S,(function(g){g&&!isFunction2(g)&&m.push(_registerPlugin(g))}))}function _initializeSharedInstance(C){if(!S){M||_throwInternal(O.diagLog(),2,520,"The Shared Manager is not yet created, the returned shared instance will be overwritten");var _=_createMergedConfig(C||g.instrumentationKey||"_not_defined_",{});v=new qd,(S=new gp(O,O.diagLog(),v)).initialize(_,m),S.isInitialized()&&I&&(b=_getEndpointUrl(I.identifier,_)),w&&S.setCookieMgr(w)}}function _createMergedConfig(m,S){var v={};return v.instrumentationKey=m,v.channels=_createMergedChannels(S),_populateMergedConfigExtensions(v),_copyObjProperties(v,S),_copyObjProperties(v,g),v}function _createMergedChannels(m){var S=[[]];return g.channels&&arrForEach(g.channels,(function(g,m){isFunction2(g)||(S[m]=S[m]||[],S[m]=S[m].concat(g))})),m&&m.channels&&arrForEach(m.channels,(function(g,m){isFunction2(g)||(S[m]=S[m]||[],S[m]=S[m].concat(g))})),S}function _populateMergedConfigExtensions(m){var S=[];g.extensions&&g.extensions.length>0&&(S=S.concat(g.extensions)),m&&m.extensions&&m.extensions.length>0&&(S=S.concat(m.extensions)),S.length>0&&(m.extensions=S),m.extensionConfig=m.extensionConfig||{},_copyObjProperties(m.extensionConfig,g.extensionConfig)}function _createMergedExtensions(g){var S=[];return m&&m.length>0&&(S=S.concat(m)),g&&g.length>0&&(S=S.concat(g)),S}function _unloadInstance(g,m,S,v){var C=E[g];C&&(C.inst&&C.inst.isInitialized()?C.inst.unload(m,(function(m){S&&S(g,m)}),v):S&&S(g,{reason:50,isAsync:m,flushComplete:!1}))}_initDefaults(),O.diagLog=function(){return A||(A=new Mc(g)),A},O.getCookieMgr=function(){return _initializeSharedInstance(),w||S.getCookieMgr()},O.setCookieMgr=function(g){w=g,S&&S.setCookieMgr(g)},O.getPerfMgr=function(){return P||g&&g.enablePerfMgr&&(P=D||new Lc(O.getNotifyMgr())),P},O.setPerfMgr=function(g){D=g,P=g},O.create=function(m,v){M?_throwInternal(O.diagLog(),2,514,"Shared Manager has already been initialized."):(g=m||{},S=null,_initializeSharedChannels(),_initializeSharedExtensions(v))},O.getInst=function(g){return(E[g]||{}).inst},O.newInst=function(g,m,C){var _=O.getInst(g);if(_)return _throwInternal(O.diagLog(),2,514,"Instance already exists for ["+g+"]"),_;if(_initializeSharedInstance(g),S.isInitialized()){var T=_createMergedConfig(g,m);if(I){var A=_getEndpointUrl(I.identifier,T);b&&A&&b!==A&&_throwInternal(O.diagLog(),2,511,"The endpointUrl mismatch, shared Url ["+b+"] is different from configured ["+A+"] shared will be used!")}var R=new hp(g,v);_=new gp(O,O.diagLog(),R),E[g]={iKey:g,inst:_,notifyMgr:R},_.setPerfMgr(O.getPerfMgr()),_.initialize(T,_createMergedExtensions(C)),_.isInitialized()||(_throwInternal(O.diagLog(),2,520,"Failed to initialize new instance!"),_=null,delete E[g])}return _},O.getSharedPlugin=function(g){_initializeSharedInstance();var m=null,v=S.getPlugin(g);return v&&(m=v.plugin),m},O.getPropertyManager=function(){return _initializeSharedInstance(),T},O.getPostChannel=function(){return _initializeSharedInstance(),I},O.getNotifyMgr=function(){return R||(R=new qd),R},O.unload=function(g,m,v){var C=objKeys(E),_=C.length+1,T={reason:50,isAsync:g,flushComplete:!1};function _doUnload(g,S){0===--_&&(_initDefaults(),m&&m(S))}S&&(arrForEach(C,(function(m){_unloadInstance(m,g,(function(g,m){_doUnload(g,m)}),v)})),S.isInitialized()&&(S.unload(g,(function(g){_doUnload(null,T=g)}),v),S=null)),_doUnload(null,T)},O[dp]=function(g){g&&E.iKey&&delete E[g]}}))}return ApplicationInsightsManager2.__ieDyn=1,ApplicationInsightsManager2}(),gp=function(g){function ApplicationInsights3(m,S,v){var C,_=g.call(this)||this,E=m;return dynamicProto(ApplicationInsights3,_,(function(g,m){g.getSharedPropertyManager=function(){return E.getPropertyManager()},g.getSharedPostChannel=function(){return E.getPostChannel()},g.getOverridePropertyManager=function(){return C},g.initialize=function(_,E){doPerf(g,(function(){return"ApplicationInsights:initialize"}),(function(){var T=[C=new zu];E&&(T=T.concat(E)),_.extensionConfig=_.extensionConfig||[];var I=_.propertyConfiguration||{};_.propertyConfiguration&&delete _.propertyConfiguration,_.extensionConfig[C.identifier]=I;try{m.initialize(_,T,S,v)}catch(m){_throwInternal(g.logger,1,514,"Failed to initialize SDK."+dumpObj(m))}}),(function(){return{config:_,extensions:E}}))},g.unload=function(S,v,C){E[dp]&&E[dp]((g.config||{}).instrumentationKey),m.unload(S,v,C)}})),_}return __extendsFn(ApplicationInsights3,g),ApplicationInsights3.__ieDyn=1,ApplicationInsights3}(Eh);function getPlatformConfig(){const g=getBrowserInfo();return"ChromiumAVD"===g.engine?new fp:"Safari"===g.engine?new Sp(g):"Firefox"===g.name?new vp:isVdiPlatform()?new Cp:"Chromium"===g.engine?new _p(g):new pp}var pp=class{getInitialSettings(){return{resizeModeForSharing:"none",enableAudioProcessingFallback:!1,allowVirtualDeviceInCall:!1,activeSpeaker:{timeToPromote:1e4},dtmf:{toneDuration:200,toneGap:100},mediaStreamHoldInterval:5e3,webrtcContributingSourcesPollingInterval:1e3,webrtcIceGatheringTimeoutMs:2e4,webrtcAllowedMediaContentType:Ke.ALLOWED_CONTENT_TYPES.SDP_NGC,webrtcMediaContentType:Ke.CONTENT_TYPE.SDP,webrtcScreensharingCapabilityMaxFS:8160,webrtcScreensharingCapabilityMaxFPS:1500,webrtcStatHwSilentDetectionDuration:5,webrtcStatHwSilentDetectionLevel:14,webrtcStatPollInterval:1e3,webrtcStatStoredRecordsNumber:60,webrtcStatNetworkDetectionDuration:10,webrtcHealedRatioExtendedWindowSize:20,webrtcStatNetworkDetectionHysteresis:.01,webrtcStatNetworkDetectionBadLevel:.17,webrtcStatNetworkDetectionGoodLevel:.15,webrtcMinAudioSamplesRecvForNetworkRecvQuality:48e4,webrtcVideoCapabilityCheckIntervalMin:2e4,webrtcVideoCapabilityCheckIntervalMinMultiparty:5e3,webrtcVideoCapabilityCheckIntervalMax:3e4,webrtcVideoCapabilityCheckIntervalMaxMultiparty:5500,webrtcScreensharingCapabilityCheckIntervalMin:0,webrtcScreensharingCapabilityCheckIntervalMax:0,webrtcVideoCapabilityMaxFS:3600,webrtcVideoCapabilityMaxFPS:3e3,webrtcMultiPartyRecvVideoMaxFS:3600,webrtcRecvVideoMaxFS:8160,webrtcCameraOpenFs:3600,minCameraOpenFps:15,maxCameraOpenFps:30,webrtcMultipartyMaxScalingFs:3600,webrtcMaxScalingFs:8160,webrtcVideoScaling:!1,webrtcVideoScalingMultiparty:!0,enableOptimalVideoCount:!1,ovcBandwidthPerVideoReceiver:2e5,ovcSlidingWindowPercentile:.3,ovcSlidingWindowSamples:20,nonEstimatedDefaultVideoReceiversCount:4,ovcMaxCount:4,ovcMaxCountXL:4,ovcXLParticipantsCount:100,ovcIgnoreFirstSamples:10,ovcAvailableConcurrencyForBiggerGrid:4,ovcMemoryForBiggerGrid:2,ovcRampUpCooldown:15e3,ovcRampDownCooldown:1e4,webrtcStatNetworkDetectionEnabled:!0,webrtcUseNewStatsApi:!0,useAudioAnalyzer:!0,webrtcVideoSubscriptionDisposeTimeout:2e3,webrtcCompareContentTypeInOffer:!0,iceServerTransport:"udp,tcp,tls",iceHostCandidateOnly:!0,iceUdpAddressType:"ip",iceTcpAddressType:"ip",renegotiationAttempts:3,reconnectTimeLimit:9e4,initialReconnectTimeLimit:0,maxReconnectDelayTime:5,waitForRelayOnReconnect:!0,relayWaitSaneTimeoutMs:25e3,reconnectOnDisconnect:!1,reconnectWithNoRelays:!1,reconnectWithProbes:!1,reconnectWaitTimeAfterProbe:1e3,reconnectOnPcClose:!0,reconnectWakeupTimeLimit:18e4,webrtcSpeakingWhileMutedBadDuration:3,webrtcSpeakingWhileMutedDetectionLevel:4e3,webrtcNegotiateDisabledDataModality:!1,recoverableMediaErrors:[Ke.MEDIA_ERROR.iceConnectionError,Ke.MEDIA_ERROR.noNetworkError,Ke.MEDIA_ERROR.srtpError,Ke.MEDIA_ERROR.incompatibleOffer,Ke.MEDIA_ERROR.internalError].join(","),forceReconnectErrors:[Ke.MEDIA_ERROR.audioPlaybackError].join(","),sendCallStartupTelemetry:!0,webrtcMultiPartyRecvVideoSignaling:!0,webrtcVideoDelayThreshold:10,webrtcEndOfCallFreezeThreshold:3,webrtcSubscriptionEventLimit:300,webrtcHandleRollback:!0,webrtcHandleRemoteRollback:!1,losingConnectivityTimeoutMs:-1,iceCandidateFilterMDns:!0,webrtcInjectTransportCCAudio:!1,webrtcInjectTransportCCAudioMultiparty:!0,webrtcRejectedFeatures:"byPass",webrtcRequiredFeatures:"nonByPass",webrtcSimulcastSessionEnabled:!1,webrtcSimulcastStreamsCountForVideo:1,webrtcSimulcastStreamsCountForSharing:1,webrtcFmtParamListSupported:!0,webrtcNegotiatedSsrcRangeForVideo:0,webrtcNegotiatedSsrcRangeForSharing:0,webrtcNegotiatedSsrcRangeForVideoOneToOne:0,webrtcNegotiatedSsrcRangeForSharingOneToOne:0,webrtcAllowRestoreKeyframe:!1,webrtcEnabledCustomBwEstimationForVideo:!1,webrtcDisabledSenderBitrate:1e3,maxStoredPreferredResolutionCount:4,maxStoredQualityLimitationReasonEvents:30,maxStoredUFDCount:50,simulcastTelemetryLayoutsPerSession:5,simulcastTelemetryNumModalitySessions:3,simulcastTelemetryNumFMTP:10,maxSendVideoCapabilitiesReportingForVideoEnabled:!1,maxSendVideoCapabilitiesReportingForSharingEnabled:!1,maxSendVideoCapabilitiesReportingUseMaximumWidthHeight:!0,maxSendVideoCapabilitiesReportingSendMaxFs:!1,maxSendVideoCapabilitiesReportingSendMaxMbps:!1,maxReportedOvershootingEvents:20,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!0,adpRequestAVLast:!0,rememberNegative:!1,persistOnDeniedError:!0,disableOnPermissionDeniedOnly:!1},devices:{blacklist:{microphone:"stereo mix \\(",camera:"(ir camera|avstream media device)",speaker:"stereo mix \\("},overrideDefault:!1,compositeLabelMatchingThreshold:.5,piiSafeWords:["airpod","bluetooth","hands-free","stereo","wireless","citrix hdx","remote audio","vmware","built-in","integrated","internal","teams","high definition","facetime","macbook","smartaudio","front","rear","back","iphone","ipad","display","displayport","dp","hdmi","amd","nvidia","intel","analog","digital","dock","line( in| out)?","s/pdif","external","thunderbolt\\d*","usb","panoramic","desktop","capture","cable","cam","virtual","manycam","snap camera","obs","vb-audio","vaio","effect","sink","source","default","test"],pollingIntervalActive:3e3,enumerateDevicesTimeout:25e3,enumerateDevicesAfterADP:!1},useGoogPrefixAudioConstraints:!0,multiviewResolutionLimits:{1:720,2:720,3:540,4:360,more:360},maxSpotlightResolution:720,multiviewResolutionLimitUpdateThrottleDelay:300,useMultiviewLimitsOnInitialRequest:!0,useApplyChannelParametersForSourceRequests:!1,maxVideoFreezeTimestampsInBucket:5,webrtcSendBandwidthNotificationsEnabled:!1,webrtcSendBandwidthIgnoredUpdateLimit:6,webrtcSendBandwidthThreshold:.1,checkSupportForWebrtc_1_0:!1,webrtcLastAppliedVideoCapabilitiesCount:5,webrtcLastAppliedVideoCapabilitiesSequenceCount:5,gumRequestTimeout:2e4,overrideGumFromWebkit:!1,setMinFpsForWebkit:!1,videoCaptureFreezeTimeout:5e3,webrtcCloseAfterIceFailure:!0,audioBandwidthInKbps:90,videoBandwidthAllocation:.3,enableQosSupport:!1,forceUnbundledTransport:!1,allowedAudioCodecs:[],allowedVideoCodecs:[],allowedVideoCodecsMultiparty:[{clockRate:9e4,mimeType:"video/H264"},{clockRate:9e4,mimeType:"video/rtx"}],filterCodecsInSdp:!1,filterCodecsInSdpMultiparty:!0,filterCodecsInSdpV2:!1,reduceRtcpFbInSdp:[],reduceRtcpFbInSdpMultiparty:["goog-remb","transport-cc","ccm/fir","nack","nack/pli"],subscribeToSsrcForVideo:!1,audioRendererUsePauseOnDetach:!0,audioRendererRestartOnPause:!1,audioRendererRestartOnDeviceError:!0,disableAudioOutputSelection:!1,preferSdesSrtp:!1,preferSdesSrtpPstn:!1,useLocalStorageForOneDs:!0,useOneDsLogger:!1,useSendBeaconSync:!1,addTelemetryReportingCallback:!0,eventsLimitInMem:200,eventLatency:ch.Normal,eventLatencyRealTime:ch.RealTime,enableCompoundKey:!1,telemetryTenants:{signaling:"53fdaa090eb946b5a1d6cbdeb4f2ef66-bcbf6380-2590-41cc-ae60-9e467cd51835-7413",media:"1cae5691997646c98b01d15beddae7a3-ce16e198-bc32-420f-ac64-42bb916111af-6865",realtimeMedia:"5aea257f81424f5d8574e57a50974ead-d3a768ce-590c-4595-ab85-3dd046114290-6701",tlePlayer:"2efdf03d07594586a5977c404e185186-71b046c4-f48f-4ba7-96d3-2a74b54e1d46-7326"},transmitProfileName:"REAL_TIME",transmitProfileTimings:[],waitReportStatsAtCallStop:!1,oneStreamPerDeviceType:!1,enableWebRtcInternalsLogs:!1,enableMultiViewStats:!0,webrtcBWJumpLowerLimit:1e5,webrtcBWJumpUpperLimit:3e5,uplinkBWStabilizationSlidingWindowSize:10,uplinkBWStabilizationMaxDeviation:.1,uplinkBWStabilizationMinBandwidth:1e5,downlinkBWStabilizationSlidingWindowSize:10,downlinkBWStabilizationMaxDeviation:.1,downlinkBWStabilizationMinBandwidth:1e5,maxKeyFrameTimestampsInBucket:5,enableAudioSharing:!1,enableStopSharingWithIncomingOffer:!0,enableDevtoolsAPI:!1,enableDataChannel:!1,enableDataChannelMultiparty:!0,enableDataChannelPstn:!1,alwaysNegotiateDataChannel:!0,webrtcDataChannel:{enableFragmentation:!1,fragmentationSize:0,enableSendScheduler:!1,rateLimiterCheckInterval:250,discardOnSendFailure:!1,bufferedAmountLowThreshold:65535,bufferedAmountHighThreshold:262144,maxBitrate:0,maxPacketRate:0,maxQueueSize:524288,dataIds:[]},acceptDisabledDataModality:!0,rejectUnbundledDataModality:!0,sctpPort:5e3,enableGiveControl:!1,maxStoredDataChannelValues:15,mediaControlPlaneConfig:{enableBweNotifications:!0,enableDominantSpeakerHistory:!0,enableSourceRequests:!1,sourceRequestsMessagesTimeout:1e4,storedSRRecordsCount:60,verboseTelemetry:!1,sendDuplicates:!1},localPreviewMirroringSupported:!1,enableVideoEffects:!0,useRawMediaApiForVideoEffects:!1,forceKeyFrameV2ScaleFactor:1.1,effectsTelemetryBufferSize:20,wasmdns:{pTime:10,goodPerfThreshold:8,poorPerfThreshold:10,badPerfThreshold:12,perfWindowLength:10,enableNoiseSuppression:!1,noiseSuppressionMode:"Off",backgroundMode:!1},wasmvqe:{enableAec:!1,enableVqe:!1,backgroundMode:!1,performanceThresholdMs:8,performanceWindowDurationSecs:10,defaultVqeMode:xn.VqeMode.Off,callType:xn.CallType.Conference,audioUsageMode:xn.AudioUsageMode.Default,performanceProfile:xn.AecPerfProfile.Normal},webcv:{qualityConfig:{outputFps:{min:15,max:30},outputResolution:720,preserveResolution:!0,degradationLadder:[{resolution:{width:1920,height:1080},fps:{min:15,max:30}},{resolution:{width:1280,height:720},fps:{min:15,max:30}},{resolution:{width:960,height:540},fps:{min:15,max:30}},{resolution:{width:640,height:360},fps:{min:13,max:30}},{resolution:{width:416,height:234},fps:{min:10,max:20}},{resolution:{width:320,height:180},fps:{min:10,max:20}}],initialLadderResolution:720,improvementFpsThresholdPercent:20,statsIntervalSec:5,enableMaskPropagation:!1,maskPropagationFramesInterval:30},powerPreference:Fn.PowerPreference.HighPerformance,useInsertableStreams:!1,webGLUnsupportedRenderers:["Google SwiftShader"],webGLRequiredExtensions:["EXT_color_buffer_float","WEBGL_debug_renderer_info","OES_texture_float_linear"],usePreheat:!1,useSharedArrayBuffer:!0,useWasmEffects:!1,processorType:Fn.ProcessorType.Webgl2},insertFakeCandidateIfNeeded:!0,useSdpCapabilitiesLegacySession:!0,useSdpCapabilities:!0,enableH264SpsPpsIdrKeyframe:!0,disableMsSdp:!1,disableSdes:!1,disableIceReinvite:!1,iceDisconnectedTimeoutMs:3e4,enableLocalVideoConstraints:!0,webrtcAudioChannelSignalingFeedback:"app recv:dsh",webrtcVideoChannelSignalingFeedback:"app send:src recv:src,vc",webrtcResolutionManagerCooldownTimeout:15e3,webrtcResolutionManagerRetryDelay:5e3,webrtcNativeCpuOveruseDisabled:!1,webrtcDisplayStreamContentHint:"text",h264SendProfileOverride:"42C02A",addFmtpToInitialSubscription:!0,h264SubscribeProfile:"64001f",notRenderingTimeInterval:{video:3,sharing:10},notRenderingLowBitrateThreshold:6,notRenderingLowFramerateThreshold:3,isBytesRecvUsedInIsRenderingCalculation:!0,useConnectionState:!0,useDtlsTrasportConnectionCheck:!1,enableNetworkRecvQualityUFD:!0,enableNetworkSendQualityUFD:!0,enableSignalingAudioPermissionDeniedUFD:!1,webrtcJitterLowThreshold:.2,webrtcJitterHighThreshold:.35,webrtcJitterSticknessTime:5e3,webrtcLossRateLowThreshold:.2,webrtcLossRateHighThreshold:.3,webrtcLossRateSticknessTime:5e3,webrtcMinPacketsSentForNetworkSendQuality:200,webrtcLossRateWindowSize:3,webrtcJitterWindowSize:3,networkSendQualityDiagnostics:!1,networkRecvQualityDiagnostics:!1,webrtcJitterExtendedWindowSize:6,webrtcLossRateExtendedWindowSize:6,freezeMinDuration:128,freezeIntervalFrequency:1e3,minPacketsReceivedToCalculatePacketLossRate:100,healedRatioPrecision:8,jitterPrecision:3,requestNewStreamOnUnmute:!0,raiseVideoMuteUfd:!1,useMediaQualityController:!1,useMediaQualityControllerForceKeyFrame:!1,layoutControlTimeout:1e4,extmapAllowMixed:!1,enableVla:!1,allowRemoteVla:!1,enableNonAdvVla:!1,specCompliantSimulcast:{},specCompliantSimulcastMultiparty:{video:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1],minFsForSimulcast:920,useApplyConstraints:!1},sharing:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1]},allowOverride:!1,constraintsDisableVla:!0,collectResolutionInfo:!0,maxBrControlEnabled:!1,allowedBweOvershootRatio:1,allowResLimit:!1},enforceOpusFmtpMultiparty:{usedtx:1},videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!1,mapSsrcToTrackForStats:!1,enableVideoOrientationExtension:!1,speakerGainLevel:0,ignoreClosedDtlsTransportState:!1,disconnectOnPageHide:!0,renderThroughCanvas:!1,isRenderingBasedOnRawStatistics:!1,enableDevicePixelRatio:!0,useSetParametersToApplyCapabilities:!1,enablePlatformCallConstraints:!1,enablePlatformCallConstraintsPerCall:!1,enableDynamicCallConstraints:!0,numCallConstraintsEvents:6,setParametersMaxBitrateUndefined:!1,onAddTrackRemoveOtherTracks:!0,avoidFakeStreamsDuringEscalation:!0,navConnectionPollingInterval:1e3,navConnectionNumSamplesToCollect:60,allowProvisionalAnswer:!1,allowProvisionalAnswerPstn:!0,acceptProvisionalAnswerFromPstnOnly:!0,disableIncomingDtlsRoleOverride:!1,disableOutgoingDtlsRoleOverride:!1,statsAllowAnyVideoSendTrack:!1,pictureInPicture:{enablePictureInPicture:!1,aspectRatioHorizontal:16,aspectRatioVertical:9,maxActiveStreams:1,minStreamGridCellWidth:160,dominantStreamChangeDebounce:3e3,statisticsBufferSize:20,multiStreamWorkerURL:""},showStatsInCall:!1,useSetStreamsForSender:!0,addPrefixForMsidInSdp:!1,enableMuteSpeakerUnmuteSpeakerWorkaround:!1,alwaysRaiseBadDeviceEvents:!1,removeRecvStreamOnEnded:!0,requiredVideoCodecs:["h264"],primaryVideoCodecs:["h264","vp8","vp9"],removeUnsupportedVideoModality:!1,enableActiveSpeakerBasedDSH:!0,enableInitialSignalingDSHSubscription:!0,enableSignalingDSHFallback:!1,emptyInitialDSH:!0,bwPercentiles:[5,50,95],enableTimerTracker:!1,diagnostics:{sideBySide:!0,useForTelemetry:!1,collectWhileNotConnected:!1,collectionLimits:{numDeviceEvents:200,numVideoEffectsEvents:100,numAudioEffectsEvents:100,numOvershootEvents:100,numIsRenderingEvents:100,numStatsReports:600,numStatsErrors:100,numSubscriptionEvents:100,numUFDs:100,numNativeSessions:3,numSessions:3,numNetworkEvents:50,numReconnects:50,numCapabilitiesRequested:60,numCapabilitiesApplied:60,maxVideoStatsAfterSubscription:30,numResolutionSwitches:10,numSamplesForE2E:4},telemetryLimits:{numDeviceEvents:50,numVideoEffectsEvents:50,numAudioEffectsEvents:50,numOvershootEvents:20,numIsRenderingEvents:4,numPreferredResolutions:3,numSubscriptionEvents:100,numUFDs:50,numAggregatedSamples:60,numStatsErrors:20,numCapabilitiesRequested:5,numCapabilitiesApplied:3,maxVideoStatsAfterSubscription:30,numNetworkEvents:20,numReconnects:10,numRendererStateChangedEvents:10},teamsRealtimeTelemetry:{pollingInterval:15},performanceMonitoring:{useComputePressure:!1,fluctuationSamplesNum:5,enableRemoteVideoCalculator:!1,enableLowerResolution:!1,monitoringStrategy:"decodeTime",decodeThresholds:{1080:{fps:30,maxDecodeTime:20},720:{fps:30,maxDecodeTime:15},540:{fps:30,maxDecodeTime:11},360:{fps:30,maxDecodeTime:9},234:{fps:15,maxDecodeTime:10},180:{fps:15,maxDecodeTime:10}},defaultThrehold:{fps:30,maxDecodeTime:60},fpsDiffThresholds:{1080:{fps:30,fpsDiff:4},720:{fps:30,fpsDiff:4},540:{fps:30,fpsDiff:4},360:{fps:30,fpsDiff:4},234:{fps:15,fpsDiff:2},180:{fps:15,fpsDiff:2}},defaultFpsDiffThreshold:{fps:30,fpsDiff:10},volatilityThresholds:{1080:10,720:10,540:10,360:10,234:5,180:5},defaultVolatilityThreshold:10,remoteVideoTrackInterval:10,telemetryResolutionRequestSpanMs:5e3,cpuMetricCollector:3},features:{takeFreezeTelemetryFromGathererV2:!0,useLastSampleDeltaPerSecondConverter:!1,useNewerStatisticsMetrics:!1}},requireUserActionForAudioSharing:!1,postponeAudioMixerForAudioSharing:!1,reassignMediaStreamAudioTrackAfterCreation:!1,deactiveAudioSender:!1,webrtcForceSdesForS1:!1,webrtcPranswerWaitForMediaPollingInterval:1e3,webrctRemoveVideoModalitiesForPstn:!1,removeSendersOnConfigureModalities:!0,streamAvailabilityConsiderModalities:!1,setBWSeed:!1,bwSeedOptions:{mids:["*"],aggregation:"const",aggregateLastN:null,constValue:-1,cappingValue:-1,useLocalStorage:!1,localStorageKey:"bwSeed"},stopCallOnAcceptFailure:!0,allowMediaBypass:!0,enablePermissionsWorkaround:!1,disposeSendersSync:!1,disposeStreamsSync:!1,maxVideoStatsAfterSubscription:30,ecsConfigTimeout:2e4,contributingSourcesLogInterval:1e4,useNewTokenApi:!1,audioRendererFailedReconnectTimes:0,audioRendererFailedRetryCodes:[3],effectsApplyConstraintsRetryMs:1e3,isSpotlightEnabled:!0,addAudioStreamBeforeConnection:!1,redReceiveEnabled:!1,mediaEventDictionary:Ke.MEDIA_EVENT_FIELDS,useSenderV2:!0,applySenderParamsBeforeStart:!1,reuseLastSetParameters:!1,hevcCodecs:["hev1.1.6.L120.90","hev1.1.4.L93.B0","hev1.1.6.L93.B0"],useInactiveAudioTrack:!1,enableRollbackHandler:!1,disableImmidiateEscalationReconnect:!1,enableCachingFMTP:!0,setDisconnectAfterCleanUp:!1,sendResolutionTableOverride:Ke.RES_TABLE.SEND,recvResolutionTableOverride:Ke.RES_TABLE.RECV,maxSendVideoCapabilitiesReportingForVideoEnabledMultiparty:!0,participantStreamInitialSubscriptions:!0,holdRetryActivationDelay:-1,holdSkipActivation:!0,recoverOnStreamUnmute:!1,isAv1Allowed:!1,audioSharingMemoryLeakFix:!0,h264SdpProfileMultiparty:"64001f",rejectIncompatibleOriginator:!1,coeffOfValidTimeDelayBetweenFramesArrival:2,invalidFPSAboveMax:40,useWakeLockApi:!1,noRequiredCodecsWorkaround:!1,vdiDisconnectedTracking:{enabled:!0,clientPhrases:["failure"]},multiStreamSupported:!1}}getEnforcedSettings(){return{}}},mp=class extends pp{getInitialSettings(){const g=super.getInitialSettings();return g.oneStreamPerDeviceType=!0,g.removeUnsupportedVideoModality=!0,g}},fp=class extends pp{constructor(){super()}getEnforcedSettings(){return{useAudioAnalyzer:!1,enableAudioSharing:!1}}},Sp=class extends mp{constructor(g){super(),this.browserInfo=g}getEnforcedSettings(){const g={webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!1,adpRequestAVLast:!1,rememberNegative:!1},devices:{pollingIntervalIdle:1e4},audioRendererRestartOnPause:!0,subscribeToSsrcForVideo:!0,noRequiredCodecsWorkaround:!0};return isVersionGreaterOrEqual(this.browserInfo.version,"15.0")||(g.statsAllowAnyVideoSendTrack=!0),isVersionGreaterOrEqual(this.browserInfo.version,"16.0")&&"Mobile"===this.browserInfo.formFactor&&(g.enablePermissionsWorkaround=!0),isVersionGreaterOrEqual(this.browserInfo.version,"17.0")&&"Mobile"===this.browserInfo.formFactor&&(g.recoverOnStreamUnmute=!0),g}},vp=class extends mp{getEnforcedSettings(){return{webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useDtlsTrasportConnectionCheck:!0,videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!0,mapSsrcToTrackForStats:!0,ignoreClosedDtlsTransportState1on1:!0,subscribeToSsrcForVideo1on1:!0,devices:{enumerateDevicesTimeout:0,pollingIntervalIdle:1e4,idlePollingOnStart:!0},webrtcInjectTransportCCAudioMultiparty:!1,videoCaptureFreezeTimeout:0,filterCodecsInSdp:!0,useSetParametersToApplyCapabilities:!0,removeRecvStreamOnEnded:!0,webrtcDisabledSenderBitrate:0,disableAudioOutputSelection:!0}}},Cp=class extends pp{constructor(){super()}getEnforcedSettings(){return{checkSupportForWebrtc_1_0:!0,requireUserActionForAudioSharing:!0,webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useAudioAnalyzer:!1,enablePlatformCallConstraints:!0,specCompliantSimulcastMultiparty:{video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!1,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0,allowOverride:!0},extmapAllowMixedMultiparty:!0,enableVlaMultiparty:!0,allowRemoteVlaMultiparty:!0,enableNonAdvVlaMultiparty:!0,useMediaQualityControllerMultiparty:!0,useSdpCapabilities:!1}}},_p=class extends mp{constructor(g){super(),this.browserInfo=g}getEnforcedSettings(){const g={};return isVersionGreaterOrEqual(this.browserInfo.version,"74.0")&&(g.webrtcSimulcastSessionEnabled=!0,g.webrtcAllowRestoreKeyframe=!0,g.enableAudioSharing=!0),"RoomAudioProcessing"===this.browserInfo.formFactor&&(g.defaultAudioProcessingFlags=0,g.wasmvqe={enableAec:!1,enableVqe:!1,backgroundMode:!1},g.wasmdns={enableNoiseSuppression:!1,backgroundMode:!1}),"CiscoOS"===this.browserInfo.name&&(g.waitReportStatsAtCallStop=!0),"Mobile"===this.browserInfo.formFactor&&(g.enableAudioSharing=!1,g.audioRendererFailedReconnectTimes=3,g.devices={pollingIntervalIdle:1e4}),"SamsungTV"===this.browserInfo.name&&(g.useSetParametersToApplyCapabilities=!0),isVersionGreaterOrEqual(this.browserInfo.version,"98.0")&&"Desktop"===this.browserInfo.formFactor&&(g.specCompliantSimulcastMultiparty={video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!0,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0},g.extmapAllowMixedMultiparty=!0,g.enableVlaMultiparty=!0,g.allowRemoteVlaMultiparty=!0,g.enableNonAdvVlaMultiparty=!0,g.useMediaQualityControllerMultiparty=!0),isVersionGreaterOrEqual(this.browserInfo.version,"100.0")&&(g.redReceiveEnabledMultiparty=!0),g.webcv={useWasmEffects:!0,processorType:Fn.ProcessorType.Wasm},g}},yp=class{constructor(g){this.settings=g,this.isTransportUnbundled=!1,this.webrtcRejectedFeatures="",this.webrtcRequiredFeatures="",this.spatialAudioEnabled=!1,this._maxBandwidthInKbps=0,this._noiseSuppressionMode="Auto",this._enableMediaBypass=!1,this.audioContext={enabledLocally:!1,disabledRemotely:!1,enabledForSend:!1,initFailed:!1,initSendFailed:!1,codec:"None",lastUsedCodec:"None"}}setMediaConfiguration(g,m){this.maxBandwidthInKbps=Math.floor((g.maxBandwidthInBps||0)/1e3),this.isTransportUnbundled=this.settings.forceUnbundledTransport||this.settings.enableQosSupport&&(g.enableMediaQoS||!!g.mediaPortRanges),this._mediaPortRanges=g.mediaPortRanges,this.simulcastSessionEnabled=this.settings.webrtcSimulcastSessionEnabled&&canUseWebrtc1_0(this.settings.checkSupportForWebrtc_1_0),this._noiseSuppressionMode=g.noiseSuppressionMode||"Auto",this._enableMediaBypass=this.settings.allowMediaBypass&&g.enableMediaBypass,this.webrtcRejectedFeatures=this._enableMediaBypass?"":this.settings.webrtcRejectedFeatures,this.webrtcRequiredFeatures=this._enableMediaBypass?"":this.settings.webrtcRequiredFeatures,this.spatialAudioEnabled=m?m.spatialAudioEnabled:g.enableSpatialAudio}get mediaBypassEnabled(){return this._enableMediaBypass}get noiseSuppressionMode(){return this._noiseSuppressionMode}get maxBandwidthInKbps(){return this._maxBandwidthInKbps}set maxBandwidthInKbps(g){this._maxBandwidthInKbps=g,this.settings.maxBandwidthInKbps&&(this._maxBandwidthInKbps=Math.min(this.settings.maxBandwidthInKbps,this._maxBandwidthInKbps||Number.MAX_SAFE_INTEGER))}get audioPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.audioMin&&this._mediaPortRanges.audioMax)return{min:this._mediaPortRanges.audioMin,max:this._mediaPortRanges.audioMax}}get videoPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.videoMin&&this._mediaPortRanges.videoMax)return{min:this._mediaPortRanges.videoMin,max:this._mediaPortRanges.videoMax}}get audioCodecContext(){return this.settings.useInsertableStreams?.audioWasmCodec?.enable?this.audioContext:void 0}};function arrayMergeCustomizer2(g,m){if(Array.isArray(g))return m.slice()}var Ep=class extends je{constructor(g,m,S={}){super(g),this.logger=g,this.platformCallConstraintsProvider=m,this.platformConfig=getPlatformConfig(),this.sessionCount=0,this._consoleOverrides={},this.uaConfig=new Vs(this),this.mediaConfiguration={},this.configReceivedDefer=defer4(),this.initialSettings=(0,ya.mergeWith)({},(0,ya.cloneDeep)(this.platformConfig.getInitialSettings()),(0,ya.cloneDeep)(S),this.platformConfig.getEnforcedSettings(),arrayMergeCustomizer2),this.settings=this.initialSettings,this.settingsWithoutOverrides=this.initialSettings,this.stackSettings=(0,ya.cloneDeep)(S),this.mediaSettings=new yp(this.settings),this.platformCallConstraintsProvider.changed((()=>{this.updateSettings();const g=this.platformCallConstraintsProvider.constraints,m=this.logger.createChild("SettingsToCallConstraintsConverter"),S=convertSettingsToCallConstraints(m,this.settings,g);this.platformCallConstraintsProvider.addCallConstraintsTelemetryEvent(S,"applied")})),this.configReceivedTimeout=window.setTimeout((()=>{this.configReceivedTimeout=void 0,this.configReceivedDefer.resolve()}),this.settings.ecsConfigTimeout),this.logger.safe.info("Initialized")}getCallConstraints(){return this.platformCallConstraintsProvider.constraints}setCallConstraints(g){return this.platformCallConstraintsProvider.setConstraints(g),g}getCallConstraintsTelemetry(){return this.logger.error("Not supported globally, returning empty array"),[]}addCallConstraintsTelemetryEvent(g,m){this.logger.error("Not supported globally")}getIceTransportPolicy(){return this.logger.warn(`Not supported globally, returning default ${Ke.ICE_TRANSPORT_POLICY.all}`),Ke.ICE_TRANSPORT_POLICY.all}setIceTransportPolicy(g){this.logger.error("Not supported globally")}getConfigReceivedOrTimeout(){return this.configReceivedDefer.promise}getConfigView(g,m){const S=g?"Multiparty":"1on1",v=Object.entries((0,ya.cloneDeep)(this.settings)).reduce(((g,[m,v])=>(g[m]=v,m.endsWith(S)&&(g[m.replace(S,"")]=v),g)),{}),C=new yp(v);return C.setMediaConfiguration(this.mediaConfiguration,m?.mediaConfig),new Ra(this.logger.createChild("ConfigProviderView"),v,C,this.userAgentConfig,this.countryCode,this.platformCallConstraintsProvider,m?.getCallConstraints())}updateConfig(g,m,S,v){this.etag=m||this.etag,this.configIds=S||this.configIds,this.country=v||this.country,this.event("newConfigReceived").raise(g,m,S),this.settingsWithoutOverrides=(0,ya.mergeWith)({},this.settingsWithoutOverrides,g,arrayMergeCustomizer2),this.updateSettings(),this.configReceivedTimeout&&(window.clearTimeout(this.configReceivedTimeout),this.configReceivedTimeout=void 0),this.configReceivedDefer.resolve()}updateSessionCount(g){this.sessionCount=g,0===g&&this.pendingSettings&&(this.logSettings("Applying pending configuration",this.pendingSettings),this.updateSettings(this.pendingSettings),this.pendingSettings=null),g>0&&this.configReceivedTimeout&&this.configReceivedDefer.resolve()}get config(){return this.settings}get stackConfig(){return this.stackSettings}get consoleOverrides(){return this._consoleOverrides}get defaultConfig(){return this.initialSettings}get userAgentConfig(){return this.uaConfig}get countryCode(){return this.country}setMediaConfiguration(g){this.mediaConfiguration=g,this.mediaSettings.setMediaConfiguration(g)}get mediaConfig(){return this.mediaSettings}get ETag(){return this.etag}get ecsConfigIds(){return this.configIds}setConsoleOverrides(g){this._consoleOverrides=(0,ya.mergeWith)({},this._consoleOverrides,g,arrayMergeCustomizer2),this.updateSettings()}setConsoleOverride(g,m){this._consoleOverrides[g]=m,this.updateSettings()}clearConsoleOverride(g){delete this._consoleOverrides[g],this.updateSettings()}clearAllConsoleOverrides(){this._consoleOverrides={},this.updateSettings()}updateSettings(g=this.settingsWithoutOverrides){if(this.sessionCount>0)return this.pendingSettings=g,void this.logSettings("pendingSettings updated",g);this.settings=this.mergeSettings(g),this.event("configUpdated").raise(),this.logSettings("Settings updated",this.settings)}logSettings(g,m){const S=Object.entries(m).reduce(((g,[m,S])=>(S!==this.initialSettings[m]&&(g[m]=S),g)),{});this.logger.safe.info(`${g}: ${JSON.stringify(S)}`)}mergeSettings(g){if(!(g.enablePlatformCallConstraints||this._consoleOverrides.enablePlatformCallConstraints))return this.mergeSettingsWithConsoleOverrides(g);let m=g;const{setConsoleOverridesBeforeCallConstraints:S}=this._consoleOverrides;return S&&(m=this.mergeSettingsWithConsoleOverrides(m)),m=this.mergeSettingsWithPlatformConstraints(m),S||(m=this.mergeSettingsWithConsoleOverrides(m)),m}mergeSettingsWithConsoleOverrides(g){return this.logger.safe.info(`Merging settings with console overrides: ${stringifyObject(this._consoleOverrides)}`),(0,ya.mergeWith)({},g,this._consoleOverrides,arrayMergeCustomizer2)}mergeSettingsWithPlatformConstraints(g){const m=this.platformCallConstraintsProvider.getSettings(g);return this.logger.safe.info(`Merging settings with platform call constraints: ${stringifyObject(m)}`),(0,ya.assign)({},g,m,arrayMergeCustomizer2)}},Tp=class{constructor(g,m){this.streamClient=g,this.logger=m,this.rawBaseClient=new Dr((()=>this.getStream()),(()=>this.activeRawInputMediaStreamClient?.dispose()),m)}client(){return this.rawBaseClient}disposeActiveMediaStreamClient(){this.logger.info("Disposing active media stream client"),this.activeRawInputMediaStreamClient?.dispose("Disposed by RawDeviceStreamManager"),this.activeRawInputMediaStreamClient=null}async getStream(){return this.activeRawInputMediaStreamClient?.originalMediaStream?.active?(this.logger.info("Returning stream from active mediaStreamClient"),this.activeRawInputMediaStreamClient.originalMediaStream):(this.activeRawInputMediaStreamClient=await this.streamClient(),await this.activeRawInputMediaStreamClient.start(),this.activeRawInputMediaStreamClient.originalMediaStream)}},Ip=class{constructor(g,m){this.logger=g,this.raiseTelemetryEvent=m,this.handlerMap=new Map([["Audio",new Map],["Video",new Map],["ScreenShare",new Map]])}dispose(g){this.logger.info(`disposing IRawStream ${g}`),this.handlerMap.get(g).forEach((g=>g.client().dispose()))}disposeAll(){this.logger.info("Dispose All clients"),this.handlerMap.forEach((g=>g.forEach((g=>g.client().dispose()))))}notifyChange(g){this.handlerMap.get(g).forEach((g=>{g.disposeActiveMediaStreamClient(),g.client().notifyStreamChange()}))}createIRawStreamClient(g,m){this.logger.info(`Create new IRawStream client for ${m}`);const S=new Tp(g,this.logger);this.handlerAdded(S,m);return S.client()}handlerAdded(g,m){const S=g.client();this.setClientSubscription(S,m),this.handlerMap.get(m).set(S.clientId,g)}deleteRawStreamManagerById(g,m){this.logger.info(`Deleting from map: ${m}`),this.handlerMap.get(m).delete(g)}setClientSubscription(g,m){this.logger.info(`Setting subscription on IRawStream client for ${m}`),g.on("clientDisposed",(S=>{this.deleteRawStreamManagerById(g.clientId,m),this.raiseTelemetryEvent("IRawStream_client_disposed",{mediaType:m,clientId:S})})),g.on("rawStreamRequested",(g=>{this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:m,clientId:g})})),g.on("notifiedOnStreamChanged",(g=>this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:m,clientId:g})))}},bp=class extends je{constructor(g,m){super(g),this.logger=g,this.configProvider=m,this.window=Us.window,this.isMuted=!1,this.isPlayingAllowed=!1,this.hadPlaybackError=!1,this.audioContext=null,this.sourceNode=null,this.gainNode=null,this.onAudioError=g=>{const m=g&&g.target||this.audio;if(this.hadPlaybackError=!0,m?.error){const g=m.error.code,S=`error with rendering audio code: ${g}, message: ${m.error.message}`;this.event("onAudioPlaybackError").raise(g,Ke.MEDIA_ERROR.audioPlaybackError,S),this.logger.safe.error(S)}else this.logger.safe.error("error with audio rendering")},this.onAudioPaused=async()=>{if(this.configProvider.config.audioRendererRestartOnPause&&this.canPlay&&!this.isMuted){const g=generateCauseId();this.logger.safe.info(`[${g}] audio playback is paused by OS, resuming it`),await this.startStream(g)}}}get muted(){return this.isMuted}async setMuted(g,m){return this.isMuted=g,g?this.stopStream(m):this.startStream(m)}get canPlay(){return this.stream&&this.isPlayingAllowed}getStream(){return this.stream}getDeviceId(){return this.deviceId}async play(g){if(this.stream=g,this.isPlayingAllowed=!0,!this.isMuted)return this.startStream()}stop(){this.stopStream(),this.isPlayingAllowed=!1}async setOutputDevice(g,m=generateCauseId()){if(this.audio)if(this.configProvider.config.disableAudioOutputSelection)this.logger.safe.warn(`[${m}] audio-output selction is disabled, disableAudioOutputSelection: true`);else if(this.audio.setSinkId){if(g){this.logger.safe.info(`[${m}] setting audio output device ID to ${scrubMriOrOmit(g)}`),this.deviceId=g;try{await this.audio.setSinkId(g)}catch(g){this.logger.safe.warn(`[${m}] setSinkId operation was aborted with error ${stringifyObject(g)}`)}this.configProvider.config.audioRendererRestartOnDeviceError&&this.hadPlaybackError&&!this.isMuted&&(this.logger.safe.info(`[${m}] audio playback error happened, restarting audio stream on new device`),await this.startStream(m),this.hadPlaybackError=!1)}}else this.logger.safe.warn(`[${m}] setting output device is not supported`);else this.deviceId=g}dispose(){this.logger.safe.info("dispose"),super.dispose(),this.audio&&(this.stop(),this.stream=null,this.audio.removeEventListener("error",this.onAudioError),this.audio.removeEventListener("pause",this.onAudioPaused),this.window.document.body.removeChild(this.audio),this.event("onAudioElementRemoved").raise(this.audio),this.audio=null),this.detachGainNode()}async startStream(g=generateCauseId()){if(this.canPlay)try{await this.assureAudioElement(g),this.logger.safe.info(`[${g}] attaching stream to renderer: ${this.stream?.id}`),this.configProvider.config.speakerGainLevel&&this.reattachToGainNode(this.stream,this.configProvider.config.speakerGainLevel),this.audio.srcObject=this.stream,await this.audio.play()}catch(m){this.logger.safe.warn(`[${g}] play operation was aborted with error ${stringifyObject(m)}`)}}async assureAudioElement(g=generateCauseId()){if(!this.audio)return this.logger.safe.info(`[${g}] creating audio element`),this.audio=this.window.document.createElement("audio"),this.audio.addEventListener("error",this.onAudioError),this.audio.addEventListener("pause",this.onAudioPaused),this.window.document.body.appendChild(this.audio),this.audio.autoplay=!0,this.event("onAudioElementAdded").raise(this.audio),this.setOutputDevice(this.deviceId,g)}stopStream(g=generateCauseId()){this.audio&&this.canPlay&&(this.detachGainNode(),this.logger.safe.info(`[${g}] detaching stream from renderer: ${this.stream?.id}`),this.configProvider.config.audioRendererUsePauseOnDetach?this.audio.pause():this.audio.srcObject=null)}attachToGainNode(g,m){this.audioContext=new Us.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(g),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=m,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination)}detachGainNode(){this.sourceNode?.disconnect(),this.sourceNode=null,this.gainNode?.disconnect(),this.gainNode=null,this.audioContext?.close(),this.audioContext=null}reattachToGainNode(g,m){this.detachGainNode(),this.attachToGainNode(g,m)}},Ap=class{constructor(g){this.logger=g,this.queue=Promise.resolve()}add(g,m=generateCauseId()){let S;S=g instanceof or?()=>g.promise:g;const v=this.queue.then(S);return this.queue=v.catch((g=>{this.queue&&this.logger.safe.error(`[${m}] Error from promiseQueue! ${stringifyObject(g)}`)})),v}dispose(){this.queue=null}},Rp=P,Pp=class{constructor(g){this.container=g,this.formatRegexPattern=new RegExp(/{(\d+)}/g),this.elements={},this.previousSamples={},this.createTableCell=(g,m,S)=>{this.elements[g]=document.createElement("td"),this.elements[g].title=g,this.addElementStyle(g,S),this.elements[m].appendChild(this.elements[g])},this.topElement=g.ownerDocument.createElement("div"),this.topElement.classList.add("vdi-occlusion"),this.topElement.style.position="absolute",this.topElement.style.top="0px",this.topElement.style.left="0px",this.topElement.style.zIndex="100",this.topElement.style.transform="inherit",this.topElement.style.backgroundColor="rgba(0, 0, 0, 0.25)",this.container.appendChild(this.topElement),this.toggleCheckbox=document.createElement("input"),this.toggleCheckbox.type="checkbox",this.toggleCheckbox.defaultChecked=!0,this.toggleCheckbox.style.pointerEvents="all",this.topElement.appendChild(this.toggleCheckbox),this.table=document.createElement("table"),this.table.style.borderCollapse="collapse",this.table.style.fontSize="smaller",this.topElement.appendChild(this.table)}dispose(){this.topElement.removeChild(this.table),this.topElement.removeChild(this.toggleCheckbox),this.container.removeChild(this.topElement),this.table=null,this.toggleCheckbox=null,this.topElement=null,this.container=null}createTableColumn(g,m){if(this.toggleCheckbox.checked)for(const S of Object.keys(g)){const v=g[S];v.hideUndefined&&v.values.every((g=>!g))||this.createTableRow(S,v,m)}}createTableRow(g,m,S){this.elements[g]||(this.elements[g]=document.createElement("tr"),this.table.appendChild(this.elements[g]));const v=`${g}-title`,C=`${g}-${S}`,_=this.formatValue(m),E=this.previousSamples[C]!==_;this.previousSamples[C]=_;const T=isOutlier(m)||!(!m.highlightChange||!E);this.elements[v]||(this.createTableCell(v,g,!1),this.elements[v].innerText=m.text?m.text:g),this.createTableCell(C,g,T),this.elements[C].innerText=_}clearTable(){for(;this.table.hasChildNodes();)this.table.removeChild(this.table.lastChild);this.elements={}}addElementStyle(g,m){this.elements[g].style.color=m?"#F72F35":"#FBF719",this.elements[g].style.fontSize="smaller",this.elements[g].style.lineHeight="1",this.elements[g].style.padding="0px 1px 0px 1px",this.elements[g].style.maxWidth="60px",this.elements[g].style.overflow="hidden",this.elements[g].style.whiteSpace="nowrap",this.elements[g].style.textOverflow="ellipsis"}formatValue(g){const{values:m,format:S,undefinedFallback:v="N/A"}=g;return S?S.replace(this.formatRegexPattern,((g,S)=>m[S]?m[S].toString():v.toString())):m?.length&&m[0]?m[0].toString():v.toString()}},Mp=class{constructor(g,m,S){this.container=m,this.renderer=S,this.subs=[],g&&!this.overlay&&(this.overlay=new Pp(this.container),this.subs.push(this.renderer.on("onVideoSizeChanged",((g,m)=>this.streamSize={width:g,height:m}))),this.subs.push(this.renderer.on("onRendererSizeChanged",((g,m)=>this.rendererSize={width:Math.ceil(m.width),height:Math.ceil(m.height)}))))}setStats(g){if(!this.overlay)return;const{id:m,ssrc:S,keyFramesDecoded:v,nackCount:C,firCount:_,pliCount:E,decoderImplementation:T,packetsLost:I}=g.inboundRTP,{frameRateReceived:b,frameRateDecoded:A,bitrate:R,decodeTime:P}=g.extensions??{},M=this.renderer?.getMsi(),w=this.renderer?.getLocalMsi(),D={streamSize:{format:"{0}x{1}",values:[this.streamSize?.width,this.streamSize?.height],undefinedFallback:0},rendererSize:{format:"{0}x{1}",values:[this.rendererSize?.width,this.rendererSize?.height],undefinedFallback:0},ssrc:{values:[S]},msid:{text:"sourceId/msid",format:"{0}/{1}",values:[M,w]},fps:{text:"FPS(r/d)",format:"{0}/{1}",values:[b,A],highlightUndefined:!0,lowerThreshold:1,upperThreshold:45,allowedDeviationThreshold:.2},bitrate:{format:"{0} kbps",values:[toKbps(R)],lowerThreshold:24},decodeTime:{format:"{0} ms",values:[P],upperThreshold:15,highlightUndefined:!0},keyFramesDecoded:{text:"KFs",values:[v]},nacksFirsPlisSent:{text:"N/F/P",format:"{0}/{1}/{2}",values:[C,_,E],undefinedFallback:0,highlightChange:!0},packetsLost:{text:"lost",values:[I],undefinedFallback:0,highlightChange:!0},codecImplementationName:{text:"decoder",values:[T],highlightUndefined:!0}};this.overlay.clearTable(),this.overlay.createTableColumn(D,m)}dispose(){this.subs.forEach((g=>g.dispose())),this.subs=[],this.overlay?.dispose(),this.overlay=null,this.container=null,this.renderer=null}},wp=class{constructor(g,m){this.container=m,g&&!this.overlay&&(this.overlay=new Pp(this.container))}setStats(g){if(!this.overlay)return;const getStatsValues=g=>{const{rid:m,ssrc:S,frameWidth:v,frameHeight:C,framesPerSecond:_,keyFramesEncoded:E,nackCount:T,firCount:I,pliCount:b,encoderImplementation:A,qualityLimitationReason:R}=g.outboundRTP,{cameraOpenResolution:P,bitrate:M,encodeTime:w,frameRateEncoded:D,frameRateSent:O,qp:N}=g.extensions??{};return{rid:{values:[m],hideUndefined:!0},cameraSize:{format:"{0}x{1}",values:[P?.width,P?.height]},inputSize:{format:"{0}x{1}",values:[g.mediaSource?.width,g.mediaSource?.height]},sentSize:{format:"{0}x{1}",values:[v,C]},ssrc:{values:[S]},fps:{text:"FPS(i/e/s)",format:"{0}/{1}/{2}",values:[_,D,O],lowerThreshold:7,upperThreshold:45,allowedDeviationThreshold:.2},bitrate:{format:"{0} kbps",values:[toKbps(M)],lowerThreshold:24},encodeTime:{format:"{0} ms",values:[w],upperThreshold:15},keyFramesEncoded:{text:"KFs",values:[E]},qp:{values:[N]},nacksFirsPlisRecv:{text:"N/F/P",format:"{0}/{1}/{2}",values:[T,I,b],undefinedFallback:0,highlightChange:!0},codecImplementationName:{text:"encoder",values:[A],highlightUndefined:!0},qualityLimitationReason:{text:"limited",values:[R],fixedValueThreshold:"none"},bwe:{format:"{0} kbps",values:[toKbps(g.transport?.selectedCandidatePair?.availableOutgoingBitrate)],lowerThreshold:100}}};this.overlay.clearTable();const m=[g,...g.altLayouts??[]];for(const g of m)this.overlay.createTableColumn(getStatsValues(g),g.outboundRTP.id)}dispose(){this.overlay?.dispose(),this.overlay=null,this.container=null}};function toKbps(g){return g&&Math.floor((g||0)/1e3)}function isOutlier(g){const{values:m,lowerThreshold:S,upperThreshold:v,highlightUndefined:C,fixedValueThreshold:_,allowedDeviationThreshold:E}=g;for(const g of m){if(void 0===g&&null===g&&C)return!0;if(_&&_!==g)return!0;if(null==g||!(0,Rp.isNumber)(g))return!1;if(S&&Number(g)<=S)return!0;if(v&&Number(g)>=v)return!0;if(E){const S=(0,Rp.mean)(m),v=S*E;if(Math.abs(Number(g)-S)>v)return!0}}return!1}function getObjectFitValue(g){switch(g){case"crop":return"cover";case"stretch":return"fill";default:return"contain"}}var Dp=class _VideoRendererBase extends je{constructor(g,m,S){const v=m.createChild(""+_VideoRendererBase.rendererId++);super(v),this.container=g,this.configProvider=S,this.video=this.container.ownerDocument.createElement("video"),this.lastNotifiedVideoWidth=0,this.lastNotifiedVideoHeight=0,this.isVideoAttached=!1,this.onVideoDataUpdated=()=>{let g=this.video.videoWidth,m=this.video.videoHeight;(g<32||m<32)&&(g=m=0),this.lastNotifiedVideoWidth===g&&this.lastNotifiedVideoHeight===m||(this.lastNotifiedVideoWidth=g,this.lastNotifiedVideoHeight=m,this.event("onVideoSizeChanged").raise(g,m)),this.video?.paused&&this.video.play()},this.onVideoError=()=>{this.logger.safe.info(`onVideoError: error with video rendering: ${JSON.stringify(this.video.error)||"no video"}`),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onError",payload:JSON.stringify(this.video.error)||"no video"})},this.onVideoPaused=()=>{this.logger.safe.info("onVideoPaused: video playback is paused"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPaused"}),this.video.play()},this.onVideoPlayed=()=>{this.logger.safe.info("onVideoPlayed"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPlayed"})},this.onContextMenu=g=>{g.preventDefault()},this.logger=v,this.video.style.width="100%",this.video.style.height="100%",this.video.setAttribute("playsinline","true"),this.video.disablePictureInPicture=!0,this.video.autoplay=!0,this.video.muted=!0,this.attachEventListeners(),this.logger.safe.info("created")}getVideoElement(){return this.video}dispose(){super.dispose(),this.isVideoAttached&&(this.container.removeChild(this.video),this.isVideoAttached=!1),this.sizeTracker?.dispose(),this.detachEventListeners(),this.attachMediaStream(null),this.video=null,this.stream=null,this.canvas=null,this.context=null}attachMediaStream(g){this.stream!==g&&(this.stream&&(this.video.srcObject=null),g&&(this.video.hidden=0===g.getVideoTracks().length,this.video.srcObject=g,this.isVideoAttached||(this.container.appendChild(this.video),this.isVideoAttached=!0)),this.stream=g)}setScalingMode(g){this.video.style.objectFit=getObjectFitValue(g)}getMediaStream(){return this.stream}getTrackId(){return this.stream?.getTracks()[0]?.id??void 0}async captureFrame(){const g=this.stream;if(!g)throw this.logger.safe.error("Mediastream not found"),new Error("Mediastream not found");const m=g.getVideoTracks?.()?.[0]?.getSettings(),S=m?.width,v=m?.height;if(!S||!v)throw this.logger.safe.error("Failed to get video track width/height"),new Error("Failed to get video track width/height");const C=this.getImageData(S,v);return{getSize:()=>({width:S,height:v}),isMirrored:()=>!1,getImageData:()=>C}}getImageData(g,m){if(this.canvas??(this.canvas=this.container.ownerDocument.createElement("canvas")),this.context??(this.context=this.canvas.getContext("2d")),!this.context)throw this.logger.safe.error("Failed to get canvas 2d context"),new Error("Failed to get canvas 2d context");this.canvas.width=g,this.canvas.height=m,this.context.drawImage(this.video,0,0,g,m);return this.context.getImageData(0,0,g,m)}attachEventListeners(){this.video.addEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.addEventListener("timeupdate",this.onVideoDataUpdated),this.video.addEventListener("error",this.onVideoError),this.video.addEventListener("pause",this.onVideoPaused),this.video.addEventListener("contextmenu",this.onContextMenu),this.video.addEventListener("play",this.onVideoPlayed)}detachEventListeners(){this.video.removeEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.removeEventListener("timeupdate",this.onVideoDataUpdated),this.video.removeEventListener("error",this.onVideoError),this.video.removeEventListener("pause",this.onVideoPaused),this.video.removeEventListener("contextmenu",this.onContextMenu),this.video.removeEventListener("play",this.onVideoPlayed)}};Dp.rendererId=0;var Op=Dp;function createResolutionTable(g){return g.map((g=>new Np(g.w,g.h,g.minBr,g.maxBr)))}var Np=class{constructor(g,m,S=0,v=0){this.width=g,this.height=m,this.minBitrate=S,this.maxBitrate=v,this.fs=Math.ceil(g/Ke.MACROBLOCK_SIZE)*Math.ceil(m/Ke.MACROBLOCK_SIZE)}toString(){return this.height?`${this.height}p`:`${this.fs}fs`}},kp=class _ResolutionTable{constructor(g){g||(this.resolutions=createResolutionTable(Ke.RES_TABLE.SEND)),this.resolutions=createResolutionTable(g)}static initialize(g){_ResolutionTable.Send=new _ResolutionTable(g.config.sendResolutionTableOverride),_ResolutionTable.Recv=new _ResolutionTable(g.config.recvResolutionTableOverride),g.on("configUpdated",(()=>{_ResolutionTable.Send=new _ResolutionTable(g.config.sendResolutionTableOverride),_ResolutionTable.Recv=new _ResolutionTable(g.config.recvResolutionTableOverride)}))}get initialResolution(){return this.resolutions[this.resolutions.length-1]}getResolutionByFs(g){for(let m=this.resolutions.length-1;m>=0;m--)if(this.resolutions[m].fs<=g)return this.resolutions[m];return this.resolutions[0]}getMaxFS(g,m){return this.getResolutionRecord(g,m).fs}getResolutionForBitrate(g){let m=this.resolutions.filter((m=>m.maxBitrate&&m.maxBitrate>=g)).shift(),S=this.resolutions.filter((m=>m.minBitrate&&m.minBitrate<=g)).pop();return m=m??S,S=S??m,{lowRes:m,highRes:S}}getBitrateForResolution(g,m){const S=this.getResolutionRecord(g,m);return{minBitrate:S.minBitrate,maxBitrate:S.maxBitrate}}getResolutionForHeight(g){for(let m=this.resolutions.length-1;m>=0;m--)if(this.resolutions[m].height<=g)return this.resolutions[m];return this.resolutions[0]}getResolutionRecord(g,m){const S=Math.max(g,m),v=Math.min(g,m);for(const g of this.resolutions)if(g.width>=S&&g.height>=v)return g;return this.resolutions[this.resolutions.length-1]}getNextLowerResolution(g,m){const S=Math.min(g,m),v=this.getResolutionForHeight(S),C=this.resolutions.indexOf(v);return this.resolutions[C-1]}getNextHigherResolution(g,m){const S=Math.min(g,m),v=this.getResolutionForHeight(S),C=this.resolutions.indexOf(v);return this.resolutions[C+1]}getResolutions(){return this.resolutions}};kp.Recv=new kp(Ke.RES_TABLE.RECV),kp.Send=new kp(Ke.RES_TABLE.SEND);var Lp=kp,Fp=class extends je{constructor(g,m,S,v){super(),this.videoElement=g,this.minInterval=m,this.maxInterval=S,this.window=Us.window,this.devicePixelRatio=v&&window.devicePixelRatio||1,this.originalVideoElementSize={width:g.offsetWidth,height:g.offsetHeight},this.initializeSizeTracking()}get width(){return this.originalVideoElementSize.width*this.devicePixelRatio}get height(){return this.originalVideoElementSize.height*this.devicePixelRatio}initializeSizeTracking(){const g=Math.floor(Math.random()*Math.abs(this.maxInterval-this.minInterval))+this.minInterval;this.elementSizeTrackingRef=this.window.setInterval((()=>{this.videoElementSizeChanged()&&(this.saveCurrentVideoElementSize(),this.raiseChanged())}),g)}triggerVideoElementSizeChange(){this.originalVideoElementSize.height&&this.originalVideoElementSize.width&&this.raiseChanged()}dispose(){this.elementSizeTrackingRef&&this.window.clearInterval(this.elementSizeTrackingRef)}videoElementSizeChanged(){return this.originalVideoElementSize.width!==this.videoElement.offsetWidth||this.originalVideoElementSize.height!==this.videoElement.offsetHeight}saveCurrentVideoElementSize(){this.originalVideoElementSize.width=this.videoElement.offsetWidth,this.originalVideoElementSize.height=this.videoElement.offsetHeight}},xp=class extends Op{constructor(g,m,S,v){super(g,S.createChild("local"),v),this.mediaStreamProvider=m,this.isDisposed=!1,this.serialQueue=new Ap(this.logger.createChild("rendererQueue")),this.lastNotifiedRendererResolution={width:0,height:0},this.logger.safe.info("ctor"),this.overlayStats=new wp(this.configProvider.config.showStatsInCall,g)}getResolution(){return this.lastNotifiedRendererResolution}dispose(){this.logger.safe.info("dispose"),this.isDisposed=!0,this.event("onRendererDisposed").raise(this),super.dispose(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),this.statsSub?.dispose(),this.overlayStats.dispose()}setVideoMirroring(g){this.configProvider.config.localPreviewMirroringSupported&&(this.getVideoElement().style.transform=g?"scaleX(-1)":void 0)}startVideoAsync(g=generateCauseId()){return this.logger.safe.info(`[${g}] starting local video`),this.event("onRendererStarted").raise(this),this.sizeTracker=new Fp(this.getVideoElement(),this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged())),this.serialQueue.add((()=>this.restartVideo()),g)}updateStreamAsync(g=generateCauseId()){return this.logger.safe.info(`[${g}] updating local video`),this.serialQueue.add((()=>this.restartVideo()),g)}setStatsProvider(g){this.statsSub?.dispose(),this.statsSub=g.on("onDiagnosticUpdated",(g=>{g.video?.send?.length&&this.overlayStats.setStats(g.video?.send[0])}))}onSizeTrackerChanged(){const g=this.sizeTracker.width,m=this.sizeTracker.height,S=Lp.Send.getResolutionForHeight(Math.min(m,g));this.lastNotifiedRendererResolution.width===S.width&&this.lastNotifiedRendererResolution.height===S.height||(this.lastNotifiedRendererResolution.width=S.width,this.lastNotifiedRendererResolution.height=S.height,this.event("onRendererSizeChanged").raise(this,{height:S.height,width:S.width}))}async restartVideo(){const g=await this.mediaStreamProvider.getVideoStream(!1,"localVideoRenderer");try{if(await g.start(),this.isDisposed)throw g.dispose(),new Error("local video renderer is disposed");this.attachStream(g)}catch(g){throw this.mediaStreamProvider.raiseTelemetryEvent("video_preview_error",{mediaType:"Video",error:stringifyObject(g)}),g}}attachStream(g){if(this.mediaStream!==g)if(this.mediaStream?.parentId!==g?.parentId){this.logger.safe.info(`attach media stream ${g?.id}`);try{this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),g&&super.attachMediaStream(g.rawStream),this.mediaStream=g}catch(m){throw g&&g.dispose(),m}}else g.dispose()}},Up=P;function adjustResolutionToAspectRatio(g,m){const S=g.width/g.height,v=(0,Up.clone)(g);return S>m?v.width=Math.floor(g.height*m):S<m&&(v.height=Math.floor(g.width/m)),v}var Vp=class _ConstraintsObject{constructor(g,m,S=!0,v=!1,C){this.audio=g,this.video=m,this.withTimeout=S,this.withEffect=v,this.withOverridenStream=C}clone(){const g=deepClone(this.video),m=deepClone(this.audio);return new _ConstraintsObject(m,g,this.withTimeout,this.withEffect,this.withOverridenStream)}},Bp=class{constructor(g){this.logger=g}dispose(){}updateVideoConstraints(g,m,S){const v=this.calculateConstraints(m,S);this.logger.safe.info(`Calculated constraints: ${JSON.stringify(v)} from capabilities: ${JSON.stringify(m)}`);const C=v.resolution,_=v.fps,E=C&&(!isInRange(C.width,g.video.minWidth,g.video.maxWidth)||!isInRange(C.height,g.video.minHeight,g.video.maxHeight)),T=g.video.fps!==_;if(!E&&!T)return g;const I=g.clone();return E&&this.setResolution(I,C),T&&(I.video.fps=_),I}updateResolution(g,m){const S=g.clone();return this.setResolution(S,m),S}setResolution(g,m){g.video.maxWidth=m.width,g.video.minWidth=m.width,g.video.maxHeight=m.height,g.video.minHeight=m.height}getKey(g){return g.video?isEmpty(g.video)?"video":g.video.deviceId&&g.video.minWidth&&g.video.minHeight?`${g.video.deviceId}x${g.video.minWidth}x${g.video.minHeight}`:g.video.minWidth&&g.video.minHeight?`${g.video.minWidth}x${g.video.minHeight}`:g.video.deviceId?`${g.video.deviceId}`:(this.logger.safe.error(`Cannot create key for constraints: ${scrubConstraints(g)}`),""):"audio"}convertConstraints(g,m={}){if(!g)return null;const S=deepClone(m);return g?.deviceId&&(S.deviceId=g.deviceId),S}},Hp=class{constructor(){this.MAX_SHARING_WIDTH=1920,this.MAX_SHARING_HEIGHT=1080}getResolutionTable(g,m){const S=this.constraintToMaxResolution(g,m);return this.generateResolutionTable(S)}constraintToMaxResolution(g,m){const S=this.getPortraitOrLandscapeMaxResolution(g),v=adjustResolutionToAspectRatio({width:g.width,height:g.height},m),C=S.width/v.width,_=S.height/v.height,E=Math.min(C,_);return this.resizeResolution(v,E)}resizeResolution(g,m){return{width:Math.round(g.width*m),height:Math.round(g.height*m)}}getPortraitOrLandscapeMaxResolution(g){return g.width>g.height?{width:this.MAX_SHARING_WIDTH,height:this.MAX_SHARING_HEIGHT}:{width:this.MAX_SHARING_HEIGHT,height:this.MAX_SHARING_WIDTH}}ceilToMackroblockSize(g){const m=g.width,S=g.height;return{width:Math.ceil(m/Ke.MACROBLOCK_SIZE)*Ke.MACROBLOCK_SIZE,height:Math.ceil(S/Ke.MACROBLOCK_SIZE)*Ke.MACROBLOCK_SIZE}}generateResolutionTable(g){return[1,2/3,1/3,1/6].map((m=>this.resizeResolution(g,m))).map((g=>this.ceilToMackroblockSize(g)))}},$p=class{constructor(g){this.logger=g,this.FPS_TABLE=[15,7.5,3.75,1.875],this.resolutionTableCalculator=new Hp,this.initialAspectRatio=null}calculateConstraints(g,m){this.initialAspectRatio||(this.initialAspectRatio=m.width/m.height);const S=this.resolutionTableCalculator.getResolutionTable(m,this.initialAspectRatio);let v={resolution:S[S.length-1],fps:this.FPS_TABLE[this.FPS_TABLE.length-1]};return S.some((m=>{const S=this.getFs(m);return this.FPS_TABLE.some((C=>{const _=this.getMbps(S,C);return S<=g.maxFs&&C<=g.maxFps&&_<=g.maxMbps&&(v={resolution:m,fps:C},!0)}))}))?this.logger.safe.info(`Calculated resolution: ${JSON.stringify(v)}`):this.logger.safe.error(`None of available resolutions are suitable: ${JSON.stringify(S)}. Fallback to: ${JSON.stringify(v)}`),v}getMbps(g,m){return g*m}getFs(g){return Math.ceil(g.width/Ke.MACROBLOCK_SIZE)*Math.ceil(g.height/Ke.MACROBLOCK_SIZE)}},Gp=class{constructor(g,m){this.logger=g,this.maxCapabilities=m}ensureValidity(g){this.throwIfMissing(g);const m=this.calculateMissing(g);return this.maxCapabilities&&this.applyMaxCapabilities(m),this.logger.safe.info(`Validating capabilities ${JSON.stringify(m)}`),m}throwIfMissing(g){if(!g.maxFs&&!g.maxMbps&&!g.maxFps||g.maxFs&&!g.maxMbps&&!g.maxFps||!g.maxFs&&g.maxMbps&&!g.maxFps||!g.maxFs&&!g.maxMbps&&g.maxFps)throw new Error(`Missing video capabilities ${JSON.stringify(g)}`)}calculateMissing(g){const m=shallowClone(g);return!g.maxFs&&g.maxMbps&&g.maxFps&&(m.maxFs=g.maxMbps/g.maxFps),g.maxFs&&!g.maxMbps&&g.maxFps&&(m.maxMbps=g.maxFs*g.maxFps),g.maxFs&&g.maxMbps&&!g.maxFps&&(m.maxFps=g.maxMbps/g.maxFs),m}applyMaxCapabilities(g){this.maxCapabilities.maxFs&&(g.maxFs=Math.min(g.maxFs,this.maxCapabilities.maxFs)),this.maxCapabilities.maxMbps&&(g.maxMbps=Math.min(g.maxMbps,this.maxCapabilities.maxMbps)),this.maxCapabilities.maxFps&&(g.maxFps=Math.min(g.maxFps,this.maxCapabilities.maxFps))}},jp=8160,qp=15,Wp=class extends Bp{constructor(g,m){super(g),this.initialConstraints={maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,fps:15},this.maxCapabilities={maxFs:jp,maxFps:qp},this.validator=new Gp(this.logger.createChild("CV"),this.maxCapabilities),this.constraintsCalculator=new $p(this.logger.createChild("CC")),m.config.resizeModeForSharing&&(this.initialConstraints.resizeMode=m.config.resizeModeForSharing)}createConstraintsObject(g){if(!g.sharing)throw new Error(`Sharing constraints are not presented: ${JSON.stringify(g)}`);const m=this.convertConstraints(g.sharing,this.initialConstraints),S=g.audio?g.audio:null;return S?.deviceId===Ke.SYSTEM_AUDIO_SOURCE_ID&&delete S.deviceId,new Vp(S,m,!1,!1,g.withOverridenStream)}generatePolicies(g){return[g]}calculateConstraints(g,m){this.logger.safe.info(`Stream resolution is ${JSON.stringify(m)}`);const S=this.validator.ensureValidity(g);return this.constraintsCalculator.calculateConstraints(S,m)}},zp=class extends Wp{constructor(g,m,S){super(g,S);const v=m.screen.width/m.screen.height;v<1&&([this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[this.initialConstraints.maxHeight,this.initialConstraints.maxWidth],[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[this.initialConstraints.minHeight,this.initialConstraints.minWidth]);let C=adjustResolutionToAspectRatio({width:this.initialConstraints.maxWidth,height:this.initialConstraints.maxHeight},v);[this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[C.width,C.height],C=adjustResolutionToAspectRatio({width:this.initialConstraints.minWidth,height:this.initialConstraints.minHeight},v),[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[C.width,C.height]}},Kp=class extends Bp{constructor(g,m){super(m),this.configProvider=g}createConstraintsObject(g){const m={},S=getBrowserInfo().engine;void 0!==g.audioProcessingFlags&&("Chromium"===S||"ChromiumAVD"===S?(m.autoGainControl=!!(1&g.audioProcessingFlags),m.echoCancellation=!!(2&g.audioProcessingFlags),m.noiseSuppression=!!(4&g.audioProcessingFlags),this.configProvider.config.useGoogPrefixAudioConstraints&&(m.googAutoGainControl=!!(1&g.audioProcessingFlags),m.googAutoGainControl2=!!(1&g.audioProcessingFlags),m.googEchoCancellation=!!(2&g.audioProcessingFlags),m.googHighpassFilter=!!(4&g.audioProcessingFlags),m.googNoiseSuppression=!!(4&g.audioProcessingFlags),m.googTypingNoiseDetection=!!(4&g.audioProcessingFlags))):"Safari"===S||"Firefox"===S?(m.autoGainControl=!!(1&g.audioProcessingFlags),m.echoCancellation=!!(2&g.audioProcessingFlags),m.noiseSuppression=!!(4&g.audioProcessingFlags)):this.logger.warn(`Unsupported browser for audio processing flags ${S}`));const v=this.convertConstraints(g.audio,m),C=this.convertConstraints(g.video,this.initialVideoConstraints);return new Vp(v,C,g.withTimeout,g.withEffect,g.withOverridenStream)}calculateConstraints(g){const m=Math.min(g.maxFs,this.configProvider.config.webrtcCameraOpenFs);return{resolution:Lp.Send.getResolutionByFs(m),fps:g.maxFps}}get initialVideoConstraints(){const g=Lp.Send.getResolutionByFs(this.configProvider.config.webrtcCameraOpenFs);return{maxWidth:g.width,minWidth:g.width,maxHeight:g.height,minHeight:g.height,fps:this.configProvider.config.maxCameraOpenFps}}},Jp=class{static getProvider(g,m,S){if("ScreenShare"===g){const g=S.createChild("SharingCP");return"Safari"===getBrowserInfo().name?new zp(g,Us.window,m):new Wp(g,m)}return new Kp(m,S.createChild("VideoCP"))}},Yp=class{constructor(){}getPolicies(g){if(g.audio&&!g.video&&this.hasAudioProcessingConstraints(g))return[g,new Vp({deviceId:g.audio.deviceId},null)];if(!g.video)return[g];const m=this.getSuitableResolutions(g).map((m=>this.getConstraintsForResolution(g,m))),S=g.audio,v={deviceId:g.video.deviceId},C=new Vp(S,v,g.withTimeout);return m.push(C),m}getSuitableResolutions(g){return Lp.Send.getResolutions().filter((m=>m.width<=g.video.maxWidth&&m.height<=g.video.maxHeight)).reverse()}getConstraintsForResolution(g,m){const S=g.clone();return S.video.minWidth=m.width,S.video.minHeight=m.height,S}hasAudioProcessingConstraints(g){const m=g&&g.audio;return m&&(void 0!==m.echoCancellation||void 0!==m.autoGainControl||void 0!==m.noiseSuppression)}},Qp=class{constructor(g,m){this.error=g,this.constraints=m,this.permissionDeniedBySystemErrorMsg=["Permission denied by system","The request is not allowed by the user agent or the platform in the current context, possibly because the user denied permission."]}getMediaError(){let g;switch(this.error.name){case"SourceUnavailableError":case"TrackStartError":case"NotReadableError":case"AbortError":g={type:Ke.MEDIA_ERROR.sourceUnavailableError,detail:`media device is already used by another process: ${stringifyObject(this.error)}`};break;case"ConstraintNotSatisfiedError":case"OverconstrainedError":g={type:Ke.MEDIA_ERROR.constraintNotSatisfiedError,detail:`could not obtain constrained media stream: ${stringifyObject(this.error)}`};break;case"DevicesNotFoundError":case"NotFoundError":g={type:Ke.MEDIA_ERROR.devicesNotFoundError,detail:`specified device not found: ${stringifyObject(this.error)}`};break;case"NotAllowedError":g=this.permissionDeniedBySystemErrorMsg.some((g=>g===this.error.message))?{type:Ke.MEDIA_ERROR.permissionDeniedBySystemError,detail:`no system permissions: ${stringifyObject(this.error)}`}:{type:Ke.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${stringifyObject(this.error)}`};break;case"PermissionDeniedError":case"PermissionDismissedError":g={type:Ke.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${stringifyObject(this.error)}`};break;case Ke.MEDIA_ERROR.extensionNotFoundError:g={type:Ke.MEDIA_ERROR.extensionNotFoundError,detail:`extension is not found: ${stringifyObject(this.error)}`};break;case Ke.MEDIA_ERROR.chromeRuntimeNotDefinedError:g={type:Ke.MEDIA_ERROR.chromeRuntimeNotDefinedError,detail:`chrome runtime is not defined: ${stringifyObject(this.error)}`};break;case Ke.MEDIA_ERROR.sharingCancelledError:g=this.getSharingCancelledError(this.error);break;case Ke.MEDIA_ERROR.mediaStreamRequestTimedOut:g={type:Ke.MEDIA_ERROR.mediaStreamRequestTimedOut,detail:"Media Stream request timed out."};break;default:g=this.error.message===Ke.MEDIA_ERROR.sharingCancelledError?this.getSharingCancelledError(this.error):{type:Ke.MEDIA_ERROR.mediaStreamRequestError,detail:`media stream request error: ${stringifyObject(this.error)}`}}return g.isAudio=!!this.constraints.audio,g.detail+=` constraints: ${stringifyObject(scrubConstraints(this.constraints))}`,g.message=g.detail,g}getSharingCancelledError(g){return{type:Ke.MEDIA_ERROR.sharingCancelledError,detail:`screen sharing cancelled: ${stringifyObject(g)}`}}},Xp=class{constructor(g){this.logger=g}static isSupported(){return!0}getStream(g){const m=this.constraintsAdapter.toGumConstraints(g);return this.logger.safe.info(`Constraints to be applied: ${JSON.stringify(scrubConstraints(m))}`),new Promise(((g,S)=>{Us.window.navigator.getUserMedia(m,g,S)})).catch((m=>{throw new Qp(m,g).getMediaError()}))}applyConstraints(g,m){if(!g||!g.getVideoTracks()||!g.getVideoTracks()[0])return Promise.reject("No video tracks found");const S=g.getVideoTracks()[0];return this.applyConstraintsForTrack(S,m)}applyConstraintsForTrack(g,m){const S=this.constraintsAdapter.toTrackConstraints(m);return g.applyConstraints?(this.logger.safe.info(`Apply constraints: ${JSON.stringify(S)} on ${JSON.stringify(g.id)}`),g.applyConstraints(S).catch((g=>{throw new Qp(g,m).getMediaError()}))):Promise.reject("track.applyConstraints() is not supported")}},Zp=class{constructor(g){this.configProvider=g}toGumConstraints(g){const m={};return g.audio&&(m.audio=deepClone(g.audio),m.audio.deviceId&&delete m.audio.deviceId,g.audio.deviceId&&g.audio.deviceId!==Ke.MEDIA_DEVICE.defaultId&&(m.audio.deviceId=g.audio.deviceId)),g.video&&(m.video={mandatory:{}},g.video.deviceId&&(m.video.mandatory.sourceId=g.video.deviceId),g.video.minWidth&&(m.video.mandatory.minWidth=g.video.minWidth),g.video.maxWidth&&(m.video.mandatory.maxWidth=g.video.maxWidth),g.video.minHeight&&(m.video.mandatory.minHeight=g.video.minHeight),g.video.maxHeight&&(m.video.mandatory.maxHeight=g.video.maxHeight),g.video.fps&&(m.video.mandatory.maxFrameRate=g.video.fps,this.configProvider.config.setMinFpsForWebkit&&(m.video.mandatory.minFrameRate=this.configProvider.config.minCameraOpenFps,m.video.mandatory.idealFrameRate=g.video.fps)),isEmpty(m.video.mandatory)&&delete m.video.mandatory),m}toTrackConstraints(g){const m={};return g.video&&(g.video.minWidth&&(m.width=g.video.minWidth),g.video.minHeight&&(m.height=g.video.minHeight),g.video.fps&&(m.frameRate=g.video.fps)),m}},em=class{constructor(g){this.configProvider=g}toGumConstraints(g){const m={};if(g.audio&&(m.audio=deepClone(g.audio),m.audio.deviceId&&delete m.audio.deviceId,g.audio.deviceId&&g.audio.deviceId!==Ke.MEDIA_DEVICE.defaultId&&(m.audio.deviceId={exact:g.audio.deviceId})),g.video){m.video={width:{},height:{},frameRate:{}},g.video.deviceId&&(m.video.deviceId={exact:g.video.deviceId}),g.video.minWidth&&(m.video.width.min=g.video.minWidth),g.video.maxWidth&&(m.video.width.max=g.video.maxWidth),g.video.minHeight&&(m.video.height.min=g.video.minHeight),g.video.maxHeight&&(m.video.height.max=g.video.maxHeight),g.video.fps&&(m.video.frameRate.max=g.video.fps,m.video.frameRate.min=this.configProvider.config.minCameraOpenFps,m.video.frameRate.ideal=g.video.fps);for(const g in m.video)isEmpty(m.video[g])&&delete m.video[g]}return m}toTrackConstraints(g){const m={};return g.video&&(g.video.minWidth&&(m.width=g.video.minWidth),g.video.minHeight&&(m.height=g.video.minHeight),g.video.fps&&(m.frameRate=g.video.fps)),m}},tm=class{toGumConstraints(g){if(!g||!g.video)throw new Error(`constraints cannot be applied: ${g}`);const m={video:{}},S=g.video.deviceId&&g.video.deviceId!==Ke.DISPLAY_SOURCE_ID;return g.video.resizeMode&&(m.video.resizeMode=g.video.resizeMode),S&&(m.video.deviceId={exact:g.video.deviceId}),g.video.maxWidth&&(m.video.width={max:g.video.maxWidth},S&&(m.video.width.ideal=g.video.maxWidth)),g.video.maxHeight&&(m.video.height={max:g.video.maxHeight},S&&(m.video.height.ideal=g.video.maxHeight)),g.video.fps&&(m.video.frameRate=g.video.fps),g.audio&&(m.audio=!g.audio.deviceId||{deviceId:{exact:g.audio.deviceId}}),m}toTrackConstraints(g){const m=navigator.mediaDevices.getSupportedConstraints();if(!m)throw new Error("Constraints are not supported by browser");const S={};return m.width&&g.video.minWidth&&(S.width=g.video.minWidth),m.height&&g.video.minHeight&&(S.height=g.video.minHeight),m.frameRate&&g.video.fps&&(S.frameRate=g.video.fps),S.resizeMode=g.video.resizeMode,S}},im=class extends Xp{constructor(g,m){if(super(m.createChild("WebRTCProvider")),this.configProvider=g,this.timeoutId=null,void 0!==navigator.webkitGetUserMedia&&void 0!==webkitRTCPeerConnection&&isVdiPlatform()){if(!this.configProvider.config.overrideGumFromWebkit||!Fs)return void(this.constraintsAdapter=new Zp(g));this.logger.safe.info("Overriding getUserMedia from webkit"),overrideGumSourceFromWebkit()}this.constraintsAdapter=new em(g)}getStream(g){if(!g.withTimeout||!this.configProvider.config.gumRequestTimeout)return super.getStream(g);const m=this.startGumRequestTimer(g),S=super.getStream(g).then((m=>{if(!this.timeoutId)throw this.stopStreamAfterTimeout(m,g),this.getMediaStreamTimeoutError(g);return this.stopGumRequestTimer(),m}));return Promise.race([m,S]).catch((g=>{throw this.stopGumRequestTimer(),g}))}getMediaStreamTimeoutError(g){const m={name:Ke.MEDIA_ERROR.mediaStreamRequestTimedOut,message:`Media stream request timed out. Constraints: ${stringifyObject(scrubConstraints(g))}`};return new Qp(m,g).getMediaError()}startGumRequestTimer(g){return new Promise(((m,S)=>{this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,S(this.getMediaStreamTimeoutError(g))}),this.configProvider.config.gumRequestTimeout)}))}stopGumRequestTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}stopStreamAfterTimeout(g,m){this.logger.safe.info(`Stopping media stream acquired after timeout: ${JSON.stringify(g.id)} with constraints: ${JSON.stringify(m)}`);try{g.getTracks().forEach((g=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(g.id)}`),g.stop()})),this.logger.safe.info(`Media stream stopped: ${g.id}`)}catch(g){this.logger.safe.warn(`Failed to stop media stream: ${stringifyObject(g)}`)}}},nm=class extends Xp{constructor(g){super(g.createChild("WebRTCDispProvider")),this.constraintsAdapter=new tm}static isSupported(){return!!window.navigator.mediaDevices.getDisplayMedia}getStream(g){const m=this.constraintsAdapter.toGumConstraints(g);return this.logger.safe.info(`Constraints to be used: ${JSON.stringify(m)}`),Promise.resolve().then((()=>g.video?.deviceId&&g.video?.deviceId!==Ke.DISPLAY_SOURCE_ID?Us.window.navigator.mediaDevices.getUserMedia(m):Us.window.navigator.mediaDevices.getDisplayMedia(m))).catch((m=>{throw new Qp(m,g).getMediaError()}))}},rm=class{constructor(g){this.detail=g}getStream(g){throw this.getError(g)}applyConstraints(g,m){throw this.getError(m)}applyConstraintsForTrack(g,m){throw this.getError(m)}getError(g){return{type:Ke.MEDIA_ERROR.unsupportedStream,detail:this.detail,message:this.detail,isAudio:!!g.audio}}},sm=class{static getStreamProvider(g,m,S){return"ScreenShare"===g?nm.isSupported()?new nm(S):(S.error("GUM stream provider cannot be created for display stream"),new rm("Sharing not supported")):new im(m,S)}},am=class extends je{constructor(g,m,S){super(S),this.mediaStream=g,this.logger=S,this.mediaStreamSubscriptions=[],this.isHold=!1,this.isMuted=this.mediaStream.getMuted(),this._isDisposed=!1,this.originalId=g.id,this.subscribeOnMediaStreamEvents(),this.update(m),this.logger.safe.info("ctor"),this.mediaType=this.mediaStream.mediaType}get id(){return this.originalId}get parentId(){return this.originalId}get rawStream(){return this.gumStream}get rawTrack(){return this.getTrackByMediaType(this.rawStream,this.mediaType)}get deviceId(){return this.mediaStream.deviceId}update(g){g&&(this.gumStream=g,this.enableDisableTracks())}dispose(){this._isDisposed?this.logger.safe.info("already disposed"):(this._isDisposed=!0,this.logger.safe.info("dispose"),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaStream&&(this.mediaStream.disposeClient(this),this.unsubscribeFromMediaStreamEvents(),this.mediaStream=null),this.event("onStreamClientDisposed").raise(this))}clone(){const g=this.mediaStream.getClient();return this.isMuted&&g.setMuted(!0),this.isHold&&g.setHold(!0),g}applyCapabilities(g){return this.mediaStream.applyCapabilities(g)}setMuted(g,m=generateCauseId()){this.isMuted=g||this.mediaStream.getMuted(),this.logger.safe.info(`[${m}] setMuted => ${this.isMuted}`),this.enableDisableTracks()}setHold(g){this.isHold=g,this.enableDisableTracks()}start(){return this.mediaStream.start()}hasAudio(){return this.mediaStream.hasAudio()}hasVideo(){return this.mediaStream.hasVideo()}hasDisplay(){return this.mediaStream.hasDisplay()}isSameStream(g){return this.parentId===g.parentId}getResolution(){return this.mediaStream.getResolution()}getFrameRate(){return this.mediaStream.getFrameRate()}isActive(){return!0}isDisposed(){return this._isDisposed}subscribeOnMediaStreamEvents(){this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamStarted",((g,m)=>{this.event("onStreamClientStarted").raise(this,m)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamError",((g,m)=>{this.event("onStreamClientError").raise(this,m)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackMuted",((g,m)=>{this.event("onStreamClientMuted").raise(this,m)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackEnded",((g,m)=>{this.event("onStreamClientEnded").raise(this,m)})))}unsubscribeFromMediaStreamEvents(){this.mediaStreamSubscriptions.forEach((g=>g.dispose())),this.mediaStreamSubscriptions=[]}enableDisableTracks(){this.gumStream?this.gumStream.getTracks().forEach((g=>{void 0!==g.enabled&&(g.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`Track ${JSON.stringify(g.id)} enabled state set to => ${g.enabled}`))})):this.logger.safe.warn("gumStream stream doesn't exist")}getTrackByMediaType(g,m){return"Audio"===m?g.getAudioTracks()[0]:g.getVideoTracks()[0]}},om=[30,15,7.5,3.75,1.875];function getResolutionForStream(g){return g&&g.getVideoTracks()[0]?getResolutionForTrack(g.getVideoTracks()[0]):null}function getResolutionForTrack(g){if(g&&g.getSettings){const m=g.getSettings();if(m)return{width:m.width,height:m.height}}return null}function getFrameRateForStream(g){return g&&g.getVideoTracks()[0]?getFrameRateForTrack(g.getVideoTracks()[0]):0}function getFrameRateForTrack(g){if(g&&g.getSettings){const m=g.getSettings();if(m)return getClosestValue(om,m.frameRate,!0)}return 0}var lm=class _MediaStreamInternal extends je{constructor(g,m,S,v){super(S),this.streamConstraints=g,this.serialQueue=m,this.configProvider=v,this.clientId=0,this.clients=[],this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.isMuted=!1,this.isHold=!1,this.gumStartTime=0,this.streamId=_MediaStreamInternal.streamGeneration++,this.logger=S.createChild(`MediaStream:${this.streamId}`),this.mediaType=this.getMediaType(this.streamConstraints),this.constraintsProvider=Jp.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(g)}get id(){return this.streamId}get rawStream(){return this.currentGumStream}get deviceId(){return this.rawStream?.getTracks()?.[0]?.getSettings?.()?.deviceId??null}applyCapabilities(g){if(this.currentGumStream){const m=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,g,this.getResolution());if(!m)return Promise.resolve(!1);if(this.currentConstraints!==m){this.currentConstraints=m;const g=this.currentConstraints;return this.hasDisplay()?this.applyConstraints(this.currentConstraints).then((()=>deepEqual(this.currentConstraints,g))).catch((g=>(this.logger.safe.error(`Apply constraints error: ${stringifyObject(g)}`),!1))):this.applyConstraintsInternal().then((()=>deepEqual(this.currentConstraints,g)))}}return Promise.resolve(!1)}getClient(){let g;this.currentGumStream?(g=this.getClone(),this.clientGumStreams.push({[this.constraintsProvider.getKey(this.currentConstraints)]:g})):this.clientGumStreams.push({});const m=new am(this,g,this.logger.createChild("Client:"+this.clientId++));return this.clients.push(m),m}getClone(){return this.hasDisplay()?this.currentGumStream:this.currentGumStream.clone()}setMuted(g){this.isMuted=g,this.clients.forEach((m=>{m.setMuted(g)})),this.enableDisableTracks()}getMuted(){return this.isMuted}setHold(g){this.isHold=g,this.clients.forEach((m=>{m.setHold(g)})),this.enableDisableTracks()}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(){for(let g=this.clients.length-1;g>=0;g--)this.clients[g].dispose()}disposeClient(g){const m=this.clients.indexOf(g);m>=0&&(this.clients.splice(m,1),this.streamsDump.push(this.clientGumStreams[m]),this.clientGumStreams.splice(m,1),0===this.clients.length)&&this.disposeStream()}async disposeStream(){this.event("onStreamDisposing").raise(this);try{await this.stopGumStream(),this.event("onStreamDisposed").raise(this)}catch(g){this.event("onStreamError").raise(this,g)}this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),super.dispose()}hasAudio(){return!!this.currentGumStream&&0!==this.currentGumStream.getAudioTracks().length}hasVideo(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId!==Ke.DISPLAY_SOURCE_ID}hasDisplay(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId===Ke.DISPLAY_SOURCE_ID}getVideoDeviceId(){return this.currentConstraints.video.deviceId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},m=getResolutionForStream(this.currentGumStream),S=m??g,v=`Stream resolution is ${S.width}x${S.height}.`;return m?this.logger.safe.info(v):this.logger.safe.error(`${v}. Resolution not found, assuming default resolution.'`),S}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g=getFrameRateForStream(this.currentGumStream);return 0===g?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${g}`),g}async startStream(g){let m;m=g.video?this.applyConstraintsInternal():this.updateGumStreamInternal(g);try{await m,this.event("onStreamStarted").raise(this,g)}catch(g){throw this.event("onStreamError").raise(this,g),g}}getMediaType(g){if(g.sharing)return"ScreenShare";if(g.video)return"Video";if(g.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(g)}`)}updateClients(g){const m=this.constraintsProvider.getKey(g);this.clients.forEach(((g,S)=>{this.clientGumStreams[S][m]||(this.clientGumStreams[S][m]=this.getClone()),g.update(this.clientGumStreams[S][m])}))}applyConstraints(g){const m=this.getGumStreamProvider();return Promise.all(this.clients.map((S=>m.applyConstraints(S.rawStream,g)))).then((()=>{}))}applyConstraintsInternal(){return new Promise(((g,m)=>{this.logger.safe.info(`applying stream constraints: ${JSON.stringify(scrubConstraints(this.currentConstraints))}`);const S=new or;this.clients.forEach((g=>{g.onApplyConstraints&&g.onApplyConstraints(S.promise)}));const v=this.serialQueue.add((()=>{const g=(new Yp).getPolicies(this.currentConstraints);return this.mediaStreamStartPromise=this.updateGumStreamInternal(g[0]),g.slice(1).forEach((g=>{this.mediaStreamStartPromise=this.mediaStreamStartPromise.catch((m=>{if(Ke.MEDIA_ERROR.constraintNotSatisfiedError===m.type)return this.logger.safe.warn("could not obtain constrained media stream, will attempt weaker policy"),this.updateGumStreamInternal(g);throw m.constraints=g,m}))})),this.mediaStreamStartPromise})).then((()=>{S.resolve()})).catch((g=>{throw this.logger.safe.error(`failed to apply constraints: ${JSON.stringify(scrubConstraints(g.constraints))} error: ${stringifyObject(g)}`),S.reject(g),g}));g(v)}))}enableDisableTracks(){this.currentGumStream&&this.currentGumStream.getTracks().forEach((g=>{void 0!==g.enabled&&(g.enabled=!("audio"===g.kind&&this.isMuted||this.isHold),this.logger.safe.info(`control media stream track kind: ${g.kind} enabled: ${g.enabled} muted: ${g.muted}`))}))}getGumStreamProvider(){return sm.getStreamProvider(this.mediaType,this.configProvider,this.logger.createChild("MSProvider"))}async updateGumStreamInternal(g){this.logger.safe.info(`querying user media for stream: ${JSON.stringify(g)}`),this.logger.safe.info("Getting GUM stream");const m=await this.getGumStream(g);this.logger.safe.info("Updating gum stream audio tracks"),this.updateGumStreamAudioTracks(m),this.currentGumStream=m,this.logger.safe.info("Updating stream constraints"),this.updateConstraints(g,m),this.logger.safe.info("Caching GUM stream"),this.cacheGumStream(this.currentConstraints,m),this.updateClients(this.currentConstraints),this.updateGumStreamVideoTracks(m),this.enableDisableTracks(),this.logger.safe.info("media stream updated");const S=this.stopRequestCalculation();this.event("onStreamAcquired").raise(this,S,(this.hasVideo()||this.hasDisplay())&&this.getResolution()||void 0)}async getGumStream(g){const m=this.gumStreams[this.constraintsProvider.getKey(g)];if(m)return m;const S=this.getGumStreamProvider();return this.startRequestCalculation(),S.getStream(g)}updateGumStreamAudioTracks(g){g.getAudioTracks().forEach((g=>{g.onended=g=>{this.logger.safe.info(`Audio stream track ended: ${JSON.stringify(g.error?.name||g)}`),this.event("onStreamTrackEnded").raise(this,g)},g.onmute=()=>{this.logger.safe.info("Audio stream track muted"),this.event("onStreamTrackMuted").raise(this,!0)},g.onunmute=()=>{this.logger.safe.info("Audio stream track unmuted"),this.event("onStreamTrackMuted").raise(this,!1)},g.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(g.id)}`)}))}updateGumStreamVideoTracks(g){const[m]=g.getVideoTracks();m&&(m.onmute=g=>{this.logger.safe.error(`Video stream track muted: ${JSON.stringify(scrubConstraints(this.currentConstraints))}; ${JSON.stringify(g)}`)},m.onended=g=>{this.logger.safe.info(`Video stream track ended: ${JSON.stringify(scrubConstraints(this.currentConstraints))}; ${JSON.stringify(g?.error.name||g)}`),this.event("onStreamTrackEnded").raise(this,g)},this.hasDisplay()&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(m,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(m.id)}`))}cacheGumStream(g,m){const S=this.constraintsProvider.getKey(g);this.gumStreams[S]!==m&&(this.gumStreams[S]&&(this.logger.safe.info(`Stream cache hit for ${S}, stopping old stream`),this.stopOneGumStream(this.gumStreams[S])),this.gumStreams[S]=m)}updateConstraints(g,m){this.currentConstraints=g.video?this.constraintsProvider.updateResolution(g,this.getResolution()):g,this.logger.safe.info(`Stream constraints updated: ${JSON.stringify(this.currentConstraints)}`)}applyContentHint(g,m){["","text","detail","motion"].indexOf(m)<0?this.logger.safe.error(`Cannot apply content hint: ${m}`):(this.logger.safe.info(`Apply content hint: ${m}`),g.contentHint=m)}startRequestCalculation(){this.gumStartTime=Date.now()}stopRequestCalculation(){if(0===this.gumStartTime)return 0;const g=Date.now()-this.gumStartTime;return this.gumStartTime=0,g}stopGumStream(){return this.mediaStreamStartPromise?(this.logger.safe.info("queueing media stream stop"),this.serialQueue.add((()=>{this.stopGumStreamInternal()}))):Promise.resolve()}stopOneGumStream(g){try{g.getTracks().forEach((g=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(g.id)}`),g.onended=null,g.onmute=null,g.stop()})),this.logger.safe.info("media stream stopped")}catch(g){this.logger.safe.warn(`failed to stop media stream: ${stringifyObject(g)}`)}}stopGumStreamInternal(){this.currentGumStream&&([...this.clientGumStreams,...this.streamsDump,this.gumStreams].forEach((g=>{forOwn(g,(g=>{this.stopOneGumStream(g)}))})),this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.currentGumStream=null)}};lm.streamGeneration=0;var cm=lm,dm=class extends je{constructor(g,m,S,v,C,_,E){super(E),this.id=g,this.masterStream=m,this.currentConstraints=S,this.constraintsProvider=v,this.streamProvider=C,this.configProvider=_,this._isDisposed=!1,this.masterStreamSubscriptions=[],this.mixerSubscriptions=[],this.parentId=m.id,this.logger=E.createChild(`C:${this.parentId}:${this.id}`),this.subscribeOnMasterStreamEvents()}get rawTrack(){return this.mediaTrack}get rawStream(){return this.rawMediaStream||(this.rawMediaStream=new MediaStream([this.mediaTrack]),this.configProvider.config.reassignMediaStreamAudioTrackAfterCreation&&this.rawMediaStream.getAudioTracks().length>0&&(this.rawMediaStream.removeTrack(this.rawMediaStream.getAudioTracks()[0]),this.rawMediaStream.addTrack(this.mediaTrack))),this.rawMediaStream}get deviceId(){return this.masterStream.deviceId}get mediaType(){return this.masterStream.mediaType}get originalMediaStream(){return this.masterStream.getOriginalMediaStream()}getCurrentConstraints(){return this.currentConstraints}dispose(g){this._isDisposed||(this._isDisposed=!0,this.logger.safe.info(`dispose: ${g}`),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaTrack&&(this.unsubscribeFromMediaTrackEvents(),this.mediaTrack=null),this.masterStream&&(this.unsubscribeFromMasterStreamEvents(),this.masterStream.disposeClient(this),this.masterStream=null),this.unsubscribeFromMixerTrackEvents(),super.dispose(),this.event("onStreamClientDisposed").raise(this))}async applyCapabilities(g){if(!this.mediaTrack)return!1;const m=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,g,this.getResolution());if(!m||!this.configProvider.config.recoverOnStreamUnmute&&this.currentConstraints===m)return!1;const applyConstraints=async g=>{try{return await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,m),this.currentConstraints=m,!0}catch(m){if(g)throw this.logger.safe.error(`Apply constraints error: ${JSON.stringify(m)}`),m;return this.logger.safe.warn(`Apply constraints failed and will be re-tried, error ${JSON.stringify(m)}`),!1}},S=this.currentConstraints.withEffect&&this.configProvider.config.effectsApplyConstraintsRetryMs;return!await applyConstraints(!S)&&S&&(await delay2(this.configProvider.config.effectsApplyConstraintsRetryMs),await applyConstraints(!0)),!0}start(){return this.masterStream.start()}clone(g){return null===this.masterStream&&this.logger.safe.error(`clone: master stream is null, reason: ${g}`),this.masterStream.getClient(`streamclient: ${g}`)}setMuted(g,m){this.isMuted=g,this.applyState(m)}setHold(g,m){this.isHold=g,this.applyState(m)}isSameStream(g){return this.parentId===g.parentId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},m=getResolutionForTrack(this.mediaTrack),S=m?.width?m:g,v=`Track resolution is ${S.width}x${S.height}.`;return m?.width?this.logger.safe.info(v):this.logger.safe.error(`${v}. Resolution not found, assuming default resolution.'`),S}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g=getFrameRateForTrack(this.mediaTrack);return 0===g?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${g}`),g}update(g){g?this.mediaTrack?this.logger.safe.error(`Media track is already created: ${this.mediaTrack.id}`):(this.mediaTrack=this.getTrackByMediaType(g,this.mediaType),this.updateTrackConstraints(),this.subscribeOnMediaTrackEvents(this.mediaTrack),this.hasMasterAudio=g&&g.getAudioTracks().length>0,this.hasMasterVideo=g&&g.getVideoTracks().length>0,this.hasMasterAudio&&this.hasMasterVideo&&(this.rawMediaStream=g),this.logger.safe.info(`Updated: ${printMediaStream(g)}`)):this.logger.safe.error("No master media stream, skipping update")}resetEffectsOutputConstraints(g){this.masterStream.resetEffectsOutputConstraints(g)}async updateTrackConstraints(){if("ScreenShare"!==this.mediaType)return;const g=this.masterStream.getResolution();if(g){const m=this.currentConstraints.clone();m.video.maxWidth=g.width,m.video.minWidth=g.width,m.video.maxHeight=g.height,m.video.minHeight=g.height;try{await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,m),this.currentConstraints=m}catch(g){this.logger.safe.error(`Apply constraints error: ${JSON.stringify(g)}`)}}}getTrackByMediaType(g,m){return"Audio"===m?g.getAudioTracks()[0]:g.getVideoTracks()[0]}applyState(g){this.mediaTrack&&void 0!==this.mediaTrack.enabled&&(this.mediaTrack.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`[${g}] Track ${JSON.stringify(this.mediaTrack.id)} enabled state set to => ${this.mediaTrack.enabled}`))}subscribeOnMediaTrackEvents(g){g.onended=m=>{this.logger.safe.info(`Track ${g.id} ended: ${JSON.stringify(m)}`),this.event("onStreamClientEnded").raise(this,m)},g.onmute=()=>{this.logger.safe.info(`Track ${g.id} muted`),this.event("onStreamClientMuted").raise(this,!0)},g.onunmute=()=>{this.logger.safe.info(`Track ${g.id} unmuted`),this.event("onStreamClientMuted").raise(this,!1)}}unsubscribeFromMediaTrackEvents(){this.mediaTrack.onended=null,this.mediaTrack.onmute=null,this.mediaTrack.onunmute=null}unsubscribeFromMixerTrackEvents(){this.mixerSubscriptions.forEach((g=>g.dispose())),this.mixerSubscriptions=[]}subscribeOnMasterStreamEvents(){this.masterStreamSubscriptions.push(this.masterStream.on("onStreamStarted",((g,m)=>this.event("onStreamClientStarted").raise(this,m))),this.masterStream.on("onStreamError",((g,m)=>this.event("onStreamClientError").raise(this,m))),this.masterStream.on("onStreamTrackMuted",((g,m)=>this.event("onStreamClientMuted").raise(this,m))),this.masterStream.on("onStreamDisposing",(g=>this.dispose())),this.masterStream.on("onStreamQualityChanged",((g,m,S,v)=>this.event("onStreamQualityChanged").raise(this,m,S,v))),this.masterStream.on("onStreamTrackEnded",((g,m)=>this.event("onStreamClientEnded").raise(this,m))))}unsubscribeFromMasterStreamEvents(){this.masterStreamSubscriptions.forEach((g=>g.dispose())),this.masterStreamSubscriptions=[]}hasAudio(){return this.hasMasterAudio}hasVideo(){return this.hasMasterVideo}isActive(){return this.mediaTrack?.enabled&&!this.mediaTrack?.muted&&"live"===this.mediaTrack?.readyState}onVideoStreamQualityChanged(g,m,S){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(g)}@${m}, reason=${S}`),this.masterStream.onVideoStreamQualityChanged(g,m,S)}isDisposed(){return this._isDisposed}},hm=class extends je{constructor(g,m,S,v,C,_){super(_),this.stream=g,this.constraints=m,this.constraintsProvider=S,this.gumStreamProvider=v,this.configProvider=C,this.logger=_,this.clients=[],this.streams=[],this.clientId=0,this.mediaStreamSubscription=this.stream.on("onStreamAcquired",(()=>this.onStreamAcquired()))}getClient(){const g=new dm(this.clientId++,this.stream,this.constraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger);return this.addClient(g),g}disposeClient(g){this.removeClient(g),this.clients.length||this.event("onAllClientsDisposed").raise()}dispose(){this.mediaStreamSubscription.dispose(),this.clients.length&&this.logger.safe.error(`Not all clients are disposed! ${JSON.stringify(this.clients.map((g=>g.id)))}`),this.streams.forEach((g=>this.disposeStream(g))),super.dispose()}getOrCreateStream(){const g=this.streams.length?this.streams[this.streams.length-1]:this.stream.rawStream;if(!g)return null;const m=g.clone();return this.logger.safe.info(`Cloned: ${printMediaStream(g)} -> ${printMediaStream(m)}`),this.resetStream(m),this.streams.push(m),m}addClient(g){this.updateClient(g),this.clients.push(g)}updateClient(g){const m=this.getOrCreateStream();m&&g.update(m)}removeClient(g){const m=this.clients.indexOf(g);this.clients.splice(m,1)}addStream(){this.clients.forEach((g=>this.updateClient(g)))}disposeStream(g){g.getTracks().forEach((g=>{this.logger.safe.info(`Stopping track: ${JSON.stringify(g.id)}`),g.stop()}))}onStreamAcquired(){this.addStream()}resetStream(g){g.getTracks().forEach((g=>{this.logger.safe.info(`Resetting state for track: ${g.id}`),g.enabled=!0}))}},um=class{static getStrategy(g,m,S,v,C,_){return _?new fm(S,v):"Video"===g?new mm(m,S,v,C):new pm(m,S,v)}},gm=class{constructor(g,m,S){this.gumStreamProvider=g,this.serialQueue=m,this.logger=S}getStream(g){return this.logger.safe.info(`Requesting stream with constraints: ${JSON.stringify(scrubConstraints(g))}`),this.serialQueue.add((()=>this.request(g)))}},pm=class extends gm{constructor(g,m,S){super(g,m,S.createChild("SimpleStrat"))}request(g){return this.gumStreamProvider.getStream(g)}},mm=class extends gm{constructor(g,m,S,v){super(g,m,S.createChild("MultStrat")),this.policyGenerator=new Yp}request(g){const m=this.policyGenerator.getPolicies(g);return this.makeRequests(m)}makeRequests(g){const m=g[0];return this.logger.safe.info(`Requesting media stream with policy: ${JSON.stringify(m)}`),this.makeRequestWithPolicy(m).catch((m=>{const S=g.slice(1);if(S.length&&Ke.MEDIA_ERROR.constraintNotSatisfiedError===m.type)return this.logger.safe.warn("Could not obtain constrained media stream, will attempt weaker policy"),this.makeRequests(S);throw m}))}makeRequestWithPolicy(g){return this.gumStreamProvider.getStream(g)}},fm=class extends gm{constructor(g,m){super(null,g,m.createChild("WithOveriddenStreamStart"))}request(g){return new Promise(((m,S)=>m(g.withOverridenStream)))}},Sm=class _SimulcastMediaStream extends je{constructor(g,m,S,v,C){super(v),this.serialQueue=m,this.configProvider=S,this.effectManager=C,this.gumRequestTime=0,this.id=_SimulcastMediaStream.streamId++,this.logger=v.createChild(`MediaStream:${this.id}`),this.mediaType=this.getMediaType(g),this.initialize(g)}get rawStream(){return this.mediaStream}get deviceId(){return this.originalMediaStream?this.originalMediaStream.getTracks()?.[0]?.getSettings?.()?.deviceId:null}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(g){this.event("onStreamDisposing").raise(this),this.stopMediaStream(g).catch((g=>{this.event("onStreamError").raise(this,g)})).finally((()=>{this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),this.clientGenerationStrategy.dispose(),this.event("onStreamDisposed").raise(this),super.dispose()}))}disposeClient(g){this.clientGenerationStrategy.disposeClient(g)}getClient(g){return this.logger.safe.debug(`getClient: ${g}`),this.clientGenerationStrategy.getClient()}getOriginalMediaStream(){return this.originalMediaStream}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},m=getResolutionForStream(this.mediaStream),S=m??g,v=`Stream resolution is ${S.width}x${S.height}.`;return m?this.logger.safe.info(v):this.logger.safe.error(`${v}. Resolution not found, assuming default resolution.'`),S}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g=getFrameRateForStream(this.mediaStream);return 0===g?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${g}`),g}getMediaType(g){if(g.sharing)return"ScreenShare";if(g.video)return"Video";if(g.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(g)}`)}resetEffectsOutputConstraints(g){const m=getResolutionForStream(this.originalMediaStream);this.effectManager.resetOutputConstraints("Video",{width:Math.min(g.width,m.width||Number.MAX_SAFE_INTEGER),height:Math.min(g.height,m.height||Number.MAX_SAFE_INTEGER)})}initialize(g){this.constraintsProvider=Jp.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(g),this.gumStreamProvider=sm.getStreamProvider(this.mediaType,this.configProvider,this.logger),this.mediaStreamRequestStrategy=um.getStrategy(this.mediaType,this.gumStreamProvider,this.serialQueue,this.logger,this.configProvider,!!this.currentConstraints.withOverridenStream),this.clientGenerationStrategy=new hm(this,this.currentConstraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger),this.clientGenerationStrategy.on("onAllClientsDisposed",(()=>this.onAllClientsDisposed()))}onAllClientsDisposed(){this.logger.safe.info("All clients are disposed, disposing master stream"),this.dispose()}async startStream(g){try{await this.getOrCreateMediaStream(g),this.event("onStreamStarted").raise(this,this.currentConstraints)}catch(g){throw this.event("onStreamError").raise(this,g),g}}async getOrCreateMediaStream(g){if(this.mediaStream)return Promise.resolve();const m=this.getRequestStartTimestamp(),S=await this.mediaStreamRequestStrategy.getStream(g);return this.gumRequestTime=this.getRequestDuration(m),this.handleMediaStreamRequestSuccess(S,g)}async handleMediaStreamRequestSuccess(g,m){const S=m.withOverridenStream&&m.withEffect&&this.configProvider.config.useRawMediaApiForVideoEffects;this.logger.safe.info(`Media stream acquired: ${printMediaStream(g)} with constraints: ${JSON.stringify(scrubConstraints(m))}`),this.originalMediaStream=g,this.subscribeToTrackEvents(this.originalMediaStream),m.withEffect&&!S?this.mediaStream=await this.getVideoEffectStream(g):this.mediaStream=g,"Audio"===this.mediaType&&await this.startNoiseSuppression(),this.currentConstraints=m,this.applyState(this.mediaStream),this.event("onStreamAcquired").raise(this,this.gumRequestTime,"Audio"!==this.mediaType&&this.getResolution()||void 0)}async getVideoEffectStream(g){this.sub=this.effectManager.on("onVideoStreamQualityChanged",((g,m,S)=>this.onVideoStreamQualityChanged(g,m,S)));const m=await this.effectManager.startEffect("Video",g);return this.logger.safe.info(`Media stream switched: ${printMediaStream(g)} -> ${printMediaStream(m)}`),m}subscribeToTrackEvents(g){const m=g?this.getTrackByMediaType(g,this.mediaType):null;m&&(m.onended=g=>{this.logger.safe.info(`Track ${m.id} ended: ${JSON.stringify(g)}`),this.event("onStreamTrackEnded").raise(this,g)},m.onmute=()=>{this.logger.safe.info(`Track ${m.id} muted`),this.event("onStreamTrackMuted").raise(this,!0)},m.onunmute=()=>{this.logger.safe.info(`Track ${m.id} unmute`),this.event("onStreamTrackMuted").raise(this,!1)})}unsubscribeFromTrackEvents(g){const m=g?this.getTrackByMediaType(g,this.mediaType):null;m&&(m.onended=null,m.onmute=null,m.onunmute=null)}getTrackByMediaType(g,m){return"Audio"===m?g.getAudioTracks()[0]:g.getVideoTracks()[0]}removeVideoEffectStream(){this.sub?.dispose(),this.effectManager.stopEffect("Video",this.mediaStream)}applyState(g){g.getAudioTracks()?.forEach((g=>this.applyAudioState(g)));const m=g.getVideoTracks()[0];this.applyVideoState(m)}applyAudioState(g){g&&(this.hasNonDefaultAudioProcessingConstraints()||"ScreenShare"===this.mediaType?this.applyContentHint(g,"music"):this.configProvider.config.defaultAudioContentHint&&this.applyContentHint(g,this.configProvider.config.defaultAudioContentHint),g.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(g.id)}`))}applyVideoState(g){g&&("ScreenShare"===this.mediaType&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(g,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(g.id)}`))}applyContentHint(g,m){this.logger.safe.info(`Apply content hint: ${m}`),g.contentHint=m}hasNonDefaultAudioProcessingConstraints(){const g=this.currentConstraints.audio;if(g){const m=this.configProvider.config.defaultAudioProcessingFlags;let S;return void 0===g.echoCancellation&&void 0===g.autoGainControl&&void 0===g.noiseSuppression||(S=0,void 0!==g.echoCancellation&&(S+=g.echoCancellation?2:0),void 0!==g.autoGainControl&&(S+=g.autoGainControl?1:0),void 0!==g.noiseSuppression&&(S+=g.noiseSuppression?4:0)),S!==m}return!1}getRequestStartTimestamp(){return Date.now()}getRequestDuration(g){return 0===g?0:Date.now()-g}async startNoiseSuppression(){this.logger.safe.info(`ECS keys for wasmvqe are: ${JSON.stringify(this.configProvider.config.wasmvqe)}`),this.logger.safe.info(`ECS keys for wasmdns are: ${JSON.stringify(this.configProvider.config.wasmdns)}`),this.mediaStream=await this.effectManager.startEffect("Audio",this.mediaStream)}stopMediaStream(g){return this.mediaStreamStartPromise?(this.logger.safe.info(`Queueing media stream stop: ${g}`),this.serialQueue.add((()=>this.stopMediaStreamInternal()))):Promise.resolve()}stopOneMediaStream(g){try{g.getTracks().forEach((g=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(g.id)}`),g.stop()})),this.logger.safe.info(`Media stream stopped: ${g.id}`)}catch(g){this.logger.safe.warn(`Failed to stop media stream: ${stringifyObject(g)}`)}}stopMediaStreamInternal(){"Video"===this.mediaType&&this.configProvider.config.enableVideoEffects&&this.removeVideoEffectStream(),this.mediaStream&&(this.stopOneMediaStream(this.mediaStream),this.mediaStream=null),this.originalMediaStream&&(this.stopOneMediaStream(this.originalMediaStream),this.unsubscribeFromTrackEvents(this.originalMediaStream),this.originalMediaStream=null)}onVideoStreamQualityChanged(g,m,S){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(g)}@${m}, reason=${S}`),this.event("onStreamQualityChanged").raise(this,g,m,S)}};Sm.streamId=0;var vm=Sm,Cm=class _MediaStreamManager extends je{constructor(g,m,S){super(g),this.logger=g,this.configProvider=m,this.effectsManager=S,this.cachedStreamsSubs=new Map,this.cachedStreamsMap=new Map,this.mediaStreamSerialQueue=new Ap(this.logger),this.couldUseWebrtc_1_0=!1}getMediaStream(g,m){this.logger.safe.info(`retrieving media stream: ${JSON.stringify(scrubConstraints(g))}`),this.cachedStreamsMap.size||(this.couldUseWebrtc_1_0=canUseWebrtc1_0(this.configProvider.config.checkSupportForWebrtc_1_0));let S=this.getSuitableStream(g);S||(this.logger.safe.info(`cached stream is not found. Creating a new one with constraints: ${stringifyObject(scrubConstraints(g))}`),S=this.createCachedStream(g)),this.logger.safe.info(`starting cached stream id=${S.id}`,m);const v=S.getClient(m);return v.start().catch((g=>{this.logger.safe.error(`could not start media stream: ${S.id}, total streams: ${this.cachedStreamsMap.size}, error: ${stringifyObject(g)}`),this.removeStream(S)})),v}dispose(){this.cachedStreamsSubs&&(this.cachedStreamsSubs.forEach((g=>{g.forEach((g=>{g.dispose()}))})),this.cachedStreamsSubs=null),this.cachedStreamsMap&&(this.cachedStreamsMap.forEach((g=>g.dispose("MSM dispose"))),this.cachedStreamsMap=null),this.mediaStreamSerialQueue&&(this.mediaStreamSerialQueue.dispose(),this.mediaStreamSerialQueue=null),super.dispose()}getCachedStreams(){return this.cachedStreamsMap}getActiveConstraints(){const g={audio:!1,video:!1,sharing:!1};return this.cachedStreamsMap.forEach(((m,S)=>{S.audio&&(g.audio=!0),S.video&&(g.video=!0),S.sharing&&(g.sharing=!0)})),g}onDevicesChanged(g){this.configProvider.config.enablePermissionsWorkaround&&_MediaStreamManager.isDeviceListEmpty(g)?this.logger.safe.info("Device list is empty, permission workaround enabled"):this.cachedStreamsMap.forEach(((m,S)=>{if(!S.sharing){const m=this.isDeviceOutdated(S.audio,g),v=this.isDeviceOutdated(S.video,g);(m||v)&&this.cachedStreamsMap.delete(S)}}))}getSuitableStream(g){let m;return this.cachedStreamsMap.forEach(((S,v)=>{this.isSuitable(this.addDeviceIdIfNecessary(S,v),g)&&(m=v)})),m&&this.cachedStreamsMap.get(m)}addDeviceIdIfNecessary(g,m){if(!g.deviceId)return m;const S=this.cloneStreamConstraints(m);return m.audio&&void 0===m.audio.deviceId&&(S.audio.deviceId=g.deviceId),m.video&&void 0===m.video.deviceId&&(S.video.deviceId=g.deviceId),m.sharing&&(S.sharing.deviceId=Ke.DISPLAY_SOURCE_ID),S}cloneStreamConstraints(g){return{...deepClone(g),withOverridenStream:g.withOverridenStream}}createCachedStream(g){const m=this.createStream(g);return this.event("onStreamCreated").raise(m.id,m.mediaType),this.subscribeOnStreamEvents(m),this.logger.safe.info(`created media stream, id: ${m.id} total: ${this.cachedStreamsMap.size}`),this.cachedStreamsMap.set(g,m),m}disposeCurrentDeviceStream(g){for(const[m,S]of this.cachedStreamsMap.entries())g.sharing||m.sharing||(_MediaStreamManager.deviceChanged(g.audio,m.audio)||_MediaStreamManager.deviceChanged(g.video,m.video))&&S.dispose("MSM dispose oneStreamPerDeviceType")}createStream(g){return this.configProvider.config.oneStreamPerDeviceType&&this.couldUseWebrtc_1_0&&this.disposeCurrentDeviceStream(g),this.configProvider.config.webrtcSimulcastSessionEnabled&&Vs.hasApplyConstraints()&&this.couldUseWebrtc_1_0?new vm(g,this.mediaStreamSerialQueue,this.configProvider,this.logger,this.effectsManager):new cm(g,this.mediaStreamSerialQueue,this.logger,this.configProvider)}subscribeOnStreamEvents(g){const m=[];m.push(g.on("onStreamAcquired",((g,m,S)=>this.onStreamAcquired(g,m,S)))),m.push(g.on("onStreamDisposing",(g=>this.onStreamDisposing(g)))),this.cachedStreamsSubs.set(g,m)}unsubscribeFromStreamEvents(g){this.cachedStreamsSubs.get(g).forEach((g=>g.dispose())),this.cachedStreamsSubs.delete(g)}removeStream(g){this.logger.safe.info(`release media stream generation: ${g.id} cached: ${this.cachedStreamsMap.size}`),this.cachedStreamsSubs.has(g)?(this.unsubscribeFromStreamEvents(g),this.cachedStreamsMap.delete(this.getConstraintsForStream(g)),this.getStreamsCountByType("Audio")||this.effectsManager.stopEffect("Audio"),this.cachedStreamsMap.size||this.event("onAllStreamsRemoved").raise()):this.logger.safe.warn(`skipping unknown stream ${g.id}`)}getConstraintsForStream(g){let m;return this.cachedStreamsMap.forEach(((S,v)=>{g===S&&(m=v)})),m}isSuitable(g,m){const S=!(!g.withOverridenStream||!m.withOverridenStream),v=S||m.sharing||this.isAcceptable(g.audio,m.audio)&&g.audioProcessingFlags===m.audioProcessingFlags,C=S||this.isAcceptable(g.video,m.video),_=this.configProvider.config.requireUserActionForAudioSharing&&m.sharing&&!!g.audio!=!!m.audio,E=this.isAcceptable(g.sharing,m.sharing),T=E&&this.isAcceptable(g.audio,m.audio),I=_?T:E,b=g.withEffect===m.withEffect,A=g.withOverridenStream?.id===m.withOverridenStream?.id;return!m.force&&v&&C&&I&&b&&A}isAcceptable(g,m){return!g&&!m||g&&m&&g.deviceId===m.deviceId}isDeviceOutdated(g,m){return g?.deviceId&&!m.some((m=>m.deviceId===g.deviceId))}onStreamDisposing(g){this.logger.safe.info(`onStreamDisposing event ${g.id}`),this.event("onStreamDisposing").raise(g.id,g.mediaType),this.removeStream(g)}onStreamAcquired(g,m,S){const v="Audio"===g.mediaType?void 0:!!g.rawStream.getAudioTracks()[0],C="ScreenShare"===g.mediaType?this.getSharingSource(g):void 0;this.event("onStreamAcquired").raise(g.id,g.mediaType,m,S,v,C)}getSharingSource(g){const m=g.rawStream.getVideoTracks()[0],S=m.getConstraints();if(S?.deviceId)return"camera";const v=m.getSettings();return v?.displaySurface??"unknown"}static deviceChanged(g,m){return!(!g||!m)&&g.deviceId!==m.deviceId}static isDeviceListEmpty(g){return g.every((g=>""===g.label))}getStreamsCountByType(g){let m=0;return this.cachedStreamsMap.forEach((S=>{m+=S.mediaType===g?1:0})),m}},_m=class{constructor(g,m,S,v,C){this.deviceId=g,this.label=m,this.kind=S,this.groupId=v,this.capabilities=C,this.type=this.getType(this.kind),this.guid=`${this.type}:${this.deviceId}`,this.isSystemDefault=this.deviceId===Ke.MEDIA_DEVICE.defaultId}toDeviceDesc(){return{id:this.guid,browserId:this.deviceId,label:this.label,kind:this.type}}getType(g){switch(g){case Ke.MEDIA_DEVICE_KIND.audioInput:return Ke.MEDIA_DEVICE.microphone;case Ke.MEDIA_DEVICE_KIND.audioOutput:return Ke.MEDIA_DEVICE.speaker;case Ke.MEDIA_DEVICE_KIND.videoInput:return Ke.MEDIA_DEVICE.camera;case Ke.MEDIA_DEVICE_KIND.compositeAudio:return Ke.MEDIA_DEVICE.compositeAudio;case Ke.MEDIA_DEVICE_KIND.virtualDevice:return Ke.MEDIA_DEVICE.virtualDevice;default:throw new Error(`Device kind to recognized: ${g}`)}}},ym=class extends _m{constructor(g,m,S,v){super(g,m,S,v)}},Em=class extends _m{constructor(g,m,S,v,C){super(g,m,S,v,C)}toDeviceDesc(){const g=super.toDeviceDesc();return g.isSystemDefault=this.isSystemDefault,g}},Tm=class extends _m{constructor(g,m,S,v,C){if(super(g,m,S,v,C),this.position="unknown",C&&C.facingMode&&1===C.facingMode.length)switch(C.facingMode[0]){case"user":this.position="front";break;case"environment":this.position="back"}}toDeviceDesc(){const g=super.toDeviceDesc();return g.position=this.position,g}},Im=class extends _m{constructor(g,m,S,v,C,_){super(null,S,v,""),this.micDevice=g,this.speakerDevice=m,this.formFactor=C,this.isPcInternalDevice=_,this.guid=null,this.isSystemDefault=!1}get micDeviceId(){return this.micDevice.guid}get speakerDeviceId(){return this.speakerDevice.guid}toDeviceDesc(){const g=super.toDeviceDesc();return g.microphoneId=this.micDeviceId,g.speakerId=this.speakerDeviceId,g.formFactor=this.formFactor,g.isPcInternalDevice=this.isPcInternalDevice,g}};function createDevice(g){const m=g.getCapabilities&&g.getCapabilities();switch(m&&(delete m.groupId,delete m.deviceId),g.kind){case Ke.MEDIA_DEVICE_KIND.audioInput:case Ke.MEDIA_DEVICE_KIND.audioOutput:return new Em(g.deviceId,g.label,g.kind,g.groupId,m);case Ke.MEDIA_DEVICE_KIND.videoInput:return new Tm(g.deviceId,g.label,g.kind,g.groupId,m);default:throw new Error(`Device kind is not recognized: ${g.kind}`)}}function createCompositeAudioDevice(g,m,S){return new Im(g,m,S,"compositeAudio",0,!1)}function createDefaultDevice(g){const m={deviceId:Ke.MEDIA_DEVICE.defaultId,label:Ke.MEDIA_DEVICE.defaultDeviceLabel,kind:getKind(g),groupId:"",toJSON:()=>JSON.stringify(m)};return createDevice(m)}function getKind(g){switch(g){case Ke.MEDIA_DEVICE.microphone:return Ke.MEDIA_DEVICE_KIND.audioInput;case Ke.MEDIA_DEVICE.speaker:return Ke.MEDIA_DEVICE_KIND.audioOutput;case Ke.MEDIA_DEVICE.camera:return Ke.MEDIA_DEVICE_KIND.videoInput;default:throw new Error(`Device type to recognized: ${g}`)}}function compilePrimitiveDeviceList(g,m,S,v,C={str:""}){C.str+=`|input(${m.length})`;let _=[];const E=[v.config.devices.blacklist[g],v.defaultConfig.devices.blacklist[g]];for(const g of E)try{const S=new RegExp(g,"i");_=m.filter((m=>g&&m.label.match(S)?(C.str+=`|-blacklisted(${m.label})`,!1):m.deviceId!==Ke.MEDIA_DEVICE.communicationsId||(C.str+="|-communications",!1)));break}catch(S){C.str+=`|filterError('${g}', ${stringifyObject(S)})`,_=m}if(_.length){const m=deductDefaultDevice(S,_,C);if(m&&(m.isSystemDefault=!0,C.str+=`|default(${scrubMriOrOmit(m.guid)})`),m&&m.deviceId!==Ke.MEDIA_DEVICE.defaultId&&_.length>1&&(_=_.filter((g=>g.deviceId!==Ke.MEDIA_DEVICE.defaultId||(C.str+="|-defaultId",!1)))),g===Ke.MEDIA_DEVICE.camera||m||(C.str+="|+syntheticDefault",_.unshift(createDefaultDevice(g))),S.forEach((g=>{const m=_.find((m=>m.guid===g.guid));m&&!m.label&&g.label&&(C.str+=`|migrateLabel(${scrubMriOrOmit(m.guid)})`,m.label=g.label)})),g===Ke.MEDIA_DEVICE.speaker){const g=_.filter((g=>""===g.label));g.length>1&&g.length===_.length&&(_=m?[m]:[_[0]],C.str+=`|-filteredEmptyLabels(${g.length})`)}}return _}function deductDefaultDevice(g,m,S){if(1===m.length)return S.str+="|default:only",m[0];const v=m.find((g=>g.isSystemDefault&&g.deviceId===Ke.MEDIA_DEVICE.defaultId));if(!v)return S.str+="|default:noSynthetic",m.find((g=>g.isSystemDefault))||m[0];{const C=m.filter((g=>g!==v));if(1===C.length)return S.str+="|default:firstNonDefault",C[0];if(""!==v.groupId){const g=C.filter((g=>g.groupId===v.groupId));if(1===g.length)return S.str+=`|default:groupId(${scrubMriOrOmit(g[0].guid)})`,g[0]}const _=C.map((g=>g.label)),E=getMaxSubstring(v.label,_),T=C.find((g=>g.label===E));if(T)return S.str+=`|default:label(${scrubMriOrOmit(T.guid)})`,T;const I=g.find((g=>g.isSystemDefault));if(I){const g=C.find((g=>g.deviceId===I.deviceId));if(g)return S.str+=`|default:previousList(${scrubMriOrOmit(g.guid)})`,g}}return S.str+="|default:anyOrNull",m.find((g=>g.isSystemDefault))||null}function compileAudioDeviceList(g,m,S=.5,v={str:""}){const C=[];if(g.length&&m.length){const _=getGroupedPairs(g.filter((g=>""!==g.groupId)),m.filter((g=>""!==g.groupId)),v);_.length&&(C.push(..._.map((g=>createCompositeAudioDevice(g.microphone,g.speaker,createCompositeDeviceLabel(g.microphone.label,g.speaker.label))))),v.str+=`|directMatched(${C.length})`);const E=C.length;C.push(...composeAudioDevicesFromLabels(g.filter((g=>!C.some((m=>m.micDeviceId===g.guid)))),m.filter((g=>!C.some((m=>m.speakerDeviceId===g.guid)))),S,v)),v.str+=`|otherMatched(${C.length-E})`}return C}function getGroupedPairs(g,m,S={str:""}){const v=new Set;for(const S of[...g,...m])v.add(S.groupId);const C=[];for(const _ of v.values()){let v=g.filter((g=>g.groupId===_)),E=m.filter((g=>g.groupId===_));if(v&&E)if(1===v.length&&1===E.length)C.push({microphone:v[0],speaker:E[0]}),S.str+=`|pairSimple(${scrubMriOrOmit(v[0].guid)}, ${scrubMriOrOmit(E[0].guid)})`;else if(v.length>1||E.length>1){let g=getMostSimilarPair(v,E);for(;g;)S.str+=`|pairComplex(${scrubMriOrOmit(g.microphone.guid)}, ${scrubMriOrOmit(g.speaker.guid)})`,C.push(g),v=v.filter((m=>m!==g.microphone)),E=E.filter((m=>m!==g.speaker)),g=getMostSimilarPair(v,E)}}return C}function getMostSimilarPair(g,m){let S=999,v=null;if(g.length>0&&m.length>0)for(const C of g)for(const g of m){const m=levenshteinDistance(C.label,g.label);m<S&&(S=m,v={microphone:C,speaker:g})}return v}function composeAudioDevicesFromLabels(g,m,S,v){const C=[];return g.length&&m.length?(g.forEach((g=>{const _=m.filter((m=>m.groupId===g.groupId));if(!_.length)return void(v.str+=`|lbl_nocand(${scrubMriOrOmit(g.guid)})`);let E=getLongestCommonContiguousSubstring(g.label,_[0].label).length;const T=_.sort(((m,S)=>{const v=getLongestCommonContiguousSubstring(g.label,m.label),C=getLongestCommonContiguousSubstring(g.label,S.label);return v.length>E&&(E=v.length),C.length>E&&(E=C.length),C.length-v.length}));if(T.length){const m=E/g.label.length;m>S&&(C.push(createCompositeAudioDevice(g,T[0],createCompositeDeviceLabel(g.label,T[0].label))),v.str+=`|lbl_matched(${scrubMriOrOmit(g.guid)} & ${scrubMriOrOmit(T[0].guid)}, ${Math.round(1e4*m)/100}%)`)}})),C):C}function createCompositeDeviceLabel(g,m){if(g===m)return g;let S=getLongestCommonContiguousSubstring(g,m);S=S.trim().replace(/^\((.+)\)$/,"$1");let v="",C="",_=0;const E=[countBraces(g),countBraces(m)];if(0===E[0]||0===E[1])return S;for(let g=0;g<S.length;g++)if("("===S[g])_++,C+=S[g];else if(")"===S[g]){if(!(_>0))break;_--,C+=S[g],v+=C,C=""}else _>0?C+=S[g]:v+=S[g];const T=countBraces(v);return T!==E[0]&&T!==E[1]||(v=v.replace(/\w+\s?\((.+)\)/,"$1"),v=createCompositeDeviceLabel(S,v)),v.trim()}function countBraces(g){const m=["(",")"];let S=0;for(let v=0;v<g.length;v++)m.some((m=>g[v]===m))&&S++;return S}var bm={microphone:"",camera:"",speaker:"",compositeAudio:"",audioIngestDevice:"",virtualDevice:""},Am=class extends je{constructor(g,m){super(m),this.configProvider=g,this.logger=m,this.debugInfo=bm,this.lists=new Map,this.lists.set(Ke.MEDIA_DEVICE.microphone,[]),this.lists.set(Ke.MEDIA_DEVICE.camera,[]),this.configProvider.userAgentConfig.isAudioOutputSelectionSupported&&(this.lists.set(Ke.MEDIA_DEVICE.speaker,[]),this.lists.set(Ke.MEDIA_DEVICE.compositeAudio,[])),g.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>this.onConfigUpdated())),this.logger.safe.info("Initialized")}get devices(){const g=[];return this.lists.forEach((m=>g.push(...m))),g}getDevicesByType(g){return this.lists.get(g)??[]}updateDevices(g,m=!1){if(deepEqual(this.latestRawList,g))return;this.latestRawList=g;const S=this.devices;this.debugInfo.microphone="microphone",this.debugInfo.camera="camera",this.debugInfo.speaker="speaker",this.debugInfo.compositeAudio="compositeAudio",this.updatePrimitiveDeviceList(Ke.MEDIA_DEVICE.microphone,g.filter((g=>g.type===Ke.MEDIA_DEVICE.microphone))),this.updatePrimitiveDeviceList(Ke.MEDIA_DEVICE.camera,g.filter((g=>g.type===Ke.MEDIA_DEVICE.camera))),this.lists.get(Ke.MEDIA_DEVICE.speaker)&&(this.updatePrimitiveDeviceList(Ke.MEDIA_DEVICE.speaker,g.filter((g=>g.type===Ke.MEDIA_DEVICE.speaker))),this.lists.get(Ke.MEDIA_DEVICE.compositeAudio)&&this.updateCompositeAudioDeviceList(this.lists.get(Ke.MEDIA_DEVICE.microphone),this.lists.get(Ke.MEDIA_DEVICE.speaker)));const v=this.lists.get(Ke.MEDIA_DEVICE.compositeAudio)||[];this.lists.set(Ke.MEDIA_DEVICE.microphone,this.orderDeviceList(this.lists.get(Ke.MEDIA_DEVICE.microphone),v)),this.lists.get(Ke.MEDIA_DEVICE.speaker)&&this.lists.set(Ke.MEDIA_DEVICE.speaker,this.orderDeviceList(this.lists.get(Ke.MEDIA_DEVICE.speaker),v));const C=this.lists.get(Ke.MEDIA_DEVICE.microphone);this.setTopItemToDefault(C);const _=this.lists.get(Ke.MEDIA_DEVICE.speaker);this.setTopItemToDefault(_),deepEqual(S,this.devices)||(this.logger.safe.info("Device lists updated and changed"),this.logger.safe.info(this.debugInfo.microphone),this.logger.safe.info(this.debugInfo.camera),this.logger.safe.info(this.debugInfo.speaker),this.logger.safe.info(this.debugInfo.compositeAudio),this.event("onDevicesChanged").raise(this.devices,m))}updateVirtualDeviceList(g){const m=this.lists.get(Ke.MEDIA_DEVICE.virtualDevice),S=g.map((g=>new ym(g.id,g.label,"virtualDevice","")));deepEqual(m,S)?this.logger.safe.info("Device lists did not change."):(this.lists.set(Ke.MEDIA_DEVICE.virtualDevice,S),this.event("onDevicesChanged").raise(this.devices,!1))}updateActiveMicrophone(g){if(!g||g.deviceId===Ke.MEDIA_DEVICE.defaultId)return;const m=this.lists.get(Ke.MEDIA_DEVICE.microphone),S=m.findIndex((g=>g.isSystemDefault));-1!==S&&m[S]!==g?(this.logger.safe.info("Removing synthetic default microphone"),g.isSystemDefault=!0,m.splice(S,1),this.lists.set(Ke.MEDIA_DEVICE.microphone,m),this.event("onDevicesChanged").raise(this.devices,!1)):g.isSystemDefault=!0}updatePrimitiveDeviceList(g,m){const S={str:this.debugInfo[g]};this.lists.set(g,compilePrimitiveDeviceList(g,m,this.lists.get(g)||[],this.configProvider,S)),this.debugInfo[g]=S.str}updateCompositeAudioDeviceList(g,m){const S={str:this.debugInfo.compositeAudio};this.lists.set(Ke.MEDIA_DEVICE.compositeAudio,compileAudioDeviceList(g,m,this.configProvider.config.devices.compositeLabelMatchingThreshold,S)),this.debugInfo.compositeAudio=S.str}orderDeviceList(g,m){return g.sort(((g,S)=>this.getDevicePriority(S,this.getCompositeAudioDeviceCounterpart(S,m))-this.getDevicePriority(g,this.getCompositeAudioDeviceCounterpart(g,m))))}getCompositeAudioDeviceCounterpart(g,m){const S=m.find((m=>m.micDeviceId===g.guid||m.speakerDeviceId===g.guid));return S?S[g.type===Ke.MEDIA_DEVICE.speaker?"micDevice":"speakerDevice"]:null}getDevicePriority(g,m){let S=0;return this.configProvider.config.devices.overrideDefault&&m&&(!g.isSystemDefault&&m.isSystemDefault?(this.debugInfo[g.type]+=`|overrideDefault(${scrubMriOrOmit(g.guid)})`,S+=10):g.isSystemDefault&&!m.isSystemDefault&&"microphone"===g.type&&(S+=15)),g.isSystemDefault&&(S+=5),m&&(S+=1,m.isSystemDefault&&(S+=2)),S}setTopItemToDefault(g){g?.length&&(g.forEach((g=>g.isSystemDefault=!1)),g[0].isSystemDefault=!0)}onConfigUpdated(){let g=!1;this.configProvider.userAgentConfig.isAudioOutputSelectionSupported?this.lists.has(Ke.MEDIA_DEVICE.speaker)||(this.lists.set(Ke.MEDIA_DEVICE.speaker,[]),this.lists.set(Ke.MEDIA_DEVICE.compositeAudio,[]),g=!0):(this.lists.has(Ke.MEDIA_DEVICE.speaker)&&(this.lists.delete(Ke.MEDIA_DEVICE.speaker),g=!0),this.lists.has(Ke.MEDIA_DEVICE.compositeAudio)&&(this.lists.delete(Ke.MEDIA_DEVICE.compositeAudio),g=!0)),g&&(this.logger.safe.info("Updating device list due to config update"),this.updateDevices(this.latestRawList||[]))}},Rm=class _DeviceEnumerator extends je{constructor(g,m){super(m),this.pollingInterval=0,_DeviceEnumerator.enumeratorUsers.add(this),_DeviceEnumerator.initialize(this,g,m)}startDevicePolling(g){this.pollingInterval=g?_DeviceEnumerator.configProvider.config.devices.pollingIntervalIdle:_DeviceEnumerator.configProvider.config.devices.pollingIntervalActive,_DeviceEnumerator.updatePollingTask()}stopDevicePolling(g){this.pollingInterval=g?0:_DeviceEnumerator.configProvider.config.devices.pollingIntervalIdle,_DeviceEnumerator.updatePollingTask()}dispose(){super.dispose(),this.stopDevicePolling(!0),_DeviceEnumerator.enumeratorUsers.delete(this),0===_DeviceEnumerator.enumeratorUsers.size&&(_DeviceEnumerator.logger.safe.info("disposing"),_DeviceEnumerator.initializeCalled=!1,_DeviceEnumerator.isInitialized=new or,_DeviceEnumerator.list=void 0,_DeviceEnumerator.window.navigator.mediaDevices.ondevicechange=void 0)}static get isPolling(){return 0!==_DeviceEnumerator.currentPollingInterval}static initialize(g,m,S){_DeviceEnumerator.initializeCalled||(_DeviceEnumerator.initializeCalled=!0,_DeviceEnumerator.window=Us.window,_DeviceEnumerator.configProvider=m,_DeviceEnumerator.logger=S,_DeviceEnumerator.list=new Am(m,S.createChild("DeviceList")),m.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>_DeviceEnumerator.enumerateDevices())),m.on("configUpdated",(()=>{void 0!==m.config.devices.pollingIntervalIdle&&null!==_DeviceEnumerator.pollingTimer&&g.startDevicePolling(!0)})),m.config.devices.pollingIntervalIdle&&m.config.devices.idlePollingOnStart&&g.startDevicePolling(!0),_DeviceEnumerator.window.navigator.mediaDevices&&(_DeviceEnumerator.window.navigator.mediaDevices.ondevicechange=()=>{S.safe.info("enumerating due to ondevicechange callback"),_DeviceEnumerator.enumerateDevices().catch((g=>{S.safe.error(`unable to enumerate ondevicechange: ${stringifyObject(g)}`)}))}),_DeviceEnumerator.enumerateDevices().then((()=>_DeviceEnumerator.isInitialized.resolve())).catch((g=>_DeviceEnumerator.isInitialized.reject(g))))}static async enumerateDevices(g=!1){if(!_DeviceEnumerator.window.navigator?.mediaDevices?.enumerateDevices)throw new Error("device enumeration unsupported");if(_DeviceEnumerator.enumerateDevicesPromise&&!g)return _DeviceEnumerator.logger.safe.info("enumeration request postponed"),void(_DeviceEnumerator.hasPendingUpdate=!0);try{_DeviceEnumerator.enumerateDevicesPromise??(_DeviceEnumerator.enumerateDevicesPromise=_DeviceEnumerator.configProvider.config.devices.enumerateDevicesTimeout?timeout(_DeviceEnumerator.window.navigator.mediaDevices.enumerateDevices(),_DeviceEnumerator.configProvider.config.devices.enumerateDevicesTimeout,"enumerateDevices"):_DeviceEnumerator.window.navigator.mediaDevices.enumerateDevices());const m=await _DeviceEnumerator.enumerateDevicesPromise;_DeviceEnumerator.list.updateDevices(m.map((g=>createDevice(g))),g)}catch(g){const m=stringifyObject(g);throw _DeviceEnumerator.logger.safe.warn(`error with enumerating devices: ${m}`),_DeviceEnumerator.raiseFailedEnumeration(m),g}finally{_DeviceEnumerator.enumerateDevicesPromise=void 0,_DeviceEnumerator.hasPendingUpdate&&(_DeviceEnumerator.hasPendingUpdate=!1,_DeviceEnumerator.logger.safe.info("running postponed enumeration"),_DeviceEnumerator.enumerateDevices())}}static updatePollingTask(){let g=Number.MAX_SAFE_INTEGER;for(const m of _DeviceEnumerator.enumeratorUsers.values())m.pollingInterval<g&&(g=m.pollingInterval);if(g===Number.MAX_SAFE_INTEGER&&(g=0),(_DeviceEnumerator.pollingTimer||_DeviceEnumerator.currentPollingInterval!==g)&&_DeviceEnumerator.pollingTimer&&(_DeviceEnumerator.window.clearTimeout(_DeviceEnumerator.pollingTimer),_DeviceEnumerator.pollingTimer=void 0),_DeviceEnumerator.currentPollingInterval=g,0===g)return;const pollingTask=async()=>{if(_DeviceEnumerator.currentPollingInterval)try{await _DeviceEnumerator.enumerateDevices(!0),_DeviceEnumerator.pollingTimer=_DeviceEnumerator.window.setTimeout(pollingTask,_DeviceEnumerator.currentPollingInterval)}catch(g){throw _DeviceEnumerator.pollingTimer=null,g}};_DeviceEnumerator.logger.safe.info(`starting device polling with interval ${g}ms`),_DeviceEnumerator.pollingTimer=1,pollingTask()}static raiseFailedEnumeration(g){for(const m of _DeviceEnumerator.enumeratorUsers.values())m.event("onDeviceEnumerationfailed").raise(g)}};Rm.isInitialized=new or,Rm.initializeCalled=!1,Rm.currentPollingInterval=0,Rm.hasPendingUpdate=!1,Rm.enumeratorUsers=new Set;var Pm=Rm,Mm=class extends je{constructor(g,m,S){super(S),this.deviceList=g,this.configProvider=m,this.logger=S,this.userSelectedDevices={microphone:null,camera:null,speaker:null},this.currentlySelectedDevices={microphone:null,camera:null,speaker:null,audioIngestDevice:null},this.deviceList.on("onDevicesChanged",(g=>this.onDevicesChanged(g))),g.devices.length>0&&this.onDevicesChanged(g.devices),this.logger.safe.info("Initialized")}get selectedDevices(){return deepClone(this.currentlySelectedDevices)}selectDevices(g){let m=!1;if(forOwn(g,((g,S)=>{const v=this.getDeviceToSelect(S,this.deviceList.getDevicesByType("audioIngestDevice"===S?"microphone":S),g);"camera"===S&&(this.userSelectedDevices[S]=v?.guid||this.userSelectedDevices[S]),v?.guid!==this.currentlySelectedDevices[S]?.guid&&(this.userSelectedDevices[S]=v?.guid||this.userSelectedDevices[S],m=!0),this.currentlySelectedDevices[S]=v})),m){const g=values(this.currentlySelectedDevices).map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed from public interface: ${g}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!0)}}getDeviceToSelect(g,m,S){let v;const C=this.userSelectedDevices[g];return S?v=m.find((g=>g.guid===S)):C&&(v=m.find((g=>g.guid===C))),"audioIngestDevice"===g?v:v||m[0]}onDevicesChanged(g){let m=!1;if(Object.keys(this.currentlySelectedDevices).forEach((S=>{const v="audioIngestDevice"===S?"microphone":S,C=g.filter((g=>g.type===v));if(C.length>0){const g=this.getDeviceToSelect(S,C);g?.guid!==this.currentlySelectedDevices[S]?.guid&&(this.currentlySelectedDevices[S]=g,m=!0)}else this.currentlySelectedDevices[S]&&(this.currentlySelectedDevices[S]=null,m=!0)})),m){const g=values(this.currentlySelectedDevices).map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed due to device list change: ${g}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!1)}}},wm=class extends je{constructor(g,m){super(g),this.logger=g,this.mediaStream=m,this.subs=[],this.subscribeOnMediaStreamEvents(m)}acquire(){return this.mediaStream?this.mediaStream.start().then((()=>this.logger.safe.info("Stream acquired"))).catch((g=>{throw this.logger.safe.warn(`Failed to acquire the stream: ${stringifyObject(g)}`),g})):Promise.reject("Disposed")}dispose(){this.logger.safe.info("Disposing stream"),this.unsubscribeFromMediaStreamEvents(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null)}subscribeOnMediaStreamEvents(g){this.subs=[g.on("onStreamClientStarted",(()=>this.event("onStreamStateChanged").raise("active"))),g.on("onStreamClientMuted",((g,m)=>this.event("onStreamStateChanged").raise(m?"inactive":"active"))),g.on("onStreamClientEnded",(()=>this.event("onStreamStateChanged").raise("stopped"))),g.on("onStreamClientError",((g,m)=>{const S=m.type===Ke.MEDIA_ERROR.permissionDeniedError||m.type===Ke.MEDIA_ERROR.sharingCancelledError;this.event("onStreamStateChanged").raise(S?"cancelled":"failed")}))]}unsubscribeFromMediaStreamEvents(){this.subs.forEach((g=>g.dispose())),this.subs=[]}},Dm=[Ke.MEDIA_STATE.inactive,Ke.MEDIA_STATE.receive,Ke.MEDIA_STATE.send,Ke.MEDIA_STATE.sendReceive],Om=[Ke.MEDIA_STATE.inactive,Ke.MEDIA_STATE.receive],Nm=class extends je{constructor(g,m,S){super(S),this.configProvider=g,this.deviceManager=m,this.logger=S,this.currentState={microphone:"unknown",camera:"unknown"},this.lastGum={audio:!1,video:!1},this.registeredTrackers=new Set,this.accessIssuePermissionOther={audio:!1,video:!1},this.window=Us.window,this.permittedModalities={audio:Dm,video:Dm,sharing:Dm},this.initialize()}async initialize(){!Vs.hasPermissionsApi()||"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera?"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera||this.logger.safe.warn(`Permissions API is not supported in this browser. Microphone: ${this.currentState.microphone}, camera: ${this.currentState.camera}`):(this.logger.safe.info("Initializing"),await this.registerPermissionTracker("microphone"),await this.registerPermissionTracker("camera"))}getPermissionState(g){return this.currentState[g]||"unknown"}isPermissionKnown(g){const m=this.getPermissionState(g);return"unknown"!==m&&"prompt"!==m}get browserPermittedModalities(){return this.permittedModalities}get knownPermissionStates(){return deepClone(this.currentState)}update(g,m){const S=deepClone(m);g.audio||delete S.audio,g.video||delete S.video;const v=deepClone(this.permittedModalities);forOwn(S,((g,m)=>{this.permittedModalities[m]=g?Dm:Om})),deepEqual(v,this.permittedModalities)||this.event("onDevicesPermissionChanged").raise()}async askDevicePermission(g){const m=g?deepClone(g):{audio:!0,video:this.deviceManager.hasCamera()};if(this.accessIssuePermissionOther={audio:!1,video:!1},this.configProvider.config.permissions.rememberNegative&&(m.audio=m.audio&&this.permittedModalities.audio===Dm,m.video=m.video&&this.permittedModalities.video===Dm),m.sharing)throw new Error("askDevicePermission does not support sharing constraints.");const S={audio:!1,video:!1};this.lastGum={audio:!1,video:!1};const resolve=async(S,v,C)=>{const _={audio:!!S.audio,video:!!S.video,sharing:!0};return!(this.configProvider.config.permissions.adpRequestAVLast&&m.audio&&m.video)||this.lastGum.audio&&this.lastGum.video||(this.logger.safe.info("Prompting for audio and video to ensure omnibar state"),await this.askDevicePermissionPrompt({audio:!0,video:!0},!1)),this.update(m,_),this.deviceManager.raiseTelemetryEvent("ask_device_permission",{constraints:g,resultConstraints:S,error:C,reason:v}),_};await this.initialize();const v=this.getPermissionState("microphone"),C=this.getPermissionState("camera");if(this.logger.safe.info(`Permission state { audio: ${v}, video: ${C} }`),this.configProvider.config.permissions.useNegativeInAdp&&(!m.audio||"denied"===v)&&(!m.video||"denied"===C))return resolve(S,"navigator_permissions_denied");if(this.configProvider.config.permissions.usePositiveInAdp&&(!m.audio||m.audio&&"granted"===v)&&(!m.video||m.video&&"granted"===C))return resolve(m,"navigator_permissions_granted");try{return resolve(this.getConstrainsWithPermissionError(await this.askDevicePermissionPrompt(m,this.configProvider.config.permissions.adpFallback)),"stream_acquisition")}catch(g){return resolve(S,"stream_acquisition",g)}}async askDevicePermissionPrompt(g,m=!0){const S={audio:!1,video:!1};try{const m=await this.deviceManager.getMediaStream(g);return m&&(this.lastGum=deepClone(g),await m.start(),S.audio=m.hasAudio(),S.video=m.hasVideo(),this.disposeLater(m)),S}catch(v){if(g.audio&&g.video&&m){try{S.video=this.configProvider.config.permissions.adpFallbackVideo&&(await this.askDevicePermissionPrompt({video:!0})).video}catch(g){g.type!==Ke.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.video=!0)}try{S.audio=this.configProvider.config.permissions.adpFallbackAudio&&(await this.askDevicePermissionPrompt({audio:!0})).audio}catch(g){g.type!==Ke.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.audio=!0)}}else if(m)throw v;return S}}getConstrainsWithPermissionError(g){return this.configProvider.config.permissions.disableOnPermissionDeniedOnly?{audio:this.accessIssuePermissionOther.audio||g.audio,video:this.accessIssuePermissionOther.video||g.video}:g}disposeLater(g){setTimeout((()=>{g.dispose()}),this.configProvider.config.mediaStreamHoldInterval)}async registerPermissionTracker(g){if(!this.registeredTrackers.has(g))try{const m=await this.window.navigator.permissions.query({name:g});this.handlePermissionStateChanged(g,m.state),m.onchange=()=>this.handlePermissionStateChanged(g,m.state),this.registeredTrackers.add(g)}catch(m){this.logger.safe.error(`Error querying permissions for ${g}: ${stringifyObject(m)}`)}}handlePermissionStateChanged(g,m){this.logger.safe.info(`Permission state for ${g} changed ${this.currentState[g]} -> ${m}`),this.currentState[g]=m,this.deviceManager.raiseTelemetryEvent("permissions_state_changed",this.knownPermissionStates),this.deviceManager.handlePermissionStateChange()}},km=class extends Ge{constructor(g,m=uniqueId()){super(),this.dms=g,this.label=m,this.id=uniqueId(),this.receivedEvents=new Map,this.subscribeToDeviceManagers(g)}getDeviceManagers(){return this.dms}dispose(){super.dispose(),this.dms?.forEach((g=>g.dispose())),this.dms=null}subscribeToDeviceManagers(g){g.forEach(((g,m)=>{g.on("onVideoEffectsEvent",((...m)=>this.eventHandler("onVideoEffectsEvent",g,(()=>this.event("onVideoEffectsEvent").raise(...m))))),g.on("onVideoEffectApplied",((...m)=>this.eventHandler("onVideoEffectApplied",g,(()=>this.event("onVideoEffectApplied").raise(...m))))),g.on("onDeviceTelemetryEvent",(g=>this.event("onDeviceTelemetryEvent").raise({deviceId:`${this.id}/${m}`,...g}))),g.on("onVideoEffectsTelemetryEvent",(g=>this.event("onVideoEffectsTelemetryEvent").raise({deviceId:`${this.id}/${m}`,...g}))),g.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise(`${this.id}/${m}`))),g.on("onStreamUpdateRequested",((...g)=>this.event("onStreamUpdateRequested").raise(...g)))}))}eventHandler(g,m,S){let v=this.receivedEvents.get(g);v??(v=new Set),v.add(m);if(this.dms.every((g=>v.has(g))))return S(),void v.clear();this.receivedEvents.set(g,v)}},sequentialize=()=>(g,m,S)=>{const v=S.value;return S.value=function(...g){return this.serialQueue.add(v.bind(this,...g))},S},Lm=class{constructor(g){this.size=g,this.items=[]}clear(){this.items=[]}},Fm=class extends Lm{get isFull(){return this.items.length>=this.size}add(g){return this.isFull&&this.items.shift(),this.items.push(g),!0}},xm=class extends Lm{add(g){return!(this.items.length>=this.size)&&(this.items.push(g),!0)}},Um=class{constructor(g){this.error=new xm(g)}startLoadTimer(){this.loadStartTimestamp=Date.now()}stopLoadTimer(){this.loadDuration=Date.now()-this.loadStartTimestamp}clearErrors(){this.error.clear()}setError(g,m){this.error.add({type:g,message:m})}getReport(){return{loadDuration:this.loadDuration,error:this.error.items}}},Vm=class{constructor(g,m,S){this.configProvider=g,this.statistics=m,this.logger=S}isWasmEffectSupported(){return this.configProvider.config.webcv.useWasmEffects?!!window.MediaStreamTrackProcessor||(this.logger.info("wasmEffects disabled, insertable streams are not supported"),!1):(this.logger.info("wasmEffects disabled by feature flag"),!1)}isWebgl2EffectSupported(){return this.isCurrentRendererSupported()&&this.isWebGL2Supported()}isCurrentRendererSupported(){const g=this.configProvider.config.webcv.webGLUnsupportedRenderers;let m=!1;const S=Vs.unmaskedGlRenderer;return S&&!g.some((g=>g===S))?m=!0:(this.statistics.setError("RendererIsNotSupported",`Blacklisted from ${JSON.stringify(g)}`),this.logger.info(`Unsupported renderer: ${stringifyObject(S)}`)),m}isWebGL2Supported(){try{const g=document.createElement("canvas").getContext("webgl2");if(!g)return this.statistics.setError("WebGL2IsNotSupported"),this.logger.info("WebGL2 context is not supported"),!1;const m=g.getSupportedExtensions(),S=this.configProvider.config.webcv.webGLRequiredExtensions.filter((g=>!m.includes(g)));if(S.length>0)return this.statistics.setError("WebGL2RequiredExtensionsNotSupported","Required WebGL2 extensions not supported."),this.logger.info(`Unsupported WebGL2 extensions: ${stringifyObject(S)}`),!1}catch(g){return this.statistics.setError("WebGL2IsNotSupported",`Error: ${stringifyObject(g)}`),this.logger.error(`isWebGL2Supported: ${stringifyObject(g)}`),!1}return!0}},Bm=class extends je{constructor(g,m,S,v){super(S),this.webcvProvider=g,this.configProvider=m,this.logger=S,this.createWasmCVWorker=v,this.serialQueue=new Ap(this.logger),this.videoEffectToWebCVEffectMapping={0:Fn.VideoEffectType.Off,1:Fn.VideoEffectType.BackgroundBlur,16:Fn.VideoEffectType.BackgroundReplacement},this.effectType=0,this.isPortrait=!1,this.effectProviderSubs=[],this.statistics=new Um(this.configProvider.config.effectsTelemetryBufferSize),this.processorType=Fn.ProcessorType.Webgl2,this.lastNotifiedResolutions=new Map}get isEffectEnabled(){return 0!==this.effectType}async init(){if(!this.effectProvider){this.logger.safe.debug("Init");try{this.effectProvider=await this.initializeVideoEffectProvider()}catch(g){throw this.notifyError("FailedToInitialize",`Initialization failed, error:${stringifyObject(g)}`),g}}}async dispose(){this.logger.safe.debug("Dispose"),this.effectProvider&&(this.effectProviderSubs.forEach((g=>g.dispose())),this.effectProviderSubs=null,await this.effectProvider.disposeAsync()),this.lastNotifiedResolutions.clear(),super.dispose()}async configure(g){if(this.logger.safe.debug(`Set config: ${JSON.stringify(g)}`),this.effectConfig={backgroundImageUrl:g.imagePath,headers:g.headers},this.effectProvider)return this.effectProvider.configureEffect(this.effectConfig);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setEffectAsync(g){if(!this.shouldApplyEffect(g))return void this.logger.safe.debug(`Effect ${this.effectType} is already set`);this.effectProvider||(this.logger.safe.debug("Initializing effect provider"),await this.init()),this.logger.safe.debug(`Set effect: ${g}`);const m=this.getWebCVEffect(g);if(!m)throw new Error(`Effect with type ${g} is not supported`);if(this.shouldCollectStats(g)&&this.notifyAboutLastSessionStats("EffectChanged"),this.effectType=g,this.effectProvider)try{await this.effectProvider.setEffectAsync(m)}catch(g){throw await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to apply ${m}, error:${stringifyObject(g)}`),g}else this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setSourceAsync(g){if(this.logger.safe.debug(`Set source: ${g?g.id:"no stream"}`),!this.effectProvider)return this.logger.safe.debug("WebCV is not initialized. Do nothing"),g;if(g.getTracks().length>0){const m=g.getVideoTracks()[0].getSettings();this.isPortrait=m.height>m.width}let m=g;try{m=await this.effectProvider.setSourceAsync(g)}catch(g){await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to set source, error:${stringifyObject(g)}`)}return m}async removeSourceAsync(g){if(this.logger.safe.debug(`Remove source: ${g?g.id:"no stream"}`),this.effectProvider)return this.effectProvider.removeSourceAsync(g);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async getEffectsCapability(){let g=0;const m=await this.getCapability();this.logger.safe.debug(`Get capabilty with return: ${JSON.stringify(m)}`);for(const S of m){const m=this.getVideoEffectType(S);if(!m)throw new Error(`Cannot convert WebCV effect to VideoEffect ${S}`);g|=m}return g}getStats(g){if(!this.effectProvider)return;const m=this.effectProvider.getStats(),S=this.statistics.getReport();return m||S.error.length?{timestamp:Date.now(),statsReason:g,...this.createTelemetryEvent(m,S)}:void 0}getVersion(){return this.effectProvider?.getVersion?.()??"Unknown"}async resetOutputConstraints(g,m=Fn.EffectQualityChangeReason.ExternalParam){const S=this.getNewResolution(g,m),v={...this.configProvider.config.webcv.qualityConfig};return this.isPortrait?v.outputResolution=S.width:v.outputResolution=S.height,this.effectProvider?.configureStreamProcessor(v,Fn.EffectQualityChangeReason.ExternalParam)}getNewResolution(g,m){let S;switch(m){case Fn.EffectQualityChangeReason.ExternalParam:S=this.lastNotifiedResolutions.get(Fn.EffectQualityChangeReason.RendererSize),this.lastNotifiedResolutions.set(Fn.EffectQualityChangeReason.ExternalParam,g);break;case Fn.EffectQualityChangeReason.RendererSize:S=this.lastNotifiedResolutions.get(Fn.EffectQualityChangeReason.ExternalParam),this.lastNotifiedResolutions.set(Fn.EffectQualityChangeReason.RendererSize,g)}return{width:Math.max(g.width,S?.width||Number.MIN_SAFE_INTEGER),height:Math.max(g.height,S?.height||Number.MIN_SAFE_INTEGER)}}createTelemetryEvent(g,m){return{payload:{version:this.getVersion(),...m,...g,isWasmEnabled:this.processorType===Fn.ProcessorType.Wasm}}}notifyError(g,m){this.statistics.setError(g,m),this.notifyAboutLastSessionStats("EffectError")}notifyAboutLastSessionStats(g){const m=this.getStats(g);m&&this.event("onVideoEffectTelementyEvent").raise(m)}async initializeVideoEffectProvider(){if(!this.webcvProvider)return this.logger.safe.debug("WebCV provider is not set"),null;this.statistics.startLoadTimer();const g=await this.webcvProvider.getVideoEffectProvider();if(this.statistics.stopLoadTimer(),!g)return this.statistics.setError("FailedToInitialize"),this.logger.safe.warn("WebCV is not initialized"),null;this.logger.safe.debug(`WebCV v${g.getVersion?.()} is initialized`);const m=await this.webcvProvider.getModelConfig();return await g.configureModel(m),this.configProvider.config.webcv.loadWorkerCallback=this.createWasmCVWorker,await g.configure({...this.configProvider.config.webcv,processorType:this.processorType}),this.effectConfig&&await g.configureEffect(this.effectConfig),this.effectProviderSubs=[g.on("onEffectApplied",(()=>this.event("onMediaStreamUpdateRequested").raise("Video"))),g.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats("EffectStopped"))),g.on("onVideoEffectQualityChanged",(g=>this.event("onVideoEffectQualityChanged").raise(g))),g.on("onVideoStreamQualityChanged",(g=>this.event("onVideoStreamQualityChanged").raise(g.resolution,g.fps,g.reason))),g.on("onCapabilitiesChanged",(()=>this.event("onVideoEffectCapabilitiesChanged").raise())),g.on("onFirstFrameProcessed",(()=>this.onFirstFrameProcessed())),g.on("onErrorNotified",(g=>this.notifyError("WebcvProccessorError",g))),g.on("videoFreezeDetected",(g=>this.event("videoFreezeDetected").raise(g)))],g}async getCapability(){if(!this.configProvider.config.enableVideoEffects)return this.logger.debug("Video effects disabled"),[Fn.VideoEffectType.Off];if(!this.webcvProvider)return this.logger.debug("WebCVProvider is not configured"),[Fn.VideoEffectType.Off];const g=new Vm(this.configProvider,this.statistics,this.logger.createChild("CapabilityChecker"));let m=[Fn.VideoEffectType.Off];return g.isWasmEffectSupported()?(m=[Fn.VideoEffectType.Off,Fn.VideoEffectType.BackgroundBlur,Fn.VideoEffectType.BackgroundReplacement],this.processorType=Fn.ProcessorType.Wasm):g.isWebgl2EffectSupported()&&(m=[Fn.VideoEffectType.Off,Fn.VideoEffectType.BackgroundBlur,Fn.VideoEffectType.BackgroundReplacement],this.processorType=Fn.ProcessorType.Webgl2),this.effectProvider?this.effectProvider.getCapability():m}getWebCVEffect(g){return this.videoEffectToWebCVEffectMapping[g]}getVideoEffectType(g){return keys(this.videoEffectToWebCVEffectMapping).find((m=>this.videoEffectToWebCVEffectMapping[m]===g))}onFirstFrameProcessed(){this.event("onVideoEffectApplied").raise(),this.logger.safe.debug("onVideoEffectApplied event raised")}async handleFailedProcessing(){this.effectType=0;try{await this.effectProvider.setEffectAsync(Fn.VideoEffectType.Off)}catch(g){this.notifyError("WebcvProccessorError",`Failed to handle error state, error:${stringifyObject(g)}`)}}shouldApplyEffect(g){return this.effectType!==g}shouldCollectStats(g){return 0!==this.effectType&&0!==g&&this.effectType!==g}};__decorateClass([sequentialize()],Bm.prototype,"init",1),__decorateClass([sequentialize()],Bm.prototype,"dispose",1),__decorateClass([sequentialize()],Bm.prototype,"configure",1),__decorateClass([sequentialize()],Bm.prototype,"setSourceAsync",1),__decorateClass([sequentialize()],Bm.prototype,"removeSourceAsync",1),__decorateClass([sequentialize()],Bm.prototype,"getEffectsCapability",1);var Hm=class extends je{constructor(g,m,S,v,C,_){super(C),this.wasmdnsProvider=g,this.wasmaecProvider=m,this.wasmVqeProvider=S,this.configProvider=v,this.logger=C,this.createWasmAudioWorkletCbs=_,this.serialQueue=new Ap(this.logger),this.stopped=!0,this.hasError=!1,this.statistics=new Um(this.configProvider.config.effectsTelemetryBufferSize),this.currentEffect=xn.AudioEffectType.Off,this.userNoiseSuppressionMode=0,this.currentEffectCapability=0,this.wasmvqeSourceStreamIsSet=!1,this.nsModeToUserNsMode={Off:0,Auto:1,Low:2,High:3},this.audioEffectToWasmAudioEffectType={0:xn.AudioEffectType.Off,1:xn.AudioEffectType.NoiseSuppressionClassic,2:xn.AudioEffectType.NoiseSuppressionDeep,4:xn.AudioEffectType.EchoCancellationClassic,8:xn.AudioEffectType.VoiceQualityEnhancementClassic,16:xn.AudioEffectType.VoiceQualityEnhancementDeep},this.audioEffectTypeToUserNsMode={[xn.AudioEffectType.Off]:0,[xn.AudioEffectType.NoiseSuppressionClassic]:2,[xn.AudioEffectType.NoiseSuppressionDeep]:3},this.noiseSuppressionModeToWasmDnsEffectMapping={Off:xn.AudioEffectType.Off,High:xn.AudioEffectType.NoiseSuppressionDeep,Low:xn.AudioEffectType.NoiseSuppressionClassic},this.userNoiseSuppressionMode=this.nsModeToUserNsMode[this.configProvider.mediaConfig.noiseSuppressionMode]}shouldFallbackToNativeProcessing(){return!!this.configProvider.config.enableAudioProcessingFallback&&(this.configProvider.config.wasmvqe.enableVqe||this.configProvider.config.wasmdns.enableNoiseSuppression?this.hasError?(this.logger.safe.info("shouldFallbackToNativeProcessing: error was encountred initializing the package"),!0):this.configProvider.config.wasmvqe.enableVqe&&!this.wasmVqeProvider?(this.logger.safe.info("shouldFallbackToNativeProcessing: VQE provider is enabled but not loaded"),!0):!(!this.configProvider.config.wasmdns.enableNoiseSuppression||this.wasmdnsProvider&&this.wasmaecProvider)&&(this.logger.safe.info("shouldFallbackToNativeProcessing: DNS/AEC provider is enabled but not loaded"),!0):(this.logger.safe.info("shouldFallbackToNativeProcessing: custom processing is not enabled"),!0))}nsModeToVqeMode(g,m){switch(g){case"High":return m?xn.VqeMode.DeepVQE:xn.VqeMode.DeepNS;case"Low":return m?xn.VqeMode.SkypeVQE:xn.VqeMode.SkypeNS;default:return m?xn.VqeMode.SkypeAEC:xn.VqeMode.Off}}vqeModeToNsMode(g){switch(g){case xn.VqeMode.DeepVQE:case xn.VqeMode.DeepNS:return"High";case xn.VqeMode.SkypeVQE:case xn.VqeMode.SkypeNS:return"Low";case xn.VqeMode.SkypeAEC:case xn.VqeMode.Off:default:return"Off"}}vqeModeToAudioEffectType(g){switch(g){case xn.VqeMode.DeepVQE:return 16;case xn.VqeMode.DeepNS:return 2;case xn.VqeMode.SkypeVQE:return 8;case xn.VqeMode.SkypeNS:return 1;case xn.VqeMode.SkypeAEC:return 4;case xn.VqeMode.Off:default:return 0}}async configureEffect(g){this.stopped||this.stop(),this.statistics.clearErrors();let m=g;if(!m){let g=this.configProvider.mediaConfig.noiseSuppressionMode;this.logger.safe.info(`Configuring the audio effect manager for Noise Suppression mode: ${g}`),"Auto"===g&&(g=this.configProvider.config.wasmvqe.enableVqe?this.vqeModeToNsMode(this.configProvider.config.wasmvqe.defaultVqeMode):this.configProvider.config.wasmdns.noiseSuppressionMode,this.logger.safe.info(`Overriding 'Auto' with ${g}`)),m={...this.configProvider.config.wasmdns,...this.configProvider.config.wasmvqe},m.defaultVqeMode=this.nsModeToVqeMode(g,m.enableAec),m.noiseSuppressionMode=g}if(await this.getEffectsCapability(),this.configProvider.config.wasmvqe.enableVqe)try{this.vqeProvider||(this.logger.safe.debug("Initializing VQE provider ..."),this.vqeProvider=await this.initializeAudioEffectProvider(xn.AudioEffectType.VoiceQualityEnhancementDeep)),this.logger.safe.debug("Configuring VQE audio effects ..."),m.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmVqeWorklet,await this.vqeProvider.configureEffect(m),this.logger.safe.debug(`The audio effects were configured as follows: ${stringifyObject(m)}, and current capability is ${this.currentEffectCapability}.`)}catch(g){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${g}), while trying to use this configuration: ${stringifyObject(m)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}else if(this.configProvider.config.wasmdns.enableNoiseSuppression){m.noiseSuppressionMode||(this.logger.safe.debug("configureEffect was called without a noiseSuppressionMode. Using noiseSuppressionMode from config provider ..."),m.noiseSuppressionMode=this.configProvider.mediaConfig.noiseSuppressionMode),this.currentEffect=this.noiseSuppressionModeToWasmDnsEffectMapping[m.noiseSuppressionMode],this.logger.safe.debug(`currentEffect is ${this.currentEffect}`);try{this.dnsProvider||(this.logger.safe.debug("Initializing DNS provider ..."),this.dnsProvider=await this.initializeAudioEffectProvider(xn.AudioEffectType.NoiseSuppressionDeep)),this.aecProvider||(this.logger.safe.debug("Initializing AEC provider ..."),this.aecProvider=await this.initializeAudioEffectProvider(xn.AudioEffectType.EchoCancellationClassic)),this.logger.safe.debug("Configuring DNS/AEC audio effects ..."),m.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmDnsWorklet,await this.dnsProvider.configureEffect(m),m.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmAecWorklet,await this.aecProvider.configureEffect(m),this.logger.safe.debug(`The audio effects were configured as follows: ${stringifyObject(m)}, and current capability is ${this.currentEffectCapability}.`)}catch(g){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${g}), while trying to use this configuration: ${stringifyObject(m)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}this.stopped=!1}}async setSourceAsync(g){if(this.logger.safe.debug(`Set source: ${g?g.id:"no stream"}, currentEffect = ${this.currentEffect}`),this.configProvider.config.wasmvqe.enableVqe&&!this.vqeProvider?await this.configureEffect():!this.configProvider.config.wasmdns.enableNoiseSuppression||this.dnsProvider&&this.aecProvider||await this.configureEffect(),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const m=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${m}).`),this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${m}).`),g}if(!this.configProvider.config.wasmvqe.enableVqe&&!this.configProvider.config.wasmdns.enableNoiseSuppression)return g;if(this.effectProviderSubs=[this.vqeProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onErrorNotified",(g=>this.notifyError("WasmVqeProccessorError",g))),this.dnsProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onErrorNotified",(g=>this.notifyError("WasmDnsProccessorError",g))),this.aecProvider?.on("onErrorNotified",(g=>this.notifyError("WasmAecProccessorError",g)))],this.configProvider.config.wasmvqe.enableVqe)try{const m=await this.vqeProvider.setSourceAsync(g);return this.aecRefStream&&this.vqeProvider.setRefStream(this.aecRefStream),this.wasmvqeSourceStreamIsSet=!0,m}catch(m){return this.notifyError("WasmVqeProccessorError",`setSourceAsync: Failed to asynchronously set source for VQE (${m})`),g}let m=g;try{m=await this.aecProvider.setSourceAsync(g),this.aecRefStream&&this.aecProvider.setRefStream?.(this.aecRefStream)}catch(g){this.notifyError("WasmAecProccessorError",`setSourceAsync: Failed to asynchronously set source for AEC (${g})`)}try{return await this.dnsProvider.setSourceAsync(m)}catch(g){this.notifyError("WasmDnsProccessorError",`setSourceAsync: Failed to asynchronously set source for DNS (${g})`)}return m}async setAecRefStream(g){try{if(this.logger.safe.debug(`Setting the reference stream to: ${g?g.id:"Null"}`),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const g=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setAecRefStream: audio effect provider not initialized (${g}).`),void this.logger.safe.warn(`Unable to setAecRefStream for audio effects: audio effect provider not initialized (${g}).`)}this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider.setRefStream(g):this.configProvider.config.wasmdns.enableNoiseSuppression&&this.aecProvider.setRefStream(g)}catch(g){this.notifyError("WasmVqeProccessorError",`setRefStream: Failed to set reference stream for echo cancellation (${g})`)}this.aecRefStream=g}async setEffectAsync(g){this.configProvider.config.wasmvqe.enableVqe&&!this.wasmvqeSourceStreamIsSet&&(this.logger.safe.info("wasmvqe source stream is not set, reacquiring audio stream"),this.event("onMediaStreamUpdateRequested").raise("Audio")),this.configProvider.config.wasmvqe.enableVqe&&!this.vqeProvider?await this.configureEffect():!this.configProvider.config.wasmdns.enableNoiseSuppression||this.dnsProvider&&this.aecProvider||await this.configureEffect();const m=this.audioEffectToWasmAudioEffectType[g];if(this.userNoiseSuppressionMode=this.audioEffectTypeToUserNsMode[m],!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const g=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${g}).`),void this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${g}).`)}try{this.configProvider.config.wasmvqe.enableVqe?await this.vqeProvider.setEffectAsync(m):this.configProvider.config.wasmdns.enableNoiseSuppression&&(await this.dnsProvider.setEffectAsync(m),await this.aecProvider.setEffectAsync(m)),this.currentEffect=m,this.logger.safe.debug(`The audio effect was set to '${m}'`)}catch(g){throw this.notifyError("WasmVqeProccessorError",`setEffectAsync: Failed to apply '${m}' audio effect, error: ${stringifyObject(g)}`),g}}stop(){try{this.stopped=!0,this.dnsProvider?.dispose(),this.dnsProvider=null,this.aecProvider?.dispose(),this.aecProvider=null,this.vqeProvider?.dispose(),this.vqeProvider=null,this.effectProviderSubs?.forEach((g=>g?.dispose())),this.effectProviderSubs=null,this.logger.safe.debug("The audio effects provider was stopped.")}catch(g){this.logger.safe.error(`Failed to stop the audio effects provider (${g})`)}}dispose(){try{this.hasError=!1,this.stop(),super.dispose(),this.logger.safe.debug("The audio effects provider was disposed.")}catch(g){this.logger.safe.error(`dispose: Failed to dispose the audio effects provider (${g})`)}}async getEffectsCapability(){return this.currentEffectCapability=0,this.configProvider.config.wasmvqe.enableVqe?(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.configProvider.config.wasmvqe.enableAec&&(this.currentEffectCapability|=4,this.currentEffectCapability|=8,this.currentEffectCapability|=16)):this.configProvider.config.wasmdns.enableNoiseSuppression&&(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.currentEffectCapability|=4),this.currentEffectCapability}getVersion(){return`${`WasmDns ${this.dnsProvider?.getVersion()??"Unknown"}`} / ${`WasmAec ${this.aecProvider?.getVersion()??"Unknown"}`} / ${`WasmVqe ${this.vqeProvider?.getVersion()??"Unknown"}`}`}getStats(){const g=this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider?.getStats():this.dnsProvider?.getStats();return g?(g.userNoiseSuppressionMethod=this.userNoiseSuppressionMode,{timestamp:Date.now(),...this.createTelemetryEvent(g)}):null}async initializeAudioEffectProvider(g){if(!this.wasmVqeProvider&&g===xn.AudioEffectType.VoiceQualityEnhancementDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmVqe package not available."),this.logger.safe.warn("WasmVqe package not available."),null;if(!this.wasmdnsProvider&&g===xn.AudioEffectType.NoiseSuppressionDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmDns package not available."),this.logger.safe.warn("WasmDns package not available."),null;if(!this.wasmaecProvider&&g===xn.AudioEffectType.EchoCancellationClassic)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmAec package not available."),this.logger.safe.warn("WasmAec package not available."),null;let m;this.statistics.startLoadTimer();try{this.configProvider.config.wasmvqe.enableVqe&&g===xn.AudioEffectType.VoiceQualityEnhancementDeep&&(m=await this.wasmVqeProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&g===xn.AudioEffectType.NoiseSuppressionDeep&&(m=await this.wasmdnsProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&g===xn.AudioEffectType.EchoCancellationClassic&&(m=await this.wasmaecProvider.getAudioEffectProvider())}catch(g){this.logger.safe.warn(`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${g})`),this.statistics.setError("FailedToInitialize",`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${g})`)}return this.statistics.stopLoadTimer(),m?(g===xn.AudioEffectType.VoiceQualityEnhancementDeep&&this.logger.safe.debug(`WasmVqe v${m.getVersion?.()} initialized!`),g===xn.AudioEffectType.NoiseSuppressionDeep&&this.logger.safe.debug(`WasmDns v${m.getVersion?.()} initialized!`),g===xn.AudioEffectType.EchoCancellationClassic&&this.logger.safe.debug(`WasmAec v${m.getVersion?.()} initialized!`),m):(this.logger.safe.warn("Unitialized Wasm audio effect provider."),null)}createTelemetryEvent(g){return{payload:{audioEffectsCapability:this.currentEffectCapability,version:this.getVersion(),...this.statistics.getReport(),...g}}}notifyError(g,m){this.statistics.setError(g,m),this.notifyAboutLastSessionStats()}notifyAboutLastSessionStats(){const g=this.getStats();g&&this.event("onAudioEffectTelemetryEvent").raise(g)}requestStreamUpdate(){this.configProvider.config.enableAudioProcessingFallback&&!this.hasError&&(this.hasError=!0,this.event("onMediaStreamUpdateRequested").raise("Audio"))}};__decorateClass([sequentialize()],Hm.prototype,"setSourceAsync",1),__decorateClass([sequentialize()],Hm.prototype,"setAecRefStream",1),__decorateClass([sequentialize()],Hm.prototype,"setEffectAsync",1),__decorateClass([sequentialize()],Hm.prototype,"stop",1),__decorateClass([sequentialize()],Hm.prototype,"dispose",1);var $m=class extends je{constructor(g,m){super(),this.configProvider=g,this.logger=m}isEffectEnabled(g){return"Video"===g&&this.videoEffectManager?.isEffectEnabled}shouldFallbackToNativeProcessing(g){return"Audio"===g&&this.audioEffectManager?.shouldFallbackToNativeProcessing()}addEffectManager(g,m){switch(g){case"Audio":this.addAudioEffectManagerAndSubscribe(m);break;case"Video":this.addVideoEffectManagerAndSubscribe(m)}}async startEffect(g,m){switch(g){case"Audio":return this.logger.safe.info("audioEffectManager is "+(this.audioEffectManager?"defined":"undefined")),this.audioEffectManager?.shouldFallbackToNativeProcessing()?(this.logger.safe.info("No custom audio effect is used. Fallback to native audio processing"),m):this.audioEffectManager.setSourceAsync(m);case"Video":return this.videoEffectManager.setSourceAsync(m);default:return m}}async setEffectType(g,m){switch(g){case"Audio":return this.audioEffectManager?.setEffectAsync(m);case"Video":return this.videoEffectManager?.setEffectAsync(m)}}stopEffect(g,m){switch(g){case"Audio":this.logger.safe.info("stopping audio effect"),this.audioEffectManager?.stop();break;case"Video":this.logger.safe.info("stopping video effect"),this.videoEffectManager?.removeSourceAsync(m)}}resetOutputConstraints(g,m,S){if("Video"===g)this.videoEffectManager?.resetOutputConstraints(m,S)}getStats(g,m){switch(g){case"Audio":return this.audioEffectManager?.getStats();case"Video":return this.videoEffectManager?.getStats(m);default:return}}async configure(g,m){if("Video"===g)return this.videoEffectManager?.configure(m)}async getEffectsCapability(g){switch(g){case"Audio":return this.audioEffectManager?.getEffectsCapability();case"Video":return this.videoEffectManager?.getEffectsCapability();default:return 0}}setAecRefStream(g){return this.audioEffectManager.setAecRefStream(g)}vqeModeToAudioEffectType(g){return this.audioEffectManager.vqeModeToAudioEffectType(g)}nsModeToVqeMode(g,m){return this.audioEffectManager.nsModeToVqeMode(g,m)}dispose(){super.dispose(),this.audioEffectManager?.dispose(),this.audioEffectManager=null,this.videoEffectManager?.dispose(),this.videoEffectManager=null}addAudioEffectManagerAndSubscribe(g){this.audioEffectManager||(this.audioEffectManager=new Hm(g.wasmdnsProvider,g.wasmaecProvider,g.wasmVqeProvider,this.configProvider,this.logger.createChild("AudioEffectManager"),g.createAudioWasmWorkerCbs),this.audioEffectManager.on("onAudioEffectTelemetryEvent",(g=>{this.event("onAudioEffectTelemetryEvent").raise(g)})),this.audioEffectManager.on("onMediaStreamUpdateRequested",(g=>{this.event("onMediaStreamUpdateRequested").raise(g)})))}addVideoEffectManagerAndSubscribe(g){this.videoEffectManager||(this.videoEffectManager=new Bm(g.webcvProvider,this.configProvider,this.logger.createChild("VideoEffectManager"),g.createWasmCVWorker),this.videoEffectManager.on("onMediaStreamUpdateRequested",(g=>{this.event("onMediaStreamUpdateRequested").raise(g)})),this.videoEffectManager.on("onVideoEffectQualityChanged",(g=>{this.event("onVideoEffectQualityChanged").raise(g)})),this.videoEffectManager.on("onVideoStreamQualityChanged",((g,m,S)=>{this.event("onVideoStreamQualityChanged").raise(g,m,S)})),this.videoEffectManager.on("onVideoEffectCapabilitiesChanged",(()=>{this.event("onVideoEffectCapabilitiesChanged").raise()})),this.videoEffectManager.on("onVideoEffectTelementyEvent",(g=>{this.event("onVideoEffectTelementyEvent").raise(g)})),this.videoEffectManager.on("onVideoEffectApplied",(()=>{this.event("onVideoEffectApplied").raise()})),this.videoEffectManager.on("videoFreezeDetected",(g=>{this.event("videoFreezeDetected").raise(g)})))}},Gm=class _DeviceManager extends je{constructor(g,m,S,v,C,_,E,T,I,b){super(g),this.logger=g,this.configProvider=m,this.diagnostics=S,this.domOverrides=v,this.ufdManager=C,this.id=uniqueId(),this.virtualDeviceRecord=new Map,this.deviceEnumerator=new Pm(this.configProvider,this.logger.createChild("DeviceEnumerator")),this.deviceSelection=new Mm(Pm.list,this.configProvider,this.logger.createChild("DeviceSelection")),this.permissionManager=new Nm(this.configProvider,{getMediaStream:g=>this.getMediaStream({...g,withEffect:!1,withTimeout:!0,force:!1,audioProcessingFlags:g.audio&&!g.video?this.getAudioProcessingFlags():void 0},"permissionManager"),hasCamera:()=>this.hasDeviceType("camera"),raiseTelemetryEvent:(g,m)=>this.raiseTelemetryEvent(g,m),getActiveConstraints:()=>this.mediaStreamManager.getActiveConstraints(),handlePermissionStateChange:()=>this.handlePermissionStateChange()},this.logger.createChild("PermissionManager")),this.activeRenderers=[],this.selectedDevices={camera:null,microphone:null,speaker:null,audioIngestDevice:null},this.pendingDevices=null,this.deviceManagerSubscriptions=[],this.streamManagerSubscriptions=[],this.streamSubscriptions=new Map,this.rendererSubscriptions=new Map,this.rawDeviceStreamManager=new Ip(this.logger.createChild("RawDeviceStream"),this.raiseTelemetryEvent.bind(this)),this.customDeviceMediaStreamMap=new Map,this.clientAudioRenderers=new Map,this.audioSharingRequested=!1,this.virtualDeviceSubs=new Map,this.effectsManagerInternal=new $m(this.configProvider,this.logger.createChild("EffectsManager")),this.effectsManagerInternal.addEffectManager("Audio",{wasmdnsProvider:E,wasmaecProvider:T,wasmVqeProvider:I,createAudioWasmWorkerCbs:b?.audioWorklet}),this.effectsManagerInternal.addEffectManager("Video",{webcvProvider:_,createWasmCVWorker:b?.createWasmCVWorker}),this.mediaStreamManager=new Cm(this.logger.createChild("MediaStreamManager"),this.configProvider,this.effectsManager),this.deviceManagerSubscriptions=[this.permissionManager.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise())),Pm.list.on("onDevicesChanged",((g,m)=>this.onDevicesChanged(g,m))),this.deviceSelection.on("onSelectedDevicesChanged",((g,m)=>this.onSelectedDevicesChanged(g,m))),this.effectsManager.on("onAudioEffectTelemetryEvent",(g=>{this.diagnostics?.registerAudioEffectsEvent(deepClone(g)),this.event("onAudioEffectsTelemetryEvent").raise(g)})),this.effectsManager.on("onMediaStreamUpdateRequested",(g=>this.onMediaStreamUpdateRequested(g,!0))),this.effectsManager.on("onMediaStreamUpdateRequested",(g=>this.onMediaStreamUpdateRequested(g))),this.effectsManager.on("onVideoEffectQualityChanged",(g=>this.onVideoEffectsQualityEventHandler(g))),this.effectsManager.on("onVideoEffectTelementyEvent",(g=>{this.diagnostics?.registerVideoEffectsEvent(deepClone(g)),this.event("onVideoEffectsTelemetryEvent").raise(g)})),this.effectsManager.on("onVideoEffectApplied",(()=>{this.raiseTelemetryEvent("video_effect_applied",{}),this.event("onVideoEffectApplied").raise()}))],this.subscribeOnStreamManagerEvents(),this.subscribeOnDeviceEnumeratorEvents(),this.deviceList.length&&this.onSelectedDevicesChanged(this.deviceSelection.selectedDevices,!1),this.createChildDeviceManager=g=>new _DeviceManager(g,m,void 0,v,C,_,E,T,I,b)}get deviceList(){return Pm.list.devices}get isDeviceEnumeratorInitialized(){return Pm.isInitialized}get isAudioOutputSelectionSupported(){return this.configProvider.userAgentConfig.isAudioOutputSelectionSupported}get effectsManager(){return this.effectsManagerInternal}createPreviewRenderer(g){const m=new xp(g,this,this.logger.createChild("videorenderer"),this.configProvider);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(m.getVideoElement()),this.subscribeOnRendererEvents(m),m}async askDevicePermission(g){await this.isDeviceEnumeratorInitialized.promise;const m=await this.permissionManager.askDevicePermission(g);if(this.configProvider.config.devices.enumerateDevicesAfterADP)try{await Pm.enumerateDevices()}catch(g){this.logger.safe.warn(`Post-ADP device enumeration failed: ${stringifyObject(g)}`)}return m}getPermissionState(g){return this.permissionManager.getPermissionState(g)}handlePermissionStateChange(){this.diagnostics&&(this.diagnostics.permissionStates=this.permissionManager.knownPermissionStates),this.event("onPermissionStateChanged").raise()}onMediaStreamUpdateRequested(g,m=!1){if("Video"===g&&(this.updateRenderersAsync(),this.effectsManager.isEffectEnabled("Video")))return this.logger.safe.info("onStreamUpdateRequested will be called after the first frame is proccessed of the video effect stream"),void this.effectsManager.once("onVideoEffectApplied",(()=>this.event("onStreamUpdateRequested").raise(g)));this.event("onStreamUpdateRequested").raise(g,m)}createAudioRenderer(){const g=new bp(this.logger.createChild("CustomAudioRenderer"),this.configProvider),m=uniqueId();this.clientAudioRenderers.set(m,g);const S=g.play.bind(g),v=g.stop.bind(g);return this.raiseTelemetryEvent("custom_audio_renderer_created",this.getSelectedDevices()),{play:S,stop:v,dispose:()=>{this.clientAudioRenderers.get(m)?.dispose(),this.clientAudioRenderers.delete(m)},setMuted:(m,S=generateCauseId())=>g.setMuted(m,S),isMuted:()=>g.muted}}setAudioSharingRequested(g){this.audioSharingRequested=g}async createDevicesHandle(g,m,S){const v=g.sharing?"ScreenShare":g.video?"Video":"Audio";return new wm(this.logger.createChild("DevicesHandle"),await this.getMediaStream({...g,...S&&{deviceId:S},withTimeout:!1,withEffect:!1,audioProcessingFlags:this.audioProcessingFlags,force:!1,withOverridenStream:this.customDeviceMediaStreamMap.get(v)?.active&&this.customDeviceMediaStreamMap.get(v)},m))}shareSystemSound(g){this.configProvider.config.postponeAudioMixerForAudioSharing&&(this.audioSharingRequested=g,this.event("onAudioSharingToggled").raise(g))}getAllowedModalities(){const g=shallowClone(this.permissionManager.browserPermittedModalities);return this.hasDeviceType("microphone")||(g.audio=[Ke.MEDIA_STATE.inactive,Ke.MEDIA_STATE.receive]),this.hasDeviceType("camera")||(g.video=[Ke.MEDIA_STATE.inactive,Ke.MEDIA_STATE.receive]),g}getRawDeviceMediaStream(g,m){if("ScreenShare"!==g&&!this.hasDeviceType(this.getDeviceType(g)))throw new Error("NoInputDevice");this.audioSharingRequested=m;const S=this.getStreamHandlerByType(g);if(!S)return this.logger.safe.debug(`method not found for ${g}`),null;const v=this.rawDeviceStreamManager.createIRawStreamClient(S,g);return this.raiseTelemetryEvent("IRawStream_client_created",g),v}setRawMediaStream(g,m){if(!g)throw this.logger.error(`Could not set ${g} as to ${m}`),new Error("InvalidStream");this.customDeviceMediaStreamMap.set(m,g),this.onMediaStreamUpdateRequested(m),this.raiseTelemetryEvent("set_raw_outgoing_media_stream",m)}unsetRawMediaStream(g){this.customDeviceMediaStreamMap.get(g)?(this.customDeviceMediaStreamMap.delete(g),this.onMediaStreamUpdateRequested(g),this.raiseTelemetryEvent("unset_raw_outgoing_media_stream",g)):this.logger.safe.debug("no custom stream")}async setVideoEffects(g){return this.effectsManager.setEffectType("Video",g)}async setAudioEffects(g){return this.effectsManager.setEffectType("Audio",g)}getAudioStream(g,m,S=!1){return this.getMediaStream({audio:!0,withTimeout:this.permissionManager.isPermissionKnown("microphone"),withEffect:!1,audioProcessingFlags:this.getAudioProcessingFlags(),force:g,withOverridenStream:!S&&this.customDeviceMediaStreamMap.get("Audio")?.active&&this.customDeviceMediaStreamMap.get("Audio")},m)}getVideoStream(g,m,S=!1){return this.getMediaStream({video:!0,withTimeout:this.permissionManager.isPermissionKnown("camera"),withEffect:!S&&this.configProvider.config.enableVideoEffects&&this.effectsManager.isEffectEnabled("Video"),force:g,withOverridenStream:!S&&this.customDeviceMediaStreamMap.get("Video")?.active&&this.customDeviceMediaStreamMap.get("Video")},m)}getDisplayStream(g,m=!1){const S=!(!this.configProvider.config.enableAudioSharing||!this.audioSharingRequested);return this.getMediaStream({audio:S,sharing:!0,withTimeout:!1,withEffect:!1,audioProcessingFlags:S?0:void 0,force:!1,withOverridenStream:!m&&this.customDeviceMediaStreamMap.get("ScreenShare")?.active&&this.customDeviceMediaStreamMap.get("ScreenShare")},g)}async enumerateDevicesAsync(){return await this.isDeviceEnumeratorInitialized.promise,this.getDeviceDescriptions(this.deviceList)}async getDeviceNameAsync(g){await this.isDeviceEnumeratorInitialized.promise;const m=this.deviceList.find((m=>m.guid===g));return m?.label??""}async getSpeakerDeviceDomIdAsync(g){await this.isDeviceEnumeratorInitialized.promise;const m=this.deviceList.find((m=>m.guid===g));return m?.deviceId??""}selectDevices(g){return this.pendingDevices?(this.logger.safe.info(`Overriding device selection until enumeration is complete with ${JSON.stringify(scrubSelectedDevices(this.pendingDevices))}`),void(this.pendingDevices=g)):this.isDeviceEnumeratorInitialized.isPending?(this.logger.safe.info("Postponing device selection until enumeration is complete"),this.pendingDevices=g,void this.isDeviceEnumeratorInitialized.promise.then((()=>{this.logger.safe.info("Performing postponed device selection");const g=this.pendingDevices;this.pendingDevices=null,this.selectDevices(g)}))):void this.deviceSelection.selectDevices(g)}getSelectedDevices(){return this.toSelectedDevices(this.deviceSelection.selectedDevices)}setAudioProcessingFlags(g){g!==this.audioProcessingFlags&&(this.logger.debug(`Setting audio processing flags: ${this.audioProcessingFlags} -> ${g}`),this.audioProcessingFlags=g,this.event("onStreamUpdateRequested").raise("Audio"))}getOutputDeviceId(){return this.selectedDevices.speaker?.deviceId}getDeviceDescriptions(g){return(g||this.deviceList).map((g=>g.toDeviceDesc()))}getDevicesCount(){return this.deviceList.reduce(((g,m)=>(g[m.type]++,g)),{camera:0,speaker:0,microphone:0,compositeAudio:0,virtualDevice:0,audioIngestDevice:0})}async getKnownPermissionStates(){return await this.permissionManager.initialize(),this.permissionManager.knownPermissionStates}getLocalVideoRenderers(){return this.activeRenderers}dispose(){this.deviceManagerSubscriptions?.forEach((g=>g.dispose())),this.deviceManagerSubscriptions=null,this.virtualDeviceSubs?.forEach((g=>g.forEach((g=>g.dispose())))),this.virtualDeviceSubs?.clear(),this.virtualDeviceSubs=null,this.virtualDeviceRecord?.forEach((g=>g.dispose())),this.virtualDeviceRecord=null,this.unsubscribeFromStreamManagerEvents(),this.deviceEnumerator.dispose(),this.mediaStreamManager.dispose(),this.activeVideoEffectSub?.dispose(),this.activeVideoStreamForEffect?.dispose(),this.disposeRawStreamAccess(),this.disposeClientAudioRenderer(),this.effectsManager.dispose(),super.dispose()}async registerVirtualDevice(g,m){const S=g.length?g.map((({id:g},m)=>{const S=this.createChildDeviceManager(this.logger.createChild(`VirtualDevice-${m}`));return S.selectDevices({camera:g}),S})):[this.createChildDeviceManager(this.logger.createChild("VirtualDevice"))],v=new km(S,m),C=v.id,_=[v.on("onVideoEffectApplied",((...g)=>this.event("onVideoEffectApplied").raise(...g))),v.on("onVideoEffectsEvent",((...g)=>this.event("onVideoEffectsEvent").raise(...g))),v.on("onDeviceTelemetryEvent",((...g)=>this.event("onDeviceTelemetryEvent").raise(...g))),v.on("onVideoEffectsTelemetryEvent",((...g)=>this.event("onVideoEffectsTelemetryEvent").raise(...g))),v.on("onDevicesPermissionChanged",((...g)=>this.event("onDevicesPermissionChanged").raise(...g))),v.on("onStreamUpdateRequested",((...g)=>this.event("onStreamUpdateRequested").raise(...g)))];return this.virtualDeviceSubs.set(C,_),this.virtualDeviceRecord.set(C,v),Pm.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.raiseTelemetryEvent("register_virtual_device",{deviceCount:S.length,id:C}),this.event("onVirtualDevicesChanged").raise(),C}async unregisterVirtualDevice(g){this.virtualDeviceRecord.has(g)?(this.virtualDeviceSubs.get(g).forEach((g=>g.dispose())),this.virtualDeviceSubs.delete(g),this.virtualDeviceRecord.get(g).dispose(),this.virtualDeviceRecord.delete(g),Pm.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.event("onVirtualDevicesChanged").raise(),this.raiseTelemetryEvent("unregister_virtual_device",{id:g})):this.logger.error(`No virtual device found with id ${g}`)}getRegisteredDevices(){return Array.from(this.virtualDeviceRecord.values())}getAudioProcessingFlags(){if(!this.effectsManager.shouldFallbackToNativeProcessing("Audio"))return this.audioProcessingFlags??this.configProvider.config.defaultAudioProcessingFlags}disposeClientAudioRenderer(){this.clientAudioRenderers.size&&(this.clientAudioRenderers.forEach((g=>{g.dispose()})),this.clientAudioRenderers.clear(),this.raiseTelemetryEvent("custom_audio_renderer_disposed",this.getSelectedDevices()))}disposeRawStreamAccess(){this.rawDeviceStreamManager.disposeAll(),this.rawDeviceStreamManager=null}toSelectedDevices(g){return Object.entries(g).reduce(((g,[m,S])=>(S&&(g[m]=S.guid),g)),{})}getStreamConstraints(g){return{deviceId:g?.deviceId||void 0}}hasDeviceType(g){return values(this.deviceList).some((m=>m.type===g))}getConstraints(g){if(!g.audio&&!g.video&&!g.sharing)throw new Error("requesting nothing");if(this.logger.safe.info(`retrieving media stream: ${JSON.stringify(g)}`),g.sharing){let m;const S=this.selectedDevices.audioIngestDevice;return m=S&&g.deviceId?{deviceId:S.deviceId}:g.audio&&!g.deviceId?{deviceId:Ke.SYSTEM_AUDIO_SOURCE_ID}:void 0,{audio:m,sharing:{deviceId:g.deviceId||Ke.DISPLAY_SOURCE_ID},withTimeout:g.withTimeout,withEffect:!1,audioProcessingFlags:g.audioProcessingFlags,force:!1,withOverridenStream:g.withOverridenStream}}const m=this.selectedDevices.microphone,S=this.selectedDevices.camera,v=g.audio&&m,C=g.video&&S;if(!v&&!C){throw{type:Ke.MEDIA_ERROR.noDeviceSelected,detail:`audio requested ${g.audio}, video requested: ${g.video} Devices: ${JSON.stringify(this.deviceList.map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords)))))}`}}const _=this.getStreamConstraints(m),E=this.getStreamConstraints(S);let T=g.audioProcessingFlags;return void 0!==T&&g.audio&&!g.video&&m?.capabilities&&(m.capabilities.echoCancellation&&!m.capabilities.echoCancellation.includes(!!(2&T))&&(T^=2),m.capabilities.autoGainControl&&!m.capabilities.autoGainControl.includes(!!(1&T))&&(T^=1),m.capabilities.noiseSuppression&&!m.capabilities.noiseSuppression.includes(!!(4&T))&&(T^=4)),T!==g.audioProcessingFlags&&this.logger.safe.warn(`Unable to fulfill processing flags ${g.audioProcessingFlags}, using ${T} instead`),{audio:g.audio?_:void 0,video:g.video?E:void 0,withTimeout:g.withTimeout,withEffect:g.withEffect,audioProcessingFlags:T,force:g.force,withOverridenStream:g.withOverridenStream}}async getMediaStream(g,m){const S=this.configProvider.config.devices.enumerateBeforeGettingStream;S&&("always"!==S&&Pm.isPolling||await Pm.enumerateDevices());const v=this.getConstraints(g),C=this.mediaStreamManager.getMediaStream(v,m);this.subscribeOnStreamEvents(C);try{await C.start();const m=C.hasAudio(),S=C.hasVideo();m&&this.signalDeviceGood("Audio",C.rawTrack.muted),S&&this.signalDeviceGood(C.mediaType,C.rawTrack.muted),this.permissionManager.update(g,g)}catch(m){this.handleUserMediaError(g,m)}return C}signalDeviceGood(g,m){this.ufdManager.signalDeviceEvent(0,"Good",g,this.id),this.ufdManager.signalDeviceEvent(1,"Good",g,this.id),this.ufdManager.signalDeviceEvent(3,"Good",g,this.id),m||"Audio"!==g&&!this.configProvider.config.raiseVideoMuteUfd||this.ufdManager.signalDeviceEvent(2,"Good",g,this.id)}handleUserMediaError(g,m){const S=this.getMediaType(g),v=g.audio&&g.video,signalUFD=(g,m)=>{!v&&this.ufdManager.signalDeviceEvent(g,m,S,this.id)};switch(m.type){case Ke.MEDIA_ERROR.permissionDeniedError:"ScreenShare"!==S&&(signalUFD(3,"Bad"),this.configProvider.config.permissions.persistOnDeniedError&&this.refreshPermissions(g));break;case Ke.MEDIA_ERROR.permissionDeniedBySystemError:signalUFD(3,"Bad");break;case Ke.MEDIA_ERROR.sourceUnavailableError:signalUFD(0,"Bad");break;case Ke.MEDIA_ERROR.mediaStreamRequestTimedOut:signalUFD(1,"Bad");break;default:this.logger.safe.error(`getMediaStream() error: ${stringifyObject(m)}`),signalUFD(0,"Bad")}}refreshPermissions(g){const m=g.audio&&!g.video,S=!g.audio&&g.video;m?this.permissionManager.update({audio:!0},{audio:!1}):S&&this.permissionManager.update({video:!0},{video:!1})}getMediaType(g){if(g.sharing)return"ScreenShare";if(g.video)return"Video";if(g.audio)return"Audio";throw new Error(`mediaType is not defined for this constraint ${JSON.stringify(g)}`)}subscribeOnStreamEvents(g){const m=[];m.push(g.on("onStreamClientStarted",((g,m)=>this.onStreamStarted(g,m)))),m.push(g.on("onStreamClientDisposing",(g=>this.onStreamDisposing(g)))),m.push(g.on("onStreamClientEnded",((g,m)=>this.onStreamEnded(g,m)))),m.push(g.on("onStreamClientMuted",((g,m)=>this.onStreamMuted(g,m)))),m.push(g.on("onStreamClientError",((g,m)=>this.onStreamError(g,m)))),this.configProvider.config.useRawMediaApiForVideoEffects&&m.push(g.on("onStreamClientDisposed",(g=>this.removeVideoEffectStream(g)))),this.streamSubscriptions.set(g,m)}async removeVideoEffectStream(g){if(g.getCurrentConstraints().withEffect){this.logger.safe.info(`this.activeVideoEffectSub: ${this.activeVideoEffectSub} to be disposed`),this.activeVideoEffectSub?.dispose();const g=await(this.activeVideoStreamForEffect?.getMediaStream());this.effectsManager.stopEffect("Video",g)}}unsubscribeFromStreamEvents(g){this.streamSubscriptions.has(g)&&(this.streamSubscriptions.get(g).forEach((g=>g.dispose())),this.streamSubscriptions.delete(g))}subscribeOnRendererEvents(g){const m=[];m.push(g.on("onRendererDisposed",(g=>this.onRendererDisposed(g)))),m.push(g.on("onRendererStarted",(g=>this.onRendererStarted(g)))),m.push(g.on("onRendererSizeChanged",((g,m)=>this.onRendererSizeChanged()))),this.rendererSubscriptions.set(g,m)}unsubscribeFromRendererEvents(g){this.rendererSubscriptions.has(g)&&(this.rendererSubscriptions.get(g).forEach((g=>g.dispose())),this.rendererSubscriptions.delete(g))}subscribeOnStreamManagerEvents(){this.streamManagerSubscriptions=[],this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onAllStreamsRemoved",(()=>this.onAllStreamsRemoved()))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamAcquired",((g,m,S,v,C,_)=>this.onStreamAcquired(g,m,S,v,C,_)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamCreated",((g,m)=>this.onStreamCreated(g,m)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamDisposing",((g,m)=>this.onMasterStreamDisposing(g,m))))}subscribeOnDeviceEnumeratorEvents(){this.deviceEnumerator.on("onDeviceEnumerationfailed",(g=>this.raiseTelemetryEvent("enumeration_failed",{error:g})))}unsubscribeFromStreamManagerEvents(){this.streamManagerSubscriptions.forEach((g=>g.dispose()))}async updateRenderersAsync(){try{await Promise.all(this.activeRenderers.map((g=>g.updateStreamAsync()))),this.logger.safe.info("Renderers updates finished")}catch(g){this.logger.safe.error(`Error updating renderers: ${stringifyObject(g)}`)}}onSelectedDevicesChanged(g,m){const S=this.selectedDevices;this.selectedDevices=g,this.diagnostics?.setSelectedDevices(g,m);if(!("camera"in S^"camera"in this.selectedDevices||"microphone"in S^"microphone"in this.selectedDevices)){const g=this.toSelectedDevices(this.selectedDevices),m=this.toSelectedDevices(S);this.event("onSelectedDevicesChanged").raise(g,m),g.microphone!==m.microphone&&this.rawDeviceStreamManager.notifyChange("Audio"),g.camera!==m.camera&&this.rawDeviceStreamManager.notifyChange("Video"),this.clientAudioRenderers.forEach((g=>{g.setOutputDevice(this.getOutputDeviceId())}))}const v=this.configProvider.config.devices.piiSafeWords;this.raiseTelemetryEvent("selected_devices_changed",{microphone:this.selectedDevices.microphone&&scrubDeviceLabelPii(this.selectedDevices.microphone.label,v),camera:this.selectedDevices.camera&&scrubDeviceLabelPii(this.selectedDevices.camera.label,v),speaker:this.selectedDevices.speaker&&scrubDeviceLabelPii(this.selectedDevices.speaker.label,v),fromInterface:m}),this.updateRenderersAsync()}onDevicesChanged(g,m){this.event("onDevicesChanged").raise(g,m),this.mediaStreamManager.onDevicesChanged(g),this.diagnostics?.setDeviceList(g,m,this.getDeviceListDebugInfo());const S=this.getDevicesCount();this.ufdManager.signalEvent("ZeroCaptureDevicesEnumerated",S.microphone>0?"Good":"Bad"),this.isAudioOutputSelectionSupported&&this.ufdManager.signalEvent("ZeroRenderDevicesEnumerated",S.speaker>0?"Good":"Bad");const v=new Map;let C=1;this.raiseTelemetryEvent("devices_changed",{devices:g.map((g=>{const m=v.get(g.groupId)||C++;return v.set(g.groupId,m),{label:scrubDeviceLabelPii(g.label,this.configProvider.config.devices.piiSafeWords),isSystemDefault:g.isSystemDefault,kind:g.kind,type:g.type,capabilities:g.capabilities,groupId:`${m}`}})),debug:this.getDeviceListDebugInfo()})}getDeviceListDebugInfo(){return Pm.list.debugInfo}raiseTelemetryEvent(g,m){this.logger.safe.info(`Device event: ${g}: ${JSON.stringify(this.scrubPayload(g,m))}`);const S={eventType:g,timestamp:Date.now(),payload:m};this.diagnostics?.registerDeviceTelemetryEvent(deepClone(S)),this.event("onDeviceTelemetryEvent").raise(S)}scrubPayload(g,m){if("devices_changed"===g){return{devices:values(m.devices).map((g=>scrubDevices(g,this.configProvider.config.devices.piiSafeWords))),debug:m.debug}}return m}async onStreamStarted(g,m){if(this.permissionManager.browserPermittedModalities.audio.some((g=>g===Ke.MEDIA_STATE.send))||this.permissionManager.browserPermittedModalities.video.some((g=>g===Ke.MEDIA_STATE.send)))try{await Pm.enumerateDevices()}catch(g){this.logger.safe.warn(`onStreamStarted device enumeration failed: ${stringifyObject(g)}`)}if(g.rawTrack){switch(g.mediaType){case"Audio":this.deviceEnumerator.startDevicePolling(),this.updateActiveMicrophone(g,m);break;case"Video":this.deviceEnumerator.startDevicePolling()}this.configProvider.config.useRawMediaApiForVideoEffects&&g.getCurrentConstraints().withEffect&&(this.activeVideoEffectSub=this.effectsManager.on("onVideoStreamQualityChanged",((m,S,v)=>g.onVideoStreamQualityChanged(m,S,v))))}else this.logger.safe.warn(`stream:${g.id} is already disposed`)}updateActiveMicrophone(g,m){if(g.deviceId){const S=this.deviceList.find((m=>m.deviceId===g.deviceId));if(!S&&"default"!==g.deviceId)return void this.logger.safe.error("Active device not found",`Device id from track: '${scrubMriOrOmit(g.deviceId)}', known devices: [${this.deviceList.map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords))))}]}`,JSON.stringify(scrubConstraints(m)));S&&"default"!==g.deviceId&&m.audio&&m.audio.deviceId===Ke.MEDIA_DEVICE.defaultId&&Pm.list.updateActiveMicrophone(S)}}onStreamDisposing(g){this.unsubscribeFromStreamEvents(g)}onStreamMuted(g,m){("Audio"===g.mediaType||this.configProvider.config.raiseVideoMuteUfd)&&this.ufdManager.signalDeviceEvent(2,m?"Bad":"Good",g.mediaType,this.id),this.raiseTelemetryEvent(m?"stream_muted":"stream_unmuted",g.mediaType)}onStreamEnded(g,m){m.error?(this.raiseTelemetryEvent("stream_ended_error",{mediaType:g.mediaType,error:{type:m.error.name,detail:m.error.message}}),"SourceUnavailableError"===m.error.name&&this.ufdManager.signalDeviceEvent(0,"Bad","Audio",this.id)):("Audio"!==g.mediaType&&"Video"!==g.mediaType||this.ufdManager.signalDeviceEvent(0,"Bad",g.mediaType,this.id),this.raiseTelemetryEvent("stream_ended",g.mediaType))}onStreamError(g,m){this.raiseTelemetryEvent("stream_error",{mediaType:g.mediaType,error:m})}onAllStreamsRemoved(){this.deviceEnumerator.stopDevicePolling(),this.audioSharingRequested=!1}onStreamAcquired(g,m,S,v,C,_){0!==S&&this.raiseTelemetryEvent("stream_acquired",{id:g,mediaType:m,timestamp:S,resolution:v,withAudio:C,source:_})}onStreamCreated(g,m){this.raiseTelemetryEvent("stream_created",{id:g,mediaType:m})}onMasterStreamDisposing(g,m){this.raiseTelemetryEvent("stream_disposed",{id:g,mediaType:m})}onRendererDisposed(g){remove2(this.activeRenderers,(m=>m===g)),this.domOverrides.onMediaElementRemoved?.(g.getVideoElement()),this.unsubscribeFromRendererEvents(g)}onRendererStarted(g){this.activeRenderers.push(g),this.event("onLocalRendererStarted").raise(g)}getLargestRendererResolution(){const g=this.activeRenderers.map((g=>g.getResolution()));return g?.length>0?g.reduce(((g,m)=>m.height>g.height?m:g)):{width:0,height:0}}onVideoEffectsQualityEventHandler(g){const m=this.deviceSelection.selectedDevices.camera;if(m?.deviceId){const S={type:"onVideoEffectQualityChanged",payload:{message:g.message,effectType:g.effectType}};this.event("onVideoEffectsEvent").raise(m.deviceId,S)}}onRendererSizeChanged(){const g=this.getLargestRendererResolution();this.effectsManager.resetOutputConstraints("Video",g,Fn.EffectQualityChangeReason.RendererSize)}getDeviceType(g){if("Video"===g)return"camera";if("Audio"===g)return"microphone";throw new Error(`DeviceType for mediaType: ${g} doesn't exist`)}getStreamHandlerByType(g){return"Video"===g?()=>this.getVideoStream(!1,"rawStream",!0):"Audio"===g?()=>this.getAudioStream(!1,"rawStream",!0):"ScreenShare"===g?()=>this.getDisplayStream("rawStream",!0):null}},jm=class{constructor(g){this.configProvider=g,this.data={deviceList:[],deviceSelectionChangeCount:0,deviceSelectionChangeCountFromInterface:0,permissionStates:{microphone:"unknown",camera:"unknown"},devicesCount:{microphone:0,camera:0,speaker:0,compositeAudio:0,audioIngestDevice:0,virtualDevice:0},devicesChangeCount:0,devicesPollChangeCount:0,deviceTelemetryEvents:[],videoEffectsEvents:[],audioEffectsEvents:[]},Object.defineProperty(this.data,"rawUsedDevices",{get:()=>this.rawUsedDevices,configurable:!1,enumerable:!1})}set permissionStates(g){this.data.permissionStates=g}setSelectedDevices(g,m){const S={microphone:scrubDeviceLabelPii(g.microphone?.label,this.configProvider.config.devices.piiSafeWords),camera:scrubDeviceLabelPii(g.camera?.label,this.configProvider.config.devices.piiSafeWords),speaker:scrubDeviceLabelPii(g.speaker?.label,this.configProvider.config.devices.piiSafeWords)};this.rawUsedDevices={microphone:g.microphone?.label,camera:g.camera?.label,speaker:g.speaker?.label},this.data.usedDevices&&(this.data.deviceSelectionChangeCount++,m&&this.data.deviceSelectionChangeCountFromInterface++),this.data.usedDevices=S}setDeviceList(g,m,S){this.data.deviceList=g.map((g=>({label:scrubDeviceLabelPii(g.label,this.configProvider.config.devices.piiSafeWords),kind:g.type}))),S&&(this.data.deviceDebugStrings=deepClone(S)),this.data.devicesCount.microphone=g.filter((g=>"microphone"===g.type)).length,this.data.devicesCount.camera=g.filter((g=>"camera"===g.type)).length,this.data.devicesCount.speaker=g.filter((g=>"speaker"===g.type)).length,this.data.devicesCount.compositeAudio=g.filter((g=>"compositeAudio"===g.type)).length,this.data.devicesChangeCount++,m&&this.data.devicesPollChangeCount++}registerDeviceTelemetryEvent(g){if("stream_acquired"===g.eventType){const m=g.payload;"Video"===m.mediaType&&(this.data.latestCameraOpenResolution=m.resolution)}arrayLimitedPush(this.data.deviceTelemetryEvents,g,this.configProvider.config.diagnostics.collectionLimits.numDeviceEvents)}registerVideoEffectsEvent(g){arrayLimitedPush(this.data.videoEffectsEvents,g,this.configProvider.config.diagnostics.collectionLimits.numVideoEffectsEvents)}registerAudioEffectsEvent(g){arrayLimitedPush(this.data.audioEffectsEvents,g,this.configProvider.config.diagnostics.collectionLimits.numAudioEffectsEvents)}getObjectRef(){return this.data}},qm=class{constructor(){this.data={clientDSH:void 0,signalingDSH:void 0,serverDSH:void 0,activeStrategy:void 0,lastMsgOrigin:void 0}}setCurrentActiveStrategy(g){this.data.activeStrategy=g}resetState(){return this.data.lastMsgOrigin=void 0,this}recordHistoryEvent(g,m){var S,v;(S=this.data)[v=m+"DSH"]??(S[v]={count:0,duplicateCount:0}),this.data.lastMsgOrigin=m;const C=this.data[m+"DSH"];C.count++,C.firstMsgTime??(C.firstMsgTime=Date.now()),deepEqual(this.data.lastHistory,g)&&C.duplicateCount++,this.data.lastHistory=g,this.data.lastMsgDate=Date.now()}getObjectRef(){return this.data}},Wm=class{constructor(g,m){this.configProvider=g,this.addStatsError=m,this.data={video:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},sharing:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},subscribedTrackIds:[]}}set subscribedTrackIds(g){this.data.subscribedTrackIds=g}addSubscribe(g,m,S){const v=this.getModalityData(g);if(v){const g={evt:1,msi:m,localMsi:S,ts:Date.now()};arrayLimitedPush(v.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),v.counters.attempted++}}addSubscribed(g,m,S,v){const C=this.getModalityData(g);if(C){const g={evt:2,msi:m,localMsi:S,ts:Date.now(),duration:v};arrayLimitedPush(C.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),C.counters.subscribed++}}addUnsubscribe(g,m,S){const v=this.getModalityData(g);if(v){const g={evt:3,msi:m,localMsi:S,ts:Date.now()};arrayLimitedPush(v.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),v.counters.unsubscribed++}}addFailed(g,m,S,v){const C=this.getModalityData(g);if(C){const g={evt:-1,msi:m,localMsi:S,ts:Date.now(),error:v};arrayLimitedPush(C.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),C.counters.failed++}}getObjectRef(){return this.data}getModalityData(g){switch(g){case Ke.MEDIA_TYPE.video:return this.data.video;case Ke.MEDIA_TYPE.sharing:return this.data.sharing;default:return void this.addStatsError(`Unsupported modality ${g}`)}}},zm=class{constructor(g,m){this.configProvider=g,this.addStatsError=m,this.data={videoMaxCapabilitiesEvents:[],videoMaxCapabilitiesErrors:[],sharingMaxCapabilitiesEvents:[],sharingMaxCapabilitiesErrors:[],currentVideoSsrcRequestedCapabilities:{},currentVideoSsrcAppliedCapabilities:{},currentSharingSsrcRequestedCapabilities:{},currentSharingSsrcAppliedCapabilities:{},numVideoControlMessages:0,numOutOfOrderVideoControlMessages:0,numWebcamFreezeIntervals:0,numProcessedStreamFreezeIntervals:0}}onMaxCapabilitiesRequested(g){const m={causeId:g.causeId,events:[{eventType:"req",timestamp:Date.now(),capabilities:g.capabilities,isSimulcast:g.isSimulcastEnabled}]};try{if(g.modality===Ke.MODALITY.video){arrayLimitedPush(this.data.videoMaxCapabilitiesEvents,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const m of g.capabilities)this.data.currentVideoSsrcRequestedCapabilities[`${m.ssrc??0}`]=m}else if(g.modality===Ke.MODALITY.sharing){arrayLimitedPush(this.data.sharingMaxCapabilitiesEvents,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const m of g.capabilities)this.data.currentSharingSsrcRequestedCapabilities[`${m.ssrc??0}`]=m}}catch(g){this.addStatsError?.("onMaxCapabilitiesRequested",stringifyObject(g))}}onMaxCapabilitiesApplied(g){try{const m=this.getEventForCause(g.modality,g.causeId),S={eventType:"app",timestamp:Date.now(),capabilities:g.capabilities,error:`${g.error}`||"none"};if(m&&(arrayLimitedPush(m.events,S,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1),g.error&&(g.modality===Ke.MODALITY.video?arrayLimitedPush(this.data.videoMaxCapabilitiesErrors,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1):g.modality===Ke.MODALITY.sharing&&arrayLimitedPush(this.data.sharingMaxCapabilitiesErrors,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1))),g.modality===Ke.MODALITY.video)for(const m of g.capabilities)this.data.currentVideoSsrcAppliedCapabilities[`${m.ssrc??0}`]=m;else if(g.modality===Ke.MODALITY.sharing)for(const m of g.capabilities)this.data.currentSharingSsrcAppliedCapabilities[`${m.ssrc??0}`]=m}catch(g){this.addStatsError?.("onMaxCapabilitiesApplied",stringifyObject(g))}}addVideoControlMessage(g=!1){this.data.numVideoControlMessages++,g&&this.data.numOutOfOrderVideoControlMessages++}getObjectRef(){return this.data}registerWebcamFreeze(){this.data.numWebcamFreezeIntervals++}registerProcessedStreamFreeze(){this.data.numProcessedStreamFreezeIntervals++}getEventForCause(g,m){return(g===Ke.MODALITY.video?this.data.videoMaxCapabilitiesEvents:this.data.sharingMaxCapabilitiesEvents).find((g=>g.causeId===m))}},Km=class{constructor(g){this.configProvider=g,this.data={renderers:[],firstTimeToFirstFrameVideo:-1,firstTimeToFirstFrameSharing:-1,timeToFirstFrameSinceSubscriptionStartVideo:-1,timeToFirstFrameSinceSubscriptionStartSharing:-1,isRenderingEvents:{video:[],sharing:[]},preferredResolution:{video:void 0,sharing:void 0}}}setTimeToFirstFrame(g,m){-1!==g&&(m===Ke.MODALITY.video&&-1===this.data.firstTimeToFirstFrameVideo?this.data.firstTimeToFirstFrameVideo=g:m===Ke.MODALITY.sharing&&-1===this.data.firstTimeToFirstFrameSharing&&(this.data.firstTimeToFirstFrameSharing=g))}setTimeToFirstFrameSinceSubscriptionStart(g,m){-1!==g&&(m===Ke.MODALITY.video&&-1===this.data.timeToFirstFrameSinceSubscriptionStartVideo?this.data.timeToFirstFrameSinceSubscriptionStartVideo=g:m===Ke.MODALITY.sharing&&-1===this.data.timeToFirstFrameSinceSubscriptionStartSharing&&(this.data.timeToFirstFrameSinceSubscriptionStartSharing=g))}setIsRendering(g,m){this.data.isRenderingEvents[m]&&arrayLimitedPush(this.data.isRenderingEvents[m],{isRendering:g,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents)}setPreferredResolution(g,m){(g.width||g.height)&&(this.data.preferredResolution[m]=g)}newRendererDiagnostics(){const g=new Jm(this,this.configProvider),m=g.on("onDisposed",(()=>{this.removeDeadRenderers(),m.dispose()}));return this.data.renderers.push(g.getObjectRef()),g}getObjectRef(){return this.data}removeDeadRenderers(){this.data.renderers=this.data.renderers.filter((g=>g.alive))}},Jm=class extends je{constructor(g,m){super(),this.managerDiagnostics=g,this.configProvider=m,this.isAlive=!0,this.data={alive:!0,totalFreezeDuration:0,isRendering:!1,timeToFirstFrame:-1,timeToFirstFrameSinceSubscriptionStart:-1,rendererStates:[]},delete this.data.alive,Object.defineProperty(this.data,"alive",{get:()=>this.isAlive,enumerable:!1,configurable:!1})}set trackId(g){this.data.trackId=g}set rendererSize(g){this.data.rendererSize=g,g.toString=()=>`${g.width}x${g.height}`,this.managerDiagnostics.setPreferredResolution(g,this.data.modality)}set msi(g){this.data.msi=g}set modality(g){this.data.modality=g}set isRendering(g){this.data.isRendering=g,this.managerDiagnostics.setIsRendering(g,this.data.modality)}set timeToFirstFrame(g){this.data.timeToFirstFrame=g,this.managerDiagnostics.setTimeToFirstFrame(g,this.data.modality)}set timeToFirstFrameSinceSubscriptionStart(g){this.data.timeToFirstFrameSinceSubscriptionStart=g,this.managerDiagnostics.setTimeToFirstFrameSinceSubscriptionStart(g,this.data.modality)}addFreezeDuration(g){this.data.totalFreezeDuration+=g}addStateChange(g){arrayLimitedPush(this.data.rendererStates,g,this.configProvider.config.diagnostics.telemetryLimits.numRendererStateChangedEvents)}dispose(){this.isAlive=!1,this.event("onDisposed").raise()}getObjectRef(){return this.data}},Ym=P,Qm=__toESM(Me()),Xm=P;function fmtParamsToString(g){let m="";return forOwn(g,((g,S)=>{m+=(m?";":"")+S,void 0!==g&&(m+=`=${g}`)})),m}var Zm=class{constructor(g){this.parameters={},g&&g.split(";").forEach((g=>{const m=g.split("=");this.parameters[m[0]]=m[1]}))}setIfMissing(g,m){this.contains(g)||(this.parameters[g]=m)}removeIfPresent(g){this.contains(g)&&delete this.parameters[g]}get(g){return this.parameters[g]}names(){return Object.keys(this.parameters)}contains(g){return this.parameters.hasOwnProperty(g)}toString(){return fmtParamsToString(this.parameters)}};function updatePayload(g,m,S){if(!g.rtp)return;const v=g.rtp.filter((g=>g.payload===m))[0];v&&forOneCodec(g,{codec:v.codec,rate:v.rate,payload:v.payload,encoding:v.encoding},(g=>(g.rtp.payload=S,g)))}function findAvailablePayload(g){const m=new Set;for(const S of g.media)for(const g of S.rtp??[])m.add(g.payload);const S=[96,127];for(let g=S[0];g<=S[1];g++)if(!m.has(g))return g;const v=[35,64];for(let g=v[0];g<=v[1];g++)if(!m.has(g))return g;return-1}function findAllAvailablePayloads(g,m){const S=new Set,v=[];for(const m of g.media)for(const g of m.rtp??[])S.add(g.payload);for(let g=m[0];g<=m[1];g++)S.has(g)||v.push(g);return v}function forOneCodec(g,m,S){forCodec(g,m,!0,S)}function forAllCodecs(g,m,S){forCodec(g,m,!1,S)}function forCodec(g,m,S,v){if(g.rtp){for(let C=0;C<g.rtp.length;C++){const _=g.rtp[C],E=_.payload;if(m.codec.toLowerCase()!==_.codec.toLowerCase()||m.rate!==_.rate||m.encoding!==_.encoding||m.payload&&m.payload!==_.payload)continue;const T={rtp:_};g.fmtp||(g.fmtp=[]);const I=g.fmtp.find((g=>_.payload===g.payload));T.fmtp=I,g.rtcpFb||(g.rtcpFb=[]),T.rtcpFb=g.rtcpFb.filter((g=>g.payload===_.payload));const b=T.rtcpFb.length>0;if(null===v(T))g.payloads=g.payloads.toString().split(" ").filter((g=>_.payload!==+g)).join(" "),g.fmtp=g.fmtp.filter((g=>_.payload!==g.payload)),g.rtcpFb=g.rtcpFb.filter((g=>_.payload!==g.payload)),g.rtp[C]=null;else{if(T.rtp.payload!==E){const m=T.rtp.payload;g.payloads=g.payloads.toString().split(" ").map((g=>+g===E?m:+g)).join(" "),T.fmtp&&(T.fmtp.payload=m),T.rtcpFb&&T.rtcpFb.forEach((g=>g.payload=m)),g.fmtp.filter((g=>g.config&&g.config.indexOf(`apt=${E}`)>-1)).forEach((g=>g.config=g.config.replace(`apt=${E}`,`apt=${m}`)))}!I&&T.fmtp&&g.fmtp.push(T.fmtp),!b&&T.rtcpFb&&T.rtcpFb.forEach((m=>g.rtcpFb.push(m)))}if(S)break}g.rtp=g.rtp.filter((g=>!!g))}}function removeCodec(g,m){if(!g.rtp)return;let S=-1;if(g.rtp.forEach((function(g,v){m.codec.toLowerCase()!==g.codec.toLowerCase()||m.rate!==g.rate||m.encoding!==g.encoding||m.payload&&m.payload!==g.payload||(S=v)})),S>=0&&g.rtp.length>1){const m=g.rtp[S].payload;g.rtp.splice(S,1),g.payloads=g.payloads.split(" ").filter((g=>m!==+g)).join(" "),g.fmtp=g.fmtp?.filter((g=>m!==g.payload))}}function addCodec(g,m){g.rtp.unshift({payload:m.payload,codec:m.codec,rate:m.rate,encoding:m.encoding}),g.payloads=`${m.payload} ${g.payloads}`}function isCodecsMatch(g,m,S){if(!(0,Xm.isUndefined)(g.rate)&&g.rate!==m.rate)return!1;if(!(0,Xm.isUndefined)(g.codec)&&g.codec.toLowerCase()!==m.codec.toLowerCase())return!1;if(!(0,Xm.isUndefined)(g.encoding)){if(!(0,Xm.isUndefined)(m.encoding)&&g.encoding!==m.encoding)return!1;if((0,Xm.isUndefined)(m.encoding)&&1!==g.encoding)return!1}if(!(0,Xm.isUndefined)(g.fmtpLine)){return!!(S&&S.find((S=>S.payload===m.payload&&-1!==S.config.toLowerCase().indexOf(g.fmtpLine.toLowerCase()))))}return!0}function isPayloadMatch(g,m){return m===g||"*"===m}function filterCodecs(g,m,S,v){if(!g.rtp?.length)return;let C=g.rtp.filter((S=>m.some((m=>isCodecsMatch(m,S,g.fmtp)))));g.type===Ke.MEDIA_TYPE.video&&(C=C.filter((m=>{const S=g.fmtp&&g.fmtp.find((g=>g.payload===m.payload&&g.config.startsWith("apt=")));if(S){const g=+S.config.split(";")[0].split("=")[1];return C.some((m=>m.payload===g))}return!0}))),C.length?(g.rtp=C,S&&(g.rtp=(0,Xm.flatten)(m.map((m=>g.rtp.filter((S=>isCodecsMatch(m,S,g.fmtp))))))),g.payloads=g.rtp.map((g=>g.payload)).join(" "),g.fmtp=g.fmtp&&g.fmtp.filter((m=>g.rtp.some((g=>isPayloadMatch(g.payload,m.payload))))),g.rtcpFb=g.rtcpFb&&g.rtcpFb.filter((m=>g.rtp.some((g=>isPayloadMatch(g.payload,m.payload)))))):v&&v.warn("Empty rtp list after filtering")}function getModalityForMedia(g){if(g.label)switch(g.label){case Ke.MEDIA_LABEL.audio:return"Audio";case Ke.MEDIA_LABEL.video:return"Video";case Ke.MEDIA_LABEL.sharing:return"ScreenShare";case Ke.MEDIA_LABEL.data:return"Data"}else switch(g.type){case Ke.MEDIA_TYPE.audio:return"Audio";case Ke.MEDIA_TYPE.video:return"Video";case Ke.MEDIA_TYPE.data:case Ke.MEDIA_TYPE.dataChannel:return"Data"}return null}function getModality(g){if(g.label)switch(g.label){case Ke.MEDIA_LABEL.audio:return Ke.MODALITY.audio;case Ke.MEDIA_LABEL.video:return Ke.MODALITY.video;case Ke.MEDIA_LABEL.sharing:return Ke.MODALITY.sharing;case Ke.MEDIA_LABEL.data:return Ke.MODALITY.data}else switch(g.type){case Ke.MEDIA_TYPE.audio:return Ke.MODALITY.audio;case Ke.MEDIA_TYPE.video:return Ke.MODALITY.video;case Ke.MEDIA_TYPE.data:case Ke.MEDIA_TYPE.dataChannel:return Ke.MODALITY.data}return null}function getLabelForModality(g){switch(g){case Ke.MODALITY.audio:return Ke.MEDIA_LABEL.audio;case Ke.MODALITY.video:return Ke.MEDIA_LABEL.video;case Ke.MODALITY.sharing:return Ke.MEDIA_LABEL.sharing;case Ke.MODALITY.data:return Ke.MEDIA_LABEL.data;default:return null}}function getModalities(g){return g.media.reduce(((g,m)=>{if(0!==m.port){const S=getModality(m);if(!(S in g)){const v=m.direction?m.direction.toLowerCase():Ke.MEDIA_STATE.sendReceive;g[S]=v}}return g}),{})}function getTypeFromModality(g){switch(g){case Ke.MODALITY.audio:return Ke.MEDIA_TYPE.audio;case Ke.MODALITY.video:case Ke.MODALITY.sharing:return Ke.MEDIA_TYPE.video;case Ke.MODALITY.data:return Ke.MEDIA_TYPE.data;default:return null}}function getBundle(g){const m=g.groups?.find((g=>"BUNDLE"===g.type));if(m){const S=m.mids?.toString().split(" ")[0];return g.media.find((g=>{const m="number"==typeof g.mid?g.mid.toString():g.mid;return S===m}))||null}return null}function isMediaDisabled(g){return 0===g.port}function getRecvCapabilitiesForMedia(g){let m;return g&&forOneCodec(g,{codec:"h264",rate:9e4},(g=>{g.fmtp?.config&&(m=parseVideoCapabilitiesFromFmtpConfig(g.fmtp.config))})),m}function getNextAvailableMid(g){const m=g.media.map((g=>parseFloat(g.mid)));for(let g=1;g<=Math.max(...m)+1;g++)if(!m.includes(g))return g.toString();return"-1"}function parseVideoCapabilitiesFromFmtpConfig(g){const m=new Zm(g);return{maxFs:+m.get(Ke.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+m.get(Ke.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+m.get(Ke.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+m.get(Ke.VIDEO_CAPABILITIES.MAX_BR_PATH)}}var ef=P;function CandidateTransform(){const g=[{jsep:"active",msSdp:"tcp-act"},{jsep:"passive",msSdp:"tcp-pass"},{jsep:"so",msSdp:"tcp-so"}];function transformBundle(g,m){if(g.port&&!g.candidates.length){const S=getBundle(m);S&&(g.port=S.port,g.connection=S.connection)}}function transformCandidate(g,m){delete g.generation,delete g["network-id"],delete g["network-cost"],g.transport.match(/tcp/i)&&transformTcpCandidate(g,m)}function transformTcpCandidate(m,S){g.some((function(g){if(S){if(g.msSdp===m.transport.toLowerCase())return m.transport="tcp",m.tcptype=g.jsep,!0}else if(m.tcptype&&g.jsep===m.tcptype.toLowerCase())return m.transport=g.msSdp,delete m.tcptype,!0;return!1}))}function isDefault(g,m,S){const v=m.connection||S.connection,isSame=function(g,m,S){return g.port===S&&g.ip===m};return!!v&&(1===g.component?isSame(g,v.ip,m.port):!!m.rtcp&&isSame(g,m.rtcp.ip||v.ip,m.rtcp.port))}this.fromMsSdp=function(g){g.candidates=g.candidates||[],g.xCandidatesIpv6&&(g.xCandidatesIpv6.forEach((function(m){g.candidates.push(m)})),delete g.xCandidatesIpv6),g.candidates.forEach((function(g){transformCandidate(g,!0)}))},this.toMsSdp=function(g,m){g.candidates=g.candidates||[],g.candidates.sort((function(S,v){return S.foundation!==v.foundation?S.foundation-v.foundation:S.component!==v.component?S.component-v.component:+isDefault(v,g,m)-+isDefault(S,g,m)})),g.candidates=g.candidates.filter((function(m,S){transformCandidate(m,!1);const v=g.candidates[S-1];return!v||v.component!==m.component||v.foundation!==m.foundation})),transformBundle(g,m)}}var tf={build:()=>new CandidateTransform},nf=class{toMsSdp(g,m){"offer"===m?g.rtcp&&(g.rtcp={port:g.port}):delete g.rtcp}},rf={build:()=>new nf},sf={STREAM_ID:{audio:"mainAudio",video:"mainVideo",sharing:"applicationsharingVideo"},STREAM_ID_DELIMITER:"-"},af=[{label:Ke.MEDIA_LABEL.audio,id:sf.STREAM_ID.audio},{label:Ke.MEDIA_LABEL.video,id:sf.STREAM_ID.video},{label:Ke.MEDIA_LABEL.sharing,id:sf.STREAM_ID.sharing}].reduce(((g,m)=>(g[m.label]=m.id,g)),{}),of=uniqueId(),lf=class{constructor(g){this.configuration=g}fromMsSdp(g){if(0===g.port)return;const m="-";if(!this.isRecvOnly(g)||this.configuration.unifiedPlanEnabled){if(g.msid){g.ssrcs&&1===g.ssrcs.length&&(this.addStream(g,g.ssrcs[0].id,g.ssrcs[0].value,g.msid),g.ssrcs.shift());const S=g.msid.split(" ");(this.configuration.addPrefixForMsid||S[0]===m)&&(g.msid=this.getMsidValue(S[0],S[1]||S[0],g.label))}if(g.ssrcs)this.updateMsids(g.ssrcs,((S,v)=>this.configuration.addPrefixForMsid||S===m?this.getMsidValue(S,v,g.label):`${S} ${v}`));else{const m=this.getFlowSsrcs(g);m.length>0?m.forEach((S=>{this.addStream(g,S,of,this.getMsidValue(m[0],m[0],g.label))})):g.xSsrcRange&&this.addStream(g,g.xSsrcRange.ssrcMin,of,this.getMsidValue(g.xSsrcRange.ssrcMin,g.xSsrcRange.ssrcMin,g.label))}}delete g.xSsrcRange}toMsSdp(g,m){if(0===g.port)return;let S;g.ssrcs&&g.ssrcs[0]&&(S=g.ssrcs[0].id),void 0!==S&&(g.xSsrcRange={ssrcMin:S,ssrcMax:S+m})}getFlowSsrcs(g){if(g.ssrcGroups&&g.type===Ke.MEDIA_TYPE.video){let m;if(g.ssrcGroups.some((g=>"FID"===g.semantics&&(m=g,!0))),m)return m.ssrcs.split(" ").map((g=>+g))}return[]}addStream(g,m,S,v){g.ssrcs=g.ssrcs||[],g.ssrcs.push({attribute:"cname",id:m,value:S}),g.ssrcs.push({attribute:"msid",id:m,value:v})}updateMsids(g,m){g.filter((g=>"msid"===g.attribute)).forEach((g=>{const S=g.value.split(" ");g.value=m(S[0],S[1]||S[0])}))}getMsidValue(g,m,S){const v=this.getMsidPrefix(S);return v+g+" "+v+m}getMsidPrefix(g){return af[g]?af[g]+sf.STREAM_ID_DELIMITER:""}isRecvOnly(g){return"recvonly"===g.direction}},cf={audio:"main-audio",video:"main-video"},df=class{constructor(g,m){this.context=g,this.mediaManager=m,this.logger=this.context.logger,this.candidateTransform=tf.build(),this.streamTransform=new lf(this.context.configuration),this.rtcpTransform=rf.build()}toMsSdp(g,m){return g.msidSemantic={semantic:"WMS",token:"*"},g.media.forEach(((S,v)=>{if(S.protocol=Ke.PROFILES.rtpSavp,S.label=S.label||this.getLabel(S.type),isMediaDisabled(S)){for(const g in S)S.hasOwnProperty(g)&&["type","port","protocol","payloads"].indexOf(g)<0&&delete S[g];S.payloads="34"}const C=this.getSsrcRangeForIndex(S.direction,v);this.streamTransform.toMsSdp(S,C),S.crypto&&S.crypto.forEach((function(g){g.config+="|2^31"})),0!==S.port&&g.fingerprint&&(S.fingerprint=g.fingerprint),this.candidateTransform.toMsSdp(S,g),this.rtcpTransform.toMsSdp(S,m),S.invalid&&(this.logger.unsafe.error(`Unknown SDP attributes! ${JSON.stringify(S.invalid)}`),delete S.invalid),this.transformExtensions(S,!1),0!==S.port&&(S.type===Ke.MEDIA_TYPE.audio&&this.context.configProvider.config.webrtcAudioChannelSignalingFeedback?S.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcAudioChannelSignalingFeedback}:S.type===Ke.MEDIA_TYPE.video&&this.context.configProvider.config.webrtcVideoChannelSignalingFeedback&&(S.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcVideoChannelSignalingFeedback}))})),delete g.fingerprint,g}fromMsSdp(g,m){for(let S=g.media.length-1;S>=0;--S){const v=g.media[S];if((v.ssrcs&&v.ssrcs[0]||v.xSsrcRange)&&(g.msidSemantic={semantic:"WMS",token:"*"}),isMediaDisabled(v))v.direction||(v.direction="inactive");else{if(this.streamTransform.fromMsSdp(v),delete v.cryptoscale,v.fingerprint&&(!this.isOffer(m)||this.context.configProvider.config.disableIncomingDtlsRoleOverride&&v.setup||(v.setup="actpass")),v.crypto)for(let g=v.crypto.length-1;g>=0;--g){const m=v.crypto[g];m.config.match(/.*\|\d+:\d+/)?v.crypto.splice(g,1):m.config=m.config.replace(/(.*)\|2\^\d+/,"$1")}v.remoteCandidates&&(delete v.candidates,delete v.xCandidatesIpv6,delete v.remoteCandidates),this.candidateTransform.fromMsSdp(v),v.rtcpFbXMessage&&delete v.rtcpFbXMessage,v.invalid&&this.logger.unsafe.info(`Unknown SDP attributes! ${JSON.stringify(v.invalid)}`),this.transformExtensions(v,!0)}}return g}transformExtensions(g,m){const S=[{name:Ke.ABS_SEND_TIME.EXT_URI,encoded:Ke.ABS_SEND_TIME.MSSDP_ENCODED_URI},{name:Ke.TRANSPORT_CC.EXT_URI,encoded:Ke.TRANSPORT_CC.MSSDP_ENCODED_URI}];g.ext&&g.ext.forEach((function(g){S.some((function(S){const v=m?S.encoded:S.name,C=m?S.name:S.encoded;return v===g.uri&&(g.uri=C,!0)}))}))}isOffer(g){return"offer"===g}getLabel(g){return cf.hasOwnProperty(g)&&cf[g]||"undefined"}getSsrcRangeForIndex(g,m){const S=this.mediaManager.getMediaEntities()[m],v=S?.getSimulcastContext();return hasSendDirectionality(g)&&v?v.getSsrcRange():0}},hf=class{constructor(g,m,S){this.context=g,this.mediaManager=m,this.sessionType=S,this.msSdpT=new df(this.context,this.mediaManager)}modify(g){this.msSdpT.toMsSdp(g,this.sessionType)}},uf=class{constructor(g,m,S){this.context=g,this.mediaManager=m,this.sessionType=S,this.msSdpT=new df(this.context,this.mediaManager)}modify(g){this.msSdpT.fromMsSdp(g,this.sessionType)}},gf=class{constructor(g){this.context=g}modify(g){const m=preferSdesSrtp(this.context),S=getSrtpInfo(g),v=g.media.find((g=>!!g.crypto));g.media.forEach((g=>{g.type!==Ke.MEDIA_TYPE.dataChannel&&(!m&&g.fingerprint&&g.crypto&&delete g.crypto,g.protocol=!S.dtls||S.sdes&&m?Ke.PROFILES.rtpSavpf:Ke.PROFILES.udpTlsRtpSavpf,isMediaDisabled(g)&&g.protocol===Ke.PROFILES.rtpSavpf&&v&&(g.crypto=v.crypto))}))}},pf=class{constructor(g,m,S){this.mediaManager=g,this.isOffer=m,this.configProvider=S}modify(g){g.media.forEach(((g,m)=>{const S=g.setup,v=this.mediaManager.getMediaEntities()[m],C=v.getExtension("setup");S&&v.isEnabled()&&("actpass"!==S?v.setExtension("setup",S):this.isOffer&&void 0!==C&&"actpass"!==C&&!this.configProvider.config.disableOutgoingDtlsRoleOverride&&(g.setup=C))}))}},mf=class{constructor(g,m){this.mediaManager=g,this.modalities=m}modify(g){let m=0;g.media.forEach(((g,S)=>{const v=parseInt(g.mid,10);!isNaN(v)&&v>=m&&(m=v+1)})),g.media.forEach(((S,v)=>{const C=this.mediaManager.getMediaEntities()[v];if(isMediaDisabled(S)||C.isDisabled()||!(C.getModality()in this.modalities)){const _=C.getExtension("midApplied")?void 0:S.mid||""+m++;0===v?S.direction=Ke.MEDIA_STATE.inactive:g.media[v]=disabledMedia(S.type,void 0,S.protocol,_)}}))}},ff=class{constructor(g,m){this.mediaManager=g,this.remote=m}modify(g){const m=this.mediaManager.getMediaEntities();for(let S=0;S<m.length;S++){const v=m[S],C=g.media[S];if(v.getExtension("rollback"))if(C&&!this.remote)g.media[S]=null;else if(!C&&this.remote){const m=v.getType()===Ke.MEDIA_TYPE.data?Ke.MEDIA_TYPE.dataChannel:v.getType(),S=m===Ke.MEDIA_TYPE.dataChannel?Ke.PROFILES.udpDtlsSctp:Ke.PROFILES.udpTlsRtpSavpf;g.media.push(disabledMedia(m,void 0,S,void 0))}}g.media=g.media.filter((g=>g))}},Sf=class{constructor(g){this.mediaManager=g}modify(g){this.mediaManager.getMediaEntities().forEach(((m,S)=>{const v=g.media[S];m.getModality()!==Ke.MODALITY.data||v&&v.type===Ke.MEDIA_TYPE.dataChannel||g.media.splice(S,0,disabledMedia(Ke.MEDIA_TYPE.data,Ke.MEDIA_LABEL.data,Ke.PROFILES.rtpSavp,void 0))}))}},vf=class{constructor(g,m){this.context=g,this.direction=m}modify(g){g.media.forEach((g=>{g.type===Ke.MEDIA_TYPE.dataChannel&&(g.type=Ke.MEDIA_TYPE.data,g.payloads=Ke.PAYLOAD_TYPE.X_DATA)})),allowDataChannel(this.context)&&getEnabledMedia(g,Ke.MEDIA_TYPE.data).forEach((m=>{m.rtp=m.rtp||[],m.fmtp=m.fmtp||[],m.rtp.push({codec:"x-data",payload:127,rate:9e4}),m.rtp.push({codec:"rtx",payload:126,rate:9e4}),m.fmtp.push({payload:126,config:"apt=127"});const S=this.getNonOverlappingSsrc(g);m.xSsrcRange={ssrcMin:S,ssrcMax:S},m.rtcpMux="rtcp-mux",m.xDataProtocol="sctp",m.direction=this.direction}))}getNonOverlappingSsrc(g){let m,S=!0;do{m=Math.floor(4294967293*Math.random())+2,getEnabledMedia(g).forEach((g=>{g?.ssrcs?.[0]?.id===m&&(S=!1)}))}while(!S);return m}},Cf=class{constructor(g){this.configProvider=g,this.uri="urn:3gpp:video-orientation",this.value=13}modify(g){if(this.configProvider.config.enableVideoOrientationExtension)for(const m of getEnabledMedia(g,Ke.MEDIA_TYPE.video))this.modifyMedia(m)}},_f=class extends Cf{modifyMedia(g){g.ext??(g.ext=[]);g.ext.some((g=>g.uri===this.uri))||g.ext.push({value:this.getAvailableValue(g.ext),uri:this.uri})}getAvailableValue(g){const m=g.map((g=>g.value));return m.includes(this.value)?Math.max(...m)+1:this.value}},yf=class extends Cf{modifyMedia(g){g.ext=g.ext?.filter((g=>g.uri!==this.uri))}},Ef=class{constructor(g){this.context=g}modify(g){const m=g.groups?.find((g=>"BUNDLE"===g.type));for(let S=g.media.length-1;S>=0;S--){const v=g.media[S];if(v.type===Ke.MEDIA_TYPE.data){const C=this.context.configProvider.config.rejectUnbundledDataModality&&!this.context.configProvider.mediaConfig.isTransportUnbundled&&!m?.mids?.toString().includes(v.mid),_=allowDataChannel(this.context);_||this.context.configProvider.config.acceptDisabledDataModality?(v.port=_&&!C?v.port:0,v.payloads=Ke.PAYLOAD_TYPE.DATA_CHANNEL,v.type=Ke.MEDIA_TYPE.dataChannel,v.protocol=Ke.PROFILES.udpDtlsSctp,v.sctpPort??(v.sctpPort=this.context.configProvider.config.sctpPort),delete v.xDataProtocol,delete v.rtp,delete v.fmtp,delete v.rtcp,delete v.rtcpMux,delete v.ext,delete v.ssrcs,delete v.ssrcGroups,delete v.xSsrcRange):g.media.splice(S,1)}}}},Tf=class{constructor(g,m){this.modalities=g,this.mediaManager=m}modify(g){getEnabledMedia(g).forEach((g=>{const m=getModality(g),S=this.mediaManager.getMediaEntityByMid(g.mid);!(this.modalities[m]!==Ke.MEDIA_STATE.send||S.getExtension("reinviteless")||g.direction&&g.direction.toLowerCase()===Ke.MEDIA_STATE.receive)&&(g.direction=Ke.MEDIA_STATE.receive)}))}},If=class{constructor(g,m){this.isMultiparty=g,this.cname=m}modify(g){this.isMultiparty&&getEnabledMedia(g).forEach((g=>{const m=g.direction;m!==Ke.MEDIA_STATE.receive&&m!==Ke.MEDIA_STATE.inactive||(g.ssrcs&&g.ssrcs[0]?g.ssrcs=[{id:g.ssrcs[0].id,attribute:"cname",value:this.cname}]:g.type===Ke.MEDIA_TYPE.audio?g.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:g.type===Ke.MEDIA_TYPE.video&&(g.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}))}},bf=class{modify(g){const m=new Set;getEnabledMedia(g,Ke.MEDIA_TYPE.video).forEach((g=>{g.ssrcs&&g.ssrcs.length>1&&m.add(g.ssrcs[0].id)}));const S=getEnabledMedia(g,Ke.MEDIA_TYPE.video).find((g=>g.direction===Ke.MEDIA_STATE.sendReceive||g.direction===Ke.MEDIA_STATE.send));getEnabledMedia(g,Ke.MEDIA_TYPE.video).forEach((g=>{const v=g.direction;if((v===Ke.MEDIA_STATE.receive||v===Ke.MEDIA_STATE.inactive)&&g.ssrcs&&1===g.ssrcs.length){const v=g.ssrcs[0].id;(1===v||S&&S.ssrcs[0].id===v||!S&&m.has(v))&&(delete g.ssrcs,delete g.ssrcGroups)}}))}},Af=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{const S=this.mediaManager.getMediaEntities()[m];g.label=getLabelForModality(S.getModality())}))}},Rf=class{modify(g){g.media.forEach((g=>{delete g.label}))}},Pf=class{constructor(g,m,S){this.mediaManager=g,this.modalities=m,this.configProvider=S}modify(g){let m=this.configProvider.mediaConfig.maxBandwidthInKbps;const S=g.bandwidth?.find((g=>"CT"===g.type));S&&(!m||m>S.limit)&&(m=S.limit);const v=this.configProvider.config.audioBandwidthInKbps||0,C=Math.max(m-v,0),_=this.configProvider.config.videoBandwidthAllocation&&hasSendDirectionality(this.modalities.video)&&hasSendDirectionality(this.modalities.sharing);getEnabledMedia(g,Ke.MEDIA_TYPE.video).forEach((g=>{if(delete g.bandwidth,C){let m=C;if(_){const S=this.mediaManager.getMediaEntityByMid(g.mid).getModality()===Ke.MODALITY.video?this.configProvider.config.videoBandwidthAllocation:1-this.configProvider.config.videoBandwidthAllocation;m=Math.round(C*S)}g.bandwidth=[{limit:m,type:"AS"}]}}))}},Mf=class{constructor(g){this.configProvider=g}modify(g){const m=this.configProvider.mediaConfig.maxBandwidthInKbps;m&&(g.bandwidth=[{limit:m,type:"CT"}])}},wf=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{const S=this.mediaManager.getMediaEntities()[m],v=S.getExtension("iceUfrag");S.setExtension("iceRestart",!!g.iceUfrag&&!!v&&v!==g.iceUfrag),S.setExtension("iceUfrag",g.iceUfrag)}))}},Df=class{modify(g){const m=new Set(["urn:ietf:params:rtp-hdrext:csrc-audio-level","http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"]);getEnabledMedia(g).forEach((g=>{g.ext&&(g.ext=g.ext.filter((g=>!m.has(g.uri))))}))}},Of=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.extmapAllowMixed&&(g.extmapAllowMixed="extmap-allow-mixed")}},Nf=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.extmapAllowMixed||delete g.extmapAllowMixed}},kf=class{modify(g){getEnabledMedia(g).forEach((g=>{delete g.signalingFbXMessage}))}},Lf=class{constructor(g,m){this.mediaManager=g,this.configProvider=m}modify(g){if(!this.configProvider.config.isAv1Allowed)return;const m=findAllAvailablePayloads(g,[96,127]);this.mediaManager.getMediaEntities().forEach(((S,v)=>{if(S.getModality()===Ke.MODALITY.audio)return;const C=g.media[v];let _=0;forAllCodecs(C,{codec:"AV1",rate:9e4},(g=>{g.rtp.payload<96&&(g.rtp.payload=m[_]??g.rtp.payload,_++)}))}))}},Ff=class{constructor(g,m,S){this.mediaManager=g,this.configProvider=m,this.sdpType=S,this.baseModifier=new Uf(this.mediaManager,this.configProvider,this.sdpType,!1)}modify(g){this.configProvider.config.filterCodecsInSdpV2||this.baseModifier.modify(g)}},xf=class{constructor(g,m,S){this.mediaManager=g,this.configProvider=m,this.sdpType=S,this.baseModifier=new Uf(this.mediaManager,this.configProvider,this.sdpType,!0)}modify(g){this.configProvider.config.filterCodecsInSdpV2&&this.baseModifier.modify(g)}},Uf=class{constructor(g,m,S,v=!1){this.mediaManager=g,this.configProvider=m,this.sdpType=S,this.alwaysReorder=v}modify(g){this.configProvider.config.filterCodecsInSdp&&"offer"===this.sdpType&&this.mediaManager.getMediaEntities().forEach(((m,S)=>{const v=g.media[S];if(!v)return;const C=getAllowedCodecs(this.configProvider,v.type);if(!C.length)return;filterCodecs(v,convertToCodecInfo(C),!!m.getExtension("unnegotiatedModality")||this.alwaysReorder,null)}))}},Vf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),S=this.configProvider.mediaConfig.audioCodecContext;m&&S&&(S.codec!==S.lastUsedCodec&&"None"!==S.lastUsedCodec&&this.removeSubstitutionCodecIfNeeded(m,S.lastUsedCodec),S.enabledLocally&&!S.disabledRemotely&&this.addSubstitutionCodecIfNeeded(m,S.codec,g))}addSubstitutionCodecIfNeeded(g,m,S){if(this.isSubstitutionCodecAdded(g,m))return;const v=findAvailablePayload(S);if(-1===v)return;const C=getCustomCodecParams(m,"SUBSTITUTION");changePayloadType(S,C.payload,v),addCodec(g,C)}removeSubstitutionCodecIfNeeded(g,m){removeCodec(g,getCustomCodecParams(m,"SUBSTITUTION"))}isSubstitutionCodecAdded(g,m){let S=!1;return forOneCodec(g,getCustomCodecParams(m,"SUBSTITUTION"),(()=>{S=!0})),S}},Bf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),S=this.configProvider.mediaConfig.audioCodecContext;if(m&&S&&S.enabledLocally&&!S.disabledRemotely){const g=getCustomCodecParams(S.codec,"SUBSTITUTION"),v=getCustomCodecParams(S.codec,"CODEC");forOneCodec(m,g,(g=>{g.rtp.codec=v.codec,g.rtp.rate=v.rate,g.rtp.encoding=v.encoding}))}}},Hf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),S=this.configProvider.mediaConfig.audioCodecContext;if(!m||!S?.enabledLocally)return;const v=getCustomCodecParams(S.codec,"CODEC"),C=getCustomCodecParams(S.codec,"SUBSTITUTION");let _=!1;forOneCodec(m,v,(g=>{S.enabledForSend&&(g.rtp.codec=C.codec,g.rtp.rate=C.rate,g.rtp.encoding=C.encoding,g.fmtp={payload:v.payload,config:"ptime=20"}),_=!0})),S.disabledRemotely=!_}},$f=class{modify(g){removeCodec(g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),{codec:"CN",rate:16e3})}},Gf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),S=this.configProvider.mediaConfig.audioCodecContext;if(!m||!S?.enabledLocally||S.disabledRemotely)return;let v=!1;const C={codec:"CN",rate:48e3};if(forOneCodec(m,C,(()=>{v=!0})),v)return;const _=findAvailablePayload(g);-1!==_&&(changePayloadType(g,Ke.PAYLOAD_TYPE.MSRTC_CNFB,_),C.payload=Ke.PAYLOAD_TYPE.MSRTC_CNFB,addCodec(m,C))}},jf=class{modify(g){removeCodec(g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),{codec:"g722",rate:8e3,encoding:2})}},qf=class{constructor(g){this.configProvider=g}modify(g){const m=this.configProvider.config.enforceOpusFmtp;if(m){forOneCodec(g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),{codec:"opus",rate:48e3,encoding:2},(g=>{g.fmtp||(g.fmtp={payload:g.rtp.payload});const S=new Zm(g.fmtp.config);Object.keys(m).forEach((g=>{S.removeIfPresent(g),S.setIfMissing(g,`${m[g]}`)})),g.fmtp.config=S.toString()}))}}},Wf=class{modify(g){const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio));if(m&&isMediaDisabled(m)){const S=g.media.find((g=>!!g.iceUfrag));S&&(m.port=9,m.direction="inactive",m.iceUfrag=S.iceUfrag,m.icePwd=S.icePwd,m.rtcpMux="rtcp-mux",S.crypto&&(m.crypto=S.crypto),S.fingerprint&&(m.fingerprint=S.fingerprint,m.setup=S.setup),m.rtp=[{payload:0,codec:"PCMU",rate:8e3}],m.payloads="0")}}},zf=class{constructor(g){this.otherPartyCodecs=g}modify(g){const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),S=["cn","telephone-event"],v=m.rtp.filter((g=>-1!==this.otherPartyCodecs.indexOf(g.codec.toLowerCase())&&-1===S.indexOf(g.codec.toLowerCase())));if(0===v.length)throw new Error("there is no matching primary audio codec");m.rtp.filter((g=>g!==v[0]&&-1===S.indexOf(g.codec.toLowerCase()))).forEach((g=>{removeCodec(m,g)}))}},Kf=class{constructor(g,m){this.configProvider=g,this.logger=m}modify(g){this.configProvider.config.webrtcInjectTransportCCAudio&&getEnabledMedia(g,Ke.MEDIA_TYPE.audio).forEach((g=>{const m=g.ext?.find((g=>g.uri===Ke.TRANSPORT_CC.EXT_URI));if(!m)return void this.logger.safe.info("transport-cc ext not present in sdp, skipping injecting transport-cc attribute for audio");const S=g.rtp?.find((g=>"opus"===g.codec.toLowerCase()));if(!S)return void this.logger.safe.info("opus codec not found, skipping injecting transport-cc attribute for audio");const v=S.payload,C=g.rtcpFb?.find((g=>g.type===Ke.TRANSPORT_CC.ATTRIBUTE&&g.payload===v));C?this.logger.safe.info("opus codec already has transport-cc attribute"):(g.rtcpFb=g.rtcpFb||[],g.rtcpFb.push({payload:v,type:Ke.TRANSPORT_CC.ATTRIBUTE}),this.logger.safe.info("injected transport-cc attribute"))}))}},Jf=class{constructor(g,m){this.mediaManager=g,this.configProvider=m}modify(g){g.media.forEach(((g,m)=>{if(isMediaDisabled(g)||g.type!==Ke.MEDIA_TYPE.video)return;const S=this.mediaManager.getMediaEntities()[m];forOneCodec(g,{codec:"h264",rate:9e4},(g=>{const m=S.getLocalRecvCapabilities();if(!m)return;g.fmtp||(g.fmtp={payload:g.rtp.payload});const v=new Zm(g.fmtp.config);this.configProvider.config.h264SdpProfile?(v.removeIfPresent("profile-level-id"),v.setIfMissing("profile-level-id",this.configProvider.config.h264SdpProfile)):v.setIfMissing("profile-level-id","42C02A"),v.setIfMissing("max-fs",m.getMaxFS().toString()),v.setIfMissing("max-mbps",m.getMaxMBPS().toString()),v.setIfMissing("max-fps",m.getMaxFPS().toString()),g.fmtp.config=v.toString()}))}))}},Yf=class{constructor(g){this.configProvider=g}modify(g){if(!this.configProvider.config.multiStreamSupported||this.configProvider.config.numVideoChannelsGvc<=10)return;let m=0;for(let S=0;S<g.media.length;S++)if("video"===g.media[S].type){if(g.media[S].xMultiStream)break;m++}const S=g.media.findIndex((g=>g.xMultiStream)),v=g.media[S];if(!v)return;const C=v.xMultiStream.startSsrc,_=v.xMultiStream.ssrcGroupRange,E=v.xMultiStream.ssrcRange;delete v.xMultiStream;const T=this.configProvider.config.numVideoChannelsGvc-m-1,I=[];for(let m=0;m<T;m++){const T=(0,ef.cloneDeep)(v);T.mid=getNextAvailableMid(g),T.xSourceStreamId=v.xSourceStreamId,T.subStreamIndex=m,I.push(T.mid);const b=C+m*E;T.ssrcGroups=[{ssrcs:`${b} ${b+_}`,semantics:"FID"}],T.xSsrcRange={ssrcMin:b,ssrcMax:b+E-1},g.media.splice(S+m,0,T)}const b=C+T*E;v.ssrcGroups=[{ssrcs:`${b} ${b+_}`,semantics:"FID"}],v.xSsrcRange={ssrcMin:b,ssrcMax:b+E-1};const A=g.groups.find((g=>g.mids.includes(v.mid)));A.mids=`${A.mids} ${I.join(" ")}`}},Qf=class{constructor(g,m,S){this.mediaManager=g,this.configProvider=m,this.type=S}modify(g){if(!this.configProvider.config.multiStreamSupported||"offer"!==this.type||this.configProvider.config.numVideoChannelsGvc<=10)return;const m=9;let S,v;if(this.mediaManager.getMediaEntitiesByModality(Ke.MODALITY.video).forEach(((g,C)=>{C===m-1&&(v=g.getMid()),S=g.getMid()})),!S||!v)return;const C=g.media.find((g=>g.mid===S));g.media=g.media.filter((g=>parseFloat(g.mid)<=parseFloat(v)||parseFloat(g.mid)>=parseFloat(S)));const _=this.configProvider.config.numVideoChannelsGvc-m;C.xMultiStream={numberOfStreams:_,startSsrc:1,ssrcRange:1,ssrcGroupRange:1}}},Xf=class{constructor(g){this.configProvider=g}modify(g){getEnabledMedia(g,Ke.MEDIA_TYPE.video).forEach((g=>{forOneCodec(g,{codec:"h264",rate:9e4},(g=>{if(g.fmtp){const m=new Zm,S=new Zm(g.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((g=>{if(S.contains(g)){let v=S.get(g);"profile-level-id"===g&&(v=this.configProvider.config.h264SendProfileOverride||v),m.setIfMissing(g,v)}})),g.fmtp.config=m.toString()}}))}))}},Zf=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&getEnabledMedia(g,Ke.MEDIA_TYPE.video).forEach((g=>{forAllCodecs(g,{codec:"h264",rate:9e4},(g=>{if(g.fmtp){const m=new Zm(g.fmtp.config);m.setIfMissing("sps-pps-idr-in-keyframe","1"),g.fmtp.config=m.toString()}}))}))}},eS=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&getEnabledMedia(g,Ke.MEDIA_TYPE.video).forEach((g=>{forAllCodecs(g,{codec:"h264",rate:9e4},(g=>{if(g.fmtp){const m=new Zm(g.fmtp.config);m.removeIfPresent("sps-pps-idr-in-keyframe"),g.fmtp.config=m.toString()}}))}))}},tS=class{constructor(g){this.configProvider=g}modify(g){const m=(g.groups||[]).findIndex((g=>"BUNDLE"===g.type)),S=g.groups?g.groups[m]:void 0;S&&(this.configProvider.mediaConfig.isTransportUnbundled?(S.mids=this.createBundleFromMedia(getEnabledMedia(g,Ke.MEDIA_TYPE.video)),S.mids||g.groups.splice(m,1)):S.mids=this.createBundleFromMedia(getEnabledMedia(g)))}createBundleFromMedia(g){return g.map((g=>g.mid?.toString())).filter((g=>g)).join(" ")}},iS=class{modify(g){g.media.forEach((g=>{isMediaDisabled(g)&&g.bundleOnly&&(g.port=9,delete g.invalid)}))}},nS=class{constructor(g,m){this.configProvider=g,this.mediaManager=m}modify(g){if(!this.configProvider.mediaConfig.isTransportUnbundled&&!g.groups?.find((g=>"BUNDLE"===g.type))){let m=!1;if(g.media.forEach(((g,S)=>{const v=this.mediaManager.getMediaEntities()[S];!m&&v.isEnabled()?(g.mid=v.getMid(),m=!0):(v.disable(),g.port=0)})),m){g.groups||(g.groups=[]);const m={type:"BUNDLE"};g.groups.push(m)}}}},rS=class{constructor(g,m){this.configProvider=g,this.logger=m}modify(g){g.media.forEach((g=>{const m=!!g.candidates;if(g.candidates&&(g.candidates=g.candidates.filter((g=>{let m=!0,S=!0,v=!0;return this.configProvider.config.iceCandidateType&&(m=!!g.type.match(new RegExp(this.configProvider.config.iceCandidateType,"i"))),this.configProvider.config.iceCandidateTransport&&(S=!!g.transport.match(new RegExp(this.configProvider.config.iceCandidateTransport,"i"))),this.configProvider.config.iceCandidateFilterMDns&&(v=!this.isMdns(g.ip),v||this.logger.safe.info(`Filtering out mDNS candidate ${scrubMriOrOmit(g.ip)}:${scrubMriOrOmit(g.port)}`)),m&&S&&v}))),m&&g.connection&&this.configProvider.config.iceCandidateFilterMDns&&(g.candidates&&0!==g.candidates.length||(g.candidates=[getDummyCandidate(g.port)]),this.isMdns(g.connection.ip)||!this.hasMatchingCandidate(g))){const m=this.getDefaultCandidate(g);g.connection.ip=m.ip,g.port=m.port}}))}hasMatchingCandidate(g){const m=g.connection;return m&&!!g.candidates.find(this.createIpAndPortMatcher(m.ip,g.port))}getDefaultCandidate(g){return g.candidates.slice().sort(((g,m)=>g.type===m.type?0:"host"===g.type||"relay"===m.type?1:"relay"===g.type||"host"===m.type?-1:0))[0]}isMdns(g){return g.indexOf(".local")>-1||g.indexOf(".encrypted")>-1}createIpAndPortMatcher(g,m){return S=>S.ip===g&&S.port===m}},sS=class{modify(g){const m=getEnabledMedia(g)[0];m&&(m.candidates=[getDummyCandidate()])}},aS=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{this.fromMsSdp(g,m)}))}fromMsSdp(g,m){if(isMediaDisabled(g)||g.rids&&g.simulcast)return;const S=this.mediaManager.getMediaEntities()[m],v=S?.getSimulcastContext();v?.shouldBeEnabledInRemoteDesc()&&(v.enableInRemoteDesc(),g.simulcast={dir1:"recv",list1:v.ridList.map((g=>`${v.activeRids.includes(g)?"":"~"}${g}`)).join(";")},g.rids=v.ridList.map((g=>({id:g,direction:"recv"}))))}},oS=class{constructor(g,m){this.mediaManager=g,this.logger=m}modify(g){g.media.forEach(((g,m)=>{this.toMsSdp(g,m)}))}toMsSdp(g,m){const S=this.mediaManager.getMediaEntities()[m],v=S?.getSimulcastContext();v&&(v.localDescriptionIsApplied(),v.shouldBeEnabledInLocalDesc()&&(v.enableInLocalDesc(),this.removeSimulcastEnvelope(g),this.addStreamSsrc(g,S.getLocalSsrc())))}removeSimulcastEnvelope(g){g.rids&&delete g.rids,g.simulcast&&delete g.simulcast}addStreamSsrc(g,m){if(!m)return;if(g.ssrcs)return void this.logger.safe.debug(`Media mid: ${g.mid} already contains ssrc: ${JSON.stringify(g.ssrcs)}`);const S=m;this.setSsrc(g,S)}setSsrc(g,m){g.ssrcs=[{id:m,attribute:"fake_attribute",value:"fake_value"}]}},lS=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{const S=this.mediaManager.getMediaEntities()[m],v=S?.getLocalTrackId();(!g.msid&&S?.getSimulcastContext()?.shouldUseSimulcast()&&v||S?.getExtension("reinviteless"))&&(g.msid=`- ${v??"-"}`)}))}},cS=class{constructor(g,m){this.mediaManager=g,this.configProvider=m}modify(g){const m=this.mediaManager.getMediaEntities(),S=(0,ef.flatMap)(m,(g=>g.getRtpHeaderExtensions())),v=S.find((g=>"vla"===g?.headerType))?.value,C=S.find((g=>"non-adv-vla"===g?.headerType))?.value,_=v??C??(0,ef.flatMap)(g.media,(g=>g.ext||[])).find((g=>g.uri===Ke.VLA.EXT_URI))?.value,E=getFreeValueForExt(g,this.configProvider.config.extmapAllowMixed,Ke.VLA.DEFAULT_VALUE);g.media.forEach(((g,S)=>{const v=getModalityForMedia(g);if(!(this.configProvider.config.enableVla&&("Video"===v||"ScreenShare"===v)))return;if(g.ext?.find((g=>g.uri===Ke.VLA.EXT_URI)))return;const C=m[S]?.getRtpHeaderExtensions(),T=C?C.find((g=>"vla"===g.headerType))?.value??C.find((g=>"non-adv-vla"===g.headerType))?.value:_??E;T&&(g.ext=g.ext||[],g.ext.push({value:T,uri:Ke.VLA.EXT_URI}))}))}},dS=class{constructor(g){this.configProvider=g}modify(g){g.media.forEach((g=>{const m=getModalityForMedia(g);if(this.configProvider.config.allowRemoteVla&&("Video"===m||"ScreenShare"===m))return;const S=g.ext?.findIndex((g=>g.uri===Ke.VLA.EXT_URI));S>-1&&g.ext.splice(S,1)}))}},hS=class{constructor(g){this.configProvider=g}modify(g,m,S){g.media.forEach((g=>{const v=getModalityForMedia(g);if(!(this.configProvider.config.enableNonAdvVla&&("Video"===v||"ScreenShare"===v))||g.ext?.find((g=>g.uri===S)))return;const C=g.ext?.find((g=>g.uri===m));C&&(C.uri=S)}))}},uS=class extends hS{constructor(g,m){super(g),this.mediaManager=m}modify(g){const m=this.mediaManager.getMediaEntities();(0,ef.flatMap)(m,(g=>g.getRtpHeaderExtensions())).some((g=>"vla"===g?.headerType))||super.modify(g,Ke.VLA.EXT_URI,Ke.VLA.EXT_URI_NON_ADV)}},gS=class extends hS{constructor(g){super(g)}modify(g){super.modify(g,Ke.VLA.EXT_URI_NON_ADV,Ke.VLA.EXT_URI)}},pS=class{modify(g){g.media.forEach((g=>{g.ext?.forEach((g=>g.uri=this.normalizeSlashesInUri(g.uri)))}))}normalizeSlashesInUri(g){return g.replace(/\\/g,"/")}},mS=class{constructor(g){this.configProvider=g}modify(g){if(this.configProvider.config.fixSdpForPartialIceRestart){const[{iceUfrag:m,icePwd:S}={}]=g.media;void 0!==m&&void 0!==S&&g.media.forEach((g=>{g.iceUfrag=m,g.icePwd=S}))}}},fS=class{constructor(g){this.configProvider=g}modify(g){if(this.configProvider.config.reduceRtcpFbInSdp?.length)for(const m of getEnabledMedia(g,Ke.MEDIA_TYPE.video))m.rtcpFb=m.rtcpFb&&this.getFbList(m.rtcpFb)}getFbList(g){const m=[],S=[];for(const v of g){const g=v.subtype?`${v.type}/${v.subtype}`:`${v.type}`;m.includes(g)||(this.configProvider.config.reduceRtcpFbInSdp.includes(g)?(m.push(g),S.push({...v,payload:"*"})):S.push(v))}return S}},SS=class{constructor(g){this.configProvider=g}modify(g){if(!this.configProvider.config.redReceiveEnabled)return;const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio));let S=0;forOneCodec(m,{codec:"opus",rate:48e3,encoding:2},(g=>{S=g.rtp.payload}));const v={codec:"RED",rate:8e3};forOneCodec(m,v,(g=>{g.rtp.rate=48e3,g.rtp.encoding=2,S&&(g.fmtp={payload:g.rtp.payload,config:`${S}/${S}`})})),removeCodec(m,v)}},vS=class{constructor(g){this.configProvider=g}modify(g){if(!this.configProvider.config.redReceiveEnabled)return;forOneCodec(g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),{codec:"red",rate:48e3,encoding:2},(g=>{g.rtp.codec="RED",g.rtp.rate=8e3,delete g.rtp.encoding}))}},CS=class{constructor(g,m){this.configProvider=g,this.sdpType=m}modify(g){if(!this.configProvider.config.redReceiveEnabled||"offer"!==this.sdpType)return;const m=g.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),S={codec:"red",rate:48e3,encoding:2};let v=0;if(forOneCodec(m,S,(g=>{v=g.rtp.payload})),v===Ke.PAYLOAD_TYPE.MSRTC_RED)return;const C=findAvailablePayload(g);-1!==C&&(changePayloadType(g,Ke.PAYLOAD_TYPE.MSRTC_RED,C),forOneCodec(m,S,(g=>{g.rtp.payload=Ke.PAYLOAD_TYPE.MSRTC_RED})))}};function disabledMedia(g,m,S,v){const C={type:g,port:0,label:m,payloads:g===Ke.MEDIA_TYPE.dataChannel||g===Ke.MEDIA_TYPE.data?Ke.PAYLOAD_TYPE.DATA_CHANNEL:"36",protocol:S,connection:{ip:"10.10.10.10",version:4}};return v&&(C.mid=v),C}function getEnabledMedia(g,m=null){return g.media.filter((g=>!(isMediaDisabled(g)||m&&g.type!==m)))}function getDummyCandidate(g=1234){return{component:1,ip:"10.10.10.10",foundation:1755259772,priority:2122197247,port:g!==9?g:1234,transport:"UDP",type:"host"}}function getFreeValueForExt(g,m,S,v=!1){const C=(0,ef.flatMap)(g.media,(g=>g.ext||[])).map((g=>g.value));if(0===C.length)return S;const _=2,E=14;if(v&&!C.includes(S))return S;let T;for(let g=_;g<=E;g++)if(!C.includes(g)){T=g;break}return!T&&m&&(T=Math.max(...C)+1),T}function getCustomCodecParams(g,m){if(!Ke.AUDIO_DECODER[g]?.[m])throw`unsupported codec ${g} or type ${m}`;const S=Ke.AUDIO_DECODER[g][m];return{codec:S.NAME,rate:S.RATE,encoding:S.ENCODING,payload:Ke.AUDIO_DECODER[g].PT}}function changePayloadType(g,m,S){for(const v of g.media)updatePayload(v,m,S)}var _S=class _SessionDescription{constructor(g,m,S,v){this.context=g,this.sessionType=m,this.sdp=S,this.remote=v,this.mediaManager=this.context.mediaManager,this.sdpTransform=this.context.sdpTransform,this.logger=this.context.logger.createChild("SessionDescr"),this.sdpModel=Qm.parse(this.sdp),"answer"===m&&v&&new Yf(this.context.configProvider).modify(this.sdpModel),this.sdpModel.media.forEach((g=>{(0,Ym.isUndefined)(g.mid)||(g.mid=g.mid.toString())})),this.remote&&!this.context.configProvider.config.disableMsSdp&&new uf(g,this.mediaManager,m).modify(this.sdpModel)}clone(){return new _SessionDescription(this.context,this.sessionType,this.sdp,this.remote)}getModalities(){return this.modalities||getModalities(this.sdpModel)}updateModalities(g){this.modalities=g}getSrtpInfo(){return getSrtpInfo(this.sdpModel)}getVideoCodecs(){const g={};return this.sdpModel.media.forEach((m=>{"video"===m.type&&m.rtp.map((g=>g.codec.toLowerCase())).forEach((m=>g[m]=!0))})),Object.keys(g)}usePrimaryAudioCodecOnly(g){new zf(g).modify(this.sdpModel)}isCodecSwitchSupported(){return!this.sdpModel.media.some((g=>g.type===Ke.MEDIA_TYPE.audio&&g.xMediaSettings&&this.containsMediaSetting(g.xMediaSettings,"codecswitchunsupported")))}toLocal(){return this.sdpModel=this.sdpTransform.toLocal(this.sdpModel,this.mediaManager,this.sessionType),Qm.write(this.sdpModel)}toOffer(){return this.toOfferAnswer()}toAnswer(){return this.toOfferAnswer()}toOfferAnswer(){const g="offer"===this.sessionType;return new rS(this.context.configProvider,this.logger).modify(this.sdpModel),(new iS).modify(this.sdpModel),g&&this.mediaManager.isEmpty()&&this.mediaManager.fromOffer(this.sdpModel,this.modalities),this.mediaManager.syncModalities(this.sdpModel,this.modalities,!g),this.sdpModel=g?this.sdpTransform.toOffer(this.sdpModel,this.mediaManager,this.modalities):this.sdpTransform.toAnswer(this.sdpModel,this.mediaManager,this.modalities),this.context.configProvider.config.disableMsSdp||new hf(this.context,this.mediaManager,this.sessionType).modify(this.sdpModel),new Jf(this.mediaManager,this.context.configProvider).modify(this.sdpModel),this.modalities=getModalities(this.sdpModel),Qm.write(this.sdpModel)}toRemote(g){return this.modalities=g,this.mediaManager.fromRemote(this.sdpModel,this.modalities),this.sdpModel=this.sdpTransform.toRemote(this.sdpModel,this.mediaManager,this.modalities,this.sessionType),Qm.write(this.sdpModel)}getVideoRecvCapabilities(){return getRecvCapabilitiesForMedia(this.getMediaByLabel(Ke.MEDIA_LABEL.video))}getSharingRecvCapabilities(){return getRecvCapabilitiesForMedia(this.getMediaByLabel(Ke.MEDIA_LABEL.sharing))}getMediaByType(g){return this.sdpModel.media.find((m=>m.type===g))}isUnbundled(){const g=this.sdpModel.groups?.find((g=>"BUNDLE"===g.type)),m=this.sdpModel.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),S=this.sdpModel.media.find((g=>g.type===Ke.MEDIA_TYPE.video));return g?!g.mids.toString().split(" ").find((g=>g===m.mid)):!!S}couldBeUnbundled(){return!this.sdpModel.groups?.find((g=>"BUNDLE"===g.type))||this.hasUnbundledIceCandidates()}containsMediaSetting(g,m){return g.some((g=>-1!==g.settings.indexOf(m)))}getMediaByLabel(g){return this.sdpModel.media.find((m=>m.label===g))}hasIceCandidatesForMediaType(g,m=""){const S=this.sdpModel.media?this.sdpModel.media.filter((m=>m.type===g&&!!m.candidates&&0!==m.candidates.length)):[];return m?S.some((g=>!!g.candidates&&g.candidates.some((g=>g.type===m)))):!!S.length}hasIceCandidates(){return this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.audio)||this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.video)}hasRelayIceCandidates(){return this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.audio,"relay")||this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.video,"relay")}hasUnbundledIceCandidates(){const g=this.sdpModel.media.filter((g=>g.type===Ke.MEDIA_TYPE.video&&0!==g.port));return this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.audio)&&(!g.length||this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.video))}hasUnbundledRelayIceCandidates(){const g=this.sdpModel.media.filter((g=>g.type===Ke.MEDIA_TYPE.video&&0!==g.port));return this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.audio,"relay")&&(!g.length||this.hasIceCandidatesForMediaType(Ke.MEDIA_TYPE.video,"relay"))}isIceRestart(){return this.mediaManager.getMediaEntities().some((g=>g.getExtension("iceRestart")))}isMSRTC(){return!!this.sdpModel.xMediaBw}insertFakeCandidateIfNeeded(g,m){this.hasIceCandidates()||(g.setFakeIceCandidate(!0),m&&(m.fakeIceCandidate=!0),(new sS).modify(this.sdpModel))}getBweType(){const g=this.sdpModel.media.find((g=>0!==g.port&&g.type===Ke.MEDIA_TYPE.video));if(!g)return"Unknown";const m=g.ext?.find((g=>g.uri===Ke.TRANSPORT_CC.EXT_URI||g.uri===Ke.TRANSPORT_CC.MSSDP_ENCODED_URI));return m?"SSBWE":"REMB"}fixDataModality(){new Sf(this.mediaManager).modify(this.sdpModel)}getPayloadsForMedia(g){const m=this.sdpModel.media.find((m=>m.type===g&&0!==m.port));return m?.rtp??[]}},yS=class{constructor(g){this.context=g}createLocalOffer(g){return new _S(this.context,"offer",g)}createRemoteOffer(g){return new _S(this.context,"offer",g,!0)}createLocalAnswer(g){return new _S(this.context,"answer",g)}createRemoteAnswer(g){return new _S(this.context,"answer",g,!0)}},ES=class{static build(g){return new yS(g=g||{})}};function getSrtpReport(g){let m="";return g.dtls&&(m+="dtls"),g.sdes&&(m+="sdes"),m}var TS=class{constructor(){this.info={OfferedSrtp:"none",NegotiatedSrtp:"none",IceConnectionState:"none",IceConnectionStatePrevious:"none",SignalingState:"none",SignalingStatePrevious:"none",RelayCandidate:"none",IceTransportPolicy:"none",IceServers:"none",FakeIceCandidate:!1,BweType:"none",SdpSemantics:"none",BundlePolicy:"none",IPAddress:"none",ReflexiveLocalIP:"none",NumberOfInterfaces:0,EncodedStreamWorker:!1,AudioCodecEvents:"none"}}setCandidateDetails(g){"host"===g.type&&"udp"===g.protocol?this.setIPAddressInfo(g.ip):"srflx"===g.type&&this.setReflexiveLocalIP(g.ip)}setOfferedModalities(g){this.offeredModalities=g,this.activeModalities=g}setNegotiatedModalities(g){this.negotiatedModalities=g,this.activeModalities=g}setNegotiatedSrtpInfo(g){this.info.NegotiatedSrtp=getSrtpReport(g)}setOfferedSrtpInfo(g){this.info.OfferedSrtp=getSrtpReport(g)}setIceConnectionState(g){this.info.IceConnectionStatePrevious=this.info.IceConnectionState,this.info.IceConnectionState=g}setSignalingConnectionState(g){this.info.SignalingStatePrevious=this.info.SignalingState,this.info.SignalingState=g}setRelayCandidateInfo(g){this.info.RelayCandidate=JSON.stringify(g)}fillExtensionInfo(g){assign(g,this.info)}setIceTransportPolicy(g){this.info.IceTransportPolicy=g}setIceServers(g){const m=g.map((g=>{const m={...g};return m.username&&(m.username="true"),m.credential&&(m.credential="true"),m}));this.info.IceServers=JSON.stringify(m)}setFakeIceCandidate(g){this.info.FakeIceCandidate=g}setBweType(g){"Unknown"!==g&&(this.info.BweType=g)}setSdpSemantics(g){this.info.SdpSemantics=g}setBundlePolicy(g){this.info.BundlePolicy=g}setEncodedStreamWorkerLoaded(g){this.info.EncodedStreamWorker=g}setAudiocCodecEvents(g){this.info.AudioCodecEvents=JSON.stringify(g)}setCreateChannelFailReason(g){this.info.CreateChannelFailReason=stringifyObject(g)}setIPAddressInfo(g){this.info.NumberOfInterfaces+=1,"none"===this.info.IPAddress&&(this.info.IPAddress=g)}setReflexiveLocalIP(g){"none"===this.info.ReflexiveLocalIP&&(this.info.ReflexiveLocalIP=g)}},IS=class{constructor(g){this.audioContext=new Us.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(g),this.analyzerNode=this.createAnalyserNode(this.sourceNode)}dispose(){this.sourceNode.disconnect(),this.audioContext.close(),this.audioContext=null,this.sourceNode=null,this.analyzerNode=null}getInputLevel(){if(!this.analyzerNode)return 0;const g=new Uint8Array(this.analyzerNode.frequencyBinCount);return this.analyzerNode.getByteFrequencyData(g),Math.floor(65535*getAverage(g)/255)}createAnalyserNode(g){const m=this.audioContext.createAnalyser();return m.fftSize=1024,m.smoothingTimeConstant=.1,g.connect(m),m}},bS=class _TimerTracker{constructor(g){this.name=g,this.sharedState={mark:new Map,measure:[]}}mark(g,m){this.sharedState.mark.set(g,{name:g,ts:Je(),startTime:Date.now(),details:m})}measure(g,m){const S=this.sharedState.mark.get(m.start),v=this.sharedState.mark.get(m.end);if(S&&v){const C={...m,parentName:this.name===g?"":this.name};this.sharedState.measure.push({name:g,details:C,duration:round(v.ts-S.ts),startTime:S.startTime})}}markAndMeasure(g,m,S,v){!1===this.sharedState.mark.has(m)&&this.mark(m,S);const C=this.sharedState.mark.get(g),_=this.sharedState.mark.get(m);if(C&&_){const g={...v,parentName:this.name===m?"":this.name};this.sharedState.measure.push({name:m,details:g,duration:round(_.ts-C.ts),startTime:C.startTime})}}clone(g){const m=new _TimerTracker(`${this.name}|${g}`);return m.setSharedState(this.sharedState),m}setSharedState(g){this.sharedState=g}getReport(){return this.sharedState.measure.map((g=>({name:g.name,duration:g.duration,ts:g.startTime,parentName:g.details.parentName})))}},AS=class _NoopTracker{mark(){}measure(){}markAndMeasure(){}clone(){return new _NoopTracker}getReport(){return[]}},RS=class{constructor(g){this.enableTimerTracker=g,this.timerTrackers={},this.timerTrackerOptions={}}getTimerTracker(g,m){if(!this.enableTimerTracker)return new AS;const S=new bS(g);if(this.timerTrackers[g]){const m=this.timerTrackerOptions[g];if(m?.first)return new AS;m?.last&&(this.timerTrackers[g]=[S]),m?.all&&this.timerTrackers[g].push(S)}else this.timerTrackers[g]=[S],this.timerTrackerOptions[g]=m;return S}getReport(){if(this.enableTimerTracker)return Object.keys(this.timerTrackers).reduce(((g,m)=>{const S=this.timerTrackerOptions[m];return(S.first||S.last)&&(g[m]=[this.timerTrackers[m][0]?.getReport()]),S.all&&(g[m]=Object.values(this.timerTrackers[m]).map((g=>g?.getReport()))),g}),{})}},PS=class{constructor(){this.presentationAPIUserDuration=0,this.presentationAudioDuration=0,this.isActiveScreenSharing=!1}handleInputLevel(g,m){this.isActiveScreenSharing&&("ScreenShare"===g&&m>0&&(this.presentationAPIUserDuration+=Ke.TIME_INTERVAL.SEC_1),"Audio"===g&&m>0&&(this.presentationAudioDuration+=Ke.TIME_INTERVAL.SEC_1))}updateScreenSharingStream(g,m){"ScreenShare"===m&&(this.isActiveScreenSharing=!!g)}getPresentationAudioDuration(){return this.presentationAudioDuration}getPresentationAudioAPIUserDuration(){return this.presentationAPIUserDuration}},MS=/profile-level-id=(.{6})/,wS=class{constructor(g,m,S=(()=>{}),v=(()=>this),C=(()=>{}),_=new qm,E){this.configProvider=g,this.dmDiagnostics=m,this.addSessionStatsError=S,this.newNativeSession=v,this.commitNativeSession=C,this.dshDiagnostics=_,this.getSessionRef=E,this.data={startTime:Date.now(),duration:0,offeredSrtp:"unknown",negotiatedSrtp:"unknown",iceConnectionState:"none",iceConnectionStatePrevious:"none",signalingState:"none",signalingStatePrevious:"none",relayCandidate:"none",iceTransportPolicy:"none",iceServers:"none",fakeIceCandidate:!1,bweType:"Unknown",sdpSemantics:"none",bundlePolicy:"none",iceCandidateErrors:[],H264Profiles:[],numInterfaces:0,statsReports:[],aggregatedModalityStats:{},multiViewStats:[],networkInfo:[],statsErrors:[],statsOnSubscribed:{},recvVideoStreamCount:{min:0,max:0,mode:0},sentBWSeed:void 0,reportedReceiveBandwidth:[],encodedStreamWorker:!1,audioCodecEvents:"none",totalVideoRecvMblocksRates:{macroblockRateReceivedMax:0,macroblockRateReceivedAvg:0,macroblockRateDecodedMax:0,macroblockRateDecodedAvg:0,macroblockRateMaxDecoderLossPercent:0,macroblockRateDecoderLossPercent:0},timerTrackerReport:{},loopIntervalMax:-1,loopIntervalMedian:-1,fetchTimeMax:-1,fetchTimeMedian:-1,codecSupport:void 0,videoPerformanceEvent:[],ovcToSubscriptionEvents:[],presentationAPIUserDuration:0,presentationAudioDuration:0,earlyMediaNumStatsPolls:0},this.timerTracker=new RS(this.configProvider.config.enableTimerTracker),this.presentationAudioTelemetry=new PS,addGetterFields(this.data,{duration:()=>this.data.endTime?this.data.endTime-this.data.startTime:Date.now()-this.data.startTime,bandwidthReport:()=>this.bandwidthStatsRef?.getBandwidthReport(),timerTrackerReport:()=>this.timerTracker.getReport(),presentationAPIUserDuration:()=>this.presentationAudioTelemetry.getPresentationAudioAPIUserDuration(),presentationAudioDuration:()=>this.presentationAudioTelemetry.getPresentationAudioDuration()}),Object.defineProperty(this.data,"IPAddress",{enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(this.data,"reflexiveLocalIP",{enumerable:!1,writable:!0,configurable:!0})}getTimerTracker(g,m){return this.timerTracker.getTimerTracker(g,m)}get deviceManager(){return this.dmDiagnostics}get audioLevel(){return this.analyzer?.getInputLevel()}get reflexiveLocalIP(){return this.data.reflexiveLocalIP}set bandwidthDiagnostic(g){this.bandwidthStatsRef=g}get callIsMuted(){return this.getSessionRef?.().callIsMuted}get sharingAudioLevel(){return this.analyzerSharing?.getInputLevel()}set offeredModalities(g){this.data.offeredModalities=g,this.data.activeModalities=g}set negotiatedModalities(g){this.data.negotiatedModalities=g,this.data.activeModalities=g}set offeredSrtp(g){this.data.offeredSrtp=getSrtpReport2(g)}set negotiatedSrtp(g){this.data.negotiatedSrtp=getSrtpReport2(g)}set iceConnectionState(g){this.data.iceConnectionStatePrevious=this.data.iceConnectionState,this.data.iceConnectionState=g}set signalingConnectionState(g){this.data.signalingStatePrevious=this.data.signalingState,this.data.signalingState=g}set relayCandidateInfo(g){this.data.relayCandidate=JSON.stringify(g)}set iceTransportPolicy(g){this.data.iceTransportPolicy=g}set iceServers(g){const m=g.map((g=>{const m={...g};return m.username&&(m.username="true"),m.credential&&(m.credential="true"),m}));this.data.iceServers=JSON.stringify(m)}set fakeIceCandidate(g){this.data.fakeIceCandidate=g}set bweType(g){this.data.bweType=g}set sdpSemantics(g){this.data.sdpSemantics=g}set isCodecsSupported(g){this.data.codecSupport=g}set bundlePolicy(g){this.data.bundlePolicy=g}set latestRawReport(g){this.data.latestRawReport=g}set recvVideoStreamsCount(g){this.data.recvVideoStreamCount=g}set aggregatedStatsRef(g){this.data.aggregatedModalityStats=g}set multiViewStats(g){this.data.multiViewStats=g}set videoCapabilities(g){if(!g?.codecs)return;const m=[];g.codecs.forEach((g=>{if("h264"===g.mimeType&&g.sdpFmtpLine){const S=MS.exec(g.sdpFmtpLine)?.[1];S&&m.push(S)}})),this.data.H264Profiles=[...new Set(this.data.H264Profiles.concat(m))]}set sentBWSeed(g){this.data.sentBWSeed=g}set reportedSendBandwidth(g){this.data.reportedSendBandwidth=g,(!this.data.reportedSendBandwidthMin||this.data.reportedSendBandwidthMin>g)&&(this.data.reportedSendBandwidthMin=g),(!this.data.reportedSendBandwidthMax||this.data.reportedSendBandwidthMax<g)&&(this.data.reportedSendBandwidthMax=g)}set maxSessionBandwidth(g){this.data.maxSessionBandwidth=g}set bwStabiliationTime(g){this.data.bwStabilizationTime=g}set bwDownlinkStabiliationTime(g){this.data.bwDownlinkStabilizationTime=g}set statsOnSubscribed(g){this.data.statsOnSubscribed=g}set loopIntervalMax(g){this.data.loopIntervalMax=g}set loopIntervalMedian(g){this.data.loopIntervalMedian=g}set fetchTimeMax(g){this.data.fetchTimeMax=g}set fetchTimeMedian(g){this.data.fetchTimeMedian=g}setTotalVideoRecvMblocksRates(g){this.data.totalVideoRecvMblocksRates=g}setCandidateDetails(g){"host"===g.type&&"udp"===g.protocol?(this.data.numInterfaces++,this.data.IPAddress||(this.data.IPAddress=g.ip)):"srflx"!==g.type||this.data.reflexiveLocalIP||(this.data.reflexiveLocalIP=g.ip)}setAudioSendStream(g,m){if(this.configProvider.config.useAudioAnalyzer){const S=new IS(g.rawStream);"ScreenShare"===m&&g.hasAudio()?(this.analyzerSharing?.dispose(),this.analyzerSharing=S):"Audio"===m&&(this.analyzer?.dispose(),this.analyzer=S)}}addNetworkInfo(g){arrayLimitedPush(this.data.networkInfo,g,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addIceCandidateError(g){this.data.iceCandidateErrors.push(g)}clearIceCandidateErrors(){this.data.iceCandidateErrors=[]}registerEarlyMediaPoll(){this.data.earlyMediaNumStatsPolls++}addReportedReceiveBandwidth(g){arrayLimitedPush(this.data.reportedReceiveBandwidth,g,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addOvcSubscriptionReport(g,m,S){const v=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];v?.ovc.count!==g&&arrayLimitedPush(this.data.ovcToSubscriptionEvents,{ovc:{ts:Date.now(),count:g,subsCount:m,...S},subs:[]},this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addSubscriptionToOvcEvent(g){const m=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];m&&m.subs.push({ts:Date.now(),count:g})}addStatsReport(g){arrayLimitedPush(this.data.statsReports,g,this.configProvider.config.diagnostics.collectionLimits.numStatsReports)}addStatsError(g,m){const S=this.data.statsErrors.find((S=>S.error===m&&S.origin===g));S?S.count++:arrayLimitedPush(this.data.statsErrors,{origin:g,error:m,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors),this.addSessionStatsError(`nativeSession:${g}`,m)}setPresentationAudioOnScreenSharing(g,m){this.presentationAudioTelemetry.updateScreenSharingStream(g,m)}handlePresentationAudioInputLevel(){this.presentationAudioTelemetry.handleInputLevel("Audio",this.audioLevel),this.presentationAudioTelemetry.handleInputLevel("ScreenShare",this.sharingAudioLevel)}terminate(){this.data.endTime=Date.now(),this.analyzer?.dispose(),this.analyzer=null,this.analyzerSharing?.dispose(),this.analyzerSharing=null}newQualityManagerDiagnostics(){const g=new zm(this.configProvider,((g,m)=>this.addStatsError(`qualityManagerDiagnostics:${g}`,m)));return this.data.qualityManager=g.getObjectRef(),g}newRemoteVideoManagerDiagnostics(){const g=new Km(this.configProvider);return this.data.remoteVideoManager=g.getObjectRef(),g}newSubscriptionManagerDiagnostics(){const g=new Wm(this.configProvider,(g=>this.addStatsError("subscriptionManagerDiagnostics",g)));return this.data.subscriptionManager=g.getObjectRef(),g}set encodedStreamWorker(g){this.data.encodedStreamWorker=g}set audioCodecEvents(g){this.data.audioCodecEvents=g}getObjectRef(){return this.data}registerVideoPerformanceEvent(g,m){const S={type:m,perfEvent:g,resRequestEvent:null,resChangedEvent:[]};this.data.videoPerformanceEvent=this.data.videoPerformanceEvent.concat(S)}registerResolutionChanageRequest(g){const m=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];m&&(m.resRequestEvent=g)}registerResolutionChanageEvent(g){const m=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];g.ts-m?.resRequestEvent.ts<this.configProvider.config.diagnostics.performanceMonitoring.telemetryResolutionRequestSpanMs&&m.resChangedEvent.push(g)}};function getSrtpReport2(g){let m="";return g.dtls&&(m+="dtls"),g.sdes&&(m+="sdes"),m}var DS=Symbol("sessionDiagnosticsRef"),OS=class{constructor(g,m,S,v,C,_){this.logger=g,this.configProvider=m,this.diagnosticsReport=S,this.dmDiagnostics=v,this.dshDiagnostics=new qm,this.data={creationTime:Date.now(),callNumber:0,sessionId:"unknown",isMultiParty:!1,dtmfSuccessCount:0,dtmfFailureCount:0,iceInitTime:0,iceConnectedStateTime:0,negotiationCount:0,rejectedNegotiationCount:0,initialNegotiationCompleted:!1,finalAnswerTime:0,transportReconnectedCount:0,rollbackNegotiation:[],activeModalities:{},allowedAudioSend:!0,allowedVideoSend:!0,allowedScreensharingSend:!0,noIceCandidatesEventCount:{good:0,bad:0},noRelayIceCandidatesEventCount:{good:0,bad:0},microphoneInUseEventCount:{good:0,bad:0},cameraInUseEventCount:{good:0,bad:0},cameraFreezeEventCount:{start:0,end:0},rawMedia:{audio:{recv:{numAttempts:0,durationRatio:0},send:{numAttempts:0,durationRatio:0}}},ufds:[],statsErrors:[],webrtcSessions:[],isOngoing:!1,duration:0,callMutedRatio:0,callOsMuted:0,callHwSilent:0,callSwMuted:0,callIsMuted:!1,callSpeakerMuted:0,callIsSpeaking:0,networkRecvUFD:void 0,networkSendUFD:void 0,deviceManager:void 0,relayTimers:void 0,dominantSpeaker:this.dshDiagnostics.getObjectRef(),[DS]:this},this.transportDisconnected=!1,this.commonMuteTracker=new kS,this.swMuteTracker=new kS,this.osMuteTracker=new kS,this.speakerMuteTracker=new kS,this.hwSilentTracker=new kS,this.isSpeakingTracker=new kS,this.networkRecv=new LS,this.networkSend=new LS,this.rawMediaTimers={audio:{send:new kS,recv:new kS}},this.dmFragmenter=new NS(this.dmDiagnostics),this.durationTimer=new kS,this.data.callNumber=C,this.data.sessionId=_,this.durationTimer.start(),addGetterFields(this.data,{isOngoing:()=>void 0===this.data.terminationTime,duration:()=>this.durationTimer.elapsed,callMutedRatio:()=>getDurationRatio(this.commonMuteTracker.elapsed,this.data.duration),callOsMuted:()=>this.osMuteTracker.elapsed,callHwSilent:()=>this.hwSilentTracker.elapsed,callSwMuted:()=>this.swMuteTracker.elapsed,callIsMuted:()=>this.swMuteTracker.isRunning,callSpeakerMuted:()=>this.speakerMuteTracker.elapsed,callIsSpeaking:()=>this.isSpeakingTracker.elapsed,networkRecvUFD:()=>({good:this.networkRecv.getCount("Good"),poor:this.networkRecv.getCount("Poor"),bad:this.networkRecv.getCount("Bad"),goodRatio:getDurationRatio(this.networkRecv.getElapsed("Good"),this.data.duration),poorRatio:getDurationRatio(this.networkRecv.getElapsed("Poor"),this.data.duration),badRatio:getDurationRatio(this.networkRecv.getElapsed("Bad"),this.data.duration)}),networkSendUFD:()=>({good:this.networkSend.getCount("Good"),poor:this.networkSend.getCount("Poor"),bad:this.networkSend.getCount("Bad"),goodRatio:getDurationRatio(this.networkSend.getElapsed("Good"),this.data.duration),poorRatio:getDurationRatio(this.networkSend.getElapsed("Poor"),this.data.duration),badRatio:getDurationRatio(this.networkSend.getElapsed("Bad"),this.data.duration)}),deviceManager:()=>this.dmFragmenter.getFragment(this.dmDiagnostics),relayTimers:()=>this.relayManagerTimers?.getStats()}),addGetterFields(this.data.rawMedia.audio.recv,{durationRatio:()=>getDurationRatio(this.rawMediaTimers.audio.recv.elapsed,this.data.duration)}),addGetterFields(this.data.rawMedia.audio.send,{durationRatio:()=>getDurationRatio(this.rawMediaTimers.audio.send.elapsed,this.data.duration)})}get telemetryReport(){const g={type:"WebRtcMediaStats",data:this.diagnosticsReport.getSessionTelemetry(this.data.sessionId)},m={};return forOwnRec(g.data,((g,S,v)=>{let C=0;Bs.test(g)?(C=13,m[S]="IPv4"):Hs.test(g)&&(C=4,m[S]="IPv6"),v[S]={type:C,value:g,__VALUE__:!0}})),g.data.metrics.piiFields={type:0,value:JSON.stringify(m),__VALUE__:!0},g}get mediaStatsReport(){return this.diagnosticsReport.getMediaSessionStats(this.data.sessionId)}get realtimeTelemetryReport(){return this.diagnosticsReport.getTeamsRealtimeTelemetry(this.data.sessionId)}get e2eDiagnostics(){return this.diagnosticsReport.getDiagnosticsForE2eTests(this.data.sessionId)}set relayManager(g){this.relayManagerTimers=g}set isMultiParty(g){this.data.isMultiParty=g}set mediaLegId(g){this.data.mediaLegId=g.process()}set ETag(g){this.data.ETag=g}set configIds(g){this.data.configIds=g}set reconnect(g){this.data.reconnect=g}set relay(g){this.data.relay={address:g.addresses.join(),expires:g.expires,realm:g.realm,credentials:!(!g.username||!g.password),ports:[g.udpPort?`udp:${g.udpPort}`:"",g.tcpPort?`tcp:${g.tcpPort}`:"",g.tlsPort?`tls:${g.tlsPort}`:""].join(","),fqdns:g.fqdns?g.fqdns.join():"none"}}set sessionError(g){this.data.error=g}set dtmfResult(g){g?this.data.dtmfSuccessCount++:this.data.dtmfFailureCount++}set swMute(g){g?this.swMuteTracker.start():this.swMuteTracker.stop(),this.updateCommonMute()}set speakerMute(g){g?this.speakerMuteTracker.start():this.speakerMuteTracker.stop()}set hwSilent(g){g?this.hwSilentTracker.start():this.hwSilentTracker.stop()}set isSpeaking(g){g?this.isSpeakingTracker.start():this.isSpeakingTracker.stop()}set iceInitTime(g){this.data.iceInitTime||(this.data.iceInitTime=g)}set finalAnswerTime(g){var m;(m=this.data).finalAnswerTime??(m.finalAnswerTime=g)}set iceConnectedStateTimestamp(g){this.data.iceConnectedStateTime||(this.data.iceConnectedStateTime=g)}set allowedModalities(g){this.data.allowedAudioSend=g.audio.some((g=>hasSendDirectionality(g))),this.data.allowedVideoSend=g.video.some((g=>hasSendDirectionality(g))),this.data.allowedScreensharingSend=g.sharing.some((g=>hasSendDirectionality(g)))}negotiationStart(g){var m;(m=this.data).initialNegotiationType??(m.initialNegotiationType=g),this.data.negotiationCount++}negotiationCompleted(g){this.data.initialNegotiationCompleted=!0,this.data.activeModalities=g,this.data.error=void 0}negotiationRejected(){this.data.rejectedNegotiationCount++}registerRollbackEvent(g){this.data.rollbackNegotiation.push({type:g.type,attempt:this.data.rollbackNegotiation.length+1,error:g.error})}registerRawMediaAccess(g,m,S){const v=this.data.rawMedia[g]?.[m];if(v){v.numAttempts++;const C=this.rawMediaTimers[g]?.[m];S?C?.start():C?.stop()}}registerQualityStateChangedEvent(g){switch(g.type){case"NoNetwork":"Good"===g.value?this.data.noIceCandidatesEventCount.good++:this.data.noIceCandidatesEventCount.bad++;break;case"NetworkRelaysNotReachable":"Good"===g.value?this.data.noRelayIceCandidatesEventCount.good++:this.data.noRelayIceCandidatesEventCount.bad++;break;case"DeviceCaptureNotFunctioning":"Good"===g.value?this.data.microphoneInUseEventCount.good++:this.data.microphoneInUseEventCount.bad++;break;case"VideoCapturerDeviceStartFailed":"Good"===g.value?this.data.cameraInUseEventCount.good++:this.data.cameraInUseEventCount.bad++;break;case"DeviceCaptureMute":"Bad"===g.value?this.osMuteTracker.start():this.osMuteTracker.stop(),this.updateCommonMute();break;case"NetworkRecvQuality":this.networkRecv.updateLevel(g.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(g.value);break;case"VideoCaptureDeviceFreeze":"Good"===g.value?this.data.cameraFreezeEventCount.end++:this.data.cameraFreezeEventCount.start++}"DeviceSpeakWhileMuted"!==g.type&&arrayLimitedPush(this.data.ufds,{...g,timestamp:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numUFDs)}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.data.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}terminated(g){this.data.terminationReason=deepClone(g),this.data.terminationTime=Date.now(),this.durationTimer.stop(),this.swMuteTracker.stop(),this.speakerMuteTracker.stop(),this.hwSilentTracker.stop(),this.isSpeakingTracker.stop(),this.dmFragmenter.terminated(this.dmDiagnostics)}addStatsError(g,m){const S=this.data.statsErrors.find((S=>S.error===m&&S.origin===g));this.logger.safe.error(`Stats error from '${g}': ${m} (${S?.count??1})`),S?S.count++:arrayLimitedPush(this.data.statsErrors,{origin:g,error:m,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors)}newNativeSessionDiag(g=!0){let m;return m=new wS(this.configProvider,this.dmDiagnostics,((g,m)=>this.addStatsError(g,m)),(g=>this.newNativeSessionDiag(g)),(()=>this.pushNativeSessionDiag(m.getObjectRef())),this.dshDiagnostics.resetState(),(()=>this.getObjectRef())),g&&arrayLimitedPush(this.data.webrtcSessions,m.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numNativeSessions),m}pushNativeSessionDiag(g){arrayLimitedPush(this.data.webrtcSessions,g,this.configProvider.config.diagnostics.collectionLimits.numNativeSessions)}getObjectRef(){return this.data}updateCommonMute(){this.swMuteTracker.isRunning||this.osMuteTracker.isRunning?this.commonMuteTracker.start():this.swMuteTracker.isRunning||this.osMuteTracker.isRunning||this.commonMuteTracker.stop()}},NS=class{constructor(g){this.fragmentBase=this.sanitizeDiagnostics(g)}getFragment(g){const m=this.fragmentTerminated??g;return{devicesChangeCount:m.devicesChangeCount-this.fragmentBase.devicesChangeCount,deviceSelectionChangeCount:m.deviceSelectionChangeCount-this.fragmentBase.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:m.deviceSelectionChangeCountFromInterface-this.fragmentBase.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:m.devicesPollChangeCount-this.fragmentBase.devicesPollChangeCount}}terminated(g){this.fragmentTerminated=this.sanitizeDiagnostics(g)}sanitizeDiagnostics(g){return{devicesChangeCount:g.devicesChangeCount,deviceSelectionChangeCount:g.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:g.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:g.devicesPollChangeCount}}},kS=class{constructor(){this.startTime=0,this.elapsedInternal=0,this.countInternal=0}get isRunning(){return!!this.startTime}get elapsed(){return Math.round(this.startTime?this.elapsedInternal+Je()-this.startTime:this.elapsedInternal)}get count(){return this.countInternal}start(){this.startTime||(this.startTime=Je(),this.countInternal++)}stop(){this.startTime&&(this.elapsedInternal+=Je()-this.startTime,this.startTime=0)}},LS=class{constructor(){this.currentLevel="Good",this.stopWatches={},this.getStopWatch(this.currentLevel).start()}updateLevel(g){this.currentLevel!==g&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=g,this.getStopWatch(this.currentLevel).start())}getCount(g){const m=this.stopWatches[g];return m?m.count:0}getElapsed(g){const m=this.stopWatches[g];return m?m.elapsed:0}getStopWatch(g){let m=this.stopWatches[g];return m||(m=new kS,this.stopWatches[g]=m),m}};function getDurationRatio(g,m){return g/(0!==m?m:1)}function compileAudioReport(g,m,S){return removeUndefinedFields({recv:removeUndefinedFields({id:m?.inboundRTP.id,ssrc:m?.inboundRTP.ssrc,mediaType:m?.inboundRTP.mediaType??m?.inboundRTP.kind,bytesReceived:sampleseries(g.audio?.recv,(g=>g.inboundRTP.bytesReceived)),packetsReceived:sampleseries(g.audio?.recv,(g=>g.inboundRTP.packetsReceived)),packetsLost:sampleseries(g.audio?.recv,(g=>g.inboundRTP.packetsLost)),googCodecName:m?.codec?.mimeType.split("/")[1],googTrackId:m?.track?.trackIdentifier,transport_id:m?.transport?.id,transportId:m?.inboundRTP.transportId,transport_selectedCandidatePairId:m?.transport?.selectedCandidatePairId,transport_dtlsCipher:m?.transport?.dtlsCipher,transport_srtpCipher:m?.transport?.srtpCipher,pair_id:m?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:m?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:m?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:m?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:m?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(g.audio?.recv,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:m?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:m?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:m?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:m?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:m?.transport?.selectedCandidatePair?.localCandidate?.ip??m?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:m?.transport?.selectedCandidatePair?.remoteCandidate?.ip??m?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:m?.transport?.selectedCandidatePair?.nominated}),send:removeUndefinedFields({id:S?.outboundRTP.id,ssrc:S?.outboundRTP.ssrc,mediaType:S?.outboundRTP.mediaType??S?.outboundRTP.kind,bytesSent:sampleseries(g.audio?.send,(g=>g.outboundRTP.bytesSent)),packetsSent:sampleseries(g.audio?.send,(g=>g.outboundRTP.packetsSent)),packetsLost:sampleseries(g.audio?.send,(g=>g.remoteInboundRTP?.packetsLost)),googCodecName:S?.codec?.mimeType.split("/")[1],googTrackId:S?.track?.trackIdentifier,transport_id:S?.transport?.id,transportId:S?.outboundRTP.transportId,transport_selectedCandidatePairId:S?.transport?.selectedCandidatePairId,transport_dtlsCipher:S?.transport?.dtlsCipher,transport_srtpCipher:S?.transport?.srtpCipher,pair_id:S?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:S?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:S?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:S?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:S?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(g.audio?.send,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:S?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:S?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:S?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:S?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:S?.transport?.selectedCandidatePair?.localCandidate?.ip??S?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:S?.transport?.selectedCandidatePair?.remoteCandidate?.ip??S?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:S?.transport?.selectedCandidatePair?.nominated})})}function compileVideoTelemetryReport(g,m,S,v){return removeUndefinedFields({recv:removeUndefinedFields({id:S?.inboundRTP.id,ssrc:S?.inboundRTP.ssrc,mediaType:S?.inboundRTP.mediaType??S?.inboundRTP.kind,bytesReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.bytesReceived)),packetsReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.packetsReceived)),packetsLost:sampleseries(m[g]?.recv,(g=>g.inboundRTP.packetsLost)),googCodecName:S?.codec?.mimeType.split("/")[1],codecImplementationName:S?.inboundRTP.decoderImplementation,googTrackId:S?.track?.trackIdentifier,transport_id:S?.transport?.id,transportId:S?.inboundRTP.transportId,transport_selectedCandidatePairId:S?.transport?.selectedCandidatePairId,transport_dtlsCipher:S?.transport?.dtlsCipher,transport_srtpCipher:S?.transport?.srtpCipher,pair_id:S?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:S?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:S?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:S?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:S?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(m[g]?.recv,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:S?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:S?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:S?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:S?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:S?.transport?.selectedCandidatePair?.localCandidate?.ip??S?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:S?.transport?.selectedCandidatePair?.remoteCandidate?.ip??S?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:S?.transport?.selectedCandidatePair?.nominated,framesDecoded:sampleseries(m[g]?.recv,(g=>g.inboundRTP.framesDecoded)),googFrameHeightReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.frameHeight)),googFrameWidthReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.frameWidth)),googFrameRateReceived:sampleseries(m[g]?.recv,(g=>g.extensions?.frameRateReceived||0)),googNacksSent:sampleseries(m[g]?.recv,(g=>g.inboundRTP.nackCount)),googPlisSent:sampleseries(m[g]?.recv,(g=>g.inboundRTP.pliCount)),keyFramesDecoded:sampleseries(m[g]?.recv,(g=>g.inboundRTP.keyFramesDecoded)),googFirsSent:sampleseries(m[g]?.recv,(g=>g.inboundRTP.firCount)),googJitterBufferMs:sampleseries(m[g]?.recv,(g=>g.extensions?.jitterBufferMs)),googFrameRateDecoded:sampleseries(m[g]?.recv,(g=>g.extensions?.frameRateDecoded||0)),googFrameRateOutput:S?.extensions?.trackRecvFps,jitter:S?.inboundRTP.jitter}),send:removeUndefinedFields({id:v?.outboundRTP.id,ssrc:v?.outboundRTP.ssrc,mediaType:v?.outboundRTP.mediaType??v?.outboundRTP.kind,bytesSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.bytesSent)),packetsSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.packetsSent)),packetsLost:sampleseries(m[g]?.send,(g=>g.remoteInboundRTP?.packetsLost)),googCodecName:v?.codec?.mimeType.split("/")[1],codecImplementationName:v?.outboundRTP.encoderImplementation,googTrackId:v?.track?.trackIdentifier,transport_id:v?.transport?.id,transportId:v?.outboundRTP.transportId,transport_selectedCandidatePairId:v?.transport?.selectedCandidatePairId,transport_dtlsCipher:v?.transport?.dtlsCipher,transport_srtpCipher:v?.transport?.srtpCipher,pair_id:v?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:v?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:v?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:v?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:v?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(m[g]?.send,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:v?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:v?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:v?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:v?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:v?.transport?.selectedCandidatePair?.localCandidate?.ip??v?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:v?.transport?.selectedCandidatePair?.remoteCandidate?.ip??v?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:v?.transport?.selectedCandidatePair?.nominated,framesEncoded:sampleseries(m[g]?.send,(g=>g.outboundRTP.framesEncoded)),googNacksReceived:sampleseries(m[g]?.send,(g=>g.outboundRTP.nackCount)),googPlisReceived:sampleseries(m[g]?.send,(g=>g.outboundRTP.pliCount)),googFirsReceived:sampleseries(m[g]?.send,(g=>g.outboundRTP.firCount)),keyFramesEncoded:sampleseries(m[g]?.send,(g=>g.outboundRTP.keyFramesEncoded)),googFrameHeightInput:v?.mediaSource?.height,googFrameWidthInput:v?.mediaSource?.width,googFrameRateInput:sampleseries(m[g]?.send,(g=>g.mediaSource?.framesPerSecond)),googFrameHeightSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.frameHeight)),googFrameWidthSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.frameWidth)),googFrameRateSent:sampleseries(m[g]?.send,(g=>g.extensions?.frameRateSent)),googRtt:sampleseries(m[g]?.send,(g=>1e3*(g.remoteInboundRTP?.roundTripTime??0)),!0),hugeFramesSent:v?.outboundRTP.hugeFramesSent,qpSum:sampleseries(m[g]?.send,(g=>g.outboundRTP.qpSum)),qualityLimitationDurations:v?JSON.stringify(v?.outboundRTP.qualityLimitationDurations):void 0,qualityLimitationReason:v?.outboundRTP.qualityLimitationReason,qualityLimitationResolutionChanges:v?.outboundRTP.qualityLimitationResolutionChanges,jitter:v?.remoteInboundRTP?.jitter})})}function compileExtensionsTelemetryReport(g,m,S){const v=g.aggregatedModalityStats,C=getLast(v.audio?.recv),_=getLast(v.audio?.send),E=getLast(v.video?.recv),T=getLast(v.video?.send),I=getLast(v.sharing?.recv),b=getLast(v.sharing?.send),getMaxCapsEvents=S=>g.qualityManager&&limitArraySize(deepClone(S).map((S=>rebaseTime(limitArraySize(S.events,m.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",g.startTime))),m.config.diagnostics.telemetryLimits.numCapabilitiesRequested),A=getMaxCapsEvents(g.qualityManager.videoMaxCapabilitiesEvents),R=getMaxCapsEvents(g.qualityManager.videoMaxCapabilitiesErrors),P=getMaxCapsEvents(g.qualityManager.sharingMaxCapabilitiesEvents),M=getMaxCapsEvents(g.qualityManager.sharingMaxCapabilitiesErrors),w="REMB"!==g.bweType?g.bandwidthReport:void 0,D="REMB"===g.bweType?g.bandwidthReport:void 0,O=[],N=[];return g.statsOnSubscribed.video?.forEach((g=>O.push(g))),g.statsOnSubscribed.sharing?.forEach((g=>N.push(g))),removeUndefinedFields({BundlePolicy:g.bundlePolicy,FakeIceCandidate:g.fakeIceCandidate,H264_available_profiles:JSON.stringify(g.H264Profiles),IceConnectionState:g.iceConnectionState,IceConnectionStatePrevious:g.iceConnectionStatePrevious,IceServers:g.iceServers,IceTransportPolicy:g.iceTransportPolicy,NegotiatedSrtp:JSON.stringify(g.negotiatedSrtp),OfferedSrtp:JSON.stringify(g.offeredSrtp),RelayCandidate:g.relayCandidate,SdpSemantics:g.sdpSemantics,iceCandidateErrors:JSON.stringify(g.iceCandidateErrors),SignalingState:g.signalingState,SignalingStatePrevious:g.signalingStatePrevious,WebRTCStats_statsErrors:JSON.stringify(S),MaxSessionBandwidth:g.maxSessionBandwidth,Bandwidth_uplinkStabilizationTime:JSON.stringify(g.bwStabilizationTime),Bandwidth_downlinkStabilizationTime:JSON.stringify(g.bwDownlinkStabilizationTime),totalVideoControlMessages:g.qualityManager?.numVideoControlMessages,outOfOrderVideoControlMessages:g.qualityManager?.numOutOfOrderVideoControlMessages,webcamFreezeIntervals:g.qualityManager?.numWebcamFreezeIntervals,processedStreamFreezeIntervals:g.qualityManager?.numProcessedStreamFreezeIntervals,IPAddress:g.IPAddress??"none",ReflexiveLocalIP:g.reflexiveLocalIP??"none",NumberOfInterfaces:g.numInterfaces,StartTime:g.startTime,EndTime:g.endTime,AudioTransportRecvBitrate:C?.transport?.extensions?.recvBWAvg,AudioTransportSendBitrate:C?.transport?.extensions?.sendBWAvg,AudioPayloadRecvBitrate:C?.aggregated?.bitrateAvg,AudioPayloadSendBitrate:_?.aggregated?.bitrateAvg,VideoPayloadRecvBitrate:E?.aggregated?.bitrateAvg,VideoPayloadSendBitrate:T?.aggregated?.bitrateAvg,WebRTCStats_bweStat_googAvailableReceiveBandwidth:sampleseries(v.video?.recv,(g=>g.transport?.selectedCandidatePair?.availableIncomingBitrate))??sampleseries(v.video?.send,(g=>g.transport?.selectedCandidatePair?.availableIncomingBitrate)),WebRTCStats_bweStat_googAvailableSendBandwidth:sampleseries(v.video?.send,(g=>g.transport?.selectedCandidatePair?.availableOutgoingBitrate))??sampleseries(v.video?.recv,(g=>g.transport?.selectedCandidatePair?.availableOutgoingBitrate)),ReportedSendBWMax:g.reportedSendBandwidthMax,ReportedSendBWMin:g.reportedSendBandwidthMin,Bandwidth_jumpsHistogram:JSON.stringify(T?.transport?.extensions?.bwJumpsHistogram),StartCallBWESendSide:JSON.stringify(w?.startOfTheCall),EndCallBWESendSide:JSON.stringify(w?.endOfTheCall),BWEStdSendSide:JSON.stringify(w?.std),BwPercentilesSendSide:JSON.stringify(w?.bwPercentiles),AvgBwSendSide:JSON.stringify(w?.avgBwe),StartCallBWE:JSON.stringify(D?.startOfTheCall),EndCallBWE:JSON.stringify(D?.endOfTheCall),BWEStd:JSON.stringify(D?.std),BwPercentiles:JSON.stringify(D?.bwPercentiles),AvgBw:JSON.stringify(D?.avgBwe),WebRTCStats_ssrc:removeUndefinedFields({audio:compileAudioReport(v,C,_),video:compileVideoTelemetryReport("video",v,E,T),sharing:compileVideoTelemetryReport("sharing",v,I,b)}),Audio_recv_jitterBufferAvgSize:C?.aggregated?.avgJitterBufferSize,Audio_recv_packetsLostRateMax:C?.aggregated?.lossRateMax,Audio_recv_jitterAvg:C?.aggregated?.jitterAvg,Audio_recv_networkAvgLossRate:C?.aggregated?.networkAvgLossRate,Audio_send_rttAvg:_?.aggregated?.rttAvg&&round(1e3*_.aggregated.rttAvg),Audio_send_rttMax:_?.aggregated?.rttMax&&round(1e3*_.aggregated.rttMax),Audio_send_RawInputVolume:sampleseries(v.audio?.send,(g=>g.aggregated?.rawInputVolume)),Audio_send_packetsLostRateMax:_?.aggregated?.lossRateMax,Audio_send_presentationAPIUserDuration:g.presentationAPIUserDuration,Audio_send_presentationDuration:g.presentationAudioDuration,Video_recv_DurationSeconds:E?.aggregated?.duration,Video_recv_FreezeHistogram:JSON.stringify(E?.aggregated?.freezeCountHistogram),Video_recv_FreezeTimestamps:JSON.stringify(rebaseHistogramTimestamps(E?.aggregated?.freezeTimestampsHistogram,g.startTime)),Video_recv_LongestFreezeDuration:E?.aggregated?.longestFreeze,Video_recv_OngoingFreeze:E?.extensions?.isFrozen,Video_recv_OngoingFreezeDuration:E?.aggregated?.ongoingFreezeDuration,Video_recv_TotalFreezeDuration:E?.aggregated?.totalFreezeDuration,Video_recv_RecvAvgFreezeDuration:E?.aggregated?.avgFreezeDuration,Video_recv_NumResolutionSwitches:E?.aggregated?.numResolutionSwitches,Video_recv_ResolutionDurations:JSON.stringify(E?.aggregated?.resolutionDurations),Video_recv_StreamsMax:g.recvVideoStreamCount.max,Video_recv_StreamsMin:g.recvVideoStreamCount.min,Video_recv_StreamsMode:g.recvVideoStreamCount.mode,Video_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameVideo,Video_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.firstTimeToFirstFrameVideo,Video_recv_bitrateAvg:E?.aggregated?.bitrateAvg,Video_recv_bitrateMax:E?.aggregated?.bitrateMax,Video_recv_frameRateAvg:E?.aggregated?.avgFrameRate,Video_recv_jitterBufferAvgSize:E?.aggregated?.avgJitterBufferSize,Video_recv_packetsLostRateMax:E?.aggregated?.lossRateMax,Video_recv_isRenderingEvents:JSON.stringify(limitArraySize(g.remoteVideoManager.isRenderingEvents.video,m.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Video_recv_FpsHarmonicAverage:E?.aggregated?.fpsHarmonicAverage,Video_recv_PreferredResolution:g.remoteVideoManager.preferredResolution.video?.toString(),Video_recv_statsOnSubscribed:JSON.stringify(O),Video_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.video.events,"ts",g.startTime)),Video_SubscriptionCounters:JSON.stringify(g.subscriptionManager?.video.counters),Video_send_CaptureFramerateAvg:T?.aggregated?.captureFramerateAvg,Video_send_DurationSeconds:T?.aggregated?.duration,Video_send_FreezeIntervals:T?.extensions?.captureFreezeIntervalsCount,Video_send_MaxCapabilities:JSON.stringify(A),Video_send_MaxCapabilitiesErrors:JSON.stringify(R),Video_send_OvershootDurations:JSON.stringify({fs:T?.aggregated?.totalFsOvershootDuration,fps:T?.aggregated?.totalFpsOvershootDuration,br:T?.aggregated?.totalBrOvershootDuration}),Video_send_OvershootEvents:JSON.stringify(rebaseTime(T?.aggregated.overshootEvents,"timestamp",g.startTime)),Video_send_QpAvg:T?.aggregated?.qpAvg,Video_send_bitrateAvg:T?.aggregated?.bitrateAvg,Video_send_bitrateMax:T?.aggregated?.bitrateMax,Video_send_frameRateAvg:T?.aggregated?.frameRateAvg,Video_send_AllocateBWAvg:T?.aggregated?.bweAvg,Video_send_CameraOpenWidth:T?.extensions?.cameraOpenResolution?.width,Video_send_CameraOpenHeight:T?.extensions?.cameraOpenResolution?.height,Video_send_packetsLostRateMax:T?.aggregated?.lossRateMax,Video_send_resolutionSwitches:JSON.stringify(T?.aggregated?.resolutionSwitches),Sharing_recv_DurationSeconds:I?.aggregated?.duration,Sharing_recv_FreezeHistogram:JSON.stringify(I?.aggregated?.freezeCountHistogram),Sharing_recv_FreezeTimestamps:JSON.stringify(rebaseHistogramTimestamps(I?.aggregated?.freezeTimestampsHistogram,g.startTime)),Sharing_recv_LongestFreezeDuration:I?.aggregated?.longestFreeze,Sharing_recv_OngoingFreeze:I?.extensions?.isFrozen,Sharing_recv_TotalFreezeDuration:I?.aggregated?.totalFreezeDuration,Sharing_recv_RecvAvgFreezeDuration:I?.aggregated?.avgFreezeDuration,Sharing_recv_NumResolutionSwitches:I?.aggregated?.numResolutionSwitches,Sharing_recv_ResolutionDurations:JSON.stringify(I?.aggregated?.resolutionDurations),Sharing_recv_StreamsMax:g.recvVideoStreamCount.max,Sharing_recv_StreamsMin:g.recvVideoStreamCount.min,Sharing_recv_StreamsMode:g.recvVideoStreamCount.mode,Sharing_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameSharing,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.firstTimeToFirstFrameVideo,Sharing_recv_bitrateAvg:I?.aggregated?.bitrateAvg,Sharing_recv_bitrateMax:I?.aggregated?.bitrateMax,Sharing_recv_frameRateAvg:I?.aggregated?.avgFrameRate,Sharing_recv_jitterBufferAvgSize:I?.aggregated?.avgJitterBufferSize,Sharing_recv_packetsLostRateMax:I?.aggregated?.lossRateMax,Sharing_recv_FpsHarmonicAverage:I?.aggregated?.fpsHarmonicAverage,Sharing_recv_isRenderingEvents:JSON.stringify(limitArraySize(g.remoteVideoManager.isRenderingEvents.sharing,m.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Sharing_recv_PreferredResolution:g.remoteVideoManager.preferredResolution.sharing?.toString(),Sharing_recv_statsOnSubscribed:JSON.stringify(N),Sharing_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.sharing.events,"ts",g.startTime)),Sharing_SubscriptionCounters:JSON.stringify(g.subscriptionManager?.sharing.counters),Sharing_send_CaptureFramerateAvg:b?.aggregated?.captureFramerateAvg,Sharing_send_DurationSeconds:b?.aggregated?.duration,Sharing_send_MaxCapabilities:JSON.stringify(P),Sharing_send_MaxCapabilitiesErrors:JSON.stringify(M),Sharing_send_OvershootDurations:JSON.stringify({fs:b?.aggregated?.totalFsOvershootDuration,fps:b?.aggregated?.totalFpsOvershootDuration,br:b?.aggregated?.totalBrOvershootDuration}),Sharing_send_resolutionSwitches:b?.aggregated?.resolutionSwitches,Sharing_send_OvershootEvents:JSON.stringify(rebaseTime(b?.aggregated.overshootEvents,"timestamp",g.startTime)),Sharing_send_QpAvg:b?.aggregated?.qpAvg,Sharing_send_bitrateAvg:b?.aggregated?.bitrateAvg,Sharing_send_bitrateMax:b?.aggregated?.bitrateMax,Sharing_send_frameRateAvg:b?.aggregated?.frameRateAvg,Sharing_send_AllocateBWAvg:b?.aggregated?.bweAvg,Sharing_send_packetsLostRateMax:b?.aggregated?.lossRateMax,multipleVideoStreams:JSON.stringify(rebaseTime(g.multiViewStats,"startTime",g.startTime)),ReportedReceiveBandwidth:g.reportedReceiveBandwidth,OvcToSubscriptions:JSON.stringify(g.ovcToSubscriptionEvents),EncodedStreamWorker:g.encodedStreamWorker,AudioCodecEvents:JSON.stringify(g.audioCodecEvents),HevcCodecSupport:JSON.stringify(g?.codecSupport),CallSetupTimeTracker:JSON.stringify(g.timerTrackerReport),SentBWSeed:g.sentBWSeed,videoPerformanceEvent:JSON.stringify(g.videoPerformanceEvent),EarlyMedia_NumStatsPolls:g.earlyMediaNumStatsPolls})}function convertCodec(g){return g?.substring(g.indexOf("/")+1).toUpperCase()}var videoSendStatsFieldConverter=g=>removeUndefinedFields({id:g.outboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.remoteInboundRTP?.jitter,packets:g.outboundRTP.packetsSent,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.remoteInboundRTP?.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,rtt:g.remoteInboundRTP?.roundTripTime,frameRateInput:g.mediaSource?.framesPerSecond,frameWidthInput:g.mediaSource?.width,frameHeightInput:g.mediaSource?.height,framesEncoded:g.outboundRTP.framesEncoded,frameRateEncoded:g.extensions?.frameRateEncoded,framesSent:g.outboundRTP.framesSent,frameRateSent:g.extensions?.frameRateSent,frameWidthSent:g.outboundRTP.frameWidth,frameHeightSent:g.outboundRTP.frameHeight,keyFramesEncoded:g.outboundRTP.keyFramesEncoded,nackCount:g.outboundRTP.nackCount,firCount:g.outboundRTP.firCount,pliCount:g.outboundRTP.pliCount,transportId:g.outboundRTP.transportId,altLayouts:g.altLayouts?.map(videoSendStatsFieldConverter)}),videoRecvStatsFieldConverter=g=>removeUndefinedFields({id:g.inboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.inboundRTP.jitter,packets:g.inboundRTP.packetsReceived,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.inboundRTP.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,packetsDiscarded:g.inboundRTP.packetsDiscarded,rtt:g.remoteOutboundRTP?.roundTripTime,msi:g.renderer?.msi,jitterBufferMs:g.extensions?.jitterBufferMs,frameRateOutput:g.extensions?.frameRateDecoded,frameRateDecoded:g.extensions?.frameRateDecoded,frameRateReceived:g.extensions?.frameRateReceived,frameWidthReceived:g.inboundRTP.frameWidth,frameHeightReceived:g.inboundRTP.frameHeight,longestFreezeDuration:g.extensions?.longestFreeze,totalFreezeDuration:g.extensions?.totalFreezeDuration,framesReceived:g.inboundRTP.framesReceived,framesDropped:g.inboundRTP.framesDropped,framesDecoded:g.inboundRTP.framesDecoded,keyFramesDecoded:g.inboundRTP.keyFramesDecoded,nackCount:g.inboundRTP.nackCount,firCount:g.inboundRTP.firCount,pliCount:g.inboundRTP.pliCount,transportId:g.inboundRTP.transportId}),audioSendStatsFieldConverter=g=>removeUndefinedFields({id:g.outboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.remoteInboundRTP?.jitter,packets:g.outboundRTP.packetsSent,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.remoteInboundRTP?.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,packetsDiscarded:g.remoteInboundRTP?.packetsDiscarded,rtt:g.remoteInboundRTP?.roundTripTime,audioLevel:g.mediaSource?.audioLevel,transportId:g.outboundRTP.transportId}),audioRecvStatsFieldConverter=g=>removeUndefinedFields({id:g.inboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.inboundRTP.jitter,packets:g.inboundRTP.packetsReceived,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.inboundRTP.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,packetsDiscarded:g.inboundRTP.packetsDiscarded,rtt:g.remoteOutboundRTP?.roundTripTime,jitterBufferMs:g.extensions?.jitterBufferMs,audioLevel:g.inboundRTP.audioLevel,healedRatio:g.extensions?.healedRatio,transportId:g.inboundRTP.transportId}),dataChannelStatsFieldConverter=g=>removeUndefinedFields({id:g.id,state:g.state,dataChannelIdentifier:g.dataChannelIdentifier,messagesSent:g.messagesSent,bytesSent:g.bytesSent,messagesReceived:g.messagesReceived,bytesReceived:g.bytesReceived,sendBitrate:g.extensions?.sendBitrate,recvBitrate:g.extensions?.recvBitrate,messagesSentPerSecond:g.extensions?.sendMessageRate,messagesReceivedPerSecond:g.extensions?.recvMessageRate}),transportStatsFieldConverter=g=>removeUndefinedFields({id:g.id,rtt:g.selectedCandidatePair?.currentRoundTripTime,availableIncomingBitrate:g.selectedCandidatePair?.availableIncomingBitrate,availableOutgoingBitrate:g.selectedCandidatePair?.availableOutgoingBitrate,relayProtocol:g.selectedCandidatePair?.localCandidate?.relayProtocol,candidateType:`${g.selectedCandidatePair?.localCandidate?.candidateType??""}:${g.selectedCandidatePair?.remoteCandidate?.candidateType??""}`});function compileAudioSendReport(g){return(g.audio?.send??[]).map(audioSendStatsFieldConverter)}function compileAudioRecvReport(g){return(g.audio?.recv??[]).map(audioRecvStatsFieldConverter)}function compileVideoSendReport(g){if(!g.video?.send?.length)return[];return g.video.send.map(videoSendStatsFieldConverter)}function compileVideoRecvReport(g){return(g.video?.recv??[]).map(videoRecvStatsFieldConverter)}function compileScreenShareSendReport(g){if(!g.sharing?.send?.length)return[];return g.sharing.send.map(videoSendStatsFieldConverter)}function compileScreenShareRecvReport(g){return(g.sharing?.recv??[]).map(videoRecvStatsFieldConverter)}function compileDataChannelReport(g){return(g.data??[]).map(dataChannelStatsFieldConverter)}function compileTransportReport(g){return Object.values(g.transports??{}).map(transportStatsFieldConverter)}function compileMediaStatsReport(g){return{audio:{send:compileAudioSendReport(g),recv:compileAudioRecvReport(g)},video:{send:compileVideoSendReport(g),recv:compileVideoRecvReport(g)},screenShare:{send:compileScreenShareSendReport(g),recv:compileScreenShareRecvReport(g)},data:compileDataChannelReport(g),transports:compileTransportReport(g)}}function compileMediaStatsReportExtensions(g,m){const S=g.qualityManager&&limitArraySize(deepClone(g.qualityManager.videoMaxCapabilitiesEvents).map((S=>rebaseTime(limitArraySize(S.events,m.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",g.startTime))),m.config.diagnostics.telemetryLimits.numCapabilitiesRequested),v=g.qualityManager&&limitArraySize(deepClone(g.qualityManager.sharingMaxCapabilitiesEvents).map((S=>rebaseTime(limitArraySize(S.events,m.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",g.startTime))),m.config.diagnostics.telemetryLimits.numCapabilitiesRequested);return removeUndefinedFields({Video_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.video.events,"ts",g.startTime)),Sharing_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.sharing.events,"ts",g.startTime)),Video_send_MaxCapabilities:JSON.stringify(S),Sharing_send_MaxCapabilities:JSON.stringify(v),RelayCandidate:g.relayCandidate,Video_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameVideo,Sharing_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameSharing,Video_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.timeToFirstFrameSinceSubscriptionStartVideo,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.timeToFirstFrameSinceSubscriptionStartSharing})}function compileMediaStatsReportMetrics(g,m,S){return removeUndefinedFields({DeviceEvents:JSON.stringify(rebaseTime(S.deviceManager.deviceTelemetryEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),IceConnectedStateTime:1e4*g.iceConnectedStateTime})}function compileMetricsTelemetryReport(g,m,S,v){const C=g.webrtcSessions[g.webrtcSessions.length-1];return removeUndefinedFields({MediaLegId:g.mediaLegId,CreationTime:getHpTimeFromMillis(g.creationTime),CallNumber:g.callNumber,SessionId:g.sessionId,MultiParty:g.isMultiParty,ErrorType:g.error?.type??"none",ErrorDetail:g.error?.detail??"none",IncompatibleOffer:g.error?.type===Ke.MEDIA_ERROR.incompatibleOffer,TerminationTime:getHpTimeFromMillis(g.terminationTime),TerminationReason_code:g.terminationReason?.code,TerminationReason_subCode:g.terminationReason?.subCode,TerminationReason_phrase:g.terminationReason?.phrase,TerminationReason_remoteTerminated:g.terminationReason?.remoteTerminated,TerminationReason_clientReasonPhrase:g.terminationReason?.clientReasonPhrase,TerminationReason_clientReasonSubCode:g.terminationReason?.clientReasonSubCode,CallDuration:getHpTimeFromMillis(g.duration),IceInitTime:getHpTimeFromMillis(g.iceInitTime),IceConnectedStateTime:getHpTimeFromMillis(g.iceConnectedStateTime),NegotiationCount:g.negotiationCount,RejectedNegotiationCount:g.rejectedNegotiationCount,InitialNegotiationCompleted:g.initialNegotiationCompleted,InitialNegotiationType:g.initialNegotiationType,FinalAnswerTime:getHpTimeFromMillis(g.finalAnswerTime),TransportReconnectedCount:g.transportReconnectedCount,RollbackNegotiation:JSON.stringify(g.rollbackNegotiation),Relay:g.relay?JSON.stringify(g.relay):void 0,ActiveModalities:JSON.stringify(g.activeModalities),AllowedAudioSend:g.allowedAudioSend,AllowedVideoSend:g.allowedVideoSend,AllowedScreensharingSend:g.allowedScreensharingSend,RelayManager:JSON.stringify(g.relayTimers),CallMutedRatio:getHpTimeFromMillis(g.callMutedRatio),CallOsMuted:getHpTimeFromMillis(g.callOsMuted),CallHwSilent:getHpTimeFromMillis(g.callHwSilent),CallSwMuted:getHpTimeFromMillis(g.callSwMuted),CallSpeakerMuted:getHpTimeFromMillis(g.callSpeakerMuted),CallIsSpeaking:getHpTimeFromMillis(g.callIsSpeaking),DtmfSuccess:g.dtmfSuccessCount,DtmfFailure:g.dtmfFailureCount,ReconnectInProgress:g.reconnect?.isReconnecting,RetargetIncomingCount:g.reconnect?.retargetCount.incoming,RetargetOutgoingCount:g.reconnect?.retargetCount.outgoing,RetargetCompletedCount:g.reconnect?.retargetCount.completed,RetargetRejectedCount:g.reconnect?.retargetCount.rejected,EscalationAttemptedCount:g.reconnect?.escalationCount.attempted,EscalationCompletedCount:g.reconnect?.escalationCount.completed,EscalationRejectedCount:g.reconnect?.escalationCount.rejected,ReconnectAttemptedCount:g.reconnect?.reconnectCount.attempted,ReconnectConnectedCount:g.reconnect?.reconnectCount.connected,ReconnectAttempts:JSON.stringify(rebaseTime(limitArraySize(g.reconnect?.records,v.config.diagnostics.telemetryLimits.numReconnects),"startTime",g.creationTime)),NetworkEvents:JSON.stringify(rebaseTime(limitArraySize(g.reconnect?.tmpRecords,v.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",g.creationTime)),NoIceCandidatesGoodEventCount:g.noIceCandidatesEventCount.good,NoIceCandidatesBadEventCount:g.noIceCandidatesEventCount.bad,NoRelayIceCandidatesGoodEventCount:g.noRelayIceCandidatesEventCount.good,NoRelayIceCandidatesBadEventCount:g.noRelayIceCandidatesEventCount.bad,MicrophoneInUseGoodEventCount:g.microphoneInUseEventCount.good,MicrophoneInUseBadEventCount:g.microphoneInUseEventCount.bad,CameraInUseGoodEventCount:g.cameraInUseEventCount.good,CameraInUseBadEventCount:g.cameraInUseEventCount.bad,CameraFreezeStartEventCount:g.cameraFreezeEventCount.start,CameraFreezeEndEventCount:g.cameraFreezeEventCount.end,NetworkRecvGood:g.networkRecvUFD.good,NetworkRecvGoodRatio:g.networkRecvUFD.goodRatio,NetworkRecvPoor:g.networkRecvUFD.poor,NetworkRecvPoorRatio:g.networkRecvUFD.poorRatio,NetworkRecvBad:g.networkRecvUFD.bad,NetworkRecvBadRatio:g.networkRecvUFD.badRatio,NetworkSendGood:g.networkSendUFD.good,NetworkSendGoodRatio:g.networkSendUFD.goodRatio,NetworkSendPoor:g.networkSendUFD.poor,NetworkSendPoorRatio:g.networkSendUFD.poorRatio,NetworkSendBad:g.networkSendUFD.bad,NetworkSendBadRatio:g.networkSendUFD.badRatio,Connection_Downlink:sampleseries(C.networkInfo,(g=>g.downlink)),Connection_EffectiveType:sampleseries(C.networkInfo,(g=>g.effectiveType)),Connection_Rtt:sampleseries(C.networkInfo,(g=>g.rtt)),Connection_SaveData:getLast(C.networkInfo)?.saveData,RawOutputAudioAccessAttempted:g.rawMedia.audio.recv.numAttempts,RawOutputAudioAccessDurationRatio:g.rawMedia.audio.recv.durationRatio,RawInputAudioOverrideAttempted:g.rawMedia.audio.send.numAttempts,RawInputAudioOverrideDurationRatio:g.rawMedia.audio.send.durationRatio,UFDs:JSON.stringify(rebaseTime(limitArraySize(g.ufds,v.config.diagnostics.telemetryLimits.numUFDs),"timestamp",g.creationTime)),MediaQosEnabled:S.configuration.mediaConfig?.enableMediaQoS??!1,PortRangeConfigured:!!S.configuration.mediaConfig?.mediaPortRanges,hardwareConcurrency:S.configuration.userAgentConfig.hardwareConcurrency,ETag:g.ETag,ConfigIds:g.configIds,GPUName:S.configuration.userAgentConfig.unmaskedGlRenderer,PermissionStates:JSON.stringify(S.deviceManager.permissionStates),DeviceList:JSON.stringify(S.deviceManager.deviceList),DeviceListDebug:JSON.stringify(S.deviceManager.deviceDebugStrings),DevicesChangeCount:g.deviceManager.devicesChangeCount,DevicesPollChangeCount:g.deviceManager.devicesPollChangeCount,DeviceSelectionChangeCount:g.deviceManager.deviceSelectionChangeCount,DeviceSelectionChangeFromInterfaceCount:g.deviceManager.deviceSelectionChangeCountFromInterface,DevicesCount:JSON.stringify(S.deviceManager.devicesCount),UsedMicrophone:S.deviceManager.usedDevices.microphone,UsedSpeaker:S.deviceManager.usedDevices.speaker,UsedCamera:S.deviceManager.usedDevices.camera,DeviceEvents:JSON.stringify(rebaseTime(S.deviceManager.deviceTelemetryEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),VideoEffects:JSON.stringify(rebaseTime(S.deviceManager.videoEffectsEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),AudioEffects:JSON.stringify(rebaseTime(S.deviceManager.audioEffectsEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),MediaByPassEnabled:!!S.configuration.mediaConfig.enableMediaBypass,CallConstraints:JSON.stringify(v.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(generateDominantSpeakerReport(g.dominantSpeaker,g.terminationTime))})}function getHpTimeFromMillis(g){return 1e4*g}function generateDominantSpeakerReport(g,m=Number(new Date)){if(!g)return;const S=deepClone(g);return g.lastMsgDate&&(g.timeSinceLastMsg=g.lastMsgDate-m),delete S.lastMsgDate,delete S.lastHistory,removeUndefinedFields(S)}function getValue(g,m,S=0){const v=m.filter((g=>void 0!==g));let C;switch(g){case"Difference":C=v[v.length-1]-v[0];break;case"Average":C=v.reduce(((g,m)=>g+m),0)/v.length;break;case"LastValue":C=v[v.length-1]}return C||0===C?`${"number"==typeof C?+C.toFixed(S):C}`:void 0}function filterStats(g,m,S){return(S?g.map((g=>g?.[m]?.[S])):g.map((g=>g?.[m]))).filter((g=>void 0!==g)).reduce(((g,m)=>g.concat(m)),[])}function findTransportStats(g){const m=g.find((g=>g?.transports));return m?m.transports[Object.keys(m.transports)[0]]:void 0}function getVideoProcessing(g){const m=g[g.length-1]?.extensions?.powerEfficient;return void 0===m?"":m?"hw":"sw"}function getMediaDirection(g,m){return g&m?"Bidirectional":g?"ReceiveFromPeer":m?"SendToPeer":"Inactive"}function getSendActivityState(g){const m=g[g.length-1]?.extensions?.callIsMuted,S=g[g.length-1]?.extensions?.rawInputVolume;return m?"0":!m&&S>0?"2":m||0!==S?void 0:"1"}function compileAudioReport2(g,m){const S=filterStats(g,"audio","send"),v=filterStats(g,"audio","recv"),C=findTransportStats(g);if(S.length||v.length)return removeUndefinedFields({mediaType:"Audio",mediaDirection:getMediaDirection(v.length,S.length),"Received BW estimate":getValue("Average",v.map((g=>g?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Recv Loss Rate (Avg)":getValue("LastValue",v.map((g=>g?.extensions?.lossRate/100)),3),"Rtp Packets Received":getValue("Difference",v.map((g=>g?.inboundRTP.packetsReceived))),"Rtp Packet Sent":getValue("Difference",S.map((g=>g?.outboundRTP.packetsSent))),"Sent BW estimate":getValue("Average",S.map((g=>g?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Audio Codec":getValue("LastValue",S.map((g=>g?.codec?.mimeType)))?.split("/")[1],"Send RTT (Avg)":getValue("LastValue",S.map((g=>g?.extensions?.rttAvg))),"Audio NW jitter avg":getValue("LastValue",v.map((g=>g?.extensions?.jitterAvg)),3),"Audio send bps":getValue("Average",S.map((g=>g?.extensions?.bitrate))),"JB delay (ms)":getValue("LastValue",v.map((g=>g?.extensions?.jitterBufferDelayMs))),"Recv Audio Codec":getValue("LastValue",v.map((g=>g?.codec?.mimeType)))?.split("/")[1],"Current Render Device Name":m?.speaker,"Current Capture Device Name":m?.microphone,"Latest Network Type":C?.selectedCandidatePair?.localCandidate?.networkType,"Latest Transport Protocol":C?.selectedCandidatePair?.localCandidate?.protocol,"Latest Reflexive Address":ipAddressConverter(C?.extensions?.reflexiveLocalIP),"Local Address":ipAddressConverter(C?.selectedCandidatePair?.localCandidate?.ip),"Local short-term Healed Data Ratio":getValue("LastValue",v.map((g=>g?.extensions?.healedRatio))),"Send activity (0=muted; 1=inactive; 2=active)":getSendActivityState(S)})}function formatVideoStats(g){const m={},formatStats=S=>{g.map((g=>g?.video?.[S])).forEach((g=>{g?.forEach((g=>{var v;const C=g?.mediaEntity?.remoteSsrc;m[C]??(m[C]={}),(v=m[C])[S]??(v[S]=[]),m[C][S].push(g)}))}))};return formatStats("recv"),formatStats("send"),m}function compileVideoReport(g,m){const S=[],v=formatVideoStats(g);for(const{send:g,recv:C}of Object.values(v)){let v={mediaType:"Camera",mediaDirection:getMediaDirection(C?.length,g?.length)};C&&(v={...v,...compileVideoRecvReport2(C)}),g&&(v={...v,...compileVideoSendReport2(g,m)}),S.push(removeUndefinedFields(v))}return S}function compileVideoSendReport2(g,m){const S=getValue("LastValue",g.map((g=>g?.codec?.mimeType)))?.split("/")[1],v=S?S+` ${getVideoProcessing(g)}`:void 0;return{"Rtp Packet Sent":getValue("Difference",g.map((g=>g?.outboundRTP.packetsSent))),"Sent BW estimate":getValue("Average",g.map((g=>g?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Current Bitrate":getValue("Average",g.map((g=>g?.extensions?.bitrate))),"Allocated Send Bandwidth Average":getValue("LastValue",g.map((g=>g?.extensions?.bitrateAvg))),"Send Actual Height":getValue("LastValue",g.map((g=>g?.outboundRTP.frameHeight))),"Send Actual Width":getValue("LastValue",g.map((g=>g?.outboundRTP.frameWidth))),"Send Current Frame Rate":getValue("Average",g.map((g=>g?.extensions?.frameRateSent))),"Send RTT (Avg)":getValue("LastValue",g.map((g=>g?.extensions?.rttAvg))),"Sent Codec Name":v,"Webcam Freeze Intervals":getValue("LastValue",g.map((g=>g?.extensions?.captureFreezeIntervalsCount))),"Current Capture Device Name":m?.camera,"Number of Sync Frame Request per Minute":getValue("LastValue",g.map((g=>g?.extensions?.pliRate)))}}function compileVideoRecvReport2(g){const m=getValue("LastValue",g.map((g=>g?.mediaEntity?.xSourceStreamId))),S=getValue("LastValue",g.map((g=>g?.codec?.mimeType)))?.split("/")[1],v=S?S+` ${getVideoProcessing(g)}`:void 0;return{"Recv Loss Rate (Avg)":getValue("LastValue",g.map((g=>g?.extensions?.lossRate)),3),"Received BW estimate":getValue("Average",g.map((g=>g?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Receive Current Bitrate":getValue("Average",g.map((g=>g?.extensions?.bitrate))),"Rtp Packets Received":getValue("Difference",g.map((g=>g?.inboundRTP.packetsReceived))),"Receive Actual Height":getValue("LastValue",g.map((g=>g?.inboundRTP.frameHeight))),"Receive Actual Width":getValue("LastValue",g.map((g=>g?.inboundRTP.frameWidth))),"Receive Current Frame Rate":getValue("Average",g.map((g=>g?.extensions?.frameRateReceived))),"Received Codec Name":v,"Received Total Freeze Fraction (ms per min)":getValue("LastValue",g.map((g=>g?.extensions?.totalFreezeFraction))),videoSourceId:m?parseInt(m):void 0,"Received Fps Time Weighted Harmonic Average":getValue("LastValue",g.map((g=>g?.extensions?.fpsHarmonicAverage)))}}function compileSharingReport(g){const m=filterStats(g,"sharing","send"),S=filterStats(g,"sharing","recv");if(!S.length&&!m.length)return;let v={mediaType:"AppSharing",mediaDirection:"Bidirectional","Render Device Name":""};return S.length&&(v={...v,...compileVideoRecvReport2(S)}),m.length&&(v={...v,...compileVideoSendReport2(m,{microphone:void 0,camera:"Screen sharing",speaker:void 0})}),removeUndefinedFields(v)}function compileReports(g,m,S){const v=compileAudioReport2(g,m);v&&S.channels.push(v);const C=compileVideoReport(g,m);C.length&&S.channels.push(...C);const _=compileSharingReport(g);_&&S.channels.push(_)}function compileTeamsRealtimeTelemetryReport(g,m){const S=filterStats(g,"inactiveTracks"),v={channels:[]};return compileReports(g,m,v),S.length&&compileReports(S,void 0,v),v}function compileVideoReportForE2E(g,m,S,v,C){return removeUndefinedFields({recv:removeUndefinedFields({id:S?.inboundRTP.id,ssrc:S?.inboundRTP.ssrc,mediaType:S?.inboundRTP.mediaType??S?.inboundRTP.kind,bytes:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.bytesReceived),C),packets:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.packetsReceived),C),packetsLost:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.packetsLost),C),codec:S?.codec?.mimeType.split("/")[1],codecReport:S?.aggregated?.codecReport,framesDecoded:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.framesDecoded),C),height:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.frameHeight),C),width:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.frameWidth),C),frameRate:sampleseriesArr(m[g]?.recv,(g=>g.extensions?.frameRateReceived),C)}),send:removeUndefinedFields({id:v?.outboundRTP.id,ssrc:v?.outboundRTP.ssrc,mediaType:v?.outboundRTP.mediaType??v?.outboundRTP.kind,bytes:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.bytesSent),C),packets:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.packetsSent),C),packetsLost:sampleseriesArr(m[g]?.send,(g=>g.remoteInboundRTP?.packetsLost),C),codec:v?.codec?.mimeType.split("/")[1],framesEncoded:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.framesEncoded),C),heightInput:v?.mediaSource?.height,widthInput:v?.mediaSource?.width,height:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.frameHeight),C),width:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.frameWidth),C),frameRate:sampleseriesArr(m[g]?.send,(g=>g.extensions?.frameRateSent),C)})})}function compileAudioReportForE2E(g,m,S,v){const C=m?.codec?.mimeType.split("/");return removeUndefinedFields({recv:removeUndefinedFields({id:m?.inboundRTP.id,ssrc:m?.inboundRTP.ssrc,mediaType:m?.inboundRTP.mediaType??m?.inboundRTP.kind,bytes:sampleseriesArr(g.audio?.recv,(g=>g.inboundRTP.bytesReceived),v),packets:sampleseriesArr(g.audio?.recv,(g=>g.inboundRTP.packetsReceived),v),packetsLost:sampleseriesArr(g.audio?.recv,(g=>g.inboundRTP.packetsLost),v),codec:C?.[C?.length-1],audioLevel:sampleseriesArr(g.audio?.recv,(g=>Math.floor(65535*g.inboundRTP.audioLevel)),v)}),send:removeUndefinedFields({id:S?.outboundRTP.id,ssrc:S?.outboundRTP.ssrc,mediaType:S?.outboundRTP.mediaType??S?.outboundRTP.kind,bytes:sampleseriesArr(g.audio?.send,(g=>g.outboundRTP.bytesSent),v),packets:sampleseriesArr(g.audio?.send,(g=>g.outboundRTP.packetsSent),v),packetsLost:sampleseriesArr(g.audio?.send,(g=>g.remoteInboundRTP?.packetsLost),v),codec:S?.codec?.mimeType.split("/")[1],audioLevel:sampleseriesArr(g.audio?.send,(g=>Math.floor(65535*g.aggregated.audioLevel)),v)})})}function compileE2EDiagReport(g,m,S,v,C){const _=g.aggregatedModalityStats,E=getLast(_.audio?.recv),T=getLast(_.audio?.send),I=getLast(_.video?.recv),b=getLast(_.video?.send),A=getLast(_.sharing?.recv),R=getLast(_.sharing?.send),P=[],M=[];return g.statsOnSubscribed.video?.forEach((g=>P.push(g))),g.statsOnSubscribed.sharing?.forEach((g=>M.push(g))),removeUndefinedFields({multipleVideoStreams:g.multiViewStats,WebRTCStats_ssrc:removeUndefinedFields({audio:compileAudioReportForE2E(_,E,T,C),video:compileVideoReportForE2E("video",_,I,b,C),sharing:compileVideoReportForE2E("sharing",_,A,R,C)}),CallSwMuted:1e3*m.callSwMuted,DeviceEvents:rebaseTime(S.deviceManager.deviceTelemetryEvents.filter((g=>g.timestamp>v)),"timestamp",m.creationTime),VideoEffects:rebaseTime(S.deviceManager.videoEffectsEvents.filter((g=>g.timestamp>v)),"timestamp",m.creationTime)})}var FS=class{constructor(g,m){this.rootRef=g,this.configProvider=m}get rootCopy(){return deepClone(this.rootRef)}get rawRootRef(){return this.rootRef}getSessionTelemetry(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g)),S={metrics:{},Extensions:{}};if(!m)return;const v=Je();try{const g=m.callNumber>1?this.rootRef.sessions.find((g=>m.callNumber-1===g.callNumber)):void 0,v=g?.terminationTime??0,C=m.webrtcSessions[m.webrtcSessions.length-1];S.metrics=compileMetricsTelemetryReport(m,v,this.rootRef,this.configProvider),S.Extensions=compileExtensionsTelemetryReport(C,this.configProvider,m.statsErrors)}catch(g){m[DS].addStatsError("DiagnosticsReport:getSessionTelemetry",stringifyObject(g)),S.Extensions.WebRTCStats_statsErrors=JSON.stringify(m.statsErrors)}return S.metrics.ReportGenerationTimeMs=round(Je()-v),S}getTeamsRealtimeTelemetry(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g));if(m)try{const g=m.webrtcSessions[m.webrtcSessions.length-1],S=this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval;return compileTeamsRealtimeTelemetryReport(g.statsReports.slice(g.statsReports.length-S),this.rootRef.deviceManager.rawUsedDevices)}catch(g){throw m[DS].addStatsError("DiagnosticsReport:getRealTimeTelemetry",stringifyObject(g)),g}}getMediaSessionStats(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g));if(m)try{const g=m.callNumber>1?this.rootRef.sessions.find((g=>m.callNumber-1===g.callNumber)):void 0,S=g?.terminationTime??0,v=m.webrtcSessions[m.webrtcSessions.length-1],C=v?.statsReports.length?v.statsReports[v.statsReports.length-1]:void 0,_=C?compileMediaStatsReport(C):void 0;return _&&(_.extensions=compileMediaStatsReportExtensions(v,this.configProvider),_.metrics=compileMediaStatsReportMetrics(m,S,this.rootRef)),_}catch(g){throw m[DS].addStatsError("DiagnosticsReport:getMediaSessionStats",stringifyObject(g)),g}}getDiagnosticsForE2eTests(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g));let S={};if(m){try{const g=m.webrtcSessions[m.webrtcSessions.length-1],v=m.callNumber>1?this.rootRef.sessions.find((g=>m.callNumber-1===g.callNumber)):void 0,C=v?.terminationTime??0;S=compileE2EDiagReport(g,m,this.rootRef,C,this.configProvider.config.diagnostics.collectionLimits.numSamplesForE2E)}catch(g){m[DS].addStatsError("DiagnosticsReport:getSessionTelemetry",stringifyObject(g))}return S}}},xS=class{constructor(g,m){this.configProvider=g,this.deviceManagerDiagnostics=m,this.root={creationTime:Date.now(),numTotalSessions:0,deviceManager:this.deviceManagerDiagnostics.getObjectRef(),configuration:{stackConfig:this.configProvider.stackConfig,defaultConfig:this.configProvider.defaultConfig,mediaConfig:{},userAgentConfig:{isAudioOutputSelectionSupported:this.configProvider.userAgentConfig.isAudioOutputSelectionSupported,isBrowserRollbackSupported:this.configProvider.userAgentConfig.isBrowserRollbackSupported,hardwareConcurrency:this.configProvider.userAgentConfig.hardwareConcurrency,unmaskedGlRenderer:this.configProvider.userAgentConfig.unmaskedGlRenderer,hasMediaApi:Vs.hasMediaApi(),hasCapabilitiesApi:Vs.hasCapabilitiesApi(),hasUnifiedPlanSupport:void 0},consoleOverrides:this.configProvider.consoleOverrides,fullConfig:deepClone(this.configProvider.config),ecsConfigUpdates:[]},browserInfo:getBrowserInfo(),sessions:[]},this.diagnosticsReport=new FS(this.root,this.configProvider),this.configProvider.on("newConfigReceived",((g,m,S)=>{this.root.configuration.ecsConfigUpdates.push({timestamp:Date.now(),etag:m,configIds:S,config:g})})),this.configProvider.on("configUpdated",(()=>{this.root.configuration.consoleOverrides=this.configProvider.consoleOverrides,this.root.configuration.fullConfig=deepClone(this.configProvider.config)}))}get reportGenerator(){return this.diagnosticsReport}get rootRef(){return this.root}set mediaConfig(g){this.root.configuration.mediaConfig=g}newSession(g,m,S){this.root.configuration.userAgentConfig.hasUnifiedPlanSupport=this.configProvider.mediaConfig.simulcastSessionEnabled;const v=new OS(S,g,this.diagnosticsReport,this.root.deviceManager,++this.root.numTotalSessions,m);return arrayLimitedPush(this.root.sessions,v.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numSessions),v}},US=class _JamaLogger{constructor(g,m){this.safe=g,this.unsafe=m,this.safe||(this.safe=this.unsafe)}warn(...g){this.unsafe.warn(...g)}error(...g){this.unsafe.error(...g)}debug(...g){this.unsafe.debug(...g)}info(...g){this.unsafe.info(...g)}createChild(g){return new _JamaLogger(this.safe.createChild(g),this.unsafe.createChild(g))}},VS=P,BS=class{constructor(g){this.logger=g,this.extensionId="nkeimhogjdpnpccoofpliimaahmaaome",this.editorExtensionId="ncbjelpjchkpbikbpkcchkhkblodoama",this.logId="TeamsWebRTCLogs",this.loggingState="unknown",this.connectionCount=0;window.webRtcInternalsCollector=this}get isExtensionAvailable(){return"unavailable"!==this.loggingState}async updateSessionCount(g){this.isExtensionAvailable&&(0===this.connectionCount&&1===g?("stopped"===this.loggingState&&await this.discardLogs(),await this.initialStartLogging()):0===g&&await this.stopLogging(),this.connectionCount=g)}async collect(){return this.isExtensionAvailable?this.collectPromise?this.collectPromise:this.collectPromise=new Promise((async g=>{try{this.connectionCount>0&&(this.logger.safe.info(`Stopping logger for gathering, open connections: ${this.connectionCount}`),await this.stopLogging()),await this.storeLogs();const m=await this.gatherFromStorage();this.connectionCount>0&&await this.continueLogging(),g(m.length>0?m.join("\r\n"):"")}catch(m){this.logger.safe.error("Error while collecting logs",m),g(JSON.stringify(m))}this.collectPromise=void 0})):""}async initialStartLogging(){try{await this.startLogging()}catch(g){if(g?.includes("A log is already open"))try{const m=g.match(/State=(\w+)/);await this.cleanState(m?.[1]),await this.startLogging()}catch(g){this.logger.safe.error("Error while starting logging at cleanup phase",g),this.loggingState="unknown"}else this.logger.safe.error("Error while starting logging",g),this.loggingState="unavailable"}}async continueLogging(){try{await this.startLogging()}catch(g){this.logger.safe.error("Error while continuing logging",g),this.loggingState="stopped"}}async startLogging(){await this.sendMessage(this.extensionId,{method:"logging.start"}),this.logger.safe.info("Logging started"),this.loggingState="started"}async cleanState(g){try{if("started"===g)await this.stopLogging(),await this.discardLogs();else{if("stopped"!==g)throw new Error(`Unexpected logging state: ${g}`);await this.discardLogs()}}catch(g){this.logger.safe.error("Error while cleaning state",g)}}async stopLogging(){try{await this.sendMessage(this.extensionId,{method:"logging.stop"}),this.logger.safe.info("Logging stopped"),this.loggingState="stopped"}catch(g){this.logger.safe.error("Error while stopping logging",g)}}async discardLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.discard"}),this.logger.safe.info("Logs discarded"),this.loggingState="closed"}catch(g){this.logger.safe.error("Error while discarding logs",g)}}async storeLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.store",logId:this.logId}),this.logger.safe.info(`Logs stored to ${this.logId}`),this.loggingState="closed"}catch(g){this.logger.safe.error("Error while storing logs",g)}}async gatherFromStorage(){const g=[];let m={offset:0};do{m=await this.sendMessage(this.editorExtensionId,{api:"getWebRtcLog",logId:this.logId,offset:m.offset}),g.push(m.data),this.logger.safe.info(`Batch gathered with offset: ${m.offset}, moreData: ${m.moreData}`)}while(m.moreData);return this.logger.safe.info("Finished gathering"),g}sendMessage(g,m){return new Promise(((S,v)=>{const C=chrome.runtime;C.sendMessage(g,m,(g=>{if(!g||g?.error){const S=g?JSON.stringify(g.error):C.lastError;v(`sendMessage ${JSON.stringify(m)} failed with error: ${S}`)}S(g)}))}))}},HS=(()=>{let g;function getInstance(m,S){return S?.config.enableWebRtcInternalsLogs&&"EdgeAnaheim"===getBrowserInfo().name&&!!chrome?.runtime?(g||(g=new BS(m)),g):(m.safe.info("WebRTC internal logging is disabled"),{collect:()=>Promise.resolve(""),updateSessionCount:()=>Promise.resolve()})}return{getInstance:getInstance}})(),$S=HS,GS=class{getId(){return 0}getDeviceId(){return Ke.EMPTY_DEVICE_ID}getPreviewAsync(g,m){return Promise.resolve(null)}getDescription(){return"display"}getType(){return 1}getIcon(g,m){return Promise.resolve(null)}},jS=class{constructor(g){this.descr=g}getId(){return 0}getDeviceId(){return this.descr.browserId}getPreviewAsync(g,m){return Promise.resolve(null)}getDescription(){return this.descr.label}getType(){return 3}getIcon(g,m){return Promise.resolve(null)}},qS=class{constructor(g){this.deviceManager=g,this.sharingSource=new GS}onScreensChanged(g){return{dispose:()=>{}}}enumerateScreensAsync(){return Promise.resolve([this.sharingSource])}enumerateWindowsAsync(){return Promise.resolve([])}async enumerateCamerasAsync(){return(await this.deviceManager.enumerateDevicesAsync()).filter((g=>"camera"===g.kind)).map((g=>new jS(g)))}},WS=class{constructor(){this.data={records:[],tmpRecords:[],isReconnecting:!1,networkRecoveredCount:0,disconnectedRecoveredCount:0,reconnectCount:{attempted:0,connected:0},retargetCount:{incoming:0,outgoing:0,completed:0,rejected:0},escalationCount:{attempted:0,completed:0,rejected:0}}}registerState(g){const m="connected"===g?this.activeTmpRecord:this.getTmpRecord();m&&m.events[m.events.length-1]?.type!==g&&(m.events.push({type:g,time:Date.now()-m.startTime}),"networkOnline"===g?this.data.networkRecoveredCount++:"connected"===g&&this.data.disconnectedRecoveredCount++,"reconnect"!==g&&"connected"!==g||(m.endTime=Date.now()-m.startTime,this.activeTmpRecord=null))}registerReconnectAttempt(g){this.activeRecord&&(this.activeAttempt={direction:g,startTime:Date.now()-this.activeRecord.startTime,status:!1},this.data.isReconnecting=!0,this.activeRecord.attempts.push(this.activeAttempt))}registerReconnectAttemptStatus(g){"completed"===g&&(this.data.isReconnecting=!1),this.activeAttempt&&this.activeRecord&&(this.activeAttempt.endTime=Date.now()-this.activeRecord.startTime,this.activeAttempt.status="completed"===g)}registerReconnect(g){if(this.data.reconnectCount[g]++,this.data.isReconnecting="attempted"===g,"attempted"===g){if(this.activeRecord)return;this.activeRecord={startTime:Date.now(),attempts:[]},this.data.records.push(this.activeRecord)}else if("connected"===g){if(!this.activeRecord)return;this.activeTmpRecord&&this.registerState("connected"),this.activeRecord.endTime=Date.now()-this.activeRecord.startTime,this.activeRecord=void 0,this.activeAttempt=void 0}}registerRetarget(g){this.data.retargetCount[g]++}registerEscalation(g){this.data.escalationCount[g]++}getObject(){return this.data}getTmpRecord(){return(!this.activeTmpRecord||this.activeTmpRecord.endTime>0)&&(this.activeTmpRecord={startTime:Date.now(),events:[]},this.data.tmpRecords.push(this.activeTmpRecord)),this.activeTmpRecord}},zS=class{constructor(){}process(g){return this.mediaLegId=g||this.mediaLegId||uniqueId().toUpperCase(),this.mediaLegId}},KS=class{constructor(g,m){this.relayManager=g,this.diagnostics=m}initialize(){}setRelayOverride(){}async queryRelaysAsync(g){const m=await this.relayManager.queryRelaysAsync(g);return m.length>0&&(this.diagnostics.relay=m[0]),m}getStats(){return this.relayManager.getStats?.()??{unavailable:"1"}}},JS=class{constructor(g,m,S){this.stats=g,this.diag=m,S&&m&&(S.reconnect=m.getObject())}registerState(g){this.diag?.registerState(g)}registerReconnectAttempt(g){this.stats.registerReconnectAttempt(g),this.diag?.registerReconnectAttempt(g)}registerReconnectAttemptStatus(g){switch(g){case"completed":this.stats.registerReconnectAttemptCompleted();break;case"rejected":this.stats.registerReconnectAttemptRejected()}this.diag?.registerReconnectAttemptStatus(g)}registerReconnect(g){switch(g){case"attempted":this.stats.registerReconnectAttempted();break;case"connected":this.stats.registerReconnectConnected()}this.diag?.registerReconnect(g)}registerRetarget(g){switch(g){case"completed":this.stats.registerRetargetCompleted();break;case"rejected":this.stats.registerRetargetRejected();break;case"incoming":this.stats.registerRetargetIncoming();break;case"outgoing":this.stats.registerRetargetOutgoing()}this.diag?.registerRetarget(g)}registerEscalation(g){switch(g){case"attempted":this.stats.registerEscalationStart();break;case"completed":this.stats.registerEscalationCompleted();break;case"rejected":this.stats.registerEscalationRejected()}this.diag?.registerEscalation(g)}},YS=class{constructor(g){this.initialCallbacks=g,this.queueCallbacks={onTerminated:this.genCallback(this.initialCallbacks.onTerminated),onSessionErrorOccurred:this.genCallback(this.initialCallbacks.onSessionErrorOccurred),onNegotiationRequired:this.genCallback(this.initialCallbacks.onNegotiationRequired),onAudioStateChanged:this.genCallback(this.initialCallbacks.onAudioStateChanged),onAudioHwSilentChanged:this.genCallback(this.initialCallbacks.onAudioHwSilentChanged),onTransportDisconnected:this.genCallback(this.initialCallbacks.onTransportDisconnected),onTransportConnected:this.genCallback(this.initialCallbacks.onTransportConnected),onTransportInitialized:this.genCallback(this.initialCallbacks.onTransportInitialized),onTransportFailed:this.genCallback(this.initialCallbacks.onTransportFailed),onUpdateMediaDescriptionsRequired:this.genCallback(this.initialCallbacks.onUpdateMediaDescriptionsRequired),onTeamsRealtimeTelemetryReport:this.genCallback(this.initialCallbacks.onTeamsRealtimeTelemetryReport)},this.queue=[]}flush(){this.queue.forEach((g=>{g.method.apply(null,g.args)})),this.clear()}clear(){this.queue=[]}genCallback(g){return(...m)=>this.queue.push({method:g,args:m})}},QS=class{constructor(g,m){this.relayConfig=g,this.logger=m}async ensureOnline(){if(0===this.relayConfig.length)return this.logger.safe.warn("No TURN servers defined"),0;if(this.probeDeferred)return this.probeDeferred.promise;this.logger.safe.info(`Starting TURN probes with ${JSON.stringify(this.relayConfig[0].urls)}`),this.checkStart=Date.now();let g=0;this.probeDeferred=defer();const check=async()=>{await this.performCheck()&&this.finalize()},spawnCheckAndScheduleNext=()=>{check(),g<3e3&&(g+=1e3),this.probeTimer=setTimeout(spawnCheckAndScheduleNext,g)};return spawnCheckAndScheduleNext(),this.probeDeferred.promise}finalize(){this.probeTimer&&(clearTimeout(this.probeTimer),this.probeTimer=0),this.probeDeferred&&(this.probeDeferred.resolve(Date.now()-this.checkStart),this.probeDeferred=null)}dispose(){this.finalize()}async performCheck(){this.logger.safe.info("Probing...");const g=this.tryCreatePc();if(!g)return!1;g.createDataChannel("probe");const m=defer();function finalize(S){g.onicecandidate=void 0,g.close(),m.resolve(S)}let S=!1;return g.onicecandidate=g=>{const m=g.candidate;if(!m)return S||this.logger.safe.info("still offline"),void finalize(S);const v=m.type??parseCandidateString(m.candidate).type;"srflx"!==v&&"relay"!==v||(this.logger.safe.info(`Back online through ${v} candidate`),S=!0,"srflx"===v&&(this.ipFromRelay=m.address,finalize(!0)))},await g.setLocalDescription(await g.createOffer()),m.promise}tryCreatePc(){try{return new Us.window.RTCPeerConnection({iceServers:this.relayConfig})}catch(g){return this.logger.safe.info(`Failed to create PC, errCode=${g.code}`),null}}},createIceServers=(g,m)=>g.reduce(((g,S)=>{const v=[],C=S.addresses&&S.addresses[0],_=S.fqdns&&S.fqdns.length>0,E=m.iceUdpAddressType,T=m.iceTcpAddressType,I=m.iceServerTransport;if(!C&&!_)return g;if(I.includes("udp")&&S.udpPort){const g=!_||"fqdn"!==E&&C?C:S.fqdns[0];v.push(`turn:${g}:${S.udpPort}?transport=udp`)}if(I.includes("tcp")&&S.tcpPort){const g=!_||"fqdn"!==T&&C?C:S.fqdns[0];v.push(`turn:${g}:${S.tcpPort}?transport=tcp`)}return I.includes("tls")&&S.tlsPort&&_&&v.push(`turns:${S.fqdns[0]}:${S.tlsPort}`),g.concat({urls:v,credential:S.password,username:S.username})}),[]),createProbeIceServers=(g,m)=>g.reduce(((g,S)=>{const v=[],C=S.addresses&&S.addresses[0],_=S.fqdns&&S.fqdns.length>0,E=m.iceUdpAddressType,T=m.iceServerTransport;if(!C&&!_)return g;if(T.includes("udp")&&S.udpPort){const g=!_||"fqdn"!==E&&C?C:S.fqdns[0];v.push(`stun:${g}:${S.udpPort}`)}return T.includes("tls")&&S.tlsPort&&_&&v.push(`turns:${S.fqdns[0]}:${S.tlsPort}`),g.concat({urls:v,credential:S.password,username:S.username})}),[]),XS=class{constructor(g,m,S,v,C,_,E,T){this.session=g,this.context=m,this.diagnostics=S,this.sessionOperationQueue=v,this.callback=C,this.sessionCallbacks=_,this.configProvider=E,this.relayManager=T,this.wasConnected=!1,this.isDisconnected=!1,this.isReconnectConference=!1,this.escalationType=0,this._isSignalingStable=!0,this.reconnectDelayTime=0,this._isReconnectScheduled=!1,this.isDisposing=!1,this.isWaitingForNetwork=!1,this.onOnline=async()=>{this.logger.safe.info("onOnline: Network is up"),this.diagnostics.registerState("networkOnline"),this.isOnlineDeferred?.resolve(),this.isOnlineDeferred=null},this.onOffline=()=>{this.logger.safe.info("onOffline: Network is down"),this.diagnostics.registerState("networkOffline"),this.isOnlineDeferred=defer4()},this.logger=m.getLogger().createChild("ReconnectManagerV2"),this.ufdManager=m.getUfdManager(),this.session.callbacks=_,this.reconnectManagerMessageQueue=new YS(_),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)}get isOnline(){return!this.isOnlineDeferred}async createRelayProber(){if(!this._relayProber){const g=Date.now(),m=createProbeIceServers(await this.relayManager.queryRelaysAsync({relayType:"turn"}),this.configProvider.config),S=Date.now()-g;this.logger.safe.info(`RelayProber configuration fetched in ${S} ms`),S>5e3&&this.diagnostics.registerState("relayConfigFetched"),this._relayProber=new QS(m,this.logger.createChild("RelayProber"))}return this._relayProber}dispose(){this.isDisposing=!0,window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline),this._relayProber?.dispose(),this.isOnlineDeferred?.reject(new Error("dispose")),this.reconnectTimer&&this.resetReconnectTimer()}get settings(){return(this.reconnectSession||this.session).getSessionConfig().config}getCurrentSession(){return this.reconnectSession||this.session}getMainSession(){return this.session||this.reconnectSession}getReconnectSession(){return this.reconnectSession}async onIceDisconnect(g){if(this.wasConnected)this.raiseReconnectEvent("Bad",g);else if(!this.settings.reconnectWithNoRelays&&!this.session.hasRelayCandidates())return void this.onReconnectFailed("no relays",g);if(this.isDisconnected=!0,!this.isReconnecting()&&!this.isWaitingForNetwork)return this.logger.safe.info(`[${g}] reconnect attempt after iceDisconnect error`),this.session.isFailed()&&this.diagnostics.registerState("failed"),this.diagnostics.registerReconnect("attempted"),this.reconnectAsync(g)}onTransportDisconnect(g){this.isDisconnected=!0,this.wasConnected&&(this.diagnostics.registerState("disconnected"),this.handleTmpConnectivityLoss(g))}onConnected(g){this.isDisconnected=!1,this.logger.safe.info(`[${g}] set allow UFD`),this.diagnostics.registerState("connected"),this.raiseReconnectEvent("Good",g),this.wasConnected=!0,this._relayProber?.finalize()}onNegotiationCompletedAsync(g){return this.logger.safe.info(`[${g}] handle negotiation completed`),this.setSignalingState(!0),this.isReconnecting()&&(this.diagnostics.registerRetarget("completed"),2===this.escalationType&&this.blockCurrentSession(g)),Promise.resolve()}async onSessionErrorOccurred(g,m){this.logger.safe.info(`[${m}] handle session error`,stringifyObject(g)),await this.rejectReconnect(m),this.isReconnectAllowed()?await this.scheduleReconnectRetry(m,!1,!1):this.callback.onSessionErrorOccurred(g,m,this.wasConnected)}onNegotiationRejection(g,m){this.logger.safe.info(`[${m}] handle negotiation rejection`),this.diagnostics.registerRetarget("rejected");const S=1===this.escalationType;return this.rejectReconnect(m).then((()=>{const v=g.type===Ke.RENEGOTIATION_ERROR.glare&&S;(g.type!==Ke.RENEGOTIATION_ERROR.glare||S)&&(this.isRecoverableError(g.type)||v?this.scheduleReconnectRetry(m,v,S):this.onReconnectFailed(stringifyObject(g),m))}))}async ensureNetwork(g){const m=this.isOnline;if(!this.isOnline){this.logger.safe.info(`[${g}] waiting for network...`);try{await this.isOnlineDeferred.promise}catch(m){return void this.logger.safe.info(`${g} call disposed while waiting for network`)}this.logger.safe.info(`[${g}] network seems up`)}if(this.isDisconnected){const S=await this.createRelayProber(),v=await S.ensureOnline();this.logger.safe.info(`[${g}] probing complete in ${v} ms`),this.diagnostics.registerState("relaysUp"),m&&v<1e3&&this.logger.safe.info(`[${g}] looks like network failed on remote side, recovery was quick`)}}oldSessionIsOnline(g){return!!this.session?.isConnected()&&(this.logger.safe.info(`[${g}] old session recovered`),this.isReconnecting()||this.diagnostics.registerReconnect("connected"),!0)}async waitForNetworkAndTryLightweightRecovery(g){const m=this.oldSessionIsOnline(g);if(m||!this.settings.reconnectWithProbes)return m;this.setReconnectTimer(),this.isWaitingForNetwork=!0;const S=this.getMaxNetworkWaitTime();return this.logger.safe.info(`[${g}] can wait up to ${S} ms`),await Promise.race([this.ensureNetwork(g),delay(S)]),this.isWaitingForNetwork=!1,this.session&&(this.session.isConnected()||this.session.isFailed()||(this.logger.safe.info(`[${g}] giving session a moment to recover`),await delay(this.settings.reconnectWaitTimeAfterProbe)),this.oldSessionIsOnline(g))?(this.resetReconnectTimer(),!0):this.checkIfTimerFailed(g)?(this.logger.safe.info(`[${g}] session reconnect timer reached during network checks`),!0):!!this.isDisposing&&(this.logger.safe.info(`[${g}] session is disposed`),!0)}reconnectAsync(g,m=!1,S=!1){return this.logger.safe.info(`[${g}] queueing reconnect, force=${m}, escalation=${S}`),this.diagnostics.registerReconnectAttempt(S?"local escalation":"out"),this._isReconnectScheduled=!0,S&&(this.escalationType=1),this.sessionOperationQueue.queueOperation((async()=>{if(this._isReconnectScheduled=!1,!m){if(await this.waitForNetworkAndTryLightweightRecovery(g))return void this.sessionOperationQueue.completeCurrentOperation()}if(this.isReconnecting())return this.logger.safe.info(`[${g}] ongoing reconnect is in progress`),void this.sessionOperationQueue.completeCurrentOperation();this.diagnostics.registerState("reconnect"),await this.initReconnect(g),await this.reconnectSession.configureModalitiesAsync(this.getConfiguredModalities(),g),this.sessionOperationQueue.completeCurrentOperation()}),g)}async acceptReconnectStartAsync(g,m){return this.logger.safe.info(`[${m}] accepting reconnect`),this.diagnostics.registerRetarget("incoming"),g?(this.escalationType=2,this.diagnostics.registerEscalation("attempted")):(!this.isReconnecting()&&this.isDisconnected?this.diagnostics.registerReconnect("attempted"):this.isReconnecting()&&await this.rejectReconnect(m),this.diagnostics.registerState("reconnect"),this.diagnostics.registerReconnectAttempt("in")),this.initReconnect(m)}acceptReconnectFinish(g){const m=this.getConfiguredModalities();return this.reconnectSession.configureModalitiesAsync(m,g).then((()=>m))}isReconnecting(){return!!this.reconnectSession}isReconnectScheduled(){return this._isReconnectScheduled}cleanUp(){this.sessionCallbacks=null,this.reconnectSession=null}async terminateAsync(g){try{await(this.session?.terminate(g,{}))}catch{}try{await this.terminateReconnectSessionAsync(g,!0)}catch{}this.cleanUp()}completeReconnect(g){return this.logger.safe.info(`[${g}] completing reconnect`),2===this.escalationType&&(this.unblockCurrentSession(),this.diagnostics.registerEscalation("completed")),this.escalationType=0,this.reconnectSession&&(this.context.config.isConference=this.isReconnectConference,this.disposeActiveSession(g),this.session=this.reconnectSession,this.reconnectManagerMessageQueue.clear(),this.diagnostics.registerReconnectAttemptStatus("completed"),this._isSignalingStable||this.diagnostics.registerRetarget("completed"),this.isDisconnected&&this.diagnostics.registerReconnect("connected"),this.resetReconnectTimer(),this.reconnectDelayTime=0,this.reconnectSession=null,this.negotiationPausePromise=null,this.session.callbacks=this.sessionCallbacks||{}),Promise.resolve()}async rejectReconnect(g){this.logger.safe.info(`[${g}] rejecting reconnect`),this.setSignalingState(!1),2===this.escalationType&&this.diagnostics.registerEscalation("rejected"),this.escalationType=0,this.reconnectSession&&(await this.terminateReconnectSessionAsync(g,!1),this.diagnostics.registerReconnectAttemptStatus("rejected")),this.session&&(this.reconnectManagerMessageQueue.flush(),this.session.callbacks=this.sessionCallbacks,this.unblockCurrentSession())}configureModalitiesAsync(g,m){this.lastKnownConfiguredModalities=g;const S=[];return this.session&&S.push(this.session.configureModalitiesAsync(g,m)),this.reconnectSession&&S.push(this.reconnectSession.configureModalitiesAsync(g,m)),Promise.all(S).then((()=>Promise.resolve()))}canSendDtmf(){return this.getMainSession().canSendDtmf()}getExtensionsManager(){return this.getMainSession().getExtensionsManager()}muteHold(g,m){this.getMainSession().muteHold(g,m)}muteInputAsync(g){return this.getMainSession().muteInputAsync(g)}unmuteInputAsync(g){return this.getMainSession().unmuteInputAsync(g)}muteOutputAsync(g){return this.getMainSession().muteOutputAsync(g)}unmuteOutputAsync(g){return this.getMainSession().unmuteOutputAsync(g)}_deviceSelectionChanged(){this.session&&this.session.deviceSelectionChanged(),this.reconnectSession&&this.reconnectSession.deviceSelectionChanged()}disposeActiveSession(g){if(this.session&&this.isReconnecting()){this.logger.safe.info(`[${g}] About to dispose current session...`);const m=this.session;return this.lastKnownConfiguredModalities=this.session.getConfiguredModalities(),m.callbacks=this.reconnectManagerMessageQueue.queueCallbacks,m.move(this.reconnectSession,g),this.session=null,m.terminate(g,{},!1)}return Promise.resolve()}registerRetargetOutgoing(){this.diagnostics.registerRetarget("outgoing")}isSignalingStable(){return this._isSignalingStable}getConfiguredModalities(){return this.getMainSession().getConfiguredModalities()||this.lastKnownConfiguredModalities}checkIfTimerFailed(g){return!(this.isReconnectAllowed()||this.session&&!this.session.isFailed())&&(this.onReconnectFailed("the time limit was reached",g),!0)}async scheduleReconnectRetry(g,m,S){const v=this.getReconnectDelayTime();if(this.logger.safe.info(`[${g}}] scheduling reconnect retry attempt in ${v}`),await delay(v),m||!this.checkIfTimerFailed(g))return this.reconnectAsync(g,S,S)}isRecoverableError(g){return Ke.RENEGOTIATION_ERROR.media===g||Ke.RENEGOTIATION_ERROR.signaling===g}async resetReconnectSession(g){this.logger.safe.info(`[${g}] Resetting reconnect session. Session exists: old: ${!!this.session}, new: ${!!this.reconnectSession}`),this.isReconnectConference=0!==this.escalationType||this.context.config.isConference;const m=0!==this.escalationType||this.context.config.isConference&&this.wasConnected&&!this.isDisconnected,S=this.getMainSession(),v=this.configProvider.getConfigView(this.isReconnectConference,S.getSessionConfig()),C=S.clone(m,v);C.callbacks={...this.sessionCallbacks,onTransportConnected:g=>{2!==this.escalationType&&this.completeReconnect(g),this.raiseReconnectEvent("Good",g),this.sessionCallbacks.onTransportConnected(g)}},this.session&&(this.session.callbacks={...this.reconnectManagerMessageQueue.queueCallbacks,onSessionErrorOccurred:(g,m)=>(g.type!==Ke.MEDIA_ERROR.iceConnectionError&&this.reconnectManagerMessageQueue.queueCallbacks.onSessionErrorOccurred(g,m),Promise.resolve())}),this.reconnectSession&&(this.reconnectSession.move(C,g),this.logger.safe.info(`[${g}] reconnect session still exists during reconnect clone operation`),await this.terminateReconnectSessionAsync(g,!1)),this.logger.safe.info(`[${g}] New session reset.`),this.reconnectSession=C}async initReconnect(g){this.logger.safe.info(`[${g}] initiate reconnect`),this.setReconnectTimer(),await this.resetReconnectSession(g),this.setSignalingState(!1),this.session&&(this.blockCurrentSession(g),await Promise.all([this.reconnectSession.muteInputAsync(g),this.reconnectSession.muteOutputAsync(g)]))}blockCurrentSession(g){this.negotiationPausePromise=this.session.pauseNegotiations(g)}unblockCurrentSession(){this.negotiationPausePromise&&(this.negotiationPausePromise.resolve(),this.negotiationPausePromise=null)}raiseReconnectEvent(g,m){this.ufdManager.signalEvent("NetworkReconnect",g,"Audio",!0,m)}async terminateReconnectSessionAsync(g,m){if(this.reconnectSession){const S=new YS(this.sessionCallbacks);this.reconnectSession.callbacks={...S.queueCallbacks,onTerminated:m?this.sessionCallbacks.onTerminated:S.queueCallbacks.onTerminated},await this.reconnectSession.terminate(g,{},!1),S.clear(),this.reconnectSession=null}}setReconnectTimer(){const g=this.wasConnected?this.settings.reconnectTimeLimit:this.settings.initialReconnectTimeLimit;g>0&&!this.reconnectTimer&&(this.reconnectTimerStart=Date.now(),this.reconnectTimer=window.setTimeout((()=>this.resetReconnectTimer()),g))}resetReconnectTimer(){clearTimeout(this.reconnectTimer),this.reconnectTimer=null}isReconnectAllowed(){return!!this.reconnectTimer&&!this.isDisposing}getReconnectDelayTime(){return 1e3*Math.min(++this.reconnectDelayTime,this.settings.maxReconnectDelayTime)}getMaxNetworkWaitTime(){const g=this.reconnectTimerStart>0?Date.now()-this.reconnectTimerStart:0;return Math.max(this.settings.reconnectTimeLimit-g,0)}onReconnectFailed(g,m){this.callback.onSessionErrorOccurred({type:Ke.MEDIA_ERROR.iceConnectionError,detail:`Reconnect failed, error - ${stringifyObject(g)}`},m,this.wasConnected)}setSignalingState(g){this._isSignalingStable=g}async handleTmpConnectivityLoss(g){this.logger.safe.info(`[${g}] Session went into disconnected state, giving it ${this.settings.losingConnectivityTimeoutMs}ms to recover`),-1!==this.settings.losingConnectivityTimeoutMs&&(await delay(this.settings.losingConnectivityTimeoutMs),this.isDisconnected&&this.raiseReconnectEvent("Poor",g)),this.isDisconnected&&this.settings.reconnectOnDisconnect&&(this.logger.safe.info(`[${g}] Session is still down, triggering reconnect`),this.onIceDisconnect(g))}},ZS=class{constructor(g,m){this.stats=g,this.diagnostics=m}set mediaLegId(g){this.stats.setMediaLegId(g.process()),this.diagnostics&&(this.diagnostics.mediaLegId=g)}set isMultiParty(g){g&&this.stats.setMultiParty(),this.diagnostics&&(this.diagnostics.isMultiParty=g)}set allowedModalities(g){this.stats.setSendModalities(g),this.diagnostics&&(this.diagnostics.allowedModalities=g)}set sessionError(g){this.stats.setError(g),this.diagnostics&&(this.diagnostics.sessionError=g)}set finalAnswerTime(g){this.stats.setFinalAnswerTimestamp(g),this.diagnostics&&(this.diagnostics.finalAnswerTime=g)}set dtmfResult(g){this.stats.dtmfResult(g),this.diagnostics&&(this.diagnostics.dtmfResult=g)}set swMute(g){this.stats.setSwMute(g),this.diagnostics&&(this.diagnostics.swMute=g)}set speakerMute(g){this.stats.setSpeakerMute(g),this.diagnostics&&(this.diagnostics.speakerMute=g)}set hwSilent(g){this.stats.setHwSilent(g),this.diagnostics&&(this.diagnostics.hwSilent=g)}set isSpeaking(g){this.stats.setSpeakingState(g),this.diagnostics&&(this.diagnostics.isSpeaking=g)}set iceConnectedStateTimestamp(g){this.stats.setIceConnectedStateTimestamp(g),this.diagnostics&&(this.diagnostics.iceConnectedStateTimestamp=g)}set iceInitTime(g){this.stats.setIceInitTimestamp(g),this.diagnostics&&(this.diagnostics.iceInitTime=g)}set ETag(g){this.stats.setETag(g),this.diagnostics&&(this.diagnostics.ETag=g)}set configIds(g){this.stats.setConfigIds(g),this.diagnostics&&(this.diagnostics.configIds=g)}set relay(g){this.stats.setRelay(g),this.diagnostics&&(this.diagnostics.relay=g)}negotiationStart(g){switch(this.diagnostics?.negotiationStart(g),g){case"Offering":this.stats.negotiation.offering.started();break;case"Answering":this.stats.negotiation.answering.started()}}negotiationCompleted(g){this.stats.negotiation.current.completed(g),this.diagnostics?.negotiationCompleted(g)}negotiationRejected(){this.stats.negotiation.current.rejected(),this.diagnostics?.negotiationRejected()}registerTransportConnected(){this.stats.registerTransportConnected(),this.diagnostics?.registerTransportConnected()}registerTransportDisconnected(){this.stats.registerTransportDisconnected(),this.diagnostics?.registerTransportDisconnected()}registerTransportFailed(){this.stats.registerTransportFailed(),this.diagnostics?.registerTransportFailed()}registerRollbackEvent(g){this.stats.registerRollbackEvent(g),this.diagnostics?.registerRollbackEvent(g)}registerRawMediaAccess(g,m,S){"send"===m?this.stats.registerSetInputRawMedia(S):this.stats.registerOutputRawMediaAccess(),this.diagnostics?.registerRawMediaAccess(g,m,S)}registerQualityStateChangedEvent(g){this.stats.registerQualityStateChangedEvent(g),this.diagnostics?.registerQualityStateChangedEvent(g)}terminated(g){this.stats.terminated(g),this.diagnostics?.terminated(g)}},ev=class{constructor(g){this.logger=g,this.operationQueue=null,this.currentOperationDeferred=null,this.operationQueue=new Ap(this.logger)}queueOperation(g,m=generateCauseId()){this.logger.safe.info(`[${m}] queueing operation`);const S=new or,v=this.operationQueue.add((()=>(this.currentOperationDeferred=S,g())),m);return this.operationQueue.add(S,m),v}completeCurrentOperation(){this.currentOperationDeferred&&(this.logger.safe.info("completing operation"),this.currentOperationDeferred.resolve())}},tv=class extends je{constructor(g,m,S,v,C,_,E,T=S.getLogger().createChild("SessionV2",m)){super(T),this.session=g,this.context=S,this.callback=v,this.statistics=C,this.configProvider=_,this.diagnostics=E,this.logger=T,this.audioStreamStates={[Ke.STREAMING_STATE.inactive]:[Ke.STREAMING_STATE.started,Ke.STREAMING_STATE.active,Ke.STREAMING_STATE.failed],[Ke.STREAMING_STATE.started]:[Ke.STREAMING_STATE.active,Ke.STREAMING_STATE.removed,Ke.STREAMING_STATE.stopped,Ke.STREAMING_STATE.failed],[Ke.STREAMING_STATE.active]:[Ke.STREAMING_STATE.removed,Ke.STREAMING_STATE.stopped,Ke.STREAMING_STATE.failed]},this.mediaLegId=new zS,this.rejectedNegotiations=0,this.negotiationState=null,this.audioStreamState=Ke.STREAMING_STATE.inactive,this.deviceManagerDisposables=[],this.visibilityChangedHandler=()=>{if(this.logger.safe.debug(`document.visibilityState changed: ${document.visibilityState}`),"visible"===document.visibilityState&&this.pcClosedInfo){const g=this.pcClosedInfo;this.pcClosedInfo=null,Date.now()<g.timestamp+this.configProvider.config.reconnectWakeupTimeLimit?(this.logger.safe.info(`[${g.causeId}] start reconnect after wakeup`),this.startReconnect(g.causeId)):(this.logger.safe.info(`[${g.causeId}] terminate a call after wakeup because allowed time limit for reconnect exceeded`),this.endCallOnFailure(g.mediaError,g.causeId))}},this.ufdManager=S.getUfdManager(),this.ufdManagerDisposable=this.ufdManager.on("onQualityChanged",(g=>this.qualityChanged(g))),this.sessionOperationQueue=new ev(this.logger),this.mediaLegId=new zS,this.diagnosticsWrapper=new ZS(this.statistics,this.diagnostics),this.statistics.setId(m),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.diagnosticsWrapper.ETag=this.configProvider.ETag,this.diagnosticsWrapper.configIds=this.configProvider.ecsConfigIds,this.diagnosticsWrapper.isMultiParty=!!S.config.isConference,this.recoverableErrors=this.configProvider.config.recoverableMediaErrors.split(","),this.forceReconnectErrors=this.configProvider.config.forceReconnectErrors.split(",");const I=this.getSessionCallbacks();g.callbacks=I,g.relayManagerProvider=this,this.reconnectManager=new XS(g,S,new JS(this.statistics,this.diagnostics?new WS:void 0,this.diagnostics),this.sessionOperationQueue,this.getReconnectManagerCallbacks(),I,this.configProvider,this.getRelayManager()),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesPermissionChanged",(()=>this.diagnosticsWrapper.allowedModalities=this.getAllowedModalities()))),this.deviceManagerDisposables.push(this.deviceManager.on("onSelectedDevicesChanged",(()=>this.deviceSelectionChanged()))),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesChanged",((g,m)=>this.deviceListChanged(m)))),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount()),this.ufdManager.applyCurrentState((g=>this.qualityChanged(g))),document.addEventListener("visibilitychange",this.visibilityChangedHandler),this.requestWakeLock()}async requestWakeLock(){if(Vs.isWakeLockSupported()&&this.configProvider.config.useWakeLockApi)try{this.wakeLock=await window.navigator.wakeLock.request("screen")}catch(g){this.logger.safe.info(`Wakelock request failed - ${g.message}`)}}enableTeamsRealTimeTelemetry(){this.realtimeTelemetryInterval||(this.logger.safe.info("teams realtime telemetry is enabled"),this.getSessionCallbacks().onTeamsRealtimeTelemetryReport(),this.realtimeTelemetryInterval=window.setInterval((()=>{this.getSessionCallbacks().onTeamsRealtimeTelemetryReport()}),1e3*this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval))}getMediaStatsReport(){return this.diagnostics?.mediaStatsReport}createOfferAsync(g){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Offering");try{const m=await this.getCurrentSession().createOfferAsync(g);return this.updateSelectedDevices(),m.mediaLegId=this.mediaLegId.process(m.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.reconnectManager.isReconnecting()&&!this.reconnectManager.isSignalingStable()&&(this.reconnectManager.registerRetargetOutgoing(),m.newOffer=!0),m}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}),g)}setCallConstraints(g,m){return this.getCurrentSession().setCallConstraints(g,m)}processOfferAsync(g,m){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Answering"),g.mediaLegId=this.mediaLegId.process(g.mediaLegId);try{g.newOffer&&await this.reconnectManager.acceptReconnectStartAsync(g.escalationOccurring,m);const S=await this.getCurrentSession().processOfferAsync(g,m);if(g.newOffer){const g=await this.reconnectManager.acceptReconnectFinish(m);return S.sharing===Ke.MEDIA_STATE.sendReceive&&(S.sharing=g.sharing===Ke.MEDIA_STATE.send?Ke.MEDIA_STATE.send:Ke.MEDIA_STATE.receive),S}return S}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}),m)}async processAnswerAsync(g,m,S,v){try{return await this.getCurrentSession().processAnswerAsync(g,m,S,v)}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}async completeNegotiationAsync(g){this.rejectedNegotiations=0;try{const m=await this.getCurrentSession().completeNegotiationAsync(g);return this.negotiationState=m,this.diagnosticsWrapper.finalAnswerTime=Date.now(),this.diagnosticsWrapper.negotiationCompleted?.(m.activeModalities),await this.reconnectManager.onNegotiationCompletedAsync(g),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}ignoreNotReconnectError(g){return g.detail?.type!==Ke.MEDIA_ERROR.incompatibleOriginator}async rejectNegotiationAsync(g,m){this.logger.safe.info(`[${m}] rejectNegotiationAsync`,g);try{if(this.reconnectManager.isReconnecting()&&this.ignoreNotReconnectError(g))return await this.reconnectManager.onNegotiationRejection(g,m),this.registerNegotiationRejection(this.negotiationState),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState;{const S=await this.getCurrentSession().rejectNegotiationAsync(g,m,this.isRenegotiationAllowed(g.type));return this.sessionOperationQueue.completeCurrentOperation(),this.registerNegotiationRejection(S),S}}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}completeEscalationAsync(g){return this.reconnectManager.completeReconnect(g)}rejectEscalationAsync(g){return this.reconnectManager.rejectReconnect(g)}async terminate(g,m){this.logger.safe.info(`terminate reject reason: ${JSON.stringify(m||"")}`),this.registerVideoEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Video","StatsQuery")),this.registerAudioEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Audio")),this.statistics.setPermissionStates(await this.deviceManager.getKnownPermissionStates()),this.diagnosticsWrapper.terminated(m);const always=()=>this.cleanUp();return this.reconnectManager.terminateAsync(g).then(always,always)}async getStatsAsync(g){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.getMainSession().getStatsAsync(g).then((g=>this.prepareStats(g)))}getLastKnownStats(g=!1){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.prepareStats(this.getMainSession().getLastKnownStats(g),g)}getCallTechnicalInfo(){return this.diagnostics?.realtimeTelemetryReport}async createAnswerAsync(g,m){try{const S=await this.getCurrentSession().createAnswerAsync(g,m);return this.updateSelectedDevices(),S.mediaLegId=this.mediaLegId.process(S.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,S}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}configureModalitiesAsync(g,m){return forOwn(g,((m,S)=>{m||delete g[S]})),this.reconnectManager.configureModalitiesAsync(g,m)}getAllowedModalities(){return this.deviceManager.getAllowedModalities()}createRemoteRenderer(g){return this.getMainSession().createRemoteRenderer(g)}async sendDtmf(g){try{const m=await this.getMainSession().sendDtmf(g);return this.diagnosticsWrapper.dtmfResult=!0,m}catch(g){throw this.diagnosticsWrapper.dtmfResult=!1,g}}canSendDtmf(){return this.reconnectManager.canSendDtmf()}getExtensionsManager(){return this.reconnectManager.getExtensionsManager()}muteHold(g,m){this.reconnectManager.muteHold(g,m)}muteInputAsync(g){return this.diagnosticsWrapper.swMute=!0,this.ufdManager.setSwMute(!0),this.reconnectManager.muteInputAsync(g)}unmuteInputAsync(g){return this.diagnosticsWrapper.swMute=!1,this.ufdManager.setSwMute(!1),this.reconnectManager.unmuteInputAsync(g)}muteOutputAsync(g){return this.diagnosticsWrapper.speakerMute=!0,this.reconnectManager.muteOutputAsync(g)}unmuteOutputAsync(g){return this.diagnosticsWrapper.speakerMute=!1,this.reconnectManager.unmuteOutputAsync(g)}getAcceptedTypes(){return this.reconnectManager.getCurrentSession().getAcceptedTypes()}useNullAudioStreamClient(){this.getCurrentSession().useNullAudioStreamClient()}createAudioElement(g){this.getCurrentSession().createAudioElement(g)}getIncomingRawAudioStream(){return this.diagnosticsWrapper.registerRawMediaAccess("audio","recv",!0),this.getCurrentSession().getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.getCurrentSession().getUnmixedAudioProvider()}deviceSelectionChanged(){this.updateSelectedDevices(),this.reconnectManager._deviceSelectionChanged()}registerDeviceTelemetryEvent(g){this.getCurrentSession().onDeviceEvent(g),this.statistics.registerDeviceTelemetryEvent(g)}registerVideoEffectsTelemetryEvent(g){this.statistics.registerVideoEffectsTelemetryEvent(g)}registerAudioEffectsTelemetryEvent(g){this.statistics.registerAudioEffectsTelemetryEvent(g)}reconnectAsync(g,m=!1){return this.reconnectManager.reconnectAsync(g,!0,m)}isReconnecting(){return this.reconnectManager.isReconnecting()}getRelayManager(){return this.relayManager??(this.relayManager=new KS(this.context.maContext.getRelayManager(),this.diagnosticsWrapper))}getSessionConfig(){return this.reconnectManager.getCurrentSession().getSessionConfig()}getDiagnostics(){return this.diagnostics}getLocalMediaTrackId(g){return this.reconnectManager.getMainSession().getLocalMediaTrackId(g)}getSubscriptionManager(){return this.getCurrentSession().getSubscriptionManager()}getDisabledModalities(){return this.getCurrentSession().getDisabledModalities()}configureSpatialAudio(g,m){this.getCurrentSession().configureSpatialAudio(g,m)}setParticipantSpatialAudioPositions(g,m){this.getCurrentSession().setParticipantSpatialAudioPositions(g,m)}startMediaDescriptionsUpdateAsync(g){return this.getCurrentSession().startMediaDescriptionsUpdateAsync(g)}completeMediaDescriptionsUpdateAsync(g){return this.getCurrentSession().completeMediaDescriptionsUpdateAsync(g)}rejectMediaDescriptionsUpdateAsync(g,m){return this.getCurrentSession().rejectMediaDescriptionsUpdateAsync(g,m)}processNotification(g,m){this.session.processNotification(g,m)}async cleanUp(){this.callback=null,this.deviceManagerDisposables.forEach((g=>g.dispose())),this.ufdManagerDisposable.dispose(),this.reconnectManager.dispose(),this.pcClosedInfo=null,document.removeEventListener("visibilitychange",this.visibilityChangedHandler),window.clearInterval(this.realtimeTelemetryInterval),this.wakeLock&&(await this.wakeLock.release(),this.wakeLock=null)}updateSelectedDevices(){const g=this.deviceManager.getSelectedDevices(),getDeviceName=g=>g?this.deviceManager.getDeviceNameAsync(g).then((g=>scrubDeviceLabelPii(g,this.configProvider.config.devices.piiSafeWords))):Promise.resolve("none");Promise.all([getDeviceName(g.microphone),getDeviceName(g.speaker),getDeviceName(g.camera)]).then((([g,m,S])=>{this.statistics.setUsedDevices({microphone:g,speaker:m,camera:S})}))}getCurrentSession(){return this.reconnectManager.getCurrentSession()}getMainSession(){return this.reconnectManager.getMainSession()}setAudioStreamState(g,m){this.isAudioStateValid(g)?this.raiseAudioStateChanged(g,m):this.logger.safe.error(`[${m}] audio state transition is invalid: ${this.audioStreamState} -> ${g}`)}isAudioStateValid(g){return this.audioStreamStates[this.audioStreamState].indexOf(g)>=-1}raiseAudioStateChanged(g,m){if(this.logger.safe.info(`[${m}] audio state changed to ${g}`),this.callback.onAudioStateChanged){const m={content:"audio",direction:"receive",stream:g};this.callback.onAudioStateChanged(m)}}getReconnectManagerCallbacks(){return{onSessionErrorOccurred:(g,m,S)=>{this.isNetworkMediaError(g)&&!S&&this.ufdManager.raisePendingWhitelistingUFD(),this.endCallOnFailure(g,m)}}}isNetworkMediaError(g){return g.type===Ke.MEDIA_ERROR.iceConnectionError||g.type===Ke.MEDIA_ERROR.noNetworkError}isRecoverableMediaError(g){return this.recoverableErrors.includes(g.type)}startReconnect(g=generateCauseId()){return this.reconnectManager.onIceDisconnect(g)}shouldForceReconnect(g){return this.forceReconnectErrors.includes(g.type)}isUnexpectedPcClose(g){return g.type===Ke.MEDIA_ERROR.unexpectedClose}getSessionCallbacks(){return this.sessionCallbacks||(this.sessionCallbacks={onTerminated:()=>{this.logger.safe.warn("call onTerminated"),this.event("onTerminated").raise(this)},onSessionErrorOccurred:(g,m=generateCauseId())=>this.isUnexpectedPcClose(g)?this.handlePcClosed(g,m):this.shouldForceReconnect(g)?this.reconnectManager.reconnectAsync(m,!0):this.isRecoverableMediaError(g)?this.reconnectManager.isReconnecting()?this.reconnectManager.onSessionErrorOccurred(g,m):this.startReconnect(m):(this.endCallOnFailure(g,m),Promise.resolve()),onNegotiationRequired:g=>this.callback.onNegotiationRequired(g),onAudioHwSilentChanged:g=>{this.diagnosticsWrapper.hwSilent=g},onAudioStateChanged:(g,m)=>{this.setAudioStreamState(g,m)},onTransportConnected:(g=generateCauseId())=>{this.logger.safe.info(`[${g}] Transport connectivity established`),this.ufdManager.cancelPendingWhitelistingUFD(),this.reconnectManager.onConnected(g),this.diagnosticsWrapper.registerTransportConnected(),this.diagnosticsWrapper.iceConnectedStateTimestamp=Date.now(),this.callback?.onTransportConnected(g)},onTransportDisconnected:(g=generateCauseId())=>{this.logger.safe.warn(`[${g}] Transport connectivity lost`),this.reconnectManager.onTransportDisconnect(g),this.diagnosticsWrapper.registerTransportDisconnected()},onTransportFailed:()=>{this.diagnosticsWrapper.registerTransportFailed()},onTransportInitialized:()=>{this.diagnosticsWrapper.iceInitTime=Date.now()},onUpdateMediaDescriptionsRequired:g=>this.callback.onUpdateMediaDescriptionsRequired(g),onTeamsRealtimeTelemetryReport:()=>this.callback.onRealtimeTelemetryReport()}),this.sessionCallbacks}registerNegotiationRejection(g){this.rejectedNegotiations++,this.diagnosticsWrapper.negotiationRejected?.(),g.rollback&&this.diagnosticsWrapper.registerRollbackEvent(g.rollback)}isRenegotiationAllowed(g){return this.rejectedNegotiations<this.context.configProvider.config.renegotiationAttempts&&!this.reconnectManager.isReconnectScheduled&&(Ke.RENEGOTIATION_ERROR.signaling===g||Ke.RENEGOTIATION_ERROR.media===g)}prepareStats(g,m=!1){this.statistics.setDeviceList(this.deviceManager.getDeviceDescriptions(),this.deviceManager.getDeviceListDebugInfo()),this.statistics.setRelayManagerTimers(this.getRelayManager().getStats()),this.statistics.setVideoEffectStats(this.context.callDeviceManager.getDeviceManager("Video").effectsManager.getStats("Video","StatsQuery")),this.statistics.setAudioEffectStats(this.deviceManager.effectsManager.getStats("Audio"));const S=this.statistics.generateStatistics(g,this.mediaLegId,m);return this.configProvider.config.diagnostics.features.useNewerStatisticsMetrics&&(S.data.metrics=this.diagnostics?.telemetryReport?.data.metrics),S}deviceListChanged(g){g&&this.statistics.deviceChangedByPoll(),this.statistics.devicesChanged(),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount())}qualityChanged(g){const m=g.deviceManagerId;!m||this.context.callDeviceManager.hasDevice(m)?this.callback?.onQualityChanged&&(this.diagnosticsWrapper.registerQualityStateChangedEvent(g),"DeviceSpeakWhileMuted"===g.type&&(this.diagnosticsWrapper.isSpeaking="Good"!==g.value),this.callback.onQualityChanged(g)):this.logger.info(`${m} - is not added to Call, skipping UFD.`)}endCallOnFailure(g,m){this.callback&&(this.callback.onSessionErrorOccurred&&this.callback.onSessionErrorOccurred(g,m),this.diagnosticsWrapper.sessionError=g,this.setAudioStreamState(Ke.STREAMING_STATE.failed,m))}async handlePcClosed(g,m){const S=this.configProvider.config.reconnectWakeupTimeLimit;return this.logger.safe.info(`[${m}] handle unexpected PC closed event`,`visibilityState=${document.visibilityState}, wakeupLimit=${this.configProvider.config.reconnectWakeupTimeLimit}`),"visible"===document.visibilityState?this.startReconnect(m):S?void(this.pcClosedInfo={timestamp:Date.now(),causeId:m,mediaError:g}):this.endCallOnFailure(g,m)}},iv=class{constructor(g){this.creationTime=g,this.records=[],this.activeRecord=null,this.activeAttempt=null,this.reconnectState=!1}getReport(){return this.records.length?JSON.stringify(this.records):""}isReconnecting(){return this.reconnectState}onReconnectStart(){this.reconnectState=!0,this.activeRecord||(this.activeRecord={attempts:[],endTime:null,startTime:Date.now()-this.creationTime},this.records.push(this.activeRecord))}onReconnectAttempt(g){if(!this.activeRecord)return null;this.activeAttempt={direction:g,status:!1,endTime:null,startTime:this.getTimestamp()},this.reconnectState=!0,this.activeRecord.attempts.push(this.activeAttempt)}onReconnectConnected(){if(!this.activeRecord)return null;this.reconnectState=!1,this.activeRecord.endTime=this.getTimestamp(),this.activeRecord=this.activeAttempt=null}onReconnectCompleted(){this.reconnectState=!1,this.resolveReconnectAttempt(!0)}onReconnectRejected(){this.resolveReconnectAttempt(!1)}resolveReconnectAttempt(g){this.activeAttempt&&this.activeRecord&&(this.activeAttempt.status=g,this.activeAttempt.endTime=this.getTimestamp())}getTimestamp(){return Date.now()-this.creationTime-this.activeRecord.startTime}},nv=window.navigator,rv=class{constructor(g="Good"){this.stopWatches=[],this.currentLevel=g,this.getStopWatch(g).start()}updateLevel(g){this.currentLevel!==g&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=g,this.getStopWatch(this.currentLevel).start())}getCount(g){const m=this.stopWatches[g];return m?m.count:0}getElapsed(g){const m=this.stopWatches[g];return m?m.elapsed:0}getStopWatch(g){let m=this.stopWatches[g];return m||(m=new kS,this.stopWatches[g]=m),m}},sv=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\:[0-9]{2,5})?$/),av=RegExp(/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))(:[0-9]{2,5})?$/),ov=class{constructor(g,m,S){this.configProvider=g,this.callNumber=m,this.sessionDiagnostics=S,this.negotiation={offering:this.offering(),answering:this.answering(),current:this.current()},this.creationTime=Date.now(),this.negotiationCount=0,this.initialNegotiationCompleted=!1,this.activeModalities={},this.multiParty=!1,this.noIceCandidatesGoodEventCount=0,this.noIceCandidatesBadEventCount=0,this.noRelayIceCandidatesGoodEventCount=0,this.noRelayIceCandidatesBadEventCount=0,this.cameraInUseBadEventCount=0,this.cameraInUseGoodEventCount=0,this.microphoneInUseBadEventCount=0,this.microphoneInUseGoodEventCount=0,this.cameraFreezeStartEventCount=0,this.cameraFreezeEndEventCount=0,this.networkRecv=new rv,this.networkSend=new rv,this.retargetIncomingCount=0,this.retargetOutgoingCount=0,this.retargetCompletedCount=0,this.retargetRejectedCount=0,this.reconnectAttemptedCount=0,this.reconnectConnectedCount=0,this.escalationAttemptedCount=0,this.escalationCompletedCount=0,this.escalationRejectedCount=0,this.durationTimer=new kS,this.terminationReason={},this.terminationTime=0,this.sessionId="0",this.rejectedNegotiationCount=0,this.mediaError={type:"none",detail:"none"},this.incompatibleOffer=!1,this.dtmfSuccess=0,this.dtmfFailure=0,this.relay=null,this.relayManagerTimers=null,this.allowedAudioSend=!0,this.allowedVideoSend=!0,this.allowedScreensharingSend=!0,this.iceInitTime=0,this.finalAnswerTime=0,this.iceConnectedStateTime=0,this.usedDevices=null,this.deviceSelectionChangeCount=0,this.devicesChangeCount=0,this.devicesPollChangeCount=0,this.mute=new kS,this.osMute=new kS,this.hwSilent=new kS,this.isSpeaking=new kS,this.swMute=new kS,this.speakerMute=new kS,this.deviceTelemetryEvents=[],this.videoEffectsTelemetryEvents=new Fm(this.configProvider.config.effectsTelemetryBufferSize),this.audioEffectsTelemetryEvents=new Fm(this.configProvider.config.effectsTelemetryBufferSize),this.devicesCount=null,this.reconnectStats=new iv(this.creationTime),this.transportDisconnected=!1,this.transportReconnectedCount=0,this.ufds=[],this.mediaQosEnabled=!1,this.portRangeConfigured=!1,this.rollbackNegotiation=[],this.rawOutputAudioAccess={attempt:0,timer:new kS},this.rawInputAudioOverride={attempt:0,timer:new kS},this.connectionEffectiveTypeSeries=new Fm(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionRttSeries=new Fm(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionDownlinkSeries=new Fm(this.configProvider.config.navConnectionNumSamplesToCollect),this.navigatorConnectionInterval=setInterval((()=>{const g=nv?.connection;g&&("number"==typeof g.downlink&&this.connectionDownlinkSeries.add(g.downlink),"number"==typeof g.rtt&&this.connectionRttSeries.add(g.rtt),"number"==typeof g.effectiveType&&this.connectionEffectiveTypeSeries.add(g.effectiveType))}),this.configProvider.config.navConnectionPollingInterval),this.durationTimer.start()}terminated(g){this.terminationReason=deepClone(g),this.terminationTime=Date.now(),this.durationTimer.stop(),this.osMute.stop(),this.swMute.stop(),this.hwSilent.stop(),this.isSpeaking.stop(),this.mute.stop(),this.speakerMute.stop(),this.rawInputAudioOverride.timer.stop(),this.rawOutputAudioAccess.timer.stop(),clearInterval(this.navigatorConnectionInterval)}setMultiParty(){this.multiParty=!0}updateCommonMute(){this.swMute.isRunning||this.osMute.isRunning?this.mute.start():this.mute.stop()}setDeviceList(g,m){this.deviceList=g.map((g=>({label:scrubDeviceLabelPii(g.label,this.configProvider.config.devices.piiSafeWords),kind:g.kind}))),m&&(this.deviceDebugStrings=deepClone(m))}setPermissionStates(g){this.permissionStates=g}setSwMute(g){g?this.swMute.start():this.swMute.stop(),this.updateCommonMute()}setSpeakerMute(g){g?this.speakerMute.start():this.speakerMute.stop()}setHwSilent(g){g?this.hwSilent.start():this.hwSilent.stop()}setSpeakingState(g){g?this.isSpeaking.start():this.isSpeaking.stop()}setETag(g){this.ETag=g}setConfigIds(g){this.configIds=g}setVideoEffectStats(g){g&&this.videoEffectsTelemetryEvents.add(g)}setAudioEffectStats(g){g&&this.audioEffectsTelemetryEvents.add(g)}registerQualityStateChangedEvent(g){switch(g.type){case"NoNetwork":"Good"===g.value?this.noIceCandidatesGoodEventCount++:this.noIceCandidatesBadEventCount++;break;case"NetworkRelaysNotReachable":"Good"===g.value?this.noRelayIceCandidatesGoodEventCount++:this.noRelayIceCandidatesBadEventCount++;break;case"DeviceCaptureNotFunctioning":"Good"===g.value?this.microphoneInUseGoodEventCount++:this.microphoneInUseBadEventCount++;break;case"VideoCapturerDeviceStartFailed":"Good"===g.value?this.cameraInUseGoodEventCount++:this.cameraInUseBadEventCount++;break;case"DeviceCaptureMute":"Audio"===g.mediaType&&("Bad"===g.value?this.osMute.start():this.osMute.stop(),this.updateCommonMute());break;case"NetworkRecvQuality":this.networkRecv.updateLevel(g.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(g.value);break;case"VideoCaptureDeviceFreeze":"Good"===g.value?this.cameraFreezeEndEventCount++:this.cameraFreezeStartEventCount++}"DeviceSpeakWhileMuted"!==g.type&&this.ufds.push({...g,timestamp:Date.now()-this.creationTime}),this.ufds.length>this.configProvider.config.maxStoredUFDCount&&this.ufds.shift()}registerRetargetIncoming(){this.retargetIncomingCount++}registerRetargetOutgoing(){this.retargetOutgoingCount++}registerRetargetCompleted(){this.retargetCompletedCount++}registerRetargetRejected(){this.retargetRejectedCount++}registerEscalationStart(){this.escalationAttemptedCount++}registerEscalationCompleted(){this.escalationCompletedCount++}registerEscalationRejected(){this.escalationRejectedCount++}registerRollbackEvent(g){g&&this.rollbackNegotiation.push({type:g.type,attempt:this.rollbackNegotiation.length+1,error:g.error?g.error:""})}registerReconnectAttempted(){this.reconnectAttemptedCount++,this.reconnectStats.onReconnectStart()}registerReconnectConnected(){this.reconnectConnectedCount++,this.reconnectStats.onReconnectConnected()}registerDeviceTelemetryEvent(g){g.timestamp=g.timestamp-this.creationTime,this.deviceTelemetryEvents.push(g)}registerVideoEffectsTelemetryEvent(g){g&&(g.timestamp=g.timestamp-this.creationTime,this.videoEffectsTelemetryEvents.add(g))}registerAudioEffectsTelemetryEvent(g){if(g){g.timestamp=g.timestamp-this.creationTime;const m=this.audioEffectsTelemetryEvents.items.pop();m&&this.audioEffectsChanged(m,g)&&this.audioEffectsTelemetryEvents.add(m),this.audioEffectsTelemetryEvents.add(g)}}audioEffectsChanged(g,m){return g.payload.fallback!==m.payload.fallback||(void 0!==m.payload.userNoiseSuppressionMethod&&g.payload.userNoiseSuppressionMethod!==m.payload.userNoiseSuppressionMethod||void 0!==m.payload.userAudioEffect&&g.payload.userAudioEffect!==m.payload.userAudioEffect)}registerReconnectAttempt(g){this.reconnectStats.onReconnectAttempt(g)}registerReconnectAttemptCompleted(){this.reconnectStats.onReconnectCompleted()}registerReconnectAttemptRejected(){this.reconnectStats.onReconnectRejected()}setMediaLegId(g){this.mediaLegId=g}setId(g){this.sessionId=g}setError(g){g.type===Ke.MEDIA_ERROR.incompatibleOffer&&(this.incompatibleOffer=!0),this.mediaError.type=g.type||Ke.MEDIA_ERROR.internalError,this.mediaError.detail=g.detail||g.toString()}setRelay(g){this.relay={address:g.addresses.join(),expires:g.expires,realm:g.realm,credentials:!(!g.username||!g.password),ports:[g.udpPort?`udp:${g.udpPort}`:"",g.tcpPort?`tcp:${g.tcpPort}`:"",g.tlsPort?`tls:${g.tlsPort}`:""].join(","),fqdns:g.fqdns?g.fqdns.join():"none"}}setRelayManagerTimers(g){this.relayManagerTimers=g}setSendModalities(g){this.allowedAudioSend=g.audio.some((g=>hasSendDirectionality(g))),this.allowedVideoSend=g.video.some((g=>hasSendDirectionality(g))),this.allowedScreensharingSend=g.sharing.some((g=>hasSendDirectionality(g)))}setIceInitTimestamp(g){this.iceInitTime||(this.iceInitTime=g)}setFinalAnswerTimestamp(g){this.finalAnswerTime||(this.finalAnswerTime=g)}setIceConnectedStateTimestamp(g){this.iceConnectedStateTime||(this.iceConnectedStateTime=g)}dtmfResult(g){g?++this.dtmfSuccess:++this.dtmfFailure}setUsedDevices(g){this.usedDevices&&JSON.stringify(g)!==JSON.stringify(this.usedDevices)&&this.deviceSelectionChangeCount++,this.usedDevices=g}setDevicesCount(g){this.devicesCount=g}setMediaQosEnabled(g){this.mediaQosEnabled=g}setPortRangeConfigured(g){this.portRangeConfigured=g}devicesChanged(){this.devicesChangeCount++}deviceChangedByPoll(){this.devicesPollChangeCount++}registerOutputRawMediaAccess(){this.rawOutputAudioAccess.attempt++,this.rawOutputAudioAccess.timer.start()}registerSetInputRawMedia(g){this.rawInputAudioOverride.attempt++,g?this.rawInputAudioOverride.timer.start():this.rawInputAudioOverride.timer.stop()}getReport(){const g=this.usedDevices||{microphone:"none",speaker:"none",camera:"none"};return{RawOutputAudioAccessDurationRatio:this.getDurationRatio(this.rawOutputAudioAccess.timer.elapsed),RawOutputAudioAccessAttempted:this.rawOutputAudioAccess.attempt,RawInputAudioOverrideDurationRatio:this.getDurationRatio(this.rawInputAudioOverride.timer.elapsed),RawInputAudioOverrideAttempted:this.rawInputAudioOverride.attempt,SessionId:this.sessionId,CallNumber:this.callNumber,NoIceCandidatesBadEventCount:this.noIceCandidatesBadEventCount,NoIceCandidatesGoodEventCount:this.noIceCandidatesGoodEventCount,NoRelayIceCandidatesBadEventCount:this.noRelayIceCandidatesBadEventCount,NoRelayIceCandidatesGoodEventCount:this.noRelayIceCandidatesGoodEventCount,CameraInUseBadEventCount:this.cameraInUseBadEventCount,CameraInUseGoodEventCount:this.cameraInUseGoodEventCount,MicrophoneInUseBadEventCount:this.microphoneInUseBadEventCount,MicrophoneInUseGoodEventCount:this.microphoneInUseGoodEventCount,CameraFreezeStartEventCount:this.cameraFreezeStartEventCount,CameraFreezeEndEventCount:this.cameraFreezeEndEventCount,RetargetIncomingCount:this.retargetIncomingCount,RetargetOutgoingCount:this.retargetOutgoingCount,RetargetCompletedCount:this.retargetCompletedCount,RetargetRejectedCount:this.retargetRejectedCount,ReconnectAttemptedCount:this.reconnectAttemptedCount,ReconnectConnectedCount:this.reconnectConnectedCount,EscalationAttemptedCount:this.escalationAttemptedCount,EscalationCompletedCount:this.escalationCompletedCount,EscalationRejectedCount:this.escalationRejectedCount,CreationTime:this.getHpTimeFromMillis(this.creationTime),InitTime:this.getHpTimeFromMillis(this.creationTime),TerminationTime:this.getHpTimeFromMillis(this.terminationTime),CallDuration:this.getHpTimeFromMillis(this.getCurrentDuration()),InitialNegotiationType:this.initialNegotiationType||"none",InitialNegotiationCompleted:this.initialNegotiationCompleted,ActiveModalities:JSON.stringify(this.activeModalities),NegotiationCount:this.negotiationCount,RejectedNegotiationCount:this.rejectedNegotiationCount,MediaLegId:this.mediaLegId,MultiParty:this.multiParty,ErrorType:this.mediaError.type,ErrorDetail:this.mediaError.detail,TerminationReason:this.terminationReason,IncompatibleOffer:this.incompatibleOffer,DtmfSuccess:this.dtmfSuccess,DtmfFailure:this.dtmfFailure,Relay:this.relay?JSON.stringify(this.relay):"none",RelayManager:this.relayManagerTimers?JSON.stringify(this.relayManagerTimers):"none",AllowedAudioSend:this.allowedAudioSend,AllowedVideoSend:this.allowedVideoSend,AllowedScreensharingSend:this.allowedScreensharingSend,IceInitTime:this.getHpTimeFromMillis(this.iceInitTime),FinalAnswerTime:this.getHpTimeFromMillis(this.finalAnswerTime),IceConnectedStateTime:this.getHpTimeFromMillis(this.iceConnectedStateTime),UsedMicrophone:g.microphone,UsedSpeaker:g.speaker,UsedCamera:g.camera,DeviceSelectionChangeCount:this.deviceSelectionChangeCount,DevicesChangeCount:this.devicesChangeCount,DevicesPollChangeCount:this.devicesPollChangeCount,DevicesCount:this.devicesCount?JSON.stringify(this.devicesCount):"none",ETag:this.ETag||"",ConfigIds:this.configIds?Array.isArray(this.configIds)?this.configIds.join(","):this.configIds:"",CallMutedRatio:this.getDurationRatio(this.mute.elapsed),CallOsMuted:this.getHpTimeFromMillis(this.osMute.elapsed),CallHwSilent:this.getHpTimeFromMillis(this.hwSilent.elapsed),CallSwMuted:this.getHpTimeFromMillis(this.swMute.elapsed),CallSpeakerMuted:this.getHpTimeFromMillis(this.speakerMute.elapsed),CallIsSpeaking:this.getHpTimeFromMillis(this.isSpeaking.elapsed),NetworkRecvGood:this.networkRecv.getCount("Good")-1,NetworkRecvPoor:this.networkRecv.getCount("Poor"),NetworkRecvBad:this.networkRecv.getCount("Bad"),NetworkSendGood:this.networkSend.getCount("Good")-1,NetworkSendPoor:this.networkSend.getCount("Poor"),NetworkSendBad:this.networkSend.getCount("Bad"),NetworkRecvGoodRatio:this.getDurationRatio(this.networkRecv.getElapsed("Good")),NetworkRecvPoorRatio:this.getDurationRatio(this.networkRecv.getElapsed("Poor")),NetworkRecvBadRatio:this.getDurationRatio(this.networkRecv.getElapsed("Bad")),NetworkSendGoodRatio:this.getDurationRatio(this.networkSend.getElapsed("Good")),NetworkSendPoorRatio:this.getDurationRatio(this.networkSend.getElapsed("Poor")),NetworkSendBadRatio:this.getDurationRatio(this.networkSend.getElapsed("Bad")),DeviceEvents:JSON.stringify(this.deviceTelemetryEvents),DeviceList:JSON.stringify(this.deviceList),DeviceListDebug:JSON.stringify(this.deviceDebugStrings),VideoEffects:JSON.stringify(this.videoEffectsTelemetryEvents.items),AudioEffects:JSON.stringify(this.audioEffectsTelemetryEvents.items),PermissionStates:JSON.stringify(this.permissionStates),ReconnectAttempts:this.reconnectStats.getReport(),NetworkEvents:JSON.stringify(rebaseTime(limitArraySize(this.sessionDiagnostics?.getObjectRef().reconnect?.tmpRecords,this.configProvider.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",this.creationTime)),ReconnectInProgress:this.reconnectStats.isReconnecting(),TransportReconnectedCount:this.transportReconnectedCount,UFDs:JSON.stringify(this.ufds),MediaQosEnabled:this.mediaQosEnabled,PortRangeConfigured:this.portRangeConfigured,RollbackNegotiation:JSON.stringify(this.rollbackNegotiation),hardwareConcurrency:Vs.hardwareConcurrency,GPUName:Vs.unmaskedGlRenderer,Connection_Downlink:sampleseries(this.connectionDownlinkSeries.items,(g=>g)),Connection_EffectiveType:sampleseries(this.connectionEffectiveTypeSeries.items,(g=>g)),Connection_Rtt:sampleseries(this.connectionRttSeries.items,(g=>g)),Connection_SaveData:nv?.connection?.saveData,MediaByPassEnabled:!!this.configProvider.mediaConfig.mediaBypassEnabled,CallConstraints:JSON.stringify(this.configProvider.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(generateDominantSpeakerReport(this.sessionDiagnostics?.getObjectRef().dominantSpeaker,this.terminationTime))}}generateStatistics(g,m,S=!1){if(this.setMediaLegId(m.process()),"WebRtcMediaStats"!==g.type)throw new Error(`Unknown stats type - ${g.type}`);if(S){const g=this.deviceTelemetryEvents.length;this.deviceTelemetryEvents.splice(0,g-1),this.deviceDebugStrings=bm,this.audioEffectsTelemetryEvents.clear()}g.data.metrics=this.getReport();const v=this.sessionDiagnostics?.getObjectRef().statsErrors;if(v?.length)if(g.data.Extensions?.WebRTCStats?.statsErrors){const m=JSON.parse(g.data.Extensions.WebRTCStats.statsErrors);m.push(...v),g.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(m)}else g.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(v);const C={};return forOwnRec(g.data,((g,m,S)=>{let v=0;sv.test(g)?(v=13,C[m]="IPv4"):av.test(g)&&(v=4,C[m]="IPv6"),S[m]={type:v,value:g,__VALUE__:!0}})),g.data.metrics.piiFields={type:0,value:JSON.stringify(C),__VALUE__:!0},g}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}resetError(){this.setError({type:"none",detail:"none"})}offering(){return{started:()=>{this.currentNegotiationType="Offering",this.negotiationStarted()}}}answering(){return{started:()=>{this.currentNegotiationType="Answering",this.negotiationStarted()}}}negotiationStarted(){this.initialNegotiationType=this.initialNegotiationType||this.currentNegotiationType,++this.negotiationCount}current(){return{completed:g=>{this.initialNegotiationCompleted=!0,this.activeModalities=g,this.resetError()},rejected:()=>{++this.rejectedNegotiationCount}}}getDurationRatio(g){const m=this.getCurrentDuration();return g/(0!==m?m:1)}getCurrentDuration(){return this.durationTimer.elapsed}getHpTimeFromMillis(g){return 1e4*g}},lv=class{constructor(g,m,S,v){this.onActiveSpeakersChanged=g,this.onDominantSpeakersChanged=m,this.diagnostics=S,this.logger=v}setStrategy(g){this.disposeStrategy(),this.dshStrategy=g,this.dshStrategy?.setOnDominantSpeakerChanged(this.onDominantSpeakerHistoryChanged.bind(this)),this.diagnostics?.setCurrentActiveStrategy("client")}onContributingSourcesChanged(g){this.onActiveSpeakersChanged(g),this.dshStrategy?.setSources(g)}onDominantSpeakerHistoryChanged(g,m){this.onDominantSpeakersChanged(g),this.diagnostics?.recordHistoryEvent(g,m),"client"!==m&&this.dshStrategy&&(this.logger.safe.info("Disposing client DSH strategy and switching to MP provided DSH"),this.disposeStrategy())}dispose(){this.disposeStrategy(),this.onActiveSpeakersChanged=null,this.onDominantSpeakersChanged=null}disposeStrategy(){this.dshStrategy?.dispose(),this.dshStrategy=null}},cv=4294967040,dv=class{constructor(){this.ssrc=Math.floor(Math.random()*(cv-1))+1}nextAudioStreamSsrc(){return this.nextSsrc(0)}nextVideoStreamSsrc(){return this.nextSsrc(99)}nextSsrc(g){let m=this.ssrc;do{m=this.ssrc,this.ssrc=(this.ssrc+g+1)%cv,0===this.ssrc&&(this.ssrc=1)}while(m+g>cv);return{min:m,max:m+g}}},hv=class{};hv.SourceNone=-1,hv.SourceAny=-2;var uv=class{constructor(g){this.listener=g,this.streams=[]}add(g){this.streams.some((m=>m.getId()===g.getId()))||(this.streams.push(g),this.listener.streamAdded(g))}remove(g){let m;remove2(this.streams,(S=>S.getId()===g&&(m=S,!0)))&&this.listener.streamRemoved(m)}getStreams(){return this.streams}clear(){this.streams.forEach((g=>g.dispose())),this.streams=[]}},gv=class{constructor(g){this.subscription=g}get subscribedStream(){return this.subscription.stream?.getMediaStream()}get msi(){return this.checkDisposed(),this.subscription.msi}get modality(){return this.checkDisposed(),this.subscription.modality}get localMsi(){return this.checkDisposed(),this.subscription.localMsi}setOnMediaStreamChangedHandler(g){this.checkDisposed(),this.mediaStreamChanged=g,this.subscription.isStreamReady&&this.notifyMediaStreamChanged()}setOnErrorHandler(g){this.checkDisposed(),this.error=g}dispose(){this.subscription&&(this.subscription.dispose(generateCauseId(),this),this.subscription=null)}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}notifyMediaStreamChanged(){if(this.mediaStreamChanged){const g=this.subscription.stream,m=this.subscription.isStreamReady;this.mediaStreamChanged(g&&m?g.getMediaStream():null)}}notifyError(g){this.error&&this.error(g)}checkDisposed(){if(!this.subscription)throw new Error("subscription disposed")}},pv=class extends je{constructor(g,m,S){super(),this.modality=g,this.msi=m,this.disposeDelay=S,this.clients=[],this.streamReady=!1}createClient(){const g=new gv(this);return this.clients.push(g),g}get isStreamReady(){return this.streamReady}get localMsi(){return this.subStream?.getSourceStreamId()}get isInactive(){return!this.clients.length}get stream(){return this.subStream}set stream(g){try{if(g===this.subStream)return;this.subStream&&(this.unsubscribe(!1),this.notifyStreamChanged()),this.subStream=g,g&&(this.streamReady=!1,g.requestSource(this.msi).then((()=>{this.streamReady=!0,this.notifyStreamChanged()})).catch((g=>{this.notifyError(g)})))}catch(g){this.event("onFailed").raise(this,g)}}notifyError(g){this.clients.forEach((m=>{m.notifyError(g)})),this.event("onFailed").raise(this,g)}dispose(g,m){m?(remove2(this.clients,(g=>g===m)),this.isInactive&&(this.disposeTimeout=window.setTimeout((()=>{this.disposeTimeout=null,this.unsubscribeIfInactive()}),this.disposeDelay))):(this.clients=[],this.unsubscribe())}unsubscribeIfInactive(){this.isInactive&&(this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.unsubscribe())}unsubscribe(g=!0){this.subStream&&(this.subStream.requestSource(hv.SourceNone).catch((()=>{})),this.streamReady=!1,this.subStream=null),g&&this.event("onDisposed").raise(this)}notifyStreamChanged(){this.clients.forEach((g=>g.notifyMediaStreamChanged())),this.event("onStreamChanged").raise()}},mv=class extends je{constructor(g,m,S,v){super(g),this.configProvider=m,this.diagnostics=v,this.videoSubscriptions=[],this.subscriptionEvents=new Map,this.setLogger(g),this.diagnostics??(this.diagnostics=new Wm(this.configProvider,(()=>{}))),this.setStreamProvider(S),this.logger.safe.info("created")}getSubscriptionsCount(){return this.videoSubscriptions.length}setStreamProvider(g){this.streamProvider=g,this.streamProvider.setOnStreamsChangedHandler((()=>this.streamsChanged()))}setLogger(g){this.logger=g}subscribeVideo(g,m=hv.SourceAny){let S=this.videoSubscriptions.find((S=>S.msi===m&&S.modality===g));if(!S){const v=Date.now();this.disposeInactiveSubscriptionIfNeeded(g);const C=this.getAvailableStream(g),_=C?.getSourceStreamId();this.logger.safe.info(`creating new subscription #${m} for modality ${g}`),this.event("onSubscriptionChanged").raise(1,g,m,_,null),this.diagnostics.addSubscribe(g,m,_),S=new pv(g,m,this.configProvider.config.webrtcVideoSubscriptionDisposeTimeout);const E=[];E.push(S.on("onDisposed",(g=>this.onSubscriptionDisposed(g)))),E.push(S.on("onStreamChanged",(()=>{const C=S.stream?.getId(),_=S.localMsi;if(this.updateTrackIds(),S.isStreamReady){const S=Date.now();this.event("onSubscriptionChanged").raise(2,g,m,_,S-v,C),this.diagnostics.addSubscribed(g,m,_,S-v)}}))),E.push(S.on("onFailed",((g,m)=>this.onSubscriptionFailed(g,m)))),this.subscriptionEvents.set(S,E),this.videoSubscriptions.push(S),C&&this.assignStream(S,C)}return S.createClient()}dispose(){const g=generateCauseId();this.videoSubscriptions.concat().forEach((m=>m.dispose(g))),this.streamProvider.setOnStreamsChangedHandler(null),super.dispose(),this.logger.safe.info("disposed")}reriseSubscribeEvents(){this.logger.safe.info(`rerising subscription events: ${this.videoSubscriptions.length}`);const g=[];this.videoSubscriptions.forEach((m=>{const S=m.modality,v=m.msi,C=m.localMsi;this.event("onSubscriptionChanged").raise(1,S,v,C),this.diagnostics.addSubscribe(S,v,C),g.push(...this.getSubscriptionVideoTrackIds(m))})),this.diagnostics.subscribedTrackIds=g}setDiagnostics(g){this.diagnostics=g??new Wm(this.configProvider,(g=>{this.logger.safe.warn(`Unhandled stats error from inactive subscription manager: ${g}`)}))}streamChangedByMsi(g){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`);const m=this.videoSubscriptions.find((m=>m.msi===g));m?this.assignSubscriptionToStream(m):this.logger.safe.error(`Subscription for msi ${g} not found`)}streamsChanged(){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`),this.videoSubscriptions.forEach((g=>{this.assignSubscriptionToStream(g)}))}assignSubscriptionToStream(g){const m=!g.stream||this.isStreamRemoved(g.stream);if(this.logger.safe.info(`Subscription for ${g.modality} ${g.msi} needs new stream: ${m}`),!m)return;const S=this.getAvailableStream(g.modality);S?this.assignStream(g,S):this.resignStream(g)}getAvailableStream(g){return this.streamProvider.getStreams().find((m=>g===m.getModality()&&m.getMsi()===hv.SourceNone))}isStreamRemoved(g){return!this.streamProvider.getStreams().some((m=>m===g))}assignStream(g,m){this.logger.safe.info(`assigning stream #${m.getId()} to subscription #${g.msi}`),g.stream=m}resignStream(g){g.stream&&(this.logger.safe.info(`removing stream from subscription #${g.msi}`),g.stream=null)}disposeInactiveSubscriptionIfNeeded(g){this.getAvailableStream(g)||this.videoSubscriptions.find((m=>m.modality===g&&m.isInactive))?.unsubscribeIfInactive()}onSubscriptionDisposed(g){const m=generateCauseId(),S=g.modality,v=g.msi,C=g.localMsi;this.event("onSubscriptionChanged").raise(3,S,v,C),this.diagnostics.addUnsubscribe(S,v,C),this.logger.safe.info(`disposing subscription for ${S} #${v}`),remove2(this.videoSubscriptions,(m=>m===g)),this.streamsChanged(),this.updateTrackIds(),this.subscriptionEvents.has(g)&&(this.subscriptionEvents.get(g).forEach((g=>g.dispose(m))),this.subscriptionEvents.delete(g))}updateTrackIds(){const g=[],m=[];this.videoSubscriptions.forEach((S=>{if(!S.isStreamReady)return;const v=S.stream?.getId().split("-")[1];m.push(v),g.push(...this.getSubscriptionVideoTrackIds(S))})),this.event("onTrackIdsChanged").raise(g),this.diagnostics.subscribedTrackIds=g,this.configProvider.config.subscribeToSsrcForVideo&&this.event("onTrackSsrcChanged").raise(m)}getSubscriptionVideoTrackIds(g){return g?.stream?.getMediaStream()?.getVideoTracks().map((g=>g.id))??[]}onSubscriptionFailed(g,m){this.event("onSubscriptionFailed").raise(-1,g.modality,g.msi,g.localMsi,m),this.diagnostics.addFailed(g.modality,g.msi,g.localMsi,stringifyObject(m))}},fv=__toESM(Me()),Sv=class{constructor(g,m,S){this.logger=g,this.qualityManager=m,this.configProvider=S}getControlItem(){return this.controlItem}setControlItem(g){this.controlItem=g}dispose(){this.controlItem=null}setVideoControlMessage(g){this.controlItem=this.messageToControlItem(g),this.logger.safe.info(`BW limit requested to ${this.controlItem.bandwidth}`)}modifyDescriptor(g){if(!this.controlItem)return g;const m=fv.parse(g.sdp);if(!m.media[1])return this.logger.unsafe.warn("video modality is disabled, skipping sdp modification, ",g),g;const S=this.getCurrentResolutionBitrate();this.logger.safe.info(`Select the BW limit as min of requested ${this.controlItem.bandwidth} and Current Resolution Max BR ${S}`);const v=this.getSessionBitrate(m),C=Math.min(S,this.controlItem.bandwidth,v);if(m.media[1].bandwidth)m.media[1].bandwidth[0].limit=C;else{const g={limit:C,type:"AS"};m.media[1].bandwidth=[g]}return g.sdp=fv.write(m),g}messageToControlItem(g){const m=new Zm(g.controlVideoStreaming.controlInfo[0].fmtParams),S="max-br",v=1.2;if(!m.contains(S))return null;const C=Math.round(+m.get(S)*v);return{sourceId:g.controlVideoStreaming.controlInfo[0].sourceId,streamMsid:g.controlVideoStreaming.controlInfo[0].streamMsid,bandwidth:C}}getCurrentResolutionBitrate(){const g=this.qualityManager.getCurrentResolution(),m=Lp.Send.getResolutionByFs(g);return g&&m?Math.floor(Lp.Send.getBitrateForResolution(m.width,m.height).maxBitrate/1e3):Number.MAX_VALUE}getSessionBitrate(g){let m=Number.MAX_SAFE_INTEGER;return this.configProvider.mediaConfig.maxBandwidthInKbps&&(m=this.configProvider.mediaConfig.maxBandwidthInKbps),g.bandwidth&&(m=Math.min(g.bandwidth[0].limit,m)),m-(this.configProvider.config.audioBandwidthInKbps||0)}},vv=class{constructor(g,m,S){this.pc=g,this.configProvider=m,this.logger=S.createChild("MediaRollbackModifier")}modifyDescriptor(g){const m=fv.parse(g.sdp);return fv.parse(this.pc.localDescription.sdp).media.forEach(((g,S)=>{const v=m.media[S];(isMediaDisabled(g)&&!g.bundleOnly||!v||isMediaDisabled(v))&&(this.logger.safe.info(`Adding disabled media ${g.type}, position ${S}`),m.media[S]=disabledMedia(g.type,void 0,g.protocol,void 0))})),new tS(this.configProvider).modify(m),g.sdp=fv.write(m),g}},Cv=class{constructor(g){this.manager=null,this.extensionType=g}initialize(g){g.manager&&(this.manager=g.manager),g.logger&&(this.logger=g.logger.createChild(this.extensionType)),g.configProvider&&(this.configProvider=g.configProvider)}dispose(){this.manager&&(this.manager=null),this.logger&&(this.logger.safe.info("disposed"),this.logger=this.logger.createChild("DISPOSED"))}configure(g){this.options=g}getOptions(){return this.options}getType(){return this.extensionType}},_v=class extends Cv{constructor(){super("dominantSpeakerHistory"),this.callback=null}initialize(g){super.initialize(g),this.extensionManagerSubscription=this.manager.on("onDominantHistoryMessage",((g,m)=>this.onDominantHistoryMessage(g,m))),g&&g.callback&&(this.callback=g.callback)}dispose(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null,this.callback=null,super.dispose()}onDominantHistoryMessage(g,m){this.callback&&("server"===m?this.callback(g.history,m):"signaling"===m&&this.callback(g.previousDominantSpeakerHistory,m))}},yv=class{constructor(g,m,S,v,C,_){this.logger=g,this.emulator=m,this.qualityManager=S,this.diagnostics=v,this.configProvider=C,this.statsGatherer=_,this.previousSequenceNumber=new Map,this.modifiers=this.configProvider.mediaConfig.simulcastSessionEnabled?[]:[new Sv(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider)]}dispose(){this.cleanupDevToolsInjector(),this.modifiers&&(this.modifiers.forEach((g=>g.dispose())),this.modifiers=null),this.emulator=null,this.logger=this.logger.createChild("DISPOSED")}handleMessage(g){const m=g.controlInfo[0].sourceId;if(this.previousSequenceNumber.has(m)&&g.sequenceNumber<this.previousSequenceNumber.get(m))return this.statsGatherer.addVideoControlMessage(!0),this.diagnostics?.addVideoControlMessage(!0),this.logger.safe.info(`Discarded old media stream control message for sourceId ${m}: (${JSON.stringify(g)})`),Promise.resolve();this.previousSequenceNumber.set(m,g.sequenceNumber),this.statsGatherer.addVideoControlMessage(),this.diagnostics?.addVideoControlMessage(),this.configProvider.config.enableDevtoolsAPI&&this.injectFmtpHandler(g);const S={controlVideoStreaming:g};return this.configureResolution(S),this.modifiers.length?(this.modifiers.forEach((g=>g.setVideoControlMessage(S))),this.emulator.renegotiate(this.modifiers)):Promise.resolve()}configureResolution(g){this.logger.safe.info(`Signaling FMTP: ${JSON.stringify(g.controlVideoStreaming)}`);const m=String(g.controlVideoStreaming.sequenceNumber),S=g.controlVideoStreaming.controlInfo[0].fmtParamsList,v=g.controlVideoStreaming.controlInfo[0].fmtParams,C=S&&this.configProvider.config.webrtcFmtParamListSupported?this.parseFmtParamsList(S):[this.parseFmtParams(v)],_=+g.controlVideoStreaming.controlInfo[0].sourceId,E=[{causeId:m,isSimulcast:C.some((g=>void 0!==g.rid))||C.length>1,capabilities:C,sourceId:_}];this.qualityManager.setMaxCapabilities(E)}parseFmtParamsList(g){return g.map((g=>this.parseFmtParams(g)))}parseFmtParams(g){const m=new Zm(g);return{maxFs:+m.get(Ke.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+m.get(Ke.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+m.get(Ke.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+m.get(Ke.VIDEO_CAPABILITIES.MAX_BR_PATH),ssrc:+m.get(Ke.VIDEO_CAPABILITIES.SSRC_PATH),rid:m.get(Ke.VIDEO_CAPABILITIES.RID_PATH),keyframe:this.shouldGenerateKeyFrame(m),vlaDebug:m.get(Ke.VIDEO_CAPABILITIES.VLA_DEBUG)}}shouldGenerateKeyFrame(g){return g.get(Ke.VIDEO_CAPABILITIES.KEYFRAME_PATH)?!!+g.get(Ke.VIDEO_CAPABILITIES.KEYFRAME_PATH):this.configProvider.config.webrtcAllowRestoreKeyframe}injectFmtpHandler(g){const m=window;m&&m.webMA&&(m.webMA.fmtp||(m.webMA.fmtp={handleMessage:this.handleMessage.bind(this)}),m.webMA.fmtp.lastFmtp=g)}cleanupDevToolsInjector(){const g=window;g&&g.webMA&&delete g.webMA.fmtp}},Ev=class{constructor(){this.sequence=0}getVideoControlMessage(g,m,S){const v={controlVideoStreaming:{sequenceNumber:++this.sequence,globalTimeStamp:(new Date).toString(),controlInfo:[{control:"start",sourceId:m,streamMsid:g}]}};return S&&(v.controlVideoStreaming.controlInfo[0].fmtParams=fmtParamsToString(S)),v}getSourceRequestMessage(g,m,S,v,C){if(!v)throw new Error("Failed to construct SourceRequestMessage, missing fmtParams");const _={sourceId:m,streamMsid:g,fmtParams:v};return _.subStreamIndex=C,{applyChannelParameters:{multiChannelParameter:{mids:[S],mediaParameter:JSON.stringify({controlVideoStreaming:{sequenceNumber:++this.sequence,controlInfo:_}})}}}}getBandwidthInfoMessage(g,m){return{applyChannelParameters:{multiChannelParameter:{mids:g,mediaParameter:JSON.stringify({remoteUplinkBWE:{bw:m.toString()}})}}}}getMaxVideoSendCapabilitiesMessage(g){function ceilToMacroblock(g){const m=16;return Math.ceil(g/m)*m}const{streamMIDs:m,capabilities:S,useMax:v,sendMaxFs:C,sendMaxMbps:_}=g;let E=ceilToMacroblock(S.maxWidth),T=ceilToMacroblock(S.maxHeight);v&&(E=T=Math.max(E,T));const I={[Ke.VIDEO_CAPABILITIES.MAX_FPS_PATH]:S.maxFps,[Ke.VIDEO_CAPABILITIES.MAX_WIDTH]:E,[Ke.VIDEO_CAPABILITIES.MAX_HEIGHT]:T};return C&&(I[Ke.VIDEO_CAPABILITIES.MAX_FS_PATH]=S.maxFs),_&&(I[Ke.VIDEO_CAPABILITIES.MAX_MBPS_PATH]=S.maxMbps),{applyChannelParameters:{multiChannelParameter:{mids:m,mediaParameter:JSON.stringify({maxVideoSendCapabilities:{caps:I}})}}}}},Tv=class{constructor(g){this.logger=g}dispose(){this.sender=null}configure(g){this.sender=g.sender}async sendMessage(g,m){if(!this.checkConfigured())return this.logger.safe.warn("extension not configured with sender"),null;let S,v;return"ApplyChannelParametersSourceRequest"===g&&(S=JSON.parse(m.applyChannelParameters.multiChannelParameter.mediaParameter),v=S.controlVideoStreaming.sequenceNumber),this.logger.safe.info(`sending video control message: ${JSON.stringify(m)}`),this.sender.send(g,m,S,v)}checkConfigured(){return!!this.sender}},Iv=class extends Cv{constructor(){super("videoStreamControl"),this.messageGenerator=new Ev}initialize(g){super.initialize(g),this.subscribeListeners(),this.sourceRequester=new Tv(g.logger),this.streamConfigurationHandler=new yv(g.logger,g.negotiationEmulator,g.qualityManager,g.diagnostics,g.configProvider,g.statisticsGatherer)}configure(g){super.configure(g),this.sourceRequester.configure(g)}sendSourceRequest(g,m,S,v,C){if(this.configProvider?.config.useApplyChannelParametersForSourceRequests){const _=this.messageGenerator.getSourceRequestMessage(g,m,S,v,C);return this.sourceRequester.sendMessage("ApplyChannelParametersSourceRequest",_)}const _=this.messageGenerator.getVideoControlMessage(g,m,v?.[0]);return this.sourceRequester.sendMessage("ControlVideoStreaming",_)}sendBandwidthInfo(g,m){const S=this.messageGenerator.getBandwidthInfoMessage(g,m);return this.sourceRequester.sendMessage("ApplyChannelParametersBandwidth",S)}sendMaxVideoSendCapabilities(g,m){const S=this.messageGenerator.getMaxVideoSendCapabilitiesMessage({streamMIDs:g,capabilities:m,sendMaxFs:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxFs,sendMaxMbps:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxMbps,useMax:this.configProvider.config.maxSendVideoCapabilitiesReportingUseMaximumWidthHeight});return this.sourceRequester.sendMessage("ApplyChannelParametersVideoCapabilities",S)}dispose(){this.unsubscribeListeners(),this.streamConfigurationHandler&&(this.streamConfigurationHandler.dispose(),this.streamConfigurationHandler=null),this.sourceRequester&&(this.sourceRequester.dispose(),this.sourceRequester=null),super.dispose()}onMediaStreamControlMessage(g){this.streamConfigurationHandler.handleMessage(g)}subscribeListeners(){this.extensionManagerSubscription=this.manager.on("onMediaStreamControlMessage",(g=>this.onMediaStreamControlMessage(g)))}unsubscribeListeners(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}},bv=class extends Cv{constructor(){super("bandwidthTelemetry")}initialize(g){super.initialize(g),this.statisticsGatherer=g.statisticsGatherer,this.diagnostics=g.diagnostics,this.extensionManagerSubscription=this.manager.on("onBandwidthMessage",(g=>this.onBandwidthMessage(g)))}dispose(){super.dispose(),this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}onBandwidthMessage(g){this.statisticsGatherer.addReportedReceiveBandwidth(g.bw),this.diagnostics.addReportedReceiveBandwidth(g.bw)}},Av=class{constructor(g){this.key=g.config.bwSeedOptions.localStorageKey||"bwSeed";const m=localStorage.getItem(this.key);parseInt(m)||localStorage.setItem(this.key,g.config.bwSeedOptions.constValue.toString())}getSeed(){const g=localStorage.getItem(this.key),m=parseInt(g);return isNaN(m)?void 0:m}saveSeed(g){localStorage.setItem(this.key,g.toString())}static localStorageAvailable(){try{const g=window.localStorage,m="someKey",S="someValue";return g.setItem(m,S),g.removeItem(m),!0}catch(g){return!1}}},Rv=class _BandwidthMemoryStorage{constructor(g){_BandwidthMemoryStorage.value??(_BandwidthMemoryStorage.value=g.config.bwSeedOptions.constValue)}getSeed(){return _BandwidthMemoryStorage.value}saveSeed(g){_BandwidthMemoryStorage.value=g}},Pv=class{constructor(g){this.value=g}addValue(g){}getAggregated(){return this.value}},Mv=class{addValue(g){this.value=g}getAggregated(){return this.value}},wv=class{constructor(g){this.values=new Fm(g)}addValue(g){this.values.add(g)}getAggregated(){return Math.floor(average(this.values.items))}},Dv=class{constructor(){this.total=0,this.duration=0,this.max=0,this.minNonZero=Number.MAX_SAFE_INTEGER}get avg(){return 0!==this.duration?this.total/this.duration:0}get maxSample(){return this.max}get minNonZeroSample(){return this.minNonZero}captureSample(g){(g||0===g)&&(this.total+=g,this.duration++,this.max=Math.max(g,this.max),0!==g&&(this.minNonZero=Math.min(g,this.minNonZero)))}},Ov=class{constructor(){this.sampleCounts={}}get min(){const g=Object.keys(this.sampleCounts).map(Number).filter((g=>g>0));return g.length>0?Math.min(...g):0}get max(){const g=Object.keys(this.sampleCounts).map(Number);return g.length>0?Math.max(...g):0}get mode(){const g=Object.keys(this.sampleCounts).map(Number);return g.length>0?g.reduce(((g,m)=>this.sampleCounts[m]>this.sampleCounts[g]?m:g),g[0]):0}captureSample(g){var m;if(void 0!==g){const S=`${g}`;(m=this.sampleCounts)[S]??(m[S]=0),this.sampleCounts[S]++}}},Nv=class{get delta(){if(void 0!==this.cur&&void 0!==this.last)return this.cur-this.last}captureSample(g,m){void 0!==g&&(void 0!==this.cur&&(this.last=this.cur),this.cur=g)}},kv=class{constructor(g=0){this.precision=g}get delta(){if(void 0!==this.currentSample&&void 0!==this.prevSample){let g=1;return void 0!==this.currentTimestamp&&void 0!==this.prevTimestamp&&(g=(this.currentTimestamp-this.prevTimestamp)/1e3),g&&round((this.currentSample-this.prevSample)/g,this.precision)}}captureSample(g,m){if(this.currentTimestamp!==m){if(void 0===g)return this.prevSample=void 0,this.currentSample=void 0,this.prevTimestamp=void 0,void(this.currentTimestamp=void 0);void 0!==this.currentSample&&(this.prevSample=this.currentSample),this.prevTimestamp=this.currentTimestamp,this.currentTimestamp=m,this.currentSample=g}}},Lv=class{constructor(){this.startTime=Date.now()}get elapsed(){return round((Date.now()-this.startTime)/1e3,0)}},Fv=class{constructor(){this.eventCount=0,this.totalActiveDuration=0,this.countBuckets={seconds1to3:0,seconds3to5:0,seconds5to8:0,seconds8to15:0,seconds15to60:0,seconds60toMax:0},this.timestampBuckets={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]},this.averager=new Dv}get active(){return!!this.current}get ongoingDuration(){return this.current?.elapsed||0}get avgDuration(){return this.averager.avg}get longestDuration(){return this.averager.maxSample}get numEvents(){return this.eventCount}get totalDuration(){return this.current?this.totalActiveDuration+this.current.elapsed:this.totalActiveDuration}get timestamps(){return deepClone(this.timestampBuckets)}get counts(){return deepClone(this.countBuckets)}set active(g){if(!this.current&&g)this.current=new Lv;else if(this.current&&!g){const g=this.current.elapsed;this.averager.captureSample(g),this.totalActiveDuration+=g;for(const m of Object.keys(Ke.HISTOGRAM_BATCH))if(g<=Ke.HISTOGRAM_BATCH[m]){this.countBuckets[m]++,this.timestampBuckets[m].push(this.current.startTime);break}this.eventCount++,this.current=void 0}}},xv=class{constructor(){this.sampleChangeCount=0,this.sampleDurations={}}get durations(){return deepClone(this.sampleDurations)}get sortedDurations(){return Object.keys(this.sampleDurations).sort(((g,m)=>this.sampleDurations[m]-this.sampleDurations[g]))}get durationRatios(){const g={};let m=0;for(const g in this.sampleDurations)m+=this.sampleDurations[g];for(const S in this.sampleDurations)g[S]=round(this.sampleDurations[S]/m*100);return g}get changeCount(){return this.sampleChangeCount}captureSample(g){this.sampleDurations[g]||(this.sampleDurations[g]=0),this.sampleDurations[g]++,g!==this.lastSample&&(this.sampleChangeCount++,this.lastSample=g)}},Uv=class{constructor(g,m){this.validTimeBetweenFramesArrival=g,this.invalidFPSAboveMax=m,this.lastSampleTimestamp=-1,this.fpsHarmonicSumWeigtsTs=0,this.fpsHarmonicWeigtedSumsFramePerDelayTs=0}captureSample(g){const m=Date.now();if(g>0&&this.lastSampleTimestamp>0){const S=m-this.lastSampleTimestamp;if(this.lastSampleTimestamp=m,S<0||S>this.validTimeBetweenFramesArrival||g>this.invalidFPSAboveMax)return;const v=S/g;this.fpsHarmonicSumWeigtsTs+=S,this.fpsHarmonicWeigtedSumsFramePerDelayTs+=S*v}(this.lastSampleTimestamp<0||0===g)&&(this.lastSampleTimestamp=m)}get harmonicMean(){return this.fpsHarmonicWeigtedSumsFramePerDelayTs>0?1e3*this.fpsHarmonicSumWeigtsTs/this.fpsHarmonicWeigtedSumsFramePerDelayTs:0}},Vv=class{constructor(g){this.samplesNum=g,this.samples=[],this.lastReport={avg:-1,max:-1,median:-1,volatilityPercent:-1}}isReportComplete(){return this.samples.length===this.samplesNum}getReport(){return this.lastReport}captureSample(g){void 0===g||g<0||(arrayLimitedPush(this.samples,g,this.samplesNum),this.lastReport={avg:this.getAvg(),max:this.getMax(),median:this.getMedian(),volatilityPercent:this.getVolatility()})}getAvg(){return average(this.samples)}getMax(){return Math.max(...this.samples)}getMedian(){this.samples.sort(((g,m)=>g-m));return this.samples.length%2==1?this.samples[Math.floor(this.samples.length/2)]:(this.samples[this.samples.length/2]+this.samples[this.samples.length/2-1])/2}getVolatility(){const g=this.getAvg();if(0===g)return 0;let m=0;this.samples.forEach((S=>{m+=Math.abs(S-g)}));return round(m/this.samples.length*100/g,2)}},Bv=class{constructor(){this.duration=0,this.reportAggr={avg:0,max:0,median:0,volatilityPercent:0}}captureSample(g){!g||g.avg<0||(this.reportAggr={avg:this.reportAggr.avg+g.avg,max:Math.max(this.reportAggr.max,g.max),median:this.reportAggr.median+g.median,volatilityPercent:this.reportAggr.volatilityPercent+g.volatilityPercent},this.duration++)}getReport(){if(0!==this.duration)return{avg:this.reportAggr.avg/this.duration,max:this.reportAggr.max,median:this.reportAggr.median/this.duration,volatilityPercent:this.reportAggr.volatilityPercent/this.duration}}},Hv=class{constructor(g=0){this.allowedOvershoot=g,this.past=[],this.totalOvershootDuration=0,this.lastAllowed=0}get isOvershooting(){return!!this.current}get events(){return this.current?[...this.past,this.current]:this.past}get totalDuration(){return this.totalOvershootDuration}captureSample(g,m){const S=round(g-m);S>this.allowedOvershoot&&(0===this.lastAllowed||m===this.lastAllowed||!this.current&&m>this.lastAllowed)?(this.totalOvershootDuration++,this.current?(this.current.min=Math.min(this.current.min,S),this.current.max=Math.max(this.current.max,S)):this.current={timestamp:Date.now(),min:S,max:S}):this.current&&(this.current.duration=Date.now()-this.current.timestamp,this.past.push(this.current),this.current=void 0),this.lastAllowed=m}},$v=class{constructor(g=100){this.minPackets=g,this.prevLost=0,this.prevReceived=0}calculate(g,m){if(void 0===g||void 0===m)return;const S=g-this.prevReceived,v=m-this.prevLost;return S+v<this.minPackets?void 0:(this.prevReceived=g,this.prevLost=m,v*this.minPackets/(v+S))}},Gv=class{constructor(){this.capturedSamples=[]}captureSample(g){g&&this.capturedSamples.push(g)}calculateStd(){if(!this.capturedSamples.length)return;const g=this.capturedSamples.reduce(((g,m)=>g+m),0)/this.capturedSamples.length,m=this.capturedSamples.map((m=>(m-g)**2)),S=m.reduce(((g,m)=>g+m),0)/m.length;return round(Math.sqrt(S),2)}getFirst(){return this.capturedSamples[0]}getLast(){if(this.capturedSamples.length)return this.capturedSamples[this.capturedSamples.length-1]}calculatePercentile(g){if(!this.capturedSamples.length)return;const m=this.capturedSamples.sort(((g,m)=>g-m)),S=(m.length-1)*g,v=Math.floor(S),C=S-v;return void 0!==m[v+1]?m[v]+C*(m[v+1]-m[v]):m[v]}};function isPowerEfficient(g){if(!g)return;const m=["libvpx","ffmpeg"];let S=!0;for(const v of m)if(g.toLowerCase().includes(v)){S=!1;break}return S}var jv=class{constructor(g){this.samplesCount=g,this.capturedSamples=[]}captureSample(g){void 0!==g&&arrayLimitedPush(this.capturedSamples,g,this.samplesCount)}getRate(){if(!this.capturedSamples.length)return;const g=this.samplesCount/this.capturedSamples.length;return this.capturedSamples.reduce(((g,m)=>g+m))*g/this.samplesCount}},qv=class{constructor(g=5){this.limit=g,this.curWidth=0,this.curHeight=0,this.resolutionSwitches=[]}captureSample(g,m){g===this.curWidth&&m===this.curHeight||(arrayLimitedPush(this.resolutionSwitches,`${g}x${m}`,this.limit),this.curWidth=g,this.curHeight=m)}get switches(){if(this.resolutionSwitches.length)return this.resolutionSwitches}};function calcMacroblockRate(g,m,S){return g&&m?Math.ceil(g/Ke.MACROBLOCK_SIZE)*Math.ceil(m/Ke.MACROBLOCK_SIZE)*S:0}var Wv=class{constructor(){this.macroblockRateAveragerReceived=new Dv,this.macroblockRateAveragerDecoded=new Dv,this.maxDecoderLoss=0,this.decoderLoss=0}captureSample(g,m){this.macroblockRateAveragerReceived.captureSample(g),this.macroblockRateAveragerDecoded.captureSample(m);let S=this.maxDecoderLoss;g&&(S=(g-m)/g*100),this.decoderLoss=S,this.maxDecoderLoss=Math.max(S,this.maxDecoderLoss)}getReport(){return{macroblockRateReceivedMax:this.macroblockRateAveragerReceived.maxSample,macroblockRateReceivedAvg:this.macroblockRateAveragerReceived.avg,macroblockRateDecodedMax:this.macroblockRateAveragerDecoded.maxSample,macroblockRateDecodedAvg:this.macroblockRateAveragerDecoded.avg,macroblockRateMaxDecoderLossPercent:Math.floor(this.maxDecoderLoss),macroblockRateDecoderLossPercent:Math.floor(this.decoderLoss)}}},zv=class{constructor(){this.codecReport={}}captureSample(g,m){var S,v;const C=g.split("/")[1];return void 0===this.activeMsi||this.activeMsi!==m?(this.activeMsi=m,this.previousCodec=C,void((S=this.codecReport)[m]??(S[m]={[C]:1,codecSwitchCounter:0}))):this.previousCodec!==C?((v=this.codecReport[m])[C]??(v[C]=0),this.codecReport[m][C]++,this.codecReport[m].codecSwitchCounter++,void(this.previousCodec=C)):void this.codecReport[m][C]++}get report(){return this.codecReport}},Kv=class{constructor(){this.bandwidthAverager=new Dv}addValue(g){this.bandwidthAverager.captureSample(g)}getAggregated(){return Math.floor(this.bandwidthAverager.avg)}},Jv=-1,Yv=class{constructor(g){this.configProvider=g,this.aggregator=this.getAggregator(),this.storage=this.getStorage(),this.cappingValue=this.configProvider.config.bwSeedOptions.cappingValue}getSeed(){const g=this.storage.getSeed()??Jv;return this.cappingValue>=0?Math.min(g,this.cappingValue):g}saveSeed(g){this.aggregator.addValue(g);const m=this.aggregator.getAggregated();this.storage.saveSeed(m)}getAggregator(){switch(this.configProvider.config.bwSeedOptions.aggregation){case"avg":return this.configProvider.config.bwSeedOptions.aggregateLastN>0?new wv(this.configProvider.config.bwSeedOptions.aggregateLastN):new Kv;case"last":return new Mv;default:return new Pv(this.configProvider.config.bwSeedOptions.constValue)}}getStorage(){return this.configProvider.config.bwSeedOptions.useLocalStorage&&Av.localStorageAvailable()?new Av(this.configProvider):new Rv(this.configProvider)}},Qv=class extends Cv{constructor(){super("bandwidthCache")}initialize(g){super.initialize(g),this.bandwidthCache=new Yv(g.configProvider),this.onBandwidthMessageSubscription=this.manager.on("onBandwidthMessage",(g=>{this.bandwidthCache.saveSeed(g.bw)}))}getBWSeed(){return this.bandwidthCache.getSeed()}dispose(){super.dispose(),this.onBandwidthMessageSubscription?.dispose(),this.onBandwidthMessageSubscription=null}},Xv=class{static getExtension(g){switch(g){case"dominantSpeakerHistory":return new _v;case"videoStreamControl":return new Iv;case"bandwidthTelemetry":return new bv;case"bandwidthCache":return new Qv;default:throw new Error(`Extension of type ${g} is not found`)}}},Zv=class extends je{constructor(g){super(g),this.logger=g,this.extensions=[]}dispose(){this.extensions.map((g=>g.dispose())),this.extensions=[],super.dispose()}addExtension(g,m){m.manager||(m.manager=this);const S=Xv.getExtension(g);S.initialize(m),this.extensions.push(S)}getExtension(g){return this.extensions.find((m=>m.getType()===g))}configureExtension(g,m){this.getExtension(g)?.configure(m)}processNotification(g,m){switch(g){case"ControlVideoStreaming":this.event("onMediaStreamControlMessage").raise(m);break;case"DominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(m,"signaling");break;case"McpDominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(m,"server");break;case"BandwithNotification":this.event("onBandwidthMessage").raise(m);break;default:this.logger.safe.error(`Notification message handler not found for type: ${g}`)}}},eC=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(g){if(!g)return;const m=new Set;if(g.send){this.diagnostics.handlePresentationAudioInputLevel();for(const S of g.send)try{m.add(S.outboundRTP.id);let g=this.sendExtenders.get(S.outboundRTP.id)??new nC(this.diagnostics,this.configProvider);S.outboundRTP.bytesSent<g.lastBytes&&(g=new nC(this.diagnostics,this.configProvider)),this.sendExtenders.set(S.outboundRTP.id,g),g.processSample(S)}catch(g){this.diagnostics.addStatsError("AudioStatsProcessor:send",stringifyObject(g))}}if(clearMap(this.sendExtenders,m),m.clear(),g.recv)for(const S of g.recv)try{m.add(S.inboundRTP.id);let g=this.recvExtenders.get(S.inboundRTP.id)??new tC(this.configProvider);S.inboundRTP.bytesReceived<g.lastBytes&&(g=new tC(this.configProvider)),this.recvExtenders.set(S.inboundRTP.id,g),g.processSample(S)}catch(g){this.diagnostics.addStatsError("AudioStatsProcessor:recv",stringifyObject(g))}clearMap(this.recvExtenders,m)}},tC=class{constructor(g){this.configProvider=g,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new $v,this.bytesReceivedDiff=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.concealedRatioAverager=new Dv,this.stretchedRatioAverager=new Dv,this.codecSwitchesTracker=new xv,this.packetDurationTracker=new xv,this.jitterAverager=new Dv,this.jitterBufferDelayAverager=new Dv,this.lastBytes=0}processSample(g){let m,S,v,C,_;const E=this.lossRateCalculator.calculate(g.inboundRTP.packetsReceived,g.inboundRTP.packetsLost)??0;this.lastBytes=g.inboundRTP.bytesReceived,this.bytesReceivedDiff.captureSample(g.inboundRTP.bytesReceived,g.inboundRTP.timestamp);const T=this.bytesReceivedDiff.delta,I=T?8*T:void 0;this.packetsDelta.captureSample(g.inboundRTP.packetsReceived,g.inboundRTP.timestamp),this.packetsLostDelta.captureSample(g.inboundRTP.packetsLost,g.inboundRTP.timestamp);const b=g.inboundRTP.jitterBufferEmittedCount&&round(g.inboundRTP.jitterBufferDelay/g.inboundRTP.jitterBufferEmittedCount*1e3,0);if(this.jitterAverager.captureSample(1e3*g.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(g.inboundRTP.jitterBufferDelay),m=g.inboundRTP.totalSamplesReceived&&round((g.inboundRTP.concealedSamples-g.inboundRTP.silentConcealedSamples)/g.inboundRTP.totalSamplesReceived),g.customHealerStats){g.customHealerStats.numSamplesPerFrame&&(C=g.customHealerStats.decodedSamples/g.customHealerStats.numSamplesPerFrame,_=g.customHealerStats.cngSamples/g.customHealerStats.numSamplesPerFrame),m=g.customHealerStats.healedSamples/(g.customHealerStats.decodedSamples+g.customHealerStats.healedSamples),v=g.customHealerStats.concealSamples&&g.customHealerStats.concealSamples/(g.customHealerStats.decodedSamples+g.customHealerStats.healedSamples),S=g.customHealerStats.stretchSamples&&g.customHealerStats.stretchSamples/(g.customHealerStats.decodedSamples+g.customHealerStats.healedSamples);const E=g.customHealerStats.packetDurationInMs&&g.customHealerStats.packetDurationInMs>100?100:g.customHealerStats.packetDurationInMs;this.concealedRatioAverager.captureSample(v),this.stretchedRatioAverager.captureSample(S),this.codecSwitchesTracker.captureSample(`${g.customHealerStats.pullAdspPayloadType}`),this.packetDurationTracker.captureSample(`${E}`)}g.extensions={lossRate:E,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,healedRatio:m,jitterBufferMs:b,bitrate:I||0,customHealerStats:g.customHealerStats&&{concealedDataRatio:v,concealedDataRatioMax:this.concealedRatioAverager.maxSample,stretchedDataRatio:S,stretchedDataRatioMax:this.stretchedRatioAverager.maxSample,numberOfDecodedFrames:C,usageMetricsCodecId:this.codecSwitchesTracker.sortedDurations,percentageOfPtime:this.packetDurationTracker.durationRatios,pushPacketProcessingTimes:g.customHealerStats.pushProcessingTimes,pullPacketProcessingTimes:g.customHealerStats.pullProcessingTimes,pullProcessingTimePerStreamNumber:g.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:g.customHealerStats.cnpPushCount,cnpPullCount:g.customHealerStats.cnpPullCount,numberOfCNFrames:_,redPacketsCount:g.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:g.customHealerStats.pullNumOfStreamsCounter},jitterAvg:round(this.jitterAverager.avg),jitterBufferDelayMs:round(this.jitterBufferDelayAverager.avg)},this.duration++}},iC=class{constructor(){this.duration=0,this.lossRateAverager=new Dv,this.bitrateAverager=new Dv,this.jitterBufferAverager=new Dv,this.jitterAverager=new Dv,this.jitterBufferDelayAverager=new Dv,this.healedRatioAverager=new Dv}processSample(g,m,S){const v=g[0],C={inboundRTP:v.inboundRTP};if(v.transport&&Object.defineProperty(C,"transport",{value:v.transport,configurable:!1,enumerable:!1}),v.codec&&(C.codec=v.codec),v.track&&(C.track=v.track),v.remoteOutboundRTP&&(C.remoteOutboundRTP=v.remoteOutboundRTP),v.extensions){this.lossRateAverager.captureSample(v.extensions.lossRate),this.bitrateAverager.captureSample(v.extensions.bitrate),this.healedRatioAverager.captureSample(v.extensions.healedRatio),this.jitterBufferAverager.captureSample(v.extensions.jitterBufferMs),this.jitterAverager.captureSample(1e3*v.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(v.inboundRTP.jitterBufferDelay);const g=v.inboundRTP.packetsReceived+v.inboundRTP.packetsLost;C.aggregated={lossRateMax:this.lossRateAverager.maxSample,lossRateAvg:this.lossRateAverager.avg,networkAvgLossRate:g>0?v.inboundRTP.packetsLost/g:0,duration:this.duration,bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),jitterAvg:this.jitterAverager.avg,avgJitterBufferSize:this.jitterBufferAverager.avg,healedRatioAvg:this.healedRatioAverager.avg,healedRatioMax:this.healedRatioAverager.maxSample,customHealerStats:v.extensions.customHealerStats&&{concealedDataRatio:v.extensions.customHealerStats.concealedDataRatio,concealedDataRatioMax:v.extensions.customHealerStats.concealedDataRatioMax,stretchedDataRatio:v.extensions.customHealerStats.stretchedDataRatio,stretchedDataRatioMax:v.extensions.customHealerStats.stretchedDataRatioMax,numberOfDecodedFrames:v.extensions.customHealerStats.numberOfDecodedFrames,usageMetricsCodecId:v.extensions.customHealerStats.usageMetricsCodecId,percentageOfPtime:v.extensions.customHealerStats.percentageOfPtime,pushPacketProcessingTimes:v.extensions.customHealerStats.pushPacketProcessingTimes,pullPacketProcessingTimes:v.extensions.customHealerStats.pullPacketProcessingTimes,pullProcessingTimePerStreamNumber:v.extensions.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:v.extensions.customHealerStats.cnpPushCount,cnpPullCount:v.extensions.customHealerStats.cnpPullCount,numberOfCNFrames:v.extensions.customHealerStats.numberOfCNFrames,redPacketsCount:v.extensions.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:v.extensions.customHealerStats.pullNumOfStreamsCounter}},this.duration++}arrayLimitedPush(m,C,S)}},nC=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new $v,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.bytesSendDiff=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.rttAverager=new Dv,this.lastBytes=0}processSample(g){const m=this.lossRateCalculator.calculate(g.remoteInboundRTP?.packetsReceived,g.remoteInboundRTP?.packetsLost)??0;this.packetsDelta.captureSample(g.outboundRTP.packetsSent,g.outboundRTP.timestamp),this.packetsLostDelta.captureSample(g.remoteInboundRTP?.packetsLost,g.remoteInboundRTP?.timestamp),this.lastBytes=g.outboundRTP.bytesSent,this.bytesSendDiff.captureSample(g.outboundRTP.bytesSent,g.outboundRTP.timestamp);const S=this.bytesSendDiff.delta;this.rttAverager.captureSample(1e3*(g.remoteInboundRTP?.roundTripTime??0)),g.extensions={lossRate:m,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,bitrate:S?8*S:0,rttAvg:round(this.rttAverager.avg),callIsMuted:this.diagnostics.callIsMuted,rawInputVolume:this.diagnostics.audioLevel},this.duration++}},rC=class{constructor(g){this.diagnostics=g,this.duration=0,this.lossRateAverager=new Dv,this.bitrateAverager=new Dv,this.rttAverager=new Dv}processSample(g,m,S){const v=g[0],C={outboundRTP:v.outboundRTP};v.transport&&Object.defineProperty(C,"transport",{value:v.transport,configurable:!1,enumerable:!1}),v.codec&&(C.codec=v.codec),v.track&&(C.track=v.track),v.mediaSource&&(C.mediaSource=v.mediaSource),v.remoteInboundRTP&&(C.remoteInboundRTP=v.remoteInboundRTP),v.extensions&&(this.lossRateAverager.captureSample(v.extensions.lossRate),this.bitrateAverager.captureSample(v.extensions.bitrate),this.rttAverager.captureSample(v.remoteInboundRTP?.roundTripTime),C.aggregated={duration:this.duration,lossRateMax:this.lossRateAverager.maxSample,bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),rttAvg:round(this.rttAverager.avg),rttMax:round(this.rttAverager.maxSample),rawInputVolume:this.diagnostics.audioLevel,audioLevel:v.track?.audioLevel??v.mediaSource?.audioLevel},this.duration++),arrayLimitedPush(m,C,S)}},sC=P,aC={fs:0,fps:1},oC=class{constructor(g){this.logger=g,this.allowed=new Map,this.lastParams=new Map,this.currentEvents=new Map,this.finishedEvents=[]}setMaxCapabilities(g){g.forEach((g=>{if(g.ssrc||0===g.ssrc){this.finishIfActive(g.ssrc),this.allowed.set(g.ssrc,{fs:g.maxFs+aC.fs,fps:g.maxFps+aC.fps});const m=this.lastParams.get(g.ssrc);m&&this.setCurrentParams(g.ssrc,m.fs,m.fps)}}))}setCurrentParams(g,m,S){this.lastParams.set(g,{fs:m,fps:S});const v=this.getAllowedParams(g);v&&(m>v.fs||S>v.fps)?(this.captureOvershoot(g,S,v.fps,"fps"),this.captureOvershoot(g,m,v.fs,"fs")):v&&this.finishIfActive(g)}flush(){this.currentEvents.forEach(((g,m)=>this.finishIfActive(m)))}getEvents(){const g=[...deepClone(this.finishedEvents)],m=Date.now();return this.currentEvents.forEach((S=>S.forEach((S=>g.push({ssrc:S.ssrc,timestamp:S.timestamp,duration:m-S.timestamp,overshootType:S.overshootType,amount:S.amount}))))),g}captureOvershoot(g,m,S,v){const C=this.currentEvents.get(g)||[],_=C.findIndex((g=>g.overshootType===v)),E=C[_],T=m-S,I=aC[v];T<=I&&E?(E.duration=Date.now()-E.timestamp,this.finishedEvents.push(E),this.logger.debug(`stopped overshooting ${v} by ${E.amount}`),C.splice(_,1)):T>I&&!E?(this.logger.safe.info(`overshooting ${v} by ${m-S}`),C.push({ssrc:g,timestamp:Date.now(),duration:-1,overshootType:v,amount:{min:T,max:T}})):T>I&&E&&(E.amount={min:Math.min(E.amount.min,T),max:Math.max(E.amount.max,T)}),C.length?this.currentEvents.set(g,C):this.currentEvents.has(g)&&this.currentEvents.delete(g)}getAllowedParams(g){const m=this.allowed.get(g);return m||this.allowed.get(0)}finishIfActive(g){const m=this.currentEvents.get(g);if(m){const S=Date.now();m.forEach((m=>{m.duration=S-m.timestamp,this.finishedEvents.push(m),this.logger.debug(`finished overshooting ${m.overshootType} by min:${m.amount.min} max:${m.amount.max} for ${m.duration}ms for ssrc ${g}`)})),this.currentEvents.delete(g)}}},lC=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(g){if(!g)return;const m=new Set;if(g.send&&(0,sC.flatMap)(g.send,(g=>[g,...g.altLayouts??[]])).forEach((g=>{try{m.add(g.outboundRTP.id);let S=this.sendExtenders.get(g.outboundRTP.id)??new hC(this.diagnostics,this.configProvider);g.outboundRTP.bytesSent<S.lastBytes&&(S=new hC(this.diagnostics,this.configProvider)),this.sendExtenders.set(g.outboundRTP.id,S),S.processSample(g)}catch(g){this.diagnostics.addStatsError("VideoStatsProcessor:send",stringifyObject(g))}})),clearMap(this.sendExtenders,m),m.clear(),g.recv)for(const S of g.recv)try{m.add(S.inboundRTP.id);let g=this.recvExtenders.get(S.inboundRTP.id)??new cC(this.configProvider);S.inboundRTP.bytesReceived<g.lastBytes&&(g=new cC(this.configProvider)),this.recvExtenders.set(S.inboundRTP.id,g),g.processSample(S)}catch(g){this.diagnostics.addStatsError("VideoStatsProcessor:recv",stringifyObject(g))}clearMap(this.recvExtenders,m)}},cC=class{constructor(g){this.configProvider=g,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new $v,this.bytesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.framesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.framesDecodedDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.trackFramesDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.decodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new kv(2):new Nv,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.freezeHistogram=new Fv,this.harmonicDecodedFps=new Uv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.prevTimeToFirstFrame=-1,this.lastBytes=0,this.macroblockStatsTracker=new Wv}processSample(g){const m=this.lossRateCalculator.calculate(g.inboundRTP.packetsReceived,g.inboundRTP.packetsLost)??0;this.framesReceivedDelta.captureSample(g.inboundRTP.framesReceived,g.inboundRTP.timestamp),this.framesDecodedDelta.captureSample(g.inboundRTP.framesDecoded,g.inboundRTP.timestamp),this.trackFramesDelta.captureSample(g.inboundRTP.framesReceived??g.track?.framesReceived,g.inboundRTP.timestamp),this.packetsDelta.captureSample(g.inboundRTP.packetsReceived,g.inboundRTP.timestamp),this.packetsLostDelta.captureSample(g.inboundRTP.packetsLost,g.inboundRTP.timestamp);const S=this.framesReceivedDelta.delta,v=this.framesDecodedDelta.delta;this.harmonicDecodedFps.captureSample(v),this.decodeTimeDelta.captureSample(g.inboundRTP.totalDecodeTime,g.inboundRTP.timestamp);const C=this.decodeTimeDelta.delta&&v&&round(this.decodeTimeDelta.delta/v*1e3,0),_=g.renderer?.timeToFirstFrame??-1;this.freezeHistogram.active=-1!==_&&-1!==this.prevTimeToFirstFrame&&(0===v||0===S),this.prevTimeToFirstFrame=_,this.lastBytes=g.inboundRTP.bytesReceived,this.bytesReceivedDelta.captureSample(g.inboundRTP.bytesReceived,g.inboundRTP.timestamp);const E=this.bytesReceivedDelta.delta,T=g.inboundRTP.jitterBufferEmittedCount&&round((g.inboundRTP.jitterBufferDelay??0)/g.inboundRTP.jitterBufferEmittedCount*1e3),I=calcMacroblockRate(g.inboundRTP.frameWidth,g.inboundRTP.frameHeight,S||0),b=calcMacroblockRate(g.inboundRTP.frameWidth,g.inboundRTP.frameHeight,v||0);this.macroblockStatsTracker.captureSample(I,b),g.extensions={lossRate:m,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,frameRateReceived:S,frameRateDecoded:v,trackRecvFps:this.trackFramesDelta.delta,decodeTime:C||0,jitterBufferMs:T,bitrate:E?8*E:0,isFrozen:this.freezeHistogram.active,macroblockRateReceived:I,macroblockRateDecoded:b,macroblockRateStats:this.macroblockStatsTracker.getReport(),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,powerEfficient:void 0!==g.inboundRTP.powerEfficientDecoder?g.inboundRTP.powerEfficientDecoder:isPowerEfficient(g.inboundRTP.decoderImplementation),totalFreezeFraction:this.duration?this.freezeHistogram.totalDuration/this.duration:0,fpsHarmonicAverage:round(this.harmonicDecodedFps.harmonicMean)},this.duration++}},dC=class{constructor(g){this.configProvider=g,this.duration=0,this.lossRateAverager=new Dv,this.bitrateAverager=new Dv,this.jitterAverager=new Dv,this.frameRateAverager=new Dv,this.freezeHistogram=new Fv,this.harmonicDecodedFps=new Uv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.resolutionDurations=new xv,this.codecCalculator=new zv}processSample(g,m,S){const v=g.sort(((g,m)=>m.inboundRTP.frameHeight*m.inboundRTP.frameWidth-g.inboundRTP.frameHeight*g.inboundRTP.frameWidth))[0],C={inboundRTP:v.inboundRTP};v.transport&&Object.defineProperty(C,"transport",{value:v.transport,configurable:!1,enumerable:!1}),v.codec&&(C.codec=v.codec,this.configProvider?.config.isAv1Allowed&&"sharing"===v.mediaEntity?.modality&&this.codecCalculator.captureSample(v.codec.mimeType,v.renderer?.msi)),v.track&&(C.track=v.track),v.remoteOutboundRTP&&(C.remoteOutboundRTP=v.remoteOutboundRTP),v.extensions&&(C.extensions=v.extensions),v.extensions&&(this.harmonicDecodedFps.captureSample(v.extensions.frameRateDecoded),this.lossRateAverager.captureSample(v.extensions.lossRate),this.bitrateAverager.captureSample(v.extensions.bitrate),this.jitterAverager.captureSample(1e3*(v.inboundRTP.jitter??0)),this.frameRateAverager.captureSample(v.extensions.frameRateReceived??v.extensions.frameRateDecoded),this.freezeHistogram.active=v.extensions.isFrozen,v.inboundRTP.frameWidth&&v.inboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${v.inboundRTP.frameWidth}x${v.inboundRTP.frameHeight}`),C.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,avgFrameRate:round(this.frameRateAverager.avg),fpsHarmonicAverage:round(this.harmonicDecodedFps.harmonicMean),avgJitterBufferSize:round(this.jitterAverager.avg),bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),bitrateMinNonZero:round(this.bitrateAverager.minNonZeroSample,0),ongoingFreezeDuration:this.freezeHistogram.ongoingDuration,numFreezes:this.freezeHistogram.numEvents,avgFreezeDuration:round(this.freezeHistogram.avgDuration),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,freezeCountHistogram:this.freezeHistogram.counts,freezeTimestampsHistogram:this.freezeHistogram.timestamps,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,macroblockRateStats:v.extensions.macroblockRateStats,codecReport:this.codecCalculator?.report},this.duration++),arrayLimitedPush(m,C,S)}},hC=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new $v,this.lossRateAverager=new Dv,this.captureFreezeIntervalsCount=0,this.bytesSendDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.encodedFramesDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.sentFramesDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.harmonicEncodedFps=new Uv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.encodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new kv(2):new Nv,this.qpDelta=this.useLastSampleDeltaPerSecondConverter?new kv(3):new Nv,this.fsOvershoot=new Hv,this.fpsOvershoot=new Hv(1),this.brOvershoot=new Hv,this.plisDelta=new Nv,this.pliRate=new jv(60),this.resolutionSwitcherTracker=new qv(this.configProvider.config.diagnostics.collectionLimits.numResolutionSwitches),this.bitrateAverager=new Dv,this.rttAverager=new Dv,this.lastBytes=0}processSample(g){const m=this.lossRateCalculator.calculate(g.remoteInboundRTP?.packetsReceived,g.remoteInboundRTP?.packetsLost);this.lossRateAverager.captureSample(m),this.plisDelta.captureSample(g.outboundRTP.pliCount),this.pliRate.captureSample(this.plisDelta.delta),this.packetsDelta.captureSample(g.outboundRTP.packetsSent,g.outboundRTP.timestamp),this.packetsLostDelta.captureSample(g.remoteInboundRTP?.packetsLost,g.remoteInboundRTP?.timestamp),this.lastBytes=g.outboundRTP.bytesSent,this.bytesSendDelta.captureSample(g.outboundRTP.bytesSent,g.outboundRTP.timestamp);const S=this.bytesSendDelta.delta,v=S?8*S:void 0;this.bitrateAverager.captureSample(v),this.rttAverager.captureSample(1e3*(g.remoteInboundRTP?.roundTripTime??0)),this.encodedFramesDelta.captureSample(g.outboundRTP.framesEncoded,g.outboundRTP.timestamp);const C=this.encodedFramesDelta.delta;this.sentFramesDelta.captureSample(g.outboundRTP.framesSent,g.outboundRTP.timestamp);const _=this.sentFramesDelta.delta||0;this.harmonicEncodedFps.captureSample(C);const E=g.mediaSource?.framesPerSecond;0===E&&void 0!==this.lastCaptureFramerate&&this.lastCaptureFramerate>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFramerate=E,this.encodeTimeDelta.captureSample(g.outboundRTP.totalEncodeTime,g.outboundRTP.timestamp);const T=this.encodeTimeDelta.delta&&C&&round(this.encodeTimeDelta.delta/C*1e3,0);this.qpDelta.captureSample(g.outboundRTP.qpSum,g.outboundRTP.timestamp);const I=this.qpDelta.delta&&C&&round(this.qpDelta.delta/C,2);g.outboundRTP.frameWidth&&g.outboundRTP.frameHeight&&this.resolutionSwitcherTracker.captureSample(g.outboundRTP.frameWidth,g.outboundRTP.frameHeight);const b=this.diagnostics.deviceManager?.latestCameraOpenResolution,A=g.appliedCapabilities??g.requestedCapabilities;A&&(void 0!==g.outboundRTP.frameHeight&&void 0!==g.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(g.outboundRTP.frameHeight/16*(g.outboundRTP.frameWidth/16),A.maxFs),this.fpsOvershoot.captureSample(_,A.maxFps),A.maxBr&&this.brOvershoot.captureSample(v,A.maxBr));const R=[];for(const g of this.fsOvershoot.events)R.push({...g,overshootType:"fs"});for(const g of this.fpsOvershoot.events)R.push({...g,overshootType:"fps"});for(const g of this.brOvershoot.events)R.push({...g,overshootType:"br"});R.sort(((g,m)=>g.timestamp-m.timestamp)),g.extensions={cameraOpenResolution:b,lossRate:m,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,pliRate:this.pliRate.getRate(),frameRateEncoded:this.encodedFramesDelta.delta,frameRateSent:_,bitrate:v||0,encodeTime:T||0,qp:I||0,captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:R,powerEfficient:void 0!==g.outboundRTP.powerEfficientEncoder?g.outboundRTP.powerEfficientEncoder:isPowerEfficient(g.outboundRTP.encoderImplementation),bitrateAvg:round(this.bitrateAverager.avg,0),rttAvg:round(this.rttAverager.avg)},this.duration++}},uC=class{constructor(g){this.configProvider=g,this.duration=0,this.lossRateAverager=new Dv,this.bitrateAverager=new Dv,this.sendBWEAverager=new Dv,this.rttAverager=new Dv,this.framerateAverager=new Dv,this.captureFpsAverager=new Dv,this.captureFreezeIntervalsCount=0,this.lastCaptureFps=void 0,this.resolutionDurations=new xv,this.fsOvershoot=new Hv,this.fpsOvershoot=new Hv(1),this.brOvershoot=new Hv,this.harmonicEncodedFps=new Uv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax)}processSample(g,m,S){g.length>1&&g.sort(((g,m)=>{const S=g.appliedCapabilities??g.requestedCapabilities,v=m.appliedCapabilities??m.requestedCapabilities;return S?.maxMbps&&v?.maxMbps?v.maxMbps-S.maxMbps:0}));const v=g[0],C={outboundRTP:v.outboundRTP};if(v.transport&&Object.defineProperty(C,"transport",{value:v.transport,configurable:!1,enumerable:!1}),v.codec&&(C.codec=v.codec),v.track&&(C.track=v.track),v.mediaSource&&(C.mediaSource=v.mediaSource),v.remoteInboundRTP&&(C.remoteInboundRTP=v.remoteInboundRTP),v.extensions&&(C.extensions=v.extensions),v.extensions){this.lossRateAverager.captureSample(v.extensions.lossRate),this.bitrateAverager.captureSample(v.extensions.bitrate),this.sendBWEAverager.captureSample(v.transport?.selectedCandidatePair?.availableOutgoingBitrate),this.rttAverager.captureSample(v.remoteInboundRTP?.roundTripTime),this.framerateAverager.captureSample(v.extensions.frameRateSent);const g=v.mediaSource?.framesPerSecond;this.captureFpsAverager.captureSample(g),0===g&&void 0!==this.lastCaptureFps&&this.lastCaptureFps>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFps=g,v.outboundRTP.frameWidth&&v.outboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${v.outboundRTP.frameWidth}x${v.outboundRTP.frameHeight}`);const m=v.appliedCapabilities??v.requestedCapabilities;m&&(void 0!==v.outboundRTP.frameHeight&&void 0!==v.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(v.outboundRTP.frameHeight/16*(v.outboundRTP.frameWidth/16),m.maxFs),this.fpsOvershoot.captureSample(v.extensions.frameRateSent,m.maxFps),m.maxBr&&this.brOvershoot.captureSample(v.extensions?.bitrate,m.maxBr)),this.harmonicEncodedFps.captureSample(v.extensions.frameRateEncoded);const S=[];for(const g of this.fsOvershoot.events)S.push({...g,overshootType:"fs"});for(const g of this.fpsOvershoot.events)S.push({...g,overshootType:"fps"});for(const g of this.brOvershoot.events)S.push({...g,overshootType:"br"});S.sort(((g,m)=>g.timestamp-m.timestamp)),C.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,frameRateAvg:round(this.framerateAverager.avg),captureFramerateAvg:round(this.captureFpsAverager.avg),fpsHarmonicAverage:round(this.harmonicEncodedFps.harmonicMean),qpAvg:round(v.outboundRTP.qpSum/v.outboundRTP.framesSent),rttAvg:round(this.rttAverager.avg),bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),bitrateMinNonZero:round(this.bitrateAverager.minNonZeroSample,0),bweAvg:round(this.sendBWEAverager.avg,0),captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:S},this.duration++}arrayLimitedPush(m,C,S)}},gC=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.extenders=new Map}processStats(g){const m=new Set;for(const S in g)try{m.add(S);const v=g[S],C=this.extenders.get(v.id)??new pC(this.configProvider,this.diagnostics);this.extenders.set(v.id,C),C.processSample(v)}catch(g){this.diagnostics.addStatsError("TransportStatsProcessor",stringifyObject(g))}clearMap(this.extenders,m)}},pC=class{constructor(g,m){this.configProvider=g,this.diagnostics=m,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.bwJumpsHistogramCollector=new Fv,this.sendBWEAverager=new Dv,this.recvBWEAverager=new Dv,this.sendBW=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.recvBW=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.sendBWAverager=new Dv,this.recvBWAverager=new Dv}processSample(g){this.sendBWEAverager.captureSample(g.selectedCandidatePair?.availableOutgoingBitrate),this.recvBWEAverager.captureSample(g.selectedCandidatePair?.availableIncomingBitrate),this.sendBW.captureSample(g.selectedCandidatePair?.bytesSent,g.selectedCandidatePair?.timestamp),this.recvBW.captureSample(g.selectedCandidatePair?.bytesReceived,g.selectedCandidatePair?.timestamp);const m=this.sendBW.delta,S=this.recvBW.delta,v=m?8*m:void 0,C=S?8*S:void 0;this.sendBWAverager.captureSample(v),this.recvBWAverager.captureSample(C);const _=g.selectedCandidatePair?.availableOutgoingBitrate;_&&(this.bwJumpsHistogramCollector.active=this.bwJumpsHistogramCollector.active&&_<this.configProvider.config.webrtcBWJumpUpperLimit||_<this.configProvider.config.webrtcBWJumpLowerLimit),g.extensions={sendBWEAvg:round(this.sendBWEAverager.avg,0),sendBWEMax:round(this.sendBWEAverager.maxSample,0),recvBWEAvg:round(this.recvBWEAverager.avg,0),recvBWEMax:round(this.recvBWEAverager.maxSample,0),sendBitrate:v,recvBitrate:C,sendBWAvg:round(this.sendBWAverager.avg,0),sendBWMax:round(this.sendBWAverager.maxSample,0),recvBWAvg:round(this.recvBWAverager.avg,0),recvBWMax:round(this.recvBWAverager.maxSample,0),bwJumpsHistogram:this.bwJumpsHistogramCollector.counts,reflexiveLocalIP:this.diagnostics.reflexiveLocalIP}}},mC=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.extenders=new Map}processStats(g){if(!g)return;const m=new Set;for(const S of g)try{m.add(S.id);const g=this.extenders.get(S.id)??new fC(this.configProvider);this.extenders.set(S.id,g),g.processSample(S)}catch(g){this.diagnostics.addStatsError("DataChannelStatsProcessor",stringifyObject(g))}clearMap(this.extenders,m)}},fC=class{constructor(g){this.configProvider=g,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.sendBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.recvBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.sendMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv,this.recvMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new kv:new Nv}processSample(g){this.sendBytesDeltaCalculator.captureSample(g.bytesSent,g.timestamp),this.recvBytesDeltaCalculator.captureSample(g.bytesReceived,g.timestamp);const m=this.sendBytesDeltaCalculator.delta,S=this.recvBytesDeltaCalculator.delta,v=m?8*m:void 0,C=S?8*S:void 0;this.sendMessagesDeltaCalculator.captureSample(g.messagesSent,g.timestamp),this.recvMessagesDeltaCalculator.captureSample(g.messagesReceived,g.timestamp);const _=this.sendMessagesDeltaCalculator.delta,E=this.recvMessagesDeltaCalculator.delta;g.extensions={sendBitrate:v,recvBitrate:C,sendMessageRate:_,recvMessageRate:E}}},SC=class{constructor(g){this.collecVideoStatsAfterSubscription=g,this.videoStatsEvent=[],this.count=0}prepareCollectingStatsOnSubscribed(g){this.count=0,this.videoStatsEvent.push({ts:Date.now(),framesDecoded:[],bytesReceived:[],height:[],msi:g})}captureStatsOnSubscribed(g,m,S,v){if(this.count>=this.collecVideoStatsAfterSubscription)return;const C=getLast(this.videoStatsEvent);C&&(C.framesDecoded.push(g),C.bytesReceived.push(m),void 0!==S&&C.height.push(S)),this.count++}getStatsOnSubscribed(){return this.videoStatsEvent}},vC=class{constructor(g,m,S,v){this.slidingWindowSize=g,this.maxDeviation=m,this.minBandwidth=S,this.directionalityCheck=v,this.slidingWindow=new Fm(this.slidingWindowSize),this.currentModality=null,this.previousModality=null,this.inProcess=!1}processBandwidth(g,m,S){this.currentModality?this.handleStopEvent(m,S):this.handleStartEvent(m,S),this.inProcess&&(this.stabilizationTime++,this.slidingWindow.add(g),this.inProcess=!this.slidingWindow.isFull||!this.isBandwidthStable())}getReport(g=!1){if(void 0!==this.stabilizationTime){return{time:this.inProcess?this.stabilizationTime:Math.max(this.stabilizationTime-this.slidingWindowSize,0),bandwidth:g?round(this.averageBandwidth,2):this.averageBandwidth,finished:!this.inProcess,modality:this.previousModality}}}handleStartEvent(g,m){this.currentModality=this.GetModalityString(g),m&&this.currentModality&&!this.previousModality&&(this.previousModality=this.currentModality,this.stabilizationTime=0,this.slidingWindow.clear(),this.inProcess=!0)}handleStopEvent(g,m){m&&(this.directionalityCheck(g.audio)||this.directionalityCheck(g.video)||this.directionalityCheck(g.sharing))||(this.currentModality=null,this.inProcess=!1)}GetModalityString(g){return[this.directionalityCheck(g.audio)?Ke.MODALITY.audio:null,this.directionalityCheck(g.video)?Ke.MODALITY.video:null,this.directionalityCheck(g.sharing)?Ke.MODALITY.sharing:null].filter(Boolean).join(", ")}isBandwidthStable(){if(this.averageBandwidth=average(this.slidingWindow.items),this.averageBandwidth<this.minBandwidth)return!1;{const g=this.averageBandwidth*this.maxDeviation,m=this.averageBandwidth-g,S=this.averageBandwidth+g;return this.slidingWindow.items.every((g=>isInRange(g,m,S)))}}},CC=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.uplinkStabilizationTelemetry=new vC(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,hasSendDirectionality),this.downlinkSabilizationTelemetry=new vC(this.configProvider.config.downlinkBWStabilizationSlidingWindowSize,this.configProvider.config.downlinkBWStabilizationMaxDeviation,this.configProvider.config.downlinkBWStabilizationMinBandwidth,hasReceiveDirectionality),this.bandwidthCalculator=new Gv,this.bandwidthAvg=new Dv}processStats(g){const m=this.diagnostics.getObjectRef(),S=m?.activeModalities;if(!S||!g.transports)return;const v=g.transports[Object.keys(g.transports)[0]],C=m?.reportedReceiveBandwidth?.[m.reportedReceiveBandwidth.length-1],_=v?.selectedCandidatePair?.availableOutgoingBitrate,E=g.audio?.send?.length>0||g.video?.send?.length>0||g.sharing?.send?.length>0,T=g.audio?.recv?.length>0||g.video?.recv?.length>0||g.sharing?.recv?.length>0;this.bweType!==m?.bweType&&(this.bandwidthCalculator=new Gv,this.bandwidthAvg=new Dv,this.bweType=m?.bweType);const I="REMB"===m?.bweType?"availableIncomingBitrate":"availableOutgoingBitrate",b=v?.selectedCandidatePair?.[I];this.bandwidthCalculator.captureSample(b),this.bandwidthAvg.captureSample(b);try{this.uplinkStabilizationTelemetry.processBandwidth(_,S,E),this.downlinkSabilizationTelemetry.processBandwidth(C,S,T)}catch(g){this.diagnostics.addStatsError("BandwithStatsProcessor",stringifyObject(g))}}getStabilizedReport(g=!1){return this.uplinkStabilizationTelemetry.getReport(g)}getDownlinkStabilizedReport(g=!1){return this.downlinkSabilizationTelemetry.getReport(g)}calculateBwPercentiles(){if(!this.bandwidthCalculator.getFirst())return;const g=this.configProvider.config.bwPercentiles,m={};return g.forEach((g=>{Object.defineProperty(m,g,{value:this.bandwidthCalculator.calculatePercentile(g/100),enumerable:!0})})),m}getBandwidthReport(){return{startOfTheCall:this.bandwidthCalculator.getFirst(),endOfTheCall:this.bandwidthCalculator.getLast(),std:this.bandwidthCalculator.calculateStd(),bwPercentiles:this.calculateBwPercentiles(),avgBwe:round(this.bandwidthAvg.avg,2)}}},_C=class{constructor(g,m){this.configProvider=g,this.diagnostics=m,this.dataChannelStatsProcessor=new mC(this.diagnostics,this.configProvider),this.transportStatsProcessor=new gC(this.diagnostics,this.configProvider),this.audioStatsProcessor=new eC(this.diagnostics,this.configProvider),this.videoStatsProcessor=new lC(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new lC(this.diagnostics,this.configProvider),this.bandwithStatsProcessor=new CC(this.diagnostics,this.configProvider),this.macroblockStatsTracker=new Wv,this.statsAggregators={audio:{recv:new iC,send:new rC(this.diagnostics)},video:{recv:new dC(this.configProvider),send:new uC(this.configProvider)},sharing:{recv:new dC(this.configProvider),send:new uC(this.configProvider)}},this.aggregatedModalityStats={},this.recvVideoStreamsCounter=new Ov,this.multiviewData={},this.multiviewKeySet=new Set,this.statsOnSubscribedData={video:{},sharing:{}},this.statsOnSubscribed={video:[],sharing:[]},this.diagnostics.aggregatedStatsRef=this.aggregatedModalityStats,this.diagnostics.statsOnSubscribed=this.statsOnSubscribed,this.diagnostics.bandwidthDiagnostic=this.bandwithStatsProcessor}processStats(g){this.dataChannelStatsProcessor.processStats(g.data),this.transportStatsProcessor.processStats(g.transports),this.audioStatsProcessor.processStats(g.audio),this.videoStatsProcessor.processStats(g.video),this.sharingStatsProcessor.processStats(g.sharing),this.bandwithStatsProcessor.processStats(g),this.diagnostics.bwStabiliationTime=this.bandwithStatsProcessor.getStabilizedReport(!0),this.diagnostics.bwDownlinkStabiliationTime=this.bandwithStatsProcessor.getDownlinkStabilizedReport(!0),this.recvVideoStreamsCounter.captureSample(g.video?.recv?.length),this.diagnostics.recvVideoStreamsCount={min:this.recvVideoStreamsCounter.min,max:this.recvVideoStreamsCounter.max,mode:this.recvVideoStreamsCounter.mode};try{this.processAggregated(g)}catch(g){this.diagnostics.addStatsError("webrtcStatistics:processAggregated",stringifyObject(g))}try{this.processMultiview(g.video?.recv??[])}catch(g){this.diagnostics.addStatsError("webrtcStatistics:processMultiview",stringifyObject(g))}try{const g=navigator?.connection;g&&this.diagnostics.addNetworkInfo({downlink:g.downlink,rtt:g.rtt,effectiveType:g.effectiveType,saveData:g.saveData})}catch(g){this.diagnostics.addStatsError("webrtcStatistics:processStats(networkInfo)",stringifyObject(g))}try{this.processMacroblockRateStats(g.video?.recv)}catch(g){this.diagnostics.addStatsError("webrtcStatistics: processMacroblockRateStats",stringifyObject(g))}}signalNoConnection(){this.transportStatsProcessor=new gC(this.diagnostics,this.configProvider),this.audioStatsProcessor=new eC(this.diagnostics,this.configProvider),this.videoStatsProcessor=new lC(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new lC(this.diagnostics,this.configProvider)}processMultiview(g){const m=new Set;for(const S of g){const g=S.inboundRTP.id;m.add(g);let v=this.multiviewData[g];v&&this.multiviewKeySet.has(g)?v.stats.duration++:(v={bitrateAverager:new Dv,jitterAverager:new Dv,frameRateAverager:new Dv,freezeHistogram:new Fv,resolutionDurations:new xv,isRenderingEvents:[],statsOnSubscribed:new SC(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),stats:{ssrc:S.inboundRTP.ssrc,startTime:Date.now(),duration:0,framesDecoded:[],bytesReceived:[],height:[],width:[]}},v.statsOnSubscribed.prepareCollectingStatsOnSubscribed(S.renderer?.msi),this.multiviewData[g]=v),v.statsOnSubscribed.captureStatsOnSubscribed(S.inboundRTP.framesDecoded,S.inboundRTP.bytesReceived,S.inboundRTP.frameHeight),v.bitrateAverager.captureSample(S.extensions?.bitrate),v.jitterAverager.captureSample(1e3*(S.inboundRTP.jitter??0)),v.frameRateAverager.captureSample(S.extensions.frameRateReceived),v.freezeHistogram.active=S.extensions?.isFrozen,S.inboundRTP.frameWidth&&S.inboundRTP.frameHeight&&v.resolutionDurations.captureSample(`${S.inboundRTP.frameWidth}x${S.inboundRTP.frameHeight}`);const C=S.renderer?.isRendering??!1;(!v.isRenderingEvents.length&&C||v.isRenderingEvents.length&&getLast(v.isRenderingEvents).isRendering!==C)&&arrayLimitedPush(v.isRenderingEvents,{isRendering:C,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents),v.stats.frameRateAvg=round(v.frameRateAverager.avg),v.stats.bitrateAvg=round(v.bitrateAverager.avg,0),v.stats.bitrateMax=round(v.bitrateAverager.maxSample,0),v.stats.bitrateMinNonZero=round(v.bitrateAverager.minNonZeroSample),v.stats.freezeHistogram=v.freezeHistogram.counts,v.stats.freezeTimestamps=v.freezeHistogram.timestamps,v.stats.avgFreezeDuration=round(v.freezeHistogram.avgDuration),v.stats.totalFreezeDuration=v.freezeHistogram.totalDuration,v.stats.ongoingFreeze=v.freezeHistogram.active,v.stats.ongoingFreezeDuration=v.freezeHistogram.ongoingDuration,v.stats.numResolutionSwitches=v.resolutionDurations.changeCount,v.stats.rendererSize=`${S.renderer?.rendererSize?.width}x${S.renderer?.rendererSize?.height}`,v.stats.resolutionDurations=v.resolutionDurations.durations,v.stats.timeToFirstFrame=S.renderer?.timeToFirstFrame,v.stats.timeToFirstFrameSinceSubscriptionStart=S.renderer?.timeToFirstFrameSinceSubscriptionStart,v.stats.isRenderingEvents=v.isRenderingEvents,v.stats.statsOnSubscribed=v.statsOnSubscribed.getStatsOnSubscribed(),v.stats.msi=S.renderer?.msi,v.stats.rendererStates=S.renderer?.rendererStates,arrayLimitedPush(v.stats.framesDecoded,S.inboundRTP.framesDecoded,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),arrayLimitedPush(v.stats.bytesReceived,S.inboundRTP.bytesReceived,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),arrayLimitedPush(v.stats.height,S.inboundRTP.frameHeight,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),arrayLimitedPush(v.stats.width,S.inboundRTP.frameWidth,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples);const _=S.extensions?.macroblockRateStats??{};for(const g in _)v.stats[g]=round(_[g],0)}this.diagnostics.multiViewStats=Object.values(this.multiviewData).map((g=>g.stats)),this.multiviewKeySet=m}processAggregated(g){for(const m of["audio","video","sharing"])if(g[m])for(const S in g[m])this.processAggregatedModality(g,m,S)}processAggregatedModality(g,m,S){var v,C;const _=g[m]?.[S]?.length??0;_>0&&((v=this.aggregatedModalityStats)[m]??(v[m]={}),(C=this.aggregatedModalityStats[m])[S]??(C[S]=[]),_>1&&("audio"===m||"sharing"===m)&&this.diagnostics.addStatsError("webrtcStatistics:processAggregatedModality",`Multiple ${m} ${S} streams: ${_}`),this.statsAggregators[m][S].processSample(g[m][S],this.aggregatedModalityStats[m][S],this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),"sharing"!==m&&"video"!==m||"recv"!==S||this.processStatsOnSubscribed(g[m][S],m))}processStatsOnSubscribed(g,m){const S=new Set;for(const v of g)if(v.inboundRTP){const g=`${v.inboundRTP.id}x${v.renderer?.msi}`;let C=this.statsOnSubscribedData[m]?.[g];S.add(g),C||(C=new SC(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),C.prepareCollectingStatsOnSubscribed(v.renderer?.msi),this.statsOnSubscribedData[m][g]=C,this.statsOnSubscribed[m].push(...C.getStatsOnSubscribed())),C.captureStatsOnSubscribed(v.inboundRTP.framesDecoded,v.inboundRTP.bytesReceived)}clearObj(this.statsOnSubscribedData[m],S)}processMacroblockRateStats(g){if(!g?.length)return;let m=0,S=0;for(const v of g)m+=v.extensions?.macroblockRateReceived,S+=v.extensions?.macroblockRateDecoded;this.macroblockStatsTracker.captureSample(m,S),this.diagnostics.setTotalVideoRecvMblocksRates(this.macroblockStatsTracker.getReport())}},yC=P,EC=class{constructor(g,m,S,v){this.logger=g,this.configProvider=m,this.diagnostics=S,this.mediaManager=v,this.webrtcStats=new _C(this.configProvider,this.diagnostics),this.ssrcToRecvTrackMap=new Map,this.activeChannels={}}setAudioDecoderStatsProvider(g){this.audioDecoderStatsProvider=g}signalNoConnection(){this.webrtcStats.signalNoConnection()}processRawReport(g){this.diagnostics.latestRawReport=g;const m={loopTime:-1,fetchTime:-1,convertTime:-1,processingTime:-1,legacyProcessingTime:-1};try{let S=Je(),v=S;const C=this.convertStatsReport(g);return C.perfCounters=m,S=Je(),m.convertTime=S-v,v=S,this.webrtcStats.processStats(C),this.diagnostics.addStatsReport(C),S=Je(),m.processingTime=S-v,C}catch(g){const m=stringifyObject(g);return this.logger.safe.error(`Error processing raw stats: ${m}`),void this.diagnostics.addStatsError("StatisticsGatherer:processRawReport",m)}}setSsrcTrackPair(g,m){null===m?this.ssrcToRecvTrackMap.delete(g):this.ssrcToRecvTrackMap.set(g,m)}convertStatsReport(g){const m={transports:this.processTransportStats(g)};return this.appendPcStats(g,m),this.appendSendMediaStats(g,m),this.appendRecvMediaStats(g,m),g["data-channel"]&&(m.data=Object.values(g["data-channel"])),m}processTransportStats(g){if(g.transport){const m={};for(const S in g.transport){const v=g.transport[S];if(m[S]=shallowClone(v),v.selectedCandidatePairId){const C=shallowClone(g["candidate-pair"][v.selectedCandidatePairId]);C.localCandidate=g["local-candidate"][C.localCandidateId],C.remoteCandidate=g["remote-candidate"][C.remoteCandidateId],m[S].selectedCandidatePair=C}v.localCertificateId&&g.certificate&&(m[S].localCertificate=g.certificate[v.localCertificateId]),v.remoteCertificateId&&g.certificate&&(m[S].remoteCertificate=g.certificate[v.remoteCertificateId])}return m}if(g["candidate-pair"]){const m={};for(const S in g["candidate-pair"]){const v=shallowClone(g["candidate-pair"][S]);v.selected&&(v.localCandidate=g["local-candidate"][v.localCandidateId],v.remoteCandidate=g["remote-candidate"][v.remoteCandidateId],m.faketransport={id:"faketransport",timestamp:v.timestamp,type:"transport",selectedCandidatePair:v,selectedCandidatePairId:v.id})}return m}}appendPcStats(g,m){let S="";g["peer-connection"]&&(Object.keys(g["peer-connection"]).forEach((g=>{""===S?S=g:(this.logger.safe.error(`Unexpected second peer connection stats id ${g}, also found ${S}`),this.diagnostics.addStatsError("StatisticsGatherer","Unexpected second peer connection stats"))})),m.peerConnection=g["peer-connection"][S])}appendSendMediaStats(g,m){var S,v,C,_;for(const E in g["outbound-rtp"]){const T=g["outbound-rtp"][E],I={outboundRTP:T};T.codecId&&g.codec&&(I.codec=g.codec[T.codecId]),Object.defineProperty(I,"transport",{value:m.transports[T.transportId??"faketransport"],configurable:!1,enumerable:!1}),T.remoteId&&g["remote-inbound-rtp"]&&(I.remoteInboundRTP=g["remote-inbound-rtp"][T.remoteId]),T.mediaSourceId&&g["media-source"]&&(I.mediaSource=g["media-source"][T.mediaSourceId]),T.trackId&&g.track&&(I.track=g.track[T.trackId]);const b=getEntityByLocalTrack(this.mediaManager,I.track?.trackIdentifier??I.mediaSource?.trackIdentifier,T.rid)??getEntityByLocalSSRC(this.mediaManager,T.ssrc,T.rid)??getMediaEntitieByMid(this.mediaManager,I.outboundRTP.mid,T.rid);if(!b?.getLocalTrackId())continue;I.mediaEntity=b.serialize(),!I.mediaSource&&I.mediaEntity&&g["media-source"]&&(I.mediaSource=Object.entries(g["media-source"]).find((([g,m])=>g.includes(I.mediaEntity.localTrackId)))[1]);const A="video"===T.kind?"sharing"===b?.getModality()?"sharing":"video":T.kind;if((S=this.activeChannels)[A]??(S[A]={}),(v=this.activeChannels[A]).send??(v.send={}),hasSendDirectionality(this.diagnostics.getObjectRef().activeModalities?.[A])){if(m[A]||(m[A]={}),m[A].send||(m[A].send=[]),"video"===T.kind){const g=getRequestedCapabilitiesBySsrc(this.diagnostics,A,T.ssrc)??getRequestedCapabilitiesBySsrc(this.diagnostics,A,0);g&&(I.requestedCapabilities=g);const S=getAppliedCapabilitiesBySsrc(this.diagnostics,A,T.ssrc)??getAppliedCapabilitiesBySsrc(this.diagnostics,A,0);S&&(I.appliedCapabilities=S);const v=m[A].send.find((g=>g.outboundRTP.trackId===I.outboundRTP.trackId));if(v){const g=parseInt(v.outboundRTP.rid,10)>parseInt(I.outboundRTP.rid,10);if(!v.altLayouts&&g&&(v.altLayouts=[]),g)v.altLayouts.push(I);else{I.altLayouts=[],I.altLayouts.push(v);const g=m[A].send.indexOf(v);m[A].send[g]=I}continue}}this.activeChannels[A].send[T.id]=I,m[A].send.push(I)}else this.activeChannels[A].send[T.id]&&"sharing"!==A&&(m.inactiveTracks??(m.inactiveTracks={}),(C=m.inactiveTracks)[A]??(C[A]={}),(_=m.inactiveTracks[A]).send??(_.send=[]),m.inactiveTracks[A].send.push(this.activeChannels[A].send[T.id]))}}appendRecvMediaStats(g,m){var S,v,C,_;const E=this.diagnostics.getObjectRef().subscriptionManager?.subscribedTrackIds;for(const T in g["inbound-rtp"]){const I=g["inbound-rtp"][T],b={inboundRTP:I};I.codecId&&g.codec&&(b.codec=g.codec[I.codecId]),"audio"===I.kind&&b.inboundRTP.ssrc===this.audioDecoderStatsProvider?.ssrc&&(b.codec||(b.codec={transportId:I.transportId??"faketransport",id:"fakeCodec",payloadType:999,timestamp:I.timestamp,type:"codec",mimeType:"unk"}),b.codec.mimeType=this.audioDecoderStatsProvider.codecName,b.inboundRTP=(0,yC.merge)(b.inboundRTP,this.audioDecoderStatsProvider.getWebRtcCompatibaleStats()),b.customHealerStats=this.audioDecoderStatsProvider.getWasmStats()),m.transports[I.transportId??"faketransport"]&&Object.defineProperty(b,"transport",{value:m.transports[I.transportId??"faketransport"],configurable:!1,enumerable:!1}),I.remoteId&&g["remote-outbound-rtp"]&&(b.remoteOutboundRTP=g["remote-outbound-rtp"][I.remoteId]);const A=b.inboundRTP.trackIdentifier??this.ssrcToRecvTrackMap.get(I.ssrc);if(I.trackId||A){I.trackId&&g.track?b.track=g.track[I.trackId]:A&&(b.track={id:"ssrcToTrackId",kind:I.kind,timestamp:I.timestamp,type:"track",trackIdentifier:A});const m=getRendererDiagnosticsByTrack(this.diagnostics,b.track?.trackIdentifier);m&&(b.renderer=m)}const R=getEntityByRemoteTrack(this.mediaManager,b.track?.trackIdentifier)??getEntityByRemoteSSRC(this.mediaManager,I.ssrc);if(!R)continue;b.mediaEntity=R.serialize();const P="video"===I.kind&&b.track?"sharing"===R?.getModality()?"sharing":"video":I.kind;(S=this.activeChannels)[P]??(S[P]={}),(v=this.activeChannels[P]).recv??(v.recv={}),"video"!==I.kind||E.some((g=>g&&g===b.track?.trackIdentifier))?hasReceiveDirectionality(this.diagnostics.getObjectRef().activeModalities?.[P])&&(m[P]||(m[P]={}),m[P].recv||(m[P].recv=[]),this.activeChannels[P].recv[I.id]=b,m[P].recv.push(b)):this.activeChannels[P].recv[I.id]&&"sharing"!==P&&(m.inactiveTracks??(m.inactiveTracks={}),(C=m.inactiveTracks)[P]??(C[P]={}),(_=m.inactiveTracks[P]).recv??(_.recv=[]),m.inactiveTracks[P].recv.push(this.activeChannels[P].recv[I.id]))}}};function verifyRidIfPresent(g,m){return!m||g.getSimulcastContext()?.activeRids.map(String).some((g=>g===m))}function getEntityByRemoteSSRC(g,m){return g.getMediaEntities().find((g=>g.getRemoteSsrc()===m))}function getEntityByRemoteTrack(g,m){const S=g.getMediaEntities();return void 0!==m?S.find((g=>g.getRemoteTrackId()===m)):void 0}function getEntityByLocalSSRC(g,m,S){return g.getMediaEntities().find((g=>g.getLocalSsrc()===m&&verifyRidIfPresent(g,S)))}function getEntityByLocalTrack(g,m,S){const v=g.getMediaEntities();return m?v.find((g=>g.getLocalTrackId()===m&&verifyRidIfPresent(g,S))):void 0}function getRequestedCapabilitiesBySsrc(g,m,S){const v=g.getObjectRef().qualityManager;return"video"===m?v?.currentVideoSsrcRequestedCapabilities[`${S}`]:"sharing"===m?v?.currentSharingSsrcRequestedCapabilities[`${S}`]:void 0}function getAppliedCapabilitiesBySsrc(g,m,S){const v=g.getObjectRef().qualityManager;return"video"===m?v?.currentVideoSsrcAppliedCapabilities[`${S}`]:"sharing"===m?v?.currentSharingSsrcAppliedCapabilities[`${S}`]:void 0}function getRendererDiagnosticsByTrack(g,m){return g.getObjectRef().remoteVideoManager?.renderers.find((g=>g.trackId===m))}function getMediaEntitieByMid(g,m,S){const v=g.getMediaEntities();return m?v.find((g=>g.getMid()===m&&verifyRidIfPresent(g,S))):void 0}var TC=class{constructor(){this.googCandidatePair={},this.ssrc={},this.googComponent={},this.VideoBwe={bweforvideo:{}}}},IC=class{constructor(){this.statistics=new TC,this.statsDiffMap=new Map,this.ssrcTrackMap=new Map}build(g){return this.statistics=new TC,this.constructGoogCandidatePair(g),this.constructGoogSsrc(g),this.constructGoogComponent(g),this.constructDataChannel(g),this.constructBwe(g),this.statistics}setSsrcTrackPair(g,m){null===m?this.ssrcTrackMap.delete(g):this.ssrcTrackMap.set(g,m)}setAudioDecoderStatsProvider(g){this.audioDecoderStatsProvider=g}constructGoogSsrc(g){const m={};if(g.hasOwnProperty("outbound-rtp")){const S=g["outbound-rtp"];Object.keys(S).forEach((v=>{const C=`ssrc_${S[v].ssrc}_send`,_=this.constructSendSsrc(g,S[v]);m[C]=_}))}if(g.hasOwnProperty("inbound-rtp")){const S=g["inbound-rtp"];Object.keys(S).forEach((v=>{const C=`ssrc_${S[v].ssrc}_recv`,_=this.constructRecvSsrc(g,S[v]);m[C]=_}))}this.statistics.ssrc=m}constructSendSsrc(g,m){const S=m.trackId?g.track[m.trackId]:null,v=m.mediaSourceId?g["media-source"][m.mediaSourceId]:null,C=g["remote-inbound-rtp"]?.[m.remoteId],_=`ssrc_${m.ssrc}_send`,E=v?.trackIdentifier??S?.trackIdentifier??this.ssrcTrackMap.get(m.ssrc);let T={id:_,ssrc:m.ssrc,mediaType:m.mediaType??m.kind,bytesSent:m.bytesSent,bytesSentDiff:this.calculateDiff(_,m.bytesSent,4),packetsSent:m.packetsSent,packetsLost:C?.packetsLost,jitter:C?.jitter,googRtt:this.getRtt(C),googCodecName:this.getCodec(g,m.codecId),transportId:m.transportId,googTrackId:E};return"audio"===T.mediaType&&(T={...T,...this.constructAudioSendSsrc(m,v)}),"video"===T.mediaType&&(T={...T,...this.constructVideoSendSsrc(m,v,_,S)}),removeUndefinedFields(T)}constructAudioSendSsrc(g,m){return{audioInputLevel:m?.audioLevel,totalAudioEnergy:m?.totalAudioEnergy,fecPacketsSent:g.fecPacketsSent}}constructVideoSendSsrc(g,m,S,v){return{framesEncoded:g.framesEncoded,googFrameRateEncoded:this.calculateDiff(S,g.framesEncoded,2),googFrameRateSent:this.calculateDiff(S,g.framesSent??v?.framesSent,1),googFrameRateInput:m?.framesPerSecond,googFrameHeightSent:g.frameHeight??v?.frameHeight,googFrameWidthSent:g.frameWidth??v?.frameWidth,googFrameHeightInput:m?.height,googFrameWidthInput:m?.width,hugeFramesSent:g.hugeFramesSent??v?.hugeFramesSent,keyFramesEncoded:g.keyFramesEncoded,qpSum:g.qpSum,qp:this.calculateDiff(S,g.qpSum,8),googPlisReceived:g.pliCount,googFirsReceived:g.firCount,googNacksReceived:g.nackCount,qualityLimitationDurations:g.qualityLimitationDurations,qualityLimitationReason:g.qualityLimitationReason,qualityLimitationResolutionChanges:g.qualityLimitationResolutionChanges,codecImplementationName:g.encoderImplementation,rid:g.rid,encodeTime:g.totalEncodeTime&&Math.round(1e3*this.calculateDiff(S,g.totalEncodeTime,6))}}constructRecvSsrc(g,m){const S=m.trackId?g.track[m.trackId]:null,v=`ssrc_${m.ssrc}_recv`,C=m.trackIdentifier??S?.trackIdentifier??this.ssrcTrackMap.get(m.ssrc);let _={id:v,ssrc:m.ssrc,mediaType:m.mediaType??m.kind,bytesReceived:m.bytesReceived,bytesReceivedDiff:this.calculateDiff(v,m.bytesReceived,5),packetsReceived:m.packetsReceived,packetsLost:m.packetsLost,jitter:m.jitter,googJitterBufferMs:m.jitterBufferEmittedCount&&Math.round(m.jitterBufferDelay/m.jitterBufferEmittedCount*1e3),googCodecName:this.getCodec(g,m.codecId),googTrackId:C,transportId:m.transportId};return"audio"===_.mediaType&&(_={..._,...this.constructAudioRecvSsrc(m,S)}),"video"===_.mediaType&&(_={..._,...this.constructVideoRecvSsrc(m,v,S)}),removeUndefinedFields(_)}constructAudioRecvSsrc(g,m){const S=this.audioDecoderStatsProvider?.ssrc===g.ssrc?this.audioDecoderStatsProvider?.getWebRtcCompatibaleStats():g,v={audioOutputLevel:S.audioLevel??m?.audioLevel,totalAudioEnergy:S.totalAudioEnergy??m?.totalAudioEnergy,concealedSamples:S.concealedSamples,silentConcealedSamples:S.silentConcealedSamples,totalSamplesReceived:S.totalSamplesReceived,healedRatio:S.totalSamplesReceived&&(S.concealedSamples-S.silentConcealedSamples)/S.totalSamplesReceived,fecPacketsReceived:S.fecPacketsReceived,fecPacketsDiscarded:S.fecPacketsDiscarded,packetsDiscarded:S.packetsDiscarded};if(this.audioDecoderStatsProvider?.ssrc===g.ssrc){v.googJitterBufferMs=S.jitterBufferEmittedCount&&Math.round(S.jitterBufferDelay/S.jitterBufferEmittedCount*1e3),v.googCodecName=this.audioDecoderStatsProvider.codecName;const g=this.audioDecoderStatsProvider.getDecoderStats();v.pushCount=g.pushCount,v.pushErrCount=g.pushErrCount,v.pullCount=g.pullCount,v.pullErrCount=g.pullErrCount}return v}constructVideoRecvSsrc(g,m,S){return{framesDecoded:g.framesDecoded,googFrameRateDecoded:this.calculateDiff(m,g.framesDecoded,3),googFrameRateReceived:this.calculateDiff(m,g.framesReceived??S?.framesReceived,0),googFrameHeightReceived:g.frameHeight??S?.frameHeight,googFrameWidthReceived:g.frameWidth??S?.frameWidth,keyFramesDecoded:g.keyFramesDecoded,googPlisSent:g.pliCount,googFirsSent:g.firCount,googNacksSent:g.nackCount,codecImplementationName:g.decoderImplementation,decodeTime:g.totalDecodeTime&&Math.round(1e3*this.calculateDiff(m,g.totalDecodeTime,7))}}constructGoogCandidatePair(g){const m=g["candidate-pair"];m&&Object.keys(m).forEach((S=>{const v=this.constructPair(g,m[S]);this.statistics.googCandidatePair[v.id]=v}))}constructPair(g,m){const S=g["local-candidate"][m.localCandidateId],v=g["remote-candidate"][m.remoteCandidateId];return removeUndefinedFields({bytesReceived:m.bytesReceived,bytesSent:m.bytesSent,googTransportType:S.protocol,googRtt:m.currentRoundTripTime?Math.round(1e3*m.currentRoundTripTime):void 0,googLocalAddress:`${S.ip?S.ip:S.address}:${S.port}`,googLocalCandidateType:S.candidateType,localRelayProtocol:S.relayProtocol,localNetworkType:S.networkType,googRemoteAddress:`${v.ip?v.ip:v.address}:${v.port}`,googRemoteCandidateType:v.candidateType,googActiveConnection:m.nominated,requestsReceived:m.requestsReceived,requestsSent:m.requestsSent,responsesReceived:m.responsesReceived,responsesSent:m.responsesSent,consentRequestsSent:m.consentRequestsSent,id:m.id,remoteCandidateId:m.remoteCandidateId,localCandidateId:m.localCandidateId,googWritable:m.writable,selected:m.selected,packetsDiscardedOnSend:m.packetsDiscardedOnSend})}constructGoogComponent(g){g.transport&&Object.keys(g.transport).forEach((m=>{this.statistics.googComponent[m]={id:m,selectedCandidatePairId:g.transport[m].selectedCandidatePairId}}))}constructDataChannel(g){if(!g.hasOwnProperty("data-channel"))return;const m=g["data-channel"];this.statistics.data=Object.keys(m).map((g=>{const S=m[g];return{bytesReceived:S.bytesReceived,bytesSent:S.bytesSent,dataChannelIdentifier:S.dataChannelIdentifier,label:S.label,messagesReceived:S.messagesReceived,messagesSent:S.messagesSent,protocol:S.protocol,state:S.state,timestamp:S.timestamp,type:S.type}}))}constructBwe(g){const m=Object.values(g["outbound-rtp"]??{})?.find((g=>{const m=g.mediaType??g.kind;return"audio"===m||"video"===m}));if(!m)return;const S=g.transport?.[m.transportId];if(!S)return;const v=g["candidate-pair"]?.[S.selectedCandidatePairId];if(!v)return;const C={googAvailableSendBandwidth:v.availableOutgoingBitrate,googAvailableReceiveBandwidth:v.availableIncomingBitrate};this.statistics.VideoBwe.bweforvideo=removeUndefinedFields(C)}getRtt(g){const m=g?.roundTripTime;return m?Math.round(1e3*m):void 0}getCodec(g,m){if(m&&g.codec&&g.codec[m])return g.codec[m].mimeType.split("/")[1]}calculateDiff(g,m,S){if(void 0===m)return;let v=m;const C=this.statsDiffMap.has(g)?this.statsDiffMap.get(g):new Map;if(C.has(S)){const g=C.get(S);g<=m&&(v=m-g)}return C.set(S,m),this.statsDiffMap.set(g,C),isNaN(v)?void 0:v}},bC=P,AC=P,RC=class{constructor(g){this.healedRatio=0,this.healedRatioMax=0,this.healedRatioDuration=0,this.healedRatioTotal=0,this.totalSamplesReceivedDiff=0;const m=g.config;this.networkDetectionDuration=m.webrtcStatNetworkDetectionDuration,this.networkRecvQualityDiagnostics=m.networkRecvQualityDiagnostics,this.networkRecvQualityDiagnostics&&(this.healedRatioAccumulator=new Fm(m.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesAccumulator=new Fm(m.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesAccumulator=new Fm(m.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedAccumulator=new Fm(m.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesDiffAccumulator=new Fm(m.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesDiffAccumulator=new Fm(m.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedDiffAccumulator=new Fm(m.webrtcHealedRatioExtendedWindowSize))}captureHealedRatioSamples(g,m,S){!g||!m||!S||g.length<=this.networkDetectionDuration||m.length<=this.networkDetectionDuration||S.length<=this.networkDetectionDuration||this.setHealedRatioPerDuration(g,m,S)}getHealedRatioMax(){return this.healedRatioMax}getHealedRatioAvg(){return this.healedRatioDuration?this.healedRatioTotal/this.healedRatioDuration:0}getHealedRatio(){return this.healedRatio}getTotalSamplesReceivedDiff(){return this.totalSamplesReceivedDiff}setHealedRatioPerDuration(g,m,S){const v=-1-this.networkDetectionDuration,C=Math.max((0,AC.last)(g)-(0,AC.nth)(g,v),0),_=Math.max((0,AC.last)(m)-(0,AC.nth)(m,v),0);this.totalSamplesReceivedDiff=Math.max((0,AC.last)(S)-(0,AC.nth)(S,v),0),0!==this.totalSamplesReceivedDiff&&(this.healedRatio=(C-_)/this.totalSamplesReceivedDiff,this.healedRatioDuration++,this.healedRatioTotal+=this.healedRatio,this.healedRatioMax=Math.max(this.healedRatioMax,this.healedRatio),this.networkRecvQualityDiagnostics&&(this.concealedSamplesAccumulator.add((0,AC.last)(g)),this.silentConcealedSamplesAccumulator.add((0,AC.last)(m)),this.totalSamplesReceivedAccumulator.add((0,AC.last)(S)),this.concealedSamplesDiffAccumulator.add(C),this.silentConcealedSamplesDiffAccumulator.add(_),this.totalSamplesReceivedDiffAccumulator.add(this.totalSamplesReceivedDiff),this.healedRatioAccumulator.add(this.healedRatio)))}getDiagnostics(g){return{quality:(0,AC.last)(g),qualityLevels:g,concealedSamples:this.concealedSamplesAccumulator.items,silentConcealedSamples:this.silentConcealedSamplesAccumulator.items,totalSamplesReceived:this.totalSamplesReceivedAccumulator.items,concealedSamplesDiff:this.concealedSamplesDiffAccumulator.items,silentConcealedSamplesDiff:this.silentConcealedSamplesDiffAccumulator.items,totalSamplesReceivedDiff:this.totalSamplesReceivedDiffAccumulator.items,healedRatio:this.healedRatioAccumulator.items.map((g=>round(g)))}}},PC=class{constructor(g=100){this.minPacketsReceivedToCalculatePacketLossRate=g,this.packetsReceivedForPrevWindow=0,this.packetsLostForPrevWindow=0,this.packetLostRateMax=0,this.totalPacketsLost=0,this.totalPacketsRecv=0,this.packetsLostDuration=0}capturePacketsLostAndPacketsReceived(g,m){this.packetsLostDuration+=Ke.TIME_INTERVAL.SEC_1,this.totalPacketsRecv=m,this.totalPacketsLost=g,this.calculateMaxLostRateInWindowSize(g,m)}getPacketsLostRateMax(){return this.packetLostRateMax}getNetworkAvgLostRate(){const g=this.totalPacketsLost+this.totalPacketsRecv;return g>0?this.totalPacketsLost/g:0}getAvgPacketsLost(){return this.totalPacketsLost?round(this.totalPacketsLost/this.packetsLostDuration,2):0}calculateMaxLostRateInWindowSize(g,m){const S=m-this.packetsReceivedForPrevWindow;if(S<this.minPacketsReceivedToCalculatePacketLossRate)return;this.packetsReceivedForPrevWindow=m;const v=g-this.packetsLostForPrevWindow;this.packetsLostForPrevWindow=g,this.packetLostRateMax=Math.max(round(v*this.minPacketsReceivedToCalculatePacketLossRate/(v+S),2),this.packetLostRateMax)}},MC=class{constructor(g){this.configProvider=g,this.audioAnalyzers=new Map,this.jitterBufferDuration=0,this.jitterBufferTotal=0,this.jitterTotal=0,this.jitterDuration=0,this.rttDuration=0,this.rttTotal=0,this.rttMax=0,this.jitterMax=0,this.webrtcAudioPacketLossRate=new PC(g.config.minPacketsReceivedToCalculatePacketLossRate)}captureJitterBuffer(g){this.jitterBufferDuration+=Ke.TIME_INTERVAL.SEC_1,this.jitterBufferTotal+=g}captureJitter(g){const m=1e3*g;this.jitterTotal+=m,this.jitterMax=Math.max(m,this.jitterMax),this.jitterDuration+=Ke.TIME_INTERVAL.SEC_1}getJitterAvg(){return this.jitterDuration?round(this.jitterTotal/this.jitterDuration):0}getAvgJitterBuffer(){return this.jitterBufferDuration?Math.round(this.jitterBufferTotal/this.jitterBufferDuration):0}capturePacketsLostAndPacketsReceived(g,m){this.webrtcAudioPacketLossRate.capturePacketsLostAndPacketsReceived(g,m)}getPacketsLostRateMax(){return this.webrtcAudioPacketLossRate.getPacketsLostRateMax()}getNetworkAvgLostRate(){return this.webrtcAudioPacketLossRate.getNetworkAvgLostRate()}getAvgPacketsLost(){return this.webrtcAudioPacketLossRate.getAvgPacketsLost()}captureRtt(g){if(null!==g){const m=parseInt(g);this.rttDuration+=Ke.TIME_INTERVAL.SEC_1,this.rttTotal+=m,this.rttMax=Math.max(this.rttMax,m)}}getAvgRtt(){return this.rttDuration?round(this.rttTotal/this.rttDuration):0}getMaxRtt(){return this.rttMax}getJitterMax(){return this.jitterMax}updateSendStream(g,m){if(!this.configProvider.config.useAudioAnalyzer)return;const S=this.audioAnalyzers.get(m);S&&(S.dispose(),this.audioAnalyzers.delete(m)),g?.rawStream?.getAudioTracks().length&&this.audioAnalyzers.set(m,new IS(g.rawStream))}getInputLevel(g){const m=this.audioAnalyzers.get(g);return m?.getInputLevel()}},wC=class{constructor(g,m){this.dropBadBandwidth=g,this.dropGoodBandwidth=m,this.dropDurationCounts={},Object.keys(Ke.HISTOGRAM_BATCH).forEach((g=>{this.dropDurationCounts[g]=0}))}recordSendBandwidth(g){this.currentDropDuration&&g<this.dropGoodBandwidth||g<this.dropBadBandwidth?this.initiateDrop():this.currentDropDuration&&g>this.dropGoodBandwidth&&this.recoverDrop()}getReport(){const g=shallowClone(this.dropDurationCounts);return this.currentDropDuration&&(g.ongoingDuration=this.currentDropDuration),g}initiateDrop(){this.currentDropDuration?this.currentDropDuration++:this.currentDropDuration=1}recoverDrop(){for(const g of Object.keys(Ke.HISTOGRAM_BATCH))if(this.currentDropDuration<=Ke.HISTOGRAM_BATCH[g]){this.dropDurationCounts[g]+=1,this.currentDropDuration=0;break}}},DC=P,OC=class{constructor(g,m,S,v){this.lowThreshold=g,this.highThreshold=m,this.isLowerBetter=S,this.curInLowerRange=S,this.stateTracker=new NC(v)}onSample(g,m){let S=this.curInLowerRange;this.curInLowerRange?g>this.highThreshold&&(S=!1):g<this.lowThreshold&&(S=!0);const v=this.stateTracker.onNewState(this.getQuality(S),m);return v!==this.getQuality(this.curInLowerRange)&&(this.curInLowerRange=S),v}getQuality(g){return g===this.isLowerBetter?"Good":"Bad"}},NC=class{constructor(g){this.sticknessTime=g}onNewState(g,m){return"Good"!==g&&"Bad"!==g?this.curState:0===this.sticknessTime?g:g===this.curState?(this.stickTimerStarted=0,this.curState):("Bad"===this.curState?0===this.stickTimerStarted?this.stickTimerStarted=m:m-this.stickTimerStarted>this.sticknessTime&&(this.curState=g,this.stickTimerStarted=0):(this.curState=g,this.stickTimerStarted=0),this.curState)}},kC=class{constructor(g,m,S,v){this.stateProcessor=g,this.windowSize=m,this.extendedWindowSize=S,this.addDiagnosticData=v,this.dataAccumulator=new Fm(S),this.avgAccumulator=new Fm(S)}getLatestSendQuality(g,m,S){if(this.dataAccumulator.add(g),this.dataAccumulator.items.length>=this.windowSize){const g=this.dataAccumulator.items.slice(-this.windowSize),S=(0,DC.mean)(g);return this.addDiagnosticData&&this.avgAccumulator.add(S),this.stateProcessor.onSample(S,m)}return S}getData(){return this.dataAccumulator.items.map((g=>round(g)))}getAggregatedData(){return this.avgAccumulator.items.map((g=>round(g)))}},LC=class{constructor(g,m,S){this.configProvider=g,this.newStatsApi=m,this.webrtcHealedRatio=S,this.sendAccumulator=new Fm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostAccumulator=new Fm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiffAccumulator=new Fm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostDiffAccumulator=new Fm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.totalAccumulator=new Fm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendQualityAccumulator=new Fm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiagnosticsEnabled=this.configProvider.config.networkSendQualityDiagnostics,this.recvDiagnosticsEnabled=this.configProvider.config.networkRecvQualityDiagnostics,this.recvQualityAccumulator=new Fm(this.configProvider.config.webrtcHealedRatioExtendedWindowSize);const v=Number(this.configProvider.config.webrtcStatNetworkDetectionHysteresis);this.networkDetectionBadLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionBadLevel)+v/2,this.networkDetectionBadLevelLow=this.networkDetectionBadLevelHigh-v,this.networkDetectionGoodLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionGoodLevel)+v/2,this.networkDetectionGoodLevelLow=this.networkDetectionGoodLevelHigh-v;const C=new OC(g.config.webrtcJitterLowThreshold,g.config.webrtcJitterHighThreshold,!0,g.config.webrtcJitterSticknessTime),_=new OC(g.config.webrtcLossRateLowThreshold,g.config.webrtcLossRateHighThreshold,!0,g.config.webrtcLossRateSticknessTime);this.jitterCalculator=new kC(C,g.config.webrtcJitterWindowSize,g.config.webrtcJitterExtendedWindowSize,this.sendDiagnosticsEnabled),this.lossRateCalculator=new kC(_,g.config.webrtcLossRateWindowSize,g.config.webrtcLossRateExtendedWindowSize,this.sendDiagnosticsEnabled)}calculateNetworkSendQualityLevel(g,m,S,v){if(!g||!m)return{quality:v};if(g.length<2||m.length<2||(0,DC.last)(g)<this.configProvider.config.webrtcMinPacketsSentForNetworkSendQuality)return{quality:v};const C=Date.now(),_=(0,DC.last)(S),E=this.jitterCalculator.getLatestSendQuality(_,C,v),[T,I]=g.slice(-2),[b,A]=m.slice(-2),R=this.getLossRate(I,T,A,b),P=this.lossRateCalculator.getLatestSendQuality(R,C,v),M="Good"===E&&"Good"===P?"Good":"Bad";return this.sendDiagnosticsEnabled&&(this.sendAccumulator.add(I),this.lostAccumulator.add(A),this.sendQualityAccumulator.add(M)),this.sendDiagnosticsEnabled?{quality:M,packetsSend:this.sendAccumulator.items,packetsLost:this.lostAccumulator.items,packetsSendDiff:this.sendDiffAccumulator.items,packetsLostDiff:this.lostDiffAccumulator.items,lossRates:this.lossRateCalculator.getData(),lossRatesAggregated:this.lossRateCalculator.getAggregatedData(),jitter:this.jitterCalculator.getData(),jitterAggregated:this.jitterCalculator.getAggregatedData(),qualityLevels:this.sendQualityAccumulator.items}:{quality:M}}calculateNetworkRecvQualityLevel(g){if(this.newStatsApi){const m=g;return this.calculateNetworkRecvQualityLevelNewStatsApi(m.concealedSamples,m.silentConcealedSamples,m.totalSamplesReceived,m.oldNetworkLevel)}{const m=g;return this.calculateNetworkRecvQualityLevelLegacyStatsApi(m.googDecodingCTN,m.googDecodingPLC,m.oldNetworkLevel)}}calculateNetworkRecvQualityLevelLegacyStatsApi(g,m,S){const v=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!g||!m||g.length<2*v)return{quality:S};let C=g.length-1-v;const _=g[g.length-1];for(;C>=0&&_-g[C]<100*v;)C--;if(C<0)return{quality:S};const E=_-g[C],T=m[m.length-1]-m[C];if(E<=0)return{quality:S};const I=T/E;return{quality:this.getRecvQuality(I,S)}}calculateNetworkRecvQualityLevelNewStatsApi(g,m,S,v){const C=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!g||g.length<=C||!m||m.length<=C||!S||S.length<=C)return{quality:v};if((0,DC.last)(S)<this.configProvider.config.webrtcMinAudioSamplesRecvForNetworkRecvQuality)return{quality:v};if(0===this.webrtcHealedRatio.getTotalSamplesReceivedDiff())return{quality:v};const _=this.webrtcHealedRatio.getHealedRatio(),E=this.getRecvQuality(_,v);if(this.recvDiagnosticsEnabled){this.recvQualityAccumulator.add(E);return this.webrtcHealedRatio.getDiagnostics(this.recvQualityAccumulator.items)}return{quality:E}}getRecvQuality(g,m){return g<this.networkDetectionGoodLevelLow?"Good":g<this.networkDetectionGoodLevelHigh?"Good"===m?"Good":"Poor":g<this.networkDetectionBadLevelLow?"Poor":g<this.networkDetectionBadLevelHigh?"Bad"===m?"Bad":"Poor":"Bad"}getLossRate(g,m,S,v){const C=g-m,_=S-v,E=C+_;return this.sendDiagnosticsEnabled&&(this.sendDiffAccumulator.add(C),this.lostDiffAccumulator.add(_),this.totalAccumulator.add(E)),E>0?_/E:0}},FC=class{constructor(g){this.configProvider=g,this.qualityLimitationReasonEvents=[]}setQualityLimitationReason(g){this.lastQualityLimitationReason!==g&&this.qualityLimitationReasonEvents.push({event:g,startTime:Date.now(),endTime:Date.now()}),this.qualityLimitationReasonEvents.length>this.configProvider.config.maxStoredQualityLimitationReasonEvents&&this.qualityLimitationReasonEvents.shift(),this.lastQualityLimitationReason=g}getQualityLimitationReasonEvents(){return this.qualityLimitationReasonEvents.reduce(((g,m,S)=>"none"===m.event?g:[...g,{...m,endTime:this.qualityLimitationReasonEvents[S+1]?.startTime??Date.now()}]),[])}},xC=class{constructor(){this.bitrateData={[Ke.MEDIA_DIRECTION.SEND]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0,allocateBW:0,allocateBWSamples:0},[Ke.MEDIA_DIRECTION.RECV]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0}}}captureSample(g,m){const S=Date.now()/1e3;if(0!==this.bitrateData[g].lastTimestamp&&m>this.bitrateData[g].lastBytes){const v=S-this.bitrateData[g].lastTimestamp,C=8*(m-this.bitrateData[g].lastBytes)/v;this.onBitrateSample(g,C)}this.bitrateData[g].lastTimestamp=S,this.bitrateData[g].lastBytes=m}getMax(g){return Math.round(this.bitrateData[g].maxSample)}getAvg(g){return 0===this.bitrateData[g].nSamples?0:Math.round(this.bitrateData[g].bitrateTotal/this.bitrateData[g].nSamples)}stopCapture(g){this.bitrateData[g].lastBytes=0,this.bitrateData[g].lastTimestamp=0}onBitrateSample(g,m){m>this.bitrateData[g].maxSample&&(this.bitrateData[g].maxSample=m),this.bitrateData[g].bitrateTotal+=m,this.bitrateData[g].nSamples++}captureAllocateBandwidth(g){if(g){const m=parseInt(g[g.length-1]);this.bitrateData[Ke.MEDIA_DIRECTION.SEND].allocateBW+=m,this.bitrateData[Ke.MEDIA_DIRECTION.SEND].allocateBWSamples+=1}}getAllocateBandwidthAvg(){const g=this.bitrateData[Ke.MEDIA_DIRECTION.SEND].allocateBW,m=this.bitrateData[Ke.MEDIA_DIRECTION.SEND].allocateBWSamples;if(g>0&&m>0)return Math.floor(g/m)}},UC=class{constructor(g,m){this.maxAppliedCapabilitiesCount=m,this.events=[],this.events.push({eventType:"req",timestamp:Date.now(),capabilities:g.capabilities,isSimulcast:g.isSimulcastEnabled})}setMaxCapabilitiesApplied(g){this.events.push({eventType:"app",timestamp:Date.now(),capabilities:g.capabilities,error:g.error?`${g.error}`:"none"}),this.maxAppliedCapabilitiesCount&&this.events.length>this.maxAppliedCapabilitiesCount+1&&this.events.splice(1,1)}getEvents(){return this.events}},VC=class{constructor(g,m){this.configProvider=g,this.logger=m,this.resolutionChangeRequestRecords={},this.currentResolutionsByRid={},this.resolutionChangeCounterByRid={},this.events=[],this.errors=[]}setMaxCapabilitesRequested(g){const m=new UC(g,this.configProvider.config.webrtcLastAppliedVideoCapabilitiesCount);this.events.push({causeId:g.causeId,seq:m}),this.recordResolutionChange(g),this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.length>this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.shift()}setMaxCapabilitesApplied(g){const m=this.events.find((m=>m.causeId===g.causeId));m?(m.seq.setMaxCapabilitiesApplied(g),g.error&&this.errors.push(m)):this.logger.safe.warn(`Requested capabilities with id ${g.causeId} not found`)}getEvents(){return this.events.map((g=>({causeId:g.causeId,events:g.seq.getEvents()})))}getErrors(){return this.errors.map((g=>({causeId:g.causeId,events:g.seq.getEvents()})))}getResolutionRecords(){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo)return{req:this.resolutionChangeRequestRecords,count:this.resolutionChangeCounterByRid}}recordResolutionChange(g){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo){const m=Object.keys(this.currentResolutionsByRid),getRid=g=>g.rid||"default";[...m,...g.capabilities.map((g=>getRid(g)))].forEach((m=>{const S=g.capabilities.find((g=>getRid(g)===m)),v=this.currentResolutionsByRid[m]||0,C=S?.maxFs||0;if(v===C)return;this.resolutionChangeRequestRecords[m]||(this.resolutionChangeRequestRecords[m]=[],this.resolutionChangeCounterByRid[m]=0);const _=this.resolutionChangeRequestRecords[m].find((g=>g.from===v&&g.to===C));_?_.counter++:this.resolutionChangeRequestRecords[m].push({from:v,to:C,counter:1}),this.currentResolutionsByRid[m]=C,this.resolutionChangeCounterByRid[m]++}))}}},BC=class{constructor(){this.delayCur=[],this.delayTotal=0,this.delayEventCount=0}analyzeDelay(g,m){if(m&&""!==m){this.delayCur.length===g&&this.delayCur.shift();const S=parseInt(m);this.delayCur.push(S),this.delayTotal+=S,this.delayEventCount+=Ke.TIME_INTERVAL.SEC_1}}getDelayCur(){if(this.delayCur.length>0){const g=this.delayCur.reduce(((g,m)=>g+m))/this.delayCur.length;return g<0?0:g}}getDelayAvg(){if(this.delayEventCount>0&&this.delayTotal>0){const g=this.delayTotal/this.delayEventCount;return g<0?0:g}}},HC=class{constructor(g,m){this.configProvider=g,this.startTime=m,this.recvTotalFreezeDuration=-1,this.recvFreezeDurations=[],this.recvFreezeIsOngoing=!1,this.recvCurrentFreezeDuration=0,this.recvFreezeCount=0,this.receiveFreezeDurationCounts={},this.longestRecvFreezeDuration=0,this.sendCameraFreezeIntervalsCount=0,this.previousInputFrame=0,this.recvCurrentFreezeStartTimestamp=0,this.receiveFreezeDurationTimestamps={},this.finalFreezeIsOngoing=!1,this.finalRecvCurrentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0,Object.keys(Ke.HISTOGRAM_BATCH).forEach((g=>{this.receiveFreezeDurationCounts[g]=0,this.receiveFreezeDurationTimestamps[g]=[]}))}gatherFreezeData({frameRateDecoded:g,frameRateRecv:m,bytesReceived:S,mediaType:v}){if(g){const C=parseInt(g[g.length-1],10),_=m?.length>0?parseInt(m[m.length-1],10):void 0;void 0!==S&&"ScreenShare"!==v&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&!this.configProvider.config.isRenderingBasedOnRawStatistics&&this.calculateBitrate(S,C),-1===this.recvTotalFreezeDuration&&(this.recvTotalFreezeDuration=0),C>0&&(this.mediaStarted=!0),0!==C&&0!==_||!this.mediaStarted?C>0&&(void 0===_||_>0)&&this.recvFreezeIsOngoing&&this.stopRecvDataGathering(!1):(this.recvFreezeIsOngoing||(this.recvCurrentFreezeStartTimestamp=Date.now()-this.startTime),this.recvFreezeIsOngoing=!0,this.recvCurrentFreezeDuration+=Ke.TIME_INTERVAL.SEC_1,this.recvTotalFreezeDuration+=Ke.TIME_INTERVAL.SEC_1)}}getIsRendering(g){return this.recvCurrentFreezeDuration<g&&this.currentLowBitrateDuration<g&&this.mediaStarted}detectCaptureFreeze(g){if(g){const m=parseInt(g[g.length-1],10);this.previousInputFrame>0&&0===m&&(this.sendCameraFreezeIntervalsCount+=1),this.previousInputFrame=m}}getSendCameraFreezeIntervals(){return this.sendCameraFreezeIntervalsCount>0?this.sendCameraFreezeIntervalsCount:void 0}stopRecvDataGathering(g=!0){this.finalFreezeIsOngoing=this.recvFreezeIsOngoing,this.recvFreezeIsOngoing=!1,g&&(this.mediaStarted=!1),this.recvCurrentFreezeDuration>0&&(this.populateLongestRecvFreezeDuration(),this.populateRecvFreezeDurationCounts(),this.recvFreezeDurations.push(this.recvCurrentFreezeDuration),this.recvFreezeCount+=1),this.finalRecvCurrentFreezeDuration=this.recvCurrentFreezeDuration,this.recvCurrentFreezeDuration=0}getRecvFreezeDurationCounts(){return this.recvFreezeCount>0?JSON.stringify(this.receiveFreezeDurationCounts):void 0}getRecvFreezeDurationTimestamps(g){if(0===this.recvFreezeCount)return;const m={};return Object.keys(this.receiveFreezeDurationTimestamps).forEach((S=>{const v=this.receiveFreezeDurationTimestamps[S].length;m[S]=v>g?this.receiveFreezeDurationTimestamps[S].slice(v-g):this.receiveFreezeDurationTimestamps[S]})),JSON.stringify(m)}getRecvFreezeIsOngoing(g){return this.finalRecvCurrentFreezeDuration>=g&&this.finalFreezeIsOngoing}getRecvTotalFreezeDuration(){return this.recvTotalFreezeDuration>=0?this.recvTotalFreezeDuration:void 0}getRecvAvgFreezeDuration(){if(this.recvTotalFreezeDuration>0&&this.recvFreezeCount>0)return this.recvTotalFreezeDuration/this.recvFreezeCount}getLongestRecvFreezeDuration(){return this.longestRecvFreezeDuration>0?this.longestRecvFreezeDuration:void 0}populateRecvFreezeDurationCounts(){for(const g of Object.keys(Ke.HISTOGRAM_BATCH))if(this.recvCurrentFreezeDuration<=Ke.HISTOGRAM_BATCH[g]){this.receiveFreezeDurationCounts[g]+=1,this.receiveFreezeDurationTimestamps[g].push(this.recvCurrentFreezeStartTimestamp);break}this.recvCurrentFreezeStartTimestamp=0}populateLongestRecvFreezeDuration(){this.recvCurrentFreezeDuration>this.longestRecvFreezeDuration&&(this.longestRecvFreezeDuration=this.recvCurrentFreezeDuration)}calculateBitrate(g,m){const S=125,v=(g-this.lastBytesRecv)/S;this.lastBytesRecv=g,v<this.configProvider.config.notRenderingLowBitrateThreshold&&m<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}},$C=class{constructor(){this.mediaData={[Ke.MEDIA_DIRECTION.SEND]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0},[Ke.MEDIA_DIRECTION.RECV]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0}},this.gatheringSendData=!1}captureMediaData(g,m,S){const v=this.mediaData[g];if(g===Ke.MEDIA_DIRECTION.SEND&&(this.gatheringSendData=!0),m){const g=parseInt(m[m.length-1],10);v.totalFrameCount+=g}if(S){-1===v.totalMediaDuration&&(v.totalMediaDuration=0);const g=parseInt(S[S.length-1],10);v.mediaStarted||g>0&&(v.mediaStarted=!0,v.mediaStartTimestamp=new Date)}v.mediaStarted&&(v.totalMediaDuration+=Ke.TIME_INTERVAL.SEC_1)}captureFrameRate(g){const m=this.mediaData[Ke.MEDIA_DIRECTION.SEND];if(g){const S=parseInt(g[g.length-1],10);m.cameraFrameRate+=S}}stopRecvDataGathering(){const g=this.mediaData[Ke.MEDIA_DIRECTION.RECV],m=(new Date).getTime();g.timeSinceLastDecode=g.totalMediaDuration>0?Math.round((m-g.mediaStartTimestamp.getTime())/1e3):0,g.mediaStarted=!1}isGatheringSendData(){return this.gatheringSendData}stopSendDataGathering(){const g=this.mediaData[Ke.MEDIA_DIRECTION.SEND],m=new Date;g.timeSinceLastDecode=g.totalMediaDuration>0?Math.round((m.getTime()-g.mediaStartTimestamp.getTime())/1e3):0,this.gatheringSendData=!1,g.mediaStarted=!1}getAvgFrameRate(g){const m=this.mediaData[g];if(m.totalMediaDuration>0&&m.totalFrameCount>0)return m.totalFrameCount/m.totalMediaDuration}getTotalDuration(g){const m=this.mediaData[g];return m.totalMediaDuration>=0?m.totalMediaDuration:void 0}getTimeSinceLastDecode(g){const m=this.mediaData[g];return m.timeSinceLastDecode>0?m.timeSinceLastDecode:void 0}getSendCameraFramerate(){const g=this.mediaData[Ke.MEDIA_DIRECTION.SEND];if(g.totalMediaDuration>0)return g.cameraFrameRate/g.totalMediaDuration}},GC=class{constructor(){this.qpData={[Ke.MEDIA_DIRECTION.SEND]:{frames:0,qpSum:0},[Ke.MEDIA_DIRECTION.RECV]:{frames:0,qpSum:0}}}captureQpData(g,m,S){const v=this.qpData[g];if(S&&S.length>0){const g=parseInt(S[S.length-1],10);g>0&&(v.frames=g)}if(m){const g=parseInt(m,10);g>0&&(v.qpSum=g)}}getQpAverage(g){const m=this.qpData[g];if(m.qpSum>0&&m.frames>0)return m.qpSum/m.frames}},jC=class{constructor(){this.resolutionChangedCount=0,this.resDurations={},this.preferredResolutionDurations={},this.preferredResolutions=[]}get resolutionSwitchCount(){return this.resolutionChangedCount}get resolutionDurationRatios(){return this.countResolutionDurationRatio(this.resDurations)}get preferredResolutionDurationRatios(){return this.countResolutionDurationRatio(this.preferredResolutionDurations)}get preferredResolution(){return this.preferredResolutions}captureSample(g){g&&g.width&&g.height&&(this.isResolutionChanged(this.lastResolution,g)&&this.resolutionChanged(g),this.updateResolutionDuration(this.getResolutionKey(g),this.resDurations)),this.lastPreferredResolution&&this.updatePreferredResolutionDurations()}capturePreferredResolution(g,m){const S=this.getResolutionKey(g);this.preferredResolution.includes(S)||(this.preferredResolutions.length>=m&&this.preferredResolutions.shift(),this.preferredResolutions.push(S)),this.isResolutionChanged(this.lastPreferredResolution,g)&&(this.preferredResolutionChanged(g),this.updatePreferredResolutionDurations())}getResolutionKey(g){return`${g.width}x${g.height}`}isResolutionChanged(g,m){return!g||g.width!==m.width||g.height!==m.height}countResolutionDurationRatio(g){const m={};let S=0;for(const m in g)S+=g[m];for(const v in g)m[v]=round(g[v]/S*100,2);return m}updatePreferredResolutionDurations(){this.updateResolutionDuration(this.getResolutionKey(this.lastPreferredResolution),this.preferredResolutionDurations)}updateResolutionDuration(g,m){m[g]||(m[g]=0),m[g]++}preferredResolutionChanged(g){this.lastPreferredResolution=g}resolutionChanged(g){this.lastResolution=g,this.resolutionChangedCount++}},qC=class{constructor(){this.streamsTimers={}}countRecvStreams(g){const m=`${g}`;this.streamsTimers.hasOwnProperty(m)||(this.streamsTimers[m]=0),this.streamsTimers[m]++}getStreamCounts(){const g={min:void 0,max:void 0,mode:void 0},m=Object.keys(this.streamsTimers).map(Number);return 0===m.length||1===m.length&&0===m[0]||(g.min=Math.min(...m.filter((g=>g>0))),g.max=Math.max(...m),g.mode=m.reduce(((g,m)=>this.streamsTimers[m]>this.streamsTimers[g]?m:g),m[0])),g}},WC=class{constructor(g){this.configProvider=g,this.subscriptionEvents=[],this.subscriptionCounters={attempted:0,subscribed:0,unsubscribed:0,failed:0}}addSubscriptionEvent(g){switch(this.subscriptionEvents.length>this.configProvider.config.webrtcSubscriptionEventLimit&&this.subscriptionEvents.shift(),this.subscriptionEvents.push(g),g.evt){case 1:this.subscriptionCounters.attempted++;break;case 2:this.subscriptionCounters.subscribed++;break;case 3:this.subscriptionCounters.unsubscribed++;break;case-1:this.subscriptionCounters.failed++}}getSubscriptionEvents(){return this.subscriptionEvents.length>0?{events:this.subscriptionEvents}:void 0}getSubscriptionCounters(){return this.subscriptionEvents.length>0?this.subscriptionCounters:void 0}},zC=class{constructor(g,m,S,v="Video"){this.startTime=g,this.configProvider=m,this.logger=S,this.mediaType=v,this.subscriptionCounter=0,this.videoFreezeTelemetry=new HC(this.configProvider,this.startTime),this.videoDelayTelemetry=new BC,this.videoSubscriptionEvents=new WC(this.configProvider),this.videoQPEvents=new GC,this.videoResolutionTelemetry=new jC,this.videoGeneralTelemetry=new $C,this.videoStreamsCounters=new qC,this.videoBitrate=new xC,this.videoMaxCapabilities=new VC(this.configProvider,this.logger),this.videoOvershoot=new oC(this.logger),this.videoQualityLimitations=new FC(this.configProvider),this.videoPacketLostRate=new PC(this.configProvider.config.minPacketsReceivedToCalculatePacketLossRate),this.videoStatsOnSubscribed=new SC(this.configProvider.config.maxVideoStatsAfterSubscription),this.videoResolutionSwitchTracker=new qv(this.configProvider.config.diagnostics?.collectionLimits?.numResolutionSwitches),this.timeToFirstFrame=-1,this.timeToFirstFrameSinceSubscriptionStart=-1,this.currentTrackId="",this.recvTotalFreezeDurationMs=0,this.isRenderingEvents=[]}get trackId(){return this.currentTrackId}set trackId(g){this.currentTrackId=g}get isRecvDataGatheringEnabled(){return this.subscriptionCounter>0}startStopRecvDataGathering(g){this.logger.safe.info("Receive data gathering is "+(g?"enabled":"disabled")),g?this.subscriptionCounter++:this.subscriptionCounter--,this.subscriptionCounter<0&&this.logger.safe.error(`Subscription counter should not be less than 0. Actual value is ${this.subscriptionCounter}`),0===this.subscriptionCounter&&this.stopRecvGathering()}stopDataGathering(){this.stopRecvGathering(),this.stopSendGathering()}stopRecvGathering(){this.videoFreezeTelemetry.stopRecvDataGathering(),this.videoGeneralTelemetry.stopRecvDataGathering(),this.videoBitrate.stopCapture(Ke.MEDIA_DIRECTION.RECV)}isSendGathering(){return this.videoGeneralTelemetry.isGatheringSendData()}stopSendGathering(){this.videoGeneralTelemetry.stopSendDataGathering(),this.videoBitrate.stopCapture(Ke.MEDIA_DIRECTION.SEND),this.videoOvershoot.flush()}gatherRecvFreezeData(g,m,S){this.videoFreezeTelemetry.gatherFreezeData({frameRateDecoded:g,frameRateRecv:m,bytesReceived:S,mediaType:this.mediaType})}detectCaptureFreeze(g){this.videoFreezeTelemetry.detectCaptureFreeze(g)}getRecvFreezeDurationCounts(){return this.videoFreezeTelemetry.getRecvFreezeDurationCounts()}getRecvFreezeDurationTimestamps(){return this.videoFreezeTelemetry.getRecvFreezeDurationTimestamps(this.configProvider.config.maxVideoFreezeTimestampsInBucket)}getRecvTotalFreezeDuration(){return this.videoFreezeTelemetry.getRecvTotalFreezeDuration()}setRecvTotalFreezeDurationMs(g){this.recvTotalFreezeDurationMs=void 0!==g?this.recvTotalFreezeDurationMs+=g:void 0}analyzeDelay(g,m){this.videoDelayTelemetry.analyzeDelay(g,m)}getDelayCur(){return this.videoDelayTelemetry.getDelayCur()}getDelayAvg(){return this.videoDelayTelemetry.getDelayAvg()}addSubscriptionEvent(g){this.videoSubscriptionEvents.addSubscriptionEvent(g)}getSubscriptionEvents(){return this.videoSubscriptionEvents.getSubscriptionEvents()}getSubscriptionCounters(){return this.videoSubscriptionEvents.getSubscriptionCounters()}captureQpData(g,m,S){this.videoQPEvents.captureQpData(g,m,S)}getQpAverage(g){return this.videoQPEvents.getQpAverage(g)}captureMediaData(g,m,S){this.videoGeneralTelemetry.captureMediaData(g,m,S)}getIsRendering(){const g=this.configProvider.config.notRenderingTimeInterval["Video"===this.mediaType?"video":"sharing"];return this.videoFreezeTelemetry.getIsRendering(g)}captureFrameRate(g){this.videoGeneralTelemetry.captureFrameRate(g)}getTotalDuration(g){return this.videoGeneralTelemetry.getTotalDuration(g)}captureResolutionSample(g){this.videoResolutionTelemetry.captureSample(g)}countRecvStreams(g){this.videoStreamsCounters.countRecvStreams(g)}captureBitrateSample(g,m){this.videoBitrate.captureSample(g,m)}captureAllocateBandwidth(g){this.videoBitrate.captureAllocateBandwidth(g)}capturePreferredResolution(g,m){this.videoResolutionTelemetry.capturePreferredResolution(g,m)}setMaxCapabilitesRequested(g,m=!1){this.videoMaxCapabilities.setMaxCapabilitesRequested(g),m||1===g.capabilities.length&&!g.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(g.capabilities)}setMaxCapabilitesApplied(g,m=!1){this.videoMaxCapabilities.setMaxCapabilitesApplied(g),m||1===g.capabilities.length&&!g.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(g.capabilities)}getMaxCapabilitiesEvents(){const g=this.videoMaxCapabilities.getEvents();return JSON.stringify(g)}getMaxCapabilitiesResolutionChanges(){const g=this.videoMaxCapabilities.getResolutionRecords();return g?JSON.stringify(g):""}getMaxCapabilitiesErrors(){const g=this.videoMaxCapabilities.getErrors();return g?JSON.stringify(g):""}setCurrentParameters(g,m,S){this.videoOvershoot.setCurrentParams(g,m.height/16*(m.width/16),S)}setMaxCapabilitiesOvershoot(g){this.videoOvershoot.setMaxCapabilities(g)}getOvershootEvents(){let g=this.videoOvershoot.getEvents();return g=g.slice(Math.max(0,g.length-(this.configProvider.config.maxReportedOvershootingEvents+1)),g.length),g.forEach((g=>g.timestamp=g.timestamp-this.startTime)),JSON.stringify(g)}getOvershootTotalDurations(){const g=this.videoOvershoot.getEvents();return g.forEach((g=>g.timestamp=g.timestamp-this.startTime)),JSON.stringify({fs:g.reduce(((g,m)=>"fs"===m.overshootType?g+m.duration:g),0),fps:g.reduce(((g,m)=>"fps"===m.overshootType?g+m.duration:g),0)})}setQualityLimitationReason(g){this.videoQualityLimitations.setQualityLimitationReason(g)}getQualityLimitationReasonEvents(){return this.videoQualityLimitations.getQualityLimitationReasonEvents()}captureTimeToFirstFrame(g,m){-1!==g&&(this.timeToFirstFrame=g,this.timeToFirstFrameSinceSubscriptionStart=m)}getTimeToFirstFrame(){return this.timeToFirstFrame}setIsRendering(g){arrayLimitedPush(this.isRenderingEvents,{isRendering:g,ts:Date.now()},this.configProvider.config.diagnostics.telemetryLimits.numIsRenderingEvents)}capturePacketsLostAndPacketsReceved(g,m){this.videoPacketLostRate.capturePacketsLostAndPacketsReceived(g,m)}setMsi(g){this.msi=g}setLocalMsi(g){this.localMsi=g}prepareCollectingStatsOnSubscribed(g){this.videoStatsOnSubscribed.prepareCollectingStatsOnSubscribed(g)}captureStatsOnSubscribed(g,m){this.videoStatsOnSubscribed.captureStatsOnSubscribed(g,m)}calculateResolutinSwitches(g,m){this.videoResolutionSwitchTracker.captureSample(g,m)}getReport(g,m,S=!1){const v={};if(v[m+"DurationSeconds"]=this.getTotalDuration(g),v[m+"QpAvg"]=this.getQpAverage(g),v[m+"frameRateAvg"]=this.videoGeneralTelemetry.getAvgFrameRate(g),v[m+"bitrateAvg"]=this.videoBitrate.getAvg(g),v[m+"bitrateMax"]=this.videoBitrate.getMax(g),g===Ke.MEDIA_DIRECTION.SEND)v[m+"DelayCur"]=this.getDelayCur(),v[m+"DelayAvg"]=this.getDelayAvg(),v[m+"TimeSinceLastEncodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(g),v[m+"AllocateBWAvg"]=this.videoBitrate.getAllocateBandwidthAvg(),v[m+"CaptureFramerateAvg"]=this.videoGeneralTelemetry.getSendCameraFramerate(),v[m+"FreezeIntervals"]=this.videoFreezeTelemetry.getSendCameraFreezeIntervals(),v[m+"MaxCapabilities"]=S?"":this.getMaxCapabilitiesEvents(),v[m+"MaxCapabilitiesErrors"]=S?"":this.getMaxCapabilitiesErrors(),v[m+"OvershootEvents"]=this.getOvershootEvents(),v[m+"OvershootDurations"]=this.getOvershootTotalDurations(),v[m+"qualityLimitationReasonEvents"]=JSON.stringify(this.getQualityLimitationReasonEvents()),v[m+"MaxCapabilitiesResolutions"]=this.getMaxCapabilitiesResolutionChanges(),v[m+"ResolutionsSwitches"]=this.videoResolutionSwitchTracker.switches?JSON.stringify(this.videoResolutionSwitchTracker.switches):"";else if(g===Ke.MEDIA_DIRECTION.RECV){v[m+"TimeSinceLastDecodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(g),v[m+"FreezeHistogram"]=this.getRecvFreezeDurationCounts(),v[m+"FreezeTimestamps"]=this.getRecvFreezeDurationTimestamps(),v[m+"LongestFreezeDuration"]=this.videoFreezeTelemetry.getLongestRecvFreezeDuration(),v[m+"RecvAvgFreezeDuration"]=this.videoFreezeTelemetry.getRecvAvgFreezeDuration(),v[m+"TotalFreezeDuration"]=this.getRecvTotalFreezeDuration(),v[m+"TotalFreezeDurationMs"]=this.recvTotalFreezeDurationMs,v[m+"OngoingFreeze"]=this.videoFreezeTelemetry.getRecvFreezeIsOngoing(this.configProvider.config.webrtcEndOfCallFreezeThreshold),v[m+"NumResolutionSwitches"]=this.videoResolutionTelemetry.resolutionSwitchCount,v[m+"PreferredResolution"]=this.videoResolutionTelemetry.preferredResolution,v[m+"PreferredResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.preferredResolutionDurationRatios),v[m+"packetsLostRateMax"]=this.videoPacketLostRate.getPacketsLostRateMax(),v[m+"ResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.resolutionDurationRatios);const S=this.videoStreamsCounters.getStreamCounts();v[m+"StreamsMin"]=S.min,v[m+"StreamsMax"]=S.max,v[m+"StreamsMode"]=S.mode,v[m+"TimeToFirstFrame"]=this.timeToFirstFrame,v[m+"TimeToFirstFrameSinceSubscriptionStart"]=this.timeToFirstFrameSinceSubscriptionStart,v[m+"LocalMsi"]=this.localMsi,v[m+"Msi"]=this.msi,v[m+"isRenderingEvents"]=JSON.stringify(this.isRenderingEvents),v[m+"statsOnSubscribed"]=JSON.stringify(this.videoStatsOnSubscribed.getStatsOnSubscribed())}return v}},KC=Symbol("mslbase"),JC=Symbol("mslsamples"),YC=class{constructor(g,m){this.logger=g,this.configProvider=m,this.currentLayouts={},this.collectedModalitySessions=[],this.startTimestamp=Date.now()}get collectedSessions(){return this.collectedModalitySessions}get highestFidelitySSRC(){if(!this.currentModalitySession)return;let g;for(const m in this.currentLayouts)g=this.getHigherFidelitySSRC(m,g);return parseInt(g)}processStats(g){const m=Object.values(g.ssrc??{}).filter((g=>g.rid&&g.ssrc&&g.googFrameHeightInput&&this.lastMaxCapabilitiesEvent?.capabilities.some((m=>m.rid===g.rid)))),S=new Map(m.map((g=>[`${g.ssrc}`,g.rid])));for(const g in this.currentLayouts)S.has(g)||this.collectLayout(g);!this.currentModalitySession&&S.size>0&&(this.currentModalitySession={timestamp:Date.now()-this.startTimestamp,duration:0,numLayouts:0,layouts:[]},this.logger.safe.info("Modality session started")),m.forEach((g=>{this.currentLayouts[`${g.ssrc}`]||this.addLayout(g)})),0===S.size&&this.currentModalitySession&&this.collectSession(),m.forEach((g=>this.processLayoutData(g)))}setMaxCapabilities(g,m){if(this.lastMaxCapabilitiesEvent=g,Object.keys(this.currentLayouts).length)for(const S of g.capabilities){const v=Object.values(this.currentLayouts).find((g=>g.rid===S.rid));v&&(m?(arrayLimitedPush(v.fmtp,{...S,timestamp:Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-v.timestamp,causeId:g.causeId},this.configProvider.config.simulcastTelemetryNumFMTP),v.gatherer.setMaxCapabilitesApplied(g)):v.gatherer.setMaxCapabilitesRequested(g),v.gatherer.setMaxCapabilitiesOvershoot([S]))}}finish(){this.logger.safe.info("Finishing statistics gathering");for(const g in this.currentLayouts)this.collectLayout(g);this.currentModalitySession&&this.collectSession()}addLayout(g){const m=`${g.ssrc}`,S=g.rid,v=this.lastMaxCapabilitiesEvent?.capabilities.find((g=>g.rid===S));this.logger.safe.info(`Adding layout for ssrc ${m} rid ${S}`);const C=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,_=new zC(C,this.configProvider,this.logger.createChild(`Telemetry#${m}`));this.currentLayouts[m]={ssrc:g.ssrc,rid:S,fmtp:[{...v,timestamp:C,causeId:this.lastMaxCapabilitiesEvent?.causeId}],timestamp:C,duration:0,gatherer:_,[KC]:{firCount:g.googFirsReceived,nackCount:g.googNacksReceived,pliCount:g.googPlisReceived,framesEncoded:g.framesEncoded,bytesSent:g.bytesSent,packetsSent:g.packetsSent,packetsLost:g.packetsLost,qpSum:g.qpSum},[JC]:{firCount:[],nackCount:[],pliCount:[],framesEncoded:[],bytesSent:[],packetsSent:[],packetsLost:[],qpSum:[],frameHeightInput:[],frameHeightSent:[],frameRateInput:[],frameRateSent:[]}},_.setMaxCapabilitiesOvershoot([v]),this.currentModalitySession.numLayouts++}processLayoutData(g){const m=`${g.ssrc}`,S=this.currentLayouts[m];this.processMediaStats(S,g),S.gatherer.captureMediaData(Ke.MEDIA_DIRECTION.SEND,[String(g.googFrameRateSent)],[String(g.framesEncoded)]),S.gatherer.captureFrameRate([String(g.googFrameRateInput)]),S.gatherer.captureQpData(Ke.MEDIA_DIRECTION.SEND,String(g.qpSum),[String(g.framesEncoded)]),S.gatherer.captureBitrateSample(Ke.MEDIA_DIRECTION.SEND,g.bytesSent),S.gatherer.detectCaptureFreeze([String(g.googFrameRateInput)]),S.gatherer.setCurrentParameters(g.ssrc,{width:g.googFrameWidthSent,height:g.googFrameHeightSent},g.googFrameRateSent)}processMediaStats(g,m){const S=g[KC],v=m.googFirsReceived-S.firCount,C=m.googNacksReceived-S.nackCount,_=m.googPlisReceived-S.pliCount,E=m.framesEncoded-S.framesEncoded,T=m.bytesSent-S.bytesSent,I=m.packetsSent-S.packetsSent,b=m.packetsLost-S.packetsLost,A=m.qpSum-S.qpSum,R=g[JC],P=this.configProvider.config.webrtcStatStoredRecordsNumber;arrayLimitedPush(R.firCount,v,P),arrayLimitedPush(R.nackCount,C,P),arrayLimitedPush(R.pliCount,_,P),arrayLimitedPush(R.framesEncoded,E,P),arrayLimitedPush(R.bytesSent,T,P),arrayLimitedPush(R.packetsSent,I,P),arrayLimitedPush(R.packetsLost,b,P),arrayLimitedPush(R.qpSum,A,P),arrayLimitedPush(R.frameHeightInput,m.googFrameHeightInput,P),arrayLimitedPush(R.frameHeightSent,m.googFrameHeightSent,P),arrayLimitedPush(R.frameRateInput,m.googFrameRateInput,P),arrayLimitedPush(R.frameRateSent,m.googFrameRateSent,P)}collectLayout(g){this.logger.safe.info(`Collecting layout for ssrc ${g}`),this.currentLayouts[g].duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-this.currentLayouts[g].timestamp,this.currentLayouts[g].gatherer.isSendGathering()&&this.currentLayouts[g].gatherer.stopSendGathering();const m=this.currentLayouts[g].gatherer.getReport(Ke.MEDIA_DIRECTION.SEND,"",!1);for(const S in m)this.currentLayouts[g][S]=m[S];for(const m in this.currentLayouts[g][JC])this.currentLayouts[g][m]=sampleseries(this.currentLayouts[g][JC][m],(g=>g));delete this.currentLayouts[g].gatherer,arrayLimitedPush(this.currentModalitySession.layouts,this.currentLayouts[g],this.configProvider.config.simulcastTelemetryLayoutsPerSession),delete this.currentLayouts[g]}collectSession(){this.logger.safe.info("Collecting session");for(const g in this.currentLayouts)this.collectLayout(g);this.currentModalitySession.duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,arrayLimitedPush(this.collectedModalitySessions,this.currentModalitySession,this.configProvider.config.simulcastTelemetryNumModalitySessions),this.currentModalitySession=void 0,this.lastMaxCapabilitiesEvent=void 0}getHigherFidelitySSRC(g,m){if(!g||!m)return g||m;const[S]=this.currentLayouts[g].fmtp.slice(-1),[v]=this.currentLayouts[m].fmtp.slice(-1);return(S?.maxMbps??0)>0&&(v?.maxMbps??0)>0?S.maxMbps>v.maxMbps?g:m:g||m}},QC=["googFrameHeightReceived","googFrameWidthReceived","googFrameHeightSent","googFrameWidthSent","googFrameRateInput","googFrameRateSent","googNacksSent","googNacksReceived","googPlisSent","googPlisReceived","googFirsSent","googFirsReceived","framesDecoded","googFrameRateDecoded","googFrameRateReceived","framesEncoded","packetsLost","packetsSent","packetsReceived","bytesReceived","bytesSent","googEncodeUsagePercent","audioInputLevel","audioOutputLevel","googDecodingCTN","googDecodingPLC","keyFramesEncoded","keyFramesDecoded","googRtt","concealedSamples","silentConcealedSamples","totalSamplesReceived","healedRatio","jitter","googJitterBufferMs","qpSum","fecPacketsReceived","fecPacketsDiscarded","fecPacketsSent","packetsDiscarded","pushCount","pushErrCount","pullCount","pullErrCount"],XC=["bytesSent","bytesReceived","googRtt","packetsSent","requestsSent","consentRequestsSent","responsesSent","requestsReceived","responsesReceived"],ZC=["googAvailableReceiveBandwidth","googAvailableSendBandwidth","googTransmitBitrate"];function catchStatsErrors(g,m,S){const v=S.value;S.value=function(...g){try{return v.apply(this,g)}catch(g){this.processStatsError(m,g)}}}var e_=10,t_=class{constructor(g,m,S,v,C,_){this.logger=g,this.sessionInfo=m,this.configProvider=S,this.mediaManager=v,this.multiparty=C,this.newStatsApi=_,this.statsErrors=[],this.subscribedTrackIds=[],this.iceCandidateErrors=[],this.terminated=!1,this.hwSilent=!1,this.isSpeaking=!1,this.networkSendLevel={quality:"Good"},this.networkRecvLevel={quality:"Good"},this.audioTelemetry=new MC(this.configProvider),this.cameraOpenResolution={width:0,height:0},this.streamSenderStarted={},this.totalVideoControlMessages=0,this.outOfOrderVideoControlMessages=0,this.subscribedTrackSsrc=[],this.multiViewVideoTelemetry={},this.h264AvailableProfiles=[],this.timeToFirstFrame={},this.timeToFirstFrameSinceSubscriptionStart={},this.missedInitialPreferredResolution={},this.MSIDs=new Set,this.MSIDsPairs={},this.timerTrackerManager=new RS(this.configProvider.config.enableTimerTracker),this.extensions={WebRTCStats:{},AudioTransportRecvBitrate:0,AudioTransportSendBitrate:0,AudioPayloadSendBitrate:0,AudioPayloadRecvBitrate:0,VideoPayloadSendBitrate:0,VideoPayloadRecvBitrate:0,TimerAudioTransportRecvBitrate:0,TimerAudioTransportSendBitrate:0,TimerAudioPayloadRecvBitrate:0,TimerAudioPayloadSendBitrate:0,TimerVideoPayloadRecvBitrate:0,TimerVideoPayloadSendBitrate:0,StartTime:Date.now(),EndTime:Date.now(),Audio_recv_jitterBufferAvgSize:0,Audio_recv_jitterMax:0,Audio_recv_jitterAvg:0,Audio_send_rttAvg:0,Audio_send_rttMax:0,MaxSessionBandwidth:0,Video_recv_MSIDs:[],CallSetupTimeTracker:"",Audio_send_presentationUserAPIDuration:"",Audio_send_presentationDuration:""},this.report={type:"WebRtcMediaStats",data:{Extensions:this.extensions}},this.lastSSRCs=new Map,this.videoTelemetry=new zC(this.extensions.StartTime,this.configProvider,this.logger.createChild("Video"),"Video"),this.sharingTelemetry=new zC(this.extensions.StartTime,this.configProvider,this.logger.createChild("Sharing"),"ScreenShare"),this.dataTelemetry=new Jr,this.bandwidthTelemetry=new wC(this.configProvider.config.webrtcBWJumpLowerLimit,this.configProvider.config.webrtcBWJumpUpperLimit),this.stabilizationTelemetry=new vC(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,hasSendDirectionality),this.storedRecordsNumber=Number(this.configProvider.config.webrtcStatStoredRecordsNumber),this.hwSilentDetectionDuration=Number(this.configProvider.config.webrtcStatHwSilentDetectionDuration),this.hwSilentDetectionLevel=Number(this.configProvider.config.webrtcStatHwSilentDetectionLevel),this.audioHealedRatioTelemetry=new RC(this.configProvider),this.networkQualityTelemetry=new LC(this.configProvider,this.newStatsApi,this.audioHealedRatioTelemetry),this.speakingWhileMutedBadDuration=Number(this.configProvider.config.webrtcSpeakingWhileMutedBadDuration),this.speakingWhileMutedDetectionLevel=Number(this.configProvider.config.webrtcSpeakingWhileMutedDetectionLevel),this.videoDelayTimePeriod=this.configProvider.config.webrtcVideoDelayThreshold,this.maxStoredPreferredResolutions=this.configProvider.config.maxStoredPreferredResolutionCount,this.simulcastVideo=new YC(this.logger.createChild("simulcastVideo"),this.configProvider),this.simulcastSharing=new YC(this.logger.createChild("simulcastSharing"),this.configProvider)}get currentVideoRecvTrackId(){return this.extensions.WebRTCStats.ssrc_video_recv?.googTrackId}get currentSharingRecvTrackId(){return this.extensions.WebRTCStats.ssrc_sharing_recv?.googTrackId}get isMultiViewVideoTelemetry(){return Object.getOwnPropertyNames(this.multiViewVideoTelemetry).length>0}onDeviceEvent(g){if("stream_acquired"===g.eventType){const m=g.payload;"Video"===m.mediaType&&(this.cameraOpenResolution=m.resolution)}}onMaxCapabilitiesRequested(g){(g.modality===Ke.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesRequested(g);(g.modality===Ke.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(g,!1)}onMaxCapabilitiesApplied(g){(g.modality===Ke.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesApplied(g);(g.modality===Ke.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(g,!0)}setSubscribedTrackIds(g){this.subscribedTrackIds=g||[]}setSubscribedTrackSsrc(g){this.subscribedTrackSsrc=g||[]}addSubscriptionEvent(g,m,S,v,C,_,E){const T={evt:g,ts:Date.now()-this.extensions.StartTime,msi:S,localMsi:v,duration:_};C&&(T.error=stringifyObject(C));const I=this.getHandlerForModality(m);if(I.addSubscriptionEvent(T),E&&this.setMSIDsPair(S,v,E),1===g||3===g){const m=1===g;I.startStopRecvDataGathering(m)}2===g&&I.prepareCollectingStatsOnSubscribed(S)}setMSIDsPair(g,m,S){const v=`ssrc_${S.replace(/\D/g,"")}_recv`;this.MSIDsPairs[v]={msi:g,localMsi:m}}getHandlerForModality(g){switch(g){case Ke.MODALITY.video:return this.videoTelemetry;case Ke.MODALITY.sharing:return this.sharingTelemetry;default:throw new Error(`Handler not found for modality: ${g}`)}}setTerminated(){this.extensions.EndTime=(new Date).getTime(),this.terminated=!0}startWaitingForStreamStart(g){this.streamStartDetection||this.sessionInfo.setOfferedModalities(g),this.streamStartDetection=!0}recordDataChannelProtocolEvent(g){this.dataTelemetry.recordDataChannelProtocolEvent(g)}setSessionDataChannelState(g){this.dataTelemetry.setSessionDataChannelState(g)}recordDataChannelError(g){this.dataTelemetry.recordDataChannelError(g)}processStatsDict(g){if(this.processSimulcastStats(g),this.constructWebRtcReportForSingleStream(this.extensions.WebRTCStats,g),this.streamStartDetection&&(this.setStartTime(this.sessionInfo.offeredModalities)||this.terminated)&&(this.streamStartDetection=!1),Object.keys(this.missedInitialPreferredResolution).length>0&&(this.currentVideoRecvTrackId||this.currentSharingRecvTrackId)&&this.setMissedInitialPreferredResolution(),this.constructWebRTCDataReport(this.extensions.WebRTCStats,g),this.calculateHwSilentState(),this.calculateSpeakingState(),this.setHealedRatioSamples(),this.calculateNetworkRecvQualityLevel(),this.calculateNetworkSendQualityLevel(),this.sessionInfo.activeModalities&&(this.processBandwidthStats(),this.processAudioStats(),this.processVideoStatsRecv(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_recv,!0),this.processVideoStatsSend(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_send),this.processSharingStats(),this.processStreamsCounters()),this.configProvider.config.enableMultiViewStats){const m=this.extensions.WebRTCStats[Ke.MULTIPLE_RECV_STREAMS]?this.extensions.WebRTCStats[Ke.MULTIPLE_RECV_STREAMS]:{};this.constructWebRtcReportForMultipleStreams(m,g);for(const g of Object.keys(m)){const S=m[g];this.processVideoStatsRecv(this.multiViewVideoTelemetry[g],S)}this.extensions.WebRTCStats[Ke.MULTIPLE_RECV_STREAMS]=m}this.extensions.WebRTCStats.statsErrors=JSON.stringify(this.statsErrors)}setTimeToFirstFrame(g,m,S){S in this.timeToFirstFrame||(this.timeToFirstFrame[S]=g,this.timeToFirstFrameSinceSubscriptionStart[S]=m)}getCurrentTimeToFirstFrame(g){return this.timeToFirstFrame[g]?this.timeToFirstFrame[g]:-1}getCurrentTimeToFirstFrameSinceSubscriptionStart(g){return this.timeToFirstFrameSinceSubscriptionStart[g]?this.timeToFirstFrameSinceSubscriptionStart[g]:-1}getVideoTelemetryBySsrc(g){let m;return this.extensions.WebRTCStats.ssrc_video_recv&&this.extensions.WebRTCStats.ssrc_video_recv.id===g?m=this.videoTelemetry:this.extensions.WebRTCStats.ssrc_sharing_recv&&this.extensions.WebRTCStats.ssrc_sharing_recv.id===g?m=this.sharingTelemetry:this.isMultiViewVideoTelemetry&&(m=this.multiViewVideoTelemetry[g]),m}getIsRendering(g){const m=this.getVideoTelemetryBySsrc(g);return m?m.getIsRendering():void 0}setFreezeDuration(g,m){for(const S of Object.keys(this.multiViewVideoTelemetry))this.multiViewVideoTelemetry[S].trackId===m&&this.isSubscribed(m)&&this.multiViewVideoTelemetry[S].setRecvTotalFreezeDurationMs(g);this.currentSharingRecvTrackId===m&&this.isSubscribed(m)&&this.sharingTelemetry.setRecvTotalFreezeDurationMs(g),this.currentVideoRecvTrackId===m&&this.isSubscribed(m)&&this.videoTelemetry.setRecvTotalFreezeDurationMs(g)}addVideoControlMessage(g){this.totalVideoControlMessages++,g&&this.outOfOrderVideoControlMessages++}setStreamSenderStarted(g,m){this.streamSenderStarted[g]=m}addReportedReceiveBandwidth(g){this.limitCaptureAmount(this.extensions,"ReportedReceiveBandwidth",g)}setHealedRatioSamples(){this.audioHealedRatioTelemetry.captureHealedRatioSamples(this.extensions?.WebRTCStats?.ssrc_audio_recv?.concealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.silentConcealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.totalSamplesReceived)}processSimulcastStats(g){this.simulcastVideo.processStats(g),this.simulcastSharing.processStats(g)}processBandwidthStats(){const g=this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth;if(g){const m=this.streamSenderStarted.Video||this.streamSenderStarted.ScreenShare;this.bandwidthTelemetry.recordSendBandwidth(g[g.length-1]),this.stabilizationTelemetry.processBandwidth(parseInt(g[g.length-1]),this.sessionInfo.activeModalities,m)}}processAudioStats(){if(this.extensions.WebRTCStats.ssrc_audio_send&&this.limitCaptureAmount(this.extensions,"Audio_send_RawInputVolume",this.audioTelemetry.getInputLevel("Audio")),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.googJitterBufferMs&&this.audioTelemetry.captureJitterBuffer((0,bC.last)(this.extensions.WebRTCStats.ssrc_audio_recv.googJitterBufferMs)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_audio_recv?.packetsReceived&&this.audioTelemetry.capturePacketsLostAndPacketsReceived((0,bC.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsLost),(0,bC.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsReceived)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.jitter&&this.audioTelemetry.captureJitter((0,bC.last)(this.extensions.WebRTCStats.ssrc_audio_recv.jitter)),this.extensions.WebRTCStats.ssrc_audio_send?.googRtt){const g=this.extensions.WebRTCStats.ssrc_audio_send.googRtt;this.audioTelemetry.captureRtt(g[g.length-1])}}stopGatheringIfNeeded(g,m,S,v){const C=`${m}${S}`;v!==this.lastSSRCs.get(C)&&(this.lastSSRCs.set(C,v),m===Ke.MEDIA_DIRECTION.SEND?g.stopSendGathering():g.stopRecvGathering())}processVideoStatsSend(g,m){m&&hasSendDirectionality(this.sessionInfo.activeModalities.video)?(this.stopGatheringIfNeeded(g,Ke.MEDIA_DIRECTION.SEND,"Video",m.ssrc),g.captureMediaData(Ke.MEDIA_DIRECTION.SEND,m.googFrameRateSent,m.framesEncoded),g.captureFrameRate(m.googFrameRateInput),g.analyzeDelay(this.videoDelayTimePeriod,m.googAvgEncodeMs),g.captureQpData(Ke.MEDIA_DIRECTION.SEND,m.qpSum,m.framesEncoded),g.captureBitrateSample(Ke.MEDIA_DIRECTION.SEND,this.getLastSampleInt(m.bytesSent)),g.detectCaptureFreeze(m.googFrameRateInput),g.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),g.setCurrentParameters(parseInt(m.ssrc),{width:this.getLastSampleInt(m.googFrameWidthSent),height:this.getLastSampleInt(m.googFrameHeightSent)},this.getLastSampleInt(m.googFrameRateSent)),g.setQualityLimitationReason(m.qualityLimitationReason),this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo&&g.calculateResolutinSwitches(this.getLastSampleInt(m.googFrameWidthSent),this.getLastSampleInt(m.googFrameHeightSent))):g.isSendGathering()&&(g.stopSendGathering(),this.lastSSRCs.delete(`${Ke.MEDIA_DIRECTION.SEND}Video`))}processVideoStatsRecv(g,m,S=!1){m&&hasReceiveDirectionality(this.sessionInfo.activeModalities.video)&&this.videoTelemetry.isRecvDataGatheringEnabled?(S&&this.stopGatheringIfNeeded(g,Ke.MEDIA_DIRECTION.RECV,"Video",m.ssrc),g.trackId=m.googTrackId,g.gatherRecvFreezeData(m.googFrameRateDecoded,m.googFrameRateReceived,this.getLastSampleInt(m.bytesReceived)),g.captureMediaData(Ke.MEDIA_DIRECTION.RECV,m.googFrameRateReceived,m.googFrameRateDecoded),g.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(m.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(m.googTrackId)),g.captureQpData(Ke.MEDIA_DIRECTION.RECV,m.qpSum,m.framesDecoded),g.captureBitrateSample(Ke.MEDIA_DIRECTION.RECV,this.getLastSampleInt(m.bytesReceived)),g.captureResolutionSample({width:this.getLastSampleInt(m.googFrameWidthReceived),height:this.getLastSampleInt(m.googFrameHeightReceived)}),this.extensions.WebRTCStats.ssrc_video_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_video_recv?.packetsReceived&&this.videoTelemetry.capturePacketsLostAndPacketsReceved((0,bC.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsLost),(0,bC.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsReceived)),g.captureStatsOnSubscribed(this.getLastSampleInt(m.framesDecoded),this.getLastSampleInt(m.bytesReceived))):S&&this.lastSSRCs.delete(`${Ke.MEDIA_DIRECTION.RECV}Video`)}processSharingStats(){const g=this.extensions.WebRTCStats.ssrc_sharing_send,m=this.extensions.WebRTCStats.ssrc_sharing_recv;g&&hasSendDirectionality(this.sessionInfo.activeModalities.sharing)?(this.stopGatheringIfNeeded(this.sharingTelemetry,Ke.MEDIA_DIRECTION.SEND,"Sharing",g.ssrc),this.sharingTelemetry.captureMediaData(Ke.MEDIA_DIRECTION.SEND,g.googFrameRateSent,g.framesEncoded),this.sharingTelemetry.captureFrameRate(g.googFrameRateInput),this.sharingTelemetry.analyzeDelay(this.videoDelayTimePeriod,g.googAvgEncodeMs),this.sharingTelemetry.captureQpData(Ke.MEDIA_DIRECTION.SEND,g.qpSum,g.framesEncoded),this.sharingTelemetry.captureBitrateSample(Ke.MEDIA_DIRECTION.SEND,this.getLastSampleInt(g.bytesSent)),this.sharingTelemetry.detectCaptureFreeze(g.googFrameRateInput),this.sharingTelemetry.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),this.sharingTelemetry.setCurrentParameters(parseInt(g.ssrc),{width:this.getLastSampleInt(g.googFrameWidthSent),height:this.getLastSampleInt(g.googFrameHeightSent)},this.getLastSampleInt(g.googFrameRateSent)),this.limitCaptureAmount(this.extensions,"Sharing_send_RawInputVolume",this.audioTelemetry.getInputLevel("ScreenShare"))):this.sharingTelemetry.isSendGathering()&&(this.sharingTelemetry.stopSendGathering(),this.lastSSRCs.delete(`${Ke.MEDIA_DIRECTION.SEND}Sharing`)),m&&hasReceiveDirectionality(this.sessionInfo.activeModalities.sharing)&&this.sharingTelemetry.isRecvDataGatheringEnabled?(this.stopGatheringIfNeeded(this.sharingTelemetry,Ke.MEDIA_DIRECTION.RECV,"Sharing",m.ssrc),this.sharingTelemetry.trackId=m.googTrackId,this.sharingTelemetry.gatherRecvFreezeData(m.googFrameRateDecoded,m.googFrameRateReceived),this.sharingTelemetry.captureMediaData(Ke.MEDIA_DIRECTION.RECV,m.googFrameRateReceived,m.googFrameRateDecoded),this.sharingTelemetry.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(m.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(m.googTrackId)),this.sharingTelemetry.captureQpData(Ke.MEDIA_DIRECTION.RECV,m.qpSum,m.framesDecoded),this.sharingTelemetry.captureBitrateSample(Ke.MEDIA_DIRECTION.RECV,this.getLastSampleInt(m.bytesReceived)),this.sharingTelemetry.captureResolutionSample({width:this.getLastSampleInt(m.googFrameWidthReceived),height:this.getLastSampleInt(m.googFrameHeightReceived)}),this.sharingTelemetry.captureStatsOnSubscribed(this.getLastSampleInt(m.framesDecoded),this.getLastSampleInt(m.bytesReceived))):this.lastSSRCs.delete(`${Ke.MEDIA_DIRECTION.RECV}Sharing`)}processStreamsCounters(){const g=this.extensions.WebRTCStats.recvCounters;g&&(this.videoTelemetry.countRecvStreams(g[Ke.MODALITY.video]),this.sharingTelemetry.countRecvStreams(g[Ke.MODALITY.sharing]))}setMissedInitialPreferredResolution(){forOwn(this.missedInitialPreferredResolution,((g,m)=>{this.setPreferredResolution(m,g)})),this.missedInitialPreferredResolution={}}setPreferredResolution(g,m,S){if((S===Ke.MEDIA_TYPE.video&&!this.currentVideoRecvTrackId||S===Ke.MEDIA_TYPE.sharing&&!this.currentSharingRecvTrackId)&&(this.missedInitialPreferredResolution[g]=m),this.currentVideoRecvTrackId===g&&this.videoTelemetry.capturePreferredResolution(m,this.maxStoredPreferredResolutions),this.currentSharingRecvTrackId===g&&this.sharingTelemetry.capturePreferredResolution(m,this.maxStoredPreferredResolutions),this.isMultiViewVideoTelemetry){const S=this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(g)];S&&S.capturePreferredResolution(m,this.maxStoredPreferredResolutions)}}setIsRendering(g,m,S){m===Ke.MEDIA_TYPE.video&&this.videoTelemetry.setIsRendering(g),m===Ke.MEDIA_TYPE.sharing&&this.sharingTelemetry.setIsRendering(g),this.isMultiViewVideoTelemetry&&this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(S)]?.setIsRendering(g)}setReportedSendBandwidth(g){this.extensions.ReportedSendBWMax||this.extensions.ReportedSendBWMin?g>this.extensions.ReportedSendBWMax?this.extensions.ReportedSendBWMax=g:g<this.extensions.ReportedSendBWMin&&(this.extensions.ReportedSendBWMin=g):(this.extensions.ReportedSendBWMax=g,this.extensions.ReportedSendBWMin=g)}setMaxSessionBandwidth(g){this.extensions.MaxSessionBandwidth=g}isSubscribed(g,m){let S=this.subscribedTrackIds.some((m=>m===g));return!S&&this.configProvider.config.subscribeToSsrcForVideo&&(S=this.subscribedTrackSsrc.some((g=>g===`${m}`))),S||!this.multiparty&&this.configProvider.config.subscribeToSsrcForVideo}getReport(g=!1,m=!1){try{m&&this.resetPairValues(),g||(this.videoTelemetry.stopDataGathering(),this.sharingTelemetry.stopDataGathering());const S=this.videoTelemetry.getTotalDuration(Ke.MEDIA_DIRECTION.RECV),v=this.videoTelemetry.getTotalDuration(Ke.MEDIA_DIRECTION.SEND),C=this.sharingTelemetry.getTotalDuration(Ke.MEDIA_DIRECTION.RECV),_=this.sharingTelemetry.getTotalDuration(Ke.MEDIA_DIRECTION.SEND);if(S>=0&&(forOwn(this.videoTelemetry.getReport(Ke.MEDIA_DIRECTION.RECV,"Video_recv_",m),((g,m)=>this.extensions[m]=g)),!isEmpty(this.multiViewVideoTelemetry))){const g=[];for(const S of Object.keys(this.multiViewVideoTelemetry)){const v={id:S};forOwn(this.multiViewVideoTelemetry[S].getReport(Ke.MEDIA_DIRECTION.RECV,"Video",m),((g,m)=>{void 0!==g&&(v[m]=g)})),g.push(v)}this.extensions[Ke.MULTIPLE_RECV_STREAMS]=JSON.stringify(g)}C>=0&&forOwn(this.sharingTelemetry.getReport(Ke.MEDIA_DIRECTION.RECV,"Sharing_recv_",m),((g,m)=>this.extensions[m]=g)),v>=0&&(forOwn(this.videoTelemetry.getReport(Ke.MEDIA_DIRECTION.SEND,"Video_send_",m),((g,m)=>this.extensions[m]=g)),this.extensions.Bandwidth_jumpsHistogram=JSON.stringify(this.bandwidthTelemetry.getReport()),this.extensions.Bandwidth_uplinkStabilizationTime=JSON.stringify(this.stabilizationTelemetry.getReport(!0)),this.extensions.Video_send_CameraOpenWidth=this.cameraOpenResolution.width,this.extensions.Video_send_CameraOpenHeight=this.cameraOpenResolution.height),_>=0&&forOwn(this.sharingTelemetry.getReport(Ke.MEDIA_DIRECTION.SEND,"Sharing_send_",m),((g,m)=>this.extensions[m]=g)),forOwn(this.dataTelemetry.getReport("Data_"),((g,m)=>this.extensions[m]=g)),g||m||(this.simulcastVideo.finish(),this.extensions.Video_send_Simulcast=JSON.stringify(this.simulcastVideo.collectedSessions),this.simulcastSharing.finish(),this.extensions.Sharing_send_Simulcast=JSON.stringify(this.simulcastSharing.collectedSessions)),this.iceCandidateErrors.length>0&&(this.extensions.iceCandidateErrors=JSON.stringify(this.iceCandidateErrors)),this.extensions.Audio_recv_jitterBufferAvgSize=this.audioTelemetry.getAvgJitterBuffer(),this.extensions.Audio_recv_packetsLostRateMax=this.audioTelemetry.getPacketsLostRateMax(),this.extensions.Audio_recv_networkAvgLossRate=this.audioTelemetry.getNetworkAvgLostRate(),this.extensions.Audio_recv_jitterMax=this.audioTelemetry.getJitterMax(),this.extensions.Audio_recv_jitterAvg=this.audioTelemetry.getJitterAvg(),this.extensions.Video_SubscriptionEvents=m?"":JSON.stringify(this.videoTelemetry.getSubscriptionEvents()),this.extensions.Video_SubscriptionCounters=m?"":JSON.stringify(this.videoTelemetry.getSubscriptionCounters()),this.extensions.Sharing_SubscriptionEvents=m?"":JSON.stringify(this.sharingTelemetry.getSubscriptionEvents()),this.extensions.Sharing_SubscriptionCounters=m?"":JSON.stringify(this.sharingTelemetry.getSubscriptionCounters()),this.extensions.Audio_recv_healedRatioMax=this.audioHealedRatioTelemetry.getHealedRatioMax(),this.extensions.Audio_recv_healedRatioAvg=this.audioHealedRatioTelemetry.getHealedRatioAvg(),this.extensions.Audio_recv_packetsLostAvg=this.audioTelemetry.getAvgPacketsLost(),this.extensions.Audio_send_rttAvg=this.audioTelemetry.getAvgRtt(),this.extensions.Audio_send_rttMax=this.audioTelemetry.getMaxRtt(),this.extensions.CallSetupTimeTracker=JSON.stringify(this.timerTrackerManager.getReport());for(const g of Object.keys(this.extensions))void 0===this.extensions[g]&&delete this.extensions[g];delete this.extensions.WebRTCStats[Ke.MULTIPLE_RECV_STREAMS],this.sessionInfo.fillExtensionInfo(this.extensions);return Object.keys(this.extensions.WebRTCStats).length>0&&!this.extensions.WebRTCStats.hasStatsError&&this.calculateAverages(),this.extensions.H264_available_profiles=this.h264AvailableProfiles.join(),this.extensions.Video_recv_MSIDs=Array.from(this.MSIDs),this.totalVideoControlMessages>0&&(this.extensions.totalVideoControlMessages=this.totalVideoControlMessages,this.extensions.outOfOrderVideoControlMessages=this.outOfOrderVideoControlMessages),deepClone(this.report)}catch(g){throw this.processStatsError("Report",g),{error:g,partialReport:deepClone(this.report)}}}getAudioHwSilent(){return this.hwSilent}getSpeakingState(){return this.isSpeaking}getNetworkSendLevel(){return this.networkSendLevel}getNetworkRecvLevel(){return this.networkRecvLevel}addIceCandidateError(g){this.iceCandidateErrors.push(g)}clearIceCandidateErrors(){this.iceCandidateErrors=[]}addH264AvailableProfiles(g){this.h264AvailableProfiles=[...new Set(this.h264AvailableProfiles.concat(g))]}updateSendStream(g,m){this.audioTelemetry.updateSendStream(g,m)}getTimerTracker(g,m){return this.timerTrackerManager.getTimerTracker(g,m)}resetPairValues(){Object.keys(this.extensions.WebRTCStats).forEach((g=>{delete this.extensions.WebRTCStats[g].pair}))}limitCaptureAmount(g,m,S){void 0!==S&&(g[m]=Array.isArray(g[m])?g[m]:[],g[m].push(S),g[m].length>this.storedRecordsNumber&&g[m].shift())}setStartTime(g){const m=this.extensions.WebRTCStats;if(!m.ssrc_audio_send||!m.ssrc_audio_recv)return!1;const setupCounter=(g,m)=>!g||m&&-1===m?m:(new Date).getTime();return this.extensions.TimerAudioPayloadRecvBitrate=hasReceiveDirectionality(g.audio)?setupCounter(m.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioPayloadRecvBitrate):-1,this.extensions.TimerAudioPayloadSendBitrate=hasSendDirectionality(g.audio)?setupCounter(m.ssrc_audio_send.bytesSent,this.extensions.TimerAudioPayloadSendBitrate):-1,this.extensions.TimerAudioTransportRecvBitrate=hasReceiveDirectionality(g.audio)?setupCounter(m.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioTransportRecvBitrate):-1,this.extensions.TimerAudioTransportSendBitrate=hasSendDirectionality(g.audio)?setupCounter(m.ssrc_audio_send.bytesSent,this.extensions.TimerAudioTransportSendBitrate):-1,!(!m.ssrc_video_send||!m.ssrc_video_recv)&&(this.extensions.TimerVideoPayloadRecvBitrate=hasReceiveDirectionality(g.video)?setupCounter(m.ssrc_video_recv.bytesReceived,this.extensions.TimerVideoPayloadRecvBitrate):-1,this.extensions.TimerVideoPayloadSendBitrate=hasSendDirectionality(g.video)?setupCounter(m.ssrc_video_send.bytesSent,this.extensions.TimerVideoSendBitrate):-1,!!(this.extensions.TimerVideoPayloadRecvBitrate&&this.extensions.TimerVideoPayloadSendBitrate&&this.extensions.TimerAudioPayloadRecvBitrate&&this.extensions.TimerAudioPayloadSendBitrate&&this.extensions.TimerAudioTransportRecvBitrate&&this.extensions.TimerAudioTransportSendBitrate))}calculateAverages(){const g=this.extensions.EndTime,doTheCalc=(m,S)=>m&&g-S>0&&0!==S&&-1!==S?Math.round(8*m/(g-S)):0,getCounter=g=>{const m=g.split(".").reduce(((g,m)=>null==g?g:g[m]),this.extensions.WebRTCStats);return Array.isArray(m)?m[m.length-1]:m};this.extensions.AudioPayloadRecvBitrate=doTheCalc(getCounter("ssrc_audio_recv.bytesReceived"),this.extensions.TimerAudioPayloadRecvBitrate),this.extensions.AudioPayloadSendBitrate=doTheCalc(getCounter("ssrc_audio_send.bytesSent"),this.extensions.TimerAudioPayloadSendBitrate),this.extensions.VideoPayloadRecvBitrate=doTheCalc(getCounter("ssrc_video_recv.bytesReceived"),this.extensions.TimerVideoPayloadRecvBitrate),this.extensions.VideoPayloadSendBitrate=doTheCalc(getCounter("ssrc_video_send.bytesSent"),this.extensions.TimerVideoPayloadSendBitrate),this.extensions.AudioTransportRecvBitrate=doTheCalc(getCounter("ssrc_audio_send.pair.bytesReceived"),this.extensions.TimerAudioTransportRecvBitrate),this.extensions.AudioTransportSendBitrate=doTheCalc(getCounter("ssrc_audio_send.pair.bytesSent"),this.extensions.TimerAudioTransportSendBitrate)}addFilteredFields(g,m,S=[]){for(const v in m)if(m.hasOwnProperty(v)&&"type"!==v)if(-1!==S.indexOf(v)){const S=g[v]||[];S.push(this.formatFields(m,v)),S.length>this.storedRecordsNumber&&S.shift(),g[v]||(g[v]=S)}else g[v]=m[v]}formatFields(g,m){const S=g[m];switch(m){case"audioInputLevel":case"audioOutputLevel":return this.newStatsApi?Math.floor(65535*S):2*S;case"googJitterBufferMs":return parseInt(S);case"healedRatio":return round(parseFloat(S),this.configProvider.config.healedRatioPrecision);case"jitter":return round(parseFloat(S),this.configProvider.config.jitterPrecision);default:return S}}processSource(g,m,S){let v;if(this.addFilteredFields(g,m,QC),m.transportId){const C=S.googComponent?.[m.transportId];g.transport||(g.transport={}),C&&(this.addFilteredFields(g.transport,C),C.selectedCandidatePairId&&(v=S.googCandidatePair?.[C.selectedCandidatePairId]))}else v=Object.values(S.googCandidatePair).find((g=>g.selected));v&&(g.pair||(g.pair={}),this.addFilteredFields(g.pair,v,XC))}getWebrtcReport(g,m,S,v){const C=g.ssrc[S],_=v?C.id.replace(/[0-9]+/,v):C.id;m[_]?C.ssrc!==m[_].ssrc&&(_.endsWith("video_send")?this.videoTelemetry.stopSendGathering():_.endsWith("video_recv")?this.videoTelemetry.stopRecvGathering():_.endsWith("sharing_send")?this.sharingTelemetry.stopSendGathering():_.endsWith("sharing_recv")&&this.sharingTelemetry.stopRecvGathering()):m[_]={},this.processSource(m[_],C,g)}constructWebRTCDataReport(g,m){if(!m.data?.length)return;const S=m.data.sort(((g,m)=>m.timestamp-g.timestamp)),v=S.find((g=>"open"===g.state));g.data=v||S[0]}constructWebRtcReportForSingleStream(g,m){if(!m.ssrc)return;const S=this.selectSsrcsToCollect(m.ssrc);g.recvCounters=S.recvCounters,delete S.recvCounters,delete S.multiRecv,forOwn(S,(S=>{forOwn(S,((S,v)=>{this.getWebrtcReport(m,g,S,v)}))})),m.VideoBwe?.bweforvideo&&(g.bweStat||(g.bweStat={}),this.addFilteredFields(g.bweStat,m.VideoBwe.bweforvideo,ZC))}constructWebRtcReportForMultipleStreams(g,m){if(!m.ssrc)return;this.selectSsrcsToCollect(m.ssrc).multiRecv.forEach((S=>this.getWebrtcReport(m,g,S)))}getMediaType(g,m){let S=m?m.getModality():g.mediaType;return g.googTrackId?.match("applicationsharing")&&S!==Ke.MEDIA_TYPE.sharing&&(S=Ke.MEDIA_TYPE.sharing),S}selectSsrcsToCollect(g){const m={send:{},recv:{},recvCounters:{video:0,sharing:0},multiRecv:[]};if(!this.sessionInfo.activeModalities)return m;let S=[];for(const v of Object.keys(g)){const C=g[v],_=C.googTrackId;if(!_&&C.mediaType!==Ke.MEDIA_TYPE.audio)continue;const E=this.getMediaEntity(_,C),T=this.getMediaType(C,E),I=E?.getXSourceStreamId();if(v.endsWith("send"))switch(T){case Ke.MEDIA_TYPE.audio:hasSendDirectionality(this.sessionInfo.activeModalities.audio)&&(m.send.audio=v);break;case Ke.MEDIA_TYPE.video:if(this.extensions.Video_send_SourceId=I,this.simulcastVideo.highestFidelitySSRC){this.simulcastVideo.highestFidelitySSRC===C.ssrc&&(m.send.video=v);break}this.streamSenderStarted.Video&&hasSendDirectionality(this.sessionInfo.activeModalities.video)&&E?.getLocalTrackId()&&(E?.getLocalTrackId()===C.googTrackId||this.configProvider.config.statsAllowAnyVideoSendTrack&&!m.send.video)&&(!C.rid||"1"===C.rid)&&(m.send.video=v);break;case Ke.MEDIA_TYPE.sharing:if(this.simulcastSharing.highestFidelitySSRC){this.simulcastSharing.highestFidelitySSRC===C.ssrc&&(m.send.sharing=v);break}this.streamSenderStarted.ScreenShare&&hasSendDirectionality(this.sessionInfo.activeModalities.sharing)&&E?.getLocalTrackId()===C.googTrackId&&(m.send.sharing=v);break;default:this.logger.warn(`Unknown media type '${T}'`)}else if(v.endsWith("recv"))switch(T){case Ke.MEDIA_TYPE.audio:hasReceiveDirectionality(this.sessionInfo.activeModalities.audio)&&(m.recv.audio=v);break;case Ke.MEDIA_TYPE.video:void 0!==I&&this.MSIDs.add(I),this.isSubscribed(C.googTrackId,C.ssrc)&&hasReceiveDirectionality(this.sessionInfo.activeModalities.video)&&(S.push(C),+C.googFrameRateReceived>0&&m.recvCounters[Ke.MODALITY.video]++);break;case Ke.MEDIA_TYPE.sharing:this.isSubscribed(C.googTrackId,C.ssrc)&&hasReceiveDirectionality(this.sessionInfo.activeModalities.sharing)&&(m.recv.sharing=v,+C.googFrameRateReceived>0&&m.recvCounters[Ke.MODALITY.sharing]++);break;default:this.logger.warn(`Unknown media type '${T}'`)}}if(S.length>0){S=S.sort(((g,m)=>+m.googFrameHeightReceived-+g.googFrameHeightReceived));const g=S.find((g=>g.mediaType===Ke.MEDIA_TYPE.video));g&&(m.recv.video=g.id),this.multiparty&&this.configProvider.config.enableMultiViewStats&&(m.multiRecv=S.map((g=>g.id)),m.multiRecv.forEach((g=>{this.multiViewVideoTelemetry[g]||(this.multiViewVideoTelemetry[g]=new zC(this.extensions.StartTime,this.configProvider,this.logger.createChild(`Video[${g}]`,"Video")),this.multiViewVideoTelemetry[g].setMsi(this.MSIDsPairs[g]?.msi),this.multiViewVideoTelemetry[g].setLocalMsi(this.MSIDsPairs[g]?.localMsi),this.multiViewVideoTelemetry[g].prepareCollectingStatsOnSubscribed(this.MSIDsPairs[g]?.msi))})))}return m}getMediaEntityForTrack(g){if(g)return this.mediaManager.getMediaEntities().find((m=>m.getLocalTrackId()===g||m.getRemoteTrackId()===g))}getMediaEntityByRemoteSsrc(g){if(g)return this.mediaManager.getMediaEntities().find((m=>m.getRemoteSsrc()===+g))}getMediaEntity(g,m){const S=`${m.ssrc}`,v=m.id;let C=this.getMediaEntityForTrack(g);return!C&&this.configProvider.config.subscribeToSsrcForVideo&&v.endsWith("recv")&&(C=this.getMediaEntityByRemoteSsrc(S)),C}calculateHwSilentState(){const g=this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!g||g.length<2*this.hwSilentDetectionDuration)return;let m=!0;for(let S=g.length-this.hwSilentDetectionDuration-1;S<g.length;S++)if(g[S]>this.hwSilentDetectionLevel){m=!1;break}this.hwSilent!==m&&(this.hwSilent=m,this.logger.safe.info(`HW silent changed to ${this.hwSilent}`))}calculateSpeakingState(){const g=this.newStatsApi&&this.configProvider.config.useAudioAnalyzer?this.extensions.Audio_send_RawInputVolume:this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!g||g.length<=this.speakingWhileMutedBadDuration)return;let m=!1;for(let S=g.length-this.speakingWhileMutedBadDuration;S<g.length;S++)if(g[S]>this.speakingWhileMutedDetectionLevel){m=!0;break}this.isSpeaking=m}calculateNetworkRecvQualityLevel(){this.configProvider.config.enableNetworkRecvQualityUFD&&this.extensions.WebRTCStats.ssrc_audio_recv&&(this.networkRecvLevel=this.networkQualityTelemetry.calculateNetworkRecvQualityLevel({googDecodingCTN:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingCTN??[],googDecodingPLC:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingPLC??[],concealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.concealedSamples??[],silentConcealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.silentConcealedSamples??[],totalSamplesReceived:this.extensions.WebRTCStats.ssrc_audio_recv.totalSamplesReceived??[],oldNetworkLevel:this.networkRecvLevel.quality}))}calculateNetworkSendQualityLevel(){this.extensions.WebRTCStats.ssrc_audio_send&&(this.networkSendLevel=this.networkQualityTelemetry.calculateNetworkSendQualityLevel(this.extensions.WebRTCStats.ssrc_audio_send.packetsSent,this.extensions.WebRTCStats.ssrc_audio_send.packetsLost,this.extensions.WebRTCStats.ssrc_audio_send.jitter,this.networkSendLevel.quality))}processStatsError(g,m){const S=stringifyObject(m);this.logger.safe.error(`webrtcStatistics error [${g}]: ${S}`);const v=this.statsErrors.find((m=>m.error===S&&m.origin===g));v?v.count++:this.statsErrors.push({origin:g,error:S,count:1}),this.statsErrors.length>e_&&this.statsErrors.splice(1)}getLastSampleInt(g){return"number"==typeof g?g:g&&parseInt(g[g.length-1])||0}getSsrcIdFromMultipleVideoStream(g){let m;const S=this.extensions.WebRTCStats[Ke.MULTIPLE_RECV_STREAMS]||{};for(const v in S){const C=S[v];if(C&&C.googTrackId===g){m=v;break}}return m}};__decorateClass([catchStatsErrors],t_.prototype,"onDeviceEvent",1),__decorateClass([catchStatsErrors],t_.prototype,"onMaxCapabilitiesRequested",1),__decorateClass([catchStatsErrors],t_.prototype,"onMaxCapabilitiesApplied",1),__decorateClass([catchStatsErrors],t_.prototype,"addSubscriptionEvent",1),__decorateClass([catchStatsErrors],t_.prototype,"processSimulcastStats",1),__decorateClass([catchStatsErrors],t_.prototype,"processBandwidthStats",1),__decorateClass([catchStatsErrors],t_.prototype,"processAudioStats",1),__decorateClass([catchStatsErrors],t_.prototype,"processVideoStatsSend",1),__decorateClass([catchStatsErrors],t_.prototype,"processVideoStatsRecv",1),__decorateClass([catchStatsErrors],t_.prototype,"processSharingStats",1),__decorateClass([catchStatsErrors],t_.prototype,"processStreamsCounters",1),__decorateClass([catchStatsErrors],t_.prototype,"setMissedInitialPreferredResolution",1),__decorateClass([catchStatsErrors],t_.prototype,"setPreferredResolution",1),__decorateClass([catchStatsErrors],t_.prototype,"setIsRendering",1),__decorateClass([catchStatsErrors],t_.prototype,"setReportedSendBandwidth",1),__decorateClass([catchStatsErrors],t_.prototype,"setMaxSessionBandwidth",1),__decorateClass([catchStatsErrors],t_.prototype,"setStartTime",1),__decorateClass([catchStatsErrors],t_.prototype,"calculateAverages",1),__decorateClass([catchStatsErrors],t_.prototype,"addFilteredFields",1),__decorateClass([catchStatsErrors],t_.prototype,"formatFields",1),__decorateClass([catchStatsErrors],t_.prototype,"processSource",1),__decorateClass([catchStatsErrors],t_.prototype,"getWebrtcReport",1),__decorateClass([catchStatsErrors],t_.prototype,"constructWebRTCDataReport",1),__decorateClass([catchStatsErrors],t_.prototype,"constructWebRtcReportForSingleStream",1),__decorateClass([catchStatsErrors],t_.prototype,"constructWebRtcReportForMultipleStreams",1),__decorateClass([catchStatsErrors],t_.prototype,"selectSsrcsToCollect",1),__decorateClass([catchStatsErrors],t_.prototype,"calculateHwSilentState",1),__decorateClass([catchStatsErrors],t_.prototype,"calculateSpeakingState",1),__decorateClass([catchStatsErrors],t_.prototype,"calculateNetworkRecvQualityLevel",1),__decorateClass([catchStatsErrors],t_.prototype,"calculateNetworkSendQualityLevel",1);var i_="VideoBwe",n_="bweforvideo",r_="googAvailableReceiveBandwidth",s_="googAvailableSendBandwidth",a_="mediaType",o_="framesDecoded",l_="googFrameRateDecoded",c_="googFrameRateReceived",d_="googFrameRateInput",h_="googTrackId";function unwrapResults(g){const m={};return g.result().forEach((g=>{g.names().forEach((S=>{m[g.type]=m[g.type]||{},m[g.type][g.id]=m[g.type][g.id]||{},m[g.type][g.id][S]=g.stat(S)})),m[g.type][g.id].id=g.id})),m}var u_=class extends je{constructor(g,m,S,v){super(),this.logger=g,this.configProvider=m,this.mediaManager=S,this.window=Us.window,this._sessionInfo=new TS,this.statisticsMapper=new IC,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.webRtcStatistics=new t_(this.logger.createChild("WebrtcStatistics"),this._sessionInfo,this.configProvider,S,v,this.useNewStatsApi)}setAudioDecoderStatsProvider(g){this.statisticsMapper?.setAudioDecoderStatsProvider(g)}get sessionInfo(){return this._sessionInfo}get isDisposed(){return null===this.pc&&0===this.interval}initialize(g){this.pc=g}startWaitingForStreamStart(g){this.webRtcStatistics.startWaitingForStreamStart(g)}onDeviceEvent(g){this.webRtcStatistics.onDeviceEvent(g)}onMaxCapabilitiesRequested(g){this.webRtcStatistics.onMaxCapabilitiesRequested(g)}onMaxCapabilitiesApplied(g){this.webRtcStatistics.onMaxCapabilitiesApplied(g)}onSendersChanged(g,m){this.webRtcStatistics.setStreamSenderStarted(g,m)}addSubscriptionEvent(g,m,S,v,C,_,E){this.webRtcStatistics.addSubscriptionEvent(g,m,S,v,C,_,E)}setSubscribedTrackIds(g){this.webRtcStatistics.setSubscribedTrackIds(g)}setSubscribedTrackSsrc(g){this.webRtcStatistics.setSubscribedTrackSsrc(g)}setPreferredResolution(g,m,S){this.webRtcStatistics.setPreferredResolution(g,m,S)}setIsRendering(g,m,S){this.webRtcStatistics.setIsRendering(g,m,S)}setReportedSendBandwidth(g){this.webRtcStatistics.setReportedSendBandwidth(g)}setMaxSessionBandwidth(g){this.webRtcStatistics.setMaxSessionBandwidth(g)}setTerminated(){this.webRtcStatistics.setTerminated()}addIceCandidateError(g){this.webRtcStatistics.addIceCandidateError(g)}clearIceCandidateErrors(){this.webRtcStatistics.clearIceCandidateErrors()}recordDataChannelProtocolEvent(g){this.webRtcStatistics.recordDataChannelProtocolEvent(g)}setSessionDataChannelState(g){this.webRtcStatistics.setSessionDataChannelState(g)}recordDataChannelError(g){this.webRtcStatistics.recordDataChannelError(g)}updateSendStream(g,m){this.webRtcStatistics.updateSendStream(g,m)}getTimerTracker(g,m){return this.webRtcStatistics.getTimerTracker(g,m)}setH264AvailableProfiles(g){if(!g?.codecs)return;let m=[];g.codecs.forEach((g=>{if("h264"===g.mimeType&&g.sdpFmtpLine){const S=/profile-level-id=(.{6})/.exec(g.sdpFmtpLine);S?.[1]&&(m=m.concat(S[1]))}})),this.webRtcStatistics.addH264AvailableProfiles(m)}processRawReport(g){this.processStatsDict(this.statisticsMapper.build(g))}processLegacyReport(g){this.processStatsDict(unwrapResults(g))}getReport(g,m=!1){const S=this.webRtcStatistics.getReport(g,m);return this.addStreamInfoForE2ETests(S),S}dispose(){this.interval&&(this.window.clearInterval(this.interval),this.interval=0),this.pc=null}getLastStatistics(){return this.statistics}setTimeToFirstFrame(g,m,S){this.webRtcStatistics.setTimeToFirstFrame(g,m,S)}setFreezeDuration(g,m){this.webRtcStatistics.setFreezeDuration(g,m)}addVideoControlMessage(g=!1){this.webRtcStatistics.addVideoControlMessage(g)}setSsrcTrackPair(g,m){this.statisticsMapper.setSsrcTrackPair(g,m)}updateStatsWithLocalSsrcTrackInfo(){for(const g of this.mediaManager.getMediaEntities()){const m=g.getLocalSsrc();m&&this.statisticsMapper.setSsrcTrackPair(m,g.getLocalTrackId())}}addReportedReceiveBandwidth(g){this.webRtcStatistics.addReportedReceiveBandwidth(g)}addStreamInfoForE2ETests(g){const m=this._sessionInfo.negotiatedModalities;if(m&&!this.isDisposed)try{g.localStreams=this.getSendersReport(this.pc.getSenders(),{audio:hasSendDirectionality(m.audio),video:hasSendDirectionality(m.video)}),g.remoteStreams=this.getReceiversReport(this.pc.getReceivers(),{audio:hasReceiveDirectionality(m.audio),video:hasReceiveDirectionality(m.video)})}catch(g){this.logger.safe.warn(`addStreamInfoForE2ETests failed: ${stringifyObject(g)}`)}}getReceiversReport(g,m){const S=[];return g.forEach((g=>{const v={tracks:[]};S.push(v),g.track&&("audio"===g.track.kind&&m.audio||"video"===g.track.kind&&m.video)&&v.tracks.push({stream:void 0,track:g.track})})),S}getSendersReport(g,m){const S=[],v={tracks:[]};return S.push(v),g.forEach((g=>{g.track&&("audio"===g.track.kind&&m.audio||"video"===g.track.kind&&m.video)&&v.tracks.push({stream:void 0,track:g.track})})),S}processStatsDict(g){this.webRtcStatistics.processStatsDict(g);let m=0,S=0;const v=g[i_]?.[n_];v&&(m=Number(v[r_]),S=Number(v[s_]));const C=1e3*((this.configProvider.mediaConfig.maxBandwidthInKbps||Math.floor(Number.MAX_SAFE_INTEGER/1e3))-(this.configProvider.config.audioBandwidthInKbps||0)),_=isNaN(m)?0:m,E=isNaN(S)?0:S,T={estimatedReceiveBandwidth:Math.min(_,C),estimatedSendBandwidth:Math.min(E,C),remoteVideoStreams:{},localVideoStreams:{},isSpeaking:this.webRtcStatistics.getSpeakingState(),audioHwSilent:this.webRtcStatistics.getAudioHwSilent(),networkSendLevel:this.webRtcStatistics.getNetworkSendLevel(),networkRecvLevel:this.webRtcStatistics.getNetworkRecvLevel()};forOwn(g.ssrc,(g=>{if("video"!==g[a_])return;const m=g[h_],S=g.id;-1!==S.indexOf("_recv")?(T.remoteVideoStreams[m]={trackId:m,frameRateReceived:Number(g[c_]),frameRateDecoded:Number(g[l_]),framesDecoded:Number(g[o_])},this.configProvider.config.isRenderingBasedOnRawStatistics||(T.remoteVideoStreams[m].isRendering=this.webRtcStatistics.getIsRendering(S))):m&&-1!==S.indexOf("_send")&&(T.localVideoStreams[m]={trackId:m,ssrc:Number(g.ssrc),frameRateInput:Number(g[d_])})})),this.notifyRawStatisticsChanged(g),deepEqual(this.statistics,T)||(this.statistics=T,this.notifyStatisticsChanged())}notifyRawStatisticsChanged(g){this.event("onRawStatisticsChanged").raise(g)}notifyStatisticsChanged(){this.event("onStatisticsChanged").raise(this.statistics)}},g_=class extends je{constructor(g,m,S,v,C){super(),this.logger=g,this.configProvider=m,this.diagnostics=S,this.mediaManager=v,this.window=Us.window,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.loopIntervalTracker=new Vv(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.loopIntervalAggregator=new Bv,this.fetchTimeTracker=new Vv(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.fetchTimeAggregator=new Bv,this.gathererV1=new u_(this.logger.createChild("V1"),this.configProvider,this.mediaManager,C),this.gathererV1.on("onStatisticsChanged",(g=>this.event("onStatisticsChanged").raise(g))),this.gathererV1.on("onRawStatisticsChanged",(g=>this.event("onRawStatisticsChanged").raise(g))),this.useNewStatsApi&&m.config.diagnostics.sideBySide&&(this.gathererV2=new EC(this.logger.createChild("V2"),this.configProvider,this.diagnostics,this.mediaManager))}initialize(g){this.pc=g,this.gathererV1.initialize(g),this.interval??(this.interval=this.window.setInterval((()=>this.processStats()),this.configProvider.config.webrtcStatPollInterval))}setAudioDecoderStatsProvider(g){this.gathererV1.setAudioDecoderStatsProvider(g),this.gathererV2?.setAudioDecoderStatsProvider(g)}dispose(){super.dispose(),this.interval&&(this.window.clearInterval(this.interval),this.interval=void 0),this.gathererV1.dispose(),this.pc=void 0}get isDisposed(){return!this.pc&&void 0===this.interval}async processStats(){if(this.configProvider.config.diagnostics.collectWhileNotConnected){if(!this.pc||"closed"===this.pc.iceConnectionState)return}else if(!this.pc||"connected"!==this.pc.iceConnectionState&&"completed"!==this.pc.iceConnectionState)return void this.gathererV2?.signalNoConnection();if(this.useNewStatsApi){const g=Je(),m=void 0===this.loopTimer?-1:g-this.loopTimer;this.loopTimer=g,this.loopIntervalTracker.captureSample(m),this.loopIntervalAggregator.captureSample(this.loopIntervalTracker.getReport());const S=this.loopIntervalAggregator.getReport();S&&(this.diagnostics.loopIntervalMax=S.max,this.diagnostics.loopIntervalMedian=S.median);const v={};(await this.pc.getStats()).forEach((g=>{this.cleanupPii(g);const m=g.type;delete g.type,v[m]??(v[m]={}),v[m][g.id]=g}));const C=Je()-g;this.fetchTimeTracker.captureSample(C),this.fetchTimeAggregator.captureSample(this.fetchTimeTracker.getReport());const _=this.fetchTimeAggregator.getReport();_&&(this.diagnostics.fetchTimeMax=_.max,this.diagnostics.fetchTimeMedian=_.median);const E=this.gathererV2?.processRawReport(v);let T=Je();this.gathererV1.processRawReport(v),T=Je()-T,E&&this.event("onDiagnosticUpdated").raise(E),E?.perfCounters&&(E.perfCounters.loopTime=m,E.perfCounters.fetchTime=C,E.perfCounters.legacyProcessingTime=T)}else this.pc.getStats((g=>{g.result&&this.gathererV1.processLegacyReport(g)}))}cleanupPii(g){switch(g.type){case"local-candidate":case"remote-candidate":{const m=g;Object.defineProperty(m,"address",{enumerable:!1}),Object.defineProperty(m,"url",{enumerable:!1}),Object.defineProperty(m,"relatedAddress",{enumerable:!1}),Object.defineProperty(m,"ip",{enumerable:!1}),Object.defineProperty(m,"usernameFragment",{enumerable:!1});break}case"certificate":{const m=g;Object.defineProperty(m,"fingerprint",{enumerable:!1}),Object.defineProperty(m,"base64Certificate",{enumerable:!1});break}}}get sessionInfo(){return this.gathererV1.sessionInfo}setReportedSendBandwidth(g){this.gathererV1.setReportedSendBandwidth(g)}onMaxCapabilitiesApplied(g){this.gathererV1.onMaxCapabilitiesApplied(g)}clearIceCandidateErrors(){this.gathererV1.clearIceCandidateErrors()}setSsrcTrackPair(g,m){this.gathererV1.setSsrcTrackPair(g,m),this.gathererV2?.setSsrcTrackPair(g,m)}addSubscriptionEvent(g,m,S,v,C,_,E){this.gathererV1.addSubscriptionEvent(g,m,S,v,C,_,E)}setSubscribedTrackSsrc(g){this.gathererV1.setSubscribedTrackSsrc(g)}addIceCandidateError(g){this.gathererV1.addIceCandidateError(g)}setH264AvailableProfiles(g){this.gathererV1.setH264AvailableProfiles(g)}setTerminated(){this.gathererV1.setTerminated()}onDeviceEvent(g){this.gathererV1.onDeviceEvent(g)}getReport(g,m=!1){const S=this.gathererV1.getReport(g,m);if(this.gathererV2&&this.configProvider.config.diagnostics.sideBySide){const g=this.loopIntervalAggregator.getReport();g&&(S.data.Extensions.LoopIntervalMax=`${round(g.max,1)}`,S.data.Extensions.LoopIntervalMedian=`${round(g.median,1)}`);const m=this.fetchTimeAggregator.getReport();m&&(S.data.Extensions.FetchTimeMax=`${round(m.max,1)}`,S.data.Extensions.FetchTimeMedian=`${round(m.median,1)}`);const v=this.diagnostics.getObjectRef();S.data.Extensions.multipleVideoStreams=JSON.stringify(rebaseTime(v.multiViewStats,"startTime",v.startTime)),S.data.Extensions.OvcToSubscriptions=JSON.stringify(v.ovcToSubscriptionEvents),S.data.Extensions.videoPerformanceEvent=JSON.stringify(v.videoPerformanceEvent);const C=v.bandwidthReport;"REMB"===v.bweType?(S.data.Extensions.StartCallBWE=JSON.stringify(C?.startOfTheCall),S.data.Extensions.EndCallBWE=JSON.stringify(C?.endOfTheCall),S.data.Extensions.BWEStd=JSON.stringify(C?.std),S.data.Extensions.BwPercentiles=JSON.stringify(C?.bwPercentiles),S.data.Extensions.AvgBwe=JSON.stringify(C?.avgBwe)):(S.data.Extensions.StartCallBWESendSide=JSON.stringify(C?.startOfTheCall),S.data.Extensions.EndCallBWESendSide=JSON.stringify(C?.endOfTheCall),S.data.Extensions.BWEStdSendSide=JSON.stringify(C?.std),S.data.Extensions.BwPercentilesSendSide=JSON.stringify(C?.bwPercentiles),S.data.Extensions.AvgBwSendSide=JSON.stringify(C?.avgBwe)),S.data.Extensions.SentBWSeed=JSON.stringify(v.sentBWSeed),S.data.Extensions.Bandwidth_downlinkStabilizationTime=JSON.stringify(v.bwDownlinkStabilizationTime);const _=v.aggregatedModalityStats?.video?.recv||[],E=v.aggregatedModalityStats?.audio?.recv||[],T=v.aggregatedModalityStats?.sharing?.recv||[],I=_[_.length-1],b=T[T.length-1],A=I?.aggregated?.macroblockRateStats??{},R=E[E.length-1]?.aggregated?.customHealerStats??{};if(R?.pullPacketProcessingTimes){const g=getPercentilesProviderFromSampleFreqs(R.pullPacketProcessingTimes);R.pullPacketProcessingTimeP50=g.getPercentile(.5),R.pullPacketProcessingTimeP95=g.getPercentile(.95)}if(R?.pushPacketProcessingTimes){const g=getPercentilesProviderFromSampleFreqs(R.pushPacketProcessingTimes);R.pushPacketProcessingTimeP50=g.getPercentile(.5),R.pushPacketProcessingTimeP95=g.getPercentile(.95)}for(const g in A)S.data.Extensions[`Video_recv_${g}`]=`${round(A[g],0)}`;for(const g in v.totalVideoRecvMblocksRates)S.data.Extensions[`totalVideoRecv_${g}`]=`${round(v.totalVideoRecvMblocksRates[g],0)}`;for(const g in R)if(void 0!==R[g]){const m="number"!=typeof R[g]?JSON.stringify(R[g]):R[g];S.data.Extensions[`Audio_recv_customHealer_${g}`]=m}S.data.Extensions.CallSetupTimeTracker=JSON.stringify(v.timerTrackerReport),S.data.Extensions.Audio_send_presentationAPIUserDuration=JSON.stringify(v.presentationAPIUserDuration),S.data.Extensions.Audio_send_presentationDuration=JSON.stringify(v.presentationAudioDuration),S.data.Extensions.CodecSupport=JSON.stringify(v.codecSupport),S.data.Extensions.Video_recv_FpsHarmonicAverage=I?.extensions.fpsHarmonicAverage?.toString(),S.data.Extensions.Sharing_recv_FpsHarmonicAverage=b?.extensions.fpsHarmonicAverage?.toString(),S.data.Extensions.Sharing_recv_CodecReport=JSON.stringify(b?.aggregated.codecReport),this.configProvider.config.diagnostics.features.takeFreezeTelemetryFromGathererV2&&(_.length&&(S.data.Extensions.Video_recv_FreezeHistogram=JSON.stringify(I.aggregated.freezeCountHistogram),S.data.Extensions.Video_recv_LongestFreezeDuration=JSON.stringify(I?.aggregated?.longestFreeze),S.data.Extensions.Video_recv_OngoingFreeze=JSON.stringify(I?.extensions?.isFrozen),S.data.Extensions.Video_recv_OngoingFreezeDuration=JSON.stringify(I?.aggregated?.ongoingFreezeDuration),S.data.Extensions.Video_recv_TotalFreezeDuration=JSON.stringify(I?.aggregated?.totalFreezeDuration),S.data.Extensions.Video_recv_RecvAvgFreezeDuration=JSON.stringify(I?.aggregated?.avgFreezeDuration),S.data.Extensions.Video_recv_FreezeTimestamps=JSON.stringify(rebaseHistogramTimestamps(I?.aggregated?.freezeTimestampsHistogram,v.startTime))),T.length&&(S.data.Extensions.Sharing_recv_FreezeHistogram=JSON.stringify(b.aggregated.freezeCountHistogram),S.data.Extensions.Sharing_recv_LongestFreezeDuration=JSON.stringify(b?.aggregated?.longestFreeze),S.data.Extensions.Sharing_recv_OngoingFreeze=JSON.stringify(b?.extensions?.isFrozen),S.data.Extensions.Sharing_recv_OngoingFreezeDuration=JSON.stringify(b?.aggregated?.ongoingFreezeDuration),S.data.Extensions.Sharing_recv_TotalFreezeDuration=JSON.stringify(b?.aggregated?.totalFreezeDuration),S.data.Extensions.Sharing_recv_RecvAvgFreezeDuration=JSON.stringify(b?.aggregated?.avgFreezeDuration),S.data.Extensions.Sharing_recv_FreezeTimestamps=JSON.stringify(rebaseHistogramTimestamps(b?.aggregated?.freezeTimestampsHistogram,v.startTime)))),S.data.Extensions.EarlyMedia={NumStatsPolls:`${v.earlyMediaNumStatsPolls}`}}return S}startWaitingForStreamStart(g){this.gathererV1.startWaitingForStreamStart(g)}getTimerTracker(g,m){return this.gathererV1.getTimerTracker(g,m)}getLastStatistics(){return this.gathererV1.getLastStatistics()}updateSendStream(g,m){this.gathererV1.updateSendStream(g,m)}setSubscribedTrackIds(g){this.gathererV1.setSubscribedTrackIds(g)}setMaxSessionBandwidth(g){this.gathererV1.setMaxSessionBandwidth(g)}updateStatsWithLocalSsrcTrackInfo(){this.gathererV1.updateStatsWithLocalSsrcTrackInfo()}onSendersChanged(g,m){this.gathererV1.onSendersChanged(g,m)}setPreferredResolution(g,m,S){this.gathererV1.setPreferredResolution(g,m,S)}setIsRendering(g,m,S){this.gathererV1.setIsRendering(g,m,S)}setTimeToFirstFrame(g,m,S){this.gathererV1.setTimeToFirstFrame(g,m,S)}setFreezeDuration(g,m){this.gathererV1.setFreezeDuration(g,m)}addVideoControlMessage(g){this.gathererV1.addVideoControlMessage(g)}setSessionDataChannelState(g){this.gathererV1.setSessionDataChannelState(g)}recordDataChannelError(g){this.gathererV1.recordDataChannelError(g)}onMaxCapabilitiesRequested(g){this.gathererV1.onMaxCapabilitiesRequested(g)}recordDataChannelProtocolEvent(g){this.gathererV1.recordDataChannelProtocolEvent(g)}addReportedReceiveBandwidth(g){this.gathererV1.addReportedReceiveBandwidth(g)}},p_=101,m_=[48e3,32e3,24e3,16e3,12e3],f_=class{constructor(g){this.context=g,this.cname=uniqueId(),this.dataMedia={type:Ke.MEDIA_TYPE.data,protocol:Ke.PROFILES.rtpSavp,port:0},this.configProvider=g.configProvider,this.logger=g.getLogger().createChild("WebkitSdpTrans")}fixTelephoneEvent(g){let m;return m_.forEach((m=>{removeCodec(g,{codec:"telephone-event",rate:m})})),updatePayload(g,p_,999),forOneCodec(g,{codec:"telephone-event",rate:8e3},(g=>(m=g.rtp.payload,g.rtp.payload=p_,g))),updatePayload(g,999,m||p_),m}toLocal(g,m,S){const v=m.isEmpty(),C=deepClone(g);let _;return C.media.forEach((g=>{if("audio"===g.type)v&&(_=this.fixTelephoneEvent(g)),fixComfortNoise(g);else{_&&updatePayload(g,p_,_);const S=m.getLocalSsrcs().get(getModality(g));this.enforceFixedSsrc(g,S)}const C=getAllowedCodecs(this.configProvider,g.type);"offer"===S&&filterCodecs2(g,C,v,this.logger)})),new Zf(this.configProvider).modify(C),delete C.extmapAllowMixed,C}toOffer(g,m,S){return this.fromNative(g,m,S,!0)}toAnswer(g,m,S){return this.fromNative(g,m,S,!1)}toRemote(g,m,S,v){const C=deepClone(g);let _,E,T=this.configProvider.mediaConfig.maxBandwidthInKbps;C.bandwidth&&(!T||T>g.bandwidth[0].limit)&&(T=g.bandwidth[0].limit),C.media.forEach(((g,S)=>{m.getMediaEntity(S).isDisabled()&&g.type!==Ke.MEDIA_TYPE.audio&&(g.port=0)}));let I=getBundle2(C);if(!I){let g=!1;C.media.forEach(((S,v)=>{const C=m.getMediaEntity(v);!g&&C.isEnabled()?(S.mid=C.getMid(),g=!0):(C.disable(),S.port=0)})),g&&(C.groups||(C.groups=[]),I={type:"BUNDLE"},C.groups.push(I))}C.media.forEach((g=>{const m=getModality(g);S[m]===Ke.MEDIA_STATE.send&&(g.direction&&g.direction.toLowerCase()===Ke.MEDIA_STATE.receive||(g.direction=Ke.MEDIA_STATE.receive))}));const b=C.media.filter((g=>g.type===Ke.MEDIA_TYPE.video));if(b.length>0){const g=b.filter((g=>0!==g.port));if(g.length>0){E=deepClone(g[0]),E.bandwidth&&delete E.bandwidth;const m=this.configProvider.config.audioBandwidthInKbps?this.configProvider.config.audioBandwidthInKbps:0;T&&T-m>0&&(E.bandwidth=[{limit:T-m,type:"AS"}]),E.mid="video",E.direction=null,delete E.label,E.ssrcs=[],E.ssrcGroups=[],delete E.msid,g.forEach((g=>{g.ssrcs&&(E.ssrcs=E.ssrcs.concat(g.ssrcs)),g.ssrcGroups&&(E.ssrcGroups=E.ssrcGroups.concat(g.ssrcGroups)),E.direction=mergeDirections(E.direction,g.direction||Ke.MEDIA_STATE.sendReceive)})),removeUnifiedPlanExtensions(E)}else E=disabledMedia2(Ke.MEDIA_TYPE.video,void 0,b[0].protocol,b[0].payloads)}const A=C.media.find((g=>g.type===Ke.MEDIA_TYPE.audio));if(A)if(0!==A.port)_=deepClone(A),_.mid="audio",delete _.label,removeG722Codec(_),fixComfortNoise(_),removeUnifiedPlanExtensions(_);else{_=disabledMedia2(Ke.MEDIA_TYPE.audio,void 0,A.protocol,A.payloads);const g=C.media.find((g=>!!g.iceUfrag));g&&(_.port=9,_.direction="inactive",_.mid="audio",_.iceUfrag=g.iceUfrag,_.icePwd=g.icePwd,_.rtcpMux="rtcp-mux",g.crypto&&(_.crypto=g.crypto),g.fingerprint&&(_.fingerprint=g.fingerprint,_.setup=g.setup),_.rtp=[{payload:0,codec:"PCMU",rate:8e3}],_.payloads="0")}C.media.forEach(((g,m)=>{g.type===Ke.MEDIA_TYPE.data&&(g.type=Ke.MEDIA_TYPE.dataChannel,g.payloads=Ke.PAYLOAD_TYPE.DATA_CHANNEL,g.protocol=Ke.PROFILES.udpDtlsSctp,g.mid="data",delete g.xDataProtocol,delete g.direction,isMediaDisabled(g)&&(C.media[m]=disabledMedia2(g.type,void 0,g.protocol,g.payloads)))}));const R=allowDataChannel(this.context)?C.media.find((g=>g.type===Ke.MEDIA_TYPE.dataChannel)):null;C.media=[_,E,R].filter((g=>g)),m.getMediaEntities()[0].getModality()!==Ke.MODALITY.audio&&C.media.reverse();const P=preferSdesSrtp(this.context),M=getSrtpInfo(g);return C.media.forEach((g=>{g.type!==Ke.MEDIA_TYPE.dataChannel&&(!P&&g.fingerprint&&g.crypto&&delete g.crypto,g.protocol=!M.dtls||M.sdes&&P?Ke.PROFILES.rtpSavpf:Ke.PROFILES.udpTlsRtpSavpf)})),"offer"===v&&(filterCodecs2(_,this.configProvider.config.allowedAudioCodecs,!1,this.logger),filterCodecs2(E,this.configProvider.config.allowedVideoCodecs,!1,this.logger)),fixBundling(C,this.configProvider.mediaConfig.isTransportUnbundled),C}splitMedia(g,m,S,v,C){const _=g.getMid(),E=g.getModality(),T=deepClone(m);if(T.label=getLabelForModality(E),T.direction=v,T.mid=_,T.ssrcs=[],T.ssrcGroups=[],g.getModality()===Ke.MODALITY.data)return T.type=Ke.MEDIA_TYPE.data,T.payloads=Ke.PAYLOAD_TYPE.X_DATA,T;const I=S.filter((g=>g.modality===E));if(I&&I.length){const g=[];m.ssrcs&&(I.forEach((S=>{const v=m.ssrcs.filter((g=>"msid"===g.attribute&&S.trackId===getTrackId(g.value))).map((g=>g.id));g.push(...v)})),T.ssrcs=m.ssrcs.filter((m=>g.indexOf(m.id)>-1)),T.ssrcs.forEach((g=>{"cname"===g.attribute&&(g.value=this.cname)}))),m.ssrcGroups&&(T.ssrcGroups=m.ssrcGroups.filter((m=>m.ssrcs.split(" ").find((m=>g.indexOf(+m)>-1)))))}else{if(v===Ke.MEDIA_STATE.send||v===Ke.MEDIA_STATE.sendReceive)return disabledMedia2(m.type,getLabelForModality(E),m.protocol,m.payloads);v!==Ke.MEDIA_STATE.receive&&v!==Ke.MEDIA_STATE.inactive||(C[m.type].ssrcs&&C[m.type].ssrcs[0]?T.ssrcs=[{id:C[m.type].ssrcs[0].id,attribute:"cname",value:this.cname}]:m.type===Ke.MEDIA_TYPE.audio?T.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:m.type===Ke.MEDIA_TYPE.video&&(T.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}return T}fromNative(g,m,S,v){const C=deepClone(g),_=this.configProvider.mediaConfig.maxBandwidthInKbps;_&&(C.bandwidth=[{limit:_,type:"CT"}]),new eS(this.configProvider).modify(C);const E=C.media.find((g=>g.type===Ke.MEDIA_TYPE.audio)),T=C.media.find((g=>g.type===Ke.MEDIA_TYPE.video)),I=C.media.find((g=>g.type===Ke.MEDIA_TYPE.dataChannel)),b={};b[Ke.MODALITY.audio]=E,b[Ke.MODALITY.video]=T,b[Ke.MODALITY.sharing]=T,b[Ke.MODALITY.data]=I||this.dataMedia;const A={};A[Ke.MEDIA_TYPE.audio]=E,A[Ke.MEDIA_TYPE.video]=T,A[Ke.MEDIA_TYPE.data]=I||this.dataMedia;const R={};return R[Ke.MODALITY.audio]=m.getMediaEntitiesByModality(Ke.MODALITY.audio)[0],R[Ke.MODALITY.video]=m.getMediaEntitiesByModality(Ke.MODALITY.video)[0],R[Ke.MODALITY.sharing]=m.getMediaEntitiesByModality(Ke.MODALITY.sharing)[0],R[Ke.MODALITY.data]=m.getMediaEntitiesByModality(Ke.MODALITY.data)[0],C.media=[],m.getMediaEntities().forEach((g=>{let _,E=S[g.getModality()];!g.isEnabled()||0===b[g.getModality()].port||g!==R[g.getModality()]&&E===Ke.MEDIA_STATE.send?(_=disabledMedia2(g.getType(),getLabelForModality(g.getModality()),b[g.getModality()].protocol,b[g.getModality()].payloads),b[g.getModality()].payloads===Ke.PAYLOAD_TYPE.DATA_CHANNEL&&(_.payloads=Ke.PAYLOAD_TYPE.DATA_CHANNEL)):(E!==Ke.MEDIA_STATE.inactive&&g!==R[g.getModality()]&&(E=Ke.MEDIA_STATE.receive),_=this.splitMedia(g,b[g.getModality()],m.getLocalTracksInfo(),E,A),g!==R[g.getModality()]&&(_.candidates=[]));const T=b[g.getModality()].setup;T&&("actpass"!==T?g.setExtension("setup",T):v&&void 0!==g.getExtension("setup")&&(_.setup="actpass"!==g.getExtension("setup")?g.getExtension("setup"):T));const I=b[g.getModality()].iceUfrag,P=g.getExtension("iceUfrag");g.setExtension("iceRestart",!!I&&!!P&&P!==I),g.setExtension("iceUfrag",I),isMediaDisabled(_)&&g.disable(),C.media.push(_)})),new vf(this.context,S.data).modify(C),fixBundling(C,this.configProvider.mediaConfig.isTransportUnbundled),C}enforceFixedSsrc(g,m){let S=-1;if(!g.ssrcs)return;const v=[];if(g.ssrcs.forEach((g=>{"msid"===g.attribute&&v.push({ssrc:g.id,trackId:getTrackId(g.value)})})),g.ssrcs.forEach((g=>{"cname"===g.attribute&&S++,m&&(g.id=this.getVideoSSRC(S,m))})),g.ssrcGroups){const m=g.ssrcs.filter((g=>"cname"===g.attribute)).map((g=>g.id));g.ssrcGroups.forEach(((g,S)=>{g.ssrcs=[m[2*S],m[2*S+1]].join(" ")}))}}getVideoSSRC(g,m){return g%2==1?m+50:m}};function removeG722Codec(g){removeCodec(g,{codec:"g722",rate:8e3,encoding:2})}function removeUnifiedPlanExtensions(g){const m=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);g.ext&&(g.ext=g.ext.filter((g=>!m.has(g.uri))))}function fixComfortNoise(g){removeCodec(g,{codec:"CN",rate:16e3})}function getBundle2(g){return g.groups?g.groups.find((g=>"BUNDLE"===g.type)):null}function fixBundling(g,m){const S=g.groups?.findIndex((g=>"BUNDLE"===g.type)),v=g.groups?g.groups[S]:void 0;v&&(m?(v.mids=g.media.filter((g=>g.type===Ke.MEDIA_TYPE.video)).map((g=>g.mid)).filter((g=>g)).join(" "),v.mids||delete g.groups[S]):v.mids=g.media.map((g=>g.mid)).filter((g=>g)).join(" "))}function disabledMedia2(g,m,S,v){return{type:g,port:0,label:m,payloads:v,protocol:S}}function getTrackId(g){return g.split(" ")[1]}function mergeDirections(g,m){return g===Ke.MEDIA_STATE.sendReceive||m===Ke.MEDIA_STATE.sendReceive?Ke.MEDIA_STATE.sendReceive:g===m?g:g&&m&&g!==m?Ke.MEDIA_STATE.sendReceive:g||m}function filterCodecs2(g,m,S,v){if(!m.length||!g?.port)return;filterCodecs(g,convertToCodecInfo(m),S,v)}var S_=__toESM(Me()),v_=class{getCapabilities(g){const m=RTCRtpReceiver.getCapabilities(g);return m.codecs.forEach((g=>{const m=g.mimeType.toLowerCase().split("/");g.mimeType=m[1]||m[0]})),Promise.resolve(m)}},C_=class{constructor(g,m){this.noRequiredCodecsWorkaround=m,this.selfGlobal=g.global.capabilityGatherer=g.global.capabilityGatherer||{},this.getCapabilities("video")}async getCapabilities(g){if("video"!==g&&"audio"!==g)return Promise.reject(new Error(`capabilities for ${g} are not supported`));if(!this.selfGlobal.gatherTask){const g=defer4();this.selfGlobal.gatherTask=g.promise;const m=void 0!==Us.window.webkitRTCPeerConnection,S=m?new Us.window.webkitRTCPeerConnection(null):new Us.window.RTCPeerConnection(null),createOfferWrapper=g=>m?new Promise(((m,v)=>{S.createOffer(m,v,g)})):(this.noRequiredCodecsWorkaround&&S.addTrack(S.addTransceiver("video").receiver.track),S.createOffer(g));try{const m=await createOfferWrapper({offerToReceiveVideo:1,offerToReceiveAudio:1}),v={};S_.parse(m.sdp).media.forEach((g=>{v[g.type]=g.rtp.map((m=>{const S={mimeType:m.codec.toLowerCase()};if("video"===g.type){const v=g.fmtp?.find((g=>g.payload===m.payload));S.sdpFmtpLine=v?.config}return S}))})),S.close(),g.resolve(v)}catch(m){this.selfGlobal.gatherTask=null,S.close(),g.reject(m)}}return this.selfGlobal.gatherTask.then((m=>({codecs:m[g]})))}},y_={build:(g,m,S=!1)=>!m&&Vs.hasCapabilitiesApi()?new v_:new C_(g,S)},E_=__toESM(Me()),T_="rollback";function SessionDescription2(){const g=[].slice.apply(arguments);let m=g[0]&&isRollback(g[0].type);g.splice(0,m?1:0,null);const S=new(Function.prototype.bind.apply(Us.window.RTCSessionDescription,g)),v=Object.getOwnPropertyDescriptor(Us.window.RTCSessionDescription.prototype,"type");return Object.defineProperty(S,"type",{get:()=>m?T_:v.get.call(S),set(g){m=isRollback(g),m||v.set.call(S,g)}}),S}function isRollback(g){return T_===g}var I_={build:()=>SessionDescription2},b_=[{codec:"telephone-event",rate:8e3},{codec:"cn",rate:16e3}];function PeerConnection(g){const m=[],S=I_.build(),v=[].slice.apply(arguments);v.splice(0,1,null),overrideSetting("iceTransportPolicy","iceTransports");const C=new(Function.prototype.bind.apply(Us.window.webkitRTCPeerConnection,v));function overrideSetting(g,m){v[1]&&v[1][g]&&(v[1][m]=v[1][g])}function shim(){shimPromises(),shimSetRemoteDescription(),shimCreateAnswer(),shimCreateOffer(),shimSenders()}function shimPromises(){[{name:"createOffer",reverseArgs:!0},"createAnswer","setRemoteDescription","setLocalDescription"].forEach((function(g){const m=g.name||g,S=C[m];C[m]=function(){const m=arguments;return new Promise((function(v,_){const E=[v,_];m.length>0&&E.splice(g.reverseArgs?E.length:0,0,m[0]),S.apply(C,E)}))}}))}function Sender(g,m){let S;Object.defineProperty(this,"dtmf",{get:()=>"audio"===g.kind?(S=S||C.createDTMFSender(g),S):null}),this.track=g,this._stream=m}function shimSenders(){C.getSenders&&C.addTrack&&C.removeTrack||(C.getSenders=function(){return m.slice()},C.addTrack=function(g,S){if(!g||!S)throw new Error("both media track and stream need to be provided");C.getLocalStreams().some((function(g){return g.id===S.id}))||C.addStream(S);let v=m.find((function(m){return m.track.id===g.id}));return v||(v=new Sender(g,S),m.push(v)),v},C.removeTrack=function(g){C.getLocalStreams().filter((function(m){return m.id===g._stream.id})).forEach((function(g){C.removeStream(g)})),remove2(m,(m=>m===g))})}function shimCreateOffer(){const g=C.createOffer;C.createOffer=function(m){const S=arguments;return m&&m.offerToReceiveVideo>1&&(m.offerToReceiveVideo=1),g.apply(C,S)}}function shimSetRemoteDescription(){["createOffer","createAnswer","setLocalDescription"].forEach((function(m){const S=C[m];C[m]=function(){const m=arguments;return g.getCapabilities("video").then((function(){return S.apply(S,m)}))}}));const m=C.setRemoteDescription;C.setRemoteDescription=function(S){return g.getCapabilities("video").then((function(g){const v=g.codecs,C=E_.parse(S.sdp);return C.media.forEach((function(g){if("video"===g.type){g.rtp.some((function(g){return v.some((function(m){return g.codec.toLowerCase()===m.mimeType}))}))?suppressH264FormatParameters(g):g.port=0}if(!hasDtls(g)){const m=getBundle(C);m?g.crypto=m.crypto:g.port||C.media.some((function(m){return!!m.port&&(g.crypto=m.crypto,!0)}))}})),S.sdp=E_.write(C),m(S)}))}}function shimCreateAnswer(){const g=C.createAnswer;C.createAnswer=function(){const m=arguments;return g.apply(C,m).then((function(g){if(!C.localDescription||!C.localDescription.sdp)return g;const m=E_.parse(C.localDescription.sdp),v=[];if(m.media.forEach((function(g){b_.forEach((function(m){forOneCodec(g,m,(function(g){v.push(g)}))}))})),v.length){const m=E_.parse(g.sdp);let C=!1;m.media.forEach((function(g){v.forEach((function(m){forOneCodec(g,{codec:m.rtp.codec,rate:m.rtp.rate},(function(g){g.rtp.payload!==m.rtp.payload&&(g.rtp.payload=m.rtp.payload,C=!0)}))}))})),C&&(g=new S({type:g.type,sdp:E_.write(m)}))}return g}))}}function suppressH264FormatParameters(g){forOneCodec(g,{codec:"h264",rate:9e4},(function(g){if(g.fmtp){const m=new Zm,S=new Zm(g.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((function(g){if(S.contains(g)){let v=S.get(g);"profile-level-id"===g&&(v="42C02A"),m.setIfMissing(g,v)}})),g.fmtp.config=m.toString()}}))}function hasDtls(g){return"RTP/SAVPF"!==g.protocol}return shim(),C}var A_={build:g=>PeerConnection.bind(null,g)},R_=class{constructor(g){const m=g.configProvider.config.useSdpCapabilitiesLegacySession,S=g.configProvider.config.noRequiredCodecsWorkaround;this.RTCRtpReceiver=y_.build(g,m,S),this.SdpTransform=f_,this.RTCPeerConnection=A_.build(this.RTCRtpReceiver),this.RTCSessionDescription=I_.build()}};function UnsupportedAdapter(){function throwUnsupported(){throw new Error("unsupported platform")}this.SdpTransform=throwUnsupported,this.RTCPeerConnection=throwUnsupported,this.RTCSessionDescription=throwUnsupported,this.RTCRtpReceiver=throwUnsupported}function isWebkitRtc(){return void 0!==Us.window.webkitRTCPeerConnection}var P_={build:g=>isWebkitRtc()?new R_(g):new UnsupportedAdapter},M_=class{constructor(g,m,S,v){this.logger=g,this.configProvider=m,this.activeSpeakerManager=S,this.contributingSourcesProvider=v,this.lastSources=[],this.poll=()=>{const g=this.contributingSourcesProvider.getContributingSources();if(!g)return this.logger.safe.info("Contributing sources are not supported on this client"),void this.dispose();this.activeSpeakerManager.onContributingSourcesChanged(g.filter((g=>{const m=this.lastSources.find((m=>m.source===g.source));return!m||m.timestamp!==g.timestamp})).map((g=>g.source))),this.updateLastSources(g),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)},this.contributingSourcesProvider=v,this.logger.safe.info("Polling started"),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)}dispose(){this.timer&&(window.clearTimeout(this.timer),this.timer=void 0),this.contributingSourcesProvider=void 0,this.logger.safe.info("Polling stopped")}updateLastSources(g){this.lastSources=g.map((g=>({source:g.source,timestamp:g.timestamp})))}},w_=class{constructor(g,m){this.logger=g,this.peerConnection=m}getContributingSources(){try{if(!this.peerConnection?.getReceivers)return;const g=this.peerConnection.getReceivers().find((g=>"audio"===g.track.kind));return g?g.getContributingSources?.():[]}catch(g){return void this.logger.safe.error("Failed to get contributing sources",g)}}},D_=P,O_=[2812,4218,8437,16875,33750,67500,108e3,135e3,198e3,244800,27e4,352500,52e4],N_=class{constructor(g,m,S,v){this.initialMaxFS=g,this.initialMaxFPS=m,this.isAv1Allowed=S,this.h264SubscribeProfile=v,this.maxFS=g,this.maxFPS=m}setMaxFS(g,m){return!(this.maxFS===g||(this.maxFS=g,!m))&&(m(this),!0)}getMaxFS(){return this.maxFS}getMaxFPS(){return this.maxFPS}getMaxMBPS(){return this.calculateMbps(this.maxFS,this.maxFPS)}calculateMbps(g,m){return getClosestValue(O_,g*m/100,!0)}resetToInitial(){this.maxFS=this.initialMaxFS,this.maxFPS=this.initialMaxFPS}fmtpParams(){return{"max-fs":this.getMaxFS(),"max-mbps":this.getMaxMBPS(),"max-fps":this.getMaxFPS()}}buildFmtp(){const g=[];let m=this.fmtpParams();return this.h264SubscribeProfile&&(m["profile-level-id"]=this.h264SubscribeProfile),g.push(m),this.isAv1Allowed&&(m=this.fmtpParams(),m.codec="AV1",g.push(m)),g}},k_=class _MediaEntity{constructor(g,m){this.entity=g,this.configProvider=m}static getVideoCababilities(g,m,S){if(g!==Ke.MEDIA_TYPE.video)return null;let v,C;m===Ke.MODALITY.sharing?(v=S.config.webrtcScreensharingCapabilityMaxFS,C=S.config.webrtcScreensharingCapabilityMaxFPS):(v=S.config.webrtcVideoCapabilityMaxFS,C=S.config.webrtcVideoCapabilityMaxFPS,S.config.useMultiviewLimitsOnInitialRequest&&S.config.multiviewResolutionLimits[1]&&(v=Lp.Send.getResolutionForHeight(S.config.multiviewResolutionLimits[1]).fs));const _=S.config.isAv1Allowed&&m===Ke.MODALITY.sharing;return new N_(v,C,_,S.config.h264SubscribeProfile)}static create(g,m,S){const v=getTypeFromModality(m),C=new _MediaEntity({modality:m,mid:S,mtype:v,extensions:{}},g);return C.localRecvCapabilities=_MediaEntity.getVideoCababilities(v,m,g),C}clone(){const g=new _MediaEntity((0,D_.cloneDeep)(this.entity),this.configProvider);return g.setSimulcastContext(this.simulcastContext),g.localRecvCapabilities=this.localRecvCapabilities,g.remoteRecvCapabilities=this.remoteRecvCapabilities,g}getModality(){return this.entity.modality}getType(){return this.entity.mtype}getMid(){return this.entity.mid}disable(){this.entity.mid=null}update(g,m){this.entity.modality!==g&&(this.localRecvCapabilities=_MediaEntity.getVideoCababilities(this.entity.mtype,g,this.configProvider)),this.entity.modality=g,this.entity.mid=m,this.isEnabled()&&this.setExtension("rollback",!1)}isDisabled(){return!this.entity.mid}isEnabled(){return!!this.entity.mid}getLocalRecvCapabilities(){return this.localRecvCapabilities}getRemoteRecvCapabilities(){return{sourceId:this.getXSourceStreamId(),capabilities:this.remoteRecvCapabilities?[this.remoteRecvCapabilities]:[]}}setRemoteRecvCapabilities(g){this.remoteRecvCapabilities=g}getRemoteStreamId(){return this.entity.remoteStreamId}setRemoteStreamId(g){this.entity.remoteStreamId=g}setRemoteSsrc(g){this.entity.remoteSsrc=g}getRemoteSsrc(){return this.entity.remoteSsrc}setLocalSsrc(g){this.entity.localSsrc=g}getLocalSsrc(){return this.entity.localSsrc}getRemoteTrackId(){return this.entity.remoteTrackId}setRemoteTrackId(g){this.entity.remoteTrackId=g}getXSourceStreamId(){return this.entity.xSourceStreamId}setXSourceStreamId(g){this.entity.xSourceStreamId=g}setLocalTrackId(g){this.entity.localTrackId=g}getLocalTrackId(){return this.entity.localTrackId}setSubStreamIndex(g){this.entity.subStreamIndex=g}getSubstreamIndex(){return this.entity.subStreamIndex}getExtension(g){return this.entity.extensions[g]}setExtension(g,m){this.entity.extensions[g]=m}getRtpHeaderExtensions(){return this.entity.rtpExt}setRtpHeaderExtensions(g){this.entity.rtpExt=g}setSimulcastContext(g){this.simulcastContext=g}getSimulcastContext(){return this.simulcastContext}serialize(){return deepClone(this.entity)}},L_=class{constructor(g){this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.localSsrcs=new Map,this.ssrcGenerator=new dv,this.logger=g.logger.createChild("MM"),this.configProvider=g.configProvider,this.numVideoChannels=g.numVideoChannels}fromOffer(g,m){g.media.forEach((g=>{if(g.type===Ke.MEDIA_TYPE.audio)Ke.MODALITY.audio in m&&this.addMediaEntity(Ke.MODALITY.audio);else if(g.type===Ke.MEDIA_TYPE.video){if(Ke.MODALITY.video in m)for(let g=0;g<this.numVideoChannels;g++)this.addMediaEntity(Ke.MODALITY.video);Ke.MODALITY.sharing in m&&this.addMediaEntity(Ke.MODALITY.sharing)}else g.type===Ke.MEDIA_TYPE.data&&Ke.MODALITY.data in m&&this.addMediaEntity(Ke.MODALITY.data)}))}fromRemote(g,m){g.media.forEach(((g,S)=>{const v=getModality(g);if(isMediaDisabled(g)||!(v in m))this.mediaEntities[S]?this.mediaEntities[S].disable():this.addDisabledMediaEntity(v),this.mediaEntities[S].setRemoteStreamId(null),this.mediaEntities[S].setRemoteTrackId(null);else{if(this.mediaEntities[S]?this.mediaEntities[S].update(v,g.mid||this.generateMid(S)):this.addMediaEntity(v,g.mid||this.generateMid(S)),g.msid)this.mediaEntities[S].setRemoteStreamId(g.msid.split(" ")[0]),this.mediaEntities[S].setRemoteTrackId(g.msid.split(" ")[1]);else if(g.ssrcs){const m=g.ssrcs.find((g=>"msid"===g.attribute));m?(this.mediaEntities[S].setRemoteStreamId(m.value.split(" ")[0]),this.mediaEntities[S].setRemoteTrackId(m.value.split(" ")[1])):this.logger.safe.warn(`No ssrc msid for media of type ${g.type} with mid ${g.mid}`)}const m=g.xSourceStreamId||this.generateSourceStreamId(S);this.mediaEntities[S].setXSourceStreamId(m)}}))}isEmpty(){return 0===this.mediaEntities.length}addMediaEntity(g,m){this.createMediaEntity(g,m||this.generateMid(this.mediaEntities.length))}addDisabledMediaEntity(g){this.createMediaEntity(g)}getMediaEntities(){return this.mediaEntities}createMediaEntity(g,m){const S=k_.create(this.configProvider,g,m);return this.mediaEntities.push(S),S}getMediaEntity(g){return this.mediaEntities[g]}getMediaEntityByMid(g){return this.mediaEntities.find((m=>m.getMid()===g))}getMediaEntitiesByModality(g){return this.mediaEntities.filter((m=>m.getModality()===g))}getMediaEntityByRemoteStreamId(g){return this.mediaEntities.find((m=>m.getRemoteStreamId()===g))}getMediaEntityByLocalTrackId(g){return this.mediaEntities.find((m=>m.getLocalTrackId()===g))}getMediaEntityByXSourceStreamId(g){return this.mediaEntities.find((m=>m.getXSourceStreamId()===g))}reset(){this.mediaEntities=[]}syncModalities(g,m,S){this.disableModalities(m),S||(this.enableModalities(m),this.addModalities(m))}enableModalities(g){this.mediaEntities.forEach(((m,S)=>{m.getModality()in g&&m.isDisabled()&&m.update(m.getModality(),this.generateMid(S))}))}disableModalities(g){this.mediaEntities.forEach((m=>{m.getModality()in g||m.disable()}))}setRollbackUpdateHandler(g){}addModalities(g){const m={};this.mediaEntities.map((g=>g.getModality())).forEach((g=>{m[g]=!0}));for(const S in g)S in m||this.addMediaEntity(S)}setLocalTracksInfo(g){this.mediaTracks=g,this.updateLocalSsrc(this.mediaTracks)}getLocalTracksInfo(){return this.mediaTracks}getLocalSsrcs(){return this.localSsrcs}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((g=>g.setLocalTrackId(null))),this.mediaTracks.forEach((g=>{const m=this.getMediaEntitiesByModality(g.modality)[0];m?m.setLocalTrackId(g.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(g.modality)}`)})))}updateMediaEntitiesWithActivityState(g,m){}backup(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((g=>{this.mediaEntitiesBackup.push(g.clone())}))}commit(){this.mediaEntitiesBackup=[]}rollback(){this.mediaEntities=this.mediaEntitiesBackup}generateSourceStreamId(g){return g+10}generateMid(g){return`media_${g}`}updateLocalSsrc(g){g.forEach((g=>{if(!this.localSsrcs.get(g.modality)){const m=this.ssrcGenerator.nextVideoStreamSsrc().min;this.logger.safe.debug(`Ssrc updated for modality: ${g.modality}: ${m}`),this.localSsrcs.set(g.modality,m)}}))}},F_=__toESM(Me()),x_=class{constructor(g,m,S,v,C){this.logger=g,this.RtcDescType=m,this.sessionDescription=S,this.negotiationQueue=v,this.mediaManager=C}dispose(){this.peerConnection=null}configure(g){this.peerConnection=g}renegotiateNow(){return this.renegotiate(null,!0)}renegotiate(g,m=!1,S="local"){if(!this.peerConnection)throw new Error("trying to renegotiate during empty peerConnection");const v="local"===S?this.createNegotiationTaskForHaveLocalOffer(g):this.createNegotiationTaskForHaveRemoteOffer(g);return m?(this.logger.safe.info(`forced ${S} renegotiation starting`),Promise.resolve(v())):this.negotiationQueue.add(v)}normalizeRemoteSdpSDES(g,m){if(m.media[0].crypto)g.media.forEach((g=>{delete g.fingerprint,delete g.setup,g.crypto=g.crypto.filter((g=>m.media[0].crypto.some((m=>m.id===g.id)))).slice(0,1)})),g.fingerprint&&delete g.fingerprint;else{const m=this.mediaManager.getMediaEntities().find((g=>void 0!==g.getExtension("setup")));g.media.forEach((g=>{const S=m?.getExtension("setup")||"actpass";"actpass"===g.setup&&(g.setup="active"===S?"passive":"active")}))}}normalizeRemoteSdpExtensions(g,m){g.media.forEach(((g,S)=>{const v=new Set(m.media[S].ext?.map((g=>g.value))||[]);g.ext=g.ext?.filter((g=>v.has(g.value)))}))}throwIfNoPeerConnection(){if(!this.peerConnection)throw this.logger.safe.warn("no peer connection present"),new Error("trying to renegotiate during empty peerConnection")}createNegotiationTaskForHaveLocalOffer(g){return()=>{let m=this.peerConnection.remoteDescription.sdp;const S=this.peerConnection.localDescription.sdp;this.logger.safe.info(`local renegotiation starting remoteSdp=${!!m} localSdp=${!!S}`);const v=F_.parse(m),C=F_.parse(S);this.normalizeRemoteSdpSDES(v,C),this.normalizeRemoteSdpExtensions(v,C),m=F_.write(v);let _=new this.RtcDescType({sdp:m,type:"answer"});return g&&g.forEach((g=>{_=g.modifyDescriptor(_)})),Promise.resolve().then((()=>(this.logger.safe.info("creating offer"),this.throwIfNoPeerConnection(),this.peerConnection.createOffer()))).then((g=>{this.throwIfNoPeerConnection();const m=this.sessionDescription.createLocalOffer(g.sdp),S=new this.RtcDescType({sdp:m.toLocal(),type:"offer"});return this.logger.safe.info("setting local description"),this.logger.unsafe.debug(`local description, sdp: ${S.sdp}`),this.peerConnection.setLocalDescription(S)})).then((()=>(this.throwIfNoPeerConnection(),this.logger.safe.info("setting remote description"),this.logger.unsafe.debug(`remote description, sdp: ${_.sdp}`),this.peerConnection.setRemoteDescription(_)))).then((g=>(this.logger.safe.debug("local renegotiation done"),g))).catch((g=>{throw this.logger.safe.error("local renegotiation failed: ",g.toString()),g}))}}createNegotiationTaskForHaveRemoteOffer(g){return this.logger.safe.info("createNegotiationTaskForRemote"),()=>(this.logger.safe.info("proceed with setting local sdp start"),Promise.resolve().then((()=>(this.logger.safe.info("creating answer"),this.throwIfNoPeerConnection(),this.peerConnection.createAnswer()))).then((g=>{this.logger.safe.info("applying answer"),this.throwIfNoPeerConnection();const m=this.sessionDescription.createLocalAnswer(g.sdp),S=new this.RtcDescType({sdp:m.toLocal(),type:"answer"});return this.logger.safe.info("setting [answer] local description"),this.logger.unsafe.debug(`[answer] local description, sdp: ${S.sdp}`),this.peerConnection.setLocalDescription(S)})).then((g=>(this.logger.safe.info("local answer for renegotiation is done"),g))).catch((g=>{throw this.logger.safe.error("local answer for renegotiation failed: ",g.toString()),g})))}},U_=15e3,V_=5e3,B_=class{constructor(g,m,S,v){this.settings=g,this.listener=m,this.statsGatherer=S,this.logger=v,this.lastSendBW=0,this.coolingDown=!1,this.cooldownTimer=null,this.cooldownEnd=0,this.active=!1,this.maxResolution=this.settings.maxResolution,this.settings.scalingEnabled?(this.active=!0,this.statsSubscription=this.statsGatherer.on("onStatisticsChanged",(g=>this.onStatisticsChanged(g)))):this.logger.safe.info("Resolution management disabled: no resolution management for 1x1 calls")}dispose(){this.currentResolution=null,this.pendingResolution=null,this.maxResolution=null,this.listener=null,this.active=!1,clearTimeout(this.cooldownTimer),this.cooldownTimer=null,this.statsSubscription&&(this.statsSubscription.dispose(),this.statsSubscription=null),this.statsGatherer=null,this.listener=null}setMaxResolution(g){const m=Lp.Send.getResolutionByFs(g);m!==this.maxResolution&&(this.logger.safe.info(`Setting max resolution: ${m}`),this.maxResolution=m,this.lastSendBW&&this.processEstimatedBandwidth(this.lastSendBW))}resetCurrentResolution(){this.currentResolution=null}getCurrentResolution(){return this.currentResolution?.fs}setCurrentResolution(g){this.currentResolution=g}applyRes(g){this.pendingResolution=g,this.coolingDown&&(!this.currentResolution||g.fs>this.currentResolution.fs)||(this.coolingDown=!0,this.logger.safe.info(`Changing resolution to ${g}`),this.listener&&this.listener.onResolutionChanged(g.fs).then((m=>{m?(g===this.pendingResolution&&(this.pendingResolution=null),this.coolingDown&&!this.currentResolution&&(this.coolingDown=!1),this.currentResolution=g,this.cooldown()):(this.logger.safe.info("Unable to apply resolution at the moment"),this.cooldown(V_))})).catch((g=>{this.logger.safe.error(`Error while applying new resolution: ${JSON.stringify(g)}`),this.pendingResolution=null})))}cooldown(g=U_){!this.active||this.coolingDown&&this.cooldownEnd-Date.now()>U_||(this.cooldownTimer&&clearTimeout(this.cooldownTimer),this.coolingDown=!0,this.cooldownEnd=Date.now()+U_,this.cooldownTimer=setTimeout((()=>{this.logger.safe.debug("Resolution changer cooled down"),this.coolingDown=!1,this.cooldownTimer=null,this.pendingResolution?this.proposeResolution(this.pendingResolution):this.processEstimatedBandwidth(this.lastSendBW)}),g))}proposeResolution(g){let m=g;this.maxResolution&&this.maxResolution.fs<m.fs&&(m=this.maxResolution),this.currentResolution&&m.fs===this.currentResolution.fs||this.applyRes(m)}processEstimatedBandwidth(g){const{lowRes:m,highRes:S}=Lp.Send.getResolutionForBitrate(g),v=g<this.lastSendBW?S:m;g<this.lastSendBW&&v&&this.currentResolution&&this.currentResolution.fs<v.fs||(v&&this.proposeResolution(v),this.lastSendBW=g)}onStatisticsChanged(g){const m=g.estimatedSendBandwidth;m!==this.lastSendBW&&(this.logger.safe.debug(`Send BW: ${m}`),this.processEstimatedBandwidth(m))}},H_=class{constructor(g,m,S,v,C,_,E){this.listener=g,this.statisticsGatherer=m,this.diagnostics=S,this.logger=v,this.configProvider=C,this.isSimulcastEnabled=E,this.serialQueue=new Ap(this.logger),this.modality=Ke.MODALITY.video;const T=_.maxResolution?{maxFs:_.maxResolution.fs}:null;this.validator=new Gp(this.logger.createChild("CapsValidator"),T),this.resolutionManager=new B_(_,this,this.statisticsGatherer,this.logger.createChild("rm"))}async setMaxCapabilities(g,m){const S={modality:this.modality,causeId:g,capabilities:m,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(S),this.diagnostics?.onMaxCapabilitiesRequested(S),this.causeId=g;const v=this.validator.ensureValidity(m[0]);this.streamSenderParams={...m[0],...v},this.resolutionManager.setMaxResolution(this.streamSenderParams.maxFs),this.configProvider.mediaConfig.simulcastSessionEnabled&&await this.applyCapabilities(this.getParamsToApply())}resetCurrentResolution(){this.resolutionManager.resetCurrentResolution()}getCurrentResolution(){return this.resolutionManager.getCurrentResolution()}setCurrentResolution(g){this.resolutionManager.setCurrentResolution(g)}async onResolutionChanged(g){return this.applyCapabilities(this.getParamsToApply(g))}dispose(){this.resolutionManager.dispose(),this.resolutionManager=null}async applyCapabilities(g){return g?this.lastAppliedSenderParams===g?(this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}`),!0):(this.logger.safe.info(`Capabilities to apply: ${JSON.stringify(g)}`),this.lastAppliedSenderParams=g,this.listener.onReceiveCapabilitiesChanged(this.modality,this.causeId,[g])):(this.logger.safe.error("Send capabilities are not set. Cannot apply constraints"),!1)}getParamsToApply(g){if(!this.streamSenderParams)return null;const m=g||this.resolutionManager.getCurrentResolution();if(!m||this.streamSenderParams.maxFs<=m)return this.streamSenderParams;const S=shallowClone(this.streamSenderParams);return S.maxFs=m,S}};__decorateClass([sequentialize()],H_.prototype,"applyCapabilities",1);var $_=class{constructor(g,m,S,v,C){this.modality=g,this.listener=m,this.statisticsGatherer=S,this.diagnostics=v,this.isSimulcastEnabled=C}setMaxCapabilities(g,m){const S={modality:this.modality,causeId:g,capabilities:m,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(S),this.diagnostics?.onMaxCapabilitiesRequested(S),this.listener.onReceiveCapabilitiesChanged(this.modality,g,m)}dispose(){}resetCurrentResolution(){}getCurrentResolution(){return null}setCurrentResolution(g){}},G_=class extends je{constructor(g,m,S){super(S),this.configProvider=g,this.statsGatherer=m,this.logger=S,this.lastReportedAgo=1/0,this._forceUpdate=!1,this.subs=this.statsGatherer.on("onStatisticsChanged",(g=>this.onStatisticsChanged(g)))}forceUpdate(){this._forceUpdate=!0}dispose(){this.subs.dispose(),this.subs=null}onStatisticsChanged(g){this._forceUpdate?this.updateBandwidth(g.estimatedSendBandwidth,"forceUpdate"):this.processEstimatedBandwidth(g.estimatedSendBandwidth)}processEstimatedBandwidth(g){if(this.lastReportedAgo++,!g||this.bandwidth===g)return;const m=this.configProvider.config.webrtcSendBandwidthIgnoredUpdateLimit,S=this.configProvider.config.webrtcSendBandwidthThreshold,v=this.lastReportedAgo===1/0,C=!m&&!S,_=m&&this.lastReportedAgo>=m,E=S&&Math.abs((g-this.bandwidth)/this.bandwidth)>=S;if(v||C||_||E){const m=+v|+C<<1|+_<<2|+E<<3,S=this.getUpdateReason(m);this.updateBandwidth(g,S)}}updateBandwidth(g,m){this.bandwidth=g,this.logger.safe.debug(`Updating send bandwidth: ${this.bandwidth}, reason: ${m}`),this.notifySendBandwidthChanged()}notifySendBandwidthChanged(){this._forceUpdate=!1,this.event("onSendBandwidthChanged").raise(this.bandwidth),this.lastReportedAgo=0}getUpdateReason(g){return 1&g?"firstReport":2&g?"throttlingDisabled":4&g?"noReportsForTooLong":8&g?"bigMovement":"none"}},j_=class{constructor(g,m,S,v,C,_){this.logger=g,this.settings=m,this.listener=S,this.statsGatherer=v,this.diagnostics=C,this.configProvider=_,this.mediaSourceModels=[],this.pendingCapabilities=new Map}dispose(){this.mediaSourceModels.forEach((g=>{g.handler&&(g.handler.dispose(),g.handler=null)})),this.mediaSourceModels=null,this.sendBandwidthCalculator&&this.disableSendBandwidthCalculator()}updateRegisteredSources(g){this.logger.safe.info(`Local media params updated: ${JSON.stringify(g)}`);const m=[];this.mediaSourceModels.forEach((g=>m.push(g.sourceId)));const S=g.map((g=>g.sourceId)),v=subtractFrom(m,S);this.removeSourcesWithIds(v);const C=subtractFrom(S,m);this.addSourcesWithIds(C,g),this.settings.sendBandwidthNotificationsEnabled&&this.updateSendBandwidthCalculator()}setMaxCapabilities(g){for(const m of g){if(!m.capabilities.length)continue;if(!m.sourceId){this.logger.safe.info(`SourceId is not defined to apply recv capabilities: ${JSON.stringify(m)}`);continue}const g=this.getModelWithSourceId(m.sourceId);if(!g){this.logger.safe.info(`Model is not registered for sourceId: ${m.sourceId}`),this.configProvider.config.enableCachingFMTP&&this.pendingCapabilities.set(m.sourceId,m);continue}this.logger.safe.info(`Capabilities handler found for sourceId: ${m.sourceId}`);const S=this.getOrCreateHandlerForModel(g,m.isSimulcast);S?S.setMaxCapabilities(m.causeId,m.capabilities):this.logger.safe.info(`Handler is not found for sourceId: ${m.sourceId}`)}this.logger.safe.debug("Max capabilities application completed")}setPendingCapabilities(){if(!this.configProvider.config.enableCachingFMTP)return;this.logger.safe.info(`Apply pending capabilties for sources [${Array.from(this.pendingCapabilities.keys())}]`);const g=Array.from(this.pendingCapabilities.values());this.setMaxCapabilities(g),this.pendingCapabilities.clear()}clearPendingCapabilities(){this.pendingCapabilities.clear()}resetCurrentResolution(){const g=this.mediaSourceModels.find((g=>g.modality===Ke.MODALITY.video));g?.handler&&g.handler.resetCurrentResolution()}getCurrentResolution(){const g=this.mediaSourceModels.find((g=>g.modality===Ke.MODALITY.video));return g?.handler?g.handler.getCurrentResolution():this.currentResolution?.fs}setCurrentResolution(g){const m=this.mediaSourceModels.find((g=>g.modality===Ke.MODALITY.video));m?.handler?m.handler.setCurrentResolution(g):this.currentResolution=g}getOrCreateHandlerForModel(g,m){return g.handler||(g.handler=this.getCapabilitiesHandler(g.modality,m)),g.handler}addSourcesWithIds(g,m){g.forEach((g=>{const S=m.find((m=>m.sourceId===g));this.registerSource(g,S.modality)}))}removeSourcesWithIds(g){g.forEach((g=>this.unregisterSource(g)))}registerSource(g,m){this.logger.safe.info(`SourceId ${g} registered with mediaType: ${m}`),this.mediaSourceModels.push({modality:m,sourceId:g})}unregisterSource(g){const m=this.mediaSourceModels.find((m=>m.sourceId===g));m?(m.handler&&m.handler.dispose(),this.mediaSourceModels.splice(this.mediaSourceModels.indexOf(m),1),this.logger.safe.info(`SourceId ${g} unregistered`)):this.logger.safe.info(`Model doesn't exist with sourceId ${g}`)}updateSendBandwidthCalculator(){this.mediaSourceModels.some((g=>[Ke.MODALITY.video,Ke.MODALITY.sharing].indexOf(g.modality)>-1))?this.enableSendBandwidthCalculator():this.disableSendBandwidthCalculator()}enableSendBandwidthCalculator(){this.sendBandwidthCalculator||(this.sendBandwidthCalculator=new G_(this.configProvider,this.statsGatherer,this.logger.createChild("SendBwCalc")),this.sendBandwidthCalculatorSubscription=this.sendBandwidthCalculator.on("onSendBandwidthChanged",(g=>this.onSendBandwidthChanged(g))))}disableSendBandwidthCalculator(){this.sendBandwidthCalculatorSubscription&&(this.sendBandwidthCalculatorSubscription.dispose(),this.sendBandwidthCalculatorSubscription=null),this.sendBandwidthCalculator&&(this.sendBandwidthCalculator.dispose(),this.sendBandwidthCalculator=null)}getModelWithSourceId(g){return this.mediaSourceModels.find((m=>m.sourceId===g))}getCapabilitiesHandler(g,m){if(g===Ke.MODALITY.audio)return null;if(g===Ke.MODALITY.video&&!m&&this.settings.customBwEstimationEnabled){const g=new H_(this.listener,this.statsGatherer,this.diagnostics,this.logger.createChild("ach"),this.configProvider,this.settings,m);return this.currentResolution&&g.setCurrentResolution(this.currentResolution),g}return new $_(g,this.listener,this.statsGatherer,this.diagnostics,m)}onSendBandwidthChanged(g){return this.listener.onSendBandwidthChanged(g).catch((g=>{this.logger.safe.error("Error while reporting send bandwidth change",g),this.sendBandwidthCalculator.forceUpdate()}))}},q_=class extends je{constructor(g,m,S,v,C,_){super(g),this.logger=g,this.multiParty=m,this.configProvider=S,this.mediaManager=v,this.statsGatherer=C,this.diagnostics=_,this.rendererResolutions=new Map,this.rendererResolutionsApplied=new Map,this.rendererResolutionMax=new Map,this.hasPendingLimitResolutionUpdate=!1}addRenderer(g){this.rendererResolutions.set(g,{width:0,height:0}),g.on("onRendererSizeChanged",((g,m)=>{this.onRendererSizeChanged(g,m)})),this.scheduleUpdateLimitedResolutions()}removeRenderer(g){this.rendererResolutions.delete(g),this.rendererResolutionsApplied.delete(g),this.rendererResolutionMax.delete(g),this.scheduleUpdateLimitedResolutions()}clearRenderers(){this.rendererResolutions.clear(),this.rendererResolutionsApplied.clear(),this.rendererResolutionMax.clear()}getMaxAllowedVideoFS(){const g=this.getMaxHeightFromConfig(this.renderersCount);return this.getMaxFSForHeight(g)}limitResolutionOnPoorPerformance(g){const m=this.getRendererByMsi(g);if(!m)return;const S=m.resolution.height>m.resolution.width,v=Lp.Recv.getNextLowerResolution(m.resolution.width,m.resolution.height);if(!v)return void this.logger.safe.info("Poor perf. Lowest resolution reached. Not limiting resolution");const C={width:S?v.height:v.width,height:S?v.width:v.height};this.rendererResolutionMax.set(m.renderer,C),this.diagnostics?.registerResolutionChanageRequest({ts:Date.now(),msi:m.renderer.getMsi(),res:C}),this.logger.safe.info(`Poor perf. Limiting resolution for renderer msi: ${m.renderer.getMsi()} from ${m.resolution.height}p to ${C.height}p`),this.onRendererSizeChanged(m.renderer,C)}get renderersCount(){return this.rendererResolutions.size}getMaxFSForHeight(g){return this.limitMaxFS(Lp.Recv.getResolutionForHeight(g).fs)}getRendererByMsi(g){for(const[m,S]of this.rendererResolutions.entries())if(m.getMsi()===g)return{renderer:m,resolution:S};return null}applyRendererResolution(g,m){this.setMaxFSCapabilities(g,m),this.rendererResolutionsApplied.set(g,m);const S=g.getMediaStream()&&g.getMediaStream().getVideoTracks();S?.[0]&&this.statsGatherer.setPreferredResolution(S[0].id,m,g.getModality())}onRendererSizeChanged(g,m){this.rendererResolutions.set(g,m),this.scheduleUpdateLimitedResolutions()}scheduleUpdateLimitedResolutions(){this.hasPendingLimitResolutionUpdate||(this.hasPendingLimitResolutionUpdate=!0,window.setTimeout((()=>{this.hasPendingLimitResolutionUpdate=!1;const g=this.groupMaxRenderersResolutionsByMsi();this.logger.safe.info(`Updating resolution limits: renderers count ${this.renderersCount}`),this.spotlightedRenderer=this.findSpotlightedRenderer(),this.spotlightedRenderer&&this.logger.safe.info(`Spotlighted renderer: ${this.spotlightedRenderer.getMsi()}`);for(const[m,S]of this.rendererResolutions.entries()){if(!S.height)continue;const v=g.get(m.getMsi()),C=this.limitRendererResolution(m,v||S),_=this.rendererResolutionsApplied.get(m);(!_||_.height!==C.height||_.width!==C.width)&&this.applyRendererResolution(m,C)}}),this.configProvider.config.multiviewResolutionLimitUpdateThrottleDelay))}findSpotlightedRenderer(){if(1===this.renderersCount||!this.configProvider.config.isSpotlightEnabled)return;let g,m=0,S=0;for(const[v,C]of this.rendererResolutions.entries()){if(!C.height)continue;S++;const _=Lp.Recv.getMaxFS(C.width,C.height);_>m?(g=v,m=_):_===m&&(g=void 0)}return S<=1?void 0:g}getMaxHeightFromConfig(g,m=!1){return m?this.configProvider.config.maxSpotlightResolution:this.configProvider.config.multiviewResolutionLimits[`${g}`]||this.configProvider.config.multiviewResolutionLimits.more}getMaxHeight(g){const m=this.spotlightedRenderer?.getMsi()===g.getMsi();let S=this.getMaxHeightFromConfig(this.renderersCount,m);const v=this.rendererResolutionMax.get(g);return v&&(S=Math.min(S,Math.min(v.height,v.width))),S}limitRendererResolution(g,m){const S=this.getMaxHeight(g);if(!S)return m;if(m.height>m.width&&m.width>S){const g=S/m.width;return{height:Math.ceil(m.height*g),width:S,limited:!0}}if(m.width>m.height&&m.height>S){const g=S/m.height;return{height:S,width:Math.ceil(m.width*g),limited:!0}}return m}setMaxFSCapabilities(g,m){const S=g.getMediaStream();if(!S)return void this.logger.safe.warn("renderer has no stream attached");const v=this.mediaManager.getMediaEntityByRemoteStreamId(S.id);if(!v?.getLocalRecvCapabilities())return void this.logger.safe.warn(`no capabilities for provided modality: ${g.getModality()}`);const C=m.limited?this.getMaxFSForHeight(m.height):this.getMaxFS(m.width,m.height),_=v.getLocalRecvCapabilities();_.setMaxFS(C,(()=>{if(this.logger.safe.info(`updated max-fs video capability to ${C} for renderer msi: ${g.getMsi()}`),this.multiParty&&this.configProvider.config.webrtcMultiPartyRecvVideoSignaling){const m=g.getMsi(),S=Number(v.getXSourceStreamId()),C=_.buildFmtp();this.event("onSourceRequestRequired").raise(v.getModality(),S,m,C,v.getSubstreamIndex())}else this.event("onNegotiationRequired").raise()}))}getMaxFS(g,m){return this.limitMaxFS(Lp.Recv.getMaxFS(g,m))}limitMaxFS(g){return this.multiParty?Math.min(g,this.configProvider.config.webrtcMultiPartyRecvVideoMaxFS):Math.min(g,this.configProvider.config.webrtcRecvVideoMaxFS)}groupMaxRenderersResolutionsByMsi(){const g=new Map;return this.rendererResolutions.forEach(((m,S)=>{const v=S.getMsi(),C=g.get(v);(!C||m.width>C.width&&m.height>C.height)&&g.set(v,m)})),g}},W_=class extends je{constructor(g,m){super(),this.configProvider=g,this.getModality=m,this.isRendering=!1,this.currentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0}captureRawStatistics(g){const m=g.googFrameRateDecoded,S=g.googFrameRateReceived,v=g.bytesReceived;void 0!==v&&this.getModality()!==Ke.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateBitrate(v,m),m>0&&(this.mediaStarted=!0),0===m||0===S?this.currentFreezeDuration+=Ke.TIME_INTERVAL.SEC_1:m>0&&(void 0===S||S>0)&&(this.currentFreezeDuration=0);const C=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(C)}updateRenderingTracker(g){const m=g.extensions.frameRateDecoded||0,S=g.extensions.frameRateReceived||0,v=g.extensions.bitrate;void 0!==v&&this.getModality()!==Ke.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateLowBitrateDuration(v,m),m>0&&(this.mediaStarted=!0),0===m||0===S?this.currentFreezeDuration+=Ke.TIME_INTERVAL.SEC_1:m>0&&(void 0===S||S>0)&&(this.currentFreezeDuration=0);const C=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(C)}calculateLowBitrateDuration(g,m){g/1e3<this.configProvider.config.notRenderingLowBitrateThreshold&&m<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}calculateBitrate(g,m){const S=8*(g-this.lastBytesRecv);this.lastBytesRecv=g,this.calculateLowBitrateDuration(S,m)}setIsRendering(g){const m=this.currentFreezeDuration<g&&this.currentLowBitrateDuration<g&&this.mediaStarted;m!==this.isRendering&&(this.isRendering=m,this.event("onIsRenderingChanged").raise(this.isRendering))}},z_=class extends je{constructor(g,m,S){super(),this.videoElement=g,this.configProvider=m,this.getTimeToFirstFrame=S,this.prevCurrentTime=0,this.prevDecodedFrameCount=0,this.prevTimestamp=Date.now(),this.currentFreezeDuration=0,this.freezeDurationTimer=window.setInterval((()=>{this.calcFreezeDurationMs()}),this.configProvider.config.freezeIntervalFrequency)}calcFreezeDurationMs(){const g=this.videoElement.currentTime,m=g===this.prevCurrentTime,S=this.videoElement.webkitDecodedFrameCount,v=void 0===S||S===this.prevDecodedFrameCount;this.prevCurrentTime=g,this.prevDecodedFrameCount=S;if(-1!==this.getTimeToFirstFrame())if(m&&v){const g=Date.now();this.currentFreezeDuration+=g-this.prevTimestamp,this.prevTimestamp=g}else{if(this.currentFreezeDuration>this.configProvider.config.freezeMinDuration){const g=this.calcFreeze();this.event("onFreezeEnded").raise(g)}this.currentFreezeDuration=0}this.prevTimestamp=Date.now()}getEndOfTheFreeze(){let g=0;return this.currentFreezeDuration>0&&(g=this.calcFreeze(),this.currentFreezeDuration=0),g}dispose(){const g=this.getEndOfTheFreeze();this.event("onFreezeEnded").raise(g),clearInterval(this.freezeDurationTimer)}calcFreeze(){const g=Date.now()-this.prevTimestamp;return this.currentFreezeDuration+g}},K_=class extends Op{constructor(g,m,S,v,C,_){super(C,g.createChild("remote"),m),this.diagnostics=S,this.subscriptionManager=v,this.sessionDiagnostics=_,this.disposed=!1,this.currentIsRendering=!1,this.startTimeTTFF=0,this.timeToFirstFrame=-1,this.isTimeToFirstFrameReported=!1,this.configProvider.config.freezeIntervalFrequency&&(this.freezeTracker=new z_(this.getVideoElement(),this.configProvider,(()=>this.timeToFirstFrame)),this.freezeTracker.on("onFreezeEnded",(g=>{this.diagnostics?.addFreezeDuration(g),this.event("onFreezeEnded").raise(g)}))),this.configProvider.config.isRenderingBasedOnRawStatistics&&(this.isRenderingTracker=new W_(this.configProvider,this.getModality.bind(this)),this.isRenderingChangedSubscription=this.isRenderingTracker.on("onIsRenderingChanged",(g=>{this.setIsRendering(g)}))),this.overlayStats=new Mp(this.configProvider.config.showStatsInCall,C,this)}getEndOfTheFreeze(){return this.freezeTracker?.getEndOfTheFreeze()}resetTimeToFirstFrameFlag(){this.isTimeToFirstFrameReported=!1}setIsRendering(g){this.currentIsRendering!==g&&(this.currentIsRendering=g,this.captureIsRenderingEvent(g))}captureRawStatistics(g){this.configProvider.config.isRenderingBasedOnRawStatistics&&this.isRenderingTracker?.captureRawStatistics(g)}updateStatsOverlay(g){this.overlayStats.setStats(g)}updateIsRenderingTracker(g){this.isRenderingTracker?.updateRenderingTracker(g)}subscribeVideoAsync(g,m){return this.timeToFirstFrameSinceSubscriptionStart=Date.now(),new Promise(((S,v)=>{this.modality=m?Ke.MODALITY.sharing:Ke.MODALITY.video,this.diagnostics&&(this.diagnostics.msi=g,this.diagnostics.modality=this.modality),this.trackElementSizeChange(),this.unsubscribe(),this.sessionDiagnostics&&this.modality===Ke.MODALITY.video&&(this.on("onVideoSizeChanged",((m,S)=>{if(this.sessionDiagnostics.registerResolutionChanageEvent({ts:Date.now(),msi:g,res:{width:m,height:S}}),!this.isTimeToFirstFrameReported){if(-1===this.timeToFirstFrame){const g=Date.now();this.timeToFirstFrame=g-this.startTimeTTFF,this.timeToFirstFrameSinceSubscriptionStart=Date.now()-this.timeToFirstFrameSinceSubscriptionStart}const g=this.getTrackId();g&&(this.diagnostics.timeToFirstFrameSinceSubscriptionStart=this.timeToFirstFrameSinceSubscriptionStart,this.diagnostics.timeToFirstFrame=this.timeToFirstFrame,this.sizeTracker?.triggerVideoElementSizeChange(),this.event("onVideoStarted").raise(this.timeToFirstFrame,this.timeToFirstFrameSinceSubscriptionStart,g),this.isTimeToFirstFrameReported=!0)}})),this.on("onVideoRendererStateChanged",(g=>{this.diagnostics.addStateChange(g)})));const C=this.subscriptionManager.subscribeVideo(this.modality,g);this.subscription=C,this.logger.safe.info(`subscribing renderer to type: ${C.modality} msi: ${C.msi}`),C.setOnMediaStreamChangedHandler((g=>{const m=this.getMediaStream();this.attachMediaStream(g),g&&(this.startTimeTTFF=Date.now());const v=this.getTrackId();v&&this.diagnostics&&(this.diagnostics.trackId=v),this.logger.safe.info(`subscribed renderer to type: ${C.modality} msi: ${C.msi} on stream #${g?g.id:"none"}`),g&&m!==g&&this.sizeTracker?.triggerVideoElementSizeChange(),S()})),C.setOnErrorHandler((m=>{this.logger.safe.error(`failed to subscribe renderer ${stringifyObject(m)}`),"webRtcSession cleanup"===JSON.stringify(m)&&(this.logger.safe.info(`Retry to subscribe to video stream with msi: ${g}. Previous session was cleaned up`),this.subscriptionManager.streamChangedByMsi(g),S()),v(m)}))}))}dispose(){this.disposed?this.logger.safe.warn("renderer already disposed"):(this.disposed=!0,this.logger.safe.info("disposing"),this.unsubscribe(),this.captureIsRenderingEvent(!1),this.freezeTracker?.dispose(),this.isRenderingChangedSubscription?.dispose(),this.overlayStats.dispose(),this.diagnostics?.dispose(),this.event("onRendererDisposed").raise(this),super.dispose())}getModality(){return this.modality}getMsi(){return this.subscription?.msi??hv.SourceNone}getLocalMsi(){return this.subscription?.localMsi}getCurrentResolution(){return this.resolution??{width:0,height:0}}unsubscribeNow(){this.subscription?.unsubscribe(),this.subscription=null}trackElementSizeChange(){const g=this.modality===Ke.MODALITY.sharing,m=g?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMin:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,S=g?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMax:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax;m&&S?(this.sizeTracker=new Fp(this.getVideoElement(),m,S,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged()))):this.logger.safe.info("skipping video size tracking")}onSizeTrackerChanged(){this.resolution={width:this.sizeTracker.width,height:this.sizeTracker.height},this.logger.safe.info(`video renderer size changed to ${this.resolution.width}x${this.resolution.height}`),this.diagnostics&&(this.diagnostics.rendererSize=this.resolution),this.event("onRendererSizeChanged").raise(this,this.resolution)}unsubscribe(){this.subscription?.dispose(),this.subscription=null}captureIsRenderingEvent(g){this.diagnostics&&(this.diagnostics.isRendering=g),this.event("onIsRenderingChanged").raise(g,this.getModality(),this.getTrackId())}},J_=class{constructor(g,m,S,v,C,_){this.logger=g,this.configProvider=m,this.statsGatherer=S,this.sessionDiagnostics=v,this.remoteVideoResolutionManager=C,this.domOverrides=_,this.remoteRendererSubscriptions=new Map,this.statSubs=[],this.diagnostics=v?.newRemoteVideoManagerDiagnostics(),this.subscribeToStatisticsChanged()}createRenderer(g,m,S){const v=new K_((S??this.logger).createChild("videorenderer"),this.configProvider,this.diagnostics?.newRendererDiagnostics(),m,g,this.sessionDiagnostics);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(v.getVideoElement()),this.addRenderer(v),v}moveRenderers(g){this.renderers.forEach((m=>{m.resetTimeToFirstFrameFlag(),g.addRenderer(m),this.removeRenderer(m)}))}getMaxAllowedVideoFS(){return this.remoteVideoResolutionManager.getMaxAllowedVideoFS()}dispose(){this.renderers.forEach((g=>g.resetTimeToFirstFrameFlag())),this.renderers.forEach((g=>{const m=g.getTrackId(),S=g.getEndOfTheFreeze();this.statsGatherer.setFreezeDuration(S,m)})),this.remoteRendererSubscriptions.forEach(((g,m)=>{m.dispose(),g.forEach((g=>g.dispose()))})),this.remoteRendererSubscriptions.clear(),this.remoteVideoResolutionManager.clearRenderers(),this.statSubs.forEach((g=>g.dispose()))}get renderers(){return Array.from(this.remoteRendererSubscriptions,(([g])=>g))}addRenderer(g){this.remoteRendererSubscriptions.set(g,this.subscribeOnEvents(g)),this.logger.safe.info("Added renderer to manager"),this.remoteVideoResolutionManager.addRenderer(g)}subscribeToStatisticsChanged(){this.configProvider.config.isRenderingBasedOnRawStatistics?this.configProvider.config.diagnostics.sideBySide&&this.configProvider.config.isRenderingBasedOnRawStatistics?this.statSubs.push(this.statsGatherer.on("onDiagnosticUpdated",(g=>this.onDiagnosticUpdated(g)))):this.statSubs.push(this.statsGatherer.on("onRawStatisticsChanged",(g=>this.processRawStats(g)))):this.statSubs.push(this.statsGatherer.on("onStatisticsChanged",(g=>this.processStats(g)))),this.statSubs.push(this.statsGatherer.on("onDiagnosticUpdated",(g=>this.updateOverlayStats(g))))}generateSSRCStats(g){const m=new Map;return forOwn(g.ssrc,(g=>{m.set(g[h_],g)})),m}generateVideoRecvStats(g){const m=new Map,processRecvStats=g=>{g?.forEach((g=>{const S=g.track?.trackIdentifier??g.inboundRTP.trackIdentifier;m.set(S,g)}))};return processRecvStats(g.sharing?.recv),processRecvStats(g.video?.recv),m}updateOverlayStats(g){const m=this.generateVideoRecvStats(g);this.renderers.forEach((g=>{const S=g.getTrackId();m.has(S)&&g.updateStatsOverlay(m.get(S))}))}processStats(g){this.renderers.forEach((m=>{const S=m.getTrackId();if(g.remoteVideoStreams[S]){const v=g.remoteVideoStreams[S].isRendering;void 0!==v&&m.setIsRendering(v)}}))}onDiagnosticUpdated(g){const m=[...g.video?.recv??[],...g.sharing?.recv??[]];if(m.length){const g=new Map;m.forEach((m=>{g.set(m.track?.trackIdentifier,m)})),this.renderers.forEach((m=>{const S=m.getTrackId();g.has(S)&&m.updateIsRenderingTracker(g.get(S))}))}}processRawStats(g){const m=this.generateSSRCStats(g);this.renderers.forEach((g=>{const S=g.getTrackId();m.has(S)&&g.captureRawStatistics(m.get(S))}))}subscribeOnEvents(g){return[g.on("onRendererDisposed",(g=>this.onRendererDisposed(g))),g.on("onVideoStarted",((g,m,S)=>this.onVideoStarted(g,m,S))),g.on("onFreezeEnded",(m=>{const S=g.getTrackId();this.statsGatherer.setFreezeDuration(m,S)})),g.on("onIsRenderingChanged",((g,m,S)=>this.statsGatherer.setIsRendering(g,m,S)))]}onRendererDisposed(g){this.logger.safe.debug("Renderer removed from manager"),this.removeRenderer(g),this.domOverrides.onMediaElementRemoved&&this.domOverrides.onMediaElementRemoved(g.getVideoElement())}removeRenderer(g){this.remoteRendererSubscriptions.get(g).forEach((g=>g.dispose())),this.remoteRendererSubscriptions.delete(g),this.remoteVideoResolutionManager.removeRenderer(g)}onVideoStarted(g,m,S){this.statsGatherer.setTimeToFirstFrame(g,m,S)}},Y_=class extends je{constructor(g,m,S,v){super(),this.statisticsGatherer=g,this.configProvider=S,this.callDevicemanager=v,this.statisticsGathererSubscription=null,this.lastFramerateInput=-1,this.trackInfo=[],this.timeoutId=null,this.logger=m.createChild("localStreamWatcher"),this.callDeviceManagerSub=v.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, updating sunscriptions"),this.handleDeviceManagerChange()}))}get effectsManager(){return this.callDevicemanager.getDeviceManager("Video").effectsManager}startWatching(g){this.trackInfo=g,this.configProvider.config.videoCaptureFreezeTimeout&&(this.statisticsGathererSubscription||(this.statisticsGathererSubscription=this.statisticsGatherer.on("onStatisticsChanged",(g=>this.onStatisticsChanged(g)))),this.videoEffectManagerSubscription||(this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(g=>this.onVideoFreezeDetected(g)))))}stopWatching(){this.trackInfo=[],this.statisticsGathererSubscription&&(this.statisticsGathererSubscription.dispose(),this.statisticsGathererSubscription=null),this.videoEffectManagerSubscription&&(this.videoEffectManagerSubscription.dispose(),this.videoEffectManagerSubscription=null),0!==this.lastFramerateInput||this.timeoutId||this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")),this.disposeTimer(),this.lastFramerateInput=-1}dispose(g){this.callDeviceManagerSub?.dispose(),super.dispose(g),this.stopWatching()}onStatisticsChanged(g){if(!this.trackInfo.length)return;let m;Object.keys(g.localVideoStreams).forEach((S=>{const v=g.localVideoStreams[S];this.trackInfo.some((g=>g.trackId===v.trackId))&&(!m||m.frameRateInput<v.frameRateInput)&&(m=v)})),m?m.frameRateInput!==this.lastFramerateInput&&(0===m.frameRateInput?this.scheduleCaptureFreezeStart(m.trackId,!this.effectsManager.isEffectEnabled("Video")):0===this.lastFramerateInput&&(this.timeoutId?this.disposeTimer():(this.logger.info(`onVideoCaptureFreeze end for trackId: ${m.trackId}`),this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")))),this.lastFramerateInput=m.frameRateInput):this.logger.safe.warn("WebRTC Stats for send video not found")}onVideoFreezeDetected(g){this.logger.info(`onVideoCaptureFreeze, webcam freeze detected trackId: ${g}`),this.event("onVideoCaptureFreeze").raise(!1,!0)}scheduleCaptureFreezeStart(g,m){this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,this.logger.info(`onVideoCaptureFreeze start for trackId: ${g}`),this.event("onVideoCaptureFreeze").raise(!0,m)}),this.configProvider.config.videoCaptureFreezeTimeout)}disposeTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handleDeviceManagerChange(){this.videoEffectManagerSubscription?.dispose(),this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(g=>this.onVideoFreezeDetected(g)))}},Q_=class{constructor(g,m,S,v,C,_,E){this.mediaStream=g,this.receiver=m,this.modality=S,this.sourceStreamId=v,this.controller=C,this.videoCapabilties=_,this.getMaxAllowedVideoFS=E,this.msi=hv.SourceNone,this.operations=Promise.resolve()}dispose(){this.receiver=null,this.mediaStream=null}getId(){return this.mediaStream.id}getModality(){return this.modality}getMsi(){return this.msi}getMediaStream(){return this.mediaStream}getReceiver(){return this.receiver}getSourceStreamId(){return this.sourceStreamId}requestSource(g){this.msi=g;const m=this.operations.then((()=>{let m;return this.videoCapabilties&&(this.videoCapabilties.resetToInitial(),this.getMaxAllowedVideoFS&&this.videoCapabilties.setMaxFS(Math.min(this.getMaxAllowedVideoFS(),this.videoCapabilties.getMaxFS())),m=this.videoCapabilties.buildFmtp(),this.videoCapabilties.resetToInitial()),this.controller.requestSource(this.modality,this.sourceStreamId,g,m)}));return this.operations=m.catch((()=>{})),m}},X_=class{constructor(g){this.queue=[],this.logger=g}cleanup(){this.queue.forEach((g=>{g.reject({notSent:g.tones})})),this.queue=[]}waitForNotification(g){return g?(this.logger.unsafe.info("sending dtmf tones: ",g),new Promise(((m,S)=>{this.queue.push({tones:g,resolve:m,reject:S})}))):Promise.reject(new Error("invalid input"))}toneSent(g){this.queue[0]&&(g===this.queue[0].tones[0]?(this.queue[0].tones=this.queue[0].tones.substr(1),""===this.queue[0].tones&&(this.queue[0].resolve(),this.queue.shift())):(this.queue[0].reject(new Error(`sent tone does not match: expected '${this.queue[0].tones[0]}' got '${g}'`)),this.queue.shift(),this.toneSent(g)))}},Z_=class{constructor(g){this.webRtcSender=null,this.configProvider=g.configProvider,this.queue=new X_(g.logger)}sendDtmf(g,m){return g&&g.getSenders?(this.syncSender(g),this.webRtcSender?(this.webRtcSender.ontonechange=this.onToneChange.bind(this),this.webRtcSender.insertDTMF(this.webRtcSender.toneBuffer+m,this.configProvider.config.dtmf.toneDuration,this.configProvider.config.dtmf.toneGap),this.queue.waitForNotification(m)):Promise.reject(new Error("not available"))):Promise.reject(new Error("bad peerConnection"))}canSendDtmf(g){return!(!g||!g.getSenders)&&(this.syncSender(g),!!this.webRtcSender&&this.webRtcSender.canInsertDTMF)}dispose(){this.queue.cleanup()}syncSender(g){const m=g.getSenders().filter((g=>g.track&&"audio"===g.track.kind)).filter((g=>g.dtmf&&g.dtmf.canInsertDTMF))[0];this.webRtcSender&&m&&m.dtmf!==this.webRtcSender&&(this.webRtcSender.ontonechange=null,this.queue.cleanup()),this.webRtcSender=m?m.dtmf:null}onToneChange(g){g.tone&&this.queue.toneSent(g.tone)}},ey={build:g=>new Z_(g)},ty=0,iy=class _WebRtcSession{constructor(g,m,S){this.context=g,this.callId=m,this.callback=S,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc-"+ ++ty),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.webrtcAdapter=P_.build({global:this.context.maContext,configProvider:this.configProvider}),this.iceHostCandidateOnly=this.multiParty&&getFrom("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new L_({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:!1}),this.sessionDescription=ES.build({sdpTransform:new this.webrtcAdapter.SdpTransform(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=getFrom("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new uv({streamAdded:g=>this.streamAdded(g),streamRemoved:g=>this.streamRemoved(g)}),this.stats=new g_(this.logger.createChild("stats"),this.configProvider,void 0,this.mediaManager,this.multiParty),this.maxResolution=this.multiParty?Lp.Send.getResolutionByFs(this.configProvider.config.webrtcMultipartyMaxScalingFs):Lp.Send.getResolutionByFs(this.configProvider.config.webrtcMaxScalingFs),this.qualityManager=new j_(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,cooldownTimeout:this.configProvider.config.webrtcResolutionManagerCooldownTimeout,retryDelay:this.configProvider.config.webrtcResolutionManagerRetryDelay,maxResolution:this.maxResolution,customBwEstimationEnabled:!0,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},{onReceiveCapabilitiesChanged:(g,m,S)=>this.applyCapabilitiesForModality(g,m,S),onSendBandwidthChanged:g=>this.onSendBandwidthChanged(g)},this.stats,void 0,this.configProvider),this.localVideoStreamWatcher=new Y_(this.stats,this.logger,this.configProvider,this.context.callDeviceManager),this.activeSpeakerManager=new lv(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,null,this.logger.createChild("ActiveSpeakerManager")),this.senders={},this.negotiationQueue=new Ap(this.logger),this.negotiationEmulator=new x_(this.logger.createChild("negotiationEmulator"),this.webrtcAdapter.RTCSessionDescription,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.toBeCalledAfterConnected=[],this.iceTransportPolicy=this.configProvider.config.iceTransportPolicyForced||this.context.config.iceTransportPolicy||Ke.ICE_TRANSPORT_POLICY.all,this.isMuteHold=!1,this.peerConnection=null,this.mediaStreams=new Map,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new or,this.relayCandidateGathered=!1,this.iceCandidatesTimer=null,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=ey.build({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=getFrom("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new mv(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:g=>this.onStreamsChanged(g)}),this.remoteVideoResolutionManager=new q_(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.stats),this.remoteVideoManager=new J_(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.stats,void 0,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new or,this.ssrcGenerator=new dv,this.ssrcs={Audio:this.getSsrcRangeForMediaType("Audio"),Video:this.getSsrcRangeForMediaType("Video"),ScreenShare:this.getSsrcRangeForMediaType("ScreenShare")},this.forceKeyFramePromise=null,this.ufdManager=g.getUfdManager(),this.stats.on("onStatisticsChanged",(g=>{this.updateQualityLevels(g)})),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((g,m,S,v)=>this.requestSource(g,m,S,v))),this.setSubsForSubscriptionManager(),this.localVideoStreamWatcher.on("onVideoCaptureFreeze",(g=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",g?"Bad":"Good","Video")})),this.configProvider.mediaConfig.maxBandwidthInKbps&&this.stats.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.createAudioRenderer(),this.configProvider.config.webrtcVideoScaling&&this.onOptimalVideoReceiversCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount)}get audioStream(){return this.mediaStreams.get("Audio")}get videoStream(){return this.mediaStreams.get("Video")}get displayStream(){return this.mediaStreams.get("ScreenShare")}useNullAudioStreamClient(){}getIncomingRawAudioStream(){return null}configureSpatialAudio(g,m){}setParticipantSpatialAudioPositions(g,m){}getAcceptedTypes(){return this.allowedMediaContentType}clone(g=!1){const m=shallowClone(this.context);m.config=shallowClone(this.context.config),m.config.webrtcMediaContentType=this.mediaContentType,m.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,g?m.config.isConference=!0:(m.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(m.config.webrtcIceGatheringTimeoutIncreased=!0));const S=new _WebRtcSession(m,this.callId,this.callback);return this.relayManagerProvider&&(S.relayManagerProvider=this.relayManagerProvider),S.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,S}setInternals(g){if(g.extensionsManager&&this.extensionsManager){const m=g.extensionsManager.getExtension("videoStreamControl");m&&m.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",m.getOptions())}g.subscriptionManager&&(this.subscriptionManager&&this.subscriptionManager.dispose(),this.subscriptionManager=g.subscriptionManager,this.subscriptionManager.setStreamProvider({getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:g=>this.onStreamsChanged(g)}),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),g.audioRenderer&&(g.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=g.audioRenderer),g.remoteVideoManager&&g.remoteVideoManager.moveRenderers(this.remoteVideoManager)}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(g=>this.stats.setSubscribedTrackIds(g))),this.subscriptionManager.on("onTrackSsrcChanged",(g=>this.stats.setSubscribedTrackSsrc(g))),this.subscriptionManager.on("onSubscriptionChanged",((g,m,S,v,C,_)=>this.stats.addSubscriptionEvent(g,m,S,v,null,C,_))),this.subscriptionManager.on("onSubscriptionFailed",((g,m,S,v,C)=>this.stats.addSubscriptionEvent(g,m,S,v,C)))]}move(g,m){g.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager}),g.muteHold(this.isMuteHold,m),this.doAudioMute?g.muteInputAsync(m):g.unmuteInputAsync(m),this.subscriptionManager=null,this.audioRenderer=null,this.callbacks.onTerminated=null}setMute(g,m,S){this.logger.safe.info(`[${S}] call setMuteAsync with mute state ${m}, audio stream exists: ${!!this.audioStream}`),"Audio"===g&&this.audioStream?this.audioStream.setMuted(m,S):"Video"===g&&this.videoStream?this.videoStream.setMuted(m,S):"ScreenShare"===g&&this.displayStream&&this.displayStream.setMuted(m,S),this.updateQualityLevels(this.stats.getLastStatistics())}setCallConstraints(g,m){return Promise.reject(new Error("Not supported"))}configureModalitiesAsync(g,m){const S=this.configuredModalitiesPromise.then((()=>{if(!g||!g.audio&&!g.video&&!g.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(g)}`);const S=!this.configuredModalities||!areNegotiatedDirectionsFulfilled(g,this.negotiatedModalities);return this.configuredModalities=g,this.logger.safe.info(`[${m}] configure modalities`,`audio: ${g.audio}`,`video: ${g.video}`,`sharing: ${g.sharing}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?this.peerConnection.signalingState:"-"}`,`needNewRenegotiation: ${S}`),S&&this.triggerRenegotiation(!1,m),this.configuredModalities}));return this.configuredModalitiesPromise=S.catch((g=>{this.logger.safe.warn(`[${m}] Error during configuring modalities: ${stringifyObject(g)}`)})).then((()=>{})),S.then((()=>{}))}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}getSubscriptionManager(){return null}createAudioElement(g){}createOfferAsync(g){const m=this.negotiationQueue.add((()=>new Promise((m=>{this.logger.safe.info(`[${g}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,this.offeredModalities=this.negotiatingModalities,this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[Ke.MODALITY.data]&&this.multiParty&&(this.offeredModalities[Ke.MODALITY.data]=Ke.MEDIA_STATE.inactive),isOnHold(this.offeredModalities)&&!isEmpty(this.negotiatedModalities)&&Object.keys(this.offeredModalities).forEach((g=>{void 0===this.negotiatedModalities[g]&&delete this.offeredModalities[g]})),m(this.updatePeerConnectionStreamsAsync(this.offeredModalities,!0,!0,g).then((()=>{const m=this.createNegotiationConstraints(this.offeredModalities);return this.logger.safe.info(`[${g}] create [offer] offered: ${JSON.stringify(this.offeredModalities)} constraints: ${JSON.stringify(m)}`),this.peerConnection.createOffer(m)})).then((m=>{this.logger.unsafe.debug(`[${g}] create [offer] offer from peer connection`,"sdp:",m.sdp);const S=this.sessionDescription.createLocalOffer(m.sdp);this.hasIceCandidates(S)||this.resetCandidateGathering(g),this.stats.startWaitingForStreamStart(this.offeredModalities);const v=new this.webrtcAdapter.RTCSessionDescription({sdp:S.toLocal(),type:"offer"});return this.setupIceGatheringTimeout(g),Promise.all([this.peerConnection.setLocalDescription(v),this.iceCandidatesDeferred.promise])})).then((()=>{const m=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);m.updateModalities(this.offeredModalities),this.checkIceCandidates(m);const S=m.toOffer();this.logger.unsafe.debug("CREATE OFFER","sdp:",S);const v={blob:S,contentType:this.mediaContentType};return""===this.configProvider.config.webrtcRequiredFeatures||this.multiParty||(v.requiredFeatures=this.configProvider.config.webrtcRequiredFeatures),this.configProvider.countryCode&&(v.clientLocation=this.configProvider.countryCode),this.doRetargetIfNeeded(v,m,g),v})))}))),g);return this.resetNegotiationQueue(g),m}processOfferAsync(g,m){const S=this.negotiationQueue.add((()=>new Promise((S=>{const v=g.blob;if(this.logger.unsafe.debug(`[${m}] process [offer]`,"sdp:",v),this.configProvider.config.webrtcCompareContentTypeInOffer&&(throwIfNotSupported(g.contentType,this.allowedMediaContentType),this.mediaContentType=g.contentType),g.requiredFeatures){const m=this.configProvider.config.webrtcRejectedFeatures.split(",");throwIfFeatureNotSupported(g.requiredFeatures.split(","),m)}this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(v),this.canTriggerRenegotiation=!1,this.offeredModalities=invertModalities(this.offeredDescription.getModalities()),this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled());let C=Promise.resolve(this.offeredModalities);if(hasSendDirectionality(this.offeredModalities.video)||hasReceiveDirectionality(this.offeredModalities.video)||hasSendDirectionality(this.offeredModalities.sharing)||hasReceiveDirectionality(this.offeredModalities.sharing)){const g=this.offeredDescription.getVideoCodecs();C=this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((S=>{if(!S.codecs.some((m=>g.some((g=>m.mimeType===g))))){this.logger.safe.warn(`[${m}] offer doesn't contain any supported video codecs`);const g=shallowClone(this.offeredModalities);return this.disabledModalities.video=g.video,this.disabledModalities.sharing=g.sharing,g.video=void 0,g.sharing=void 0,g}return this.offeredModalities})).catch((g=>(this.logger.safe.error(`[${m}] failed to get video capability ${stringifyObject(g)}`),this.offeredModalities)))}S(C.then((g=>(this.logger.safe.info(`[${m}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(g)}`),g))))}))),m);return this.resetNegotiationQueue(m),S}createAnswerAsync(g,m){return new Promise((S=>{if(g)return void S({blob:"",contentType:this.mediaContentType});this.logger.safe.info(`[${m}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for"),this.negotiatingModalities=this.configuredModalities;let v=negotiateModalities(this.offeredModalities,this.negotiatingModalities);const C=this.offeredDescription.clone();S(this.updatePeerConnectionStreamsAsync(v,!0,!1,m).then((()=>this.handleCodecSwitchUnsupported(m))).then((()=>{const g=this.offeredDescription.toRemote(v);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources();const S=new this.webrtcAdapter.RTCSessionDescription({sdp:g,type:"offer"});return this.updateDescriptor(S,C),this.logger.unsafe.info(`[${m}] create [answer] set remote description`,"negotiated:",v,"sdp:",S.sdp),this.peerConnection.setRemoteDescription(S)})).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.updatePeerConnectionStreamsAsync(v,!1,!0,m)))).then((()=>(this.handleSharingRecvCapabilities(C),this.handleVideoRecvCapabilities(C)))).then((()=>this.peerConnection.createAnswer())).then((g=>{this.logger.unsafe.debug(`[${m}] create [answer] answer from peer connection`,"sdp:",g.sdp);const S=this.sessionDescription.createLocalAnswer(g.sdp);this.hasIceCandidates(S)||this.resetCandidateGathering(m),this.stats.startWaitingForStreamStart(v);const C=new this.webrtcAdapter.RTCSessionDescription({sdp:S.toLocal(),type:"answer"});return this.setupIceGatheringTimeout(m),Promise.all([this.peerConnection.setLocalDescription(C),this.iceCandidatesDeferred.promise])})).then((()=>{const g=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);g.updateModalities(v),this.checkIceCandidates(g);const S=g.toAnswer();v=g.getModalities(),areNegotiatedDirectionsAcceptable(this.configuredModalities,this.negotiatingModalities,v)||this.triggerRenegotiation(!0,m),this.setNegotiatedModalities(v),this.stats.sessionInfo.setBweType(g.getBweType()),this.logger.unsafe.debug("CREATE ANSWER","sdp:",S);const C={blob:S,contentType:this.mediaContentType};return this.configProvider.countryCode&&(C.clientLocation=this.configProvider.countryCode),C})))}))}processAnswerAsync(g,m,S){const v=g.blob;if(this.logger.unsafe.debug(S?"PROCESS PRANSWER":"PROCESS ANSWER","sdp:",v),S)return this.logger.safe.info(`[${m}] process [pranswer] ignored`),Promise.resolve();this.mediaContentType=g.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType);const C=this.sessionDescription.createRemoteAnswer(v),_=C.clone(),E=invertModalities(C.getModalities());this.setNegotiatedModalities(E);const T=C.toRemote(this.negotiatedModalities);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources(),this.stats.sessionInfo.setBweType(C.getBweType());const I=new this.webrtcAdapter.RTCSessionDescription({sdp:T,type:"answer"});return this.updateDescriptor(I,_),this.logger.unsafe.info(`[${m}] process [answer] set remote description`,"negotiated:",this.negotiatedModalities,"sdp:",I.sdp),this.peerConnection.setRemoteDescription(I).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.negotiatedModalities))).then((()=>(this.handleSharingRecvCapabilities(_),this.handleVideoRecvCapabilities(_)))).then((g=>{g&&this.triggerRenegotiation(!0,m)}))}completeNegotiationAsync(g){return new Promise((m=>{this.mediaManager.commit();const S=this.configuredModalities,v=this.forceMediaStreamUpdate&&!isOnHold(this.negotiatedModalities)||!areNegotiatedDirectionsAcceptable(S,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,C=!v;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${g}] negotiation completed isComplete: ${C} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),v&&this.triggerRenegotiation(!1,g),this.negotiationCompletedPromise.resolve();m({isComplete:C,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})}))}rejectNegotiationAsync(g,m,S=!1){return Promise.resolve().then((()=>{if(this.mediaManager.rollback(),this.logger.safe.warn(`[${m}] negotiation rejected isComplete: ${!S} error: ${stringifyObject(g)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.peerConnection){if("have-local-offer"===this.peerConnection.signalingState)return this.logger.safe.info(`[${m}] rolling back local description`),this.configProvider.config.webrtcHandleRollback?(this.logger.safe.info(`[${m}] rolling back using local renegotiation`),this.negotiationEmulator.renegotiateNow().then((()=>{this.logger.safe.info(`[${m}] rolling back using local complete`)}))):this.peerConnection.setLocalDescription(new this.webrtcAdapter.RTCSessionDescription({type:"rollback"}));this.logger.safe.error(`[${m}] cannot rollback local description in currrent state: ${this.peerConnection.signalingState}`)}})).then((()=>{this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected");this.getAddedMediaTypes(this.negotiatedModalities,this.negotiatingModalities).forEach((g=>{this.removeTrackByMediaType(g),this.disposeStreamByMediaType(g)})),this.registerLocalStreams()})).then((()=>(S&&(this.logger.safe.info(`[${m}] retrying failed negotiation`),this.triggerRenegotiation(!1,m)),{isComplete:!S,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})))}startMediaDescriptionsUpdateAsync(g){return Promise.reject(new Error("Not supported"))}completeMediaDescriptionsUpdateAsync(g){return Promise.reject(new Error("Not supported"))}rejectMediaDescriptionsUpdateAsync(g,m){return Promise.reject(new Error("Not supported"))}createRemoteRenderer(g){return this.remoteVideoManager.createRenderer(g,this.subscriptionManager,this.logger)}getStatsAsync(g){return this.terminated||(this.statisticsReport=this.statisticsReport.then((()=>this.stats.getReport(g))).catch((g=>(this.logger.safe.error(`getting statistics should never fail: ${g.error}`),g.partialReport)))),this.statisticsReport}getLastKnownStats(g=!1){return this.stats.getReport(!1,g)}muteHold(g,m){this.isMuteHold=g;const S=[Ke.MODALITY.audio,Ke.MODALITY.video,Ke.MODALITY.sharing].filter((g=>hasSendDirectionality(this.negotiatedModalities[g])&&(g!==Ke.MODALITY.audio||!this.doAudioMute)));for(const v of S)this.setMute(modalityToMediaType(v),g,m)}async muteInputAsync(g){this.doAudioMute=!0,this.setMute("Audio",!0,g)}async unmuteInputAsync(g){this.doAudioMute=!1,this.setMute("Audio",!1,g)}muteOutputAsync(g){return this.audioRenderer.setMuted(!0,g),Promise.resolve()}unmuteOutputAsync(g){return this.audioRenderer.setMuted(!1,g),Promise.resolve()}sendDtmf(g){return this.dtmfSender.sendDtmf(this.peerConnection,g)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(g=generateCauseId()){const m=new or;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(m,g)})),m}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(g){this.stats.onDeviceEvent(g)}deviceSelectionChanged(){this.peerConnection&&(this.audioRenderer&&this.audioRenderer.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),isOnHold(this.negotiatedModalities)||(this.forceMediaStreamUpdate=!0,this.triggerRenegotiation(!0)))}async terminate(g,m,S=!0){this.logger.safe.info(`[${g}] terminate`),this.stats.setTerminated(),this.canTriggerRenegotiation=!1,this.cleanUp(g);try{S&&await this.getStatsAsync(!1)}catch(m){this.logger.safe.error(`[${g}] Error while gathering stats ${stringifyObject(m)}`)}finally{this.stats.dispose(),this.terminated=!0}}processNotification(g,m){this.extensionsManager.processNotification(g,m)}cleanUp(g){this.negotiationQueue.dispose(),this.localVideoStreamWatcher.dispose(),this.remoteVideoManager.dispose(),this.resetPeerConnection(g),this.subscriptionManagerSubs.forEach((g=>g.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(g){this.logger.safe.info(`[${g}] reset peer connection`),this.audioRenderer&&this.audioRenderer.dispose(),this.dtmfSender&&(this.dtmfSender.dispose(),this.dtmfSender=null),this.peerConnection&&this.peerConnection.close(),this.toBeCalledAfterConnected=[],this.disposeStreams(),this.peerConnection=null,this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(g),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(g=generateCauseId()){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new or,g)}setNegotiationPromise(g,m=generateCauseId()){this.terminated||(this.negotiationCompletedPromise=g,this.negotiationQueue.add(this.negotiationCompletedPromise,m))}setupExtensionsManager(){const g=new Zv(this.logger.createChild("ExtMgr"));return g.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),g.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,configProvider:this.configProvider,statisticsGatherer:this.stats}),g}updateQualityLevels(g){if(!g)return;this.hwSilent!==g.audioHwSilent&&(this.hwSilent=g.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.ufdManager.signalEvent("NetworkRecvQuality",g.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:g.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",g.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:g.networkSendLevel});const m=!(!g.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",m?"Bad":"Good")}triggerRenegotiation(g,m=generateCauseId()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${m}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(m)):g&&(this.logger.safe.info(`[${m}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(g){if(!this.configuredModalities)throw new Error(g)}addTrack(g,m,S){if(!g)return;const v=this.modalityByMediaType(S);if(this.logger.safe.info(`add media track kind: ${g.kind} id: ${g.id}`),this.senders[v])throw new Error("track already created, modality:"+v+", kind:"+g.kind+", id:"+g.id);"closed"!==this.peerConnection.iceConnectionState&&(this.senders[v]=this.peerConnection.addTrack(g,m))}registerMediaSources(){const g=[];if(this.mediaStreams.forEach(((m,S)=>{const v={sourceId:this.getSourceIdForStream(m),defaultSSRC:this.ssrcs[S].min,modality:this.modalityByMediaType(S)};g.push(v)})),this.qualityManager.updateRegisteredSources(g),this.videoStream){const g=this.videoStream.getResolution();this.qualityManager.setCurrentResolution(new Np(g.width,g.height))}}updateStream(g,m){return g.start().then((()=>{try{const S=this.mediaStreams.get(m);if(S&&g.isSameStream(S))return g.dispose(),null;if(this.updateSsrcRangeForMediaType(m),this.removeTrackByMediaType(m),this.disposeStreamByMediaType(m),!this.peerConnection)return g.dispose(),null;if(this.addTrack(g.rawTrack,g.rawStream,m),g.onApplyConstraints=S=>{this.removeTrackByMediaType(m),S.then((()=>{this.addTrack(g.rawTrack,g.rawStream,m),this.registerLocalStreams(),this.mediaManager.updateMediaEntitiesWithLocalTracks()}))},this.mediaStreams.set(m,g),"Video"===m){const g=[this.getMediaTrackInfo(m)];this.localVideoStreamWatcher.startWatching(g)}}catch(S){throw this.removeTrackByMediaType(m),this.disposeStreamByMediaType(m),g.dispose(),S}}))}getSourceIdForStream(g){const m=g.rawStream.getTracks()[0].id,S=this.mediaManager.getMediaEntityByLocalTrackId(m);return S?(this.logger.safe.info(`Media entity found: ${JSON.stringify(S.getXSourceStreamId())}`),S.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(m)}`),0)}updatePeerConnectionStreamsAsync(g,m,S,v){const C=hasSendDirectionality(this.negotiatedModalities.audio),_=hasSendDirectionality(this.negotiatedModalities.video),E=hasSendDirectionality(this.negotiatedModalities.sharing),T=isOnHold(this.negotiatedModalities),I=hasSendDirectionality(g.audio),b=hasSendDirectionality(g.video),A=hasSendDirectionality(g.sharing),R=isOnHold(g);return T||R||(this.stats.onSendersChanged("Audio",I),this.stats.onSendersChanged("Video",b),this.stats.onSendersChanged("ScreenShare",A)),this.assurePeerConnectionAsync(v).then((async()=>{if(this.logger.safe.info("updatePeerConnectionStreamsAsync","pc state",this.peerConnection.signalingState,"hold","[",T,"->",R,"]","audio","[",C,"->",I,"]","video","[",_,"->",b,"]","sharing","[",E,"->",A,"]"),T!==R){if(this.videoStream&&this.videoStream.setHold(R),this.audioStream&&this.audioStream.setHold(R),this.displayStream&&this.displayStream.setHold(R),R)return;if(!R&&this.audioStream){this.removeTrackByMediaType("Audio");const g=this.audioStream.clone();this.audioStream.dispose(),this.mediaStreams.set("Audio",g),this.addTrack(this.audioStream.rawStream.getAudioTracks()[0],this.audioStream.rawStream,"Audio")}}if((C!==I||_!==b||E!==A||this.forceMediaStreamUpdate)&&(S&&(this.forceMediaStreamUpdate=!1),m&&(this.logger.safe.info("not using any media(track api) track, remove all senders"),I||(this.removeTrackByMediaType("Audio"),this.disposeStreamByMediaType("Audio")),S&&b||(this.removeTrackByMediaType("Video"),this.disposeStreamByMediaType("Video")),S&&A||(this.removeTrackByMediaType("ScreenShare"),this.disposeStreamByMediaType("ScreenShare"))),S)){const g=[];if(b){const m=await this.deviceManager.getVideoStream(!1);g.push(this.updateStream(m,"Video"))}if(A){const m=await this.deviceManager.getDisplayStream();g.push(this.updateStream(m,"ScreenShare"))}if(I){const m=await this.deviceManager.getAudioStream(!1);g.push(this.updateStream(m,"Audio").then((()=>{this.audioStream.setMuted(this.doAudioMute)})))}return Promise.all(g).then((()=>this.registerLocalStreams()))}}))}getMediaTrackInfo(g){const m=this.modalityByMediaType(g),S=this.mediaStreams.get(g).rawStream.getTracks()[0].id;return S||this.logger.safe.error(`No media track for modality found: ${m}`),{trackId:S,modality:m}}getSsrcRangeForMediaType(g){const m={min:1,max:1};switch(g){case"Audio":return this.ssrcGenerator.nextAudioStreamSsrc();case"Video":case"ScreenShare":return this.ssrcGenerator.nextVideoStreamSsrc();default:return m}}updateSsrcRangeForMediaType(g){"Video"!==g&&"ScreenShare"!==g||(this.ssrcs[g]=this.ssrcGenerator.nextVideoStreamSsrc())}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!1,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}registerLocalStreams(){const g=[];this.mediaStreams.forEach(((m,S)=>{g.push(this.getMediaTrackInfo(S))})),this.mediaManager.setLocalTracksInfo(g)}handleVideoRecvCapabilities(g){if(this.configProvider.config.enableLocalVideoConstraints&&hasReceiveDirectionality(g.getModalities().video)){if(this.videoStream){const m=g.getVideoRecvCapabilities();if(!m)return this.logger.safe.error("No fmt params found for video modality"),Promise.resolve(!1);const S=this.generateReceiveCapabilities(m,this.videoStream);this.qualityManager.setMaxCapabilities([S])}this.logger.safe.error("remote endpoint didn't specify video receive capability")}return Promise.resolve(!1)}handleSharingRecvCapabilities(g){if(this.configProvider.config.enableLocalVideoConstraints&&hasReceiveDirectionality(g.getModalities().sharing)&&this.displayStream){const m=g.getSharingRecvCapabilities();if(!m)return void this.logger.safe.error("No fmt params found for sharing modality");const S=this.generateReceiveCapabilities(m,this.displayStream);this.qualityManager.setMaxCapabilities([S])}}generateReceiveCapabilities(g,m){const S={ssrc:0,rid:"0",keyframe:!1,...g},v={causeId:generateCauseId(),isSimulcast:!1,sourceId:this.getSourceIdForStream(m),capabilities:[S]};return this.logger.safe.info(`Generated receive capabilities for stream ${m.id}: ${JSON.stringify(v)}`),v}updateDescriptor(g,m){const S=m.getVideoRecvCapabilities(),v={sourceId:0,streamMsid:0,bandwidth:0};if(S&&this.videoStream&&!this.displayStream&&(v.sourceId=this.getSourceIdForStream(this.videoStream),v.streamMsid=this.videoStream.id,v.bandwidth=S.maxBr?S.maxBr:Number.MAX_VALUE),v.bandwidth>0){v.bandwidth=Math.floor(v.bandwidth/1200);const m=new Sv(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider);m.setControlItem(v),m.modifyDescriptor(g)}}removeTrackByMediaType(g){return this.removeTracksByModality(this.modalityByMediaType(g))}modalityByMediaType(g){switch(g){case"Audio":return Ke.MODALITY.audio;case"Video":return Ke.MODALITY.video;case"ScreenShare":return Ke.MODALITY.sharing;default:throw new Error(`Modality is not defined for media type: ${g}`)}}removeTracksByModality(g){this.forceKeyFramePromise&&"sharing"===g?this.forceKeyFramePromise.then((()=>{this.removeTracksByModality(g)})):g in this.senders&&(this.logger.safe.info(`remove sender track kind: ${this.senders[g].track.kind} track id: ${this.senders[g].track.id}`),"closed"!==this.peerConnection.iceConnectionState&&this.peerConnection.removeTrack(this.senders[g]),delete this.senders[g])}handleCodecSwitchUnsupported(g){return this.offeredDescription.isCodecSwitchSupported()?Promise.resolve():this.webrtcAdapter.RTCRtpReceiver.getCapabilities(Ke.MEDIA_TYPE.audio).then((g=>{const m=g.codecs.map((g=>g.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(m)})).catch((m=>{this.logger.safe.error(`[${g}] failed to set primary codec based on audio capability ${stringifyObject(m)}`)}))}disposeStreamByMediaType(g){const m=this.mediaStreams.get(g);m&&(this.mediaStreams.delete(g),m.dispose(),"Video"===g&&this.localVideoStreamWatcher.stopWatching())}disposeStreams(){this.mediaStreams.forEach(((g,m)=>this.disposeStreamByMediaType(m)))}assurePeerConnectionAsync(g){if(!this.peerConnectionPromise){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info("fetching relay details from RelayManager...");const m={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};this.peerConnectionPromise=this.relayManagerProvider.getRelayManager().queryRelaysAsync(m).then((m=>{if(this.terminated)throw new Error("session already disposed");const S={optional:[]},v=createIceServers(m,this.configProvider.config),C=this.configureCrypto(S);this.configureCpuThreshold(S),this.logger.safe.info("create peer connection");const _=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle",E=this.peerConnection=new this.webrtcAdapter.RTCPeerConnection({iceServers:v,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,bundlePolicy:_,sdpSemantics:"plan-b",audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===C,offerExtmapAllowMixed:!1},S);this.negotiationEmulator.configure(E),this.stats.initialize(E),this.stats.sessionInfo.setIceServers(v),this.stats.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.stats.sessionInfo.setBundlePolicy(_),this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((g=>this.stats.setH264AvailableProfiles(g))),E.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${E.signalingState}`)},E.onsignalingstatechange=()=>{this.stats.sessionInfo.setSignalingConnectionState(E.signalingState),this.logger.safe.info(`onsignalingstatechange signalingState: ${E.signalingState}`)},E.onicecandidateerror=g=>{const[m,S]=[g.address,g.port];this.logger.safe.warn(`On ICE candidate error ${g.url} | ${m}:${S}: code ${g.errorCode}: ${g.errorText}`),this.isConnected()&&!this.iceCandidatesDeferred.isPending||this.stats.addIceCandidateError({address:m,port:+S,url:g.url,errorCode:g.errorCode,errorText:g.errorText})};const onAddStream=g=>{if(!this.isConnected())return this.logger.safe.info("onaddstream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onAddStream(g)));const m=g.stream;this.logger.safe.info(`onaddstream stream: ${m.id}`);let S=this.mediaManager.getMediaEntityByRemoteStreamId(m.id);if(S||(this.logger.safe.info(`cannot find media entity with stream id ${m.id} trying to fallback`),m.getAudioTracks()[0]&&(S=this.mediaManager.getMediaEntitiesByModality(Ke.MODALITY.audio)[0])),S){const g=this.createReceiveStream(m,S);this.receiveStreamCollection.add(g)}else this.logger.safe.error(`could not find media entity for an added stream: ${m.id}`)};E.onaddstream=onAddStream,E.ontrack=g=>{this.logger.safe.info(`ontrack track: ${g.track}`)};const onRemoveStream=g=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onRemoveStream(g)));this.logger.safe.info(`onremovestream stream: ${g.stream.id}`),this.receiveStreamCollection.remove(g.stream.id)};E.onremovestream=onRemoveStream,E.onicecandidate=m=>{const S=m.candidate;if(S){const m=parseCandidateString(S.candidate);this.logger.safe.info(`[${g}] onicecandidate candidate: prio:${m.priority} type:${m.type} port:${m.port}`),this.logger.unsafe.info(`[${g}] candidate details: ${S.candidate}`),!this.relayCandidateGathered&&S.candidate.indexOf("typ relay")>-1&&(this.stats.sessionInfo.setRelayCandidateInfo({priority:S.priority||S.candidate.split(" ")[3],time:Date.now()-this.iceRelayCandidatesGatherStartTime}),this.relayCandidateGathered=!0)}else this.logger.safe.info(`[${g}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const C=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,_=this.iceHostCandidateOnly||0===v.length;if(!S&&C||_){S&&this.logger.safe.info(`[${g}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${g}] Is connected:`,this.isConnected(),E.iceConnectionState,E.signalingState);let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled&&S){m=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledIceCandidates()}m&&this.completeCandidateGathering(g)}else if(this.relayCandidateGathered){let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled){m=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledRelayIceCandidates()}m&&(this.stats.clearIceCandidateErrors(),this.completeCandidateGathering(g))}},E.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${E.iceGatheringState}`)},E.oniceconnectionstatechange=()=>{const g=generateCauseId();if(!this.terminated){if(this.stats.sessionInfo.setIceConnectionState(E.iceConnectionState),this.logger.safe.info(`[${g}] oniceconnectionstatechange iceConnectionState: ${E.iceConnectionState} pc.signalingState: ${E.signalingState}`),"connected"===E.iceConnectionState||"completed"===E.iceConnectionState)this.onTransportConnected(g);else if("failed"===E.iceConnectionState){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${g}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(g);this.raiseError({type:Ke.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},g),this.configProvider.config.webrtcCloseAfterIceFailure&&E.close(),this.onTransportFailed()}"disconnected"===E.iceConnectionState?(this.onTransportDisconnected(g),this.startIceDisconnectedTimer(g)):this.clearIceDisconnectedTimer()}},this.multiParty&&(this.contributingSources=new M_(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new w_(this.logger.createChild("ContributingSourcesProvider"),E)))}))}return this.peerConnectionPromise}configureCrypto(g){let m=!1;const S=preferSdesSrtp(this.context);if(this.offeredDescription){const g=this.offeredDescription.getSrtpInfo();this.stats.sessionInfo.setOfferedSrtpInfo(g),m=!g.dtls||g.sdes&&S}else m=S;return m&&(this.logger.safe.info("configuring peer connection to use sdes"),g.optional.push({DtlsSrtpKeyAgreement:!1})),this.stats.sessionInfo.setNegotiatedSrtpInfo({dtls:!m,sdes:!!m}),m?0:1}configureCpuThreshold(g){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&g.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(g){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${g}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(g){if(this.logger.safe.info(`[${g}] audio transport connected`),this.stats.clearIceCandidateErrors(),!this.terminated)for(this.callbacks.onAudioStateChanged(Ke.STREAMING_STATE.active,g),this.callbacks.onTransportConnected&&this.callbacks.onTransportConnected(g);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}onTransportDisconnected(g){this.callbacks.onTransportDisconnected&&this.callbacks.onTransportDisconnected(g)}onTransportFailed(){this.callbacks.onTransportFailed&&this.callbacks.onTransportFailed()}startIceDisconnectedTimer(g){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${g}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise CONSTANTS.MEDIAthis._ERROR.iceConnectionError`),this.raiseError({type:Ke.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},g)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(g,m=generateCauseId()){this.logger.safe.error(`[${m}] Media error occurred type: ${g.type} detail: ${g.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(g,m)}createNegotiationConstraints(g){function canReceive(g){return!!g&&(hasReceiveDirectionality(g)||"inactive"===g)}return{offerToReceiveAudio:canReceive(g.audio),offerToReceiveVideo:canReceive(g.video)||canReceive(g.sharing)}}resetCandidateGathering(g){this.logger.safe.info(`[${g}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new or}checkIceCandidates(g){const m=this.hasIceCandidates(g);if(m===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:Ke.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(m){const m=this.hasRelayIceCandidates(g);if(m===this.noRelayIceCandidates){if(!m&&("connected"===this.peerConnection.iceConnectionState||"completed"===this.peerConnection.iceConnectionState))return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledIceCandidates():g.hasIceCandidates()}hasRelayIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledRelayIceCandidates():g.hasRelayIceCandidates()}doRetargetIfNeeded(g,m,S){const v=m.isIceRestart();this.logger.safe.info(`[${S}] ICE restart: ${v}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription?.isMSRTC()&&v&&!this.multiParty&&m.getSrtpInfo().sdes&&(g.newOffer=!0)}getAddedMediaTypes(g,m){g||(g={}),m||(m={});const S=[];return isModalityAdded(g.audio,m.audio)&&S.push("Audio"),isModalityAdded(g.video,m.video)&&S.push("Video"),isModalityAdded(g.sharing,m.sharing)&&S.push("ScreenShare"),S}applyCapabilitiesForModality(g,m,S){return g===Ke.MODALITY.video?this.applyCapabilitiesForVideo(m,S[0]):g===Ke.MODALITY.sharing?this.applyCapabilitiesForSharing(m,S[0]):Promise.resolve(!1)}applyCapabilitiesForSharing(g,m){return this.displayStream?this.applyCapabilities(this.displayStream,m).then((S=>(this.stats.onMaxCapabilitiesApplied({causeId:g,modality:Ke.MODALITY.sharing,capabilities:[m]}),this.configProvider.config.webrtcAllowRestoreKeyframe?this.forceKeyframe(this.senders[Ke.MODALITY.sharing]).then((()=>S)):Promise.resolve(S)))):(this.logger.safe.info(`${JSON.stringify(m)} is ignored as no sharing stream is sent, no renegotiation`),Promise.resolve(!1))}forceKeyframe(g){if(!g)return this.logger.safe.error("forceKeyframe: No sender available for sharing"),null;if(this.forceKeyFramePromise)return this.logger.safe.warn("forceKeyframe: already in progress"),this.forceKeyFramePromise;this.logger.safe.info("Restoring keyframe");const m=g.track;return this.forceKeyFramePromise=g.replaceTrack(null).then((()=>g.replaceTrack(m))).then((()=>{this.forceKeyFramePromise=null,this.logger.safe.info("Restoring keyframe finished")})).catch((g=>{this.forceKeyFramePromise=null,this.logger.safe.error(`Restoring keyframe failed: ${g}`),delete this.senders[Ke.MODALITY.sharing]})),this.forceKeyFramePromise}applyCapabilitiesForVideo(g,m){return this.negotiationCompletedPromise.isPending?(this.logger.safe.info("##### Renegotiation is in progress, no local resolution switch for now #####"),this.negotiationCompletedPromise.promise.then((()=>Promise.resolve(!1)))):this.videoStream?this.scheduleApplyCapabilities(this.videoStream,g,m):(this.logger.safe.info(`${JSON.stringify(m)} is ignored as no video is sent, no renegotiation`),Promise.resolve(!0))}scheduleApplyCapabilities(g,m,S){this.logger.safe.info("Queueing local renegotiation...");let v=!1;return this.negotiationQueue.add((()=>(this.logger.safe.info("############# LOCAL RENEGOTIATION START #############"),this.applyCapabilities(g,S).then((()=>{this.stats.onMaxCapabilitiesApplied({causeId:m,modality:Ke.MODALITY.video,capabilities:[S]}),v=!0})))),m),this.negotiationEmulator.renegotiate().then((()=>(this.logger.safe.info(`############# LOCAL RENEGOTIATION END. RESULT: ${v}  #############`),v)))}applyCapabilities(g,m){return g?(this.logger.safe.info(`Changing resolution to ${JSON.stringify(m)}`),g.applyCapabilities(m)):(this.logger.safe.info(`Resolution ${JSON.stringify(m)} ignored, no stream is being sent`),Promise.resolve(!1))}onOptimalVideoReceiversCountChanged(g){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(g)}async onSendBandwidthChanged(g){if(!this.isConnected())return;const m=this.extensionsManager.getExtension("videoStreamControl"),S=this.mediaManager.getMediaEntities().filter((g=>[Ke.MODALITY.video,Ke.MODALITY.sharing].indexOf(g.getModality())>-1)).filter((g=>g.isEnabled())).map((g=>g.getMid()));return 0!==S.length?m.sendBandwidthInfo(S,g).then((()=>{this.stats.setReportedSendBandwidth(g)})):void 0}getStreams(){return this.receiveStreamCollection.getStreams()}onStreamsChanged(g){this.streamsChangedListener=g}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}streamAdded(g){Ke.MODALITY.audio===g.getModality()&&(this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),this.audioRenderer.play(g.getMediaStream())),this.notifyStreamsChanged()}streamRemoved(g){Ke.MODALITY.audio===g.getModality()&&this.audioRenderer.getStream()===g.getMediaStream()&&this.audioRenderer.stop(),this.notifyStreamsChanged()}setNegotiatedModalities(g){this.negotiatedModalities=g,this.stats.sessionInfo.setNegotiatedModalities(g)}setupIceGatheringTimeout(g){this.iceRelayCandidatesGatherStartTime=Date.now();const m=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!m)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const S=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,S.isPending&&(this.logger.safe.warn(`[${g}] ICE candidates gathering terminated due to timeout ${m}`),S.resolve())}),m)}createAudioRenderer(){this.audioRenderer=new bp(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved)}isConnected(){const g=this.peerConnection;return g&&("connected"===g.iceConnectionState||"completed"===g.iceConnectionState)}isFailed(){return this.peerConnection&&("failed"===this.peerConnection.iceConnectionState||"closed"===this.peerConnection.iceConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}createReceiveStream(g,m){const S=this.configProvider.config.addFmtpToInitialSubscription?m.getLocalRecvCapabilities():null,v=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&m.getModality()!==Ke.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null;return new Q_(g,null,m.getModality(),+m.getXSourceStreamId(),this,S,v)}requestSource(g,m,S,v){return this.multiParty?!this.isMuteHold&&this.negotiatedModalities[g]!==Ke.MEDIA_STATE.inactive||S===hv.SourceNone?this.negotiationCompletedPromise.isPending?this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>this.requestSource(g,m,S,v))):Promise.resolve().then((()=>{const g=this.mediaManager.getMediaEntityByXSourceStreamId(m);return this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(m,S,g?.getMid(),v)})):delay2(10).then((()=>this.requestSource(g,m,S,v))):Promise.resolve()}getSessionConfig(){return this.configProvider}getUnmixedAudioProvider(){return null}};function isModalityAdded(g,m){return!hasSendDirectionality(g)&&hasSendDirectionality(m)}var ny={build:(g,m,S)=>new iy(g,m,S)},ry=0,sy=class{constructor(g,m,S,v){this.worker=g,this.clientId=m,this.transformType=S,this.listener=v,this.worker.subscribeClient(this.clientId,this.transformType,(g=>this.processMsg(g))),this.worker.sendTransformCommand(this.clientId,{operation:"add",transformType:this.transformType})}processMsg(g){if(this.listener&&g.name in this.listener)return this.listener[g.name].apply(this.listener,g.args);throw`unexpected message received for transform type ${this.transformType}: ${JSON.stringify(g)}`}},ay=7,oy=31,ly=class{constructor(g){this.logger=g}createBaseInstanse(g){this.imp=new cy(this.logger.safe),g.addTransform(this.imp)}createWorkerInstanse(g,m){this.imp=new dy(g,m)}},cy=class{constructor(g){this.logger=g,this.transformType=0}transform(g){return this.processChunk(g),g}dispose(){}getStartCodeSize(g){const m=g.getUint32(0);return 1===m?4:256==(4294967040&m)?3:0}processChunk(g){if("key"!==g.type)return;const m=this.isH264KeyFrame(g.data)?`${this.getH264Profile(g.data)}(H264)`:"unknown";this.logger.info(`keyframe metadata: ${JSON.stringify(g.getMetadata())}, profile=${m}`)}isH264KeyFrame(g){if(g.byteLength<7)return!1;const m=new DataView(g),S=this.getStartCodeSize(m);return!!S&&(m.getUint8(S)&oy)===ay}getH264Profile(g){const m=new DataView(g),S=this.getStartCodeSize(m);return(16777215&m.getUint32(S)).toString(16)}},dy=class extends sy{constructor(g,m){super(g,m,0,void 0)}},hy=P,uy=[Ke.MODALITY.audio,Ke.MODALITY.video,Ke.MODALITY.sharing],gy=class{constructor(g,m,S,v,C){this.peerConnection=m,this.mediaManager=S,this.reinvitelessContext=C,this.entityTransceiverMap=new Map,this.logger=g.createChild("TM"),this.configProvider=v.configProvider,this.isMultiparty=v.config.isConference,this.isPstnCall=v.config.isPstnCall,this.isParkedCall=v.config.isParkedCall,this.numVideoChannels=this.isMultiparty&&this.configProvider.config.numVideoChannelsGvc||1,v.configProvider.config.enableRollbackHandler&&this.mediaManager.setRollbackUpdateHandler(this.handleMediaEntitiesRollback.bind(this))}getTransceivers(){return this.peerConnection.getTransceivers().filter(isActiveTransceiver)}assureTransceivers(g){this.assureNegotiatedOrder(),this.addModalities(g),this.logTransceiversInfo("assureTransceivers"),this.setDirections(g)}syncTransceivers(g){this.syncWithMediaEntities(),this.setDirections(g)}assureNegotiatedOrder(){const g=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((m=>{if(-1===uy.indexOf(m.getModality()))return;isActiveTransceiverInPc(this.entityTransceiverMap.get(m),g)||this.createTransceiverForEntity(m)}))}addModalities(g){const m=this.mediaManager.isEmpty();this.isMultiparty||!m||this.isPstnCall||(g.video=g.video||"inactive",g.sharing=g.sharing||"inactive"),this.configProvider.config.webrctRemoveVideoModalitiesForPstn&&this.isPstnCall&&!this.isParkedCall&&(delete g.video,delete g.sharing);for(const S of uy){if(this.mediaManager.getMediaEntitiesByModality(S)[0]||!g[S])continue;const v=S===Ke.MODALITY.video?this.numVideoChannels:1;(0,hy.times)(v,(g=>{const v=this.mediaManager.createMediaEntity(S);v.setExtension("reinviteless",m&&this.reinvitelessContext.maxStreamsForModality[S]>g),this.createTransceiverForEntity(v)}))}}createTransceiverForEntity(g){const m=g.getModality();this.logger.safe.info(`createTransceiver: modality=${m}`);const S=m===Ke.MODALITY.audio?Ke.MEDIA_TYPE.audio:Ke.MEDIA_TYPE.video,v=g.getSimulcastContext(),C=this.createTransceiver(S,v);this.setCodecPreferences(C,S,!0),this.setExtensionPreferences(C,m),this.entityTransceiverMap.set(g,C),g.setExtension("unnegotiatedModality",!0)}setCodecPreferences(g,m,S){const v=getAllowedCodecs(this.configProvider,m);if(!v?.length||!Vs.hasCapabilitiesApi()||this.configProvider.config.filterCodecsInSdp)return;const C=Us.window.RTCRtpReceiver.getCapabilities(m);if(!C)return;const _=[];if(S)for(const g of v){const m=C.codecs.filter((m=>isCodecsMatch2(g,m)));_.push(...m)}else for(const g of C.codecs)v.some((m=>isCodecsMatch2(m,g)))&&_.push(g);_.length&&g.setCodecPreferences&&g.setCodecPreferences(_)}setExtensionPreferences(g,m){if(!this.configProvider.config.headerExtensionsToUpdate?.[m])return;if(!g.getHeaderExtensionsToNegotiate||!g.setHeaderExtensionsToNegotiate)return void this.logger.safe.debug("setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate is not supported");const S=this.configProvider.config.headerExtensionsToUpdate[m],v=g.getHeaderExtensionsToNegotiate();for(const g of v){const m=S.find((m=>m.uri===g.uri));m&&(g.direction=m.direction)}try{g.setHeaderExtensionsToNegotiate(v)}catch(g){this.logger.safe.error(`setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate failed, err ${stringifyObject(g)}`)}}async createSender(g,m,S){const v=await this.associateTrackWithTransceiver(g,m,S);if(!v)throw new Error(`Transceiver for modality=${S} is not found`);const C=this.findEntityForTransceiver(v),_=S!==Ke.MODALITY.sharing||C?.getExtension("reinviteless")?Ke.MEDIA_STATE.sendReceive:Ke.MEDIA_STATE.send;return v.direction=_,this.logger.safe.info(`Replace track completed direction:${v.direction} for transceiver mid=${v.mid}`),v.sender}removeSender(g){this.removeSenderInternal(g,!1)}async removeSenderAsync(g){return this.removeSenderInternal(g,!0)}removeSenderInternal(g,m){if("closed"===(this.peerConnection.connectionState||this.peerConnection.iceConnectionState))return void this.logger.safe.info("Not removing sender from pc, connection is closed");const S=this.getTransceivers().find((m=>m.sender===g));if(!S)throw new Error(`Transceiver for sender with track=${g.track?.id} is not found`);const v=this.findEntityForTransceiver(S),C=!!v?.getExtension("reinviteless");this.logger.safe.info(`Remove sender with track=${g.track?.id} for transceiver mid=${S.mid}, reinviteless=${C}, doAsync=${m}`);let _=Promise.resolve();return C&&m?_=S.sender.replaceTrack(null):this.peerConnection.removeTrack(g),m?_:void 0}createTransceiver(g,m){const S={direction:"inactive"};return this.addSimulcastEnvelopeIfNeeded(S,m),this.peerConnection.addTransceiver(g,S)}addSimulcastEnvelopeIfNeeded(g,m){m?.shouldUseSimulcast()&&(g.sendEncodings=(0,hy.times)(m.config.layerScaleFactors.length,(g=>{const S=`${m.ridList[g]}`,v=m.config.layerScaleFactors[g];return this.logger.safe.debug(`Added layer ${g} with rid: ${S} SF: ${v}`),{rid:S,scaleResolutionDownBy:v}})))}async associateTrackWithTransceiver(g,m,S){const v=this.findAvailableTransceiverToSend(S);if(v){this.logger.safe.info(`Associate track=${g?.id} (${S}) with existing transceiver mid=${v.mid}`);try{await v.sender.replaceTrack(g),this.configProvider.config.useSetStreamsForSender&&v.sender.setStreams&&v.sender.setStreams(m)}catch(g){throw this.logger.safe.error(`replaceTrack failed, err ${JSON.stringify(g)}`),g}return v}return null}syncWithMediaEntities(){const g=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((m=>{let S=this.entityTransceiverMap.get(m);S=isActiveTransceiverInPc(S,g)?S:g.find((g=>g.mid===m.getMid())),this.entityTransceiverMap.set(m,S)})),this.logTransceiversInfo("syncWithMediaEntities")}getTransceiversByModality(g){return this.mediaManager.getMediaEntitiesByModality(g).map((g=>this.entityTransceiverMap.get(g))).filter(isActiveTransceiver)}setDirections(g){const m=!isOnHold(g);for(const S of uy)for(const[v,C]of this.getTransceiversByModality(S).entries()){const _=this.findEntityForTransceiver(C);if(_?.getExtension("reinviteless")&&m){C.direction="sendrecv";continue}const E=g[S]||Ke.MEDIA_STATE.inactive;C.direction=0===v&&C.currentDirection?E:removeSendDirectionality2(E)}this.logTransceiversInfo("setDirections")}handleMediaEntitiesRollback(g,m){g.forEach((g=>{const S=this.entityTransceiverMap.get(g),v=m.find((m=>m.getMid()===g.getMid()));this.entityTransceiverMap.set(v,S)})),this.logTransceiversInfo("handleMediaEntitiesRollback")}findAvailableTransceiverToSend(g){const m=this.mediaManager.getMediaEntitiesByModality(g)[0];return this.entityTransceiverMap.get(m)}findEntityForTransceiver(g){for(const[m,S]of this.entityTransceiverMap)if(S===g)return m}logTransceiversInfo(g){let m=`${g}: transceivers details:`;for(const g of uy){const S=this.getTransceiversByModality(g);m+=` ${g}(${S.length}) [${S.map((g=>`mid=${g.mid}, direction=${g.direction}`)).join(";")}]`}this.logger.safe.debug(m)}};function isCodecsMatch2(g,m){return!(!(0,hy.isUndefined)(g.channels)&&g.channels!==m.channels)&&(!(!(0,hy.isUndefined)(g.clockRate)&&g.clockRate!==m.clockRate)&&(!(!(0,hy.isUndefined)(g.mimeType)&&g.mimeType.toLowerCase()!==m.mimeType.toLowerCase())&&!(!(0,hy.isUndefined)(g.sdpFmtpLine)&&-1===m.sdpFmtpLine.toLowerCase().indexOf(g.sdpFmtpLine.toLowerCase()))))}function removeSendDirectionality2(g){let m=g;return hasSendDirectionality(g)&&(m=removeSendDirectionality(g)),m||Ke.MEDIA_STATE.inactive}function isActiveTransceiver(g){return g&&"stopped"!==g.direction&&!g.stopped}function isActiveTransceiverInPc(g,m){return isActiveTransceiver(g)&&-1!==m.indexOf(g)}var py=class{constructor(g,m){this.transforms=[];const S=new TransformStream({transform:(g,m)=>{let S=g;for(const g of this.transforms)if(S=g.transform(S),!S)return;m.enqueue(S)}});g.pipeThrough(S).pipeTo(m)}clearTransforms(){for(const g of this.transforms)g.dispose();this.transforms=[]}addTransform(g){this.transforms.push(g)}getTransform(g){return this.transforms.find((m=>m.transformType===g))}},my=class{constructor(g,m){this.logger=m,this.clientsMap=new Map,this.loaded=!1,this.initDefer=defer4();try{this.worker=g.getWorker(),this.worker.onmessage=g=>this.handleEvent(g.data),this.worker.onerror=g=>{this.logger.safe.error(`error inside worker: ${g.message}`),this.initDefer.resolve()}}catch(g){this.logger.safe.error("failed to create worker"),this.initDefer.resolve()}}initialize(){return Promise.race([this.initDefer.promise,delay2(5e3)])}isWorkerLoaded(){return this.loaded}sendTransformCommand(g,m,S=[]){const v={type:"transform",clientId:g,payload:m};this.worker.postMessage(v,S)}subscribeClient(g,m,S){const v=this.clientsMap.get(g)??new Map;v.set(m,S),this.clientsMap.set(g,v)}dispose(){const g={type:"generic",payload:{operation:"dispose"}};this.worker.postMessage(g),this.worker.terminate()}handleEvent(g){switch(g.type){case"init":this.initDefer.resolve(),this.loaded=!0;break;case"transform":{const m=this.clientsMap.get(g.payload.clientId),S=m?.get(g.payload.event.transformType);S?.(g.payload.event),S||this.logger.safe.error(`received event for unknown Client ${g.payload.clientId} or transformType ${g.payload.event.transformType}`)}break;case"log":switch(g.level){case"debug":this.logger.safe.debug(g.msg);break;case"info":this.logger.safe.info(g.msg);break;case"warn":this.logger.safe.warn(g.msg);break;case"error":this.logger.safe.error(g.msg);break;default:this.logger.safe.error(`unknown log level ${g.level}`)}break;default:this.logger.safe.error(`received unsupported event from worker ${g.type}`)}}},fy=class extends je{constructor(g,m,S){super(),this.configProvider=g,this.workerProvider=m,this.logger=S,this.transformsCollections=new Map}async initialize(){return this.configProvider.config.useInsertableStreams&&this.workerProvider&&Vs.hasEncodedStreamApi()&&(this.worker=new my(this.workerProvider,this.logger)),this.worker?this.worker.initialize():Promise.resolve()}initTransformsCollection(g,m,S){const v=Vs.hasScriptTransformApi()||this.workerProvider;if(!(this.configProvider.config.useInsertableStreams&&Vs.hasEncodedStreamApi()&&(!v||this.isWorkerLoaded())))return null;if(!this.transformsCollections.has(g)){const v=this.worker?new vy(this.worker,g):new Sy(g);this.transformsCollections.set(g,{collection:v,mediaType:S,objType:m})}const C=this.transformsCollections.get(g);return this.event("onTransformsCollectionCreated").raise(C),C.collection}clearTransformsCollection(g){const m=this.transformsCollections.get(g);m&&(this.event("onTransformsCollectionCleared").raise(m),m.collection.clearTransforms())}dispose(){for(const g of this.transformsCollections.values())this.event("onTransformsCollectionCleared").raise(g),g.collection.clearTransforms();this.transformsCollections.clear(),this.worker?.dispose(),super.dispose()}isWorkerLoaded(){return!!this.worker?.isWorkerLoaded()}},Sy=class{constructor(g){const{readable:m,writable:S}=g.createEncodedStreams();this.streamTransformer=new py(m,S)}addTransform(g){g.createBaseInstanse(this.streamTransformer)}clearTransforms(){this.streamTransformer.clearTransforms()}},vy=class{constructor(g,m){if(this.workerHandler=g,this.clientId=m.track.id,Vs.hasScriptTransformApi())return void(m.transform=new RTCRtpScriptTransform(this.workerHandler.worker,{clientId:this.clientId}));const{readable:S,writable:v}=m.createEncodedStreams(),C=[S,v];this.workerHandler.sendTransformCommand(this.clientId,{operation:"init",readable:S,writable:v},C)}addTransform(g){g.createWorkerInstanse(this.workerHandler,this.clientId)}clearTransforms(){this.workerHandler.sendTransformCommand(this.clientId,{operation:"clear"})}},Cy=P,_y=class extends je{constructor(g,m){super(m),this.logger=m,this.id=-1,this.parentId=-1,this.rawStream=null,this.rawTrack=null,this.deviceId=null,this.mediaType=g}start(){return this.logger.safe.debug("start"),Promise.resolve()}clone(){return this.logger.safe.debug("clone"),this}setMuted(g,m){this.logger.safe.debug("setMuted")}setHold(g){this.logger.safe.debug("setHold")}getResolution(){return this.logger.safe.debug("getResolution"),{width:240,height:180}}getFrameRate(){return this.logger.safe.debug("getFrameRate"),1}hasAudio(){return this.logger.safe.debug("hasAudio"),!1}hasVideo(){return this.logger.safe.debug("hasVideo"),!1}isSameStream(g){return this.logger.safe.debug("isSameStream"),g===this}applyCapabilities(g){return this.logger.safe.debug("applyCapabilities"),Promise.resolve(!1)}onApplyConstraints(g){this.logger.safe.debug("onApplyConstraints")}update(g){this.logger.safe.debug("update")}isActive(){return!1}isDisposed(){return!1}},yy=class _SessionStreamsProvider extends je{constructor(g,m,S,v){super(v),this.callDeviceManager=g,this.configProvider=m,this.serialQueue=S,this.logger=v,this.mediaStreams={Audio:null,Video:null,ScreenShare:null},this.streamSubscriptions=new Map,this.deviceManagerSubscriptions=[],this.isNullAudioStream=!1}get currentMediaTypes(){return keys(this.streams).filter((g=>!!this.streams[g]))}get streams(){return this.mediaStreams}useNullAudioStreamClient(){this.isNullAudioStream=!0}async update(g,m){const S=keys(g).filter((m=>g[m]));return deepEqual(S,this.currentMediaTypes)?(this.logger.safe.info("Requested modalities have not changed. Do nothing"),sendStreamsToModalities(this.streams)):(this.logger.safe.info(`Starting media session with modalities: ${JSON.stringify(g)}`),await this.updateStreams(S,m),this.subscribeOnDeviceManagerEvents(),sendStreamsToModalities(this.streams))}async stopAsync(){this.logger.safe.info("Stopping streams async"),this.stop()}stop(){this.logger.safe.info("Stopping streams"),this.unsubscribeFromDeviceManagerEvents(),keys(this.mediaStreams).forEach((g=>this.removeStreamByType(g)))}async ensureUpdateCompleted(){this.logger.safe.debug("streams updated")}dispose(){this.stop(),super.dispose()}async updateStreams(g,m){const S=this.getAvailableMediaTypes(),v=(0,Cy.intersection)(g,S),C=keys(this.mediaStreams).filter((g=>this.mediaStreams[g])),_=m?[]:subtractFrom(v,C),E=subtractFrom(C,v);this.logger.safe.info(`Adding media streams for types: ${JSON.stringify(_)}`),await Promise.all(_.map((async g=>{await this.addStream(g,!1),this.mediaStreams[g]&&this.event("onStreamAdded").raise(g)}))),this.logger.safe.info(`Removing media streams for types: ${JSON.stringify(E)}`),E.forEach((g=>{this.event("onStreamRemoving").raise(g),this.removeStreamByType(g)}))}getAvailableMediaTypes(){const g=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices(),m=[];return g.microphone&&m.push("Audio"),g.camera&&m.push("Video"),m.push("ScreenShare"),m}async addStream(g,m){if(this.mediaStreams[g])return void this.logger.safe.warn(`Stream with type: ${g} is already registered`);const S=await this.getStream(g,m);this.subscribeOnMediaStreamEvents(S);try{await S.start()}catch(m){return this.logger.safe.error(`Media stream request error: ${JSON.stringify(m)}`),void this.event("onStreamError").raise(g,m)}this.mediaStreams[g]=S}removeStreamByType(g){const m=this.mediaStreams[g];m?(this.unsubscribeFromMediaStreamEvents(m),m.dispose(),this.mediaStreams[g]=null):this.logger.safe.warn(`Stream with type: ${g} is not registered`)}async updateStream(g,m,S=!1){S&&"Audio"===g?await this.updateStreamWithEffect(g):(this.removeStreamByType(g),await this.addStream(g,m)),this.event("onStreamUpdated").raise(g)}async updateStreamWithEffect(g){const m=this.mediaStreams[g];m&&this.unsubscribeFromMediaStreamEvents(m);const S=await this.getStreamByMediaType(g,!0);this.subscribeOnMediaStreamEvents(S);try{await S.start()}catch(m){return this.logger.safe.error(`updateStreamWithEffect. Media stream request error: ${JSON.stringify(m)}`),void this.event("onStreamError").raise(g,m)}this.mediaStreams[g]=S,m?.dispose()}subscribeOnMediaStreamEvents(g){if(this.streamSubscriptions.has(g))return;const m=[];m.push(g.on("onStreamClientError",((g,m)=>this.onStreamError(g,m)))),m.push(g.on("onStreamClientDisposing",(g=>this.onStreamDisposing(g)))),this.streamSubscriptions.set(g,m)}unsubscribeFromMediaStreamEvents(g){this.streamSubscriptions.has(g)&&(this.streamSubscriptions.get(g).forEach((g=>g.dispose())),this.streamSubscriptions.delete(g))}async getStream(g,m){const S=this.mediaStreams[g];return S?(this.logger.safe.info(`Stream exists with id: ${S.id}, type: ${g}`),S):this.getStreamByMediaType(g,m)}async getStreamByMediaType(g,m){switch(g){case"Audio":return this.isNullAudioStream?new _y("Audio",this.logger.createChild("NullStreamClient")):this.getDeviceManagerByType("Audio").getAudioStream(m,"sessionStream");case"Video":return this.getDeviceManagerByType("Video").getVideoStream(m,"sessionStream");case"ScreenShare":return this.getDeviceManagerByType("ScreenShare").getDisplayStream("sessionStream");default:throw new Error(`Media type is not supported: ${g}`)}}getMediaTypeForStream(g){const m=Object.keys(this.mediaStreams).find((m=>this.mediaStreams[m]===g));return m||this.logger.safe.error(`Media type is not found for stream: ${stringifyObject(g)}`),m}subscribeOnDeviceManagerEvents(){if(0!==this.deviceManagerSubscriptions.length)return;if(this.callDeviceManager.isVirtualDeviceEnabled){const g=this.callDeviceManager.on("onSelectedVirtualDevicesChanged",((g,m)=>{const S=g;if(!g.camera){this.logger.info("Virtual DeviceID for camera is undefined, falling back to default device");const{camera:g}=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices();S.camera=g}this.callDeviceManager.isModalityEnabled("Video")&&m.camera!==S.camera&&(this.logger.info("Updating stream for camera"),this.updateStreamForVirtualDeviceChange("Video")),this.callDeviceManager.isModalityEnabled("ScreenShare")&&m.screenshare!==S.screenshare&&(this.logger.info("Updating stream for screenshare"),this.updateStreamForVirtualDeviceChange("ScreenShare"))}));this.deviceManagerSubscriptions.push(g)}const g=this.callDeviceManager.getDefaultDeviceManager();this.deviceManagerSubscriptions.push(g.on("onSelectedDevicesChanged",((g,m)=>this.onSelectedDevicesChanged(g,m))),g.on("onStreamUpdateRequested",((g,m)=>this.requestStreamUpdate(g,!1,m))),g.on("onAudioSharingToggled",(g=>this.onAudioSharingToggled(g))))}unsubscribeFromDeviceManagerEvents(){0!==this.deviceManagerSubscriptions.length&&(this.deviceManagerSubscriptions.forEach((g=>g.dispose())),this.deviceManagerSubscriptions=[])}getMediaTypesToUpdate(g,m){const S=[];return this.currentMediaTypes.some((g=>"Audio"===g))&&g.microphone&&g.microphone!==m.microphone&&S.push("Audio"),!this.callDeviceManager.getSelectedDevices().camera&&this.currentMediaTypes.some((g=>"Video"===g))&&g.camera&&g.camera!==m.camera&&S.push("Video"),S}removeStream(g){const m=this.getMediaTypeForStream(g);this.removeStreamByType(m)}async onSelectedDevicesChanged(g,m){if(this.configProvider.config.enablePermissionsWorkaround&&_SessionStreamsProvider.isDeviceListEmpty(g,m))return void this.logger.safe.info("Device list is empty, permission workaround enabled");const S=this.getMediaTypesToUpdate(g,m);this.logger.safe.info(`Media types to update: ${JSON.stringify(S)}`),await Promise.all(S.map((g=>this.updateStream(g,!1))))}async onAudioSharingToggled(g){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&g)return this.updateStream("ScreenShare",!0)}async requestStreamUpdate(g,m,S=!1){if(this.currentMediaTypes.some((m=>m===g))||m)return this.logger.safe.debug(`UpdateStream with media type: ${g}, force: ${m}`),this.updateStream(g,m,S);this.logger.safe.debug(`Stream with media type: ${g} is not active. Do nothing`)}onStreamError(g,m){this.removeStream(g)}onStreamDisposing(g){this.removeStream(g)}static isDeviceListEmpty(g,m){return!g.camera&&!g.microphone||!m.microphone&&!m.camera}getDeviceManagerByType(g){return this.callDeviceManager.getDeviceManager(g)}async updateStreamForVirtualDeviceChange(g){return this.updateStream(g,!1)}};__decorateClass([sequentialize()],yy.prototype,"update",1),__decorateClass([sequentialize()],yy.prototype,"stopAsync",1),__decorateClass([sequentialize()],yy.prototype,"ensureUpdateCompleted",1),__decorateClass([sequentialize()],yy.prototype,"onSelectedDevicesChanged",1),__decorateClass([sequentialize()],yy.prototype,"onAudioSharingToggled",1),__decorateClass([sequentialize()],yy.prototype,"requestStreamUpdate",1),__decorateClass([sequentialize()],yy.prototype,"updateStreamForVirtualDeviceChange",1);var Ey=yy,Ty=P,Iy=[5e4,1e6,15e5,2e6,25e5,375e4,4e6],by=[7e4,2e5,4e5,8e5,15e5,2499990,25e5];function createBandwidthAllocatorPerMediaType(g,m){const S=new Ay(g.createChild("BandwidthAllocator"));return S.setLadder("ScreenShare",m.config.sharingBitrateLadderOverride||Iy),S.setLadder("Video",m.config.videoBitrateLadderOverride||by),S}var Ay=class{constructor(g){this.logger=g,this.availableBandwidth=0,this.receivers=new Map,this.currentLayout={},this.ladders={}}setAvailableBandwidth(g){this.availableBandwidth=g,this.logger.safe.debug(`Total available bandwidth updated: ${g}`),this.updateLayouts()}addReceiverCapabilty(g,m){this.logger.safe.debug(`Receiver maxBr set: ${g}/${m}`),this.receivers.set(g,m),this.updateLayouts()}removeReceiver(g){this.logger.safe.debug(`Receiver maxBr removed: ${g}`),this.receivers.delete(g),this.updateLayouts()}getLayouts(){return this.currentLayout}setLadder(g,m){this.ladders[g]=m}updateLayouts(){const g=this.generateLayouts();(0,Ty.isEqual)(g,this.currentLayout)||(this.currentLayout=g,this.logger.safe.debug(`Bandwidth distribution updated: ${stringifyObject(g)}`))}generateLayouts(){const g={},m={};for(const S of Object.keys(this.ladders)){const v=this.receivers.get(S);v&&(m[S]=v||Number.MAX_SAFE_INTEGER,g[S]=0)}let S=this.availableBandwidth,v=0;const runLoop=()=>{if(!S)return!1;for(const g of Object.values(m))if(g)return!0;return!1};for(;runLoop();){for(const C of Object.keys(g)){const _=this.ladders[C];let E=_[v]||_[_.length-1];E=Math.min(E,S,m[C]),g[C]+=E,S-=E,m[C]-=E}v++}return g}},Ry=class{constructor(g,m,S){this.timeout=m,this.logger=S,this.isFirstTimeDeferred=!0,this.internalCallback=m=>{this.logger.safe.debug(`Trigger reason: ${m}`),g()}}invoke(g){if(this.logger.safe.debug(`Schedule shouldDefer: ${g}`),this.createTimerIfNeeded(g),this.timer)return g?this.startTimer():this.stopTimerAndTrigger();this.internalCallback("request")}dispose(){this.stopTimer()}startTimer(){this.timer.isActive||(this.timer.start(this.timeout),this.logger.safe.debug(`Timer started for : ${this.timeout}ms`))}stopTimer(){this.timer?.isActive&&(this.timer.stop(),this.logger.safe.debug("Timer stopped"))}stopTimerAndTrigger(){this.stopTimer(),this.internalCallback("request")}createTimerIfNeeded(g){g&&this.isFirstTimeDeferred&&(this.isFirstTimeDeferred=!1,this.timer=new js((()=>{this.internalCallback("timeout"),this.timer=null})))}},Py=class{constructor(g){this.logger=g,this.currentFrameSize=Lp.Send.initialResolution.fs}setAvailableBandwidth(g){g!==this.lastSendBW&&(this.logger.safe.debug(`Available bandwidth updated ${g}`),this.processEstimatedBandwidth(g))}setMaxFrameSize(g){this.logger.safe.debug(`SetMaxFrameSize ${g}`),g!==this.maxFrameSize?(this.maxFrameSize=g,this.lastSendBW?(this.logger.safe.debug(`Setting max frame size: ${g}`),this.processEstimatedBandwidth(this.lastSendBW)):this.logger.safe.debug("Last send bwe is not defined. Do nothing")):this.logger.safe.debug(`Max frame size did not change. Do nothing, maxFs: ${g}`)}getFrameSize(){return this.currentFrameSize}processEstimatedBandwidth(g){if(this.logger.safe.debug(`Process estimated bandwidth ${g}`),0===g)return this.lastSendBW=0,void this.proposeResolution(0);const{lowRes:m,highRes:S}=Lp.Send.getResolutionForBitrate(g);this.logger.safe.debug("low",m,"hi",S);const v=g<this.lastSendBW?S.fs:m.fs;g<this.lastSendBW&&this.currentFrameSize<v?this.logger.safe.debug(`proposed resolution is above the existing one, so we should stay on the current resolution, last bw: ${g}`):(v&&this.proposeResolution(v),this.logger.safe.debug(`Updating last bw: ${g}`),this.lastSendBW=g)}proposeResolution(g){this.logger.safe.debug(`Propose resolution ${g}`);const m=this.maxFrameSize?Math.min(g,this.maxFrameSize):g;m!==this.currentFrameSize&&(this.currentFrameSize=m,this.logger.safe.debug(`Proposed new frame size: ${m} based on bandwidth: ${this.lastSendBW}`))}},My=1e8,wy=[{bwe:2e5,param:5e5},{bwe:5e5,param:12e5},{bwe:8e5,param:25e5},{bwe:12e5,param:4e6}],Dy=[{bwe:2e5,param:240},{bwe:3e5,param:405},{bwe:5e5,param:920},{bwe:9e5,param:2040}],limitParamByBwe=(g,m,S)=>{for(const v of S)if(m<v.bwe)return Math.min(g,v.param);return g},limitStreamMaxBitrate=(g,m,S=wy)=>limitParamByBwe(g,m,S),limitStreamMaxResolution=(g,m,S=Dy)=>limitParamByBwe(g,m,S),Oy=class extends je{constructor(g,m,S){super(m),this.configProvider=g,this.logger=m,this.layoutsNumber=S,this.totalBandwidth=My,this.totalBandwidthMax=0,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),this.outputLayouts=null,super.dispose()}setAvailableBandwidth(g){this.storeAvailableBandwidth(g),this.inputLayouts?(this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.debug("Layouts are not set. Skip update")}setLayouts(g,m){this.storeAvailableBandwidth(m),g.length===this.layoutsNumber?(this.logger.safe.debug(`Set layouts: ${JSON.stringify(g)}`),this.inputLayouts=this.getPrioritizedLayouts(g),this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.warn(`Incorrect number of layouts! ${JSON.stringify(g)}, expected ${this.layoutsNumber}`)}getLayouts(){return this.inputLayouts}getPrioritizedLayouts(g){return g}checkForChangesAndNotify(){const g=this.getLayouts();deepEqual(this.outputLayouts,g)?this.logger.safe.debug("Layout has not changed, skip update"):(this.outputLayouts=g.slice(),this.event("onLayoutsChanged").raise())}storeAvailableBandwidth(g){this.logger.safe.debug(`Set available bandwidth: ${g}`),this.totalBandwidth=g,this.totalBandwidthMax=Math.max(this.totalBandwidthMax,this.totalBandwidth)}},Ny=class extends Oy{constructor(g,m){super(g,m,2),this.resolutionManager=new Py(this.logger.createChild("BWEControlledResolutionManager"))}getLayouts(){return this.hiFiLayout?[this.loFiLayout,this.hiFiLayout]:[this.loFiLayout]}dispose(){super.dispose(),this.resolutionManager=null}getHighLayoutBandwidth(g){const m=this.inputLayouts?.[0].maxBr||0,S=Math.max(g-m,0);this.logger.safe.debug(`Setting available bandwidth for layouts. High: ${S}, low: ${m||"not set"}, total: ${g}`);const v=this.configProvider.config.specCompliantSimulcast?.allowedBweOvershootRatio||1;return Math.floor(S*v)}recalculateLayouts(){const g=this.hiFiLayout,m=this.getHighLayoutBandwidth(this.totalBandwidth);this.resolutionManager.setAvailableBandwidth(m),this.resolutionManager.setMaxFrameSize(this.inputLayouts[1].maxFs),this.loFiLayout=this.getMinimalLayoutParams(this.inputLayouts),this.hiFiLayout=this.getHighLayoutParams(this.inputLayouts,m,this.loFiLayout),this.loFiLayout=this.adjustLowLayoutBasedOnHighLayout(this.hiFiLayout,this.loFiLayout,g)}adjustLowLayoutBasedOnHighLayout(g,m,S){return this.configProvider.config.useMediaQualityControllerForceKeyFrame&&!g&&S&&(this.logger.safe.debug("Forcing kayframe on low layout due to disabling high layout"),m.keyframe=!0),g?(m.maxBr===g.maxBr&&m.maxBr--,m):m}getPrioritizedLayouts(g){return g.sort(((g,m)=>g.maxFs-m.maxFs?g.maxFs-m.maxFs:g.maxFps-m.maxFps))}getHighLayoutParams(g,m,S){const v=g[1];if(v.maxBr<=m)return this.logger.safe.debug(`High layout bandwidth suits requested caps. Applying as-is: ${JSON.stringify(v)}`),v;const C={...g[1],maxFs:this.resolutionManager.getFrameSize(),maxBr:Math.min(m,g[1].maxBr),maxFps:g[1].maxFps},_=C.maxBr<S.maxBr||C.maxFs<S.maxFs||C.maxFs===S.maxFs&&C.maxFps<=S.maxFps,E=`Potential high layout: ${JSON.stringify(C)}`;return!this.hiFiLayout&&_?(this.logger.safe.debug(`High layout is already disabled. Do nothing. ${E}`),null):this.hiFiLayout&&_?(this.logger.safe.debug(`High layout gets disabled. ${E}`),null):(this.hiFiLayout&&deepEqual(C,this.hiFiLayout)?this.logger.safe.debug(`High layout has not been changed. Do nothing. ${E}`):this.hiFiLayout?this.logger.safe.debug(`High layout updated. ${E}`):this.logger.safe.debug(`High layout enabled. ${E}`),C)}getMinimalLayoutParams(g){const m=Math.min(g[0].maxBr,g[1].maxBr),S=this.configProvider.config.specCompliantSimulcast.maxBrControlEnabled?limitStreamMaxBitrate(m,this.totalBandwidth,this.configProvider.config.specCompliantSimulcast.bitrateToBweTable):m;return{...g[0],maxBr:S,maxFps:Math.min(g[0].maxFps,g[1].maxFps),maxFs:Math.min(g[0].maxFs,g[1].maxFs)}}},ky=class extends Oy{constructor(g,m,S){super(m,S,1),this.couldLimitFs=g}getLayouts(){return[this.layout]}recalculateLayouts(){let g=this.inputLayouts[0].maxFs;if(this.configProvider.config.specCompliantSimulcast.allowResLimit&&this.couldLimitFs&&this.totalBandwidthMax){const m=this.configProvider.config.specCompliantSimulcast.fsToBweTable;g=limitStreamMaxResolution(this.inputLayouts[0].maxFs,this.totalBandwidthMax,m)}const m=this.configProvider.config.specCompliantSimulcast.bitrateToBweTable,S=limitStreamMaxBitrate(this.inputLayouts[0].maxBr,this.totalBandwidth,m);this.layout={...this.inputLayouts[0],maxFs:g,maxBr:S}}},Ly=class extends je{constructor(g){super(g),this.logger=g,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),super.dispose()}setAvailableBandwidth(g){this.logger.safe.debug(`Available bandwidth updated ${g}`)}setLayouts(g,m){this.layouts=g,this.setAvailableBandwidth(m)}getLayouts(){return this.layouts}},Fy=class extends je{constructor(g,m,S,v){super(v),this.supportSingleBwControl=g,this.configProvider=S,this.logger=v,this.multiStream=!1,this.deferredOperation=new Ry((()=>this.updateStrategy()),this.configProvider.config.layoutControlTimeout,this.logger.createChild("DeferredOperation")),this.createStrategy(this.multiStream,m)}configure(g){const m=this.isMultiStream(g);this.multiStream!==m&&(this.multiStream=m,this.deferredOperation.invoke(this.multiStream&&!this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled))}setLayouts(g,m){deepEqual(this.latestLayouts,g)&&this.latestBandwidth===m?this.logger.safe.debug("Layouts and bandwidth are not changed. Skipping update"):(this.latestLayouts=g,this.latestBandwidth=m,this.strategy.setLayouts(this.latestLayouts,m))}setAvailableBandwidth(g){this.latestBandwidth!==g?(this.strategy.setAvailableBandwidth(g),this.latestBandwidth=g):this.logger.safe.debug("Bandwidth is not changed. Skipping update")}getLayouts(){return this.strategy.getLayouts()}dispose(){this.strategy.dispose(),this.strategy=null,this.deferredOperation.dispose(),this.deferredOperation=null,super.dispose()}updateStrategy(){this.strategy.dispose(),this.createStrategy(this.multiStream),this.latestLayouts&&this.strategy.setLayouts(this.latestLayouts,this.latestBandwidth)}isMultiStream(g){return g>1}createStrategy(g,m=!1){this.strategy=this.getNewStrategy(g,m),this.strategy.on("onLayoutsChanged",(()=>{this.event("onLayoutsChanged").raise()}))}getNewStrategy(g,m){return g?new Ny(this.configProvider,this.logger.createChild("BWEControlledStrategy")):this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled&&this.supportSingleBwControl?new ky(m,this.configProvider,this.logger.createChild("BWEControlledStrategySingle")):new Ly(this.logger.createChild("NoControlStrategy"))}},xy=class extends je{constructor(g,m,S){super(S),this.statisticsGatherer=g,this.configProvider=m,this.logger=S,this.bandwidthAllocator=null,this.bandwidthCalculator=new G_(this.configProvider,this.statisticsGatherer,this.logger.createChild("SendBandwidthCalculator")),this.layoutProviders=new Map,this.hadLayoutProvider=new Set,this.bandwidthAllocator=createBandwidthAllocatorPerMediaType(this.logger,this.configProvider),this.bandwidthCalculator.on("onSendBandwidthChanged",(g=>this.onAvailableBandwithChanged(g)))}dispose(){this.bandwidthCalculator?.dispose(),this.bandwidthCalculator=null,this.bandwidthAllocator=null,this.layoutProviders.forEach((g=>g.dispose())),this.layoutProviders.clear(),this.layoutProviders=null,super.dispose()}addReceiver(g,m){this.logger.safe.debug(`Set receiver max capabilities for ${g}: ${JSON.stringify(m)}`),this.configureProviders(g,m.length);const S=m.map((g=>g.maxBr)).reduce(((g,m)=>g+m));this.bandwidthAllocator.addReceiverCapabilty(g,S);const v=this.bandwidthAllocator.getLayouts();this.layoutProviders.get(g).setLayouts(m,v[g]),this.updateBandwidthDistribution()}removeReceiver(g){this.logger.safe.debug(`Removing receiver for ${g}`),this.layoutProviders.get(g)?.dispose(),this.layoutProviders.delete(g),this.bandwidthAllocator.removeReceiver(g),this.updateBandwidthDistribution()}getLayouts(g){return this.layoutProviders.get(g).getLayouts()}configureProviders(g,m){if(!this.layoutProviders.has(g)){const m=this.createProvider(g);this.layoutProviders.set(g,m)}this.layoutProviders.get(g).configure(m)}createProvider(g){const m=new Fy("Video"===g,!this.hadLayoutProvider.has(g),this.configProvider,this.logger.createChild(`LG:${g}`));return m.on("onLayoutsChanged",(()=>{const S=m.getLayouts();this.logger.safe.debug(`New layouts generated: ${JSON.stringify(S)}`),this.event("onLayoutsUpdated").raise(g)})),this.hadLayoutProvider.add(g),m}onAvailableBandwithChanged(g){this.bandwidthAllocator.setAvailableBandwidth(g),this.updateBandwidthDistribution()}updateBandwidthDistribution(){const g=this.bandwidthAllocator.getLayouts();for(const[m,S]of Object.entries(g))this.layoutProviders.get(m)?.setAvailableBandwidth(S)}},Uy=P,convertResolutionToFramesize=g=>Lp.Send.getResolutionForHeight(g).fs;function mergeCapabilitiesWithCallConstraints(g,m,S){if("Video"!==g||!S)return S;const{maxBitrate:v,maxResolution:C,maxFramerate:_}=m.config.outgoingVideoLimit??{},E=v??1/0,T=C?convertResolutionToFramesize(C):1/0,I=_??1/0;return E===1/0&&T===1/0&&I===1/0?S:S.map((g=>({...g,maxFs:getMinDefined(g.maxFs,T),maxBr:getMinDefined(g.maxBr,E),maxFps:getMinDefined(g.maxFps,I)})))}var Vy=class{constructor(g,m,S,v,C){this.sender=g,this.streamResolution=m,this.maxSimulcastLayerCount=S,this.logger=v,this.configProvider=C}async setCapabilities(g){if(!(0,Uy.isEqual)(this.currentCapabilities,g))return this.defaultCapabilities=(0,Uy.cloneDeep)(g),this.currentCapabilities=(0,Uy.cloneDeep)(g),await this.generateKeyFrameIfNeeded(g),this.applyCapabilities(g,0);this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}. Do nothing`)}async updateStreamQualityParams(g,m,S){if(g&&!(0,Uy.isEqual)(this.streamResolution,g))return this.logger.safe.debug(`Stream params changed: ${JSON.stringify(g)}@${m}`),this.streamResolution=g,this.applyCapabilities(this.currentCapabilities,S);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(g)}@${m}`)}async stop(){return this.logger.safe.info("Stopping senders."),this.deactivateSenders()}applyCallConstraints(g){return this.logger.safe.info(`[${g}] Applying call constraints`),this.currentCapabilities=mergeCapabilitiesWithCallConstraints(this.sender.mediaType,this.configProvider,this.defaultCapabilities),this.applyCapabilities(this.currentCapabilities,3)}getScaleFactor(g){const m=Lp.Send.getResolutionByFs(g),S=this.streamResolution;let v=Math.min(S.width,S.height)/m.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(S)} and new Fs: ${g} as ${v}`),v<1&&(this.logger.safe.error("Scale factor cannot be less than 1! Limiting to 1"),v=1),v}deactivateSenders(){const g=this.sender.rtpSender.getParameters();return g.encodings.forEach((g=>g.active=!1)),this.logger.safe.info(`Stopping senders. Encoding params to set: ${JSON.stringify(g.encodings)}`),this.sender.rtpSender.setParameters(g)}async generateKeyFrameIfNeeded(g){const m=this.sender.rtpSender.getParameters(),S=[];if(g.forEach((g=>{const v=this.getEncondingIndexForRid(g.rid,m.encodings),C=m.encodings[v];g.keyframe&&C.active?(this.logger.safe.info(`Keyframe is needed for encoder with index ${v}`),S.push(v)):this.logger.safe.info(`Keyframe is not needed for index ${v} because encoding is active: ${C.active} or KF is requested: ${g.keyframe}`)})),0===S.length)return void this.logger.safe.info("No keyframes needed. Skipping");const v=this.getParamsForKeyFrame(m,S);return this.logger.safe.info(`Applying keyframe encoding params new: ${JSON.stringify(v.encodings)}, old: ${JSON.stringify(m.encodings)}`),this.sender.rtpSender.setParameters(v)}async applyCapabilities(g,m){if(!g)return void this.logger.safe.info("Capabilities are not set. Do nothing");await this.applyStreamCapabilities(g,m);const S=this.sender.rtpSender.getParameters(),v=(0,Uy.cloneDeep)(S);return g.forEach((g=>{const m=this.getEncondingIndexForRid(g.rid,S.encodings);this.updateEncodingsWithCaps(S.encodings[m],g)})),this.updateActiveStates(S,g),this.logger.safe.info(`Encoding params new: ${JSON.stringify(S.encodings)}, old: ${JSON.stringify(v.encodings)}`),this.sender.rtpSender.setParameters(S)}async applyStreamCapabilities(g,m){if(!this.configProvider.config.specCompliantSimulcast?.video?.useApplyConstraints||2===m||!g.length||"Video"!==this.sender.mediaType)return;let S=g[0];for(const m of g)S.maxFs<m.maxFs&&(S=m);g.length>1&&(S=(0,Uy.cloneDeep)(S),S.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,S.maxFs)),this.streamResolution=await this.sender.applyStreamCapabilities(S)}getEncondingIndexForRid(g,m){if(!g)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const S=m.findIndex((m=>m.rid===g));return S<0||S-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):S}updateEncodingsWithCaps(g,m){g?(g.maxBitrate=m.maxBr,g.scaleResolutionDownBy=this.getScaleFactor(m.maxFs),g.maxFramerate=m.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(m)}`)}updateActiveStates(g,m){const S=g.encodings.map((g=>g.rid)),v=S.filter((g=>m.some((m=>g===m.rid)))),C=subtractFrom(S,v);v.forEach((m=>this.changeEncodingState(g,m,!0))),C.forEach((m=>this.changeEncodingState(g,m,!1)))}changeEncodingState(g,m,S){const v=g.encodings.find((g=>g.rid===m));v?v.active=S:this.logger.safe.error(`Encoding not found for RID: ${m}`)}getParamsForKeyFrame(g,m){const S=(0,Uy.cloneDeep)(g);return m.forEach((g=>{S.encodings[g].active&&S.encodings[g].scaleResolutionDownBy&&(S.encodings[g]=this.getEncodingParamsForKeyFrame(S.encodings[g]))})),S}getEncodingParamsForKeyFrame(g){const m=(0,Uy.cloneDeep)(g);return m.scaleResolutionDownBy&&(m.scaleResolutionDownBy=1.1*g.scaleResolutionDownBy),m}},By=class{constructor(g,m,S){this.sender=g,this.logger=m,this.configProvider=S}applyCallConstraints(g){this.logger.safe.info(`[${g}] Applying call constraints`);const m=mergeCapabilitiesWithCallConstraints(this.sender.mediaType,this.configProvider,this.currentCapabilities);return this.setCapabilities(m)}async setCapabilities(g){if(0===g.length||1!==g.length)return void this.logger.safe.error("Incorrect number of sender params!");this.currentCapabilities=g;const m=this.currentCapabilities?.find((g=>"1"===g.rid))??this.currentCapabilities?.[0];await this.sender.setParameters(m),await this.sender.start()}updateStreamQualityParams(g,m,S){return this.sender.updateStreamQualityParams(g,m,S)}async stop(){await this.sender.stop()}},Hy=P,$y=class{constructor(g,m){this.configProvider=g,this.logger=m}async setActive(g,m){const S=this.getSenderParameters(g);return S.encodings[0].active=m,this.setSenderParameters(g,S,"setActive")}getScaleFactor(g,m){if(!m.width||!m.height)return this.logger.safe.warn("Stream resolution is not set yet. Cannot calculate scale factor. Returning 1"),1;const S=Lp.Send.getResolutionByFs(g);let v=Math.min(m.width,m.height)/S.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(m)} and new Fs: ${g} as ${v}`),v<1&&(this.logger.safe.warn("Scale factor cannot be less than 1! Limiting to 1"),v=1),v}async generateKeyFrameIfNeeded(g,m){if(!m.track)return void this.logger.safe.info("No track attached. Skipping");const S=this.getSenderParameters(m),v=g.filter((g=>g.keyframe)).map((g=>g.rid));if(0===v.length||!S.encodings.some((g=>g.active)))return void this.logger.safe.info("No keyframes needed. Skipping");const C=S.encodings.map(((g,m)=>g.active?g.rid&&!v.includes(g.rid)?null:{idx:m,factor:g.scaleResolutionDownBy||1}:null)).filter((g=>g));for(const g of C)S.encodings[g.idx].scaleResolutionDownBy=g.factor*this.configProvider.config.forceKeyFrameV2ScaleFactor;this.logger.safe.debug(`Restoring keyframe starting. Update scaleResolutionDownBy for encodings: ${JSON.stringify(S.encodings)}`),await this.setSenderParameters(m,S,"generateKeyFrameStart");const _=this.getSenderParameters(m);for(const g of C)_.encodings[g.idx].scaleResolutionDownBy=g.factor;await this.setSenderParameters(m,_,"generateKeyFrameEnd"),this.logger.safe.debug(`Restoring keyframe completed. Set scaleResolutionDownBy back for encodings: ${JSON.stringify(_.encodings)}`)}getSenderParameters(g){const m=g.getParameters();if(m.encodings?.length||(m.encodings=[{}]),this.configProvider.config.reuseLastSetParameters&&this.lastSetEncodings){this.logger.safe.info(`Override returned encodings ${JSON.stringify(m.encodings)}`);const g=(0,Hy.merge)((0,Hy.cloneDeep)(m.encodings),this.lastSetEncodings);this.logger.safe.info(`Overrided encodings ${JSON.stringify(g)}`),m.encodings=g}return m}async setSenderParameters(g,m,S,v=!0){try{await g.setParameters(m),this.logger.safe.info(`${S}: Parameters applied for sender: ${JSON.stringify(m.encodings)}`),this.lastSetEncodings=m.encodings}catch(g){const C=`${S}: setParameters failed. Parameters: ${JSON.stringify(m.encodings)}, error:  ${stringifyObject(g)}`;if(this.logger.safe.error(C),v)throw new Error(C)}}getAdjustedBitrate(g,m){let S=g||0;const v=Lp.Send.getResolutionRecord(m.width,m.height);return S=Math.min(S||v.maxBitrate,v.maxBitrate),S}async updateStreamParameters(g,m,S){if(g.getCurrentConstraints().withEffect&&m?.maxFs){const S=Lp.Send.getResolutionByFs(m.maxFs),v={width:S.width,height:S.height};this.logger.safe.info(`Applying video constrains for video effetcs ${JSON.stringify(v)}`),g.resetEffectsOutputConstraints(v)}S&&await g.applyCapabilities(m)}},Gy=class{constructor(g,m,S){this.maxSimulcastLayerCount=g,this.configProvider=m,this.logger=S,this.capabiltiesHelper=new $y(this.configProvider,this.logger)}setSender(g){this.rtpSender=g}updateStream(g){this.stream=g,this.streamResolution=g.getResolution()}setActive(g){return this.capabiltiesHelper.setActive(this.rtpSender,g)}async setCapabilities(g){(0,Hy.isEqual)(this.currentCapabilities,g)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}. Do nothing`):(this.defaultCapabilities=(0,Hy.cloneDeep)(g),this.currentCapabilities=(0,Hy.cloneDeep)(g),await this.applyLastCapabilities(),await this.capabiltiesHelper.generateKeyFrameIfNeeded(g,this.rtpSender))}async updateStreamQualityParams(g,m,S){if(g&&!(0,Hy.isEqual)(this.streamResolution,g))return this.streamResolution=g,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(g)}@${m}`),this.applyLastCapabilities();this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(g)}@${m}`)}async startSender(){}async stopSender(){this.logger.safe.info("Stopping senders.");const g=this.capabiltiesHelper.getSenderParameters(this.rtpSender);return g.encodings.forEach((g=>g.active=!1)),this.capabiltiesHelper.setSenderParameters(this.rtpSender,g,"Stopping senders")}async applyLastCapabilities(){if(!this.currentCapabilities)return void this.logger.safe.info("Capabilities are not set. Do nothing");this.currentCapabilities=mergeCapabilitiesWithCallConstraints(this.stream.mediaType,this.configProvider,this.defaultCapabilities),await this.applyStreamCapabilities(this.currentCapabilities);const g=this.capabiltiesHelper.getSenderParameters(this.rtpSender),m=(0,Hy.cloneDeep)(g);return this.currentCapabilities.forEach((m=>{const S=this.getEncondingIndexForRid(m.rid,g.encodings);this.updateEncodingsWithCaps(g.encodings[S],m)})),this.updateActiveStates(g,this.currentCapabilities),this.logger.safe.info(`Encoding params new: ${JSON.stringify(g.encodings)}, old: ${JSON.stringify(m.encodings)}`),this.capabiltiesHelper.setSenderParameters(this.rtpSender,g,"applyCapabilities")}async applyCallConstraints(g){return this.logger.safe.info(`[${g}] Applying call constraints`),this.applyLastCapabilities()}async applyStreamCapabilities(g){if("Video"!==this.stream.mediaType||!g.length)return;let m=g[0];for(const S of g)m.maxFs<S.maxFs&&(m=S);g.length>1&&(m=(0,Hy.cloneDeep)(m),m.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,m.maxFs));const S=this.configProvider.config.specCompliantSimulcast.video.useApplyConstraints;await this.capabiltiesHelper.updateStreamParameters(this.stream,m,S),S&&(this.streamResolution=this.stream.getResolution())}getEncondingIndexForRid(g,m){if(!g)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const S=m.findIndex((m=>m.rid===g));return S<0||S-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):S}updateEncodingsWithCaps(g,m){g?(g.maxBitrate=m.maxBr,g.scaleResolutionDownBy=this.capabiltiesHelper.getScaleFactor(m.maxFs,this.streamResolution),g.maxFramerate=m.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(m)}`)}updateActiveStates(g,m){const S=g.encodings.map((g=>g.rid)),v=S.filter((g=>m.some((m=>g===m.rid)))),C=subtractFrom(S,v);v.forEach((m=>this.changeEncodingState(g,m,!0))),C.forEach((m=>this.changeEncodingState(g,m,!1)))}changeEncodingState(g,m,S){const v=g.encodings.find((g=>g.rid===m));v?v.active=S:this.logger.safe.error(`Encoding not found for RID: ${m}`)}},jy=class{constructor(g,m){this.configProvider=g,this.logger=m,this.capabiltiesHelper=new $y(this.configProvider,this.logger)}get params(){return this.currentCapabilities?.find((g=>"1"===g.rid))??this.currentCapabilities?.[0]}async applyCallConstraints(g){return this.logger.safe.info(`[${g}] Applying call constraints`),this.applyLastCapabilities(3)}setSender(g){this.rtpSender=g}updateStream(g){this.stream=g,this.streamResolution=g.getResolution()}setActive(g){return this.capabiltiesHelper.setActive(this.rtpSender,g)}async setCapabilities(g){(0,Hy.isEqual)(this.currentCapabilities,g)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}. Do nothing`):1===g.length?(this.defaultCapabilities=(0,Hy.cloneDeep)(g),this.currentCapabilities=(0,Hy.cloneDeep)(g),await this.applyLastCapabilities(0),await this.capabiltiesHelper.generateKeyFrameIfNeeded(g,this.rtpSender)):this.logger.safe.error("Incorrect number of sender params!")}async updateStreamQualityParams(g,m,S){if(g&&!(0,Hy.isEqual)(this.streamResolution,g))return this.streamResolution=g,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(g)}@${m}`),this.applyLastCapabilities(S);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(g)}@${m}`)}async startSender(g){this.logger.safe.info(`Replace sender with track: ${g.id}`),await this.rtpSender.replaceTrack(g),this.logger.safe.info("replaceTrack completed"),this.configProvider.config.applySenderParamsBeforeStart&&this.currentCapabilities&&await this.capabiltiesHelper.generateKeyFrameIfNeeded(this.currentCapabilities,this.rtpSender)}async stopSender(){this.logger.safe.info("Replace sender with track: null"),await this.rtpSender.replaceTrack(null),this.logger.safe.info("replaceTrack completed")}async applyLastCapabilities(g){this.currentCapabilities?(this.currentCapabilities=mergeCapabilitiesWithCallConstraints(this.stream.mediaType,this.configProvider,this.defaultCapabilities),this.logger.safe.info(`Applying params: ${JSON.stringify(this.params)}`),await this.applyParams(this.params,g),await this.applyBitrate(this.params.maxBr)):this.logger.safe.debug("Capabilities are not yet set, nothing to apply")}applyBitrate(g){let m=g||0;return"Video"===this.stream.mediaType&&(m=this.capabiltiesHelper.getAdjustedBitrate(m,this.streamResolution)),this.setSingleEncodingParameters(this.rtpSender,{maxBitrate:m},"applyBitrate",!1)}async applyParams(g,m){if(this.configProvider.config.useSetParametersToApplyCapabilities)return this.setSingleEncodingParameters(this.rtpSender,{scaleResolutionDownBy:this.capabiltiesHelper.getScaleFactor(g.maxFs,this.streamResolution),maxFramerate:g.maxFps},"applyParams");2!==m&&await this.capabiltiesHelper.updateStreamParameters(this.stream,g,!0)}async setSingleEncodingParameters(g,m,S,v=!0){const C=this.capabiltiesHelper.getSenderParameters(g);return(0,Hy.merge)(C.encodings[0],m),0===C.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?C.encodings[0].maxBitrate=void 0:delete C.encodings[0].maxBitrate),this.capabiltiesHelper.setSenderParameters(this.rtpSender,C,S,v)}},qy=class{constructor(g,m,S){this.transitionStates=g,this.logger=S,this.stateInternal=m}get state(){return this.stateInternal}isDestinationStateValid(g){return this.transitionStates[this.stateInternal].indexOf(g)>-1}setState(g){return this.isDestinationStateValid(g)?(this.stateInternal=g,!0):(this.logger.safe.info(`Invalid state transition ${this.stateInternal} -> ${g}`),!1)}isCurrentStateMatchedWith(g){return this.stateInternal===g||(this.logger.safe.info(`State does not match. Current: ${this.stateInternal} required: ${g}`),!1)}},Wy=P,zy=class{constructor(g,m=document.body){this.logger=g,this.parentElement=m,this.container=this.createContainerElement(),this.video=this.createVideoElement(),this.canvas=this.createCanvasElement(),this.context=this.canvas.getContext("2d"),this.medaiQuery=window.matchMedia("(orientation: portrait)"),this.isPortrait=this.medaiQuery.matches,this.captureFrameRate=30,this.mediaQueryChangeListener=g=>{this.isPortrait=g.matches},this.container.append(this.video,this.canvas),this.parentElement.prepend(this.container),this.medaiQuery.addEventListener("change",this.mediaQueryChangeListener)}modify(g){this.logger.safe.info("modify()"),this.clearAnimationFrames(),this.disposeStream(),this.stream=this.canvas.captureStream(this.captureFrameRate),this.video.srcObject=new MediaStream([g]),this.video.play();let m=g.getSettings(),S=0,v=0;const requestFrame=()=>{m=g.getSettings();const C=this.isPortrait?Math.min(m.width,m.height):Math.max(m.width,m.height),_=this.isPortrait?Math.max(m.width,m.height):Math.min(m.width,m.height);S===C&&v===_||(this.canvas.width=C,this.canvas.height=_,S=C,v=_),this.context.drawImage(this.video,0,0,C,_),this.animationFrame=requestAnimationFrame(requestFrame)};return this.animationFrame=requestAnimationFrame(requestFrame),this.stream.getVideoTracks()[0]}dispose(){this.logger.safe.info("dispose()"),this.clearAnimationFrames(),this.disposeStream(),this.container.parentElement.removeChild(this.container),this.medaiQuery.removeEventListener("change",this.mediaQueryChangeListener)}disposeStream(){this.stream&&(this.stream.getTracks().forEach((g=>g.stop())),this.stream=void 0)}createContainerElement(){const g=document.createElement("div");return g.style.opacity="0",g.style.position="fixed",g.style.zIndex="-2147483648",g.style.pointerEvents="none",g.style.top="0",g.style.left="0",g.style.bottom="0",g.style.right="0",g}createVideoElement(){const g=document.createElement("video");return g.setAttribute("muted",""),g.setAttribute("playsinline",""),g.setAttribute("autoplay",""),g.style.top="0",g.style.left="0",g}createCanvasElement(){const g=document.createElement("canvas");return g.style.right="0",g.style.bottom="0",g}clearAnimationFrames(){this.logger.safe.info("clearAnimationFrames()"),this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0)}},Ky=class extends je{constructor(g){super(g),this.logger=g,this.audioContext=new Us.window.AudioContext,this.destination=this.audioContext.createMediaStreamDestination(),this.streamNodeMap=new Map,this.logger.safe.info(`Destination stream: ${this.destination.stream.id}, track: ${this.getDestinationTrack().id}`),this.subscribeOnMediaTrackEvents(this.getDestinationTrack())}get numberOfStreams(){return this.streamNodeMap.size}addSourceStream(g){if(!g.rawStream)return;if(this.streamNodeMap.has(g.rawStream))return;const m=g.on("onStreamClientDisposing",(()=>{this.removeSourceStream(g.rawStream),m.dispose()}));this.logger.safe.info(`Add stream: ${g.rawStream.id}, track: ${getTrack(g.rawStream).id}`),this.addStream(g.rawStream,g.mediaType)}getDestinationTrack(){return getTrack(this.destination.stream)}dispose(){super.dispose(),this.unsubscribeFromMediaTrackEvents(this.getDestinationTrack());for(const g of this.streamNodeMap.keys())this.removeSourceStream(g);this.audioContext.close(),this.audioContext=null}addStream(g,m="Audio"){const S=this.audioContext.createMediaStreamSource(g);S.connect(this.destination),this.streamNodeMap.set(g,{mediaType:m,sourceNode:S})}removeSourceStream(g){const m=this.streamNodeMap.get(g);m&&(this.logger.safe.info(`Remove stream: ${g.id}, track: ${getTrack(g).id}`),m.sourceNode.disconnect(),this.streamNodeMap.delete(g))}subscribeOnMediaTrackEvents(g){g.onended=m=>{this.logger.safe.info(`Track ${g.id} ended: ${JSON.stringify(m)}`)},g.onmute=()=>{this.logger.safe.info(`Track ${g.id} muted`)},g.onunmute=()=>{this.logger.safe.info(`Track ${g.id} unmuted`)}}unsubscribeFromMediaTrackEvents(g){g.onended=null,g.onmute=null,g.onunmute=null}};function getTrack(g){return g.getAudioTracks()[0]}var Jy=class{constructor(g){this.logger=g}createBaseInstanse(g){this.imp=new Yy,g.addTransform(this.imp)}createWorkerInstanse(g,m){this.imp=new Qy(g,m)}mute(g){this.logger.safe.info(`Dropping audio chunks: ${g}`),this.imp.mute(g)}},Yy=class{constructor(){this.transformType=1,this.muted=!1}transform(g){return this.muted?null:g}mute(g){this.muted=g}dispose(){}},Qy=class extends sy{constructor(g,m){super(g,m,1,void 0)}mute(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"mute",args:[g]}})}},Xy=class extends je{constructor(g,m,S,v,C,_){super(),this.mediaConnection=g,this.contextStream=S,this.logger=v,this.configProvider=C,this.encStreamsManager=_,this.isActive=!1,this.isMuted=!1,this.configProvider.config.renderThroughCanvas&&(this.videoThroughCanvas=new zy(this.logger.createChild("videoThroughCanvas"))),this.stream=m.clone("streamSender ctor"),this.streamResolution=this.stream.getResolution()}get rtpSender(){return this.sender}get trackId(){const g=this.rawTrack;return g?.id}get mediaType(){return this.stream.mediaType}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get canvasedRawTrack(){return this.configProvider.config.renderThroughCanvas?"Video"!==this.stream.mediaType?this.rawTrack:this.videoThroughCanvas?.modify(this.rawTrack)??this.rawTrack:this.rawTrack}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms()}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.wakeSender(),this.params&&await this.applyParams(this.params,0),this.logger.safe.info("Started"))}async stop(){if(this.isActive){if(this.logger.safe.info("Stopping"),this.isActive=!1,"Audio"!==this.stream.mediaType){const g=this.configProvider.config.webrtcDisabledSenderBitrate;await this.applyBitrate(g,!1)}await this.sleepSender(),this.logger.safe.info("Stopped")}else this.logger.safe.info("Already stopped. Do nothing")}setMuted(g,m,S){this.isMuted=g,this.stream.setMuted(g,m),g&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(g),!this.configProvider.config.requestNewStreamOnUnmute||g||S||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(g,m){return this.activateSender(!g,m)}async setMainStream(g){if(this.stream.dispose(),this.stream=g.clone("streamSender setMainStream"),this.streamResolution=this.stream.getResolution(),this.stream.setMuted(this.isMuted),this.params&&await this.applyCapabilities(this.params,1),this.audioMixer?.addSourceStream(this.stream),this.isActive){const g=this.rawTrack?.id;this.logger.safe.info(`Replace sender with track: ${g}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Replace completed")}}async addAdditionalStream(g){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(g),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}async setParameters(g,m=!1,S=0){if(m||this.params!==g){if(this.params=g,this.isActive)return this.applyParams(this.params,S);this.logger.safe.info("Sender is not active, preserving params")}}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((g=>g.active)).map((g=>+g.rid))}async updateStreamQualityParams(g,m,S){if(this.configProvider.config.useSetParametersToApplyCapabilities)if(g){if(this.logger.safe.debug(`Stream resolution has changed to ${JSON.stringify(g)}@${m}, re-applying send parameters`),this.streamResolution=g,this.params)return this.setParameters(this.params,!0,S);this.logger.safe.debug("Params are not yet set, do nothing")}else this.logger.safe.debug(`Resolution is not defined: ${JSON.stringify(g)}@${m}`)}async applyStreamCapabilities(g){return await this.stream.applyCapabilities(g),this.stream.getResolution()}async applyParams(g,m){this.logger.safe.info(`Applying params: ${JSON.stringify(g)}`),await this.applyCapabilities(g,m),await this.applyBitrate(g.maxBr),this.params.keyframe&&await this.forceKeyframe()}applyBitrate(g,m=!0){const S=m?this.getAdjustedBitrate(g):g;return this.setEncodingParameters({maxBitrate:S},"applyBitrate")}getAdjustedBitrate(g){let m=g||0;if("Video"===this.stream.mediaType){const g=Lp.Send.getResolutionRecord(this.streamResolution.width,this.streamResolution.height);m=Math.min(m||g.maxBitrate,g.maxBitrate)}return m}async activateSender(g,m){await this.setEncodingParameters({active:g},"activateSender"),this.logger.safe.info(`[${m}] Active state applied isActive = ${g}`)}async forceKeyframe(){if(!this.sender)return this.logger.safe.error("No sender available"),null;if(!this.sender.track)return void this.logger.safe.info("Sender track does not exist, not restoring keyframe");this.logger.safe.info("Restoring keyframe starting");const g=this.getSenderParameters().encodings[0].scaleResolutionDownBy||1;await this.setEncodingParameters({scaleResolutionDownBy:g*this.configProvider.config.forceKeyFrameV2ScaleFactor},"forceKeyframe start"),await this.setEncodingParameters({scaleResolutionDownBy:g},"forceKeyframe end"),this.logger.safe.info("Restoring keyframe finished")}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.canvasedRawTrack,this.contextStream,mediaTypeToModality(this.stream.mediaType))}async wakeSender(){this.logger.safe.info("Wake started"),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Wake completed")}async sleepSender(){this.logger.safe.info("Sleep started"),await this.sender.replaceTrack(null),this.logger.safe.info("Sleep completed")}addStreamTransforms(){const g=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);g&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new Jy(this.logger.createChild("SendAudioPayload")),g.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&g.addTransform(new ly(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new Ky(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const g=this.sender.getParameters();return g.encodings?.length||(g.encodings=[{}]),g}async setEncodingParameters(g,m,S=!1){const v=this.getSenderParameters();(0,Wy.merge)(v.encodings[0],g),0===v.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?v.encodings[0].maxBitrate=void 0:delete v.encodings[0].maxBitrate);try{await this.sender.setParameters(v),this.logger.safe.info(`${m}: Parameters applied for sender: ${JSON.stringify(v.encodings[0])}`)}catch(g){if(this.logger.safe.error(`${m}: setParameters failed: ${stringifyObject(g)}, parameters ${JSON.stringify(v.encodings[0])}`),S)throw g}}async applyCapabilities(g,m){this.configProvider.config.useSetParametersToApplyCapabilities?await this.setEncodingParameters({scaleResolutionDownBy:this.getScaleFactor(g.maxFs),maxFramerate:g.maxFps},"applyCapabilities",!0):2!==m&&await this.applyStreamCapabilities(g)}getScaleFactor(g){const m=Lp.Send.getResolutionByFs(g),{width:S,height:v}=this.streamResolution,C=Math.min(S,v)/m.height;return this.logger.safe.debug(`Current stream resolution: ${S}x${v}, scale factor: ${C}`),C<1?(this.logger.safe.warn(`Resolution scale factor is less than 1: ${C}`),1):C}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.stream=null,this.isActive=!1,this.videoThroughCanvas?.dispose()}},Zy=class extends je{constructor(g,m,S,v,C,_,E){super(),this.mediaConnection=g,this.contextStream=S,this.logger=v,this.configProvider=C,this.encStreamsManager=_,this.capabilitiesManager=E,this.isActive=!1,this.isMuted=!1,this.stream=m.clone("streamSender ctor"),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.updateStream(this.stream)}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get trackId(){const g=this.rawTrack;return g?.id}get rtpSender(){throw new Error("rtpSender getter not implemented.")}get mediaType(){throw new Error("mediaType getter not implemented.")}setParameters(g){throw new Error("setParameters not implemented.")}applyStreamCapabilities(g){throw new Error("applyStreamCapabilities not implemented.")}applyCallConstraints(g){return this.capabilitiesManager.applyCallConstraints(g)}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms(),this.capabilitiesManager.setSender(this.sender)}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.capabilitiesManager.startSender(this.rawTrack),this.logger.safe.info("Started"))}async stop(){this.isActive?(this.logger.safe.info("Stopping"),this.isActive=!1,await this.capabilitiesManager.stopSender(),this.logger.safe.info("Stopped")):this.logger.safe.info("Already stopped. Do nothing")}async setCapabilities(g){this.configProvider.config.applySenderParamsBeforeStart||await this.start(),await this.capabilitiesManager.setCapabilities(g),await this.start()}updateStreamQualityParams(g,m,S){return this.capabilitiesManager.updateStreamQualityParams(g,m,S)}setMuted(g,m,S){this.isMuted=g,this.stream.setMuted(g,m),g&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(g),!this.configProvider.config.requestNewStreamOnUnmute||g||S||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(g,m){if(this.configProvider.config.holdSkipActivation)return;const S=!g;this.logger.safe.info(`[${m}] change isActive state to ${S}`);try{return this.capabilitiesManager.setActive(S)}catch(g){const v=this.configProvider.config.holdRetryActivationDelay;if(v>=0)return this.logger.safe.info(`[${m}] retrying after delay of ${v}`),await delay(v),this.logger.safe.info(`[${m}] change isActive state to ${S}, second attempt`),this.capabilitiesManager.setActive(S);throw g}}async setMainStream(g){return this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=g.clone("streamSender setMainStream"),this.stream.setMuted(this.isMuted),this.audioMixer?.addSourceStream(this.stream),this.isActive&&(this.logger.safe.info(`Replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("Replace completed")),this.capabilitiesManager.updateStream(this.stream),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.applyLastCapabilities(1)}async addAdditionalStream(g){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(g),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((g=>g.active)).map((g=>+g.rid))}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.rawTrack,this.contextStream,mediaTypeToModality(this.stream.mediaType))}addStreamTransforms(){const g=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);g&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new Jy(this.logger.createChild("SendAudioPayload")),g.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&g.addTransform(new ly(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new Ky(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const g=this.sender.getParameters();return g.encodings?.length||(g.encodings=[{}]),g}subscribeOnStreamClientMuted(){this.configProvider.config.recoverOnStreamUnmute&&(this.onStreamClientMutedSubscription=this.stream.on("onStreamClientMuted",(async(g,m)=>{m||await this.capabilitiesManager.applyLastCapabilities(1)})))}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=null,this.isActive=!1}},eE=class _SimulcastStreamSender extends je{constructor(g,m,S,v,C,_,E,T,I,b){super(),this.mediaConnection=g,this.mainStream=m,this.contextStream=S,this.mediaType=v,this.serialQueue=C,this.logger=_,this.configProvider=E,this.isAlwaysActive=T,this.encStreamsManager=I,this.simulcastContext=b,this.isMuted=!1,this.isHold=!1,this.previousParameters=[],this.state=new qy(_SimulcastStreamSender.transitionStates,"NotStarted",this.logger),this.pendingStream=null,this.pendingParams=null,this.subscribeOnQualityUpdates(this.mainStream)}async start(){this.state.setState("Started")&&(this.sender=this.createSenderModel(),await this.sender.init(),this.notifyMaxVideoSendCapabilitiesChanged(),this.configProvider.config.deactiveAudioSender&&"Audio"===this.mediaType&&await this.sender.stop(),this.subscribeForSenderEvents())}async activate(){this.state.setState("Active")&&(this.pendingStream&&(await this.updateStreamInternal(this.pendingStream),this.pendingStream=null),this.isAlwaysActive&&!this.isMuted&&"Audio"===this.mediaType&&await this.sender.start(),this.isAlwaysActive?(this.event("onSendersChanged").raise(this,!0),this.logger.safe.info("Sender set to always active. Do not stopping")):await this.capabilitiesManager.stop(),this.configProvider.config.enableCachingFMTP&&this.pendingParams&&(this.logger.safe.info("Apply pending parameters"),await this.updateParametersInternal(this.pendingParams),this.pendingParams=null))}updateStream(g){return this.updateStreamInternal(g)}async addAdditionalStream(g){return this.sender.addAdditionalStream(g)}async updateParameters(g){if(this.state.isCurrentStateMatchedWith("Active"))return this.updateParametersInternal(g);this.configProvider.config.enableCachingFMTP?(this.logger.safe.info("Postpone params update until sender is activated"),this.pendingParams=g):this.logger.safe.warn("Ignore params update as sender is not activate")}async terminateAsync(){this.state.setState("Disposed")&&(this.logger.safe.info("Terminating async"),await this.sender.terminateAsync(),this.cleanUp())}dispose(){this.state.setState("Disposed")&&(this.logger.safe.info("Disposing"),this.sender.dispose(),this.cleanUp())}async setHold(g,m){if(this.isHold!==g)return this.logger.safe.info(`[${m}] Setting hold to: ${g}`),this.isHold=g,this.sender.setHold(g,m);this.logger.safe.info(`[${m}] Already in hold=${g} state`)}setMuted(g,m,S){this.logger.safe.info(`[${m}] Setting muted to: ${g}`),this.isMuted=g,this.sender.setMuted(this.isMuted,m,S),!this.isMuted&&"Audio"===this.mediaType&&this.state.isCurrentStateMatchedWith("Active")&&this.sender.start()}getActiveStreamIndexes(){return this.sender?this.sender.getActiveStreamIndexes():[]}getTrackInfo(){return{modality:mediaTypeToModality(this.mediaType),trackId:this.sender.trackId}}applyCallConstraints(g){return this.capabilitiesManager.applyCallConstraints(g)}createSenderModel(){if(this.configProvider.config.useSenderV2){const g=new Zy(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("SenderV2"),this.configProvider,this.encStreamsManager,this.getCapabilitiesManagerV2(this.simulcastContext));return this.capabilitiesManager=g,g}const g=new Xy(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("Sender"),this.configProvider,this.encStreamsManager);return this.capabilitiesManager=this.getCapabilitiesManager(g,this.simulcastContext),g}subscribeForSenderEvents(){this.sender.on("onNewStreamNeeded",(()=>this.event("onNewStreamNeeded").raise()))}getCapabilitiesManager(g,m){return m?.shouldUseSimulcast()?new Vy(g,this.mainStream.getResolution(),m.config.layerScaleFactors.length,this.logger.createChild("SimCapMgr"),this.configProvider):new By(g,this.logger.createChild("SnglCapMgr"),this.configProvider)}getCapabilitiesManagerV2(g){return g?.shouldUseSimulcast()?new Gy(g.config.layerScaleFactors.length,this.configProvider,this.logger.createChild("SimCapMgrV2")):new jy(this.configProvider,this.logger.createChild("SnglCapMgrV2"))}async updateStreamInternal(g){return this.state.isCurrentStateMatchedWith("Active")?this.mainStream!==g?(this.logger.safe.debug(`Switching streams: ${this.mainStream.parentId}:${this.mainStream.id} -> ${g.parentId}:${g.id}`),this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=g,this.subscribeOnQualityUpdates(this.mainStream),this.notifyMaxVideoSendCapabilitiesChanged(),await this.sender.setMainStream(this.mainStream),this.capabilitiesManager.updateStreamQualityParams(this.mainStream.getResolution(),this.mainStream.getFrameRate(),1)):void this.logger.safe.info("Stream has not been changed. Skipping update"):(this.logger.safe.info("Postponing stream update until sender is activated"),void this.setPendingStream(g))}async updateParametersInternal(g){await this.capabilitiesManager.setCapabilities(g),compareArraysBy(this.previousParameters,g,((g,m)=>g.ssrc===m.ssrc))||(this.previousParameters=g,this.event("onSendersChanged").raise(this,!0))}setPendingStream(g){this.pendingStream=g;const m=g.on("onStreamClientDisposing",(()=>{this.pendingStream===g&&(this.pendingStream=null,m.dispose())}))}subscribeOnQualityUpdates(g){this.sub=g.on("onStreamQualityChanged",((g,m,S,v)=>this.updateStreamQualityParams(m,S,v)))}updateStreamQualityParams(g,m,S){return S===Fn.EffectQualityChangeReason.Performance&&this.notifyMaxVideoSendCapabilitiesChanged({resolution:g,fps:m}),this.capabilitiesManager.updateStreamQualityParams(g,m,2)}unsubscribeFromQualityEvents(){this.sub?.dispose(),this.sub=null}notifyMaxVideoSendCapabilitiesChanged(g){if(!["Video","ScreenShare"].includes(this.mediaType))return;const{width:m,height:S}=g?.resolution??this.mainStream.getResolution(),v=g?.fps??this.mainStream.getFrameRate();if(!m||!S||!v)return;const C=new Np(m,S),_={maxFs:C.fs,maxMbps:C.fs*v,maxFps:v,maxWidth:C.width,maxHeight:C.height};this.logger.safe.info(`Capabilities for ${this.mediaType} stream: ${JSON.stringify(_)}`),this.event("onMaxVideoSendCapabilitiesChanged").raise(_)}cleanUp(){this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=null,this.pendingStream&&this.pendingStream.dispose(),this.pendingStream=null,this.sender=null,this.contextStream=null,this.event("onSendersChanged").raise(this,!1),super.dispose()}};eE.transitionStates={NotStarted:["Started","Disposed"],Started:["Active","Disposed"],Active:["NotStarted","Disposed"],Disposed:[]},__decorateClass([sequentialize()],eE.prototype,"start",1),__decorateClass([sequentialize()],eE.prototype,"activate",1),__decorateClass([sequentialize()],eE.prototype,"updateStream",1),__decorateClass([sequentialize()],eE.prototype,"addAdditionalStream",1),__decorateClass([sequentialize()],eE.prototype,"updateParameters",1),__decorateClass([sequentialize()],eE.prototype,"terminateAsync",1),__decorateClass([sequentialize()],eE.prototype,"setHold",1),__decorateClass([sequentialize()],eE.prototype,"updateStreamQualityParams",1);var tE=eE,iE=class extends je{constructor(g,m,S,v,C,_,E,T){super(m),this.mediaManager=g,this.logger=m,this.callDeviceManager=S,this.configProvider=v,this.statisticsGatherer=C,this.diagnostics=_,this.isMultiparty=E,this.encStreamsManager=T,this.senders=new Map,this.previousMediaModalitites={Audio:!1,Video:!1,ScreenShare:!1},this.serialQueue=new Ap(this.logger),this.muted=new Map([["Audio",!1],["Video",!1]]),this.subs=new Map,this.senderId=0,this.callConstraintsCauseId=void 0,this.streamsProvider=new Ey(S,v,this.serialQueue,this.logger.createChild("StreamsProvider")),this.subscribeToStreamProviderEvents(),this.localVideoStreamWatcher=new Y_(C,this.logger,this.configProvider,this.callDeviceManager),this.subscribeToStreamWatcherEvents(),this.configProvider.config.useMediaQualityController&&(this.mediaQualityController=new xy(this.statisticsGatherer,this.configProvider,this.logger.createChild("MQC")),this.mediaQualityController.on("onLayoutsUpdated",(g=>this.updateLayouts(g))))}dispose(){this.senders.forEach(((g,m)=>{this.event("onSendStreamChanged").raise(null,m),this.configProvider.config.disposeSendersSync?g.dispose():g.terminateAsync()})),this.senders.clear(),this.subs.forEach((g=>g.forEach((g=>g.dispose())))),this.subs.clear(),this.mediaConnection=null,this.unsubscribeFromStreamProviderEvents(),this.configProvider.config.disposeStreamsSync?this.streamsProvider.stop():this.streamsProvider.stopAsync(),this.streamsProvider=null,this.localVideoStreamWatcherSubs?.dispose(),this.localVideoStreamWatcher?.dispose(),this.localVideoStreamWatcher=null,this.mediaManager=null,this.logger=this.logger.createChild("DISPOSED"),this.mediaQualityController?.dispose(),this.mediaQualityController=null,super.dispose()}registerRtpSenderManager(g){this.mediaConnection=g}useNullAudioStreamClient(){this.streamsProvider.useNullAudioStreamClient()}async update(g,m,S,v){v?.mark("startUpdateStreams");const C=getSendMediaModalities(g),_=await this.updateStreams(C,m);return v?.markAndMeasure("startUpdateStreams","updateStreamsWithModalities"),await this.updateSenders(),v?.markAndMeasure("updateStreamsWithModalities","updateSenders"),this.applyMuteState(S,!0),this.setAndUpdateLocalTracksInfo(!1),this.previousMediaModalitites=shallowClone(_),mergeSendModalities(g,this.previousMediaModalitites)}async activate(g){this.logger.info(`[${g}] activate senders`),await Promise.all([...this.senders.values()].map((async g=>g.activate())))}applyCallConstraints(g){const m=this.senders.get("Video");return m?m.applyCallConstraints(g):(this.logger.info(`[${g}] Caching call constraints until sender is created`),this.callConstraintsCauseId=g,this.applyCallConstraintsDeferred=defer4(),this.applyCallConstraintsDeferred.promise)}async applyCapabilities(g,m,S){this.logger.safe.info(`[${g}] Applying incoming ${m} FMTP: ${JSON.stringify(S)}`);const v=modalityToMediaType(m);this.lastCauseId=g;let C=S;return this.mediaQualityController&&(this.mediaQualityController.addReceiver(v,S),C=this.mediaQualityController.getLayouts(v)),this.updateParameters(g,v,C)}getLocalMediaSources(){const g=this.getTracksInfo(),m=[];return g.forEach((g=>{m.some((m=>m.modality===g.modality))||m.push({sourceId:this.getSourceIdForTrack(g),modality:g.modality})})),m}setMuted(g,m,S){this.muted.set(g,m),this.applyMuteState(S,!1)}async setHold(g,m){await Promise.all([...this.senders.values()].map((async S=>S.setHold(g,m))))}async updateParameters(g,m,S){try{await this.applyCapabilitiesForMediaType(m,S),this.logger.safe.debug(`[${g}] Capabilities completed`);const v={modality:mediaTypeToModality(m),causeId:g,capabilities:S};this.statisticsGatherer.onMaxCapabilitiesApplied(v),this.diagnostics?.onMaxCapabilitiesApplied(v)}catch(v){const C=stringifyObject(v);this.logger.safe.error(`[${g}] Error applying capabilities ${C}`);const _={modality:mediaTypeToModality(m),causeId:g,capabilities:S,error:C};this.statisticsGatherer.onMaxCapabilitiesApplied(_),this.diagnostics?.onMaxCapabilitiesApplied(_)}}async applyCapabilitiesForMediaType(g,m){const S=this.senders.get(g);if(S)return S.updateParameters(m);this.logger.safe.info(`[${this.lastCauseId}] Capabilities ignored ${JSON.stringify(m)} ignored, no sender for media type ${JSON.stringify(g)}`)}applyMuteState(g,m){for(const[S,v]of this.muted)this.senders.get(S)&&this.senders.get(S).setMuted(v,g,m)}setAndUpdateLocalTracksInfo(g){const m=this.getTracksInfo();this.mediaManager.setLocalTracksInfo(m),g&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statisticsGatherer.updateStatsWithLocalSsrcTrackInfo())}getTracksInfo(){const g=[];return this.senders.forEach((m=>{g.push(m.getTrackInfo())})),g}async updateStreams(g,m){const S=await this.streamsProvider.update(g,m);return this.logger.safe.info(`Streams updated, modalities requested: ${JSON.stringify(g)}, result: ${JSON.stringify(S)}`),S}async updateSenders(){await this.streamsProvider.ensureUpdateCompleted();const g=sendStreamsToModalities(this.streamsProvider.streams);await Promise.all(keys(g).map((async m=>{const S=g[m];if(S===this.previousMediaModalitites[m])return void this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(m)} are not changed. enabled=${S}`);if(!S)return this.logger.safe.info(`Removing sender for mediaType: ${JSON.stringify(m)}`),void await this.removeSender(m);const v=this.streamsProvider.streams[m];if(await this.createAndStartSender(v,m),this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(m)} is added`),this.applyCallConstraintsDeferred&&"Video"===m){const g=this.senders.get("Video");try{await g.applyCallConstraints(this.callConstraintsCauseId),this.applyCallConstraintsDeferred.resolve()}catch(g){this.applyCallConstraintsDeferred.reject(g)}this.applyCallConstraintsDeferred=void 0,this.callConstraintsCauseId=void 0}await this.addAudioSharingStream(v),this.event("onSendStreamChanged").raise(v,m)}))),this.logger.safe.info("Senders updated")}createAndStartSender(g,m){if(this.senders.get(m))return this.logger.safe.error(`Sender already created, modality: ${JSON.stringify(m)}`),this.senders.get(m).start();const S=this.mediaManager.getMediaEntitiesByModality(mediaTypeToModality(m))[0],v=S?.getSimulcastContext(),C="Audio"===m||!this.isMultiparty||!!v?.shouldUseSimulcast(),_=new tE(this.mediaConnection,g,new MediaStream,m,this.serialQueue,this.logger.createChild(`Sender_${JSON.stringify(m)}:${this.senderId++}`),this.configProvider,C,this.encStreamsManager,v);this.senders.set(m,_);const E=[_.on("onSendersChanged",((g,m)=>this.onSenderStateChanged(g,m))),_.on("onNewStreamNeeded",(()=>this.streamsProvider.requestStreamUpdate(m,!0))),_.on("onMaxVideoSendCapabilitiesChanged",(g=>this.event("onMaxVideoSendCapabilitiesChanged").raise(m,g)))];return this.subs.set(_,E),_.start()}async removeSender(g){const m=this.senders.get(g);m&&(this.senders.delete(g),this.event("onSendStreamChanged").raise(null,g),await m.terminateAsync(),this.subs.get(m).forEach((g=>g.dispose())),this.subs.delete(m),this.logger.safe.info(`Removed sender with mediaType: ${JSON.stringify(g)}`)),this.mediaQualityController?.removeReceiver(g)}async updateLayouts(g){const m=this.mediaQualityController.getLayouts(g);return this.logger.safe.debug(`Update layouts for ${g}: ${JSON.stringify(m)}`),this.updateParameters(this.lastCauseId,g,m)}getSourceIdForTrack(g){const m=g.trackId,S=this.mediaManager.getMediaEntityByLocalTrackId(m);return S?(this.logger.safe.info(`Media entity found: ${JSON.stringify(S.getXSourceStreamId())}`),S.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(m)}`),0)}subscribeToStreamProviderEvents(){this.streamProviderSubscriptions=[this.streamsProvider.on("onStreamAdded",(g=>this.onStreamUpdated(g,!1))),this.streamsProvider.on("onStreamUpdated",(g=>this.onStreamUpdated(g,!0)))]}unsubscribeFromStreamProviderEvents(){this.streamProviderSubscriptions.forEach((g=>g.dispose())),this.streamProviderSubscriptions=null}subscribeToStreamWatcherEvents(){this.localVideoStreamWatcherSubs=this.localVideoStreamWatcher.on("onVideoCaptureFreeze",((g,m)=>{g||(m?this.diagnostics.registerWebcamFreeze():this.diagnostics.registerProcessedStreamFreeze()),this.event("onVideoCaptureFreeze").raise(g)}))}async onStreamUpdated(g,m){if(!this.senders.has(g))return void this.logger.safe.warn(`Sender with media type ${g} does not exist, do not update media stream`);let S=this.streamsProvider.streams[g];if(S||(this.logger.safe.info(`Stream is missing for mediaType: ${g}, using fake stream...`),S=new _y(g,this.logger.createChild("NullStreamClient"))),S.isDisposed())return void this.logger.safe.info(`Stream is already disposed for mediaType: ${g}`);this.event("onSendStreamChanged").raise(S,g);const v=this.senders.get(g);await this.addAudioSharingStream(S),await v.updateStream(S),this.setAndUpdateLocalTracksInfo(m)}onSenderStateChanged(g,m){if(this.mediaManager&&this.mediaManager.updateMediaEntitiesWithActivityState(g.mediaType,g.getActiveStreamIndexes()),this.statisticsGatherer.onSendersChanged(g.mediaType,m),"Video"===g.mediaType)if(m){const g=this.getTracksInfo().filter((g=>g.modality===Ke.MODALITY.video));this.localVideoStreamWatcher.startWatching(g)}else this.localVideoStreamWatcher.stopWatching()}async addAudioSharingStream(g){"ScreenShare"===g.mediaType&&g.hasAudio()&&(this.logger.safe.info("Adding audio stream from sharing to audio sender"),await(this.senders.get("Audio")?.addAdditionalStream(g)))}},nE=class{constructor(g,m,S,v,C){this.pc=g,this.cryptoMethod=m,this.logger=S,this.configProvider=v,this.stateChangedCallback=C,this.logger=S.createChild("TransportStateProvider"),this.subscribeForConnectionState()}get hasPcConnectionState(){return"connectionState"in this.pc&&this.configProvider.config.useConnectionState}subscribeForConnectionState(){this.pc.oniceconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection oniceconnectionstatechange iceConnectionState: ${this.pc.iceConnectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(0)&&this.stateChangedCallback(this.pc.iceConnectionState)},1===this.cryptoMethod&&this.hasPcConnectionState&&(this.pc.onconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection onconnectionStatechange connectionState: ${this.pc.connectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(1)&&this.stateChangedCallback(this.pc.connectionState)})}subscribeForDtlsTransportState(){if(!this.configProvider.config.useDtlsTrasportConnectionCheck||this.transport||1!==this.cryptoMethod||this.hasPcConnectionState)return;const g=this.pc.getReceivers().find((g=>!!g.transport));this.transport=g&&g.transport,this.transport&&(this.transport.onstatechange=()=>{this.logger.safe.info(`RTCDtlsTransport onstatechange state: ${this.transport.state} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(2)&&this.stateChangedCallback(this.transport.state)})}dispose(){this.pc.oniceconnectionstatechange=null,this.transport&&(this.transport.onstatechange=null,this.transport=null),this.pc.onconnectionstatechange&&(this.pc.onconnectionstatechange=null),this.pc=null,this.stateChangedCallback=null}shouldRaise(g){switch(g){case 2:if(1!==this.cryptoMethod)throw new Error(`DTLS transport is used with cryptoMethod=${this.cryptoMethod}`);return!this.configProvider.config.ignoreClosedDtlsTransportState||"closed"!==this.transport.state;case 1:return 1===this.cryptoMethod&&!this.transport;case 0:return!(!this.configProvider.config.ignoreClosedDtlsTransportState||!this.transport||"closed"!==this.pc.iceConnectionState)||(0===this.cryptoMethod||!this.transport&&!this.hasPcConnectionState||this.transport&&"disconnected"===this.pc.iceConnectionState||"connected"===this.transport?.state&&"connected"===this.pc.iceConnectionState);default:return this.logger.safe.error(`unknown StateMethod=${g}`),!1}}},rE=class{constructor(g,m,S,v,C){this.recvStream=g,this.mainTrack=m,this.receiveStreamCollection=S,this.logger=v,this.settings=C,this.removeOtherTracks(m),this.subscribeOnStreamEvents()}get stream(){return this.recvStream.getMediaStream()}dispose(){this.unsubscribeFromStreamEvents(),this.receiveStreamCollection=null,this.mainTrack=null,this.recvStream.dispose()}getId(){return this.recvStream.getId()}getModality(){return this.recvStream.getModality()}getMsi(){return this.recvStream.getMsi()}getMediaStream(){return this.stream}getReceiver(){return this.recvStream.getReceiver()}requestSource(g){return this.recvStream.requestSource(g)}getSourceStreamId(){return this.recvStream.getSourceStreamId()}removeOtherTracks(g){if(this.settings.onAddTrackRemoveOtherTracks){this.stream.getTracks().forEach((m=>{m.id!==g.id&&this.stream.removeTrack(m)}))}}subscribeOnStreamEvents(){const logEvent=g=>this.logger.safe.info(`${g} track: ${this.mainTrack.id}, stream: ${this.stream.id}`);this.stream.onremovetrack=()=>{logEvent("onremovetrack"),this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onended=()=>{logEvent("onended"),this.settings.removeRecvStreamOnEnded&&this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onmute=()=>logEvent("onmute"),this.mainTrack.onunmute=()=>logEvent("onunmute")}unsubscribeFromStreamEvents(){this.stream.onremovetrack=null,this.mainTrack.onended=null,this.mainTrack.onmute=null,this.mainTrack.onunmute=null}},sE=class{constructor(g){this.startTimestamp=0,this.totalTime=0,this.lastActiveTime=0,this.id=g}},aE=class{constructor(g){this.speakersHistory=[],this.sources=[],this.configProvider=g.configProvider,this.ping=this.setupTimer()}setSources(g=[]){const m=g.map(this.getOrCreateSource.bind(this)),S=this.excludeSources(this.sources,m);m.forEach((g=>{this.isAlreadyActive(g)||this.updateSourceTimestamp(g),this.updateSourceLastActiveTime(g)})),S.forEach((g=>{this.updateTotalTime(g),this.resetStartTimestamp(g)})),this.ping||(this.ping=this.setupTimer())}setOnDominantSpeakerChanged(g){this.callback=g}dispose(){this.clearTimer(),this.sources=null,this.callback=null}excludeSources(g,m){return g.filter((g=>!m.some((m=>g.id===m.id))))}trigger(){if(!this.hasAnyoneSpoken())return void this.clearTimer();const byActivity=(g,m)=>m.totalTime-g.totalTime||m.lastActiveTime-g.lastActiveTime,toSourceId=g=>g.id,g=this.sources.map(this.updateTotalTime).sort(byActivity).map(toSourceId).slice(0,this.configProvider.config.ovcMaxCount);g.length&&!deepEqual(this.speakersHistory,g)&&(this.speakersHistory=g,this.callback&&this.callback(this.speakersHistory,"client")),this.sources.map(this.resetTotalTime).filter(this.isAlreadyActive).forEach(this.updateSourceTimestamp)}isAlreadyActive(g){return!!g.startTimestamp}setupTimer(){return window.setInterval(this.trigger.bind(this),this.configProvider.config.activeSpeaker.timeToPromote)}clearTimer(){this.ping&&(clearInterval(this.ping),this.ping=null)}getOrCreateSource(g){if(this.isExist(g))return this.sourceById(g);{const m=new sE(g);return this.sources.push(m),m}}isExist(g){return this.sources.some((m=>g===m.id))}hasAnyoneSpoken(){return this.sources.some((g=>0!==g.startTimestamp||0!==g.totalTime))}sourceById(g){return this.sources.find((m=>g===m.id))}updateSourceTimestamp(g){g.startTimestamp=Date.now()}updateSourceLastActiveTime(g){g.lastActiveTime=Date.now()}updateTotalTime(g){return g.startTimestamp&&(g.totalTime+=Date.now()-g.startTimestamp),g}resetStartTimestamp(g){return g.startTimestamp=0,g}resetTotalTime(g){return g.totalTime=0,g}},oE=class{constructor(g){this.modifierList=g}modify(g){for(const m of this.modifierList)m.modify(g)}},lE=class{constructor(g,m,S,v){this.context=g,this.mediaManager=m,this.modalities=S,this.cname=v}build(g){switch(g.sdpSource){case 0:return new oE([new Zf(this.context.configProvider),new Nf(this.context.configProvider),new cS(this.mediaManager,this.context.configProvider),new lS(this.mediaManager),new Gf(this.context.configProvider),new Vf(this.context.configProvider),new Ff(this.mediaManager,this.context.configProvider,g.sdpType),new Lf(this.mediaManager,this.context.configProvider),new CS(this.context.configProvider,g.sdpType)]);case 2:return new oE([new mf(this.mediaManager,this.modalities),new kf,new ff(this.mediaManager,!0),new nS(this.context.configProvider,this.mediaManager),new Tf(this.modalities,this.mediaManager),new Wf,new $f,new jf,new qf(this.context.configProvider),new Hf(this.context.configProvider),new Xf(this.context.configProvider),new bf,new gf(this.context),new aS(this.mediaManager),new Of(this.context.configProvider),new pS,new gS(this.context.configProvider),new dS(this.context.configProvider),new Pf(this.mediaManager,this.modalities,this.context.configProvider),new Ef(this.context),new mS(this.context.configProvider),new _f(this.context.configProvider),new Ff(this.mediaManager,this.context.configProvider,g.sdpType),new xf(this.mediaManager,this.context.configProvider,g.sdpType),new Kf(this.context.configProvider,this.context.getLogger()),new Rf,new SS(this.context.configProvider),new tS(this.context.configProvider)]);case 1:return new oE([new vf(this.context,this.modalities.data),new ff(this.mediaManager,!1),new Mf(this.context.configProvider),new mf(this.mediaManager,this.modalities),new Af(this.mediaManager),new $f,new Bf(this.context.configProvider),new pf(this.mediaManager,"offer"===g.sdpType,this.context.configProvider),new oS(this.mediaManager,this.context.getLogger()),new uS(this.context.configProvider,this.mediaManager),new If(this.context.config.isConference,this.cname),new wf(this.mediaManager),new Df,new eS(this.context.configProvider),new yf(this.context.configProvider),new fS(this.context.configProvider),new vS(this.context.configProvider),new xf(this.mediaManager,this.context.configProvider,g.sdpType),new Qf(this.mediaManager,this.context.configProvider,g.sdpType),new tS(this.context.configProvider)])}}},cE=class{constructor(g){this.context=g,this.cname=uniqueId()}toLocal(g,m,S){return this.modify({sdpSource:0,sdpType:S},g,m)}toOffer(g,m,S){return this.modify({sdpSource:1,sdpType:"offer"},g,m,S)}toAnswer(g,m,S){return this.modify({sdpSource:1,sdpType:"answer"},g,m,S)}toRemote(g,m,S,v){return this.modify({sdpSource:2,sdpType:v},g,m,S)}modify(g,m,S,v){const C=new lE(this.context,S,v,this.cname).build(g),_=deepClone(m);return C.modify(_),_}},dE=class{get sdp(){return this.originalDescription.sdp}set sdp(g){this.originalDescription=new Us.window.RTCSessionDescription({sdp:g,type:this.originalDescription.type})}get type(){return this.originalDescription.type}set type(g){this.originalDescription=new Us.window.RTCSessionDescription({sdp:this.originalDescription.sdp,type:g})}constructor(g){this.originalDescription=new Us.window.RTCSessionDescription(g)}toJSON(){return this.originalDescription.toJSON()}},hE=P,uE=class{constructor(g,m,S){this.mediaEntity=g,this.logger=m,this.configProvider=S,this.activeRids=[],this.isLocalDescSet=!1,this.enabledLocally=!1,this.enabledRemotely=!1;const v=modalityToMediaType(this.mediaEntity.getModality());this.config=getSimulcastConfigForMediaType(v,this.configProvider),this.config?this.logger.safe.debug(`Adding simulcast info to ${g.getModality()} with mid: ${g.getMid()}, config: ${JSON.stringify(this.config)}`):this.logger.safe.debug(`Simulast is disabled for ${g.getModality()}`)}get ridList(){return this.config?(0,hE.times)(this.config.layerScaleFactors.length,(g=>g+1)):[]}localDescriptionIsApplied(){this.isLocalDescSet=!0}enableInLocalDesc(){this.enabledLocally=!0}shouldBeEnabledInLocalDesc(){return!!this.config&&(this.config.enableLocally||this.enabledRemotely)}enableInRemoteDesc(){this.enabledRemotely=!0}shouldBeEnabledInRemoteDesc(){return!!this.config&&(this.enabledLocally||this.config.allowEnableRemotely&&this.isMidRidHeaderExtPresented()&&!this.isLocalDescSet)}shouldUseSimulcast(){return this.shouldBeEnabledInLocalDesc()}getSsrcRange(){return this.shouldUseSimulcast()?99:0}isMidRidHeaderExtPresented(){const g=this.mediaEntity.getRtpHeaderExtensions();return g?.some((g=>"mid"===g.headerType||"rid"===g.headerType||"rrid"===g.headerType))}},gE={toffset:"toffset","abs-send-time":"abs-send-time","video-orientation":"video-orientation","draft-holmer-rmcat-transport-wide-cc-extensions-01":"transport-cc","video-content-type":"video-content-type","video-timing":"video-timing","color-space":"color-space","video-layers-allocation00":"vla","video-layers-allocation00-non-advertised":"non-adv-vla",mid:"mid","rtp-stream-id":"rid","repaired-rtp-stream-id":"rrid","fast_bandwidth_feedback#version_3":"fast_bandwidth_feedback#version_3","frame-counters-gvc":"frame-counters-gvc"},pE=class{constructor(g){this.context=g,this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.ssrcGenerator=new dv,this.rollbackHandlers=[],this.logger=g.logger.createChild("MM2"),this.configProvider=g.configProvider}fromOffer(g,m,S=!1){this.updateMediaEntitiesFromModel(g,S),this.updateSharingEntity(!!m.sharing),g.media.forEach((g=>{const m=this.getMediaEntityByMid(g.mid);m&&this.saveLocalSsrc(m,g)}))}fromRemote(g,m){const S=0===this.mediaEntities.length;this.updateMediaEntitiesFromModel(g,!1,m),g.media.forEach(((g,m)=>{const S=this.getMediaEntityByMid(g.mid);S&&(this.saveRemoteMsid(S,g),this.saveRemoteSsrc(S,g),this.saveRtpHeaderExtensions(S,g),S.setXSourceStreamId(g.xSourceStreamId||this.generateSourceStreamId(m)),S.setRemoteRecvCapabilities(getRecvCapabilitiesForMedia(g)),S.setSubStreamIndex(g.subStreamIndex))})),S&&this.updateReinvitelessState(g)}isEmpty(){return 0===this.mediaEntities.length}createMediaEntity(g,m){const S=k_.create(this.configProvider,g,m);return this.context.useSimulcast&&!this.mediaEntities.find((m=>m.getModality()===g))&&this.setSimulcastContext(S),S.setExtension("reinviteless",!1),this.mediaEntities.push(S),S}getMediaEntities(){return this.mediaEntities}getMediaEntity(g){return this.mediaEntities[g]}getMediaEntityByMid(g){return this.mediaEntities.find((m=>m.getMid()===g))}getMediaEntitiesByModality(g){return this.mediaEntities.filter((m=>m.getModality()===g))}getMediaEntitiesByMediaType(g){const m=modalityToMediaType(g);return this.getMediaEntitiesByModality(m)}getMediaEntityByRemoteStreamId(g){return this.mediaEntities.find((m=>m.getRemoteStreamId()===g))}getMediaEntityByLocalTrackId(g){return this.mediaEntities.find((m=>m.getLocalTrackId()===g))}getMediaEntityByXSourceStreamId(g){return this.mediaEntities.find((m=>m.getXSourceStreamId()===g))}reset(){this.mediaEntities=[],this.rollbackHandlers=[]}syncModalities(g,m,S=!1){this.fromOffer(g,m,S)}setLocalTracksInfo(g){this.mediaTracks=g}getLocalTracksInfo(){return this.mediaTracks}backup(){this.logger.safe.debug("backup"),this.mediaEntitiesBackup=[],this.mediaEntities.forEach((g=>{this.mediaEntitiesBackup.push(g.clone())}))}commit(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((g=>{g.setExtension("unnegotiatedModality",!1)}))}rollback(){this.logger.safe.debug(`rollback, if backup exists: ${!!this.mediaEntitiesBackup.length}`),this.mediaEntitiesBackup.length&&(this.rollbackHandlers.forEach((g=>g(this.mediaEntities,this.mediaEntitiesBackup))),this.mediaEntities.forEach(((g,m)=>{this.mediaEntitiesBackup[m]?this.mediaEntities[m]=this.mediaEntitiesBackup[m]:(g.disable(),g.setExtension("rollback",!0))})))}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((g=>g.setLocalTrackId(null))),this.mediaTracks.forEach((g=>{const m=this.getMediaEntitiesByModality(g.modality)[0];m?m.setLocalTrackId(g.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(g.modality)}`)})))}updateMediaEntitiesWithActivityState(g,m){this.logger.safe.debug(`Updating activity indexes for ${g} to ${JSON.stringify(m)}`);const S=mediaTypeToModality(g),v=this.getMediaEntitiesByModality(S)[0];if(!v)return void this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(S)}`);const C=v.getSimulcastContext();C&&(C.activeRids=m)}setRollbackUpdateHandler(g){this.rollbackHandlers.push(g)}saveRtpHeaderExtensions(g,m){if(g.isDisabled())return void g.setRtpHeaderExtensions(void 0);const S=m.ext?.map((g=>this.getHeaderExtension(g)));this.logger.safe.debug(`RTP header ext for mid=${m.mid}, modality=${g.getModality()}: ${JSON.stringify(S)}`),g.setRtpHeaderExtensions(S)}getHeaderExtension(g){let m="unknown";for(const[S,v]of Object.entries(gE))if(g.uri.endsWith(S)){m=v;break}return{headerType:m,value:g.value}}saveRemoteMsid(g,m){if(isMediaDisabled(m))g.setRemoteStreamId(null);else if(m.msid)g.setRemoteStreamId(m.msid.split(" ")[0]);else if(m.ssrcs){const S=m.ssrcs.find((g=>"msid"===g.attribute));S?g.setRemoteStreamId(S.value.split(" ")[0]):this.logger.safe.warn(`No ssrc msid for media of type ${m.type} with mid ${m.mid}`)}}saveRemoteSsrc(g,m){if(m.ssrcs?.length){const S=m.ssrcs[0];g.setRemoteSsrc(S.id)}}saveLocalSsrc(g,m){const S=m.ssrcs?.[0]?.id;if(!hasSendDirectionality(m.direction))return void g.setLocalSsrc(S);const v=S||g.getLocalSsrc()||this.ssrcGenerator.nextVideoStreamSsrc().min;g.setLocalSsrc(v)}updateMediaEntitiesFromModel(g,m,S){g.media.forEach(((g,v)=>{this.mediaEntities[v]?isMediaDisabled(g)?this.mediaEntities[v].disable():this.mediaEntities[v].update(this.mediaEntities[v].getModality(),g.mid||this.mediaEntities[v].getMid()):m||this.createMediaEntity(getModality(g),g.mid||v.toString()),this.mediaEntities[v]&&S&&!(this.mediaEntities[v].getModality()in S)&&this.mediaEntities[v].disable()}))}updateSharingEntity(g){if(g&&!this.getMediaEntitiesByModality(Ke.MODALITY.sharing).length){const g=this.getMediaEntitiesByModality(Ke.MODALITY.video).pop();g.update(Ke.MODALITY.sharing,g.getMid())}}setSimulcastContext(g){if(!g||g.getSimulcastContext())return;const m=new uE(g,this.logger.createChild(`SimContext:${g.getModality()}`),this.configProvider);g.setSimulcastContext(m)}generateSourceStreamId(g){return g+10}updateReinvitelessState(g){const m={[Ke.MODALITY.audio]:0,[Ke.MODALITY.video]:0,[Ke.MODALITY.sharing]:0};for(const S of g.media){const g=getModality(S);void 0!==m[g]&&m[g]++;const v=this.getMediaEntityByMid(S.mid);if(v){const C=this.context.reinviteltessContext?.maxStreamsForModality[g]>=m?.[g]&&(!S.direction||"sendrecv"===S.direction);v.setExtension("reinviteless",C)}}}};function createAudioWasmDecoderProxy(g,m,S){return new mE(g,m,S)}var mE=class extends sy{constructor(g,m,S){super(g,m,2,S)}init(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[g]}})}setCodec(g,m){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[g,m]}})}passWriteableStreams(g,m){const S=g.concat(m);this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"passWriteableStreams",args:[g,m]}},S)}setAvailableStreams(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setAvailableStreams",args:[g]}})}setRecvPayloads(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setRecvPayloads",args:[g]}})}debugLogging(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[g]}})}sendApiRecordingData(){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"sendApiRecordingData",args:[]}})}},fE=class{constructor(g){this.logger=g,this.audioContext=new AudioContext,this.destination=this.audioContext.createMediaStreamDestination()}get stream(){return this.destination.stream}isSingleInputStream(){return 0===this.mixerImp?.mixerType}dispose(){this.audioContext.close(),this.audioContext=null}setMixerType(g,m){this.mixerImp?.mixerType!==g&&(this.mixerImp?.reset(),this.mixerImp=this.createMixer(g),this.mixerImp.setupMixer(this.audioContext,this.destination,m))}setStreamSources(g){this.mixerImp.setStreamSources?.(g)}setParticipantSpatialAudioPositions(g){this.mixerImp.setParticipantSpatialAudioPositions?.(g)}createMixer(g){switch(g){case 0:return new vE;case 1:return new CE(this.logger.createChild("MixingStreamsMixer"));case-1:return new SE;default:throw new Error(`unknown mixer type: ${g}`)}}},SE=class{constructor(){this.mixerType=-1}reset(){}setupMixer(g,m,S){}},vE=class{constructor(){this.mixerType=0}reset(){this.sourceNode.disconnect()}setupMixer(g,m,S){this.sourceNode=g.createMediaStreamSource(S[0]),this.sourceNode.connect(m)}},CE=class{constructor(g){this.logger=g,this.sourcePositions=new Map,this.pannerNodes=[],this.mixerType=1}reset(){for(const g of this.pannerNodes)g.disconnect();this.pannerNodes=[]}setupMixer(g,m,S){for(const v of S){const S=g.createMediaStreamSource(v),C=new PannerNode(g,{panningModel:"HRTF"});S.connect(C),C.connect(m),this.pannerNodes.push(C)}this.logger.safe.info(`setupMixer is done for ${S.length} streams.`)}setStreamSources(g){for(let m=0;m<g.length;m++)this.setStreamPosition(m,g[m])}setParticipantSpatialAudioPositions(g){this.sourcePositions=new Map(g.map((g=>[g.sourceId,g])))}setStreamPosition(g,m){const S=this.sourcePositions.get(m)??{sourceId:m,x:0,y:0},v=this.pannerNodes[g];v.positionX.value=S.x,v.positionY.value=S.y}},_E=class extends Ge{constructor(g){super(),this.logger=g,this.mediaStreams=[],this.cnStream=null,this.isActive=!1}get active(){return this.isActive}get streams(){return this.mediaStreams}get comfortNoiseStream(){return this.cnStream}setupStreams(g,m){this.logger.safe.debug(`setup ${g} streams with extra Comfort Noise stream: ${m}`),this.mediaStreams=[];const S=[];for(;g--;){const g=new MediaStreamTrackGenerator({kind:"audio"});S.push(g),this.streams.push(new MediaStream([g]))}const v=m?new MediaStreamTrackGenerator({kind:"audio"}):null;return this.cnStream=v?new MediaStream([v]):null,this.event("onStreamsChanged").raise(),{streams:S.map((g=>g.writable)),cnStream:v?.writable}}setStreamSources(g){this.isActive&&this.event("onStreamSourcesUpdated").raise(g)}activateUnmixedProvider(g){this.isActive!==g&&(this.isActive=g,this.event("onActiveStateChanged").raise())}},yE=class extends je{constructor(g,m){super(),this.logger=g,this.maxNumOfStreamsFactor=m,this.statsProvider=new EE,this.streamMixer=new fE(this.logger),this.unmixedAudioProvider=new _E(this.logger),this.codec="None",this.recvPayloads=[],this.initCompleted=!1,this.enabledApiRecording=!1;try{this.enabledApiRecording="true"===localStorage.getItem("enableApiRecording")}catch{}this.injectWebMA()}get stream(){return this.streamMixer.stream}dispose(){super.dispose(),this.streamMixer.dispose(),this.removeWebMA()}activateTransform(g){this.logger.safe.debug("Activating WASM decoder transform"),g.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM decoder transform"),this.imp=null,this.initCompleted=!1,this.codec="None",this.streamMixer.setMixerType(-1,[])}createBaseInstanse(g){this.logger.warn("WASM decoder could only be instantiated in worker")}createWorkerInstanse(g,m){this.imp=createAudioWasmDecoderProxy(g,m,this),this.imp.init(this.enabledApiRecording)}setCodec(g){if(this.logger.safe.debug(`Setting codec to ${g}`),!this.initCompleted)return this.logger.safe.debug("Decoder is not initialized yet, postponing codec setting"),void(this.codec=g);this.codec!==g&&(this.codec=g,this.setCodecInternal())}setRecvPayloads(g){this.recvPayloads=g,this.imp?.setRecvPayloads(g)}negotiationCompleted(g){this.logger.safe.debug(`Negotiation completed, negotiated=${g}`),g||(this.codec="None",this.imp?.setCodec(this.codec,this.streamMixer.isSingleInputStream()))}setParticipantSpatialAudioPositions(g){this.streamMixer.setParticipantSpatialAudioPositions(g)}getStatsProvider(){return this.statsProvider}getUnmixedAudioProvider(){return this.unmixedAudioProvider}async storeApiRecording(){if(this.enabledApiRecording&&this.initCompleted)return this.recordingCompletePromise?.resolve(),this.recordingCompletePromise=new or,this.imp.sendApiRecordingData(),this.recordingCompletePromise.promise}initDone(g,m){if(this.healerCapabilities=m,this.logger.safe.info(`Init done, errorCode=${g}`),0!==g)return void this.event("initFailed").raise(g);this.logger.safe.info(`healerCapabilities=${JSON.stringify(m)}`),this.initCompleted=!0;const S=Math.floor(this.healerCapabilities.maxNumStreamsPerPacket*this.maxNumOfStreamsFactor),v=this.unmixedAudioProvider.setupStreams(S,!0);this.imp.passWriteableStreams(v.streams,v.cnStream),this.setCodecInternal(),this.imp.setRecvPayloads(this.recvPayloads)}usedDecoderChanged(g){this.logger.safe.info(`Used decoder changed to custom=${g}, configured codec=${this.codec}`),this.event("usedDecoderChanged").raise(g),this.unmixedAudioProvider.activateUnmixedProvider(g&&"MUCHv2"===this.codec)}packetReceived(g,m,S){this.statsProvider.ssrc=m,this.statsProvider.addPushStats(g,S)}newDataWrittenToStreams(g){const m=Array.from(new Int32Array(g));this.unmixedAudioProvider.setStreamSources(m),this.streamMixer.setStreamSources(m);const S=m.reduce(((g,m,S)=>(m===ry&&g.push(S),g)),[]);this.imp?.setAvailableStreams(S)}packetDecoded(g,m,S){this.statsProvider.addPullStats(g,m,S,S.extra.samplingRatekHz*this.healerCapabilities.frameLengthMs)}apiRecordingAvailable(g,m,S){if(this.logger.safe.debug(`API recording available: errorCode=${g}, name=${m}, buffer length=${S.byteLength}`),this.recordingCompletePromise?.resolve(),0===S.byteLength)return;const v=new Blob([S],{type:"application/octet-stream"}),C=URL.createObjectURL(v),_=document.createElement("a");_.href=C,_.download=m,_.click()}setCodecInternal(){this.streamMixer.setMixerType(getStreamGeneratorType(this.codec),this.unmixedAudioProvider.streams),this.imp.setCodec(this.codec,this.streamMixer.isSingleInputStream()),this.statsProvider.codecName=this.codec}injectWebMA(){const g=window.webMA;g&&(g.wasmDecoder={debugLogging:g=>this.imp?.debugLogging(g),sendApiRecordingData:()=>this.imp?.sendApiRecordingData()})}removeWebMA(){const g=window.webMA;g&&delete g.wasmDecoder}};function getStreamGeneratorType(g){switch(g){case"SatinFB":return 0;case"MUCHv2":return 1;case"None":return-1;default:throw new Error(`unknown codec: ${g}`)}}var EE=class{constructor(){this.customHealerStats={numSamplesPerFrame:0,FECPayloadDecodedSamples:0,concealSamples:0,stretchSamples:0,healedSamples:0,decodedSamples:0,redPacketsCount:0,pushProcessingTimes:{},pullProcessingTimes:{},pullProcessingTimePerStreamNumber:{},pullNumOfStreamsCounter:{}},this.inboudStats={silentConcealedSamples:0,concealedSamples:0,totalSamplesReceived:0,audioLevel:0,jitterBufferDelay:0,jitterBufferEmittedCount:0},this.decoderStats={pushCount:0,pushErrCount:0,pullCount:0,pullErrCount:0},this.packetPushProccesingTimes=new TE(0,1e3),this.packetPullProccesingTimes=new TE(0,1e3),this.numOfStreamsCounter=new TE(0,10),this.pullProcessingTimePerStreamNumber={}}get codecName(){return this.codec}set codecName(g){this.codec=g}addPushStats(g,m){this.decoderStats.pushCount++,this.decoderStats.pushErrCount+=0!==g?1:0,this.inboudStats.jitterBufferDelay+=m.webrtc.jitterBufferDelay,this.customHealerStats.packetDurationInMs=m.extra.packetDurationInMs,this.packetPushProccesingTimes.addSample(m.extra.processingTime),this.customHealerStats.pushProcessingTimes=this.packetPushProccesingTimes.getFrequencies(),this.customHealerStats.cnpPushCount=m.extra.totalCountCNPackets,this.customHealerStats.redPacketsCount+=0!==m.extra.redundancyTimestampOffset?1:0}addPullStats(g,m,S,v){var C;this.decoderStats.pullCount++,this.decoderStats.pullErrCount+=0!==g?1:0,this.inboudStats.audioLevel=S.webrtc.audioLevel,this.inboudStats.totalAudioEnergy=S.webrtc.totalAudioEnergy,this.inboudStats.jitterBufferEmittedCount=S.webrtc.jitterBufferEmittedCount,this.inboudStats.totalSamplesReceived=S.webrtc.totalSamplesReceived,this.inboudStats.concealedSamples=S.webrtc.concealedSamples,this.inboudStats.silentConcealedSamples=S.webrtc.silentConcealedSamples,this.numOfStreamsCounter.addSample(m),this.customHealerStats.FECPayloadDecodedSamples=S.extra.FECPayloadDecodedSamples,this.customHealerStats.numSamplesPerFrame=v,this.customHealerStats.pullAdspPayloadType=S.extra.pullAdspPayloadType,this.customHealerStats.concealSamples=S.extra.concealSamples,this.customHealerStats.stretchSamples=S.extra.stretchSamples,this.customHealerStats.healedSamples=S.extra.healedSamples,this.customHealerStats.decodedSamples=S.extra.decodeSamples,this.packetPullProccesingTimes.addSample(S.extra.processingTime),this.customHealerStats.pullProcessingTimes=this.packetPullProccesingTimes.getFrequencies(),this.customHealerStats.cnpPullCount=S.extra.totalCountCNGeneratedFrames,this.customHealerStats.cngSamples=S.extra.cngSamples,this.customHealerStats.pullNumOfStreamsCounter=this.numOfStreamsCounter.getFrequencies(),(C=this.pullProcessingTimePerStreamNumber)[m]??(C[m]=new TE(0,200)),this.pullProcessingTimePerStreamNumber[m].addSample(S.extra.processingTime);for(const g of Object.keys(this.pullProcessingTimePerStreamNumber))this.customHealerStats.pullProcessingTimePerStreamNumber[g]=this.pullProcessingTimePerStreamNumber[g].getFrequencies()}getWebRtcCompatibaleStats(){return this.inboudStats}getWasmStats(){return this.customHealerStats}getDecoderStats(){return this.decoderStats}},TE=class{constructor(g,m){this.minSample=g,this.maxSample=m,this.frequencyDict={}}addSample(g){if(void 0===g)return;const m=Math.min(this.maxSample,Math.max(this.minSample,g));this.frequencyDict[m]=(this.frequencyDict[m]??0)+1}getFrequencies(){return{...this.frequencyDict}}};function createAudioWasmEncoderProxy(g,m,S){return new IE(g,m,S)}var IE=class extends sy{constructor(g,m,S){super(g,m,3,S)}init(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[g]}})}setCodec(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[g]}})}debugLogging(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[g]}})}},bE=["SatinFB"],AE=class extends je{constructor(g){super(),this.logger=g,this.codec="None",this.injectWebMA()}dispose(){super.dispose(),this.removeWebMA()}activateTransform(g){this.logger.safe.debug("Activating WASM encoder transform"),g.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM encoder transform"),this.imp=null,this.encodersInitCodes=void 0,this.codec="None"}createBaseInstanse(g){this.logger.warn("WASM encoder could only be instantiated in worker")}createWorkerInstanse(g,m){this.imp=createAudioWasmEncoderProxy(g,m,this),this.imp.init(bE)}setCodec(g){if(this.logger.safe.debug(`Setting codec to ${g}`),!this.encodersInitCodes)return this.logger.safe.debug("Encoder is not initialized yet, postponing codec setting"),void(this.codec=g);this.codec!==g&&(this.codec=g,this.setCodecInternal())}isCodecAllowed(g){return bE.includes(g)}negotiationCompleted(g){g||(this.codec="None",this.imp?.setCodec(this.codec))}initDone(g){this.logger.safe.info(`initDone: ${JSON.stringify(g)}`),this.encodersInitCodes=g,this.setCodecInternal()}packetEncoded(g){0!==g&&this.logger.safe.info(`encode failed: ${g}`)}setCodecInternal(){const g=this.encodersInitCodes[this.codec]??-2147024809;if("None"!==this.codec&&0!==g)return this.logger.safe.error(`WASM encoder is failed to init codec ${this.codec}, err code: ${g}`),void this.event("initCodecFailed").raise(g);this.imp.setCodec(this.codec)}injectWebMA(){const g=window.webMA;g&&(g.wasmEncoder={debugLogging:g=>this.imp?.debugLogging(g)})}removeWebMA(){const g=window.webMA;g&&delete g.wasmEncoder}},RE=P,PE=class extends je{constructor(g,m,S){super(),this.encStreamsManager=g,this.logger=m,this.configProvider=S,this.isEnabled=!1,this.sessionStats=new wE,this.subs=[],this.codecContext=this.configProvider.mediaConfig.audioCodecContext,this.codecConfig=this.configProvider.config.useInsertableStreams?.audioWasmCodec}get decoder(){return this.decoderImp}get encoder(){return this.encoderImp}init(g){if(!g||!this.codecContext||!this.codecConfig?.enable)return;this.isEnabled=!0;const m=this.codecConfig.maxNumOfStreamsFactor||1;this.decoderImp=new yE(this.logger.createChild("AudioWasmDecoder"),m),this.codecConfig.enableSend&&(this.encoderImp=new AE(this.logger.createChild("AudioWasmEncoder"))),this.subscribeToStreamManagerEvents(this.encStreamsManager),this.subscribeToCodecsEvents()}dispose(){super.dispose(),this.unsubscribeFromEvents(),this.decoderImp?.dispose(),this.encoderImp?.dispose()}getSessionEvents(){return this.sessionStats.getSessionEvents()}prepareForNegotiation(g){if(!this.isEnabled)return;const m=this.configProvider.mediaConfig.spatialAudioEnabled?"MUCHv2":this.codecConfig.codec||"None";this.codecContext.codec!==m&&(this.codecContext.initSendFailed=!1),this.codecContext.lastUsedCodec=this.codecContext.codec,this.codecContext.codec=m,this.codecContext.enabledLocally=!this.codecContext.initFailed&&"None"!==m,this.codecContext.enabledForSend=this.codecContext.enabledLocally&&!this.codecContext.initSendFailed&&!!this.codecConfig?.enableSend&&this.encoder?.isCodecAllowed(m),this.logger.safe.info(`Audio codec state: context=${JSON.stringify(this.codecContext)}`),this.codecContext.initFailed||!g&&this.codecContext.disabledRemotely||(this.sessionStats.toggleState("None"!==m),this.decoderImp?.setCodec(m),this.encoderImp?.setCodec(this.codecContext.enabledForSend?m:"None"))}negotiationCompleted(){if(!this.isEnabled)return!1;const g=this.codecContext.enabledLocally&&!this.codecContext.disabledRemotely;return this.decoderImp?.negotiationCompleted(g),this.encoderImp?.negotiationCompleted(g),this.sessionStats.negotiationCompleted(g,this.codecContext.enabledForSend),g}configureSpatialAudio(g,m){if(!this.isEnabled)return!1;return(g&&"MUCHv2"!==this.codecContext.codec||!g&&"MUCHv2"===this.codecContext.codec)&&this.event("negotiationNeeded").raise(m),!0}subscribeToStreamManagerEvents(g){this.subs.push(g.on("onTransformsCollectionCreated",(g=>this.handleTransformsCollectionCreated(g))),g.on("onTransformsCollectionCleared",(g=>this.handleTransformsCollectionCleared(g))))}handleTransformsCollectionCreated(g){"Audio"===g.mediaType&&(this.decoderImp&&"Receiver"===g.objType?this.decoderImp.activateTransform(g.collection):this.encoderImp&&"Sender"===g.objType&&this.encoderImp.activateTransform(g.collection))}handleTransformsCollectionCleared(g){"Audio"===g.mediaType&&(this.decoderImp&&"Receiver"===g.objType?this.decoderImp.deactivateTransform():this.encoderImp&&"Sender"===g.objType&&this.encoderImp.deactivateTransform())}subscribeToCodecsEvents(){this.decoderImp&&this.subs.push(this.decoderImp.on("initFailed",(g=>this.handleCodecInitFailed("decoder",g)))),this.encoderImp&&this.subs.push(this.encoderImp.on("initCodecFailed",(g=>this.handleCodecInitFailed("encoder",g))))}unsubscribeFromEvents(){this.subs.forEach((g=>g.dispose())),this.subs=[]}handleCodecInitFailed(g,m){"decoder"===g?this.codecContext.initFailed=!0:this.codecContext.initSendFailed=!0;const S=generateCauseId();this.logger.safe.warn(`[${S}] Audio ${g} init failed ${m}`),this.sessionStats.initFailed(m,g),this.event("negotiationNeeded").raise(S)}},ME=class _AudioCodecSessionStats{constructor(){this.sessionEvents={negotiationAttempts:[],toggleCount:0,negotiatedCount:0,failedNegotiationCount:0,decoderInitError:0,encoderInitError:0}}toggleState(g){this.sessionEvents.toggleCount++,this.inProgressNegotiation={ts:Date.now(),enabled:g,negotiated:!1,sendEnabled:!1},arrayLimitedPush(this.sessionEvents.negotiationAttempts,this.inProgressNegotiation,_AudioCodecSessionStats.maxStoreNegotiations)}negotiationCompleted(g,m){this.inProgressNegotiation&&(this.sessionEvents.negotiatedCount+=g?1:0,this.sessionEvents.failedNegotiationCount+=this.inProgressNegotiation.enabled&&!g?1:0,this.inProgressNegotiation.negotiated=g,this.inProgressNegotiation.sendEnabled=m,this.inProgressNegotiation=void 0)}initFailed(g,m){"decoder"===m?this.sessionEvents.decoderInitError=g:this.sessionEvents.encoderInitError=g}getSessionEvents(){return(0,RE.clone)(this.sessionEvents)}};ME.maxStoreNegotiations=5;var wE=ME,DE=class extends je{constructor(g,m){super(),this.configProvider=g,this.logger=m,this.bandwidthEstimationAvailable=!1,this.smoothingWindow=[],this.totalSamples=0,this.isStarted=!1,this.maxCountStatic=this.configProvider.config.ovcMaxCount,this.previousParticipantsCount=0;const S=window.navigator;this.updateStaticConstraint(S.hardwareConcurrency,this.configProvider.config.ovcAvailableConcurrencyForBiggerGrid,4),this.updateStaticConstraint(S.deviceMemory,this.configProvider.config.ovcMemoryForBiggerGrid,4),this.throttler=new OE(this.logger.createChild("ovcThrottler"),this.configProvider.config.ovcRampDownCooldown,this.configProvider.config.ovcRampUpCooldown)}start(){this.isStarted=!0,this.throttler.changed((()=>this.event("calculatorStateChanged").raise(2,{ovc:this.throttler.value,ovcPayload:this.payload})))}stop(){this.isStarted=!1}dispose(){super.dispose(),this.throttler.dispose()}processEstimatedBandwidth(g){const m=this.getOVCEstimate(g),S=Math.max(1,Math.min(m,this.maxCountStatic));this.payload={bandwidth:g,reason:0},this.throttler.setValue(S,0)}updateParticipantCount(g){if(!this.configProvider||g===this.previousParticipantsCount)return;const m=this.configProvider.config.ovcXLParticipantsCount;g>m&&this.previousParticipantsCount<=m&&(this.maxCountStatic=this.configProvider.config.ovcMaxCountXL),g<=m&&this.previousParticipantsCount>m&&(this.maxCountStatic=this.configProvider.config.ovcMaxCount),this.previousParticipantsCount=g;let S=this.maxCountStatic;this.payload?.bandwidth&&(S=this.getOVCEstimate(this.payload.bandwidth),this.payload.reason=1),this.throttler.setValue(Math.max(1,Math.min(S,this.maxCountStatic)),1)}getOVCEstimate(g){this.bandwidthEstimationAvailable||(this.bandwidthEstimationAvailable=this.isStarted&&g>0&&(this.totalSamples++>=this.configProvider.config.ovcIgnoreFirstSamples||Math.floor(g)/this.configProvider.config.ovcBandwidthPerVideoReceiver>=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount));let m=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount;return this.bandwidthEstimationAvailable&&(m=Math.floor(this.sampleSmoothed(g)/this.configProvider.config.ovcBandwidthPerVideoReceiver)),m}sampleSmoothed(g){if(this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples?this.smoothingWindow.shift():this.smoothingWindow.length===this.configProvider.config.ovcSlidingWindowSamples-1&&(this.smoothingWindow=this.smoothingWindow.map((()=>g))),this.smoothingWindow.push(g),this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples){const g=this.smoothingWindow.slice().sort(),m=average(g);return g[g.length-1]-(g[g.length-1]-m*(1-this.configProvider.config.ovcSlidingWindowPercentile))}return g}updateStaticConstraint(g,m,S){g&&g<m&&(this.maxCountStatic=Math.min(this.maxCountStatic,S))}},OE=class extends je{constructor(g,m,S){super(g),this.logger=g,this.throttleDownCooldown=m,this.throttleUpCooldown=S,this.wasRampingUp=!0,this.lastUpdateTime=0}get value(){return this.lastValue}setValue(g,m){if(g===this.lastValue)return;const S=g>this.lastValue,v=void 0!==this.lastValue&&S!==this.wasRampingUp?S?this.throttleUpCooldown:this.throttleDownCooldown:-1,C=Date.now();C-this.lastUpdateTime<v&&(1!==m||S)||(void 0!==this.lastValue&&(this.lastUpdateTime=C,this.wasRampingUp=S),this.logger.safe.info(`optimal video receivers count updated ${this.lastValue} -> ${g}`),this.lastValue=g,this.raiseChanged())}},NE=class _CPUUsageMetricCollector{constructor(g,m=30){this.logger=g,this.maxEventNum=m,this.report=[],this.started=!1}isSupported(){return Boolean(window.chrome?.runtime?.connect)}start(){this.isSupported?(this.started=!0,this.logger.debug("Starting collecting CPU metric"),this.port=window.chrome.runtime.connect(_CPUUsageMetricCollector.extensionID,{name:_CPUUsageMetricCollector.extensionName}),this.port.onMessage.addListener((g=>{g&&arrayLimitedPush(this.report,{timeStamp:Date.now(),value:g},this.maxEventNum)}))):this.logger.debug("Chrome runtime is not supported")}stop(){this.port?.disconnect(),this.port=null,this.started=!1}getSamples(){return this.report}getLastSample(){return getLast(this.report)}getCurrentCpuSample(){return new Promise(((g,m)=>{this.started&&g(getLast(this.report)),this.isSupported()||m("Not supported"),this.port=window.chrome.runtime.connect(_CPUUsageMetricCollector.extensionID,{name:_CPUUsageMetricCollector.extensionName}),this.port.onMessage.addListener((S=>{this.stop(),S||m("Not supported"),g({timeStamp:Date.now(),value:S})}))}))}clearStats(){this.report=[]}};NE.extensionID="nkeimhogjdpnpccoofpliimaahmaaome",NE.extensionName="processCpu";var kE=NE,LE=class{constructor(g){this.logger=g,this.started=!1}static isSupported(){return void 0!==globalThis.PressureObserver}get cpuState(){return this.currentCpuState}start(){if(this.logger.safe.debug("Starting CPU pressure observer"),this.started)this.logger.safe.debug("CPU pressure observer is already started");else{try{this.cpuObserver=new globalThis.PressureObserver((g=>{g.forEach((m=>{"cpu"===m.source&&this.currentCpuState!==m.state&&(this.logger.safe.debug(`CPU pressure state changed: ${JSON.stringify(g)}`),this.currentCpuState=m.state)}))}),{sampleRate:1})}catch(g){throw this.logger.safe.error(`Error while creating pressure observer: ${g}`),g}this.started=!0,this.cpuObserver?.observe("cpu")}}stop(){this.started=!1,this.cpuObserver?.disconnect()}},FE=class{static getStrategy(g){switch(g.config.diagnostics.performanceMonitoring.monitoringStrategy){case"decodeTime":default:return new xE(g);case"renderedFps":return new UE(g);case"rendererVolatility":return new VE(g)}}},xE=class{constructor(g){this.configProvider=g,this.decodeThresholds=this.configProvider.config.diagnostics.performanceMonitoring.decodeThresholds,this.defaultThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultThrehold,this.badPerfCount=new Map}checkQuality(g){let m=!1,S=!1;const v=this.decodeThresholds[g.frameHeight]||this.defaultThreshold,C=g.decodeTimeTracker.getReport();return C.median>v.maxDecodeTime&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)||1),m=!0),C.median<v.maxDecodeTime&&this.badPerfCount.get(g.msi)&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)-1),S=!0),m?0:S?2:1}},UE=class{constructor(g){this.configProvider=g,this.fpsDiffThresholds=this.configProvider.config.diagnostics.performanceMonitoring.fpsDiffThresholds,this.defaultFpsDiffThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultFpsDiffThreshold,this.badPerfCount=new Map}checkQuality(g){let m=!1,S=!1;const v=this.fpsDiffThresholds[g.frameHeight]||this.defaultFpsDiffThreshold,C=g.incomingFps.getReport(),_=g.rendererFps.getReport(),E=C.median-_.median;return E>=v.fpsDiff&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)||1),m=!0),E<v.fpsDiff&&this.badPerfCount.get(g.msi)&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)-1),S=!0),m?0:S?2:1}},VE=class{constructor(g){this.configProvider=g,this.volatilityThresholds=this.configProvider.config.diagnostics.performanceMonitoring.volatilityThresholds,this.defaultVolatilityThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultVolatilityThreshold,this.badPerfCount=new Map}checkQuality(g){let m=!1,S=!1;const v=this.volatilityThresholds[g.frameHeight]||this.defaultVolatilityThreshold,C=g.rendererFps.getReport(),_=g.incomingFps.getReport(),E=Math.abs(C.volatilityPercent-_.volatilityPercent);return v&&E>=v&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)||1),m=!0),E<v&&this.badPerfCount.get(g.msi)&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)-1),S=!0),m?0:S?2:1}},BE=class extends je{constructor(g,m,S,v){super(),this.statsGatherer=g,this.diagnostics=m,this.configProvider=S,this.logger=v,this.paused=!1,this.started=!1,this.cpuMetricCollector=new kE(this.logger,this.configProvider.config.diagnostics.performanceMonitoring.cpuMetricCollector),this.trackInterval=this.configProvider.config.diagnostics.performanceMonitoring.remoteVideoTrackInterval,this.badPerfIds=new Set,this.perfTrackerMap=new Map,this.subs=[],this.rendererFpsCap=40,this.configProvider.config.diagnostics.performanceMonitoring.useComputePressure&&LE.isSupported()&&(this.cpuPressureObserver=new LE(this.logger))}start(){this.logger.safe.debug("Starting RemoteVideoPerformanceCalculator"),this.started?this.logger.safe.debug("RemoteVideoPerformanceCalculator already running. Do nothing."):(this.calculatorStrategy=FE.getStrategy(this.configProvider),this.started=!0,this.cpuPressureObserver?.start(),this.subs.push(this.statsGatherer.on("onDiagnosticUpdated",(g=>this.processStats(g)))))}stop(){this.logger.safe.debug("Stopping RemoteVideoPerformanceCalculator"),this.started=!1,this.subs.forEach((g=>{g.dispose()})),this.cpuMetricCollector.stop(),this.cpuPressureObserver?.stop()}dispose(){this.logger.safe.debug("Disposing RemoteVideoPerformanceCalculator"),this.cleanupMaps(),this.stop()}cleanupMaps(){this.badPerfIds.clear(),this.perfTrackerMap.clear()}async processStats(g){this.paused||g.video?.recv?.length&&g.video?.recv?.forEach((async m=>{const S=m.renderer?.msi;if(!this.perfTrackerMap.has(S)){const g={id:m.mediaEntity.remoteTrackId,decodeTimeTracker:new Vv(this.trackInterval),macroblockLossTracker:new Vv(this.trackInterval),macroblockMaxLossTracker:0,freezeDurationPercent:0,frameHeight:0,rendererFps:new Vv(this.trackInterval),incomingFps:new Vv(this.trackInterval),framesReceived:0,framesDecoded:0,decoder:"",msi:S};this.perfTrackerMap.set(S,g)}const v=this.perfTrackerMap.get(S);if(m.inboundRTP.totalDecodeTime&&m.inboundRTP.framesDecoded){const g=round(m.inboundRTP.totalDecodeTime/m.inboundRTP.framesDecoded*1e3,2);v.decodeTimeTracker.captureSample(g)}const C=m.extensions.macroblockRateStats?.macroblockRateDecoderLossPercent;v.macroblockLossTracker.captureSample(C),v.macroblockMaxLossTracker=m.extensions.macroblockRateStats?.macroblockRateMaxDecoderLossPercent,m.extensions.duration&&(v.freezeDurationPercent=m.extensions.totalFreezeDuration/m.extensions.duration*100),v.frameHeight=m.inboundRTP.frameHeight||0,void 0!==m.extensions.frameRateDecoded&&void 0!==m.inboundRTP.framesPerSecond&&m.extensions.frameRateDecoded<=this.rendererFpsCap&&m.inboundRTP.framesPerSecond<=this.rendererFpsCap&&(v.rendererFps.captureSample(m.extensions.frameRateDecoded),v.incomingFps.captureSample(m.inboundRTP.framesPerSecond)),m.inboundRTP.framesReceived&&m.inboundRTP.framesDecoded&&(v.framesReceived=m.inboundRTP.framesReceived,v.framesDecoded=m.inboundRTP.framesDecoded),v.decoder=m.inboundRTP.decoderImplementation,v.rendererFps.isReportComplete()&&v.incomingFps.isReportComplete()&&v.decodeTimeTracker.isReportComplete()&&(this.paused=!0,await this.checkQuality(v,g.perfCounters),this.paused=!1)}))}async checkQuality(g,m){const S=[];let v;try{v=await this.cpuMetricCollector.getCurrentCpuSample()}catch{this.logger.safe.debug("CPU sampling is not supported")}const C={ts:Date.now(),trackId:g.id,decodeTime:g.decodeTimeTracker.getReport(),macroblockLossPercent:g.macroblockLossTracker.getReport(),macroblockMaxLossPercent:g.macroblockMaxLossTracker,freezeDurationPercent:g.freezeDurationPercent,perfCounters:m,cpuUsage:v,rendererFps:g.rendererFps.getReport(),incomingFps:g.incomingFps.getReport(),framesDecoded:g.framesDecoded,framesReceived:g.framesReceived,msi:g.msi,frameHeight:g.frameHeight,decoder:g.decoder};S.push(C);const _=this.calculatorStrategy.checkQuality(g);0===_&&(this.diagnostics.registerVideoPerformanceEvent(S,1),this.logger.safe.debug(`Bad perf detected for msi ${g.msi}: ${JSON.stringify(S)}`),this.event("calculatorStateChanged").raise(1,{msi:g.msi})),2===_&&(this.diagnostics.registerVideoPerformanceEvent(S,0),this.logger.safe.debug(`Good perf detected for msi ${g.msi}: ${JSON.stringify(S)}`),this.event("calculatorStateChanged").raise(0,{msi:g.msi})),this.perfTrackerMap.delete(g.msi)}},HE=class extends je{constructor(g,m,S,v){super(),this.statsGatherer=g,this.diagnostics=m,this.configProvider=S,this.logger=v,this.calculators=new Map,this.subs=[]}on(g,m){switch(g){case"onIncomingVideoQualityChanged":this.addCalculator(0),this.startCalculator(0);break;case"onOptimalVideoCountChanged":this.addCalculator(2),this.startCalculator(2)}return this.subscribe({changed:void 0,on:{name:String(g),handler:m}})}addCalculator(g){let m=this.calculators.get(g);if(!m){switch(g){case 0:if(!this.configProvider.config.diagnostics.performanceMonitoring.enableRemoteVideoCalculator)return;m=new BE(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("RemoteVideoPerformanceCalculator"));break;case 2:if(!this.configProvider.config.enableOptimalVideoCount)return;m=new DE(this.configProvider,this.logger.createChild("OptimalVideoCountCalculator"));break;case 1:throw new Error("Not implemented")}this.subs.push(m.on("calculatorStateChanged",((m,S)=>{this.handleChanged(g,m,S)}))),this.calculators.set(g,m)}}startCalculator(g){this.logger.safe.debug(`adding calculator with id ${g}`);const m=this.calculators.get(g);m&&m.start()}stopCalculator(g){this.logger.safe.debug(`stopping calculator with id ${g}`);const m=this.calculators.get(g);m&&m.stop()}processNotification(g,m){switch(g){case"BandwithNotification":this.calculators.get(2)?.processEstimatedBandwidth(m.bw);break;case"ParticipantCountChanged":this.calculators.get(2)?.updateParticipantCount(m.count);break;default:this.logger.safe.info(`Notification message handler not found for type: ${g}`)}}dispose(){super.dispose(),this.calculators.forEach((g=>{g.dispose()})),this.subs.forEach((g=>{g.dispose()}))}handleChanged(g,m,S){switch(this.logger.info(`calculatorStateChanged  ${m}: calculatorType ${g} ${JSON.stringify(S)}`),g){case 0:this.configProvider.config.diagnostics.performanceMonitoring.enableLowerResolution&&this.event("onIncomingVideoQualityChanged").raise(m,S?.msi);break;case 2:this.event("onOptimalVideoCountChanged").raise(S?.ovc,S?.ovcPayload)}}},$E=0,GE=class _WebRtcSession2{constructor(g,m,S){this.context=g,this.callId=m,this.callback=S,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc2-"+ ++$E),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.capabiltityGatherer=y_.build({global:this.context.maContext},this.configProvider.config.useSdpCapabilities,this.configProvider.config.noRequiredCodecsWorkaround),this.reinvitelessContext=makeReinvitelessContext(this.context.config.reinvitelessConfig,this.multiParty),this.iceHostCandidateOnly=this.multiParty&&getFrom("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new pE({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:this.multiParty,reinviteltessContext:this.reinvitelessContext}),this.sessionDescription=ES.build({sdpTransform:new cE(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=getFrom("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new uv({streamAdded:g=>this.streamAdded(g),streamRemoved:g=>this.streamRemoved(g)}),this.diagnostics=this.context.diagnostics,this.qmDiagnostics=this.diagnostics?.newQualityManagerDiagnostics(),this.statsGatherer=new g_(this.logger.createChild("stats"),this.configProvider,this.diagnostics,this.mediaManager,this.multiParty),this.qualityManager=new j_(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,customBwEstimationEnabled:this.configProvider.config.webrtcEnabledCustomBwEstimationForVideo,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},this,this.statsGatherer,this.qmDiagnostics,this.configProvider),this.activeSpeakerManager=new lv(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,this.diagnostics?.dshDiagnostics,this.logger.createChild("ActiveSpeakerManager")),this.negotiationQueue=new Ap(this.logger),this.negotiationEmulator=new x_(this.logger.createChild("negotiationEmulator"),dE,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.wasConnected=!1,this.toBeCalledAfterConnected=[],this.peerConnection=null,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new or,this.iceCandidatesTimer=null,this.relayCandidateGathered=!1,this.iceCandidateReceived=!1,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.reinvitelessRequestedModalities={},this.reinvitelessAppliedModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({type:"WebRtcMediaStats",data:{}}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=ey.build({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=getFrom("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new mv(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:g=>this.streamsChangedListener=g},this.diagnostics?.newSubscriptionManagerDiagnostics()),this.remoteVideoResolutionManager=new q_(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.statsGatherer,this.diagnostics),this.remoteVideoManager=new J_(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.statsGatherer,this.diagnostics,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.transceiverManager=null,this.encStreamsManager=new fy(this.configProvider,this.context.maContext.getEncodedStreamsWorkerProvider?.(),this.logger.createChild("EncodedStreamsManager")),this.streamSendersManager=new iE(this.mediaManager,this.logger.createChild("SSM"),this.context.callDeviceManager,this.configProvider,this.statsGatherer,this.qmDiagnostics,this.multiParty,this.encStreamsManager),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new or,this.transportStateProvider=null,this.isMuteHold=!1,this.rawIncomingAudioStreamManager=new Lr(this.logger.createChild("rawIncomingAudioStream")),this.useNullAudioStream=!1,this.audioCodecManager=new PE(this.encStreamsManager,this.logger,this.configProvider),this.perfMonitorSubs=[],this.ufdManager=g.getUfdManager(),this.statsGatherer.on("onStatisticsChanged",(g=>{this.updateQualityLevels(g)})),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((g,m,S,v,C)=>this.requestSource(g,m,S,v,C))),this.performanceMonitor=new HE(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("PerformanceMonitor")),this.setSubsForSubscriptionManager(),this.setSubsForStreamManagerEvents(),this.configProvider.mediaConfig.maxBandwidthInKbps&&(this.statsGatherer.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.diagnostics&&(this.diagnostics.maxSessionBandwidth=this.configProvider.mediaConfig.maxBandwidthInKbps)),this.createAudioRenderer(),this.dmSub=this.getVideoDeviceManager().on("onLocalRendererStarted",(g=>g.setStatsProvider(this.statsGatherer))),this.context.callDeviceManager.isVirtualDeviceEnabled&&this.setupCallDeviceManagerSubs(),this.configProvider.config.enableActiveSpeakerBasedDSH&&this.activeSpeakerManager.setStrategy(new aE({configProvider:this.configProvider})),this.perfMonitorSubs.push(this.performanceMonitor.on("onIncomingVideoQualityChanged",((g,m)=>{this.onIncomingVideoQualityChanged(g,m)}))),this.configProvider.config.webrtcVideoScaling&&(this.perfMonitorSubs.push(this.performanceMonitor.on("onOptimalVideoCountChanged",((g,m)=>{this.onOptimalVideoCountChanged(g,m)}))),this.onOptimalVideoCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount))}get iceTransportPolicy(){return this.configProvider.getIceTransportPolicy()}getAcceptedTypes(){return this.allowedMediaContentType}clone(g,m){const S=shallowClone(this.context);S.config=shallowClone(this.context.config),S.config.webrtcMediaContentType=this.mediaContentType,S.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,S.configProvider=m,S.diagnostics=this.context.diagnostics?.newNativeSession(!1),g?(S.config.isConference=!0,S.config.isPstnCall=!1):(S.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(S.config.webrtcIceGatheringTimeoutIncreased=!0));const v=new _WebRtcSession2(S,this.callId,this.callback);return this.useNullAudioStream&&v.useNullAudioStreamClient(),this.relayManagerProvider&&(v.relayManagerProvider=this.relayManagerProvider),v.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,v}async setCallConstraints(g,m){const S=this.configProvider.setCallConstraints(g);if(this.logger.safe.info(`[${m}] Setting call constraints ${JSON.stringify(S)}, enableDynamicCallConstraints: ${this.configProvider.config.enableDynamicCallConstraints}`),this.configProvider.config.enableDynamicCallConstraints)try{await this.streamSendersManager.applyCallConstraints(m),this.configProvider.addCallConstraintsTelemetryEvent(S,"applied")}catch(g){throw this.logger.safe.error(`Error while applying constraints: ${g}`),g}else this.configProvider.addCallConstraintsTelemetryEvent(S,"applied");return S}setInternals(g,m){if(this.logger.safe.info(`[${m}] Setting internals from previous session`),this.diagnostics?.commitNativeSession(),g.extensionsManager&&this.extensionsManager){const m=g.extensionsManager.getExtension("videoStreamControl");m?.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",m.getOptions())}g.subscriptionManager&&(this.subscriptionManager?.dispose(),this.subscriptionManager=g.subscriptionManager,this.subscriptionManager.setDiagnostics(this.diagnostics?.newSubscriptionManagerDiagnostics()),this.subscriptionManager.setStreamProvider({getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:g=>this.streamsChangedListener=g}),this.subscriptionManager.setLogger(this.logger.createChild("subs")),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),g.audioRenderer&&(g.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=g.audioRenderer),g.remoteVideoManager?.moveRenderers(this.remoteVideoManager),g.rawIncomingAudioStreamManager&&this.rawIncomingAudioStreamManager.updateHandlers(g.rawIncomingAudioStreamManager.handlerMap),this.audioRenderer.getStream()&&this.rawIncomingAudioStreamManager.streamChanged(this.audioRenderer.getStream())}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(g=>this.statsGatherer.setSubscribedTrackIds(g))),this.subscriptionManager.on("onTrackSsrcChanged",(g=>this.statsGatherer.setSubscribedTrackSsrc(g))),this.subscriptionManager.on("onSubscriptionChanged",((g,m,S,v,C,_)=>this.onSubscriptionChanged(g,m,S,v,C,_))),this.subscriptionManager.on("onSubscriptionFailed",((g,m,S,v,C)=>this.statsGatherer.addSubscriptionEvent(g,m,S,v,C)))]}onSubscriptionChanged(g,m,S,v,C,_){m===Ke.MODALITY.video&&(2===g&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount()),3===g&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount())),this.statsGatherer.addSubscriptionEvent(g,m,S,v,null,C,_)}setSubsForStreamManagerEvents(){this.streamSendersManager.on("onSendStreamChanged",((g,m)=>{this.statsGatherer.updateSendStream(g,m),g?.hasAudio()&&this.diagnostics?.setAudioSendStream(g,m),this.diagnostics?.setPresentationAudioOnScreenSharing(g,m)})),this.streamSendersManager.on("onVideoCaptureFreeze",(g=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",g?"Bad":"Good","Video")})),this.streamSendersManager.on("onMaxVideoSendCapabilitiesChanged",((g,m)=>this.onMaxVideoSendCapabilitiesChanged(g,m)))}move(g,m){this.logger.safe.info(`[${m}] moving to new session`),g.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager,rawIncomingAudioStreamManager:this.rawIncomingAudioStreamManager},m),g.muteHold(this.isMuteHold,m),this.doAudioMute?g.muteInputAsync(m):g.unmuteInputAsync(m),this.subscriptionManager=null,this.audioRenderer=null,this.rawIncomingAudioStreamManager=null,this.callbacks.onTerminated=null}setMute(g,m,S){this.logger.safe.info(`[${S}] call setMute for ${g} with mute state ${m}`),this.streamSendersManager.setMuted(g,m,S),this.updateQualityLevels(this.statsGatherer.getLastStatistics())}configureModalitiesAsync(g,m){const S=(async()=>{if(await this.configuredModalitiesPromise,!g||!g.audio&&!g.video&&!g.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(g)}`);const S=shallowClone(g),v=shallowClone(this.negotiatedModalities);this.configProvider.config.alwaysNegotiateDataChannel&&(delete S.data,delete v.data);const C=!this.configuredModalities||!areNegotiatedDirectionsFulfilled(S,v);if(this.configuredModalities=g,this.logger.safe.info(`[${m}] configure modalities`,`audio: ${g.audio}`,`video: ${g.video}`,`sharing: ${g.sharing}`,`data: ${g.data}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?.signalingState??"-"}`,`needNewRenegotiation: ${C}`),C){this.updateSendStreamsReinviteless(m)||(this.configProvider.config.removeSendersOnConfigureModalities&&!isOnHold(this.configuredModalities)&&await this.streamSendersManager.update(this.configuredModalities,!0,m),this.triggerRenegotiation(!1,m))}})();return this.configuredModalitiesPromise=S.catch((g=>{this.logger.safe.warn(`[${m}] Error during configuring modalities: ${stringifyObject(g)}`)})),S}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}createAudioElement(g){this.audioRenderer.assureAudioElement(g)}useNullAudioStreamClient(){this.useNullAudioStream=!0,this.streamSendersManager.useNullAudioStreamClient()}createOfferAsync(g){const m=this.negotiationQueue.add((()=>this.doCreateOfferAsync(g)),g);return this.resetNegotiationQueue(g),m}getTimerTracker(g,m){return this.diagnostics?this.diagnostics.getTimerTracker(g,m):this.statsGatherer.getTimerTracker(g,m)}async doCreateOfferAsync(g){const m=this.getTimerTracker("createOfferAsync",{first:!0});m.mark("start"),this.logger.safe.info(`[${g}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,await this.assurePeerConnectionAsync(g,m.clone("assurePeerConnectionAsync")),m.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${g}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),isOnHold(this.negotiatingModalities)&&!isEmpty(this.negotiatedModalities)&&Object.keys(this.negotiatingModalities).forEach((g=>{void 0===this.negotiatedModalities[g]&&delete this.negotiatingModalities[g]})),this.transceiverManager.assureTransceivers(this.negotiatingModalities);const S=await this.assureStreamsAndDataChannel(this.negotiatingModalities,g,m.clone("assureStreamsAndDataChannel"));m.markAndMeasure("assurePeerConnectionAsync","assureStreamsAndDataChannel"),this.offeredModalities=S,!allowDataChannel(this.context)&&this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[Ke.MODALITY.data]&&this.multiParty&&(this.offeredModalities[Ke.MODALITY.data]=Ke.MEDIA_STATE.inactive),this.configureAudioCodec(),this.logger.safe.info(`[${g}] create [offer] offered: ${JSON.stringify(this.offeredModalities)}`);const v=await this.peerConnection.createOffer();m.markAndMeasure("assureStreamsAndDataChannel","createOffer"),this.logger.unsafe.debug(`[${g}] create [offer] offer from peer connection, sdp: ${v.sdp}`);const C=this.sessionDescription.createLocalOffer(v.sdp);this.hasIceCandidates(C)||this.resetCandidateGathering(g),this.statsGatherer.startWaitingForStreamStart(this.offeredModalities),this.diagnostics&&(this.diagnostics.offeredModalities=S),this.setupIceGatheringTimeout(g);const _=C.toLocal();this.logger.unsafe.debug(`[${g}] create [offer] set local description`,"sdp:",_),await this.peerConnection.setLocalDescription({sdp:_,type:"offer"}),m.markAndMeasure("createOffer","sLD"),await this.iceCandidatesDeferred.promise,m.markAndMeasure("sLD","candidates");const E=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(E),E.updateModalities(this.offeredModalities),this.checkIceCandidates(E);const T=E.toOffer();this.logger.unsafe.debug(`[${g}] CREATE OFFER`,"sdp:",T);const I={blob:T,contentType:this.mediaContentType};return""===this.configProvider.mediaConfig.webrtcRequiredFeatures||this.multiParty||(I.requiredFeatures=this.configProvider.mediaConfig.webrtcRequiredFeatures),this.audioCodecManager.decoder?.setRecvPayloads(E.getPayloadsForMedia(Ke.MEDIA_TYPE.audio)),this.configProvider.countryCode&&(I.clientLocation=this.configProvider.countryCode),this.mediaManager.getMediaEntities().forEach((g=>{g.setExtension("midApplied",!0)})),this.doRetargetIfNeeded(I,C,g),this.reinvitelessContext.enabled&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),I.mediaDescriptions=this.getMediaDescriptions(this.offeredModalities)),this.setBWSeed(I),m.markAndMeasure("start","createOfferAsync"),I}processOfferAsync(g,m){const S=this.negotiationQueue.add((()=>this.doProcessOfferAsync(g,m)),m);return this.resetNegotiationQueue(m),S}async doProcessOfferAsync(g,m){const S=this.getTimerTracker("processOfferAsync",{first:!0});S.mark("start"),this.mediaManager.backup();const v=g.blob;if(this.logger.unsafe.debug(`[${m}] process [offer]`,"sdp:",v),this.configProvider.config.webrtcCompareContentTypeInOffer&&(throwIfNotSupported(g.contentType,this.allowedMediaContentType),this.mediaContentType=g.contentType),this.offerOriginator&&this.offerOriginator!==g.originator&&this.configProvider.config.rejectIncompatibleOriginator)throw{detail:"mediaContent.originator is different on renegotiation",type:Ke.MEDIA_ERROR.incompatibleOriginator};if(this.offerOriginator=g.originator,g.requiredFeatures){const m=this.configProvider.mediaConfig.webrtcRejectedFeatures.split(",");throwIfFeatureNotSupported(g.requiredFeatures.split(","),m)}this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(v),this.canTriggerRenegotiation=!1,this.offeredModalities=invertModalities(this.offeredDescription.getModalities()),this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled());let C=this.configProvider.config.removeUnsupportedVideoModality?this.offeredModalities:shallowClone(this.offeredModalities);if(hasSendDirectionality(this.offeredModalities.video)||hasReceiveDirectionality(this.offeredModalities.video)||hasSendDirectionality(this.offeredModalities.sharing)||hasReceiveDirectionality(this.offeredModalities.sharing)){const g=this.offeredDescription.getVideoCodecs();try{S.mark("startGetCapabilities");const v=await this.capabiltityGatherer.getCapabilities("video");S.markAndMeasure("startGetCapabilities","getCapabilities");v.codecs.some((m=>g.some((g=>m.mimeType===g&&this.configProvider.config.primaryVideoCodecs.includes(g)))))||(this.logger.safe.warn(`[${m}] offer doesn't contain any supported video codecs`),this.disabledModalities.video=C.video,this.disabledModalities.sharing=C.sharing,delete C.video,delete C.sharing)}catch(g){this.logger.safe.error(`[${m}] failed to get video capability ${stringifyObject(g)}`)}}return(!allowDataChannel(this.context)&&(hasSendDirectionality(this.offeredModalities.data)||hasReceiveDirectionality(this.offeredModalities.data))||this.dataChannel&&"Failed"===this.dataChannel.state)&&(this.logger.safe.info(`[${m}] Supressing data modality as data channel is not possible`),C=shallowClone(C),delete C.data),S.markAndMeasure("start","processOfferAsync"),this.logger.safe.info(`[${m}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(C)}`),C}async createAnswerAsync(g,m){if(g)return{blob:"",contentType:this.mediaContentType};const S=this.getTimerTracker("createAnswerAsync",{first:!0});S.mark("start"),this.logger.safe.info(`[${m}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for");const v=this.configuredModalities;let C=this.negotiatingModalities=negotiateModalities(this.offeredModalities,v);await this.assurePeerConnectionAsync(m,S.clone("assurePeerConnectionAsync")),S.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${m}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),await this.handleCodecSwitchUnsupported(m),S.markAndMeasure("assurePeerConnectionAsync","handleCodecSwitchUnsupported"),this.configureAudioCodec();const _=this.offeredDescription.toRemote(C);this.logger.unsafe.info(`[${m}] create [answer] set remote description', 'negotiated:`,C,"sdp:",_),await this.peerConnection.setRemoteDescription({sdp:_,type:"offer"}),S.markAndMeasure("handleCodecSwitchUnsupported","setRemoteDescription"),this.transceiverManager.syncTransceivers(C),this.mediaManager.getMediaEntities().forEach((g=>{g.setExtension("midApplied",!0)})),await this.assureStreamsAndDataChannel(C,m,S.clone("assureStreamsAndDataChannel")),S.markAndMeasure("setRemoteDescription","assureStreamsAndDataChannel"),this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized();const E=await this.peerConnection.createAnswer();S.markAndMeasure("assureStreamsAndDataChannel","createAnswer"),this.logger.unsafe.debug(`[${m}] create [answer] answer from peer connection`,"sdp:",E.sdp);const T=this.sessionDescription.createLocalAnswer(E.sdp);this.hasIceCandidates(T)||this.resetCandidateGathering(m),this.statsGatherer.startWaitingForStreamStart(C),this.diagnostics&&(this.diagnostics.offeredModalities=C),this.setupIceGatheringTimeout(m);const I=T.toLocal();this.logger.unsafe.debug(`[${m}] create [answer] set local description`,"sdp:",I),await this.peerConnection.setLocalDescription({sdp:I,type:"answer"}),S.markAndMeasure("createAnswer","sLD"),await this.iceCandidatesDeferred.promise,S.markAndMeasure("sLD","candidates");const b=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(b),b.updateModalities(C),this.checkIceCandidates(b);const A=b.toAnswer();this.audioCodecManager.decoder?.setRecvPayloads(b.getPayloadsForMedia(Ke.MEDIA_TYPE.audio)),this.checkAudioCodecNegotiated(m),await this.streamSendersManager.activate(m),S.markAndMeasure("candidates","streamSendersManagerActivate"),this.updateLocalMediaSources(),this.applyReceiveCapabilities(),C=b.getModalities(),this.reinvitelessContext.enabled&&(C=removeChangedSendDirection(this.negotiatingModalities,C)),areNegotiatedDirectionsAcceptable(this.configuredModalities,this.negotiatingModalities,C)||this.triggerRenegotiation(!0,m),this.setNegotiatedModalities(C),this.statsGatherer.sessionInfo.setBweType(b.getBweType()),this.diagnostics&&(this.diagnostics.bweType=b.getBweType()),this.logger.unsafe.debug(`[${m}] CREATE ANSWER`,"sdp:",A);const R={blob:A,contentType:this.mediaContentType};return this.configProvider.countryCode&&(R.clientLocation=this.configProvider.countryCode),this.reinvitelessContext.enabled&&(R.mediaDescriptions=this.getMediaDescriptions(C)),this.setBWSeed(R),S.markAndMeasure("start","createAnswerAsync"),R}async processAnswerAsync(g,m,S,v=!1){const C=g.blob;this.logger.unsafe.debug(S?`[${m}] PROCESS PRANSWER`:`[${m}] PROCESS ANSWER`,"sdp:",C);const _=S?"pranswer":"answer";if(S&&(!allowProvisionalAnswer(this.context,v)||"have-local-offer"!==this.peerConnection.signalingState))return void this.logger.safe.info(`[${m}] process [${_}] ignored`);const E=this.getTimerTracker(""+(S?"processProvisionalAnswerAsync":"processAnswerAsync"),{first:!0});E.mark("start");const T=this.sessionDescription.createRemoteAnswer(C);let I=invertModalities(T.getModalities());this.reinvitelessContext.enabled&&(I=removeChangedSendDirection(this.offeredModalities,I));const b=T.toRemote(I);S||(this.mediaContentType=g.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType),isOnHold(I)||(await this.streamSendersManager.update(I,!0,m),E.markAndMeasure("start","streamSendersManagerUpdate"),hasSendDirectionality(this.offeredModalities.data)&&!I.data&&this.dataChannel?.disable()),this.setNegotiatedModalities(I),this.updateLocalMediaSources(),this.statsGatherer.sessionInfo.setBweType(T.getBweType()),this.diagnostics&&(this.diagnostics.bweType=T.getBweType())),this.callbacks.onTransportInitialized?.(),this.logger.unsafe.info(`[${m}] process [${_}] set remote description`,"negotiated:",I,"sdp:",b),E.mark("startSetRemoteDescription"),await this.peerConnection.setRemoteDescription({sdp:b,type:_}),E.markAndMeasure("startSetRemoteDescription","setRemoteDescription"),S||(await this.streamSendersManager.activate(m),E.markAndMeasure("setRemoteDescription","streamSendersManagerActivate"),this.applyReceiveCapabilities(),this.checkAudioCodecNegotiated(m),this.transceiverManager.syncTransceivers(I),E.markAndMeasure("start","processAnswerAsync"))}async completeNegotiationAsync(g){this.mediaManager.commit();const m=this.configuredModalities,S=this.forceMediaStreamUpdate&&!isOnHold(this.negotiatedModalities)||!areNegotiatedDirectionsAcceptable(m,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,v=!S;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${g}] negotiation completed isComplete: ${v} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),S&&this.triggerRenegotiation(!1,g);for(const g of this.getVideoDeviceManager().getLocalVideoRenderers())g.setStatsProvider(this.statsGatherer);return this.negotiationCompletedPromise.resolve(),{isComplete:v,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator}}async rejectNegotiationAsync(g,m,S=!1){let v;this.mediaManager.rollback(),this.logger.safe.warn(`[${m}] negotiation rejected isComplete: ${!S} error: ${stringifyObject(g)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.qualityManager.clearPendingCapabilities();const C=this.getModalitiesForRollback(m);if(this.transceiverManager?.syncTransceivers(C),await this.assureStreamsAndDataChannel(C,m),"have-local-offer"===this.peerConnection?.signalingState){v={},this.logger.safe.info(`[${m}] rolling back local description`);try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRollback){v.type="LocalRN",this.logger.safe.info(`[${m}] rolling back using local renegotiation`);const g=[new vv(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(g,!0),this.logger.safe.info(`[${m}] rolling back using local complete`)}else this.logger.safe.info(`[${m}] rolling back using rollback`),v.type="Rollback",await this.peerConnection.setLocalDescription({type:"rollback"})}catch(g){this.logger.safe.error(`[${m}] rollback error`,g),v.error=g}}else if("have-remote-offer"===this.peerConnection?.signalingState){v={};try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRemoteRollback){v.type="RemoteRN",this.logger.safe.info(`[${m}] applying answer for remote renegotiation`);const g=[new vv(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(g,!0,"remote")}else this.logger.safe.info(`[${m}] rolling back using rollback on remote description`),v.type="Rollback",await this.peerConnection.setRemoteDescription({type:"rollback"})}catch(g){this.logger.safe.error(`[${m}] rollback error`,g),v.error=g}}else this.peerConnection&&this.logger.safe.error(`[${m}] cannot rollback local description in currrent state: ${this.peerConnection.signalingState}`);return this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected"),S&&(this.logger.safe.info(`[${m}] retrying failed negotiation`),this.triggerRenegotiation(!1,m)),{isComplete:!S,activeModalities:C,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator,rollback:v}}async startMediaDescriptionsUpdateAsync(g){return this.reinvitelessAppliedModalities=await this.assureStreamsAndDataChannel(this.reinvitelessRequestedModalities,g),this.updateLocalMediaSources(),await this.streamSendersManager.activate(g),this.getMediaDescriptions(this.reinvitelessAppliedModalities)}async completeMediaDescriptionsUpdateAsync(g){this.logger.safe.info(`[${g}] complete media descriptions update`),this.setNegotiatedModalities(this.reinvitelessAppliedModalities);const m=this.reinvitelessAppliedModalities,S=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:m,requestedModalities:S}}async rejectMediaDescriptionsUpdateAsync(g,m=!1){this.logger.safe.info(`[${g}] reject media descriptions update`),m&&(this.logger.safe.info(`[${g}] trigger renegotiation after failed media descriptions update`),this.triggerRenegotiation(!1,g));const S=await this.streamSendersManager.update(this.negotiatedModalities,!0,g),v=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:S,requestedModalities:v}}createRemoteRenderer(g){return this.remoteVideoManager.createRenderer(g,this.subscriptionManager,this.logger)}getStatsAsync(g){if(this.statsGatherer&&!this.statsGatherer.isDisposed){if(this.audioCodecManager){const g=this.audioCodecManager.getSessionEvents();this.statsGatherer.sessionInfo.setAudiocCodecEvents(g),this.diagnostics&&(this.diagnostics.audioCodecEvents=g)}this.statisticsReport=this.statisticsReport.then((()=>this.statsGatherer.getReport(g))).catch((g=>(this.logger.safe.error(`getting statistics should never fail: ${g.error}`),g.partialReport)))}return this.statisticsReport}getLastKnownStats(g){return this.statsGatherer.getReport(!1,g)}muteHold(g,m){this.logger.safe.info(`[${m}] set muteHold state ${g}`),this.isMuteHold=g;const S=[Ke.MODALITY.audio,Ke.MODALITY.video,Ke.MODALITY.sharing].filter((g=>hasSendDirectionality(this.negotiatedModalities[g])&&(g!==Ke.MODALITY.audio||!this.doAudioMute)));for(const v of S)this.setMute(modalityToMediaType(v),g,m)}async muteInputAsync(g){this.doAudioMute=!0,this.setMute("Audio",!0,g)}async unmuteInputAsync(g){this.doAudioMute=!1,this.setMute("Audio",!1,g)}muteOutputAsync(g){return this.audioRenderer.setMuted(!0,g)}unmuteOutputAsync(g){return this.audioRenderer.setMuted(!1,g)}sendDtmf(g){return this.dtmfSender.sendDtmf(this.peerConnection,g)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(g=generateCauseId()){const m=new or;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(m,g)})),m}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(g){this.statsGatherer.onDeviceEvent(g)}deviceSelectionChanged(){this.peerConnection&&this.audioRenderer?.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId())}async terminate(g,m,S=!0){this.logger.safe.info(`[${g}] terminate`),this.statsGatherer.setTerminated(),this.diagnostics?.terminate(),this.perfMonitorSubs.forEach((g=>g?.dispose())),this.performanceMonitor.dispose(),this.terminated=!0,this.canTriggerRenegotiation=!1,await(this.audioCodecManager.decoder?.storeApiRecording()),this.cleanUp(g);try{S&&await this.getStatsAsync(!1)}catch(m){this.logger.safe.error(`[${g}] Error while gathering stats ${stringifyObject(m)}`)}finally{this.statsGatherer.dispose()}}getIncomingRawAudioStream(){this.logger.info("IRawStream for incoming audio stream requested");const g=this.audioRenderer.getStream();return this.rawIncomingAudioStreamManager.createIRawStreamClient(g)}getUnmixedAudioProvider(){return this.audioCodecManager.decoder?.getUnmixedAudioProvider()}configureSpatialAudio(g,m){this.configProvider.mediaConfig.spatialAudioEnabled=g,this.audioCodecManager.configureSpatialAudio(g,m)||this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable","Bad","Audio",!0,m)}setParticipantSpatialAudioPositions(g,m){if(!this.configProvider.mediaConfig.spatialAudioEnabled||!this.audioCodecManager?.decoder)throw this.logger.safe.error(`[${m}] setParticipantSpatialAudioPositions is called while MUCH audio decoder is not created or not enabled`),"setParticipantSpatialAudioPositions not allowed";this.audioCodecManager.decoder?.setParticipantSpatialAudioPositions(g)}processNotification(g,m){this.performanceMonitor.processNotification(g,m)}cleanUp(g){this.negotiationQueue.dispose(),this.rawIncomingAudioStreamManager?.dispose(),this.remoteVideoManager.dispose(),this.dataChannel&&(this.dataChannel.dispose(),this.dataChannel=null),this.deviceManager.effectsManager.setAecRefStream(null),this.resetPeerConnection(g),this.subscriptionManagerSubs.forEach((g=>g.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.dmSub.dispose(),this.callDeviceManagerSub?.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(g){this.logger.safe.info(`[${g}] reset peer connection`),this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.qualityManager?.dispose(),this.qualityManager=null,this.audioRenderer?.dispose(),this.dtmfSender?.dispose(),this.dtmfSender=null,this.streamSendersManager?.dispose(),this.streamSendersManager=null,this.transceiverManager=null,this.encStreamsManager.dispose(),this.receiveStreamCollection.clear(),this.transportStateProvider?.dispose(),this.transportStateProvider=null,this.audioCodecManager.dispose(),this.mediaManager.reset(),this.peerConnection?.close(),this.peerConnection=null,this.toBeCalledAfterConnected=[],this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(g),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(g){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new or,g)}setNegotiationPromise(g,m=generateCauseId()){this.terminated||(this.negotiationCompletedPromise=g,this.negotiationQueue.add(this.negotiationCompletedPromise,m))}setupExtensionsManager(){const g=new Zv(this.logger.createChild("ExtMgr"));return g.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),g.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,diagnostics:this.qmDiagnostics,configProvider:this.configProvider,statisticsGatherer:this.statsGatherer}),g.addExtension("bandwidthTelemetry",{statisticsGatherer:this.statsGatherer,diagnostics:this.diagnostics}),this.configProvider.config.setBWSeed&&g.addExtension("bandwidthCache",{logger:this.logger,configProvider:this.configProvider}),g}updateQualityLevels(g){if(!g)return;this.hwSilent!==g.audioHwSilent&&(this.hwSilent=g.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.ufdManager.signalEvent("NetworkRecvQuality",g.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:g.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",this.doAudioMute?"Good":g.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:g.networkSendLevel});const m=!(!g.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",m?"Bad":"Good")}triggerRenegotiation(g,m=generateCauseId()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${m}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(m)):g&&(this.logger.safe.info(`[${m}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(g){if(!this.configuredModalities)throw new Error(g)}async handleCodecSwitchUnsupported(g){if(!this.offeredDescription.isCodecSwitchSupported())try{const g=(await this.capabiltityGatherer.getCapabilities(Ke.MEDIA_TYPE.audio)).codecs.map((g=>g.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(g)}catch(m){this.logger.safe.error(`[${g}] failed to set primary codec based on audio capability ${stringifyObject(m)}`)}}assurePeerConnectionAsync(g,m){return this.peerConnectionPromise??(this.peerConnectionPromise=this.getPeerConnectionPromise(g,m)),this.peerConnectionPromise}async getPeerConnectionPromise(g,m){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info(`[${g}] fetching relay details from RelayManager...`);const S={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};m.mark("startQueryRelaysAsync");const v=await this.relayManagerProvider.getRelayManager().queryRelaysAsync(S);if(m.markAndMeasure("startQueryRelaysAsync","queryRelaysAsync"),this.terminated)throw new Error("session already disposed");const C={optional:[]},_=createIceServers(v,this.configProvider.config),E=this.configureCrypto(C);this.configureCpuThreshold(C),this.logger.safe.info("create peer connection");const T="unified-plan",I=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle";try{this.peerConnection=new Us.window.RTCPeerConnection({iceServers:_,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,iceCandidatePoolSize:this.configProvider.config.iceCandidatePoolSize,bundlePolicy:I,sdpSemantics:T,audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===E,encodedInsertableStreams:!!this.configProvider.config.useInsertableStreams},C)}catch(g){throw g.code===DOMException.INVALID_STATE_ERR&&this.ufdManager.signalEvent("NoNetwork","Bad"),g}const b=this.peerConnection;this.isRollbackSupported=1===E&&this.context.configProvider.userAgentConfig.isBrowserRollbackSupported,this.negotiationEmulator.configure(b),this.statsGatherer.initialize(b),this.statsGatherer.sessionInfo.setIceServers(_),this.statsGatherer.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.statsGatherer.sessionInfo.setSdpSemantics(T),this.statsGatherer.sessionInfo.setBundlePolicy(I),this.diagnostics&&(this.diagnostics.iceServers=_,this.diagnostics.iceTransportPolicy=this.iceTransportPolicy,this.diagnostics.sdpSemantics=T,this.diagnostics.bundlePolicy=I),await this.checkVideoCodecsSupport(),m.markAndMeasure("queryRelaysAsync","checkVideoCodecsSupport"),b.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${b.signalingState}`)},b.onsignalingstatechange=()=>{const g=generateCauseId();this.statsGatherer.sessionInfo.setSignalingConnectionState(b.signalingState),this.diagnostics&&(this.diagnostics.signalingConnectionState=b.signalingState),this.logger.safe.info(`[${g}] onsignalingstatechange signalingState: ${b.signalingState}`),this.transportStateProvider&&this.transportStateProvider.subscribeForDtlsTransportState(),this.configProvider.config.reconnectOnPcClose&&!this.terminated&&"closed"===b.signalingState&&this.isTransportConnected()&&this.raiseError({type:Ke.MEDIA_ERROR.unexpectedClose,detail:"PeerConnection is closed"},g)},b.onicecandidateerror=g=>{const m=g,[S,v]=[m.address,m.port];if(this.logger.safe.warn(`On ICE candidate error ${m.url} | ${S}:${v}: code ${m.errorCode}: ${m.errorText}`),!this.isConnected()||this.iceCandidatesDeferred.isPending){const g={address:S,port:+v,url:m.url,errorCode:m.errorCode,errorText:m.errorText};this.statsGatherer.addIceCandidateError(g),this.diagnostics?.addIceCandidateError(g)}};const onAddTrack=g=>{const{track:m,receiver:S,transceiver:v}=g,C=g.streams[0]??new MediaStream([m]);if(!(this.configProvider.config.addAudioStreamBeforeConnection&&Ke.TRACK_KIND.audio===m.kind)&&!this.isConnected())return this.logger.safe.info("ontrack handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onAddTrack(g)));this.logger.safe.info(`ontrack track ${m.id}, stream: ${C?.id}, transceiver=${v?.mid}`);let _=C?.active;if(!_&&this.configProvider.config.useInactiveAudioTrack&&"audio"===m.kind&&(this.logger.safe.warn("ontrack override forcing to use inactive audio stream"),_=!0),!_||"stopped"===v?.currentDirection||v?.stopped)return void this.logger.safe.info("ontrack ignore non active stream");let E=this.mediaManager.getMediaEntityByRemoteStreamId(C.id);if(E||(this.logger.safe.info(`cannot find media entity with stream id ${C.id} trying to fallback`),C.getAudioTracks()[0]&&(E=this.mediaManager.getMediaEntitiesByModality(Ke.MODALITY.audio)[0])),E){const g=this.createReceiveStream(C,S,m,E);E.setRemoteTrackId(m.id),this.addReceiveStreamTransforms(S,E.getModality()),this.receiveStreamCollection.add(g)}else this.logger.safe.error(`could not find media entity for an added stream: ${C.id}`)};b.onaddstream=g=>{this.logger.safe.info(`onaddstream stream: ${g.stream.id}`)},b.ontrack=onAddTrack;const onRemoveStream=g=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onRemoveStream(g)));this.logger.safe.info(`onremovestream stream: ${g.stream.id}`),this.receiveStreamCollection.remove(g.stream.id)};b.onremovestream=onRemoveStream,b.onicecandidate=m=>{const S=m.candidate;if(S){const m=parseCandidateString(S.candidate);if(this.logger.safe.info(`[${g}] onicecandidate candidate: component:${m.component} protocol:${m.protocol} prio:${m.priority} type:${m.type} port:${m.port}`),this.logger.unsafe.info(`[${g}] candidate details: ${S.candidate}`),"1"!==m.component)return;if(this.iceCandidateReceived=!0,this.statsGatherer.sessionInfo.setCandidateDetails(m),this.diagnostics?.setCandidateDetails(m),!this.relayCandidateGathered&&S.candidate.indexOf("typ relay")>-1){const g={priority:S.priority?.toString()||m.priority,time:Date.now()-this.iceRelayCandidatesGatherStartTime};this.statsGatherer.sessionInfo.setRelayCandidateInfo(g),this.diagnostics&&(this.diagnostics.relayCandidateInfo=g),this.relayCandidateGathered=!0}}else this.logger.safe.info(`[${g}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const v=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,C=this.iceHostCandidateOnly||0===_.length;if(!S&&v||C){S&&this.logger.safe.info(`[${g}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${g}] Is connected:`,this.isConnected(),b.iceConnectionState,b.signalingState);let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled&&S){m=this.sessionDescription.createLocalOffer(b.localDescription.sdp).hasUnbundledIceCandidates()}m&&this.completeCandidateGathering(g)}else if(this.relayCandidateGathered){let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled){m=this.sessionDescription.createLocalOffer(b.localDescription.sdp).hasUnbundledRelayIceCandidates()}m&&(this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),this.completeCandidateGathering(g))}},b.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${b.iceGatheringState}`)};const handleTransportState=S=>{if(this.terminated)return;const v=this.wasConnected?generateCauseId():g,C=this.lastTransportConnectionState;if(this.lastTransportConnectionState=S,this.statsGatherer.sessionInfo.setIceConnectionState(S),this.diagnostics&&(this.diagnostics.iceConnectionState=S),"connecting"===S&&m.mark("transportConnecting"),"connected"===S||"completed"===S)m.markAndMeasure("transportConnecting","transportConnected"),this.onTransportConnected(v);else if("failed"===S||"closed"===S&&"failed"!==C){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${v}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(v);this.raiseError({type:Ke.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},v),this.configProvider.config.webrtcCloseAfterIceFailure&&b.close(),this.callbacks.onTransportFailed?.()}"disconnected"===S?(this.callbacks.onTransportDisconnected?.(g),this.startIceDisconnectedTimer(v)):this.clearIceDisconnectedTimer()};this.transportStateProvider=new nE(b,E,this.logger,this.configProvider,(g=>handleTransportState(g))),this.transceiverManager=new gy(this.logger,this.peerConnection,this.mediaManager,this.context,this.reinvitelessContext),this.streamSendersManager.registerRtpSenderManager(this.transceiverManager),allowDataChannel(this.context)&&!this.dataChannel&&(this.dataChannel=new cs(this.peerConnection,this.statsGatherer,this.logger,this.configProvider),this.callback.onDataChannelUpdated(this.dataChannel)),this.multiParty&&(this.contributingSources=new M_(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new w_(this.logger.createChild("ContributingSourcesProvider"),b))),m.mark("startInitialize"),await this.encStreamsManager.initialize(),m.markAndMeasure("startInitialize","encStreamsManagerInitialize");const A=this.encStreamsManager.isWorkerLoaded();this.initAudioCodec(A),this.statsGatherer.sessionInfo.setEncodedStreamWorkerLoaded(A),this.diagnostics&&(this.diagnostics.encodedStreamWorker=A)}configureCrypto(g){let m=!1;const S=preferSdesSrtp(this.context);if(this.offeredDescription){const g=this.offeredDescription.getSrtpInfo();this.statsGatherer.sessionInfo.setOfferedSrtpInfo(g),this.diagnostics&&(this.diagnostics.offeredSrtp=g),m=!g.dtls||g.sdes&&S}else m=S;m&&(this.logger.safe.info("configuring peer connection to use sdes"),g.optional.push({DtlsSrtpKeyAgreement:!1}));const v={dtls:!m,sdes:!!m};return this.statsGatherer.sessionInfo.setNegotiatedSrtpInfo(v),this.diagnostics&&(this.diagnostics.negotiatedSrtp=v),m?0:1}configureCpuThreshold(g){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&g.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(g){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${g}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(g){if(this.logger.safe.info(`[${g}] audio transport connected`),this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),!this.terminated)for(this.wasConnected=!0,this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval&&"have-remote-pranswer"===this.peerConnection.signalingState?this.handleEarlyMediaAudioState(g):this.callbacks.onAudioStateChanged?.(Ke.STREAMING_STATE.active,g),this.callbacks.onTransportConnected?.(g);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}handleEarlyMediaAudioState(g){const m=this.peerConnection.getReceivers().filter((g=>"audio"===g.track.kind))[0];if(!m)return this.logger.safe.warn(`[${g}] Connected transport with provisional answer with no audio receiver`),void this.callbacks.onAudioStateChanged?.(Ke.STREAMING_STATE.active,g);this.callbacks.onAudioStateChanged?.(Ke.STREAMING_STATE.started,g);const S=setInterval((async()=>{try{let v;this.logger.safe.debug(`[${g}] Polling audio receiver stats to detect early media start`);const C=await m.getStats();this.diagnostics?.registerEarlyMediaPoll();for(const g of C.values())if("inbound-rtp"===g.type){v=g;break}(this.terminated||!v||v.bytesReceived>0||"have-remote-pranswer"!==this.peerConnection.signalingState)&&(this.logger.safe.debug(`[${g}] Finished polling early media audio stats ${!this.terminated}`),this.terminated||this.callbacks.onAudioStateChanged?.(Ke.STREAMING_STATE.active,g),clearInterval(S))}catch(m){const v=stringifyObject(m);this.logger.safe.error(`[${g}] Error polling stats for pranswer: ${v}`),this.diagnostics?.addStatsError("WebrtcSession::earlyMediaPolling",v),this.callbacks.onAudioStateChanged?.(Ke.STREAMING_STATE.active,g),clearInterval(S)}}),this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval)}startIceDisconnectedTimer(g){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${g}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise ${Ke.MEDIA_ERROR.iceConnectionError}`),this.raiseError({type:Ke.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},g)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(g,m=generateCauseId()){this.logger.safe.error(`[${m}] Media error occurred type: ${g.type} detail: ${g.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(g,m)}resetCandidateGathering(g){this.logger.safe.info(`[${g}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new or,this.iceCandidateReceived=!1}checkIceCandidates(g){const m=this.hasIceCandidates(g);if(m===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:Ke.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(m){const m=this.hasRelayIceCandidates(g);if(m===this.noRelayIceCandidates){if(!m&&this.isIceConnected())return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledIceCandidates():g.hasIceCandidates()}hasRelayIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledRelayIceCandidates():g.hasRelayIceCandidates()}doRetargetIfNeeded(g,m,S){const v=m.isIceRestart();this.logger.safe.info(`[${S}] ICE restart: ${v}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription&&this.offeredDescription.isMSRTC()&&v&&!this.multiParty&&m.getSrtpInfo().sdes&&(g.newOffer=!0)}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}async streamAdded(g){if(Ke.MODALITY.audio===g.getModality()&&(this.webrtcAudioRecvStream=g.getMediaStream(),await this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),await this.updateAudioRendererStream(this.webrtcAudioRecvStream)),this.configProvider.config.mapSsrcToTrackForStats){const m=this.mediaManager.getMediaEntityByRemoteStreamId(g.getMediaStream().id);this.statsGatherer.setSsrcTrackPair(m.getRemoteSsrc(),m.getRemoteTrackId())}this.notifyStreamsChanged()}async updateAudioRendererStream(g){await this.audioRenderer.play(g),await this.deviceManager.effectsManager.setAecRefStream(g),this.rawIncomingAudioStreamManager.streamChanged(g)}streamRemoved(g){if(Ke.MODALITY.audio===g.getModality())this.audioRenderer.getStream()===g.getMediaStream()&&(this.audioRenderer.stop(),this.rawIncomingAudioStreamManager.streamChanged(null)),this.deviceManager.effectsManager.setAecRefStream(null),this.webrtcAudioRecvStream=null;else if(Ke.MODALITY.video===g.getModality()){const m=this.mediaManager.getMediaEntityByRemoteStreamId(g.getMediaStream().id);m?.getLocalRecvCapabilities()?.resetToInitial()}this.clearReceiveStreamTransforms(g.getReceiver()),g.dispose(),this.notifyStreamsChanged()}setNegotiatedModalities(g){this.logger.safe.info(`setNegotiatedModalities ${JSON.stringify(g)}`),this.negotiatedModalities=g,this.statsGatherer.sessionInfo.setNegotiatedModalities(g),this.diagnostics&&(this.diagnostics.negotiatedModalities=g)}setupIceGatheringTimeout(g){this.iceRelayCandidatesGatherStartTime=Date.now();const m=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!m)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const S=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,S.isPending&&(this.logger.safe.warn(`[${g}] ICE candidates gathering terminated due to timeout ${m}`),S.resolve())}),m)}isConnected(){return this.isTransportConnected()&&"closed"!==this.peerConnection.signalingState}isFailed(){return this.peerConnection&&("failed"===this.lastTransportConnectionState||"closed"===this.lastTransportConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}isIceConnected(){return"connected"===this.peerConnection?.iceConnectionState||"completed"===this.peerConnection?.iceConnectionState}isTransportConnected(){return this.peerConnection&&("connected"===this.lastTransportConnectionState||"completed"===this.lastTransportConnectionState)}createReceiveStream(g,m,S,v){const C=this.configProvider.config.addFmtpToInitialSubscription?v.getLocalRecvCapabilities():null,_=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&v.getModality()!==Ke.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null,E=new Q_(g,m,v.getModality(),+v.getXSourceStreamId(),this,C,_);return new rE(E,S,this.receiveStreamCollection,this.logger.createChild("RecvStream"),this.configProvider.config)}async requestSource(g,m,S,v,C){if(!this.multiParty)return;if((this.isMuteHold||this.negotiatedModalities[g]===Ke.MEDIA_STATE.inactive)&&S!==hv.SourceNone)return await delay2(10),this.requestSource(g,m,S,v);if(this.negotiationCompletedPromise.isPending)try{await this.negotiationCompletedPromise.promise}catch{this.logger.safe.error("source request should be sent even if negotiation rejected")}if(!this.isConnected()){this.logger.safe.info("requestSource is postponed till transport is connected");const g=defer4();this.toBeCalledAfterConnected.push((()=>g.resolve())),await g.promise}const _=this.mediaManager.getMediaEntityByXSourceStreamId(m);return this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(m,S,_?.getMid(),v,C)}async assureStreamsAndDataChannel(g,m,S){this.logger.safe.info(`[${m}] assureStreamsAndDataChannel `,this.negotiatedModalities,"offered",this.offeredModalities," mod ",g),this.dataChannel&&this.dataChannel.updateDataModalityState(g.data),S?.mark("startConfigureHold");const v=await this.configureHold(this.negotiatedModalities,g,m);if(S?.markAndMeasure("startConfigureHold","configureHold"),v)return this.logger.safe.info(`[${m}] Hold is configured. Not updating streams`),g;const C=await this.streamSendersManager.update(g,!1,m,S?.clone("updateStreams"));return S?.markAndMeasure("configureHold","updateStreams"),this.dataChannel&&g.data&&(C.data=g.data),C}async configureHold(g,m,S){const v=isOnHold(g),C=isOnHold(m);return v!==C&&await this.streamSendersManager.setHold(C,S),C}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!0,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}applyReceiveCapabilities(){const g=this.mediaManager.getMediaEntities().map((g=>g.getRemoteRecvCapabilities()));this.multiParty?this.qualityManager.setPendingCapabilities():this.qualityManager.setMaxCapabilities(g)}async onReceiveCapabilitiesChanged(g,m,S){if(!this.streamSendersManager)return!1;try{return await this.streamSendersManager.applyCapabilities(m,g,S),!0}catch(g){return!1}}onOptimalVideoCountChanged(g,m){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(g),this.diagnostics.addOvcSubscriptionReport(g,this.subscriptionManager?.getSubscriptionsCount(),m)}async onSendBandwidthChanged(g){if(!this.isConnected())return;const m=this.extensionsManager.getExtension("videoStreamControl"),S=this.mediaManager.getMediaEntities().filter((g=>[Ke.MODALITY.video,Ke.MODALITY.sharing].indexOf(g.getModality())>-1)).filter((g=>g.isEnabled())).map((g=>g.getMid()));0!==S.length&&(await m.sendBandwidthInfo(S,g),this.statsGatherer.setReportedSendBandwidth(g),this.diagnostics&&(this.diagnostics.reportedSendBandwidth=g))}onMaxVideoSendCapabilitiesChanged(g,m){if("Video"===g&&this.configProvider.config.maxSendVideoCapabilitiesReportingForVideoEnabled||"ScreenShare"===g&&this.configProvider.config.maxSendVideoCapabilitiesReportingForSharingEnabled)return this.isConnected()?void this.notifyMaxVideoCapabilitiesChanged(g,m):(this.logger.safe.info("sendMaxVideoSendCapabilities is postponed till transport is connected"),void this.toBeCalledAfterConnected.push((()=>this.notifyMaxVideoCapabilitiesChanged(g,m))))}notifyMaxVideoCapabilitiesChanged(g,m){const S=this.extensionsManager.getExtension("videoStreamControl"),v=mediaTypeToModality(g),C=this.mediaManager.getMediaEntitiesByModality(v)[0];if(!C)return;const _=C.getMid();S.sendMaxVideoSendCapabilities([_],m)}createAudioRenderer(){this.audioRenderer=new bp(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved),this.audioRenderer.on("onAudioPlaybackError",((g,m,S)=>this.onAudioPlaybackError(g,m,S)))}onAudioPlaybackError(g,m,S){const v={type:m,detail:S,isAudio:!0};this.deviceManager.raiseTelemetryEvent("reconnect_on_audio_playback_error",{error:g,mediaError:m,message:S}),this.context.reconnectRetry&&this.configProvider.config.audioRendererFailedRetryCodes?.includes(g)&&(this.logger.warn(`Reconnect required, attempt No: ${this.context.reconnectRetry}`),this.context.reconnectRetry--,this.raiseError(v))}getModalitiesForRollback(g){const m=removeChangedSendDirection(this.negotiatedModalities,this.negotiatingModalities);return this.logger.safe.debug(`[${g}] configured modalities for rollback: ${JSON.stringify(m)}`),m}fixLocalDescription(g){this.configProvider.config.insertFakeCandidateIfNeeded&&(this.iceCandidateReceived||!this.iceCandidateReceived&&this.isIceConnected())&&g.insertFakeCandidateIfNeeded(this.statsGatherer.sessionInfo,this.diagnostics),g.fixDataModality()}getSessionConfig(){return this.configProvider}getLocalMediaTrackId(g){const m=this.mediaManager.getLocalTracksInfo(),S=mediaTypeToModality(g),v=m.find((g=>g.modality===S));return v?v.trackId:null}addReceiveStreamTransforms(g,m){const S=this.encStreamsManager.initTransformsCollection(g,"Receiver",modalityToMediaType(m));S&&m!==Ke.MODALITY.audio&&this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&S.addTransform(new ly(this.logger.createChild(`RecvStreamAnalyzer [${m}/${g.track.id}]`)))}clearReceiveStreamTransforms(g){this.encStreamsManager.clearTransformsCollection(g)}async checkVideoCodecsSupport(){try{const g=await this.capabiltityGatherer.getCapabilities("video");this.statsGatherer.setH264AvailableProfiles(g);const m=await Vs.isCodecsSupported(this.configProvider.config.hevcCodecs);this.diagnostics&&(this.diagnostics.videoCapabilities=g,this.diagnostics.isCodecsSupported=m);const S=new Set(g?.codecs?.map((g=>g.mimeType.toLocaleLowerCase()))||[]);for(const g of this.configProvider.config.requiredVideoCodecs)if(!S.has(g)){this.ufdManager.signalEvent("NoRequiredVideoCodecs","Bad","Video");break}}catch(g){this.logger.safe.error(`failed to get video capability ${stringifyObject(g)}`)}}getMediaDescriptions(g){if(isOnHold(g))return{};const m=[];for(const S of this.mediaManager.getMediaEntities()){if(!S.getExtension("reinviteless"))continue;const v=g[S.getModality()],C={mid:S.getMid(),direction:!S.getLocalTrackId()&&hasSendDirectionality(v)?removeSendDirectionality(v):v};m.push(C)}return{descriptions:m}}updateSendStreamsReinviteless(g){if(isEmpty(this.negotiatedModalities)||isOnHold(this.negotiatedModalities)||isOnHold(this.configuredModalities))return!1;this.reinvitelessRequestedModalities=shallowClone(this.negotiatedModalities);for(const[g,m]of Object.entries(this.configuredModalities)){const S=this.mediaManager.getMediaEntitiesByModality(g)[0];S?.getExtension("reinviteless")&&(this.reinvitelessRequestedModalities[g]=m)}return!deepEqual(this.reinvitelessRequestedModalities,this.negotiatedModalities)&&(this.callbacks?.onUpdateMediaDescriptionsRequired?.(g),deepEqual(this.reinvitelessRequestedModalities,this.configuredModalities))}setBWSeed(g){if(!this.configProvider.config.setBWSeed)return;const m=this.extensionsManager.getExtension("bandwidthCache").getBWSeed();g.applyChannelParameters={multiChannelParameter:{mids:this.configProvider.config.bwSeedOptions.mids,mediaParameter:JSON.stringify({sendSideBWSeed:{seedValueBitsPerSec:m}})}},this.diagnostics.sentBWSeed=m}getSubscriptionManager(){return this.subscriptionManager}initAudioCodec(g){this.audioCodecManager.init(g);const m=this.audioCodecManager.decoder;m&&(m.on("usedDecoderChanged",(g=>{this.updateAudioRendererStream(g?m.stream:this.webrtcAudioRecvStream),this.statsGatherer.setAudioDecoderStatsProvider(g?m.getStatsProvider():void 0)})),this.audioCodecManager.on("negotiationNeeded",(g=>this.triggerRenegotiation(!0,g))))}configureAudioCodec(){this.audioCodecManager.prepareForNegotiation(this.initiator)}checkAudioCodecNegotiated(g){const m=this.audioCodecManager.negotiationCompleted();if(this.configProvider.mediaConfig.spatialAudioEnabled){const S=m?"Good":"Bad";this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable",S,"Audio",!0,g)}}onIncomingVideoQualityChanged(g,m){1===g&&this.remoteVideoResolutionManager.limitResolutionOnPoorPerformance(m)}getVideoDeviceManager(){return this.context.callDeviceManager.getDeviceManager("Video")}setupCallDeviceManagerSubs(){this.callDeviceManagerSub=this.context.callDeviceManager.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, disposing onLocalRendererStarted sub"),this.dmSub.dispose(),this.logger.info("New onLocalRendererStarted created"),this.dmSub=this.getVideoDeviceManager().on("onLocalRendererStarted",(g=>g.setStatsProvider(this.statsGatherer)))}))}updateLocalMediaSources(){this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statsGatherer.updateStatsWithLocalSsrcTrackInfo();const g=this.streamSendersManager.getLocalMediaSources();this.qualityManager.updateRegisteredSources(g)}},jE={build:(g,m,S)=>new GE(g,m,S)},qE=class{constructor(g,m,S,v,C,_,E,T){this.logger=g,this.context=m,this.configProvider=S,this.diagnostics=v,this.ufdManager=C,this.deviceManager=_,this.capabilities=E,this.midCallTelemetry=T,this.activeSessions=[],this.pendingDeviceTelemetryEvents=[],this.pendingVideoEffectsTelemetryEvents=[],this.pendingAudioEffectsTelemetryEvents=[],this.callsCount=0,this.mediaConfig={},this.configProvider.on("configUpdated",(()=>this.configApplied())),this.deviceManager.on("onDeviceTelemetryEvent",(g=>this.onDeviceTelemetryEvent(g))),this.deviceManager.on("onVideoEffectsTelemetryEvent",(g=>this.onVideoEffectsTelemetryEvent(g))),this.deviceManager.on("onAudioEffectsTelemetryEvent",(g=>this.onAudioEffectsTelemetryEvent(g)))}createSession(g,m,S,v){this.configProvider.setMediaConfiguration(this.mediaConfig);const C=this.configProvider.getConfigView(S?.isConference),_=this.logger,E=this.diagnostics.newSession(C,m,this.logger.createChild("sessionDiagnostics")),T={getLogger:()=>_,getUfdManager:()=>this.ufdManager,maContext:this.context,config:S??{},configProvider:C,diagnostics:E.newNativeSessionDiag(),reconnectRetry:C.config.audioRendererFailedReconnectTimes,callDeviceManager:v},I=(C.mediaConfig.simulcastSessionEnabled?jE:ny).build(T,m,g),b=new ov(C,++this.callsCount,E);b.setMediaQosEnabled(!!this.mediaConfig.enableMediaQoS),b.setPortRangeConfigured(!!this.mediaConfig.mediaPortRanges);const A=new tv(I,m,T,g,b,this.configProvider,E);for(A.on("onTerminated",(g=>this.onSessionTerminated(g))),this.activeSessions.push(A),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector=$S.getInstance(this.logger.createChild("WebRtcInternals"),C),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length);this.pendingDeviceTelemetryEvents.length>0;)A.registerDeviceTelemetryEvent(this.pendingDeviceTelemetryEvents.pop());for(;this.pendingVideoEffectsTelemetryEvents.length>0;)A.registerVideoEffectsTelemetryEvent(this.pendingVideoEffectsTelemetryEvents.pop());for(;this.pendingAudioEffectsTelemetryEvents.length>0;)A.registerAudioEffectsTelemetryEvent(this.pendingAudioEffectsTelemetryEvents.pop());return A}getDeviceManager(){return this.deviceManager}getCapabilities(){return this.capabilities}getScreenSharingManager(){return new qS(this.deviceManager)}updateConfig(g,m,S,v){this.configProvider.updateConfig(g,m,S,v)}getConfig(){return this.configProvider.config}getConfigProvider(){return this.configProvider}setMediaConfig(g){(0,VS.merge)(this.mediaConfig,g),this.diagnostics.mediaConfig=this.mediaConfig}getMediaLogs(){return this.webRtcInternalsCollector?this.webRtcInternalsCollector.collect():Promise.resolve("")}dispose(g){return Promise.all([this.deviceManager.dispose(),this.capabilities.dispose(),...this.activeSessions.map((async m=>{await m.terminate(g,{}).catch((()=>{})),m.dispose()}))]).then((()=>{}),(()=>{}))}handleSendMidCallTelemetry(g){this.midCallTelemetry?.on("sendMidCallTelemetry",g)}configApplied(){window&&(this.configProvider.config.enableDevtoolsAPI?window.webMA||this.injectDevtoolsAPI():window.webMA&&delete window.webMA)}injectDevtoolsAPI(){const g={config:{addOverride:(g,m)=>this.configProvider.setConsoleOverride(g,m),setOverrides:g=>this.configProvider.setConsoleOverrides(g),clearOverride:g=>this.configProvider.clearConsoleOverride(g),clearAllOverrides:()=>this.configProvider.clearAllConsoleOverrides(),setConstraints:g=>this.configProvider.setCallConstraints(g),setRelayConfigOverride:g=>this.context.getRelayManager().setRelayOverride(g)},diagnosticsReport:this.diagnostics.reportGenerator,deviceManager:{setAudioProcessingFlags:g=>this.deviceManager.setAudioProcessingFlags(g)}};window.webMA=g}onDeviceTelemetryEvent(g){this.activeSessions.length>0?this.activeSessions.forEach((m=>m.registerDeviceTelemetryEvent(g))):this.pendingDeviceTelemetryEvents.push(g)}onVideoEffectsTelemetryEvent(g){this.activeSessions.length>0?this.activeSessions.forEach((m=>m.registerVideoEffectsTelemetryEvent(g))):this.pendingVideoEffectsTelemetryEvents.push(g)}onAudioEffectsTelemetryEvent(g){this.activeSessions.length>0?this.activeSessions.forEach((m=>m.registerAudioEffectsTelemetryEvent(g))):this.pendingAudioEffectsTelemetryEvents.push(g)}onSessionTerminated(g){remove2(this.activeSessions,(m=>m===g)),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length),0===this.activeSessions.length&&this.ufdManager.reset()}},WE=class{static build(g,m,S,v,C,_,E,T){return new qE(g,m,S,v,C,_,E,T)}};WE.constants=Ke,WE.helper=Ns;var zE=class{constructor(g,m,S){g.logger??(g.logger=new Sa),g.domOverrides??(g.domOverrides={}),this.config=g;const v=g.mediaSettings;setAgentPlatformInfo(g.clientInformation),this.logger=new US(g.safeLogger?.createChild("MA",v.debug),g.logger.createChild("MA",v.debug)),this.configProvider=new Ep(this.logger.createChild("configProvider"),S,v);const C=new jm(this.configProvider);this.mediaAgentDiagnostics=new xS(this.configProvider,C),this.ufdManager=new _a(this.logger.createChild("UFD"),this.configProvider),this.deviceManager=new Gm(this.logger.createChild("DeviceManager"),this.configProvider,C,g.domOverrides,this.ufdManager,g.webcvProvider,g.wasmdnsProvider,g.wasmaecProvider,g.wasmVqeProvider,g.createWasmWorkerCbs),this.capabilities=new va(this.configProvider),Lp.initialize(this.configProvider),m.on("OnECSChanged",(()=>{const g=m.getEcsConfig("SkypeWebMedia","mediaAgent");g?this.configProvider.updateConfig(g,m.ETag,m.getEcsConfig("ConfigIDs","SkypeWebMedia"),m.getEcsConfig("Headers","CountryCode")):this.logger.warn("No SkypeWebMedia.mediaAgent config.")}))}getDeviceManager(){return this.deviceManager}async buildAgent(g,m,S){if(!Vs.hasMediaApi())throw[new KE(`${g} not supported by media agent provider`,"not_supported")];if(this.config?.detectH264Support&&!await Vs.hasH264CodecSupport(this.config.logger))throw[new KE("H264 is not supported","not_supported")];const v=await buildEncodedStreamWorkerProvider(this.config.createWasmWorkerCbs,this.config.encodedStreamsWorkerProvider),C={getRelayManager:()=>m,getWebCVProvider:()=>this.config.webcvProvider,getWasmDnsProvider:()=>this.config.wasmdnsProvider,getWasmAecProvider:()=>this.config.wasmaecProvider,getWasmVqeProvider:()=>this.config.wasmVqeProvider,getEncodedStreamsWorkerProvider:()=>v,domOverrides:this.config.domOverrides,configProvider:this.configProvider};C.getRelayManager().initialize(this.configProvider);const _=WE.build(this.logger,C,this.configProvider,this.mediaAgentDiagnostics,this.ufdManager,this.deviceManager,this.capabilities,S);return _.constants=WE.constants,_}},KE=class extends Error{constructor(g,m="failure"){super(g),this.reason=m}};async function buildEncodedStreamWorkerProvider(g,m){if(g?.createEncodedStreamsWorker)return{getWorker:()=>g.createEncodedStreamsWorker()};if(m){const g=await m.getWorkerUrl();return{getWorker:()=>new Worker(g)}}return null}var JE=class{constructor(){this.supportedPlatforms=new Map([["Chrome","59.0"],["EdgeAnaheim","79.0"],["Safari","13.1"],["Electron","3.0"],["Firefox","96.0"],["WebView2","1.0"]]),this.experimentalPlatforms=new Map}getPlatformSupportLevel(g){const m=getBrowserInfo(),S=this.supportedPlatforms.get(m.name);if(g&&S&&isVersionGreaterOrEqual(m.version,S))return 1;if(g&&!S){if("Chromium"===m.engine||"ChromiumAVD"===m.engine)return 2;const g=this.experimentalPlatforms.get(m.name);if(g&&isVersionGreaterOrEqual(m.version,g))return 2}return 0}},YE=class extends Ge{constructor(g){super(),this.ecsFilters=g,this.config=null}get ETag(){return this.etag}async setEcsConfig(g){this.config=JSON.parse(g.ecsBlob),this.etag=g.etag,this.event("OnECSChanged").raise()}async setUserEcsServerUrl(g,m){throw new Error("Not implemented")}async getUserEcsServerUrl(g){throw new Error("Not implemented")}async setActiveUserForEcs(g){throw new Error("Not implemented")}async getEcsQueryParameters(){const g={};g.CLRelease=getTsCallingVersion();const m="_TS_BUILC_VERSION_".replace("C","D"),S=this.ecsFilters?.["UserInfo.Ring"]?.value,v=this.getTeamsExperience();g.CLRelease===m&&(g.CLRelease="9999.99"),S&&(g.audienceGroup=S,g.teamsRing=S),v&&(g.Experience=v);const C=getBrowserInfo();return g.BrowserName=C.name,g.BrowserEngine=C.engine,g.BrowserVersion=C.version,g.FormFactor=C.formFactor,Vs.hardwareConcurrency&&(g.CPUCount=Vs.hardwareConcurrency),JSON.stringify(g)}async ecsGetUserQueryParameters(g){return this.getEcsQueryParameters()}async shouldTriggerCQF(g,m,S){throw new Error("Not implemented")}getEcsConfig(g,m){const S=this.config&&this.config[g];return m?S&&S[m]:S}createEcsConfiguration(){return new class{constructor(g){this.provider=g}getBoolean(g,m){return this.provider.getEcsConfig(g,m)}getNumber(g,m){return this.provider.getEcsConfig(g,m)}getString(g,m){const S=this.provider.getEcsConfig(g,m);return JSON.stringify(S)}}(this)}getTeamsExperience(){return!0===this.ecsFilters?.isTeams2?.value?"teams2":!1===this.ecsFilters?.isTeams2?.value?"teams1":void 0}},QE=class{constructor(g){this._sharingSource=g}getId(){return this._sharingSource.getId()}getDeviceId(){return this._sharingSource.getDeviceId()}getType(){return this.mapSharingSourceType(this._sharingSource.getType())}getPreview(g,m,S){return Promise.reject("not implemented")}getPreviewAsync(g,m){return this._sharingSource.getPreviewAsync(g,m)}getDescription(){return this._sharingSource.getDescription()}getIcon(g,m){return this._sharingSource.getIcon(g,m)}getBounds(){}mapSharingSourceType(g){switch(g){case 1:return 1;case 2:return 2;case 3:return 3;default:throw new Error("Invalid sharing source type")}}},XE=class extends Ge{constructor(g){super(),this._screenSharingManager=g,this._screenSharingManager.onScreensChanged((()=>{this.event("screensChanged").raise()}))}enumerateScreensAsync(){return this._screenSharingManager.enumerateScreensAsync().then((g=>g.map((g=>new QE(g)))))}enumerateWindowsAsync(){return this._screenSharingManager.enumerateWindowsAsync().then((g=>g.map((g=>new QE(g)))))}enumerateCamerasAsync(){return this._screenSharingManager.enumerateCamerasAsync().then((g=>g.map((g=>new QE(g)))))}},ZE=R,updateSignalingAgentConfig=(g,m)=>{if(!m)return g;const S={...g};if(m.ngIncoming&&m.ngOutgoing){const v=convertScreenSharingFlag(m.ngIncoming.isVBSSEnabled,m.ngOutgoing.isVBSSEnabled);S.cloudScreenSharingFlag=getParam(v,g.cloudScreenSharingFlag)}return m.ngOutgoing&&(S.emergencyCallCountry=convertEmergencyCallCountryFlag(m.ngOutgoing.isEmergencyCallingEnabled,g.emergencyCallCountry),S.isGVCOutgoingEnabled=getParam(m.ngOutgoing.isGVCEnabled,g.isGVCOutgoingEnabled),S.brokerEnabledOutgoing=getParam(m.ngOutgoing.isBrokerEnabled,g.brokerEnabledOutgoing)),m.ngIncoming&&(S.isGVCJoiningEnabled=getParam(m.ngIncoming.isGVCEnabled,g.isGVCJoiningEnabled),S.brokerEnabledIncoming=getParam(m.ngIncoming.isBrokerEnabled,g.brokerEnabledIncoming)),S.conversationServiceUrl=getUrl(m.conversationServiceUrl,g.conversationServiceUrl),S.uploadLogRequestUrl=getUrl(m.uploadLogRequestUrl,g.uploadLogRequestUrl),S.isConversationServiceUrlFromEcs=!!m.conversationServiceUrl,S.isUploadLogRequestUrlFromEcs=!!m.uploadLogRequestUrl,S.callingTokenLogicalUrl=getUrl(m.callingTokenLogicalUrl,g.callingTokenLogicalUrl),S.doHostlessCalling=getParam(m.allowHostlessCalls,g.doHostlessCalling),S.supportsCompressedServicePayload=getParam(m.supportCompressedTrouterPayload,g.supportsCompressedServicePayload),S.brokerRequestBatching=getParam(m.allowBrokerSubscribeBatching,g.brokerRequestBatching),S.brokerExclusively=getParam(m.brokerExclusively,g.brokerExclusively),S.handleMediaOfferFromPushNotification=getParam(m.handleMediaOfferFromPushNotification,g.handleMediaOfferFromPushNotification),S.handleNewOfferRequest=getParam(m.handleNewOfferRequest,g.handleNewOfferRequest),S.sendProgressFromCC=getParam(m.sendProgressFromCC,g.sendProgressFromCC),S.handleUnmuteMuteFromResponse=getParam(m.handleUnmuteMuteFromResponse,g.handleUnmuteMuteFromResponse),S.useInternalHttpDispatcher=getParam(m.webInternalHttpDispatcher,g.useInternalHttpDispatcher),(m.webInternalHttpDispatcherConfigNetworkRequest||g.requestTypeHttpDispatcherConfigMap)&&(m.webInternalHttpDispatcherConfigNetworkRequest=m.webInternalHttpDispatcherConfigNetworkRequest||{},g.requestTypeHttpDispatcherConfigMap=g.requestTypeHttpDispatcherConfigMap||{},S.requestTypeHttpDispatcherConfigMap={...g.requestTypeHttpDispatcherConfigMap,...m.webInternalHttpDispatcherConfigNetworkRequest}),(m.operationTypeHttpDispatcherConfigMap||g.operationTypeHttpDispatcherConfigMap)&&(m.operationTypeHttpDispatcherConfigMap=m.operationTypeHttpDispatcherConfigMap||{},g.operationTypeHttpDispatcherConfigMap=g.operationTypeHttpDispatcherConfigMap||{},S.operationTypeHttpDispatcherConfigMap={...g.operationTypeHttpDispatcherConfigMap,...m.operationTypeHttpDispatcherConfigMap}),(m.csaTimeoutConfiguration||g.csaTimeoutConfiguration)&&(m.csaTimeoutConfiguration=m.csaTimeoutConfiguration||{},g.csaTimeoutConfiguration=g.csaTimeoutConfiguration||{},S.csaTimeoutConfiguration={...g.csaTimeoutConfiguration,...m.csaTimeoutConfiguration}),S.autoJoinOnConflict=getParam(m.autoJoinOnConflict,g.autoJoinOnConflict),S.enableQuickSendAcceptanceAck=getParam(m.enableQuickSendAcceptanceAck,g.enableQuickSendAcceptanceAck),S.supportMediaRetargetWhileIncomingRenegotiation=getParam(m.supportMediaRetargetWhileIncomingRenegotiation,g.supportMediaRetargetWhileIncomingRenegotiation),S.enableCallEstablishmentTimeoutsForStartJoinCall=getParam(m.enableCallEstablishmentTimeoutsForStartJoinCall,g.enableCallEstablishmentTimeoutsForStartJoinCall),S.callingServiceSupportsCAETokens=getParam(m.callingServiceSupportsCAETokens,g.callingServiceSupportsCAETokens),S.callingServiceSupportsAADTokens=getParam(m.callingServiceSupportsAADTokens,g.callingServiceSupportsAADTokens),S.aadTokenExpirationTimeInSeconds=getParam(m.aadTokenExpirationTimeInSeconds,g.aadTokenExpirationTimeInSeconds),S.caeTokenExpirationTimeInSeconds=getParam(m.caeTokenExpirationTimeInSeconds,g.caeTokenExpirationTimeInSeconds),S.disableTokenMigrationHeader=getParam(m.disableTokenMigrationHeader,g.disableTokenMigrationHeader),S.enablePublishTokenTelemetry=getParam(m.enablePublishTokenTelemetry,g.enablePublishTokenTelemetry),S.refreshTimeBeforeTokenTimeoutInSeconds=getParam(m.refreshTimeBeforeTokenTimeoutInSeconds,g.refreshTimeBeforeTokenTimeoutInSeconds),S.forceClearExpiredTokens=getParam(m.forceClearExpiredTokens,g.forceClearExpiredTokens),S.enableRefreshToken=getParam(m.enableRefreshToken,g.enableRefreshToken),S.enableAsyncDisablePreheat=getParam(m.enableAsyncDisablePreheat,g.enableAsyncDisablePreheat),S.forceLowercaseHttpHeaders=getParam(m.forceLowercaseHttpHeaders,g.forceLowercaseHttpHeaders),S.enableResolveScreenSharingWhenNegotiationComplete=getParam(m.enableResolveScreenSharingWhenNegotiationComplete,g.enableResolveScreenSharingWhenNegotiationComplete),S.maxReinvitelessMediaForVideoForWeb=getParam(m.maxReinvitelessMediaForVideoForWeb,g.maxReinvitelessMediaForVideoForWeb),S.maxReinvitelessMediaForVBSSForWeb=getParam(m.maxReinvitelessMediaForVBSSForWeb,g.maxReinvitelessMediaForVBSSForWeb),S.enableRefreshTokenRetry=getParam(m.enableRefreshTokenRetry,g.enableRefreshTokenRetry),S.enableRefreshTokenRetryInSeconds=getParam(m.enableRefreshTokenRetryInSeconds,g.enableRefreshTokenRetryInSeconds),S.enableConversationTypeUpdateOnCallEnd=getParam(m.enableConversationTypeUpdateOnCallEnd,g.enableConversationTypeUpdateOnCallEnd),S.supportMissingTokenTypesInResponse=getParam(m.supportMissingTokenTypesInResponse,g.supportMissingTokenTypesInResponse),S.useSkypeTokenWhenNoAuthenticateHeader=getParam(m.useSkypeTokenWhenNoAuthenticateHeader,g.useSkypeTokenWhenNoAuthenticateHeader),S.enableAutoPromotion=getParam(m.enableAutoPromotion,g.enableAutoPromotion),S.enableTokenCache=getParam(m.enableTokenCache,g.enableTokenCache),S.enableBatchedSendMessageStatus=getParam(m.enableBatchedSendMessageStatus,g.enableBatchedSendMessageStatus),S.enableBatchedReceiveMessage=getParam(m.enableBatchedReceiveMessage,g.enableBatchedReceiveMessage),S.enableTokenCacheForGenericTokenAPI=getParam(m.enableTokenCacheForGenericTokenAPI,g.enableTokenCacheForGenericTokenAPI),S.disableRealTimeModeFromRoster=getParam(m.disableRealTimeModeFromRoster,g.disableRealTimeModeFromRoster),S.enableLongOutgoing1To1SetupTimeoutForWeb=getParam(m.enableLongOutgoing1To1SetupTimeoutForWeb,g.enableLongOutgoing1To1SetupTimeoutForWeb),S};function getParam(g,m){return null==g?m:g}function getUrl(g,m){return g||m}function convertScreenSharingFlag(g,m){return m&&g?"enabled":g?"recvOnly":!1===g&&!1===m?"disabled":void 0}function convertEmergencyCallCountryFlag(g,m){return!1===g?"":m}var eT,tT,iT="SkypeCalling",nT=class{constructor(g,m,S,v){this.signalingAgentConfig=g,this.ecsProvider=m,this.logger=S,this.telemetryLogger=v,this.ecsProvider.on("OnECSChanged",(()=>this.onEcsUpdate())),this.signalingAgentConfig.clientInformation+=`/TsCallingVersion=${getTsCallingVersion()}/Ovb=${getOvb()}`,this.signalingAgentConfig.piiScrubber={omit:ZE.pii.Omit,mri:ZE.pii.Mri},this.signalingAgent=new wn(this.getSignalingAgentConfig())}getSignalingAgent(){return this.signalingAgent}onEcsUpdate(){const g=this.ecsProvider.getEcsConfig(iT);this.logger.info(`onEcsUpdate, ecsTag=${this.ecsProvider.ETag||""}, ecsConfig=${JSON.stringify(g)}`),this.signalingAgentConfig=updateSignalingAgentConfig(this.signalingAgentConfig,g),this.signalingAgentConfig.ecsEtag=this.ecsProvider.ETag,this.signalingAgent.updateSignalingAgentConfig(this.getSignalingAgentConfig())}getSignalingAgentConfig(){return this.signalingAgentConfig.oneDsTelemetryLogger=this.telemetryLogger,this.signalingAgentConfig}},rT={build:(g,m,S,v)=>new nT(g,m,S,v)};function isValidPersistenceLevel(g){return isNumber3(g)&&g>=1&&g<=2}(tT=eT||(eT={}))[tT.LocalStorage=1]="LocalStorage",tT[tT.SessionStorage=2]="SessionStorage",tT[tT.IndexedDb=3]="IndexedDb";var sT="readwrite",aT="result",oT="DBError: Unable to open database",lT="Database is not open",cT="DBError: Failed to Open Cursor",dT="DBError: Failed to delete the database",hT="DBError: Database does not exist",uT="DBError: Database upgrade required",gT="DBError: Feature not supported",pT=["indexedDB"],mT=isFunction2,fT=isString2;function _getDbFactory(){var g=getGlobal()||{},m=null;if(g)try{for(var S=0;S<pT.length;S++)if((m=g[pT[S]])&&mT(m.open))return m}catch(g){m=null}return m||null}function _debugLog(g,m){getGlobalInst("QUnit")&&console&&console.log("IndexedDbHelper ["+g+"] "+m)}function _warnLog(g,m,S){g&&g.warnToConsole("IndexedDbHelper ["+m+"] "+S)}function _eventReject(g,m,S,v){return function(C){S(new Error(m)),_debugLog(g,"["+v+"] event rejected")}}var ST=[];function _getDbContext(g,m){for(var S=null,v=0;v<ST.length;v++)if((S=ST[v]).name===g)return S;return S={name:g,sch:new Oh("IndexedDbHelper["+g+"]",m),dbHdl:[],add:function(m){S.dbHdl.push(m),_debugLog(g,"- dbOpened (add) -- hdls ["+S.dbHdl.length+"]")},remove:function(m){for(var v=S.dbHdl,C=0;C<v.length;C++)if(v[C]===m){v.splice(C,1);break}_debugLog(g,"- dbClosed (remove) -- hdls ["+S.dbHdl.length+"]")},isOpen:function(){return S.dbHdl.length>0},openHdl:function(){return S.dbHdl.length>0?S.dbHdl[0]:null}},ST.push(S),S}var vT=function(){function IndexedDbHelper2(g){dynamicProto(IndexedDbHelper2,this,(function(m){var S=_getDbFactory()||null;function _createStoreContext(m,S){var v=m.db.transaction(S,sT);return v.onabort=function(){_warnLog(g,m.dbName,"txn.onabort")},v.onerror=function(){_warnLog(g,m.dbName,"txn.onerror")},v.oncomplete=function(){_debugLog(m.dbName,"txn.oncomplete")},{db:m,store:v.objectStore(S),tx:v,tbl:S,openCursor:function(g,v){return _openCursor(m,S,g,v)},newTransaction:function(g){return _openStore(m,S,g)}}}function _openStore(g,m,S){if(!g||!g.db)return bh.reject(new Error(lT));try{var v=S(_createStoreContext(g,m));return v instanceof bh?v:bh.resolve(v)}catch(g){return bh.reject(g)}}function _openCursor(g,m,S,v){if(!g||!g.db)return bh.reject(new Error(lT));var C=null;return S&&fT(S)?C=new CT(S):S&&S.isMatch&&(C=S),new bh((function(S,_){var E=[],T=null,I=null;C&&C.keyRange&&(I=C.keyRange());var b=_createStoreContext(g,m);(T=I?b.store.openCursor(I):b.store.openCursor()).onerror=_eventReject(b.db.dbName,cT,_,"openCursor"),T.onsuccess=function(g){var m=g.target[aT];if(m){var T={store:b,cursor:m,continue:function(){m.continue()},done:function(){S(E)}},I=m.value;if(!C||C.isMatch(I))if(v)try{switch(v(T,I,E)){case 2:S(E);break;case 1:break;default:T.continue()}}catch(g){_(g)}else E.push(I),T.continue();else T.continue()}else S(E)}}))}function _scheduleEvent(g,m,S,v){return _getDbContext(g).sch.scheduleEvent(S,m,v)}m.isAvailable=function(){return!!S},m.openDb=function(m,v,C,_){return _scheduleEvent(m,"openDb",(function(E){return new bh((function(T,I){var b=!1;function _createDbCtx(g,S,C,_,E){var T={db:S,dbName:m,dbVersion:v,ctx:null,isNew:_,txn:C?C.transaction:null};return E||(T.openStore=function(g,m){return _openStore(T,g,m)},T.openCursor=function(g,m,S){return _openCursor(T,g,m,S)}),T}function _databaseUpgrade(g,m){var S=_createDbCtx(null,g,m,!0,!0);if(_)b=!0,_(S).then((function(){S.txn||(S.txn=m.transaction)}),(function(g){try{m.transaction&&m.transaction.abort()}finally{I(g)}}));else try{m.transaction&&m.transaction.abort()}finally{I(new Error(uT))}}function _databaseOpen(S,v){var _=_getDbContext(m);_.add(S),S.onabort=function(v){_warnLog(g,m,"onabort -- closing the Db"),_.remove(S)},S.onerror=function(v){_warnLog(g,m,"onerror -- closing the Db"),_.remove(S)},S.onclose=function(v){_warnLog(g,m,"onclose -- closing the Db"),_.remove(S)},S.onversionchange=function(v){_warnLog(g,m,"onversionchange -- force closing the Db"),S.close(),_.remove(S)};var E=null,A=null;_.dbHdl.length>0&&(A=_.dbHdl[0]),E=_createDbCtx(_,A,v,b);try{C(E).then((function(g){T(g)}),I)}catch(g){I(g)}}var A=_getDbContext(m);if(null==S)I(new Error("No available storage factory"));else if(A.isOpen()){var R=_createDbCtx(A,A.openHdl(),null,!1);C(R).then(T,I)}else{var P=S.open(m,v);P.onblocked=function(S){_warnLog(g,m,"Db Open Blocked event ["+E+"] - "+(P.error||"")),I(new Error(oT))},P.onerror=function(S){_warnLog(g,m,"Db Open Error event ["+E+"] - "+(P.error||"")),I(new Error(oT))},P.onupgradeneeded=function(g){_debugLog(m,"Db Open Create/Upgrade needed event ["+E+"]");try{var S=g.target[aT];if(!S)return void I(new Error(oT));_databaseUpgrade(S,P)}catch(g){_eventReject(m,oT,I,E)(g)}},P.onsuccess=function(g){var m=g.target[aT];m?_databaseOpen(m,P):I(new Error(oT))}}}))}))},m.closeDb=function(g){_scheduleEvent(g,"closeDb",(function(m){var S=_getDbContext(g),v=S.dbHdl,C=v.length;if(C>0){for(var _=0;_<C;_++)v[_].close();S.dbHdl=[]}return bh.resolve(1)}))},m.deleteDb=function(m){return null==S?bh.resolve(!1):_scheduleEvent(m,"deleteDb",(function(v){var C=_getDbContext(m),_=C.dbHdl,E=_.length;if(E>0){_warnLog(g,m,"Db is open ["+E+"] force closing");for(var T=0;T<E;T++)_[T].close();C.dbHdl=[]}return new bh((function(C,_){setTimeout((function(){try{_debugLog(m,"["+v+"] starting");var E=S.deleteDatabase(m);E.onerror=function(S){_warnLog(g,m,"["+v+"] error!!"),_(new Error(dT))},E.onblocked=function(S){_warnLog(g,m,"["+v+"] blocked!!"),_(new Error(dT))},E.onupgradeneeded=function(S){_warnLog(g,m,"["+v+"] upgrade needed!!"),_(new Error(dT))},E.onsuccess=function(g){_debugLog(m,"["+v+"] complete"),C(!0)},_debugLog(m,"["+v+"] started")}catch(S){_warnLog(g,m,"["+v+"] threw - "+S),_(new Error(dT+" - "+S))}}),0)}))}))},m.getDbDetails=function(g){return _scheduleEvent(g,"getDbDetails",(function(m){return null!=S&&S.databases?new bh((function(m,v){S.databases().then((function(S){for(var C=0;C<S.length;C++)if(S[C].name===g)return void m(S[C]);v(new Error(hT))}),v)})):bh.reject(new Error(gT))}),2e3)}}))}return IndexedDbHelper2.__ieDyn=1,IndexedDbHelper2}(),CT=function(){function SimpleQuery2(g){var m=[],S=null;dynamicProto(SimpleQuery2,this,(function(v){v.keyRange=function(){return S},v.parseQuery=function(g){if(m=[],g)for(var C=g.split(";"),_=0;_<C.length;_++){var E=C[_],T=E.indexOf("=");if(-1!==T){var I=E.substring(0,T),b=E.substring(T+1);0===I.indexOf("#")&&(I=I.substring(1),S||(S=IDBKeyRange.bound(b,b+"￿"))),v.startsWith(I,b)}}},v.startsWith=function(g,S){m.push({name:g,value:S,type:0})},v.contains=function(g,S){m.push({name:g,value:S,type:1})},v.isMatch=function(g){if(!m||0===m.length)return!0;if(!g)return!1;for(var S=0;S<m.length;S++){var v=m[S],C=g[v.name];if(C)if(0===v.type){if(0!==C.indexOf(v.value))return!1}else if(1===v.type&&-1===C.indexOf(v.value))return!1}return!0},g&&v.parseQuery(g)}))}return SimpleQuery2.__ieDyn=1,SimpleQuery2}(),_T=10,yT=1,ET=6e5,TT=1008e4,IT="Unknown",bT=-1,AT="DBError: Unable to add event",RT="DBError: Unable to update iKey",PT="AppInsightEvents.1",MT=1,wT="Evts",DT="iKey",OT=isValidPersistenceLevel;function _getTime2(){return(new Date).getTime()}function _eventReject2(g,m){return function(S){return m(new Error(g))}}function _createDb(g){g.objectStoreNames.contains(wT)||g.createObjectStore(wT,{keyPath:"key"}).createIndex("EvntId","key",{unique:!1});g.objectStoreNames.contains(DT)||g.createObjectStore(DT,{keyPath:"iKey"}).createIndex("iKey","iKey",{unique:!0})}function _updateiKey(g){return g.openStore(DT,(function(m){return new bh((function(S,v){var C={iKey:g.ctx.iKey,tm:_getTime2()},_=m.store.put(C);_.onsuccess=function(g){S(_.result.toString())},_.onerror=function(g){v(new Error(AT))},_.onerror=_eventReject2(RT,v)}))}))}function _orderEventsByPriority(g){for(var m=[],S=2;S>=1;S--)for(var v=0;v<g.length;v++){var C=g[v];C&&C.evt.persistence===S&&m.push(C.evt)}return m}function _addEventByTime(g,m){for(var S=0;S<g.length;S++)if(m.tm<g[S].tm)return void g.splice(S,0,m);g.push(m)}function _getKeyIndex(g,m){for(var S=m.length,v=0;v<S;v++)if(g===m[v].id)return v;return-1}function _isOldItem(g,m){var S=g.tm;return _getTime2()-S>m}function _cursorContinueEvent(g){return function(m){return g.continue()}}function _cursorDeleteAndContinue(g){var m=g.cursor.delete();return m.onerror=_cursorContinueEvent(g),m.onsuccess=_cursorContinueEvent(g),1}function _getAllEventsForiKey(g,m){return g.openCursor(wT,m,(function(g,m,S){return S.push(m),0}))}function _deleteEvents(g,m,S){return g.openCursor(wT,m,(function(g,m,v){return S(m)?(v.push(m),_cursorDeleteAndContinue(g)):0}))}function _deleteOrphanedEvents(g){return new bh((function(m,S){var v=!1;g.openCursor(DT,null,(function(g,m,S){var C=m.tm;return _getTime2()-C<TT?0:(v=!0,2)})).then((function(){if(v){var C={};_deleteEvents(g,null,(function(g){if(!g||!g.evt||!g.evt.iKey)return!0;var m=g.tm;return _getTime2()-m>TT||(C[g.evt.iKey]=1,!1)})).then((function(){var v=[];g.openCursor(DT,null,(function(g,m,S){var _=m.tm;return _getTime2()-_<TT||C[m.iKey]?0:(v.push(m),_cursorDeleteAndContinue(g))})).then((function(){m(v)}),S)}),S)}else m([])}),S)}))}function _moveOldEventsToCurrentStore(g){return g.openCursor(wT,"#key="+g.ctx.iKeyPrefix(),(function(m,S){var v=S.key;if(0===v.indexOf(g.ctx.iKeyPrefix())&&-1===v.indexOf(g.ctx.evtKeyPrefix())&&_isOldItem(S,ET)){S.key=g.ctx.evtKeyPrefix()+S.id;var C=m.store.store.put(S);return C.onerror=_cursorContinueEvent(m),C.onsuccess=function(g){try{_cursorDeleteAndContinue(m)}catch(g){m.continue()}},1}return 0}))}function _checkVersionAndMoveEventsToCurrentStorage(g){return new bh((function(m,S){_deleteOrphanedEvents(g).then((function(){_moveOldEventsToCurrentStore(g).then(m,m)}),S)}))}function _dropEventsUpToPersistence(g,m){return new bh((function(S,v){var C=0,_=g.ctx.evtKeyPrefix();function _resolveWithDroppedEvents(){S(C)}function _dropEvent(g,m){return new bh((function(S){var v=g.store.delete(m.key);v.onsuccess=function(g){C++,S()},v.onerror=function(g){S()}}))}function _processCandidates(m){0!==m.length?g.openStore(wT,(function(g){for(var S=[],v=0;v<m.length;v++)S.push(_dropEvent(g,m[v]));return bh.all(S).then(_resolveWithDroppedEvents,_resolveWithDroppedEvents)})):_resolveWithDroppedEvents()}g.openCursor(wT,"#key="+_,(function(g,S,v){return S.evt.persistence<=m&&0===S.key.indexOf(_)&&(_addEventByTime(v,S),v.length>_T&&v.splice(v.length-1,1)),0})).then(_processCandidates,(function(){S(0)}))}))}var NT=function(){function IndexedDbProvider2(g){dynamicProto(IndexedDbProvider2,this,(function(m){var S=null,v=null,C=IT,_=null,E=null,T=null,I=bT,b=0;function _openDb(g){function _handleDbUpgrade(g){return new bh((function(m,S){_createDb(g.db),m()}))}function _handleDbOpen(m){return new bh((function(S,v){var I={iKey:C,storageId:_,iKeyPrefix:function(){return E},evtKeyPrefix:function(){return T}};m.ctx=I,_updateiKey(m).then((function(){g(m).then(S,v)}),v)}))}return S.openDb(v,MT,_handleDbOpen,_handleDbUpgrade)}function _addDbEvent(g,m,S){return new bh((function(v,C){function dropEvents(m,S){_dropEventsUpToPersistence(g,m).then((function(g){g>0&&(b-=g),S(g)}),(function(g){S(0)}))}function resolveAddEvent(g){v(m.evt)}function _insertNewEvent(){g.openStore(wT,(function(_){var E=_.store.put(m);E.onsuccess=function(C){S&&_updateiKey(g).then(resolveAddEvent,resolveAddEvent),b++,v(m.evt)},E.onerror=function(_){function _retryAddEvent(S){0===S&&C(new Error(AT)),_addDbEvent(g,m,!1).then((function(g){v(m.evt)}),(function(){C(new Error(AT))}))}S?dropEvents(1,(function(g){g>0?_retryAddEvent(g):m.evt.persistence>=2?dropEvents(2,(function(g){_retryAddEvent(g)})):C(new Error(AT))})):C(new Error(AT))}}))}I>0&&b>=I?dropEvents(1,(function(g){0===g?m.evt.persistence>=2?dropEvents(2,(function(g){_insertNewEvent()})):C(new Error(AT)):_insertNewEvent()})):_insertNewEvent()}))}m.id=g,m.initialize=function(g){var b=g.itemCtx.diagLog();if(!(S=new vT(b)).isAvailable())return S=null,!1;var A=g.itemCtx.getCfg(),R=g.storageConfig||{};return v=R.indexedDbName||PT,C=A.instrumentationKey||C,_=m.id||g.id||newGuid2(),T=(E=C+"::")+_+"::",I=R.maxStorageItems>0?R.maxStorageItems:I,_openDb((function(g){return g.isNew?bh.resolve(!0):_checkVersionAndMoveEventsToCurrentStorage(g)})).then((function(g){}),(function(g){b.warnToConsole("IndexedDbProvider failed to initialize - "+(g||"<unknown>")),S=null})),!0},m.supportsSyncRequests=function(){return!1},m.getAllEvents=function(){return null!=S&&S.isAvailable()?_openDb((function(g){return new bh((function(m,S){_getAllEventsForiKey(g,"#key="+g.ctx.evtKeyPrefix()).then((function(g){b=g.length,m(_orderEventsByPriority(g))}),S)}))})):bh.resolve([])},m.addEvent=function(g,m,v){return null!=S&&S.isAvailable()?(m.id=m.id||newGuid2(),OT(m.persistence)||(m.persistence=1),_openDb((function(S){var v=g||m.id,C={key:S.ctx.evtKeyPrefix()+v,id:v,evt:m,tm:_getTime2(),v:yT};return _addDbEvent(S,C,!0)}))):bh.resolve(m)},m.removeEvents=function(g){if(null==S||!S.isAvailable())return bh.resolve([]);var m=[];return new bh((function(S,v){_openDb((function(S){return S.openCursor(wT,"#key="+S.ctx.iKey,(function(S,v,C){if(-1!==_getKeyIndex(v.id,g)){var _=S.cursor.delete();return _.onerror=_cursorContinueEvent(S),_.onsuccess=function(){m.push(v.evt),S.continue()},1}return 0}))})).then((function(g){b-=m.length,S(m)}),(function(g){b-=m.length,S(m)}))}))},m.clear=function(){return null!=S&&S.isAvailable()?new bh((function(g,m){_openDb((function(g){return _deleteEvents(g,"#key="+g.ctx.evtKeyPrefix(),(function(m){return 0===m.key.indexOf(g.ctx.evtKeyPrefix())}))})).then((function(m){b=0,g(_orderEventsByPriority(m))}),m)})):bh.resolve([])},m.teardown=function(){S&&S.closeDb(v)}}))}return IndexedDbProvider2.__ieDyn=1,IndexedDbProvider2}(),kT=10,LT="3",FT="Version",xT=6e5,UT="AWTEvents",VT=5e6;function _isQuotaExceeded(g,m){var S=!1;return m instanceof DOMException&&(22!==m.code&&"QuotaExceededError"!==m.name&&1014!==m.code&&"NS_ERROR_DOM_QUOTA_REACHED"!==m.name||g&&0!==g.length&&(S=!0)),S}function _getAvailableStorage(g){var m=getGlobal()||{},S=null;try{if(S=m[g]){var v="__storage_test__";S.setItem(v,v),S.removeItem(v)}}catch(g){_isQuotaExceeded(S,g)||(S=null)}return S}function _forEachMap(g,m){if(g)for(var S=objKeys(g),v=0;v<S.length;v++){var C=S[v];if(!m(g[C],C))break}}function _isMapEmpty(g){var m=!0;return _forEachMap(g,(function(g,S){return g&&(m=!1),m})),m}function _dropEventsUpToPersistence2(g,m){for(var S=1,v=0,_loop_1=function(){var g=[],C=m[S];if(_forEachMap(C,(function(m,S){return g.push(S),++v<kT})),v>0){for(var _=0;_<g.length;_++)delete C[g[_]];return{value:!0}}S++};S<=g&&v<kT;){var C=_loop_1();if("object"==typeof C)return C.value}return v>0}var BT=isValidPersistenceLevel,HT=function(){function WebStorageProvider2(g,m){dynamicProto(WebStorageProvider2,this,(function(S){var v=null,C=UT,_=null,E=LT,T=null,I=null,b=VT,A=null,R=null;function _newStore(g,m){return{key:g,db:m}}function _fetchStoredDb(g,m){void 0===m&&(m=!0);var S=null;if(v){var C=v.getItem(g);if(C)try{S=JSON.parse(C)}catch(m){v.removeItem(g)}}return m&&!S&&(S={events:{1:{},2:{},3:{}},lastAccessTime:0}),_newStore(g,S)}function _updateStoredDb(g,m){void 0===m&&(m=!0);var S=!0,C=g.db;if(C){m&&(C.lastAccessTime=(new Date).getTime());for(var _=1;_<=2;_++)if(!_isMapEmpty(C.events[_])){S=!1;break}}try{if(S)v&&v.removeItem(g.key);else{var E=JSON.stringify(C);if(E.length>b)return!1;v&&v.setItem(g.key,E)}}catch(g){return!1}return!0}function _clearDatabase(g){var m=[],S=_fetchStoredDb(g,!1),C=S.db;if(C){var _=C.events;try{for(var E=1;E<=2;E++)_forEachMap(_[E],(function(g,S){return g&&m.push(g),!0}))}catch(g){}v&&v.removeItem(S.key)}return m}function _checkVersionAndMoveEventsToCurrentStorage2(){if(v){for(var g=v.getItem(A),m=[],S=_fetchStoredDb(R),_=!1,T=0;T<v.length;T++){var b=v.key(T);if(0===b.indexOf(C)&&b!==A){if(g!==LT){m.push(_newStore(b,null));continue}var P=_fetchStoredDb(b,!1),M=P.db;if(M){if((new Date).getTime()-M.lastAccessTime>xT){for(var w=1,_loop_3=function(){var g=M.events[w],m=S.db.events[w];_forEachMap(g,(function(S,v){return(getTenantId(S.iKey)||S.iKey)===I&&(m[v]=S,delete g[v]),!0})),w++};w<=2;)_loop_3();_=!0,m.push(P)}}else m.push(_newStore(b,null))}}for(T=0;T<m.length;T++)_updateStoredDb(m[T],!1);_&&_updateStoredDb(S),v.setItem(A,E)}}S.id=m,v=_getAvailableStorage(g)||null,S.initialize=function(g){if(!v)return!1;var m=g.storageConfig||{};return b=m.maxStorageSizeInBytes>0?m.maxStorageSizeInBytes:b,C=m.storageKey||UT,_=S.id||g.id||newGuid2(),R=C+"."+_,A=C+FT,T=g.itemCtx.getCfg().instrumentationKey,I=getTenantId(T)||T,_checkVersionAndMoveEventsToCurrentStorage2(),!0},S.supportsSyncRequests=function(){return!0},S.getAllEvents=function(){try{var g=[],m=_fetchStoredDb(R,!1).db;if(m)for(var S=m.events,v=2;v>=1;v--)_forEachMap(S[v],(function(m){m&&((getTenantId(m.iKey)||m.iKey)===I&&g.push(m));return!0}));return bh.resolve(g)}catch(g){return bh.reject(g)}},S.addEvent=function(g,m,S){try{var v=_fetchStoredDb(R);m.id=m.id||newGuid2(),BT(m.persistence)||(m.persistence=1);for(var C=m.persistence,_=m.id,E=v.db.events;;){if(E[C][_]=m,_updateStoredDb(v))return bh.resolve(m);if(delete E[C][_],!_dropEventsUpToPersistence2(C,E))return bh.reject(new Error("Unable to free up event space"))}}catch(g){return bh.reject(g)}},S.removeEvents=function(g){try{var m=_fetchStoredDb(R,!1),S=m.db;if(S){var v=S.events;try{for(var C=0;C<g.length;++C){var _=g[C];delete v[_.persistence][_.id]}if(_updateStoredDb(m))return bh.resolve(g)}catch(g){}g=_clearDatabase(m.key)}return bh.resolve(g)}catch(g){return bh.reject(g)}},S.clear=function(){try{var g=[],m=_fetchStoredDb(R,!1),S=m.db;if(S){for(var v=S.events,_loop_2=function(m){var S=v[m];_forEachMap(S,(function(m){m&&((getTenantId(m.iKey)||m.iKey)===I&&(delete S[m.id],g.push(m)));return!0}))},C=2;C>=1;C--)_loop_2(C);_updateStoredDb(m)}return bh.resolve(g)}catch(g){return bh.reject(g)}},S.teardown=function(){try{var g=_fetchStoredDb(R,!1),m=g.db;m&&(m.lastAccessTime=0,_updateStoredDb(g,!1))}catch(g){}}}))}return WebStorageProvider2.__ieDyn=1,WebStorageProvider2}(),$T="3.2.9",GT="LocalStorage",jT=5,qT=isValidPersistenceLevel,WT=function(g){function LocalStorageChannel2(){var m=g.call(this)||this;return m.identifier=GT,m.priority=1009,m.version=$T,dynamicProto(LocalStorageChannel2,m,(function(g,m){var S,v,C,_;function _initDefaults(){S=!1,v=!1,C=null,_=[]}function _queueStorageEvent(g,m){C||(C=new Oh("LocalStorage")),C.scheduleEvent((function(g){return m(g)}),g)}function _sendStoredEventsToNextPlugin(m){doPerf(g.core,(function(){return"LocalStorageChannel:_sendStoredEventsToNextPlugin"}),(function(){_queueStorageEvent("sendToNext",(function(S){return m.provider.getAllEvents().then((function(S){for(var v=0;v<S.length;v++)try{var C=S[v];(getTenantId(C.iKey)||C.iKey)===m.tenantId&&g.processNext(C,m.coreRootCtx.createNew())}catch(g){}}))}))}),(function(){return{iKeyConfig:m}}))}function _removeEvents(m,S){doPerf(g.core,(function(){return"LocalStorageChannel:_removeEvents"}),(function(){_queueStorageEvent("removeEvents",(function(g){var v=[];return arrForEach(S,(function(g){(getTenantId(g.iKey)||g.iKey)===m.tenantId&&v.push(g)})),v.length>0?m.provider.removeEvents(v).then((function(g){})).catch((function(g){})):bh.resolve()}))}),(function(){return{iKeyConfig:m,events:S}}))}function _shouldCacheEvent(g,m){return!(m.sync||m.persistence<g.minPersistenceCacheLevel)}function _tryGetIndexedDbProvider(g){var m=new NT;return m.initialize(g)||(m=null),m}function _tryGetWebStorageProvider(g,m){var S=new HT(g);return S.initialize(m)||(S=null),S}function _initializeProvider(g){for(var m=g.storageConfig.providers,S=null,v=0;!S&&v<m.length&&v<jT;)switch(m[v++]){case eT.LocalStorage:S=_tryGetWebStorageProvider("localStorage",g);break;case eT.SessionStorage:S=_tryGetWebStorageProvider("sessionStorage",g);break;case eT.IndexedDb:S=_tryGetIndexedDbProvider(g)}return S}function _getCoreItemCtx(m,S,v,C){m&&(m.extensionConfig=m.extensionConfig||[]),!C&&S&&(C=S.getProcessTelContext().getNext());var _=null,E=g._getTelCtx().getNext();return E&&(_=E.getPlugin()),new Dd(C,m,S,_)}function _createIkeyConfig(m,S,v,C){var E=g.identifier,T=m.extensionConfig=m.extensionConfig||[],I=T[E]=T[E]||{};I.providers||(I.providers=[eT.LocalStorage,eT.IndexedDb]);var b=_getCoreItemCtx(m,S,v,C),A={itemCtx:b,storageConfig:I,id:g.id},R=_initializeProvider(A);if(R){var P={iKey:m.instrumentationKey,tenantId:getTenantId(m.instrumentationKey)||m.instrumentationKey,minPersistenceCacheLevel:1,coreRootCtx:b,providerContext:A,provider:R};qT(I.minPersistenceLevel||-1)&&(P.minPersistenceCacheLevel=I.minPersistenceLevel),_.push(P),S.addNotificationListener({eventsSent:function(g){_removeEvents(P,g)},eventsDiscarded:function(g,m){_removeEvents(P,g)}}),_sendStoredEventsToNextPlugin(P)}}_initDefaults(),g.initialize=function(g,v,_,E){doPerf(v,(function(){return"LocalStorageChannel.initialize"}),(function(){S||(m.initialize(g,v,_),m.setInitialized(!1),S=!0,C=new Oh("LocalStorage",v.logger)),_createIkeyConfig(g,v,_,E)}),(function(){return{coreConfig:g,core:v,extensions:_,pluginChain:E}}))},g.processTelemetry=function(m,C){var E=m;if(S&&!v){C=g._getTelCtx(C),setProcessTelemetryTimings(m,g.identifier);var T=null;arrForEach(_,(function(g){g.iKey===m.iKey&&(T=g)}));var I=T?T.provider:null;if(E.sync||!I)return void g.processNext(E,C);E.id=E.id||newGuid2(),isValidPersistenceLevel(E.persistence)||(E.persistence=1),_shouldCacheEvent(T,E)&&_queueStorageEvent("processTelemetry",(function(g){return I.addEvent(E.id,E,C)}))}g.processNext(E,C)},g.pause=function(){v=!0},g.resume=function(){doPerf(g.core,(function(){return"LocalStorageChannel:resume"}),(function(){v=!1,arrForEach(_,(function(g){g.provider&&_sendStoredEventsToNextPlugin(g)}))}))},g._doTeardown=function(g,m){arrForEach(_,(function(g){var m=g.provider;m&&m.teardown()})),_initDefaults()},g.flush=function(g,m){}})),m}return __extendsFn(LocalStorageChannel2,g),LocalStorageChannel2.__ieDyn=1,LocalStorageChannel2}(Ld),zT=WT,KT=class{constructor(g,m,S,v,C,_,E){this.logger=g,this.configProvider=m,this.clientInfo=S,this.eventLatency=v,this.contextProvider=C,this.accountCollectorURL=_,this.envOverride=E,this.manager=new up,this.managerConfig=this.createConfigForManager(),this.currentTransmitProfile=Ke.REPORTING_PROFILE.RT_PROFILE,this.initManager(),this.uiVersion=this.getUiVersion(),this.configProvider.on("configUpdated",(()=>this.updateChannelConfig()))}createLogger(g){return new JT(g,this.manager,this.logger,this.configProvider,this.uiVersion,this.eventLatency,this.contextProvider,this.envOverride)}createConfigForManager(){const g={extensionConfig:{LocalStorage:{storageKey:"TsCalling"}},propertyConfiguration:{populateBrowserInfo:!0,populateOperatingSystemInfo:!0},channelConfiguration:{eventsLimitInMem:this.configProvider.config.eventsLimitInMem},endpointUrl:this.accountCollectorURL,enableCompoundKey:this.configProvider.config.enableCompoundKey};if(this.configProvider.config.useLocalStorageForOneDs){const m=new zT;g.channels=[[m]]}return g}getUiVersion(){const g=this.clientInfo.match(/^.*?\/(\d+\/)(.*?)\/.*$/);return g?g[1]+g[2]:this.clientInfo}updateChannelConfig(){this.configProvider.config.eventsLimitInMem!==this.managerConfig.channelConfiguration.eventsLimitInMem&&this.manager.getPostChannel().setEventQueueLimits(this.configProvider.config.eventsLimitInMem),this.setTransmitProfile()}initManager(){this.manager.create(this.managerConfig,[]);this.manager.getPostChannel()._notificationManager.addNotificationListener({eventsDiscarded:(g,m)=>this.logDiscardedEvents(g,m),eventsSent:g=>this.logSentEvents(g)}),this.setTransmitProfile()}logDiscardedEvents(g,m){let S="discarded events:";g.forEach((g=>S=`${S+g.name};`)),this.logger.info(`${S} reason:${m}`)}logSentEvents(g){let m=`sent events: ${g[0]?.data?.CorrelationId&&getFrom("value",g[0].data.CorrelationId)}:`;g.forEach((g=>{m=`${m+g.name};`})),this.logger.info(`${m}`)}setTransmitProfile(){this.configProvider.config.transmitProfileTimings.length&&this.manager.getPostChannel()._loadTransmitProfiles({[this.configProvider.config.transmitProfileName]:this.configProvider.config.transmitProfileTimings}),this.configProvider.config.transmitProfileName!==this.currentTransmitProfile&&this.manager.getPostChannel()._setTransmitProfile(this.configProvider.config.transmitProfileName),this.currentTransmitProfile=this.configProvider.config.transmitProfileName}},JT=class{constructor(g,m,S,v,C,_,E,T){this.tenant=g,this.manager=m,this.logger=S,this.configProvider=v,this.uiVersion=C,this.eventLatency=_,this.contextProvider=E,this.envOverride=T,this.instanceConfig={extensions:[],extensionConfig:[]}}sendEvent(g){this.setEnvPropertiesToEveryEvent();const m=this.configProvider.config.telemetryTenants[this.tenant],S=this.manager.getInst(m)??this.manager.newInst(m,this.instanceConfig,[]),v=g.props,C={};switch(this.logger.info(`preparing event for delievery: ${g.props?.CorrelationId??""}/${g.eventName}`),this.tenant){case"signaling":v.SkypeId&&(C.user_id={value:v.SkypeId,kind:10},C.Skype_InitiatingUser_Username={value:v.SkypeId,kind:10},C.SkypeId={value:v.SkypeId,kind:10},delete v.SkypeId),this.uiVersion&&(C.ui_version={value:this.uiVersion,kind:0});break;case"media":case"tlePlayer":this.uiVersion&&(C.uiVersion={value:this.uiVersion,kind:0});break;case"realtimeMedia":this.uiVersion&&(C["AppInfo.Version"]={value:this.uiVersion,kind:0})}for(const g of Object.keys(v)){const m=v[g];C[g]={value:m?.value??m,kind:m?.piiKind??0}}const _={name:g.eventName,data:C,latency:this.eventLatency,persistence:dh.Normal};this.configProvider.config.useSendBeaconSync&&(_.sync=2),this.logger.info(`about to send event ${JSON.stringify(_)}`),S.track(_)}setEnvPropertiesToEveryEvent(){const g=this.contextProvider?.();if(!deepEqual(this.ctx,g)&&(this.ctx=g,this.ctx))if(this.envOverride){for(const g of Object.keys(this.envOverride||{}))if(this.ctx[g]){const m=this.ctx[g].piiKind??0,S=convertContextProperty(this.ctx[g].value);this.manager.getPropertyManager().setProperty(this.envOverride[g],{value:S,kind:m})}}else for(const g of Object.keys(this.ctx)){const m=this.ctx[g].piiKind??0,S=convertContextProperty(this.ctx[g].value);this.manager.getPropertyManager().setProperty(g,{value:S,kind:m})}}},YT=class extends Ge{constructor(g,m,S){super(),this.relayManager=g,this.configProvider=m,this.logger=S,this.currentInfo={},this.currentAreaContent={},this.isEnabled=!1,this.isEnabled=this.configProvider.config.enableE911,m.on("configUpdated",(()=>{this.isEnabled=this.configProvider.config.enableE911,this.isEnabled&&(this.prober?.dispose(),this.prober=void 0,this.probeForIP())}))}get info(){return this.currentInfo}get areaContent(){return this.currentAreaContent}async getInfo(){return this.isEnabled&&!this.prober&&await this.probeForIP(),this.currentInfo}setClientInfo(g,m){if(this.isEnabled)switch(this.logger.info(`Client info for ${g} set`),g){case 3:this.mergeClientAreaInfo(JSON.parse(m));break;case 1:break;case 2:this.mergeClientNetworkInfo(JSON.parse(m))}}mergeClientAreaInfo(g){const m=JSON.stringify(this.currentAreaContent);this.currentAreaContent.geoCoordinates=g.geoCoordinates,removeUndefinedFields(this.currentAreaContent),JSON.stringify(this.currentAreaContent)!==m&&this.raiseChanged()}mergeClientNetworkInfo(g){if(0===Object.keys(g).length){const g=Object.keys(this.currentInfo).length+Object.keys(this.currentAreaContent).length;return this.currentInfo={},this.currentAreaContent={},void(g>0&&this.raiseChanged())}const m=JSON.stringify(this.currentInfo);this.currentInfo.bssid=g.bssid,this.currentInfo.bssidv6=g.bssidv6,this.currentInfo.e911=g.e911,this.currentInfo.mac=g.mac,this.currentInfo.macv6=g.macv6,this.currentInfo.subnetLengthIpv4=g.subnetLengthIpv4,this.currentInfo.subnetLengthIpv6=g.subnetLengthIpv6,removeUndefinedFields(this.currentInfo),JSON.stringify(this.currentInfo)!==m&&this.probeForIP().then((g=>{g||this.raiseChanged()}))}async probeForIP(){this.logger.info("Probing for public IP address...");const g=await this.ensureProber();if(await g.ensureOnline(),g.ipFromRelay){if((this.currentInfo.ipv4||this.currentInfo.ipv6)!==g.ipFromRelay)return delete this.currentInfo.ipv4,delete this.currentInfo.ipv6,this.currentInfo[Bs.test(g.ipFromRelay)?"ipv4":"ipv6"]=g.ipFromRelay,this.raiseChanged(),!0}else if(0!==Object.keys(this.currentInfo).length)return this.currentInfo={},this.raiseChanged(),!0;return!1}async ensureProber(){if(this.prober)return this.prober;const g=createProbeIceServers(await this.relayManager.queryRelaysAsync({relayType:"turn"}),this.configProvider.config);return this.prober=new QS(g,new US(this.logger.createChild("Prober"),this.logger.createChild("ProberUnsafe"))),this.prober}},QT=class extends Error{constructor(g,m=1){super(g),this.callSupport=m}};function createTelemetryLoggersFromConfig(g){let m={};return g.telemetryLoggers?m=g.telemetryLoggers:g.telemetryService?.getGenericTelemetryLogger&&g.telemetryTenants?Object.keys(g.telemetryTenants).forEach((S=>m[S]=g.telemetryService.getGenericTelemetryLogger(g.telemetryTenants[S]))):g.telemetryService&&(g.telemetryService.sendEvents||g.telemetryService.getCallingAdapter)&&(g.telemetryService.sendEvents&&(m.media={sendEvent(m){m.eventName&&(m.eventName=m.eventName.replace(/^(mdsc_)/,"")),g.telemetryService.sendEvents([m])}},m.tlePlayer={sendEvent(m){m.eventName&&(m.eventName=m.eventName.replace(/^(mdsc_)/,"")),g.telemetryService.sendEvents([m])}}),g.telemetryService?.sendRealTimeEvents&&(m.realtimeMedia={sendEvent(m){m.eventName&&(m.eventName=m.eventName.replace(/^(mdsc_)/,"")),g.telemetryService.sendRealTimeEvents([m])}}),g.telemetryService.getCallingAdapter&&(m.signaling={sendEvent(m){g.telemetryService.getCallingAdapter().sendEvent(m.eventName,m.props)}})),m}function createTelemetryLoggersForOneDs(g,m,S,v,C,_){const E={signaling:[],media:[],tlePlayer:[],realtimeMedia:[]};let T={signaling:{sendEvent:g=>E.signaling.push(g)},media:{sendEvent:g=>E.media.push(g)},tlePlayer:{sendEvent:g=>E.tlePlayer.push(g)},realtimeMedia:{sendEvent:g=>E.realtimeMedia.push(g)}};return m.getConfigReceivedOrTimeout().then((async()=>{let I=(await C)?.serviceUrls?.OneDsCollectorUrl;if(I=I??m.config.collectorUrl,I){const C=new KT(g,m,S,m.config.eventLatency,v,I);T.signaling=C.createLogger("signaling"),T.media=C.createLogger("media"),T.tlePlayer=C.createLogger("tlePlayer");const _=new KT(g,m,S,m.config.eventLatencyRealTime,v,I,{"UserInfo.Ring":"Ring","UserInfo.TenantId":"TenantId","AppInfo.ClientType":"client_type","UserInfo.ETag":"AppInfo.EcsEtag",appversion:"First/Second Client VDI Desktop Version",vdiMode:"First/Second Client VDI Mode",vdiConnectedState:"First/Second Client VDI Connected State",vdiShimVersion:"First/Second Client VDI Shim Version",vdiProvider:"First/Second Client VDI Provider Version"});T.realtimeMedia=_.createLogger("realtimeMedia")}else T=createTelemetryLoggersFromConfig(_);for(const[g,m]of Object.entries(E))for(const S of m)T[g].sendEvent(S)})),T}var XT=class _PluginlessStack extends Ge{constructor(g,m){super(),this._config=g,this._ecsProvider=m,this.callRegistries=[],this._logger=new Ze(this._config.logger).createChild("PluginlessStack"),this._platformManager=new JE,this._waitForAccountConfiguration=new or,this.platformCallConstraintsProvider=new Xe(this._logger.createChild("PlatformConstraintsProvider"))}async initializeMediaAgent(g){let m,S=null;if(!this._mediaAgentProvider)throw new QT("PluginlessStack initialize MediaAgent error, Media Stack not initialized",S);try{this._relayManager=g.relayManager||this.buildRelayManager(g.httpRequestDispatcher,g.tokenProvider,g.configProvider,g.appStateProvider,g.trapTokenCredentialsProvider),m=await this._mediaAgentProvider.buildAgent(this._config.platformType,this._relayManager,this._midCallTelemetry)}catch(g){const m=g.some((g=>"incompatible_version"===g.reason));S=m?2:1}if(!this._config.usePlatformSupportApi&&!this._config.callSettings?.useLwjForAllCalls){if(S)throw new QT("PluginlessStack initialization failed",S);{const g=(new JE).getPlatformSupportLevel(!0);if(1!==g&&2!==g)throw new QT("PluginlessStack initialization failed",1)}}m?(this._screenSharingManager=new XE(m.getScreenSharingManager()),this._waitForAccountConfigurationTimeout=window.setTimeout((()=>{this._waitForAccountConfiguration.resolve(void 0),this._waitForAccountConfigurationTimeout=void 0}),3e4),this._oneDsTelemetryLoggers=createTelemetryLoggersForOneDs(this._logger.createChild("OneDsLogger"),m.getConfigProvider(),g.clientInformation,this._config.telemetryContextProvider,this._waitForAccountConfiguration.promise,this._config),m.getConfigProvider().config.useOneDsLogger&&(this.signalingLoggerAdapter={sendEvent:(g,m)=>{const S={eventName:g,props:m};this._oneDsTelemetryLoggers.signaling.sendEvent(S)}}),this._mediaAgent=m,this._e911=new YT(this._relayManager,this._mediaAgent.getConfigProvider(),this._logger.createChild("E911")),this._e911?.changed((()=>{this.event("e911InfoChanged").raise(this._e911?.info,this._e911?.areaContent)}))):this._deviceManager=new Ot}async initializeSignalingAgentProvider(g){this._trouterService=g.trouterService,this._signalingAgentProvider=rT.build(g.signalingAgentConfig,this._ecsProvider,this._config.logger,this.signalingLoggerAdapter)}static async build(g,m,S){try{const v=new _PluginlessStack({detectH264Support:g.mediaAgentFactoryConfig.detectH264Support,domOverrides:g.mediaAgentFactoryConfig.domOverrides,mediaSettings:g.mediaAgentFactoryConfig.settings,logger:g.logger,telemetryLoggers:g.telemetryLoggers,telemetryService:g.telemetryService,telemetryTenants:g.telemetryTenants,telemetryContextProvider:g.telemetryContextProvider,platformType:g.platformType,callSettings:g.callSettings,usePlatformSupportApi:g.usePlatformSupportApi,clientInformation:g.signalingAgentConfig.clientInformation},m);return v.initializeMediaProvider({detectH264Support:g.mediaAgentFactoryConfig.detectH264Support,domOverrides:g.mediaAgentFactoryConfig.domOverrides,mediaSettings:g.mediaAgentFactoryConfig.settings,logger:g.mediaAgentFactoryConfig.logger,safeLogger:g.mediaAgentFactoryConfig.safeLogger,webcvProvider:g.mediaAgentFactoryConfig.webcvProvider,wasmdnsProvider:g.mediaAgentFactoryConfig.wasmdnsProvider,wasmaecProvider:g.mediaAgentFactoryConfig.wasmaecProvider,wasmVqeProvider:g.mediaAgentFactoryConfig.wasmVqeProvider,createWasmWorkerCbs:g.mediaAgentFactoryConfig.createWasmWorkerCbs,encodedStreamsWorkerProvider:g.mediaAgentFactoryConfig.encodedStreamsWorkerProvider,clientInformation:g.signalingAgentConfig.clientInformation}),v.setMidCallTelemetry(S),v.initializeSignalingAgentProvider({signalingAgentConfig:g.signalingAgentConfig,trouterService:g.trouterService}),await v.initializeMediaAgent({httpRequestDispatcher:g.mediaAgentFactoryConfig.httpRequestDispatcher,tokenProvider:g.mediaAgentFactoryConfig.tokenProvider,configProvider:g.mediaAgentFactoryConfig.configProvider,appStateProvider:g.mediaAgentFactoryConfig.appStateProvider,clientInformation:g.signalingAgentConfig.clientInformation,trapTokenCredentialsProvider:g.mediaAgentFactoryConfig.trapTokenCredentialsProvider,relayManager:g.mediaAgentFactoryConfig.relayManager}),v}catch(g){throw g instanceof QT?g:new QT(`${g}`)}}static async buildBaseStack(g,m){const S=new _PluginlessStack(g,m);return S.initializeMediaProvider({detectH264Support:g.detectH264Support,domOverrides:g.domOverrides,mediaSettings:g.mediaSettings,logger:g.logger,safeLogger:g.safeLogger,webcvProvider:g.webcvProvider,wasmdnsProvider:g.wasmdnsProvider,wasmaecProvider:g.wasmaecProvider,wasmVqeProvider:g.wasmVqeProvider,createWasmWorkerCbs:g.createWasmWorkerCbs,encodedStreamsWorkerProvider:g.encodedStreamsWorkerProvider,clientInformation:g.clientInformation}),S}async init(){}async dispose(g=generateCauseId()){const m=this._logger.createFnLogger("dispose",g);m.info("Dispose"),this._ecsProvider.dispose();const handleDisposeError=g=>{m.warn("Failed:",g)},S=this.callRegistries.map((m=>m.dispose(g).catch(handleDisposeError)));await Promise.all(S),await this._mediaAgent.dispose(g).catch(handleDisposeError),m.info("media agent is disposed"),this.callRegistries=[],m.info("call registries are disposed"),this._screenSharingManager&&(this._screenSharingManager.dispose(g),this._screenSharingManager=void 0,m.info("screensharing manager is disposed")),this._deviceManager=void 0,super.dispose()}getCallRegistry(){return this._logger.info("returning default callRegistry"),this.callRegistries[0]?this.callRegistries[0]:this._createCallRegistry()}async createCallRegistry(g,m=generateCauseId()){const S=g?mriOrId(g.id):void 0,v=this._logger.createFnLogger(`createCallRegistry[identity=${S}]`,m),C=this.callRegistries.find((m=>m.identity===g.id));return C&&!C.isDisposing?(v.info(`callRegistry already exists for ${mriOrId(g.id)}`),C):(C?.isDisposing&&await C.disposePromise,this._createCallRegistry(g))}createCompositor(g){throw new Error("Method not implemented.")}_createCallRegistry(g){if(!this._trouterService)throw new QT("Unable to create call registry, trouter service undefined");if(!this._mediaAgent)throw new QT("Unable to create call registry, media agent undefined");if(!this._signalingAgentProvider)throw new QT("Unable to create call registry, signaling agent undefined");const m=new ia(this._trouterService,this._signalingAgentProvider,this._mediaAgent,this._logger,createTelemetryLoggersFromConfig(this._config),this._ecsProvider,g,this._oneDsTelemetryLoggers);return m.on("disposed",(()=>{this.callRegistries.splice(this.callRegistries.indexOf(m),1)})),m.on("accountConfigurationReceived",(g=>{0===this._waitForAccountConfiguration.state&&(this._waitForAccountConfiguration.resolve(g),window.clearTimeout(this._waitForAccountConfigurationTimeout)),this._relayManager.setDefaultRelayConfig(g.relayConfig)})),m.on("locationInfoSet",((g,m)=>{this._e911?.setClientInfo(g,m)})),this.callRegistries.push(m),m}initializeMediaProvider(g){const m=(0,Ve.assign)({},g);this._mediaAgentProvider=new zE(m,this._ecsProvider,this.platformCallConstraintsProvider),this._deviceManager=new aa(this._mediaAgentProvider.getDeviceManager())}setMidCallTelemetry(g){this._midCallTelemetry=g}buildRelayManager(g,m,S,v,C){const _=g||new Ue(this._logger);return build({logger:this._logger,tokenProvider:m,trapTokenCredentialsProvider:C,configProvider:()=>S.getRelayConfig(),request:{get:(g,m)=>_.getAsync(g,_.getRequestOptions("GET",m?.headers,null,m?.timeout)),isOnline:v.isOnline},newTokenProvider:()=>this._signalingAgentProvider.getSignalingAgent().authTokenManager.getToken(generateGuid())})}getDeviceManager(){return this._deviceManager}async getDeviceManagerAsync(){return this._deviceManager}createDeviceManager(g){return this._deviceManager}getScreenSharingManager(){return this._screenSharingManager}getSetup(){}getEcsProvider(){return this._ecsProvider}async getEcsProviderAsync(){return this._ecsProvider}getCallFeedback(){return null}getAiMdp(){return null}fireIntent(g,m){}getVersion(){return{build:getTsCallingVersion(),ovb:getOvb()}}getMediaStatus(){return null}getVideoCapabilityLimits(){return null}async setMediaConfig(g){this._mediaAgent.setMediaConfig(g)}async getE911Info(){return this._e911?.getInfo()}setPlatformCallConstraints(g){this.platformCallConstraintsProvider.setConstraints(g)}getPlatformSupportLevel(){return this._platformManager.getPlatformSupportLevel(!!this._mediaAgent)}getLiveStreamClient(){const getTelemetryLogger=()=>createTelemetryLoggersFromConfig(this._config).tlePlayer;return new Dt(this._ecsProvider.createEcsConfiguration(),this._logger.createChild("LiveStreamClient"),getTelemetryLogger)}createVoipCallCoordinator(){}async setLogFileName(g,m,S){throw new Error("not supported")}aggregateDiagnosticLogs(g){return Promise.reject("not supported")}extendBrbFeedback(g,m){return Promise.reject("not supported")}async addOcclusion(g,m,S,v,C,_){}async removeOcclusion(g,m,S,v){}async flushLogs(){throw new Error("not supported")}async getStageCapability(){throw new Error("not supported")}},ZT={build(g){const m=g.telemetryContextProvider?.(),S=new YE(m),v=new pa;return initLogger(g,S,v),XT.build(g,S,v)},buildBaseStack(g){const m=g.telemetryContextProvider?.(),S=new YE(m);return XT.buildBaseStack(g,S)},getVersion:()=>({build:getTsCallingVersion(),ovb:getOvb()})};
/*! Bundled license information:

	@microsoft/dynamicproto-js/lib/dist/esm/dynamicproto-js.js:
	  (*!
	   * Microsoft Dynamic Proto Utility, 1.1.8
	   * Copyright (c) Microsoft and contributors. All rights reserved.
	   *)
	*/
if("object"==typeof C.exports&&"object"==typeof v){var __cp=(g,m,S,v)=>{if(m&&"object"==typeof m||"function"==typeof m)for(let C of Object.getOwnPropertyNames(m))Object.prototype.hasOwnProperty.call(g,C)||C===S||Object.defineProperty(g,C,{get:()=>m[C],enumerable:!(v=Object.getOwnPropertyDescriptor(m,C))||v.enumerable});return g};C.exports=__cp(C.exports,v)}return C.exports}))})),w={BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,REQUEST_TIMEOUT:408,CONFLICT:409,MEDIA_ERROR:410,PRECONDITION_FAILED:412,UNSUPPORTED_MEDIA_TYPE:415,UNPROCESSABLE_ENTITY:422,INTERNAL_ERROR:500,NOT_IMPLEMENTED:501};const D={CALL_CLIENT:{INIT_CALL_CLIENT:{message:"Failed to initialize CallClient",code:500,subCode:4e4,resultCategories:["UnexpectedClientError"]},CREATE_CALL_AGENT:{message:"Failed to create CallAgent",code:409,subCode:40001,resultCategories:["UnexpectedClientError"]},CREATE_TEAMS_CALL_AGENT:{message:"Failed to create TeamsCallAgent",code:409,subCode:40002,resultCategories:["UnexpectedClientError"]},RELAY_INFO:{message:"Error processing relay information. Possibly invalid url: {0}",code:400,subCode:40003,resultCategories:["ExpectedError"]},RELAY_UNRECOGNIZED_SCHEMA:{message:"Error processing relay information. Unrecognized schema",code:400,subCode:40004,resultCategories:["ExpectedError"]},PROXY_SHORT_URL:{message:"Failed setup proxy, the url is too short",code:400,subCode:40005,resultCategories:["ExpectedError"]},PROXY_PROTOCOL:{message:"Failed setup proxy, the protocol is not https or http",code:400,subCode:40006,resultCategories:["ExpectedError"]},SETUP_PROXY:{message:"Setup failed. Proxy url is invalid: {0}",code:400,subCode:40007,resultCategories:["ExpectedError"]},ONE_CALL_AGENT_PER_CALL_CLIENT:{message:"CallClient instance can support only one CallAgent or TeamsCallAgent create new CallClient instance to create new CallAgent or TeamsCallAgent",code:400,subCode:40008,resultCategories:["ExpectedError"]},EMERGENCY_CODE_TOO_LONG:{message:"EmergencyCountryCode is invalid, max length is 10",code:400,subCode:40009,resultCategories:["ExpectedError"]}},CALL_STACK:{BAD_PROTOCOL:{message:"ACS Web Calling SDK must be used through https, file:, or localhost",code:400,subCode:40100,resultCategories:["ExpectedError"]},BASE_STACK_INIT_TIMEOUT:{message:"Failed to create stack base due to timeout during initialization",code:408,subCode:40101,resultCategories:["UnexpectedClientError"]},BASE_STACK_INIT_FAILED:{message:"Failed to create stack base due to failure in intialization",code:500,subCode:40102,resultCategories:["UnexpectedClientError"]},BASE_STACK_CREATE_FAILED:{message:"Base stack failed to create",code:500,subCode:40103,resultCategories:["UnexpectedClientError"]},USER_STACK_INIT_TIMEOUT:{message:"User stack init timeout",code:408,subCode:40104,resultCategories:["UnexpectedClientError"]},USER_STACK_INIT_FAILED:{message:"User stack init failed",code:500,subCode:40105,resultCategories:["UnexpectedClientError"]},PARSE_CONFIG:{message:"Unable to parse configuration",code:500,subCode:40106,resultCategories:["UnexpectedClientError"]},SET_STACK_CONFIG:{message:"Failed to set configuration for stack",code:500,subCode:40107,resultCategories:["UnexpectedClientError"]},GET_DM:{message:"Failed to get device manager due to internal call stack undefined",code:500,subCode:40108,resultCategories:["UnexpectedClientError"]},SET_STACK_PARAMS:{message:"Failed to initialize callclient",code:500,subCode:40109,resultCategories:["UnexpectedClientError"]},FOUND_UNDEFINED_CONFIGS:{message:"Found undefined configs in ECS response: {0}",code:500,subCode:40110,resultCategories:["UnexpectedClientError"]},SIGNALING_SERVICE_CREATE_FAIL:{message:"Failed to create trouter service",code:500,subCode:40111,resultCategories:["UnexpectedClientError"]},SIGNALING_INIT_FAIL:{message:"Signaling init failed",code:500,subCode:40112,resultCategories:["UnexpectedClientError"]},SIGNALING_SERVICE_ALREADY_INITIALIZED:{message:"Signaling service already initialized",code:500,subCode:40113,resultCategories:["ExpectedError"]},SIGNALING_SERVICE_CREATE_TIMEOUT:{message:"Signaling init timeout, request took longer than {0} ms",code:408,subCode:40114,resultCategories:["UnexpectedClientError"]},SIGNALING_UNINITIALIZED:{message:"Signaling failed to initialize.",code:412,subCode:40115,resultCategories:["UnexpectedClientError"]}},CALL_AGENT:{PROXY_CUSTOM_TURN_FORBIDDEN:{message:"Using proxy or custom TURN for calls involving Teams is disabled",code:403,subCode:40200,resultCategories:["ExpectedError"]},PARSE_ACCESSTOKEN:{message:"Failed to parse AccessToken",code:500,subCode:40201,resultCategories:["UnexpectedClientError"]},CANT_CALL_YOURSELF:{message:"Call to yourself is not supported.",code:400,subCode:40202,resultCategories:["ExpectedError"]},ACS_ALREADY_DISPOSED:{message:"Call Agent is already disposed",code:409,subCode:40203,resultCategories:["ExpectedError"]},CTE_ALREADY_DISPOSED:{message:"Teams Call Agent is already disposed",code:409,subCode:40204,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:40205,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:40206,resultCategories:["ExpectedError"]},MESH_DEVICETYPE_V2:{message:"Device type must be msft-acs-mesh-deviceType-v2 to join immersive call",code:400,subCode:40207,resultCategories:["ExpectedError"]},STACK_NOT_INIT:{message:"Failed to start or join call, call stack did not initialize",code:500,subCode:40208,resultCategories:["UnexpectedClientError"]},INVALID_CALL_CONFIG:{message:"Invalid call configuration",code:400,subCode:40209,resultCategories:["ExpectedError"]},INVALID_MEETING_LINK:{message:"Invalid meeting link",code:400,subCode:40210,resultCategories:["ExpectedError"]},INVALID_TFL_MEETING_LINK:{message:"Invalid TFL meeting link",code:400,subCode:40211,resultCategories:["ExpectedError"]},GROUPCALL_THREADID:{message:"Starting a group call must include thread ID in StartTeamsGroupCallOptions.",code:400,subCode:40212,resultCategories:["ExpectedError"]},ONE_TO_ONE_THREADID:{message:"Starting a one to one with thread ID is invalid.",code:400,subCode:40213,resultCategories:["ExpectedError"]},CTE_DISPLAY_NAME:{message:"Display name is not allowed to be set for Teams users.",code:400,subCode:40214,resultCategories:["ExpectedError"]},DISPLAY_NAME_TOO_LONG:{message:"Display name is too long.",code:400,subCode:40215,resultCategories:["ExpectedError"]},INIT_FAIL:{message:"Failed to create CallAgent",code:500,subCode:40216,resultCategories:["UnexpectedClientError"]},GET_TOKEN_BEFORE_INIT:{message:"Attempted to get AccessToken before initialization",code:422,subCode:40217,resultCategories:["UnexpectedClientError"]},INVALID_PUSH_NOTIFICAITON_DATA:{message:"Invalid push notification data provided",code:400,subCode:40218,resultCategories:["ExpectedError"]},PUSH_NOTIFICAITON_FAIL:{message:"Failed to handle push notification",code:500,subCode:40219,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_NO_PAYLOAD:{message:"Invalid Incoming Call push notification payload provided",code:400,subCode:40220,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD_NO_CONTEXT_PROVIDED:{message:"No 'incomingCallContext' provided in event payload",code:400,subCode:40221,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD:{message:"Invalid Incoming Call push notification payload data provided",code:400,subCode:40222,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_ALREADY_PROCESSED:{message:"Incoming Call is already being processed",code:400,subCode:40223,resultCategories:["ExpectedError"]},INCOMING_PUSH_NOTIFICATION_FAILED_TO_PROCESS:{message:"Failed to handle Incoming Call push notification",code:500,subCode:40224,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_CALL_MISSED:{message:"Missed call",code:400,subCode:40225,resultCategories:["ExpectedError"]},USERIDS_MUST_BE_OBJECTS:{message:"AssertIsObject failed. : userIds must be object",code:400,subCode:40226,resultCategories:["ExpectedError"]},USERIDS_CANNOT_BE_NULL:{message:"AssertNotNull failed. : userIds cannot be null",code:400,subCode:40227,resultCategories:["ExpectedError"]},ACS_CALLAGENT_ALREADY_EXSISTS:{message:"Failed to create call agent, call agent for this ACS Id already exists",code:409,subCode:40228,resultCategories:["ExpectedError"]},ACS_CALLAGENT_TOKEN_ONLY:{message:"CallAgent must be created only with ACS token",code:403,subCode:40229,resultCategories:["ExpectedError"]},TEAMS_CALLAGENT_ALREADY_EXSISTS:{message:"Failed to create call agent, call agent for this ACS Id already exists",code:409,subCode:40230,resultCategories:["ExpectedError"]},TEAMS_CALLAGENT_TOKEN_ONLY:{message:"TeamsCallAgent must be created only with Teams token",code:403,subCode:40231,resultCategories:["ExpectedError"]},FAILED_TO_GET_TOKEN:{message:"Failed to get token",code:409,subCode:40232,resultCategories:["UnexpectedClientError"]},REFRESHED_TOKEN_INVALID_USERID:{message:"Refreshed AccessToken User Id doesnt match initial User Id.",code:400,subCode:40233,resultCategories:["ExpectedError"]},REFRESHED_TOKEN_RETRIES:{message:"Access token is expired and failed to fetch a valid one after retries.",code:400,subCode:40234,resultCategories:["ExpectedError"]},ACCESSTOKEN_EXPIRED:{message:"AccessToken expired",code:401,subCode:40235,resultCategories:["ExpectedError"]},ACTION_BLOCKED:{message:"Action not allowed.",code:403,subCode:40236,resultCategories:["ExpectedError"]}},DEVICE_MANAGER:{GET_MEDIA_STREAM_TRACK:{message:"Failed to get raw device stream track",code:500,subCode:40600,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM_DEVICE_UNAVAILABLE:{message:"Failed to get raw device stream track, make sure there is available device",code:412,subCode:40601,resultCategories:["UnexpectedClientError"]},GET_DM:{message:"Failed to get device manager.",code:500,subCode:40602,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:40603,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:40604,resultCategories:["ExpectedError"]},ACCESS_DM:{message:"Unable to access device manager",code:500,subCode:40605,resultCategories:["UnexpectedClientError"]},SPEAKER_ENUMERATION_UNSUPPORTED:{message:"This device does not support speaker enumeration.",code:405,subCode:40606,resultCategories:["ExpectedError"]},SELECT_MICROPHONE_TIMEOUT:{message:"Microphone selection timed out.",code:408,subCode:40607,resultCategories:["UnexpectedClientError"]},SELECT_MICROPHONE_FAIL:{message:"There was an issue with selecting the microphone",code:500,subCode:40608,resultCategories:["UnexpectedClientError"]},SELECT_SPEAKER_TIMEOUT:{message:"Speaker selection timed out.",code:408,subCode:40609,resultCategories:["UnexpectedClientError"]},SELECT_SPEAKER_FAIL:{message:"There was an issue with selecting the speaker",code:500,subCode:40610,resultCategories:["UnexpectedClientError"]},SPEAKER_SELECTION_UNSUPPORTED:{message:"This device does not support speaker selection.",code:405,subCode:40611,resultCategories:["ExpectedError"]},ONE_PERMISSION_ATLEAST:{message:"At least one permission must be requested",code:400,subCode:40612,resultCategories:["ExpectedError"]},PERMISSION_NOT_GRANTED_OR_FAILED:{message:"Permissions not granted or failed: {0}",code:400,subCode:40613,resultCategories:["ExpectedError"]},ADP_FAIL:{message:"Failed to get audio video permissions",code:500,subCode:40614,resultCategories:["UnexpectedClientError"]},INVALID_DEVICE:{message:"The device argument is invalid",code:400,subCode:40615,resultCategories:["ExpectedError"]},DEVICE_NOT_SELECTABLE:{message:"The device is not selectable",code:400,subCode:40616,resultCategories:["ExpectedError"]}},CALL:{OPERATION_NOT_ALLOWED_DURING_EMERGENCY_CALL:{message:"{0} operation is not allowed during Emergency Call",code:500,subCode:41e3,resultCategories:["ExpectedError"]},OPERATION_FAILED:{message:"{0} failed",code:500,subCode:41001,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_UNDEFINED:{message:"Unable to get remote audio stream, getMediaStream returned undefined",code:500,subCode:41002,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_RETURNED_ERROR:{message:"Unable to get remote audio stream, getMediaStream returned error",code:500,subCode:41003,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_DISABLED:{message:"Getting raw audio media strema is currently dissabled",code:409,subCode:41004,resultCategories:["ExpectedError"]},ACCEPT_INCOMING_CALL:{message:"Failed to accept the Incoming Call",code:500,subCode:41005,resultCategories:["UnexpectedClientError"]},ACCEPT_NOT_RINGING:{message:"Call cannot be accepted because it is not in Ringing state",code:400,subCode:41006,resultCategories:["ExpectedError"]},REJECT_NOT_RINGING:{message:"Call cannot be rejectd because it is not in Ringing state",code:400,subCode:41007,resultCategories:["ExpectedError"]},LOCAL_AUDIO_GET_MEDIA_STREAM:{message:"Failed to get raw stream from local audio stream",code:500,subCode:41008,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_SET_MEDIA_STREAM:{message:"Failed to set raw input audio stream",code:500,subCode:41009,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_UNSET_MEDIA_STREAM:{message:"Failed to unset raw input audio stream",code:500,subCode:41010,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_UNDEFINED_STACK:{message:"Failed to process audio because of internal call stack error",code:500,subCode:41011,resultCategories:["UnexpectedClientError"]},REMOVE_LOCAL_VIDEO_ON_BAD_UFD:{message:"Removing local video stream due to video fail UFD being raised before call connected. UFD: {0}, value: {1}, call direction: {2}",code:409,subCode:41012,resultCategories:["UnexpectedClientError"]},STOP_AUDIO_ON_BAD_UFD:{message:"Failed to stop audio on microphone device not functioning or capture mute event {0} with value {1}",code:400,subCode:41013,resultCategories:["UnexpectedClientError"]},INSTANTIATE_CALL:{message:"Failed to instantiate the Call",code:500,subCode:41014,resultCategories:["UnexpectedClientError"]},MIC_MUTE:{message:"Failed to mute microphone",code:500,subCode:41015,resultCategories:["UnexpectedClientError"]},MIC_UNMUTE:{message:"Failed to unmute microphone",code:400,subCode:41016,resultCategories:["UnexpectedClientError"]},MIC_UNMUTE_AND_STARTAUDIO:{message:"Failed to unmute and start audio, microphone device not functioning",code:410,subCode:41017,resultCategories:["UnexpectedClientError"]},MUTE_ALL_PARTICIPANTS_DISABLED:{message:"Mute other participants disabled.",code:403,subCode:41018,resultCategories:["ExpectedError"]},MUTE_ALL_PARTICIPANTS:{message:"Failed to mute all remote participants",code:500,subCode:41019,resultCategories:["UnexpectedClientError"]},MUTE_INCOMING_AUDIO:{message:"Failed to mute incoming audio",code:500,subCode:41020,resultCategories:["UnexpectedClientError"]},UNMUTE_INCOMING_AUDIO:{message:"Failed to unmute incoming audio",code:500,subCode:41021,resultCategories:["UnexpectedClientError"]},DTMF_TONE:{message:"Failed to send DTMF tone",code:400,subCode:41022,resultCategories:["UnexpectedClientError"]},INVALID_DTMF_TONE:{message:"Invalid value passed to DtfmTone",code:422,subCode:41023,resultCategories:["ExpectedError"]},START_AUDIO_BEFORE_VIDEO:{message:"Failed to start audio before starting video",code:400,subCode:41024,resultCategories:["UnexpectedClientError"]},STREAM_NULL:{message:"Failed to start video, localVideoStream cannot be null",code:400,subCode:41025,resultCategories:["ExpectedError"]},STREAM_IS_NOT_LVS:{message:"Failed to start video, localVideoStream is not an instance of LocalVideoStream",code:400,subCode:41026,resultCategories:["ExpectedError"]},VIDEO_ALREADY_ON:{message:"Failed to start video, local video is already on",code:400,subCode:41027,resultCategories:["ExpectedError"]},VIDEO_SET_MEDIA_STREAM:{message:"Failed to set media stream",code:500,subCode:41028,resultCategories:["UnexpectedClientError"]},START_VIDEO:{message:"Failed to start video",code:500,subCode:41029,resultCategories:["UnexpectedClientError"]},VIDEO_ALREADY_OFF:{message:"Failed to stop video, local video is already off",code:400,subCode:41030,resultCategories:["ExpectedError"]},VIDEO_UNDEFINED_STACK:{message:"Failed to process video because of internal call stack error",code:500,subCode:41031,resultCategories:["UnexpectedClientError"]},STOP_WRONG_STREAM:{message:"Invalid LocalVideoStream, this LocalVideoStream is not being sent",code:400,subCode:41032,resultCategories:["ExpectedError"]},HOLD_CALL:{message:"Failed to hold call",code:500,subCode:41033,resultCategories:["UnexpectedClientError"]},RESUME_CALL:{message:"Failed to resume call",code:500,subCode:41034,resultCategories:["UnexpectedClientError"]},SS_ALREADY_ON:{message:"Failed to start screen share, screen share is already on. Must stop and start again.",code:400,subCode:41035,resultCategories:["ExpectedError"]},SS_RAW_STREAM_IS_NOT_LVS:{message:"Failed to start raw screen sharing, localVideoStream is not an instance of LocalVideoStream",code:400,subCode:41036,resultCategories:["ExpectedError"]},SS_RAW_STREAM_UNDEFINED:{message:"Unable to get media stram from local video stream for screen sharing",code:500,subCode:41037,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_SET:{message:"Failed to set media stream for screen sharing",code:422,subCode:41038,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_GET:{message:"Failed to get media stream for screen sharing",code:422,subCode:41039,resultCategories:["UnexpectedClientError"]},START_SS:{message:"Failed to start screen sharing",code:500,subCode:41040,resultCategories:["UnexpectedClientError"]},SS_ALREADY_OFF:{message:"Failed to stop screen share, screen share is already off",code:400,subCode:41041,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:41042,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:41043,resultCategories:["ExpectedError"]},ONLY_SINGLE_VIDEO_STREAM:{message:"Only single LocalVideoStream is supported currently",code:400,subCode:41044,resultCategories:["ExpectedError"]},NOT_INSTANCE_OF_LVS:{message:"Stream is not an instance of LocalVideoStream",code:400,subCode:41045,resultCategories:["ExpectedError"]},ONLY_SINGLE_AUDIO_STREAM:{message:"Only single LocalAudioStream is supported currently",code:400,subCode:41046,resultCategories:["ExpectedError"]},NOT_INSTANCE_OF_LAS:{message:"Stream is not an instance of LocalAudioStream",code:400,subCode:41047,resultCategories:["ExpectedError"]},VIDEO_FAILED_TO_START:{message:"Video failed to start during call-{0} process.",code:410,subCode:41048,resultCategories:["UnexpectedClientError"]},AUDIO_FAILED_TO_START:{message:"Audio failed to start during call-{0} process.",code:400,subCode:41049,resultCategories:["UnexpectedClientError"]},LARGE_MEETING_FORCE_ISAVAILABLE:{message:"Failed to force isAvailable flag to false during large meeting",code:500,subCode:41050,resultCategories:["UnexpectedClientError"]},LARGE_MEETING_DISPOSE_VIEW:{message:"Failed to dispose view in large meeting",code:500,subCode:41051,resultCategories:["UnexpectedClientError"]},ADD_UNKNOWN:{message:"Not able to add unkown participant.",code:400,subCode:41052,resultCategories:["ExpectedError"]},PARTICIPANT_ALREADY_IN_CALL:{message:"{0} is already in the call",code:400,subCode:41053,resultCategories:["ExpectedError"]},PARTICIPANT_NOT_IN_CALL:{message:"{0} is not in the call.",code:400,subCode:41054,resultCategories:["ExpectedError"]},CTE_ADDPARTICIPANT_NO_THREAD_ID:{message:"Add participant failed: thread ID is missing in options.",code:400,subCode:41055,resultCategories:["ExpectedError"]},CTE_VOICE_NOT_ENABLED:{message:"Teams Enterprise voice is not enabled. Teams user is not eligible to make PSTN call",code:412,subCode:41056,resultCategories:["ExpectedError"]},SERVER_CALL_ID:{message:"Failed to get server call Id",code:500,subCode:41057,resultCategories:["UnexpectedClientError"]},VOLUME_TRACK:{message:"failed to getMediaStreamTrack",code:500,subCode:41058,resultCategories:["UnexpectedClientError"]},VOLUME_INIT:{message:"Failed to setup volume calcualtor using AudioContext, please retry getVolumeindicator on a working audio stream with exponential backoff",code:500,subCode:41059,resultCategories:["UnexpectedClientError"]},VOLUME_EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:400,subCode:41060,resultCategories:["ExpectedError"]},VOLUME_EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe to event {0}, unknown event name",code:400,subCode:41061,resultCategories:["ExpectedError"]},VOLUME_GET:{message:"Failed to setup volume calculator, please retry after exponential backoff",code:500,subCode:41062,resultCategories:["UnexpectedClientError"]},GET_SERVER_CALL_ID:{message:"Failed to get serverCallId, serverCallId is empty",code:404,subCode:41063,resultCategories:["UnexpectedClientError"]},MEDIA_CONSTRAINTS_DISABLED:{message:"Setting call constraints is disabled",code:409,subCode:41064,resultCategories:["ExpectedError"]},SET_CONSTRAINTS_START_OR_ACCEPT:{message:"Error setting call constraints at call {0}",code:500,subCode:41065,resultCategories:["UnexpectedClientError"]},SET_CONSTRAINTS_MID_CALL:{message:"Error setting call constraints during mid-call",code:500,subCode:41066,resultCategories:["UnexpectedClientError"]},SET_CONSTRAINTS:{message:"Error setting video constraints during call stage: {0}",code:500,subCode:41067,resultCategories:["UnexpectedClientError"]},ACCEPT_VIDEO_CONSTRAINTS:{message:"Error setting video constraints during call accept",code:500,subCode:41068,resultCategories:["UnexpectedClientError"]},CALLSTART_VIDEO_CONSTRAINTS:{message:"Error setting video constraints during call start",code:500,subCode:41069,resultCategories:["UnexpectedClientError"]},SET_VIDEO_CONSTRAINTS:{message:"Failed to set call constraints during mid call",code:500,subCode:41070,resultCategories:["UnexpectedClientError"]},START_SS_CALL_NOT_CONNECTED:{message:"Failed to start screen sharing. Call must be in connected state",code:412,subCode:41071,resultCategories:["ExpectedError"]},STOP_SS_CALL_NOT_CONNECTED:{message:"Failed to stop screen sharing. Call must be in connected state",code:412,subCode:41072,resultCategories:["ExpectedError"]},ACCESS_RAW_MEDIA_STREAM_DISABLED:{message:"Accessing raw media stream is currently not enabled",code:412,subCode:41073,resultCategories:["ExpectedError"]},ACCESS_RAW_MEDIA_STREAM_UNDEFINED_FUNC:{message:"The raw media stream function is currently not available",code:500,subCode:41074,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_LVS_IS_NOT_RAW_MEDIA:{message:"Failed to start raw screen sharing, localVideoStream doesn't contain a raw media stream",code:400,subCode:41075,resultCategories:["ExpectedError"]}},LOBBY:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:41800,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:41801,resultCategories:["ExpectedError"]},CONV_UNSUPPORTED:{message:"Current conversation type doesn't support lobby admit and reject",code:400,subCode:41802,resultCategories:["ExpectedError"]},ALREADY_IN_MEETING:{message:"{0} is already in the meeting",code:400,subCode:41803,resultCategories:["ExpectedError"]},NOT_IN_LOBBY:{message:"{0} is not in the lobby",code:400,subCode:41804,resultCategories:["ExpectedError"]},UNAUTHORIZED_ADMIT_REJECT:{message:"only Organizer, Co-organizer or Presenter can admit/reject participants from lobby",code:403,subCode:41805,resultCategories:["ExpectedError"]}},CTE_MID_TIER_POLICY_SERVICE:{TEAMS_USER_ID_NOT_PROVIDED:{message:"Caller's MicrosoftTeamsUserIdentifier wasn't provided. Fetching Teams user policies and settings cannot proceed",code:400,subCode:41900,resultCategories:["ExpectedError"]},FETCH_POLICY:{message:"Error Fetching Teams user policy from ACS MiddleTier Service",code:500,subCode:41901,resultCategories:["UnexpectedServerError"]},DERIVE_EMERGENCY_POLICY:{message:"Unable to derive emergency policy from ACS MiddleTier Service response",code:500,subCode:41902,resultCategories:["UnexpectedServerError"]},TEAMSUSER_CALLINGPOLICY_FETCHING_FAILED:{message:"Unable to fetch teamsCallingPolicy from ACS MiddleTier Service response",code:500,subCode:41903,resultCategories:["UnexpectedServerError"]},TEAMSUSER_MEETINGPOLICY_FETCHING_FAILED:{message:"Unable to fetch teamsMeetingPolicy from ACS MiddleTier Service response",code:500,subCode:41904,resultCategories:["UnexpectedServerError"]},TEAMSUSER_FEATURETYPE_TEAMSPROMGMT_FETCHING_FAILED:{message:"Unable to fetch featureTypes from ACS MiddleTier Service response",code:500,subCode:41905,resultCategories:["UnexpectedServerError"]}},REMOTE_PARTICIPANT:{MUTE_PARTICIPANT_DISABLED:{message:"Mute other participants disabled.",code:403,subCode:42e3,resultCategories:["ExpectedError"]},MUTE_PARTICIPANT_FAILED:{message:"Failed to mute specific participant",code:500,subCode:42001,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:42002,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe to event {0}, unknown event name",code:422,subCode:42003,resultCategories:["ExpectedError"]}},LOCAL_VIDEO_STREAM:{SOURCE_UNAVAILABLE:{message:"Video operation failure SourceUnavailableError",code:412,subCode:43e3,resultCategories:["ExpectedError"]},PERMISSION_DENIED:{message:"Video operation failure PermissionDeniedError",code:403,subCode:43001,resultCategories:["ExpectedError"]},UNKNOWN:{message:"Video operation failure UnknownFailureForVideoOperation",code:500,subCode:43002,resultCategories:["UnexpectedClientError"]},WRONG_STREAM_TYPE:{message:"Failed to create local video stream, source was not of type VideoDeviceInfo or MediaStream",code:400,subCode:43003,resultCategories:["ExpectedError"]},SWITCH_SOURCE_WRONG_TYPE:{message:"Failed to switch source, source was not of type VideoDeviceInfo",code:400,subCode:43004,resultCategories:["ExpectedError"]},SWITCH_SAME_SOURCE:{message:"Unable to switch to the same source",code:400,subCode:43005,resultCategories:["ExpectedError"]},CANT_GET_DEVICE_TYPE:{message:"Unable to get device type",code:500,subCode:43006,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM:{message:"Failed to get media stream",code:500,subCode:43007,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM_WRONG_TYPE:{message:"Failed to set media stream source is not MediaStream",code:400,subCode:43008,resultCategories:["ExpectedError"]},SET_MEDIA_STREAM_UNDEFINED_FUNC:{message:"Unable ot set media stream",code:500,subCode:43009,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM:{message:"Failed to set media stream",code:500,subCode:43010,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:43011,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:43012,resultCategories:["ExpectedError"]}},REMOTE_VIDEO_STREAM:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:43100,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:43101,resultCategories:["ExpectedError"]},GET_RAW_MEDIA_STREAM:{message:"Not able to get media stream",code:500,subCode:43102,resultCategories:["UnexpectedClientError"]},STREAM_NOT_AVAILABLE:{message:"The stream is currently not available, subscribe to stream.isAvailable property to get notified when it is ready to get media stream",code:400,subCode:43103,resultCategories:["ExpectedError"]},SUBSCRIBE_MEDIA_STREAM_TIMEOUT:{message:"Failed to subscribe to media stream, timeout",code:408,subCode:43104,resultCategories:["UnexpectedClientError"]},GET_TRACK:{message:"Failed to get media stream",code:500,subCode:43105,resultCategories:["UnexpectedClientError"]},TRACK_UNMUTED_TIMEOUT:{message:"Failed to subscribe to media stream, muted",code:408,subCode:43106,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM:{message:"Failed to get raw media stream",code:500,subCode:43107,resultCategories:["UnexpectedClientError"]}},VIEW:{ISAVAILABLE_FALSE:{message:"Failed to create view, remote stream is not available",code:412,subCode:43200,resultCategories:["ExpectedError"]},START_ALREADY_DISPOSED:{message:"Failed to start stream, already disposed",code:405,subCode:43201,resultCategories:["ExpectedError"]},STREAM_BECAME_UNAVAILABLE:{message:"Failed to start stream, stream became unavailable",code:404,subCode:43202,resultCategories:["ExpectedError"]},TIMEOUT:{message:"Failed to render stream, timeout",code:408,subCode:43203,resultCategories:["UnexpectedClientError"]},SUBSCRIBE:{message:"Failed to start stream, fail to subscribe",code:500,subCode:43204,resultCategories:["UnexpectedClientError"]},START:{message:"Failed to start stream, internal error",code:500,subCode:43205,resultCategories:["UnexpectedClientError"]},SCALING_MODE:{message:"Failed to updateScalingMode, failed to update",code:500,subCode:43206,resultCategories:["UnexpectedClientError"]},LARGE_MEETING_VIEW_DISPOSED:{message:"Failed to start stream, disposing stream because participant is not a dominant speaker in the large meeting",code:405,subCode:43207,resultCategories:["ExpectedError"]},REMOTE_VIDEO_STREAM_DISPOSED:{message:"Failed to start stream, disposing stream because remote video stream is disposing",code:405,subCode:43208,resultCategories:["ExpectedError"]},APP_VIEW_DISPOSED:{message:"Failed to start stream, disposing stream",code:405,subCode:43209,resultCategories:["ExpectedError"]},RENDERER_DISPOSE_ALREADY_DISPOSED:{message:"Failed to dispose stream, already disposed",code:400,subCode:43210,resultCategories:["ExpectedError"]},REMOTE_RENDERER_DISPOSE_FAIL:{message:"Failed to dispose remote renderer",code:500,subCode:43211,resultCategories:["UnexpectedClientError"]},VIEW_WRONG_STREAM_TYPE:{message:"Failed to create VideoStreamRendererView, videoStream must be either LocalVideoStream or RemoteVideoStream type",code:400,subCode:43212,resultCategories:["ExpectedError"]},VIEW_ALREADY_DISPOSED:{message:"Failed to dispose, VideoStreamRendererView is disposed",code:400,subCode:43213,resultCategories:["ExpectedError"]},RENDER_FAIL_STREAM_DISPOSED:{message:"Failed to render, stream disposed",code:400,subCode:43214,resultCategories:["ExpectedError"]},SCALING_MODE_DISPOSED:{message:"Failed to updateScalingMode, VideoStreamRendererView is disposed",code:400,subCode:43215,resultCategories:["ExpectedError"]},SCALING_MODE_WRONG_VAL:{message:"Failed to updateScalingMode, wrong scalingMode value",code:400,subCode:43216,resultCategories:["ExpectedError"]},DISPOSE_FAIL:{message:"Failed to dispose view",code:500,subCode:43217,resultCategories:["UnexpectedClientError"]},RENDERER_WRONG_STREAM_TYPE:{message:"Failed to create VideoStreamRenderer, videoStream must be either LocalVideoStream or RemoteVideoStreamCommon type",code:400,subCode:43218,resultCategories:["ExpectedError"]},RENDERER_DISPOSED:{message:"Failed to create view, VideoStreamRenderer is disposed",code:400,subCode:43219,resultCategories:["ExpectedError"]},MAX_NUM_OF_VIEWS_REACHED:{message:"Failed to create view, maximum number of {0} active RemoteVideoStream has been reached",code:400,subCode:43220,resultCategories:["ExpectedError"]},CREATE_VIEW_FAILED:{message:"Failed to create view",code:500,subCode:43221,resultCategories:["UnexpectedClientError"]},RENDERER_ALREADY_DISPOSED:{message:"Failed to dispose, VideoStreamRendererView is already disposed",code:400,subCode:43222,resultCategories:["ExpectedError"]},UNKNOWN_STREAM_TYPE:{message:"Unknown stream type",code:400,subCode:43223,resultCategories:["ExpectedError"]},LOCAL_RENDERER_DISPOSE_FAIL:{message:"Failed to dispose local renderer",code:500,subCode:43224,resultCategories:["UnexpectedClientError"]}},LOCAL_AUDIO_STREAM:{WRONG_STREAM_TYPE:{message:"Failed to create local audio stream, source is not of type AudioDeviceInfo or MediaStream",code:400,subCode:43600,resultCategories:["ExpectedError"]},SOURCE_WRONG_TYPE:{message:"Failed to create local audio stream, source is not a microphone",code:400,subCode:43601,resultCategories:["ExpectedError"]},GET_MEDIA_STREAM:{message:"Failed to get media stream source is not AudioDeviceInfo or MediaStream",code:500,subCode:43602,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM_WRONG_TYPE:{message:"Failed to switch stream on local audio, source is not of type MediaStream",code:400,subCode:43603,resultCategories:["ExpectedError"]},SWITCH_SOURCE_WRONG_TYPE:{message:"Failed to create local audio stream, source is not a microphone",code:400,subCode:43604,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:43605,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:43606,resultCategories:["ExpectedError"]}},REMOTE_AUDIO_STREAM:{},IDENTIFIER:{PARSE_PHONENUMBER:{message:"Unable to parse PhoneNumberIdentifier object",code:422,subCode:44e3,resultCategories:["ExpectedError"]},PARSE_MSFT_TEAMS_USER:{message:"Unable to parse MicrosoftTeamsUserIdentifier object",code:422,subCode:44001,resultCategories:["ExpectedError"]},PARSE_MSFT_TEAMS_APP:{message:"Unable to parse MicrosoftTeamsAppIdentifier object",code:422,subCode:44002,resultCategories:["ExpectedError"]},PARSE_IDENTIFIER:{message:"Unable to parse Identifier object, please check the syntax",code:422,subCode:44003,resultCategories:["ExpectedError"]},INVALID_COMM_USER:{message:"Invalid CommunicationUser identifier specified",code:422,subCode:44004,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_USER_RAWID:{message:"Invalid MicrosoftTeamsUser rawId specified",code:422,subCode:44005,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_USER_USERID:{message:"Invalid MicrosoftTeamsUser microsoftTeamsUserId specified",code:422,subCode:44006,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_APP_RAWID:{message:"Invalid MicrosoftTeamsApp rawId specified",code:422,subCode:44007,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_APP_APPID:{message:"Invalid MicrosoftTeamsApp teamsAppId specified",code:422,subCode:44008,resultCategories:["ExpectedError"]},INVALID_UNKNOWN_IDENTIFIER:{message:"Invalid identifier specified, please specify an id",code:422,subCode:44009,resultCategories:["ExpectedError"]},PARSE_INVALID_IDENTIFIER:{message:"Unable to parse Identifier object",code:422,subCode:44010,resultCategories:["ExpectedError"]},INVALID_IDENTIFIER_ARRAY:{message:"AssertIsArrayOfIdentifiers failed. : userIds must be array of CommunicationIdentifier",code:422,subCode:44011,resultCategories:["ExpectedError"]},NO_CLOUD_PREFIX_FOUND:{message:"No cloud prefix found in identity",code:409,subCode:44012,resultCategories:["ExpectedError"]}},INTERNAL:{ECS_CONFIG_EMPTY:{message:"Config is empty",code:500,subCode:44100,resultCategories:["UnexpectedServerError"]},ECS_CONFIG_MISSING_ACS:{message:"Missing ACS config key",code:500,subCode:44101,resultCategories:["UnexpectedServerError"]},ECS_CONFIG_MERGING_ERROR:{message:"Error while merging config",code:500,subCode:44102,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE_INVALID_CLOUD_TYPE:{message:"Failed to initialize telemetry",code:500,subCode:44103,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE_ALREADY_INITIALIZED:{message:"Failed to initialize telemetry",code:500,subCode:44104,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE:{message:"Failed to create and initialize telemetry logger for {0}",code:500,subCode:44105,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_FLUSH:{message:"Failed to flush telemetry",code:500,subCode:44106,resultCategories:["UnexpectedClientError"]},TELEMETRY_LOGGER_INIT_FAIL:{message:"Failed to initialize telemetry logger",code:500,subCode:44107,resultCategories:["UnexpectedClientError"]},NO_TOKEN_PROVIDED:{message:"No CommunicationTokenCredential provided",code:401,subCode:44108,resultCategories:["ExpectedError"]},EMPTY_TOKEN:{message:"AccessToken is empty",code:401,subCode:44109,resultCategories:["ExpectedError"]},GET_TOKEN:{message:"Failed to get AccessToken",code:401,subCode:44110,resultCategories:["UnexpectedClientError"]},TOKEN_PAYLOAD_UNDEFINED:{message:"Invalid token",code:401,subCode:44111,resultCategories:["ExpectedError"]},TOKEN_UNDEFINED:{message:"Failed to parse AccessToken",code:401,subCode:44112,resultCategories:["ExpectedError"]},INVALID_TOKEN_SCOPE:{message:"AccessToken does not contain 'voip' or 'voip.join' scope",code:401,subCode:44113,resultCategories:["ExpectedError"]},INVALID_TOKEN_SCOPE_FORMAT:{message:"Wrong AccessToken scope format. Scope is expected to be a string that contains 'voip'",code:401,subCode:44114,resultCategories:["ExpectedError"]},RESOURCE_NOT_FOUND_IN_TOKEN:{message:"AccessToken does not contain ACS resource Id",code:401,subCode:44115,resultCategories:["ExpectedError"]},USERID_NOT_FOUND_IN_TOKEN:{message:"AccessToken does not contain ACS user Id",code:401,subCode:44116,resultCategories:["ExpectedError"]},PARSE_TOKEN_FAIL:{message:"Failed to parse AccessToken",code:401,subCode:44117,resultCategories:["UnexpectedClientError"]},OPERATION_TIMEDOUT:{message:"Operation timed out",code:408,subCode:44118,resultCategories:["UnexpectedClientError"]}},FEATURES:{AUDIO_EFFECTS:{SET_ECHO_CANCELLATION:{message:"Error while trying to {0} echo cancellation",code:500,subCode:45e3,resultCategories:["UnexpectedClientError"]},SET_NOISE_SUPPRESSION:{message:"Error while trying to {0} noise suppression",code:500,subCode:45001,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:400,subCode:45002,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:400,subCode:45003,resultCategories:["ExpectedError"]},DISABLED:{message:"Setting audio effects is disabled.",code:403,subCode:45004,resultCategories:["ExpectedError"]},START_DISPOSED:{message:"Audio effects feature is disposed. Create a new AudioEffects feature instance.",code:400,subCode:45005,resultCategories:["ExpectedError"]},SOURCE_UNSUPPORTED:{message:"Current source is not supported",code:415,subCode:45006,resultCategories:["ExpectedError"]},START_DEVICE_MANAGER:{message:"Failed to get device manager to start effects.",code:500,subCode:45007,resultCategories:["UnexpectedClientError"]},STOP_DISPOSED:{message:"Audio effects feature is disposed. Create a new AudioEffects feature instance.",code:400,subCode:45008,resultCategories:["ExpectedError"]},STOP_DEVICE_MANAGER:{message:"Failed to get device manager to stop effects.",code:500,subCode:45009,resultCategories:["UnexpectedClientError"]},FAILED_TO_GET_DM:{message:"Internal error - DM missing",code:500,subCode:45010,resultCategories:["UnexpectedClientError"]},PROVIDER_UNAVAILABLE:{message:"EffectProvider not available",code:500,subCode:45011,resultCategories:["UnexpectedClientError"]},AEC_PROVIDER_MISSING:{message:"Internal error - stack aec provider missing",code:500,subCode:45012,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT:{message:"Invalid effect provided",code:400,subCode:45013,resultCategories:["ExpectedError"]},INVALID_EFFECT_ECHO:{message:"Invalid or no echo cancellation effect provided",code:400,subCode:45014,resultCategories:["ExpectedError"]},INVALID_EFFECT_NOISE_SUPP:{message:"Invalid or no noise suppression effect provided",code:400,subCode:45015,resultCategories:["ExpectedError"]},UNSUPPORTED_EFFECT:{message:"{0} is not supported.",code:415,subCode:45016,resultCategories:["UnexpectedClientError"]},SUPPORT_CHECK_FAILED:{message:"Error while checking support",code:501,subCode:45017,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT_GAINCONTROL:{message:"Invalid or no auto gain control effect provided",code:400,subCode:45018,resultCategories:["ExpectedError"]},SET_AUTO_GAIN_CONTROL:{message:"Error while trying to {0} auto gain control",code:500,subCode:45019,resultCategories:["UnexpectedClientError"]},AUDIO_FLAGS:{message:"Error setting browser audio processing flags",code:500,subCode:45020,resultCategories:["UnexpectedClientError"]},START_FAILED:{message:"Error starting audio effects.",code:500,subCode:45021,resultCategories:["UnexpectedClientError"]},STOP_FAILED:{message:"Error stopping audio effects.",code:500,subCode:45022,resultCategories:["UnexpectedClientError"]},DISPOSE_FAILED:{message:"Error disposing audio effects feature.",code:500,subCode:45023,resultCategories:["UnexpectedClientError"]}},AUDIO_ZONES:{},CALL_SURVEY:{INVALID_SURVEY:{message:"{0}.",code:400,subCode:45100,resultCategories:["ExpectedError"]},SUBMIT_TIMEOUT:{message:"Please try again.",code:408,subCode:45101,resultCategories:["UnexpectedClientError"]}},CAPABILITIES:{},CAPTIONS:{INITIALIZE:{message:"Failed to initialize Captions.",code:500,subCode:45200,resultCategories:["UnexpectedClientError"]},DISABLED:{message:"Feature is not enabled.",code:412,subCode:45201,resultCategories:["ExpectedError"]},SPOKEN_LANG_UNSUPPORTED:{message:"Spoken language requested is not supported.",code:400,subCode:45202,resultCategories:["ExpectedError"]},MEETING_POLICY_DISABLED:{message:"Captions feature is disabled in meeting policy.",code:403,subCode:45203,resultCategories:["ExpectedError"]},CALLING_POLICY_DISABLED:{message:"Captions feature is disabled in calling policy.",code:403,subCode:45204,resultCategories:["ExpectedError"]},START_FAILED:{message:"Could not start captions.",code:500,subCode:45205,resultCategories:["UnexpectedClientError"]},UPDATE_LANGUAGE_NOT_STARTED:{message:"Cannot update spoken language as captions has not started.",code:400,subCode:45206,resultCategories:["ExpectedError"]},SPOKEN_LANG_DISABLED:{message:"Set spoken language is not enabled.",code:412,subCode:45207,resultCategories:["ExpectedError"]},UPDATE_LANGUAGE_GET_TOKEN:{message:"Unable to update spoken language. Failed to get token.",code:401,subCode:45208,resultCategories:["UnexpectedClientError"]},UPDATE_LANGUAGE_FAILED:{message:"Unable to update spoken language.",code:500,subCode:45209,resultCategories:["UnexpectedClientError"]},UPDATE_CAPTIONS_NOT_STARTED:{message:"Cannot update caption language as captions has not started.",code:400,subCode:45210,resultCategories:["ExpectedError"]},CAPTIONS_LANG_DISABLED:{message:"Set caption language is not enabled.",code:412,subCode:45211,resultCategories:["ExpectedError"]},CAPTIONS_LANG_TEAMS_LICENSE:{message:"Set caption language failed. Teams premium license is needed to use this feature.",code:401,subCode:45212,resultCategories:["ExpectedError"]},CAPTIONS_LANG_UNSUPPORTED:{message:"Caption language requested is not supported.",code:400,subCode:45213,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_GET_TOKEN:{message:"Null token",code:401,subCode:45214,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_FAILED:{message:"Unable to update caption language.",code:500,subCode:45215,resultCategories:["UnexpectedClientError"]},CTE_POLICY_FETCH_FAIL:{message:"Failed to fetch policy for Teams Captions.",code:500,subCode:45216,resultCategories:["UnexpectedClientError"]},ALREADY_ACTIVE:{message:"Captions already active",code:400,subCode:45217,resultCategories:["ExpectedError"]},STOP_NOT_ACTIVE:{message:"Captions feature is not active.",code:400,subCode:45218,resultCategories:["ExpectedError"]},ALREADY_STARTING:{message:"Operation in progress",code:400,subCode:45219,resultCategories:["ExpectedError"]},SPOKEN_LANGUAGE_ALREADY_SET:{message:"Spoken language already set",code:400,subCode:45220,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_NOT_ACTIVE:{message:"Unable to update caption language as Captions is not active.",code:400,subCode:45221,resultCategories:["ExpectedError"]},CAPTIONS_LANG_ALREADY_SET:{message:"Caption language already set.",code:400,subCode:45222,resultCategories:["ExpectedError"]}},COMPOSED_STREAM:{},DATA_CHANNEL:{DISPOSED:{message:"DataChannel has been disposed",code:500,subCode:45300,resultCategories:["UnexpectedClientError"]},SENDER_NOT_READY:{message:"Sender is not ready",code:500,subCode:45301,resultCategories:["UnexpectedClientError"]},NO_AVAILABLE_CHANNEL_ID:{message:"No available channel id",code:500,subCode:45302,resultCategories:["UnexpectedClientError"]},INVALID_CHANNEL_ID:{message:"Invalid channel id",code:400,subCode:45303,resultCategories:["ExpectedError"]},INVALID_BITRATE_IN_KBPS:{message:"Invalid bitrateInKbps",code:400,subCode:45304,resultCategories:["ExpectedError"]},INVALID_PARTICIPANTS:{message:"Invalid participants",code:400,subCode:45305,resultCategories:["ExpectedError"]},TOO_MANY_PARTICIPANTS:{message:"Too many participants",code:400,subCode:45306,resultCategories:["ExpectedError"]},NO_VALID_PARTICIPANT:{message:"No valid participant",code:400,subCode:45307,resultCategories:["ExpectedError"]},MSG_DATA_EMPTY:{message:"Message data is empty",code:400,subCode:45308,resultCategories:["ExpectedError"]},MSG_DATA_TOO_LARGE:{message:"The size of message data is too large",code:400,subCode:45309,resultCategories:["ExpectedError"]},INVALID_MSG_LENGTH:{message:"Invalid message length",code:500,subCode:45310,resultCategories:["UnexpectedClientError"]},BUFFER_FULL:{message:"The buffer is full. Please wait and try again",code:500,subCode:45311,resultCategories:["UnexpectedClientError"]},SENDER_CLOSED:{message:"The sender has been closed",code:400,subCode:45312,resultCategories:["ExpectedError"]},NO_AVAILABLE_RELIABLE_CHANNEL:{message:"Currently there is no available reliable channel",code:500,subCode:45313,resultCategories:["UnexpectedClientError"]},NO_AVAILABLE_UNRELIABLE_CHANNEL:{message:"Currently there is no available unreliable channel",code:500,subCode:45314,resultCategories:["UnexpectedClientError"]},CHANNEL_ALREADY_ALLOCATED:{message:"Unable allocate the channel because a channel with the same channelId has already been allocated",code:500,subCode:45315,resultCategories:["UnexpectedClientError"]},INVALID_BITRATE:{message:"Invalid bitrate",code:400,subCode:45316,resultCategories:["ExpectedError"]},TRAFFIC_LIMITED:{message:"Traffic is limited",code:400,subCode:45317,resultCategories:["ExpectedError"]},SEND_FAIL:{message:"Failed to send message.",code:500,subCode:45318,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to {0} subscribe to event {1}, unknown event name",code:422,subCode:45319,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_TYPE:{message:"TypeError: Expect '{0}' to be of type '{1}'",code:400,subCode:45320,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_VALUE:{message:"ValueError: Expect '{0}' to be '{1}'",code:400,subCode:45321,resultCategories:["ExpectedError"]},CANT_FIND_CHANNEL_ID:{message:"Cannot find the channelId {0}",code:400,subCode:45322,resultCategories:["ExpectedError"]},FAILED_TO_CREATE_SENDER:{message:"Failed to create the sender.",code:500,subCode:45323,resultCategories:["UnexpectedClientError"]}},DEBUG_INFO:{},DIAGNOSTICS:{INCORRECT_VALUETYPE_MAPPED:{message:"Mapped to an incorrect value type={0}, diagnostic value={1}, for diagnostic {2}",code:500,subCode:45400,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:45401,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:45402,resultCategories:["ExpectedError"]},INCORRECT_VALUE_MAPPED:{message:"Cannot map ts quality level {0} for {1}",code:500,subCode:45403,resultCategories:["UnexpectedClientError"]}},DOMINANT_SPEAKER:{},LIVE_STREAM:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:45500,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:45501,resultCategories:["ExpectedError"]},INVALID_AGGREGATION_INTERVAL_RANGE:{message:"Invalid aggregationInterval value range.",code:400,subCode:45502,resultCategories:["ExpectedError"]},INVALID_DATAPOINTS_AGGREGATION_RANGE:{message:"invalid dataPointsPerAggregation value range.",code:400,subCode:45503,resultCategories:["ExpectedError"]},DISPOSED:{message:"MediaStatsCallFeature has been disposed.",code:400,subCode:45504,resultCategories:["ExpectedError"]}},MEDIA_STATS:{INVALID_AGGREGATION_INTERVAL_RANGE:{message:"Invalid aggregationInterval value range.",code:400,subCode:45550,resultCategories:["ExpectedError"]},INVALID_DATAPOINTS_AGGREGATION_RANGE:{message:"invalid dataPointsPerAggregation value range.",code:400,subCode:45551,resultCategories:["ExpectedError"]},DISPOSED:{message:"MediaStatsCallFeature has been disposed.",code:400,subCode:45552,resultCategories:["ExpectedError"]}},OPTIMAL_VIDEO_COUNT:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:45600,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:45601,resultCategories:["ExpectedError"]}},PPTLIVE:{},PRECALL_DIAGNOSTICS:{SET_DEVICE_FAIL:{message:"Failed to set default microphone or speaker with error",code:412,subCode:45700,resultCategories:["UnexpectedClientError"]},GET_DIAGNOSTICS_INFO:{message:"Unable to return call diagnostic information.",code:500,subCode:45701,resultCategories:["UnexpectedClientError"]},VIDEO_STREAM_TIMEOUT:{message:"Timeout in checking media stream status",code:500,subCode:45702,resultCategories:["UnexpectedClientError"]},GET_CALL_AGENT:{message:"Failed to get existing call agent or create a new one",code:500,subCode:45703,resultCategories:["UnexpectedClientError"]},CONNECT_FAIL:{message:"Test call failed to connect",code:500,subCode:45704,resultCategories:["UnexpectedClientError"]},RENDER_VIDEO:{message:"Call failed to render video.",code:500,subCode:45705,resultCategories:["UnexpectedClientError"]},HANGUP_FAIL:{message:"Test call failed hang up the call",code:500,subCode:45706,resultCategories:["UnexpectedClientError"]},VIDEO_MEDIASTATS:{message:"Failed to get video call media stats",code:500,subCode:45707,resultCategories:["UnexpectedClientError"]},CALL_CONNECT_TIMEOUT:{message:"Call timeout after {0}",code:408,subCode:45708,resultCategories:["UnexpectedClientError"]}},RAISE_HAND:{INITIALIZE:{message:"Could not initialize raise hand feature.",code:500,subCode:45750,resultCategories:["UnexpectedClientError"]},RAISE_HAND_PUBLISH_STATE:{message:"Could not change a participant state.",code:500,subCode:45751,resultCategories:["UnexpectedServerError"]},RAISE_HAND_FAIL:{message:"Could not change a participant state.",code:500,subCode:45752,resultCategories:["UnexpectedServerError"]},LOWER_HAND_FAIL:{message:"Could not change a participant state.",code:500,subCode:45753,resultCategories:["UnexpectedServerError"]},LOWER_REMOTEPARTICIPANTS_HANDS_FAIL:{message:"Could not change a participant state.",code:500,subCode:45754,resultCategories:["UnexpectedServerError"]},LOWER_ALL_HANDS_FAIL:{message:"Could not change a participant state.",code:500,subCode:45755,resultCategories:["UnexpectedServerError"]}},REACTION:{CALL_NOT_CONNECTED:{message:"Call is not connected yet to send reaction",code:400,subCode:45800,resultCategories:["ExpectedError"]},NOT_SUPPORTED_1TO1_CTE:{message:"Reaction send is not supported for 1:1 direct calling with teams identity",code:400,subCode:45801,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE_FAIL_POLICY:{message:"Unable to register listener due to meeting policy",code:403,subCode:45802,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE_FAIL_POLICY:{message:"Unable to deregister listener due to meeting policy",code:403,subCode:45803,resultCategories:["ExpectedError"]},SEND_FAIL_POLICY:{message:"Unable to send reaction due to meeting policy",code:403,subCode:45804,resultCategories:["ExpectedError"]},STATE_SERVICE_CONNECT_FAIL:{message:"Could not create state service proxy web-socket connection",code:500,subCode:45805,resultCategories:["UnexpectedServerError"]},MAP_CREATE_FAIL:{message:"Could not create sync map to exchange reaction",code:500,subCode:45806,resultCategories:["UnexpectedServerError"]},NOT_INIT_YET:{message:"Unable to handle send reaction",code:400,subCode:45807,resultCategories:["ExpectedError"]},SEND_REACTION_FAIL:{message:"Unable to handle send reaction",code:500,subCode:45808,resultCategories:["UnexpectedClientError"]},RECEIVE_REACTION_FAIL:{message:"Unable to parse reaction",code:500,subCode:45809,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:45810,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:45811,resultCategories:["ExpectedError"]}},RECORDING:{EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:45850,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:45851,resultCategories:["ExpectedError"]}},SPOTLIGHT:{ALREADY_SPOTLIGHTED:{message:"Bad request. All participants are already spotlighted",code:400,subCode:45900,resultCategories:["ExpectedError"]},START_SPOTLIGHT_FAILED:{message:"Internal Error. Start spotlight for participants failed",code:500,subCode:45901,resultCategories:["UnexpectedServerError"]},SPOTLIGHT_LIGHT_MAX_REACHED:{message:"startSpotlight failed. {0} is the max number of participants that can be Spotlighted",code:400,subCode:45902,resultCategories:["ExpectedError"]},UNSUPPORTED_ROLE_TYPE:{message:"{0} spotlight failed. User does not have a Presenter or Organizer role in {1}",code:403,subCode:45903,resultCategories:["ExpectedError"]}},TEAMS_MEETING_AUDIO_CONFERENCING:{ONLY_AVAILABLE_IN_MEETINGS:{message:"Teams meeting audio conferencing feature is only available in meetings",code:400,subCode:45950,resultCategories:["ExpectedError"]},DISABLED:{message:"Teams meeting audio conferencing details feature is disabled",code:405,subCode:45951,resultCategories:["ExpectedError"]},UNAVAILABLE_BEFORE_JOINING:{message:"Teams meeting audio conferencing details are not available before joining the Teams meeting",code:400,subCode:45952,resultCategories:["ExpectedError"]},UNVAILABLE_IN_LOBBY:{message:"Teams meeting audio conferencing details are not available in Lobby",code:400,subCode:45953,resultCategories:["ExpectedError"]},DETAILS_NOT_CONFIGURED:{message:"Teams meeting audio conferencing details is not configured",code:400,subCode:45954,resultCategories:["UnexpectedClientError"]},GET_DETAILS_FAILED:{message:"Error retrieving Teams meeting audio conferencing details",code:500,subCode:45955,resultCategories:["UnexpectedServerError"]}},TRANSCRIPTION:{},TRANSFER:{TRANSFER_TO_TARGET_FAILED:{message:"Transfer to target failed",code:500,subCode:46050,resultCategories:["UnexpectedClientError"]},UNSUPPORTED_CALL_TYPE:{message:"Transfer is not supported in this call.",code:400,subCode:46051,resultCategories:["ExpectedError"]},TARGET_NOT_RECOGNIZED:{message:"Transfer target is not recognized.",code:400,subCode:46052,resultCategories:["ExpectedError"]},INVALID_TARGET_TYPE:{message:"Invalid target participant type detected: {0}.",code:400,subCode:46053,resultCategories:["ExpectedError"]}},UNMIXED_AUDIO:{UNAVAILABLE:{message:"UnmixedAudio is not available.",code:500,subCode:46100,resultCategories:["UnexpectedClientError"]},PENDING_OPERATION:{message:"The operation cannot be done because there is a pending operation",code:400,subCode:46101,resultCategories:["ExpectedError"]},UNSUPPORTED_OPERATION:{message:"The operation is not supported in peer-to-peer call",code:400,subCode:46102,resultCategories:["ExpectedError"]},ENABLED:{message:"Unmixed audio has been enabled",code:400,subCode:46103,resultCategories:["ExpectedError"]},DISABLED:{message:"Unmixed audio has been disabled",code:400,subCode:46104,resultCategories:["ExpectedError"]},DISPOSED:{message:"Unmixed audio has been disposed",code:400,subCode:46105,resultCategories:["ExpectedError"]},EVENT_SUBSCIBE_UNSUBSCRIBE:{message:"Unable to {0} to event {1}, unknown event name",code:422,subCode:46106,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_TYPE:{message:"TypeError: Expect '{0}' to be of type '{1}'",code:400,subCode:46107,resultCategories:["ExpectedError"]},WRONG_ARGUMENT_VALUE:{message:"ValueError: Expect '{0}' to be '{1}'",code:400,subCode:46108,resultCategories:["ExpectedError"]},INVALID_STATE:{message:"Invalid state: {0}",code:400,subCode:46109,resultCategories:["ExpectedError"]},UNKNOWN_ERROR:{message:"Unknown error",code:500,subCode:46110,resultCategories:["UnexpectedClientError"]},FAILED_TO_ENABLE:{message:"Failed to enable unmixed audio: AudioContext={0}, UnmixedAudio={1}",code:500,subCode:46111,resultCategories:["UnexpectedClientError"]},FAILED_TO_DISABLE:{message:"Failed to disable unmixed audio: AudioContext={0}, UnmixedAudio={1}",code:500,subCode:46112,resultCategories:["UnexpectedClientError"]},FAILED_TO_INITIALIZE:{message:"Failed to initialize unmixed audio.",code:500,subCode:46113,resultCategories:["UnexpectedClientError"]}},VIDEO_EFFECTS:{DISABLED:{message:"Disabled.",code:403,subCode:46150,resultCategories:["ExpectedError"]},START_DISPOSED:{message:"VideoEffects feature is disposed. Create a new VideoEffects Feature instance.",code:400,subCode:46151,resultCategories:["ExpectedError"]},UNSUPPORTED_SOURCE:{message:"Current source is unsupported to use effects",code:415,subCode:46152,resultCategories:["ExpectedError"]},START_DEVICE_MANAGER:{message:"Failed to get device manager to start effects.",code:500,subCode:46153,resultCategories:["UnexpectedClientError"]},PROVIDER_UNAVAILABLE:{message:"EffectProvider not available",code:500,subCode:46154,resultCategories:["UnexpectedClientError"]},WEBCV_PROVIDER_FAILED:{message:"Failed to get WebCV provider.",code:500,subCode:46155,resultCategories:["UnexpectedClientError"]},UNSUPPORTED_EFFECT:{message:"Effect is not supported.",code:501,subCode:46156,resultCategories:["UnexpectedClientError"]},STOP_DISPOSED:{message:"VideoEffects feature is disposed. Create a new VideoEffects Feature instance.",code:400,subCode:46157,resultCategories:["UnexpectedClientError"]},STOP_DEVICE_MANAGER:{message:"Failed to get device manager to stop effects.",code:500,subCode:46158,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT:{message:"Invalid effect provided",code:400,subCode:46159,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {event}, unknown event name",code:400,subCode:46160,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {event}, unknown event name",code:400,subCode:46161,resultCategories:["ExpectedError"]},EFFECT_PROVIDER_TIMEOUT:{message:"Timed promise; rejected.",code:408,subCode:46162,resultCategories:["UnexpectedClientError"]},SUPPORT_CHECK_FAILED:{message:"Error while checking support",code:501,subCode:46163,resultCategories:["UnexpectedClientError"]},START_FAILED:{message:"Error starting video effects",code:500,subCode:46164,resultCategories:["UnexpectedClientError"]},STOP_FAILED:{message:"Error stopping video effects",code:500,subCode:46165,resultCategories:["UnexpectedClientError"]},DISPOSE_FAILED:{message:"Error disposing video effects feature",code:500,subCode:46166,resultCategories:["UnexpectedClientError"]}},LOCAL_RECORDING:{ONLY_AVAILABLE_IN_MEETINGS:{message:"Local Recording feature is only available in meetings",code:400,subCode:46200,resultCategories:["ExpectedError"]},DISABLED:{message:"Local Recording feature is disabled",code:405,subCode:46201,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:{message:"Not able to subscribe to event {0}, unknown event name",code:422,subCode:46202,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE:{message:"Not able to unsubscribe event {0}, unknown event name",code:422,subCode:46203,resultCategories:["ExpectedError"]}}}},O=w.BAD_REQUEST,N=w.REQUEST_TIMEOUT,k=w.PRECONDITION_FAILED,L=w.UNPROCESSABLE_ENTITY,F=w.INTERNAL_ERROR,x="19:preview-",U={Date:!0,RegExp:!0,String:!0,Number:!0},V=3e3;class CallingCommunicationError extends Error{constructor(g){if(super(),this._code=0,this._subCode=0,this._resultCategories=[],this.name="CallingCommunicationError",g.originalError instanceof CallingCommunicationError)return this._code=g.originalError.code,this._subCode=g.originalError.subCode,this._resultCategories=g.originalError.resultCategories,this.message=g.originalError.message,void(this.stack=g.originalError.stack);g.defaultErrorMessageArgs?this.message=g.defaultError.message.replace(/{(\d+)}/g,(function(m,S){return g.defaultErrorMessageArgs&&void 0!==g.defaultErrorMessageArgs[S]?g.defaultErrorMessageArgs[S]:m})):this.message=g.defaultError.message,this._code=g.defaultError.code,this._subCode=g.defaultError.subCode,this._resultCategories=g.defaultError.resultCategories,g.originalError instanceof Error&&(this.stack=g.originalError.stack)}get code(){return this._code}get subCode(){return this._subCode}get resultCategories(){return this._resultCategories}}const B=Symbol("loggerKeySymbol");var H,$,G;function syncOperation(g){return operationDecoratorFactory(g||"",!1)}function asyncOperation(g){return operationDecoratorFactory(g||"",!0)}(H=g.CallAgentKind||(g.CallAgentKind={})).CallAgent="CallAgent",H.TeamsCallAgent="TeamsCallAgent",($=g.CallKind||(g.CallKind={})).Call="Call",$.TeamsCall="TeamsCall",(G=g.IncomingCallKind||(g.IncomingCallKind={})).IncomingCall="IncomingCall",G.TeamsIncomingCall="TeamsIncomingCall";const validateEmergencyCallOperation=m=>(S,v,C)=>{const _=C.value;return C.value=function(...S){if(this.kind===g.CallKind.TeamsCall&&this.isEmergencyCallInProgress())throw new CallingCommunicationError({defaultError:D.CALL.OPERATION_NOT_ALLOWED_DURING_EMERGENCY_CALL,defaultErrorMessageArgs:[m]});return _.apply(this,S)},C},operationDecoratorFactory=(g,m)=>m?(m,S,v)=>{const C=v.value;return v.value=async function(...m){let S;const v=+new Date;tryToLogAcsMessage(this,g,"started");try{S=await C.apply(this,m),tryToLogAcsMessage(this,g,"succeeded",v)}catch(m){const S=new CallingCommunicationError({defaultError:D.CALL.OPERATION_FAILED,defaultErrorMessageArgs:[g],originalError:m});throw tryToLogAcsError(this,g,m,v),S}return S},v}:(m,S,v)=>{const C=v.value;return v.value=function(...m){let S;const v=+new Date;tryToLogAcsMessage(this,g,"started");try{S=C.apply(this,m),tryToLogAcsMessage(this,g,"succeeded",v)}catch(m){const S=new CallingCommunicationError({defaultError:D.CALL.OPERATION_FAILED,defaultErrorMessageArgs:[g],originalError:m});throw tryToLogAcsError(this,g,m,v),S}return S},v};function tryToLogAcsMessage(g,m,S,v){const C=getAcsLogger(g);if(C){const g=v?`in ${(+new Date-v)/1e3}s`:"";C.info(`op:${m}, ${S} ${g}`)}}function tryToLogAcsError(g,m,S,v){const C=getAcsLogger(g);try{if(C){const g=v?`in ${(+new Date-v)/1e3}s`:"";C.error(`op:${m} failed, message=${S.message}, code=${S.code}${S.subCode?`, subCode=${S.subCode}`:""} ${g}`),S&&C.error(`op:${m} failed, message=${S.message}, code=${S.code}, subCode=${S.subCode}, resultCategories=${S.resultCategories}, time elapsed=${g}`)}}catch(S){}}function getAcsLogger(g){try{const m=Reflect.getMetadata(B,g);if(m)return g[m]}catch(g){}}function generateGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(g=>{const m=16*Math.random()|0;return("x"===g?m:3&m|8).toString(16)}))}var j="function",q="object",W="undefined",z="prototype",K="hasOwnProperty",J=Object,Y=J[z],Q=J.assign,X=J.create,Z=J.defineProperty,ee=Y[K];function getGlobal(){return typeof globalThis!==W&&globalThis?globalThis:typeof self!==W&&self?self:typeof window!==W&&window?window:typeof global!==W&&global?global:null}function throwTypeError(g){throw new TypeError(g)}function objCreateFn(g){if(X)return X(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==q&&m!==j&&throwTypeError("Object prototype may only be an Object:"+g),tmpFunc[z]=g,new tmpFunc}(getGlobal()||{}).Symbol,(getGlobal()||{}).Reflect;var __objAssignFnImpl=function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Y[K].call(m,C)&&(g[C]=m[C]);return g},te=Q||__objAssignFnImpl,extendStaticsFn=function(g,m){return extendStaticsFn=J.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m[K](S)&&(g[S]=m[S])},extendStaticsFn(g,m)};function __extendsFn(g,m){function __(){this.constructor=g}typeof m!==j&&null!==m&&throwTypeError("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn(g,m),g[z]=null===m?objCreateFn(m):(__[z]=m[z],new __)}var ie,ne={Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5},re="undefined",se="constructor",ae="prototype",oe="function",le="_dynInstFuncs",ce="_isDynProxy",de="_dynClass",he="_dynCls$",ue="_dynInstChk",ge=ue,pe="_dfOpts",me="_unknown_",fe="__proto__",Se="_dyn"+fe,ve="__dynProto$Gbl",Ce="_dynInstProto",_e="useBaseInst",ye="setInstFuncs",Ee=Object,Te=Ee.getPrototypeOf,Ie=Ee.getOwnPropertyNames;
/*!
	 * Microsoft Dynamic Proto Utility, 1.1.9
	 * Copyright (c) Microsoft and contributors. All rights reserved.
	 */function _getGlobal(){var g;return typeof globalThis!==re&&(g=globalThis),g||typeof self===re||(g=self),g||typeof window===re||(g=window),g||typeof global===re||(g=global),g||{}}var be,Ae=_getGlobal(),Re=Ae[ve]||(Ae[ve]={o:(ie={},ie[ye]=!0,ie[_e]=!0,ie),n:1e3});function _hasOwnProperty(g,m){return g&&Ee[ae].hasOwnProperty.call(g,m)}function _isObjectOrArrayPrototype(g){return g&&(g===Ee[ae]||g===Array[ae])}function _isObjectArrayOrFunctionPrototype(g){return _isObjectOrArrayPrototype(g)||g===Function[ae]}function _getObjProto(g){var m;if(g){if(Te)return Te(g);var S=g[fe]||g[ae]||(g[se]?g[se][ae]:null);m=g[Se]||S,_hasOwnProperty(g,Se)||(delete g[Ce],m=g[Se]=g[Ce]||g[Se],g[Ce]=S)}return m}function _forEachProp(g,m){var S=[];if(Ie)S=Ie(g);else for(var v in g)"string"==typeof v&&_hasOwnProperty(g,v)&&S.push(v);if(S&&S.length>0)for(var C=0;C<S.length;C++)m(S[C])}function _isDynamicCandidate(g,m,S){return m!==se&&typeof g[m]===oe&&(S||_hasOwnProperty(g,m))}function _throwTypeError(g){throw new TypeError("DynamicProto: "+g)}function _getInstanceFuncs(g){var m={};return _forEachProp(g,(function(S){!m[S]&&_isDynamicCandidate(g,S,!1)&&(m[S]=g[S])})),m}function _hasVisited(g,m){for(var S=g.length-1;S>=0;S--)if(g[S]===m)return!0;return!1}function _getBaseFuncs(g,m,S,v){function _instFuncProxy(g,m,S){var C=m[S];if(C[ce]&&v){var _=g[le]||{};!1!==_[ge]&&(C=(_[m[de]]||{})[S]||C)}return function(){return C.apply(g,arguments)}}var C={};_forEachProp(S,(function(g){C[g]=_instFuncProxy(m,S,g)}));for(var _=_getObjProto(g),E=[];_&&!_isObjectArrayOrFunctionPrototype(_)&&!_hasVisited(E,_);)_forEachProp(_,(function(g){!C[g]&&_isDynamicCandidate(_,g,!Te)&&(C[g]=_instFuncProxy(m,_,g))})),E.push(_),_=_getObjProto(_);return C}function _getInstFunc(g,m,S,v){var C=null;if(g&&_hasOwnProperty(S,de)){var _=g[le]||{};if((C=(_[S[de]]||{})[m])||_throwTypeError("Missing ["+m+"] "+oe),!C[ue]&&!1!==_[ge]){for(var E=!_hasOwnProperty(g,m),T=_getObjProto(g),I=[];E&&T&&!_isObjectArrayOrFunctionPrototype(T)&&!_hasVisited(I,T);){var b=T[m];if(b){E=b===v;break}I.push(T),T=_getObjProto(T)}try{E&&(g[m]=C),C[ue]=1}catch(g){_[ge]=!1}}}return C}function _getProtoFunc(g,m,S){var v=m[g];return v===S&&(v=_getObjProto(m)[g]),typeof v!==oe&&_throwTypeError("["+g+"] is not a "+oe),v}function _populatePrototype(g,m,S,v,C){function _createDynamicPrototype(g,m){var dynProtoProxy=function(){return(_getInstFunc(this,m,g,dynProtoProxy)||_getProtoFunc(m,g,dynProtoProxy)).apply(this,arguments)};return dynProtoProxy[ce]=1,dynProtoProxy}if(!_isObjectOrArrayPrototype(g)){var _=S[le]=S[le]||{},E=_[m]=_[m]||{};!1!==_[ge]&&(_[ge]=!!C),_forEachProp(S,(function(m){_isDynamicCandidate(S,m,!1)&&S[m]!==v[m]&&(E[m]=S[m],delete S[m],(!_hasOwnProperty(g,m)||g[m]&&!g[m][ce])&&(g[m]=_createDynamicPrototype(g,m)))}))}}function _checkPrototype(g,m){if(Te){for(var S=[],v=_getObjProto(m);v&&!_isObjectArrayOrFunctionPrototype(v)&&!_hasVisited(S,v);){if(v===g)return!0;S.push(v),v=_getObjProto(v)}return!1}return!0}function _getObjName(g,m){return _hasOwnProperty(g,ae)?g.name||m||me:((g||{})[se]||{}).name||m||me}function dynamicProto(g,m,S,v){_hasOwnProperty(g,ae)||_throwTypeError("theClass is an invalid class definition.");var C=g[ae];_checkPrototype(C,m)||_throwTypeError("["+_getObjName(g)+"] not in hierarchy of ["+_getObjName(m)+"]");var _=null;_hasOwnProperty(C,de)?_=C[de]:(_=he+_getObjName(g,"_")+"$"+Re.n,Re.n++,C[de]=_);var E=dynamicProto[pe],T=!!E[_e];T&&v&&void 0!==v[_e]&&(T=!!v[_e]);var I=_getInstanceFuncs(m);S(m,_getBaseFuncs(C,m,I,T));var b=!!Te&&!!E[ye];b&&v&&(b=!!v[ye]),_populatePrototype(C,_,m,I,!1!==b)}dynamicProto[pe]=Re.o,function(g){g[g.CRITICAL=1]="CRITICAL",g[g.WARNING=2]="WARNING"}(be||(be={}));var Pe={BrowserDoesNotSupportLocalStorage:0,BrowserCannotReadLocalStorage:1,BrowserCannotReadSessionStorage:2,BrowserCannotWriteLocalStorage:3,BrowserCannotWriteSessionStorage:4,BrowserFailedRemovalFromLocalStorage:5,BrowserFailedRemovalFromSessionStorage:6,CannotSendEmptyTelemetry:7,ClientPerformanceMathError:8,ErrorParsingAISessionCookie:9,ErrorPVCalc:10,ExceptionWhileLoggingError:11,FailedAddingTelemetryToBuffer:12,FailedMonitorAjaxAbort:13,FailedMonitorAjaxDur:14,FailedMonitorAjaxOpen:15,FailedMonitorAjaxRSC:16,FailedMonitorAjaxSend:17,FailedMonitorAjaxGetCorrelationHeader:18,FailedToAddHandlerForOnBeforeUnload:19,FailedToSendQueuedTelemetry:20,FailedToReportDataLoss:21,FlushFailed:22,MessageLimitPerPVExceeded:23,MissingRequiredFieldSpecification:24,NavigationTimingNotSupported:25,OnError:26,SessionRenewalDateIsZero:27,SenderNotInitialized:28,StartTrackEventFailed:29,StopTrackEventFailed:30,StartTrackFailed:31,StopTrackFailed:32,TelemetrySampledAndNotSent:33,TrackEventFailed:34,TrackExceptionFailed:35,TrackMetricFailed:36,TrackPVFailed:37,TrackPVFailedCalc:38,TrackTraceFailed:39,TransmissionFailed:40,FailedToSetStorageBuffer:41,FailedToRestoreStorageBuffer:42,InvalidBackendResponse:43,FailedToFixDepricatedValues:44,InvalidDurationValue:45,TelemetryEnvelopeInvalid:46,CreateEnvelopeError:47,CannotSerializeObject:48,CannotSerializeObjectNonSerializable:49,CircularReferenceDetected:50,ClearAuthContextFailed:51,ExceptionTruncated:52,IllegalCharsInName:53,ItemNotInArray:54,MaxAjaxPerPVExceeded:55,MessageTruncated:56,NameTooLong:57,SampleRateOutOfRange:58,SetAuthContextFailed:59,SetAuthContextFailedAccountName:60,StringValueTooLong:61,StartCalledMoreThanOnce:62,StopCalledWithoutStart:63,TelemetryInitializerFailed:64,TrackArgumentsNotSpecified:65,UrlTooLong:66,SessionStorageBufferFull:67,CannotAccessCookie:68,IdTooLong:69,InvalidEvent:70,FailedMonitorAjaxSetRequestHeader:71,SendBrowserInfoOnUserInit:72,PluginException:73,NotificationException:74,SnippetScriptLoadFailure:99,InvalidInstrumentationKey:100,CannotParseAiBlobValue:101,InvalidContentBlob:102,TrackPageActionEventFailed:103},Me="on",we="attachEvent",De="addEventListener",Oe="detachEvent",Ne="removeEventListener",ke=Z;function objToString(g){return Y.toString.call(g)}function isUndefined(g){return void 0===g||typeof g===W}function isNullOrUndefined(g){return null===g||isUndefined(g)}function isNotNullOrUndefined(g){return!isNullOrUndefined(g)}function hasOwnProperty(g,m){return g&&ee.call(g,m)}function isObject(g){return typeof g===q}function isFunction(g){return typeof g===j}function attachEvent(g,m,S,v){void 0===v&&(v=!1);var C=!1;if(!isNullOrUndefined(g))try{isNullOrUndefined(g[De])?isNullOrUndefined(g[we])||(g[we](Me+m,S),C=!0):(g[De](m,S,v),C=!0)}catch(g){}return C}function detachEvent(g,m,S,v){if(void 0===v&&(v=!1),!isNullOrUndefined(g))try{isNullOrUndefined(g[Ne])?isNullOrUndefined(g[Oe])||g[Oe](Me+m,S):g[Ne](m,S,v)}catch(g){}}function objForEachKey(g,m){if(g)for(var S in g)ee.call(g,S)&&m.call(g,S,g[S])}function strEndsWith(g,m){if(g&&m){var S=m.length,v=g.length;if(g===m)return!0;if(v>=S){for(var C=v-1,_=S-1;_>=0;_--){if(g[C]!=m[_])return!1;C--}return!0}}return!1}function strStartsWith(g,m){var S=!1;if(g&&m){var v=m.length;if(g===m)return!0;if(g.length>=v){for(var C=0;C<v;C++)if(g[C]!==m[C])return!1;S=!0}}return S}function strContains(g,m){return!(!g||!m)&&-1!==g.indexOf(m)}function isDate(g){return"[object Date]"===objToString(g)}function isArray(g){return"[object Array]"===objToString(g)}function isError(g){return"[object Error]"===objToString(g)}function isString(g){return"string"==typeof g}function isNumber(g){return"number"==typeof g}function isBoolean(g){return"boolean"==typeof g}function toISOString(g){if(isDate(g)){var pad=function(g){var m=String(g);return 1===m.length&&(m="0"+m),m};return g.getUTCFullYear()+"-"+pad(g.getUTCMonth()+1)+"-"+pad(g.getUTCDate())+"T"+pad(g.getUTCHours())+":"+pad(g.getUTCMinutes())+":"+pad(g.getUTCSeconds())+"."+String((g.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}function arrForEach(g,m,S){for(var v=g.length,C=0;C<v&&(!(C in g)||-1!==m.call(S||g,g[C],C,g));C++);}function arrIndexOf(g,m,S){for(var v=g.length,C=S||0,_=Math.max(C>=0?C:v-Math.abs(C),0);_<v;_++)if(_ in g&&g[_]===m)return _;return-1}function strTrim(g){return"string"!=typeof g?g:g.replace(/^\s+|\s+$/g,"")}var Le=!{toString:null}.propertyIsEnumerable("toString"),Fe=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function objKeys(g){var m=typeof g;m===j||m===q&&null!==g||throwTypeError("objKeys called on non-object");var S=[];for(var v in g)g&&ee.call(g,v)&&S.push(v);if(Le)for(var C=Fe.length,_=0;_<C;_++)g&&ee.call(g,Fe[_])&&S.push(Fe[_]);return S}function objDefineAccessors(g,m,S,v){if(ke)try{var C={enumerable:!0,configurable:!0};return S&&(C.get=S),v&&(C.set=v),ke(g,m,C),!0}catch(g){}return!1}function dateNow(){var g=Date;return g.now?g.now():(new g).getTime()}function getExceptionName(g){return isError(g)?g.name:""}function setValue(g,m,S,v,C){var _=S;return g&&((_=g[m])===S||C&&!C(_)||v&&!v(S)||(_=S,g[m]=_)),_}function getSetValue(g,m,S){var v;return g?!(v=g[m])&&isNullOrUndefined(v)&&(v=isUndefined(S)?{}:S,g[m]=v):v=isUndefined(S)?{}:S,v}function isNotTruthy(g){return!g}function isTruthy(g){return!!g}function throwError(g){throw new Error(g)}function optimizeObject(g){return g&&(g=J(Q?Q({},g):g)),g}var xe="window",Ue="document",Ve="navigator",Be="location",He="console",$e="performance",Ge="JSON",je="crypto",qe="msCrypto",We="ReactNative",ze="msie",Ke="trident/",Je=null,Ye=null,Qe=!1;function getGlobalInst(g){var m=getGlobal();return m&&m[g]?m[g]:g===xe&&hasWindow()?window:null}function hasWindow(){return Boolean(typeof window===q&&window)}function getWindow(){return hasWindow()?window:getGlobalInst(xe)}function hasDocument(){return Boolean(typeof document===q&&document)}function getDocument(){return hasDocument()?document:getGlobalInst(Ue)}function hasNavigator(){return Boolean(typeof navigator===q&&navigator)}function getNavigator(){return hasNavigator()?navigator:getGlobalInst(Ve)}function getLocation(g){if(g&&Qe){var m=getGlobalInst("__mockLocation");if(m)return m}return typeof location===q&&location?location:getGlobalInst(Be)}function getConsole(){return typeof console!==W?console:getGlobalInst(He)}function getPerformance(){return getGlobalInst($e)}function hasJSON(){return Boolean(typeof JSON===q&&JSON||null!==getGlobalInst(Ge))}function getJSON(){return hasJSON()?JSON||getGlobalInst(Ge):null}function getCrypto(){return getGlobalInst(je)}function getMsCrypto(){return getGlobalInst(qe)}function isReactNative(){var g=getNavigator();return!(!g||!g.product)&&g.product===We}function isIE(){var g=getNavigator();if(g&&(g.userAgent!==Ye||null===Je)){var m=((Ye=g.userAgent)||"").toLowerCase();Je=strContains(m,ze)||strContains(m,Ke)}return Je}function dumpObj(g){var m=Object[z].toString.call(g),S="";return"[object Error]"===m?S="{ stack: '"+g.stack+"', message: '"+g.message+"', name: '"+g.name+"'":hasJSON()&&(S=getJSON().stringify(g)),m+S}var Xe="AI (Internal): ",Ze="AI: ",et="AITR_";function _sanitizeDiagnosticText(g){return g?'"'+g.replace(/\"/g,"")+'"':""}var tt=function(){function _InternalLogMessage(g,m,S,v){void 0===S&&(S=!1);var C=this;C.messageId=g,C.message=(S?Ze:Xe)+g;var _="";hasJSON()&&(_=getJSON().stringify(v));var E=(m?" message:"+_sanitizeDiagnosticText(m):"")+(v?" props:"+_sanitizeDiagnosticText(_):"");C.message+=E}return _InternalLogMessage.dataType="MessageData",_InternalLogMessage}();function safeGetLogger(g,m){return(g||{}).logger||new it(m)}var it=function(){function DiagnosticLogger(g){this.identifier="DiagnosticLogger",this.queue=[];var m=0,S={};dynamicProto(DiagnosticLogger,this,(function(v){function _getConfigValue(m,S){var v=g[m];return isNullOrUndefined(v)?S:v}function _areInternalMessagesThrottled(){return m>=v.maxInternalMessageLimit()}isNullOrUndefined(g)&&(g={}),v.consoleLoggingLevel=function(){return _getConfigValue("loggingLevelConsole",0)},v.telemetryLoggingLevel=function(){return _getConfigValue("loggingLevelTelemetry",1)},v.maxInternalMessageLimit=function(){return _getConfigValue("maxMessageLimit",25)},v.enableDebugExceptions=function(){return _getConfigValue("enableDebugExceptions",!1)},v.throwInternal=function(g,m,C,_,E){void 0===E&&(E=!1);var T=new tt(m,C,E,_);if(v.enableDebugExceptions())throw T;if(!isUndefined(T)&&T&&!isUndefined(T.message)){var I=v.consoleLoggingLevel();if(E){var b=+T.messageId;!S[b]&&I>=be.WARNING&&(v.warnToConsole(T.message),S[b]=!0)}else I>=be.WARNING&&v.warnToConsole(T.message);v.logInternalMessage(g,T)}},v.warnToConsole=function(g){var m=getConsole();if(m){var S="log";m.warn&&(S="warn"),isFunction(m[S])&&m[S](g)}},v.resetInternalMessageCount=function(){m=0,S={}},v.logInternalMessage=function(g,C){if(!_areInternalMessagesThrottled()){var _=!0,E=et+C.messageId;if(S[E]?_=!1:S[E]=!0,_&&(g<=v.telemetryLoggingLevel()&&(v.queue.push(C),m++),m===v.maxInternalMessageLimit())){var T="Internal events throttle limit per PageView reached for this app.",I=new tt(Pe.MessageLimitPerPVExceeded,T,!1);v.queue.push(I),v.warnToConsole(T)}}}}))}return DiagnosticLogger}(),nt="ctx",rt=function(){function PerfEvent(g,m,S){var v,C=this,_=!1;(C.start=dateNow(),C.name=g,C.isAsync=S,C.isChildEvt=function(){return!1},isFunction(m))&&(_=objDefineAccessors(C,"payload",(function(){return!v&&isFunction(m)&&(v=m(),m=null),v})));C.getCtx=function(g){return g?g===PerfEvent.ParentContextKey||g===PerfEvent.ChildrenContextKey?C[g]:(C[nt]||{})[g]:null},C.setCtx=function(g,m){if(g)if(g===PerfEvent.ParentContextKey)C[g]||(C.isChildEvt=function(){return!0}),C[g]=m;else if(g===PerfEvent.ChildrenContextKey)C[g]=m;else{(C[nt]=C[nt]||{})[g]=m}},C.complete=function(){var g=0,S=C.getCtx(PerfEvent.ChildrenContextKey);if(isArray(S))for(var v=0;v<S.length;v++){var E=S[v];E&&(g+=E.time)}C.time=dateNow()-C.start,C.exTime=C.time-g,C.complete=function(){},!_&&isFunction(m)&&(C.payload=m())}}return PerfEvent.ParentContextKey="parent",PerfEvent.ChildrenContextKey="childEvts",PerfEvent}(),st=function(){function PerfManager(g){this.ctx={},dynamicProto(PerfManager,this,(function(m){m.create=function(g,m,S){return new rt(g,m,S)},m.fire=function(m){m&&(m.complete(),g&&g.perfEvent(m))},m.setCtx=function(g,S){g&&((m[nt]=m[nt]||{})[g]=S)},m.getCtx=function(g){return(m[nt]||{})[g]}}))}return PerfManager}(),at="CoreUtils.doPerf";function doPerf(g,m,S,v,C){if(g){var _=g;if(_&&isFunction(_.getPerfMgr)&&(_=_.getPerfMgr()),_){var E=void 0,T=_.getCtx(at);try{if(E=_.create(m(),v,C)){if(T&&E.setCtx&&(E.setCtx(rt.ParentContextKey,T),T.getCtx&&T.setCtx)){var I=T.getCtx(rt.ChildrenContextKey);I||(I=[],T.setCtx(rt.ChildrenContextKey,I)),I.push(E)}return _.setCtx(at,E),S(E)}}catch(g){E&&E.setCtx&&E.setCtx("exception",g)}finally{E&&_.fire(E),_.setCtx(at,T)}}}return S()}var ot=function(){function TelemetryPluginChain(g,m){var S=this,v=null,C=isFunction(g.processTelemetry),_=isFunction(g.setNextPlugin);S._hasRun=!1,S.getPlugin=function(){return g},S.getNext=function(){return v},S.setNext=function(g){v=g},S.processTelemetry=function(E,T){T||(T=m);var I=g?g.identifier:"TelemetryPluginChain";doPerf(T?T.core():null,(function(){return I+":processTelemetry"}),(function(){if(g&&C){S._hasRun=!0;try{T.setNext(v),_&&g.setNextPlugin(v),v&&(v._hasRun=!1),g.processTelemetry(E,T)}catch(S){var m=v&&v._hasRun;v&&m||T.diagLog().throwInternal(be.CRITICAL,Pe.PluginException,"Plugin ["+g.identifier+"] failed during processTelemetry - "+S),v&&!m&&v.processTelemetry(E,T)}}else v&&(S._hasRun=!0,v.processTelemetry(E,T))}),(function(){return{item:E}}),!E.sync)}}return TelemetryPluginChain}();function _createProxyChain(g,m){var S=[];if(g&&g.length>0)for(var v=null,C=0;C<g.length;C++){var _=g[C];if(_&&isFunction(_.processTelemetry)){var E=new ot(_,m);S.push(E),v&&v.setNext(E),v=E}}return S.length>0?S[0]:null}function _copyProxyChain(g,m,S){var v=[],C=!S;if(g)for(;g;){var _=g.getPlugin();(C||_===S)&&(C=!0,v.push(_)),g=g.getNext()}return C||v.push(S),_createProxyChain(v,m)}function _copyPluginChain(g,m,S){var v=g,C=!1;return S&&g&&(v=[],arrForEach(g,(function(g){(C||g===S)&&(C=!0,v.push(g))}))),S&&!C&&(v||(v=[]),v.push(S)),_createProxyChain(v,m)}var lt=function(){function ProcessTelemetryContext(g,m,S,v){var C=this,_=null;null!==v&&(g&&isFunction(g.getPlugin)?_=_copyProxyChain(g,C,v||g.getPlugin()):v?_=_copyPluginChain(g,C,v):isUndefined(v)&&(_=_createProxyChain(g,C))),C.core=function(){return S},C.diagLog=function(){return safeGetLogger(S,m)},C.getCfg=function(){return m},C.getExtCfg=function(g,S){var v;if(void 0===S&&(S={}),m){var C=m.extensionConfig;C&&g&&(v=C[g])}return v||S},C.getConfig=function(g,S,v){var _;void 0===v&&(v=!1);var E=C.getExtCfg(g,null);return E&&!isNullOrUndefined(E[S])?_=E[S]:m&&!isNullOrUndefined(m[S])&&(_=m[S]),isNullOrUndefined(_)?v:_},C.hasNext=function(){return null!=_},C.getNext=function(){return _},C.setNext=function(g){_=g},C.processNext=function(g){var m=_;m&&(_=m.getNext(),m.processTelemetry(g,C))},C.createNew=function(g,v){return void 0===g&&(g=null),new ProcessTelemetryContext(g||_,m,S,v)}}return ProcessTelemetryContext}(),ct="iKey",dt="extensionConfig",ht="getPlugin",ut=function(){function BaseTelemetryPlugin(){var g=this,m=!1,S=null,v=null;g.core=null,g.diagLog=function(m){return g._getTelCtx(m).diagLog()},g.isInitialized=function(){return m},g.setInitialized=function(g){m=g},g.setNextPlugin=function(g){v=g},g.processNext=function(g,m){m?m.processNext(g):v&&isFunction(v.processTelemetry)&&v.processTelemetry(g,null)},g._getTelCtx=function(m){void 0===m&&(m=null);var C=m;if(!C){var _=S||new lt(null,{},g.core);C=v&&v[ht]?_.createNew(null,v[ht]):_.createNew(null,v)}return C},g._baseTelInit=function(C,_,E,T){C&&setValue(C,dt,[],null,isNullOrUndefined),!T&&_&&(T=_.getProcessTelContext().getNext());var I=v;v&&v[ht]&&(I=v[ht]()),g.core=_,S=new lt(T,C,_,I),m=!0}}return BaseTelemetryPlugin.prototype.initialize=function(g,m,S,v){this._baseTelInit(g,m,S,v)},BaseTelemetryPlugin}(),gt="processTelemetry",pt="priority",mt="setNextPlugin",ft="isInitialized";function initializePlugins(g,m){for(var S=[],v=null,C=g.getNext();C;){var _=C.getPlugin();_&&(v&&isFunction(v[mt])&&isFunction(_[gt])&&v[mt](_),isFunction(_[ft])&&_[ft]()||S.push(_),v=_,C=C.getNext())}arrForEach(S,(function(S){S.initialize(g.getCfg(),g.core(),m,g.getNext())}))}function sortPlugins(g){return g.sort((function(g,m){var S=0,v=isFunction(m[gt]);return isFunction(g[gt])?S=v?g[pt]-m[pt]:1:v&&(S=-1),S}))}var St=500,vt="Channel has invalid priority",Ct=function(g){function ChannelController(){var m,S=g.call(this)||this;function _checkQueuePriority(g){arrForEach(g,(function(g){g.priority<St&&throwError(vt+g.identifier)}))}function _addChannelQueue(g){g&&g.length>0&&(_checkQueuePriority(g=g.sort((function(g,m){return g.priority-m.priority}))),m.push(g))}function _createChannelQueues(g,S){if(m=[],g&&arrForEach(g,(function(g){return _addChannelQueue(g)})),S){var v=[];arrForEach(S,(function(g){g.priority>St&&v.push(g)})),_addChannelQueue(v)}}return S.identifier="ChannelControllerPlugin",S.priority=St,dynamicProto(ChannelController,S,(function(g,v){g.setNextPlugin=function(g){},g.processTelemetry=function(g,v){m&&arrForEach(m,(function(m){m.length>0&&S._getTelCtx(v).createNew(m).processNext(g)}))},g.getChannelControls=function(){return m},g.initialize=function(S,C,_){g.isInitialized()||(v.initialize(S,C,_),_createChannelQueues((S||{}).channels,_),arrForEach(m,(function(g){return initializePlugins(new lt(g,S,C),_)})))}})),S}var m;return __extendsFn(ChannelController,g),ChannelController._staticInit=(objDefineAccessors(m=ChannelController.prototype,"ChannelControls",m.getChannelControls),void objDefineAccessors(m,"channelQueue",m.getChannelControls)),ChannelController}(ut),_t="toGMTString",yt="toUTCString",Et="cookie",Tt="expires",It="enabled",bt="isCookieUseDisabled",At="disableCookiesUsage",Rt="_ckMgr",Pt="",Mt=null,wt=null,Dt=null,Ot=getDocument(),Nt={},kt={};function _gblCookieMgr(g,m){var S=createCookieMgr[Rt]||kt[Rt];return S||(S=createCookieMgr[Rt]=createCookieMgr(g,m),kt[Rt]=S),S}function _isMgrEnabled(g){return!g||g.isEnabled()}function _createCookieMgrConfig(g){var m=g.cookieCfg=g.cookieCfg||{};if(setValue(m,"domain",g.cookieDomain,isNotNullOrUndefined,isNullOrUndefined),setValue(m,"path",g.cookiePath||"/",null,isNullOrUndefined),isNullOrUndefined(m[It])){var S=void 0;isUndefined(g[bt])||(S=!g[bt]),isUndefined(g[At])||(S=!g[At]),m[It]=S}return m}function safeGetCookieMgr(g,m){var S;if(g)S=g.getCookieMgr();else if(m){var v=(m||{}).cookieCfg;S=v[Rt]?v[Rt]:createCookieMgr(m)}return S||(S=_gblCookieMgr(m,(g||{}).logger)),S}function createCookieMgr(g,m){var S=_createCookieMgrConfig(g||kt),v=S.path||"/",C=S.domain,_=!1!==S[It],E={isEnabled:function(){var g=_&&areCookiesSupported(m),S=kt[Rt];return g&&S&&E!==S&&(g=_isMgrEnabled(S)),g},setEnabled:function(g){_=!1!==g},set:function(g,m,_,T,I){if(_isMgrEnabled(E)){var b={},A=strTrim(m||Pt),R=A.indexOf(";");if(-1!==R&&(A=strTrim(m.substring(0,R)),b=_extractParts(m.substring(R+1))),setValue(b,"domain",T||C,isTruthy,isUndefined),!isNullOrUndefined(_)){var P=isIE();if(isUndefined(b[Tt])){var M=dateNow()+1e3*_;if(M>0){var w=new Date;w.setTime(M),setValue(b,Tt,_formatDate(w,P?_t:yt)||_formatDate(w,P?_t:yt)||Pt,isTruthy)}}P||setValue(b,"max-age",Pt+_,null,isUndefined)}var D=getLocation();D&&"https:"===D.protocol&&(setValue(b,"secure",null,null,isUndefined),null===wt&&(wt=!uaDisallowsSameSiteNone((getNavigator()||{}).userAgent)),wt&&setValue(b,"SameSite","None",null,isUndefined)),setValue(b,"path",I||v,null,isUndefined),(S.setCookie||_setCookieValue)(g,_formatCookieValue(A,b))}},get:function(g){var m=Pt;return _isMgrEnabled(E)&&(m=(S.getCookie||_getCookieValue)(g)),m},del:function(g,m){_isMgrEnabled(E)&&E.purge(g,m)},purge:function(g,v){if(areCookiesSupported(m)){var C=((_={}).path=v||"/",_[Tt]="Thu, 01 Jan 1970 00:00:01 GMT",_);isIE()||(C["max-age"]="0"),(S.delCookie||_setCookieValue)(g,_formatCookieValue(Pt,C))}var _}};return E[Rt]=E,E}function areCookiesSupported(g){if(null===Mt){Mt=!1;try{Mt=void 0!==(Ot||{})[Et]}catch(m){g&&g.throwInternal(be.WARNING,Pe.CannotAccessCookie,"Cannot access document.cookie - "+getExceptionName(m),{exception:dumpObj(m)})}}return Mt}function _extractParts(g){var m={};g&&g.length&&arrForEach(strTrim(g).split(";"),(function(g){if(g=strTrim(g||Pt)){var S=g.indexOf("=");-1===S?m[g]=null:m[strTrim(g.substring(0,S))]=strTrim(g.substring(S+1))}}));return m}function _formatDate(g,m){return isFunction(g[m])?g[m]():null}function _formatCookieValue(g,m){var S=g||Pt;return objForEachKey(m,(function(g,m){S+="; "+g+(isNullOrUndefined(m)?Pt:"="+m)})),S}function _getCookieValue(g){var m=Pt;if(Ot){var S=Ot[Et]||Pt;Dt!==S&&(Nt=_extractParts(S),Dt=S),m=strTrim(Nt[g]||Pt)}return m}function _setCookieValue(g,m){Ot&&(Ot[Et]=g+"="+m)}function uaDisallowsSameSiteNone(g){return!!isString(g)&&(!(!strContains(g,"CPU iPhone OS 12")&&!strContains(g,"iPad; CPU OS 12"))||(!!(strContains(g,"Macintosh; Intel Mac OS X 10_14")&&strContains(g,"Version/")&&strContains(g,"Safari"))||(!(!strContains(g,"Macintosh; Intel Mac OS X 10_14")||!strEndsWith(g,"AppleWebKit/605.1.15 (KHTML, like Gecko)"))||(!(!strContains(g,"Chrome/5")&&!strContains(g,"Chrome/6"))||(!(!strContains(g,"UnrealEngine")||strContains(g,"Chrome"))||!(!strContains(g,"UCBrowser/12")&&!strContains(g,"UCBrowser/11")))))))}var Lt="Extensions must provide callback to initialize",Ft="_notificationManager",xt=function(){function BaseCore(){var g,m,S,v,C,_=!1;dynamicProto(BaseCore,this,(function(E){E._extensions=new Array,m=new Ct,E.logger=objCreateFn({throwInternal:function(g,m,S,v,C){},warnToConsole:function(g){},resetInternalMessageCount:function(){}}),g=[],E.isInitialized=function(){return _},E.initialize=function(g,v,C,T){E.isInitialized()&&throwError("Core should not be initialized more than once"),g&&!isNullOrUndefined(g.instrumentationKey)||throwError("Please provide instrumentation key"),S=T,E[Ft]=T,E.config=g||{},g.extensions=isNullOrUndefined(g.extensions)?[]:g.extensions,getSetValue(g,dt).NotificationManager=T,C&&(E.logger=C);var I=[];I.push.apply(I,v.concat(g.extensions)),I=sortPlugins(I);var b=[],A={};arrForEach(I,(function(g){(isNullOrUndefined(g)||isNullOrUndefined(g.initialize))&&throwError(Lt);var S=g.priority,v=g.identifier;g&&S&&(isNullOrUndefined(A[S])?A[S]=v:C.warnToConsole("Two extensions have same priority #"+S+" - "+A[S]+", "+v)),(!S||S<m.priority)&&b.push(g)})),I.push(m),b.push(m),I=sortPlugins(I),E._extensions=I,initializePlugins(new lt([m],g,E),I),initializePlugins(new lt(b,g,E),I),E._extensions=b,0===E.getTransmissionControls().length&&throwError("No channels available"),_=!0,E.releaseQueue()},E.getTransmissionControls=function(){return m.getChannelControls()},E.track=function(m){setValue(m,ct,E.config.instrumentationKey,null,isNotTruthy),setValue(m,"time",toISOString(new Date),null,isNotTruthy),setValue(m,"ver","4.0",null,isNullOrUndefined),E.isInitialized()?E.getProcessTelContext().processNext(m):g.push(m)},E.getProcessTelContext=function(){var g=E._extensions,S=g;return g&&0!==g.length||(S=[m]),new lt(S,E.config,E)},E.getNotifyMgr=function(){return S||(S=objCreateFn({addNotificationListener:function(g){},removeNotificationListener:function(g){},eventsSent:function(g){},eventsDiscarded:function(g,m){},eventsSendRequest:function(g,m){}}),E[Ft]=S),S},E.getCookieMgr=function(){return C||(C=createCookieMgr(E.config,E.logger)),C},E.setCookieMgr=function(g){C=g},E.getPerfMgr=function(){return v||E.config&&E.config.enablePerfMgr&&(v=new st(E.getNotifyMgr())),v},E.setPerfMgr=function(g){v=g},E.eventCnt=function(){return g.length},E.releaseQueue=function(){g.length>0&&(arrForEach(g,(function(g){E.getProcessTelContext().processNext(g)})),g=[])}}))}return BaseCore}(),Ut=function(){function NotificationManager(g){this.listeners=[];var m=!!(g||{}).perfEvtsSendAll;dynamicProto(NotificationManager,this,(function(g){g.addNotificationListener=function(m){g.listeners.push(m)},g.removeNotificationListener=function(m){for(var S=arrIndexOf(g.listeners,m);S>-1;)g.listeners.splice(S,1),S=arrIndexOf(g.listeners,m)},g.eventsSent=function(m){arrForEach(g.listeners,(function(g){g&&g.eventsSent&&setTimeout((function(){return g.eventsSent(m)}),0)}))},g.eventsDiscarded=function(m,S){arrForEach(g.listeners,(function(g){g&&g.eventsDiscarded&&setTimeout((function(){return g.eventsDiscarded(m,S)}),0)}))},g.eventsSendRequest=function(m,S){arrForEach(g.listeners,(function(g){if(g&&g.eventsSendRequest)if(S)setTimeout((function(){return g.eventsSendRequest(m,S)}),0);else try{g.eventsSendRequest(m,S)}catch(g){}}))},g.perfEvent=function(S){S&&(!m&&S.isChildEvt()||arrForEach(g.listeners,(function(g){if(g&&g.perfEvent)if(S.isAsync)setTimeout((function(){return g.perfEvent(S)}),0);else try{g.perfEvent(S)}catch(g){}})))}}))}return NotificationManager}(),Vt=function(g){function AppInsightsCore(){var m=g.call(this)||this;return dynamicProto(AppInsightsCore,m,(function(g,m){function _validateTelemetryItem(g){if(isNullOrUndefined(g.name))throw _notifyInvalidEvent(g),Error("telemetry name required")}function _notifyInvalidEvent(m){var S=g.getNotifyMgr();S&&S.eventsDiscarded([m],ne.InvalidEvent)}g.initialize=function(g,S,v,C){m.initialize(g,S,v||new it(g),C||new Ut(g))},g.track=function(S){doPerf(g.getPerfMgr(),(function(){return"AppInsightsCore:track"}),(function(){null===S&&(_notifyInvalidEvent(S),throwError("Invalid telemetry item")),_validateTelemetryItem(S),m.track(S)}),(function(){return{item:S}}),!S.sync)},g.addNotificationListener=function(m){var S=g.getNotifyMgr();S&&S.addNotificationListener(m)},g.removeNotificationListener=function(m){var S=g.getNotifyMgr();S&&S.removeNotificationListener(m)},g.pollInternalLogs=function(m){var S=g.config.diagnosticLogInterval;return S&&S>0||(S=1e4),setInterval((function(){var S=g.logger?g.logger.queue:[];arrForEach(S,(function(S){var v={name:m||"InternalMessageId: "+S.messageId,iKey:g.config.instrumentationKey,time:toISOString(new Date),baseType:tt.dataType,baseData:{message:S.message}};g.track(v)})),S.length=0}),S)}})),m}return __extendsFn(AppInsightsCore,g),AppInsightsCore}(xt),Bt=4294967296,Ht=4294967295,$t=!1,Gt=123456789,jt=987654321;function _mwcSeed(g){g<0&&(g>>>=0),Gt=123456789+g&Ht,jt=987654321-g&Ht,$t=!0}function _autoSeedMwc(){try{var g=2147483647&dateNow();_mwcSeed((Math.random()*Bt^g)+g)}catch(g){}}function randomValue(g){return g>0?Math.floor(random32()/Ht*(g+1))>>>0:0}function random32(g){var m,S=getCrypto()||getMsCrypto();return S&&S.getRandomValues?m=S.getRandomValues(new Uint32Array(1))[0]&Ht:isIE()?($t||_autoSeedMwc(),m=mwcRandom32()&Ht):m=Math.floor(Bt*Math.random()|0),g||(m>>>=0),m}function mwcRandom32(g){var m=((jt=36969*(65535&jt)+(jt>>16)&Ht)<<16)+(65535&(Gt=18e3*(65535&Gt)+(Gt>>16)&Ht))>>>0&Ht|0;return g||(m>>>=0),m}function addEventHandler(g,m){var S=!1,v=getWindow();v&&(S=attachEvent(v,g,m),S=attachEvent(v.body,g,m)||S);var C=getDocument();return C&&(S=zt.Attach(C,g,m)||S),S}function newGuid(){function randomHexDigit(){return randomValue(15)}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(Wt,(function(g){var m=0|randomHexDigit();return("x"===g?m:3&m|8).toString(16)}))}function perfNow(){var g=getPerformance();return g&&g.now?g.now():dateNow()}function newId(g){void 0===g&&(g=22);for(var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",S=random32()>>>0,v=0,C="";C.length<g;)v++,C+=m.charAt(63&S),S>>>=6,5===v&&(S=(random32()<<2&4294967295|3&S)>>>0,v=0);return C}function generateW3CId(){for(var g,m=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],S="",v=0;v<4;v++)S+=m[15&(g=random32())]+m[g>>4&15]+m[g>>8&15]+m[g>>12&15]+m[g>>16&15]+m[g>>20&15]+m[g>>24&15]+m[g>>28&15];var C=m[8+(3&random32())|0];return S.substr(0,8)+S.substr(9,4)+"4"+S.substr(13,3)+C+S.substr(16,3)+S.substr(19,12)}var qt,Wt=/[xy]/g,zt={Attach:attachEvent,AttachEvent:attachEvent,Detach:detachEvent,DetachEvent:detachEvent},Kt={NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32},Jt={Normal:1,CostDeferred:2,RealTime:3,Immediate:4},Yt={Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9},Qt=te(te({},Pe),{AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}),Xt="1DS-Web-JS-"+"3.1.2",Zt=((qt={})[0]=Yt.Unspecified,qt[2]=Yt.Double,qt[1]=Yt.String,qt[3]=Yt.Bool,qt[4098]=Yt.Double,qt[4097]=Yt.String,qt[4099]=Yt.Bool,qt),ei=null,ti=(Boolean(getDocument()),Boolean(getWindow()));function isValueAssigned(g){return!(""===g||isNullOrUndefined(g))}function getTenantId(g){if(g){var m=g.indexOf("-");if(m>-1)return g.substring(0,m)}return""}function isBeaconsSupported(){return null===ei&&(ei=hasNavigator()&&Boolean(getNavigator().sendBeacon)),ei}function isLatency(g){return!!(g&&isNumber(g)&&g>=Jt.Normal&&g<=Jt.Immediate)}function sanitizeProperty(g,m,S){if(!m&&!isValueAssigned(m)||"string"!=typeof g)return null;var v=typeof m;if("string"===v||"number"===v||"boolean"===v||isArray(m))m={value:m};else if("object"!==v||m.hasOwnProperty("value")){if(isNullOrUndefined(m.value)||""===m.value||!isString(m.value)&&!isNumber(m.value)&&!isBoolean(m.value)&&!isArray(m.value))return null}else m={value:S?JSON.stringify(m):m};if(isArray(m.value)&&!isArrayValid(m.value))return null;if(!isNullOrUndefined(m.kind)){if(isArray(m.value)||!isValueKind(m.kind))return null;m.value=m.value.toString()}return m}function useXDomainRequest(){if(void 0!==typeof XMLHttpRequest){var g=getGlobalInst("XMLHttpRequest");if(g){var m=new g;return Boolean(isUndefined(m.withCredentials)&&void 0!==typeof XDomainRequest)}}}function getCommonSchemaMetaData(g,m,S){var v=-1;if(!isUndefined(g))if(m>0&&(32===m?v=8192:m<=13&&(v=m<<5)),isDataType(S))-1===v&&(v=0),v|=S;else{var C=Zt[getFieldValueType(g)]||-1;-1!==v&&-1!==C?v|=C:C===Yt.Double&&(v=C)}return v}function getCookie(g){return areCookiesSupported(null)?getCookieValue(safeGetCookieMgr(null),g):""}function getCookieValue(g,m,S){var v;return void 0===S&&(S=!0),g&&(v=g.get(m),S&&v&&decodeURIComponent&&(v=decodeURIComponent(v))),v||""}function createGuid(g){void 0===g&&(g="D");var m=newGuid();return"B"===g?m="{"+m+"}":"P"===g?m="("+m+")":"N"===g&&(m=m.replace(/-/g,"")),m}function extend(g,m,S,v,C){var _={},E=!1,T=0,I=arguments.length,b=arguments;for("[object Boolean]"===Object[z].toString.call(b[0])&&(E=b[0],T++);T<I;T++){objForEachKey(b[T],(function(g,m){E&&m&&isObject(m)?isArray(m)?(_[g]=_[g]||[],arrForEach(m,(function(m,S){m&&isObject(m)?_[g][S]=extend(!0,_[g][S],m):_[g][S]=m}))):_[g]=extend(!0,_[g],m):_[g]=m}))}return _}var ii=perfNow;function isValueKind(g){return g===Kt.NotSet||g>Kt.NotSet&&g<=Kt.Pii_IPV4AddressLegacy||g===Kt.CustomerContent_GenericContent}function isDataType(g){return g>=0&&g<=9}function isArrayValid(g){return g.length>0}function addPageUnloadEventListener(g){var m=addEventHandler("beforeunload",g);return m=addEventHandler("unload",g)||m,m=addEventHandler("pagehide",g)||m}function setProcessTelemetryTimings(g,m){var S=g;S.timings=S.timings||{},S.timings.processTelemetryStart=S.timings.processTelemetryStart||{},S.timings.processTelemetryStart[m]=ii()}function getFieldValueType(g){var m=0;if(null!=g){var S=typeof g;"string"===S?m=1:"number"===S?m=2:"boolean"===S?m=3:S===q&&(m=4,isArray(g)?(m=4096,g.length>0&&(m|=getFieldValueType(g[0]))):hasOwnProperty(g,"value")&&(m=8192|getFieldValueType(g.value)))}return m}function isChromium(){return!!getGlobalInst("chrome")}var ni="version",ri="properties",si=function(g){function AppInsightsCore(){var m=g.call(this)||this;return m.pluginVersionStringArr=[],m.pluginVersionString="",dynamicProto(AppInsightsCore,m,(function(g,m){g.initialize=function(S,v,C,_){doPerf(g,(function(){return"AppInsightsCore.initialize"}),(function(){if(S){S.endpointUrl||(S.endpointUrl="https://browser.events.data.microsoft.com/OneCollector/1.0/");var E=S.propertyStorageOverride;if(E&&(!E.getProperty||!E.setProperty))throw new Error("Invalid property storage override passed.");S.channels&&arrForEach(S.channels,(function(m){m&&arrForEach(m,(function(m){if(m.identifier&&m.version){var S=m.identifier+"="+m.version;g.pluginVersionStringArr.push(S)}}))}))}g.getWParam=function(){return"undefined"!=typeof document?0:-1},v&&arrForEach(v,(function(m){if(m&&m.identifier&&m.version){var S=m.identifier+"="+m.version;g.pluginVersionStringArr.push(S)}})),g.pluginVersionString=g.pluginVersionStringArr.join(";");try{m.initialize(S,v,C,_)}catch(m){g.logger.throwInternal(be.CRITICAL,Qt.ErrorProvidedChannels,"Channels must be provided through config.channels only")}g.pollInternalLogs("InternalLog")}),(function(){return{config:S,extensions:v,logger:C,notificationManager:_}}))},g.track=function(S){doPerf(g,(function(){return"AppInsightsCore.track"}),(function(){var v=S;if(v){v.timings=v.timings||{},v.timings.trackStart=ii(),isLatency(v.latency)||(v.latency=Jt.Normal);var C=v.ext=v.ext||{};C.sdk=C.sdk||{},C.sdk.ver=Xt;var _=v.baseData=v.baseData||{};_[ri]||(_[ri]={});var E=_[ri];E[ni]||(E[ni]=""),""!==g.pluginVersionString&&(E[ni]=g.pluginVersionString)}m.track(v)}),(function(){return{item:S}}),!S.sync)}})),m}return __extendsFn(AppInsightsCore,g),AppInsightsCore}(Vt),ai="function",oi="object",li="undefined",ci="prototype",di="hasOwnProperty",hi=Object,ui=hi[ci],gi=hi.assign,pi=hi.create,mi=hi.defineProperty,fi=ui[di];function getGlobal$1(){return typeof globalThis!==li&&globalThis?globalThis:typeof self!==li&&self?self:typeof window!==li&&window?window:typeof global!==li&&global?global:null}function throwTypeError$1(g){throw new TypeError(g)}function objCreateFn$1(g){if(pi)return pi(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==oi&&m!==ai&&throwTypeError$1("Object prototype may only be an Object:"+g),tmpFunc[ci]=g,new tmpFunc}(getGlobal$1()||{}).Symbol,(getGlobal$1()||{}).Reflect;var Si,__objAssignFnImpl$1=function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])ui[di].call(m,C)&&(g[C]=m[C]);return g},vi=gi||__objAssignFnImpl$1,extendStaticsFn$1=function(g,m){return extendStaticsFn$1=hi.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m[di](S)&&(g[S]=m[S])},extendStaticsFn$1(g,m)};function __extendsFn$1(g,m){function __(){this.constructor=g}typeof m!==ai&&null!==m&&throwTypeError$1("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn$1(g,m),g[ci]=null===m?objCreateFn$1(m):(__[ci]=m[ci],new __)}!function(g){g[g.CRITICAL=1]="CRITICAL",g[g.WARNING=2]="WARNING"}(Si||(Si={}));var Ci={BrowserDoesNotSupportLocalStorage:0,BrowserCannotReadLocalStorage:1,BrowserCannotReadSessionStorage:2,BrowserCannotWriteLocalStorage:3,BrowserCannotWriteSessionStorage:4,BrowserFailedRemovalFromLocalStorage:5,BrowserFailedRemovalFromSessionStorage:6,CannotSendEmptyTelemetry:7,ClientPerformanceMathError:8,ErrorParsingAISessionCookie:9,ErrorPVCalc:10,ExceptionWhileLoggingError:11,FailedAddingTelemetryToBuffer:12,FailedMonitorAjaxAbort:13,FailedMonitorAjaxDur:14,FailedMonitorAjaxOpen:15,FailedMonitorAjaxRSC:16,FailedMonitorAjaxSend:17,FailedMonitorAjaxGetCorrelationHeader:18,FailedToAddHandlerForOnBeforeUnload:19,FailedToSendQueuedTelemetry:20,FailedToReportDataLoss:21,FlushFailed:22,MessageLimitPerPVExceeded:23,MissingRequiredFieldSpecification:24,NavigationTimingNotSupported:25,OnError:26,SessionRenewalDateIsZero:27,SenderNotInitialized:28,StartTrackEventFailed:29,StopTrackEventFailed:30,StartTrackFailed:31,StopTrackFailed:32,TelemetrySampledAndNotSent:33,TrackEventFailed:34,TrackExceptionFailed:35,TrackMetricFailed:36,TrackPVFailed:37,TrackPVFailedCalc:38,TrackTraceFailed:39,TransmissionFailed:40,FailedToSetStorageBuffer:41,FailedToRestoreStorageBuffer:42,InvalidBackendResponse:43,FailedToFixDepricatedValues:44,InvalidDurationValue:45,TelemetryEnvelopeInvalid:46,CreateEnvelopeError:47,CannotSerializeObject:48,CannotSerializeObjectNonSerializable:49,CircularReferenceDetected:50,ClearAuthContextFailed:51,ExceptionTruncated:52,IllegalCharsInName:53,ItemNotInArray:54,MaxAjaxPerPVExceeded:55,MessageTruncated:56,NameTooLong:57,SampleRateOutOfRange:58,SetAuthContextFailed:59,SetAuthContextFailedAccountName:60,StringValueTooLong:61,StartCalledMoreThanOnce:62,StopCalledWithoutStart:63,TelemetryInitializerFailed:64,TrackArgumentsNotSpecified:65,UrlTooLong:66,SessionStorageBufferFull:67,CannotAccessCookie:68,IdTooLong:69,InvalidEvent:70,FailedMonitorAjaxSetRequestHeader:71,SendBrowserInfoOnUserInit:72,PluginException:73,NotificationException:74,SnippetScriptLoadFailure:99,InvalidInstrumentationKey:100,CannotParseAiBlobValue:101,InvalidContentBlob:102,TrackPageActionEventFailed:103},_i=mi;function objToString$1(g){return ui.toString.call(g)}function isUndefined$1(g){return void 0===g||typeof g===li}function isNullOrUndefined$1(g){return null===g||isUndefined$1(g)}function isFunction$1(g){return typeof g===ai}function strContains$1(g,m){return!(!g||!m)&&-1!==g.indexOf(m)}function isArray$1(g){return"[object Array]"===objToString$1(g)}function isString$1(g){return"string"==typeof g}function isNumber$1(g){return"number"==typeof g}function arrForEach$1(g,m,S){for(var v=g.length,C=0;C<v&&(!(C in g)||-1!==m.call(S||g,g[C],C,g));C++);}var yi=!{toString:null}.propertyIsEnumerable("toString"),Ei=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function objKeys$1(g){var m=typeof g;m===ai||m===oi&&null!==g||throwTypeError$1("objKeys called on non-object");var S=[];for(var v in g)g&&fi.call(g,v)&&S.push(v);if(yi)for(var C=Ei.length,_=0;_<C;_++)g&&fi.call(g,Ei[_])&&S.push(Ei[_]);return S}function objDefineAccessors$1(g,m,S,v){if(_i)try{var C={enumerable:!0,configurable:!0};return S&&(C.get=S),v&&(C.set=v),_i(g,m,C),!0}catch(g){}return!1}function dateNow$1(){var g=Date;return g.now?g.now():(new g).getTime()}function setValue$1(g,m,S,v,C){var _=S;return g&&((_=g[m])===S||C&&!C(_)||v&&!v(S)||(_=S,g[m]=_)),_}var Ti="window",Ii="document",bi="navigator",Ai="console",Ri="performance",Pi="JSON",Mi="crypto",wi="msCrypto",Di="msie",Oi="trident/",Ni=null,ki=null;function getGlobalInst$1(g){var m=getGlobal$1();return m&&m[g]?m[g]:g===Ti&&hasWindow$1()?window:null}function hasWindow$1(){return Boolean(typeof window===oi&&window)}function getWindow$1(){return hasWindow$1()?window:getGlobalInst$1(Ti)}function hasDocument$1(){return Boolean(typeof document===oi&&document)}function getDocument$1(){return hasDocument$1()?document:getGlobalInst$1(Ii)}function hasNavigator$1(){return Boolean(typeof navigator===oi&&navigator)}function getNavigator$1(){return hasNavigator$1()?navigator:getGlobalInst$1(bi)}function getConsole$1(){return typeof console!==li?console:getGlobalInst$1(Ai)}function getPerformance$1(){return getGlobalInst$1(Ri)}function hasJSON$1(){return Boolean(typeof JSON===oi&&JSON||null!==getGlobalInst$1(Pi))}function getJSON$1(){return hasJSON$1()?JSON||getGlobalInst$1(Pi):null}function getCrypto$1(){return getGlobalInst$1(Mi)}function getMsCrypto$1(){return getGlobalInst$1(wi)}function isIE$1(){var g=getNavigator$1();if(g&&(g.userAgent!==ki||null===Ni)){var m=((ki=g.userAgent)||"").toLowerCase();Ni=strContains$1(m,Di)||strContains$1(m,Oi)}return Ni}var Li="AI (Internal): ",Fi="AI: ",xi="AITR_";function _sanitizeDiagnosticText$1(g){return g?'"'+g.replace(/\"/g,"")+'"':""}var Ui=function(){function _InternalLogMessage(g,m,S,v){void 0===S&&(S=!1);var C=this;C.messageId=g,C.message=(S?Fi:Li)+g;var _="";hasJSON$1()&&(_=getJSON$1().stringify(v));var E=(m?" message:"+_sanitizeDiagnosticText$1(m):"")+(v?" props:"+_sanitizeDiagnosticText$1(_):"");C.message+=E}return _InternalLogMessage.dataType="MessageData",_InternalLogMessage}();function safeGetLogger$1(g,m){return(g||{}).logger||new Vi(m)}var Vi=function(){function DiagnosticLogger(g){this.identifier="DiagnosticLogger",this.queue=[];var m=0,S={};dynamicProto(DiagnosticLogger,this,(function(v){function _getConfigValue(m,S){var v=g[m];return isNullOrUndefined$1(v)?S:v}function _areInternalMessagesThrottled(){return m>=v.maxInternalMessageLimit()}isNullOrUndefined$1(g)&&(g={}),v.consoleLoggingLevel=function(){return _getConfigValue("loggingLevelConsole",0)},v.telemetryLoggingLevel=function(){return _getConfigValue("loggingLevelTelemetry",1)},v.maxInternalMessageLimit=function(){return _getConfigValue("maxMessageLimit",25)},v.enableDebugExceptions=function(){return _getConfigValue("enableDebugExceptions",!1)},v.throwInternal=function(g,m,C,_,E){void 0===E&&(E=!1);var T=new Ui(m,C,E,_);if(v.enableDebugExceptions())throw T;if(!isUndefined$1(T)&&T&&!isUndefined$1(T.message)){var I=v.consoleLoggingLevel();if(E){var b=+T.messageId;!S[b]&&I>=Si.WARNING&&(v.warnToConsole(T.message),S[b]=!0)}else I>=Si.WARNING&&v.warnToConsole(T.message);v.logInternalMessage(g,T)}},v.warnToConsole=function(g){var m=getConsole$1();if(m){var S="log";m.warn&&(S="warn"),isFunction$1(m[S])&&m[S](g)}},v.resetInternalMessageCount=function(){m=0,S={}},v.logInternalMessage=function(g,C){if(!_areInternalMessagesThrottled()){var _=!0,E=xi+C.messageId;if(S[E]?_=!1:S[E]=!0,_&&(g<=v.telemetryLoggingLevel()&&(v.queue.push(C),m++),m===v.maxInternalMessageLimit())){var T="Internal events throttle limit per PageView reached for this app.",I=new Ui(Ci.MessageLimitPerPVExceeded,T,!1);v.queue.push(I),v.warnToConsole(T)}}}}))}return DiagnosticLogger}(),Bi="ctx",Hi=function(){function PerfEvent(g,m,S){var v,C=this,_=!1;(C.start=dateNow$1(),C.name=g,C.isAsync=S,C.isChildEvt=function(){return!1},isFunction$1(m))&&(_=objDefineAccessors$1(C,"payload",(function(){return!v&&isFunction$1(m)&&(v=m(),m=null),v})));C.getCtx=function(g){return g?g===PerfEvent.ParentContextKey||g===PerfEvent.ChildrenContextKey?C[g]:(C[Bi]||{})[g]:null},C.setCtx=function(g,m){if(g)if(g===PerfEvent.ParentContextKey)C[g]||(C.isChildEvt=function(){return!0}),C[g]=m;else if(g===PerfEvent.ChildrenContextKey)C[g]=m;else{(C[Bi]=C[Bi]||{})[g]=m}},C.complete=function(){var g=0,S=C.getCtx(PerfEvent.ChildrenContextKey);if(isArray$1(S))for(var v=0;v<S.length;v++){var E=S[v];E&&(g+=E.time)}C.time=dateNow$1()-C.start,C.exTime=C.time-g,C.complete=function(){},!_&&isFunction$1(m)&&(C.payload=m())}}return PerfEvent.ParentContextKey="parent",PerfEvent.ChildrenContextKey="childEvts",PerfEvent}(),$i="CoreUtils.doPerf";function doPerf$1(g,m,S,v,C){if(g){var _=g;if(_&&isFunction$1(_.getPerfMgr)&&(_=_.getPerfMgr()),_){var E=void 0,T=_.getCtx($i);try{if(E=_.create(m(),v,C)){if(T&&E.setCtx&&(E.setCtx(Hi.ParentContextKey,T),T.getCtx&&T.setCtx)){var I=T.getCtx(Hi.ChildrenContextKey);I||(I=[],T.setCtx(Hi.ChildrenContextKey,I)),I.push(E)}return _.setCtx($i,E),S(E)}}catch(g){E&&E.setCtx&&E.setCtx("exception",g)}finally{E&&_.fire(E),_.setCtx($i,T)}}}return S()}var Gi=function(){function TelemetryPluginChain(g,m){var S=this,v=null,C=isFunction$1(g.processTelemetry),_=isFunction$1(g.setNextPlugin);S._hasRun=!1,S.getPlugin=function(){return g},S.getNext=function(){return v},S.setNext=function(g){v=g},S.processTelemetry=function(E,T){T||(T=m);var I=g?g.identifier:"TelemetryPluginChain";doPerf$1(T?T.core():null,(function(){return I+":processTelemetry"}),(function(){if(g&&C){S._hasRun=!0;try{T.setNext(v),_&&g.setNextPlugin(v),v&&(v._hasRun=!1),g.processTelemetry(E,T)}catch(S){var m=v&&v._hasRun;v&&m||T.diagLog().throwInternal(Si.CRITICAL,Ci.PluginException,"Plugin ["+g.identifier+"] failed during processTelemetry - "+S),v&&!m&&v.processTelemetry(E,T)}}else v&&(S._hasRun=!0,v.processTelemetry(E,T))}),(function(){return{item:E}}),!E.sync)}}return TelemetryPluginChain}();function _createProxyChain$1(g,m){var S=[];if(g&&g.length>0)for(var v=null,C=0;C<g.length;C++){var _=g[C];if(_&&isFunction$1(_.processTelemetry)){var E=new Gi(_,m);S.push(E),v&&v.setNext(E),v=E}}return S.length>0?S[0]:null}function _copyProxyChain$1(g,m,S){var v=[],C=!S;if(g)for(;g;){var _=g.getPlugin();(C||_===S)&&(C=!0,v.push(_)),g=g.getNext()}return C||v.push(S),_createProxyChain$1(v,m)}function _copyPluginChain$1(g,m,S){var v=g,C=!1;return S&&g&&(v=[],arrForEach$1(g,(function(g){(C||g===S)&&(C=!0,v.push(g))}))),S&&!C&&(v||(v=[]),v.push(S)),_createProxyChain$1(v,m)}var ji=function(){function ProcessTelemetryContext(g,m,S,v){var C=this,_=null;null!==v&&(g&&isFunction$1(g.getPlugin)?_=_copyProxyChain$1(g,C,v||g.getPlugin()):v?_=_copyPluginChain$1(g,C,v):isUndefined$1(v)&&(_=_createProxyChain$1(g,C))),C.core=function(){return S},C.diagLog=function(){return safeGetLogger$1(S,m)},C.getCfg=function(){return m},C.getExtCfg=function(g,S){var v;if(void 0===S&&(S={}),m){var C=m.extensionConfig;C&&g&&(v=C[g])}return v||S},C.getConfig=function(g,S,v){var _;void 0===v&&(v=!1);var E=C.getExtCfg(g,null);return E&&!isNullOrUndefined$1(E[S])?_=E[S]:m&&!isNullOrUndefined$1(m[S])&&(_=m[S]),isNullOrUndefined$1(_)?v:_},C.hasNext=function(){return null!=_},C.getNext=function(){return _},C.setNext=function(g){_=g},C.processNext=function(g){var m=_;m&&(_=m.getNext(),m.processTelemetry(g,C))},C.createNew=function(g,v){return void 0===g&&(g=null),new ProcessTelemetryContext(g||_,m,S,v)}}return ProcessTelemetryContext}(),qi="extensionConfig",Wi="getPlugin",zi=function(){function BaseTelemetryPlugin(){var g=this,m=!1,S=null,v=null;g.core=null,g.diagLog=function(m){return g._getTelCtx(m).diagLog()},g.isInitialized=function(){return m},g.setInitialized=function(g){m=g},g.setNextPlugin=function(g){v=g},g.processNext=function(g,m){m?m.processNext(g):v&&isFunction$1(v.processTelemetry)&&v.processTelemetry(g,null)},g._getTelCtx=function(m){void 0===m&&(m=null);var C=m;if(!C){var _=S||new ji(null,{},g.core);C=v&&v[Wi]?_.createNew(null,v[Wi]):_.createNew(null,v)}return C},g._baseTelInit=function(C,_,E,T){C&&setValue$1(C,qi,[],null,isNullOrUndefined$1),!T&&_&&(T=_.getProcessTelContext().getNext());var I=v;v&&v[Wi]&&(I=v[Wi]()),g.core=_,S=new ji(T,C,_,I),m=!0}}return BaseTelemetryPlugin.prototype.initialize=function(g,m,S,v){this._baseTelInit(g,m,S,v)},BaseTelemetryPlugin}(),Ki=4294967296,Ji=4294967295,Yi=!1,Qi=123456789,Xi=987654321;function _mwcSeed$1(g){g<0&&(g>>>=0),Qi=123456789+g&Ji,Xi=987654321-g&Ji,Yi=!0}function _autoSeedMwc$1(){try{var g=2147483647&dateNow$1();_mwcSeed$1((Math.random()*Ki^g)+g)}catch(g){}}function randomValue$1(g){return g>0?Math.floor(random32$1()/Ji*(g+1))>>>0:0}function random32$1(g){var m,S=getCrypto$1()||getMsCrypto$1();return S&&S.getRandomValues?m=S.getRandomValues(new Uint32Array(1))[0]&Ji:isIE$1()?(Yi||_autoSeedMwc$1(),m=mwcRandom32$1()&Ji):m=Math.floor(Ki*Math.random()|0),g||(m>>>=0),m}function mwcRandom32$1(g){var m=((Xi=36969*(65535&Xi)+(Xi>>16)&Ji)<<16)+(65535&(Qi=18e3*(65535&Qi)+(Qi>>16)&Ji))>>>0&Ji|0;return g||(m>>>=0),m}function newGuid$1(){function randomHexDigit(){return randomValue$1(15)}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(en,(function(g){var m=0|randomHexDigit();return("x"===g?m:3&m|8).toString(16)}))}function perfNow$1(){var g=getPerformance$1();return g&&g.now?g.now():dateNow$1()}var Zi,en=/[xy]/g,tn={Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9},nn={Normal:1,Critical:2};vi(vi({},Ci),{AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}),(Zi={})[0]=tn.Unspecified,Zi[2]=tn.Double,Zi[1]=tn.String,Zi[3]=tn.Bool,Zi[4098]=tn.Double,Zi[4097]=tn.String,Zi[4099]=tn.Bool,Boolean(getDocument$1()),Boolean(getWindow$1());function getTenantId$1(g){if(g){var m=g.indexOf("-");if(m>-1)return g.substring(0,m)}return""}var rn=perfNow$1;function setProcessTelemetryTimings$1(g,m){var S=g;S.timings=S.timings||{},S.timings.processTelemetryStart=S.timings.processTelemetryStart||{},S.timings.processTelemetryStart[m]=rn()}var sn=isFunction$1;function _createPromiseAllOnResolvedFunction(g,m,S){return function(v){g[m]=v,S()}}var an=function(){function ESPromise(g){var m=0,S=null,v=[];function _enqueue(g,C,_,E){v.push((function(){var v;try{(v=1===m?sn(g)?g(S):S:sn(C)?C(S):S)instanceof ESPromise?v.then(_,E):2!==m||sn(C)?_(v):E(v)}catch(g){return void E(g)}})),0!==m&&_processQueue()}function _processQueue(){if(v.length>0){var g=v.slice();v=[],setTimeout((function(){for(var m=0,S=g.length;m<S;++m)try{g[m]()}catch(g){}}),0)}}function _resolve(g){0===m&&(S=g,m=1,_processQueue())}function _reject(g){0===m&&(S=g,m=2,_processQueue())}dynamicProto(ESPromise,this,(function(g){g.then=function(g,m){return new ESPromise((function(S,v){_enqueue(g,m,S,v)}))},g.catch=function(m){return g.then(null,m)}})),function _initialize(){if(!sn(g))throw new TypeError("ESPromise: resolvedFunc argument is not a Function");try{g(_resolve,_reject)}catch(g){_reject(g)}}()}return ESPromise.resolve=function(g){return g instanceof ESPromise?g:g&&sn(g.then)?new ESPromise((function(m,S){try{g.then(m,S)}catch(g){S(g)}})):new ESPromise((function(m){m(g)}))},ESPromise.reject=function(g){return new ESPromise((function(m,S){S(g)}))},ESPromise.all=function(g){if(g&&g.length)return new ESPromise((function(m,S){try{for(var v=[],C=0,_=0;_<g.length;_++){var E=g[_];E&&sn(E.then)?(C++,E.then(_createPromiseAllOnResolvedFunction(v,_,(function(){0==--C&&m(v)})),S)):v[_]=E}0===C&&setTimeout((function(){m(v)}),0)}catch(g){S(g)}}))},ESPromise.race=function(g){return new ESPromise((function(m,S){if(g&&g.length)try{for(var _loop_1=function(v){var C=g[v];C&&sn(C.then)?C.then(m,S):setTimeout((function(){m(C)}),0)},v=0;v<g.length;v++)_loop_1(v)}catch(g){S(g)}}))},ESPromise}(),on=6e5,ln=0,cn=[],dn=[],hn=[];function _getTime(){return(new Date).getTime()}var un,gn=function(){function ESPromiseScheduler(g,m){var S=0,v=(g||"<unnamed>")+"."+ln;function _debugLog(g){var m=getGlobal$1();m&&m.QUnit&&console&&console.log("ESPromiseScheduler["+v+"] "+g)}function _warnLog(g){m&&m.warnToConsole("ESPromiseScheduler["+v+"] "+g)}ln++,dynamicProto(ESPromiseScheduler,this,(function(g){var m=null,C=0;function _removeQueuedEvent(g,m){for(var S=0;S<g.length;S++)if(g[S].id===m)return g.splice(S,1)[0];return null}g.scheduleEvent=function(g,_,E){var T=v+"."+C;C++,_&&(T+="-("+_+")");var I=T+"{"+S+"}";S++;var b={evt:null,tm:_getTime(),id:I,isRunning:!1,isAborted:!1};return b.evt=m?_waitForPreviousEvent(b,m):_startWaitingEvent(b),(m=b).evt._schId=I,b.evt;function _abortAndRemoveOldEvents(g){for(var m=_getTime(),S=m-on,v=g.length,C=0;C<v;){var _=g[C];if(_&&_.tm<S){var E=null;_.abort?(E="Aborting ["+_.id+"] due to Excessive runtime ("+(m-_.tm)+" ms)",_.abort(E)):E="Removing ["+_.id+"] due to Excessive runtime ("+(m-_.tm)+" ms)",_warnLog(E),g.splice(C,1),v--}else C++}}function _cleanup(g,S){var v=!1,C=_removeQueuedEvent(cn,g);if(C||(C=_removeQueuedEvent(hn,g),v=!0),C){C.to&&(clearTimeout(C.to),C.to=null);var _=_getTime()-C.tm;S?v?_warnLog("Timed out event ["+g+"] finally complete -- "+_+" ms"):_debugLog("Promise ["+g+"] Complete -- "+_+" ms"):(hn.push(C),_warnLog("Event ["+g+"] Timed out and removed -- "+_+" ms"))}else _debugLog("Failed to remove ["+g+"] from running queue");m&&m.id===g&&(m=null),_abortAndRemoveOldEvents(cn),_abortAndRemoveOldEvents(dn),_abortAndRemoveOldEvents(hn)}function _removeScheduledEvent(g,m){return function(S){return _cleanup(g,!0),m&&m(S),S}}function _waitForFinalResult(g,m,S,v){m.then((function(m){return m instanceof an?(_debugLog("Event ["+g+"] returned a promise -- waiting"),_waitForFinalResult(g,m,S,v),m):_removeScheduledEvent(g,S)(m)}),_removeScheduledEvent(g,v))}function _createScheduledEvent(g,m){var S=g.id;return new an((function(v,C){_debugLog("Event ["+S+"] Starting -- waited for "+(g.wTm||"--")+" ms"),g.isRunning=!0,g.abort=function(m){g.abort=null,g.isAborted=!0,_cleanup(S,!1),C(new Error(m))};var _=m(S);_ instanceof an?(E&&(g.to=setTimeout((function(){_cleanup(S,!1),C(new Error("Timed out after ["+E+"] ms"))}),E)),_waitForFinalResult(S,_,(function(m){_debugLog("Event ["+S+"] Resolving after "+(_getTime()-g.tm)+" ms"),v(m)}),C)):(_debugLog("Promise ["+S+"] Auto completed as the start action did not return a promise"),v())}))}function _startWaitingEvent(m){var S=_getTime();return m.wTm=S-m.tm,m.tm=S,m.isAborted?an.reject(new Error("["+T+"] was aborted")):(cn.push(m),_createScheduledEvent(m,g))}function _waitForPreviousEvent(g,m){var S=new an((function(S,v){var C=_getTime()-m.tm,_=m.id;_debugLog("["+T+"] is waiting for ["+_+":"+C+" ms] to complete before starting -- ["+dn.length+"] waiting and ["+cn.length+"] running"),g.abort=function(m){g.abort=null,_removeQueuedEvent(dn,T),g.isAborted=!0,v(new Error(m))},m.evt.then((function(m){_removeQueuedEvent(dn,T),_startWaitingEvent(g).then(S,v)}),(function(m){_removeQueuedEvent(dn,T),_startWaitingEvent(g).then(S,v)}))}));return dn.push(g),S}}}))}return ESPromiseScheduler.incomplete=function(){return cn},ESPromiseScheduler.waitingToStart=function(){return dn},ESPromiseScheduler}();function isValidPersistenceLevel(g){return isNumber$1(g)&&g>=nn.Normal&&g<=nn.Critical}!function(g){g[g.LocalStorage=1]="LocalStorage",g[g.SessionStorage=2]="SessionStorage",g[g.IndexedDb=3]="IndexedDb"}(un||(un={}));var pn=10,mn="3",fn="Version",Sn=6e5,vn="AWTEvents",Cn=5e6,_n=1,yn=2;function _isQuotaExceeded(g,m){var S=!1;return m instanceof DOMException&&(22!==m.code&&"QuotaExceededError"!==m.name&&1014!==m.code&&"NS_ERROR_DOM_QUOTA_REACHED"!==m.name||g&&0!==g.length&&(S=!0)),S}function _getAvailableStorage(g){var m=getGlobal$1()||{},S=null;try{if(S=m[g]){var v="__storage_test__";S.setItem(v,v),S.removeItem(v)}}catch(g){_isQuotaExceeded(S,g)||(S=null)}return S}function _forEachMap(g,m){if(g)for(var S=objKeys$1(g),v=0;v<S.length;v++){var C=S[v];if(!m(g[C],C))break}}function _isMapEmpty(g){var m=!0;return _forEachMap(g,(function(g,S){return g&&(m=!1),m})),m}function _dropEventsUpToPersistence(g,m){for(var S=_n,v=0,_loop_1=function(){var g=[],C=m[S];if(_forEachMap(C,(function(m,S){return g.push(S),++v<pn})),v>0){for(var _=0;_<g.length;_++)delete C[g[_]];return{value:!0}}S++};S<=g&&v<pn;){var C=_loop_1();if("object"==typeof C)return C.value}return v>0}var En=isValidPersistenceLevel,Tn=function(){function WebStorageProvider(g,m){dynamicProto(WebStorageProvider,this,(function(S){var v=null,C=vn,_=null,E=mn,T=null,I=null,b=Cn,A=null,R=null;function _newStore(g,m){return{key:g,db:m}}function _fetchStoredDb(g,m){void 0===m&&(m=!0);var S=null;if(v){var C=v.getItem(g);if(C)try{S=JSON.parse(C)}catch(m){v.removeItem(g)}}return m&&!S&&(S={events:{1:{},2:{},3:{}},lastAccessTime:0}),_newStore(g,S)}function _updateStoredDb(g,m){void 0===m&&(m=!0);var S=!0,C=g.db;if(C){m&&(C.lastAccessTime=(new Date).getTime());for(var _=_n;_<=yn;_++)if(!_isMapEmpty(C.events[_])){S=!1;break}}try{if(S)v&&v.removeItem(g.key);else{var E=JSON.stringify(C);if(E.length>b)return!1;v&&v.setItem(g.key,E)}}catch(g){return!1}return!0}function _clearDatabase(g){var m=[],S=_fetchStoredDb(g,!1),C=S.db;if(C){var _=C.events;try{for(var E=_n;E<=yn;E++)_forEachMap(_[E],(function(g,S){return g&&m.push(g),!0}))}catch(g){}v&&v.removeItem(S.key)}return m}function _checkVersionAndMoveEventsToCurrentStorage(){if(v){for(var g=v.getItem(A),m=[],S=_fetchStoredDb(R),_=!1,T=0;T<v.length;T++){var b=v.key(T);if(0===b.indexOf(C)&&b!==A){if(g!==mn){m.push(_newStore(b,null));continue}var P=_fetchStoredDb(b,!1),M=P.db;if(M){if((new Date).getTime()-M.lastAccessTime>Sn){for(var w=_n,_loop_3=function(){var g=M.events[w],m=S.db.events[w];_forEachMap(g,(function(S,v){return(getTenantId$1(S.iKey)||S.iKey)===I&&(m[v]=S,delete g[v]),!0})),w++};w<=yn;)_loop_3();_=!0,m.push(P)}}else m.push(_newStore(b,null))}}for(T=0;T<m.length;T++)_updateStoredDb(m[T],!1);_&&_updateStoredDb(S),v.setItem(A,E)}}S.id=m,v=_getAvailableStorage(g)||null,S.initialize=function(g){if(!v)return!1;var m=g.storageConfig||{};return b=m.maxStorageSizeInBytes>0?m.maxStorageSizeInBytes:b,C=m.storageKey||vn,_=S.id||g.id||newGuid$1(),R=C+"."+_,A=C+fn,T=g.itemCtx.getCfg().instrumentationKey,I=getTenantId$1(T)||T,_checkVersionAndMoveEventsToCurrentStorage(),!0},S.supportsSyncRequests=function(){return!0},S.getAllEvents=function(){try{var g=[],m=_fetchStoredDb(R,!1).db;if(m)for(var S=m.events,v=yn;v>=_n;v--)_forEachMap(S[v],(function(m){m&&((getTenantId$1(m.iKey)||m.iKey)===I&&g.push(m));return!0}));return an.resolve(g)}catch(g){return an.reject(g)}},S.addEvent=function(g,m,S){try{var v=_fetchStoredDb(R);m.id=m.id||newGuid$1(),En(m.persistence)||(m.persistence=_n);for(var C=m.persistence,_=m.id,E=v.db.events;;){if(E[C][_]=m,_updateStoredDb(v))return an.resolve(m);if(delete E[C][_],!_dropEventsUpToPersistence(C,E))return an.reject(new Error("Unable to free up event space"))}}catch(g){return an.reject(g)}},S.removeEvents=function(g){try{var m=_fetchStoredDb(R,!1),S=m.db;if(S){var v=S.events;try{for(var C=0;C<g.length;++C){var _=g[C];delete v[_.persistence][_.id]}if(_updateStoredDb(m))return an.resolve(g)}catch(g){}g=_clearDatabase(m.key)}return an.resolve(g)}catch(g){return an.reject(g)}},S.clear=function(){try{var g=[],m=_fetchStoredDb(R,!1),S=m.db;if(S){for(var v=S.events,_loop_2=function(m){var S=v[m];_forEachMap(S,(function(m){m&&((getTenantId$1(m.iKey)||m.iKey)===I&&(delete S[m.id],g.push(m)));return!0}))},C=yn;C>=_n;C--)_loop_2(C);_updateStoredDb(m)}return an.resolve(g)}catch(g){return an.reject(g)}},S.teardown=function(){try{var g=_fetchStoredDb(R,!1),m=g.db;m&&(m.lastAccessTime=0,_updateStoredDb(g,!1))}catch(g){}}}))}return WebStorageProvider}(),In="readwrite",bn="result",An="DBError: Unable to open database",Rn="Database is not open",Pn="DBError: Failed to Open Cursor",Mn="DBError: Failed to delete the database",wn="DBError: Database does not exist",Dn="DBError: Database upgrade required",On="DBError: Feature not supported",Nn=["indexedDB"],kn=isFunction$1,Ln=isString$1;function _getDbFactory(){var g=getGlobal$1()||{},m=null;if(g)try{for(var S=0;S<Nn.length;S++)if((m=g[Nn[S]])&&kn(m.open))return m}catch(g){m=null}return m||null}function _debugLog(g,m){getGlobalInst$1("QUnit")&&console&&console.log("IndexedDbHelper ["+g+"] "+m)}function _warnLog(g,m,S){g&&g.warnToConsole("IndexedDbHelper ["+m+"] "+S)}function _eventReject(g,m,S,v){return function(C){S(new Error(m)),_debugLog(g,"["+v+"] event rejected")}}var Fn=[];function _getDbContext(g,m){for(var S=null,v=0;v<Fn.length;v++)if((S=Fn[v]).name===g)return S;return S={name:g,sch:new gn("IndexedDbHelper["+g+"]",m),dbHdl:[],add:function(m){S.dbHdl.push(m),_debugLog(g,"- dbOpened (add) -- hdls ["+S.dbHdl.length+"]")},remove:function(m){for(var v=S.dbHdl,C=0;C<v.length;C++)if(v[C]===m){v.splice(C,1);break}_debugLog(g,"- dbClosed (remove) -- hdls ["+S.dbHdl.length+"]")},isOpen:function(){return S.dbHdl.length>0},openHdl:function(){return S.dbHdl.length>0?S.dbHdl[0]:null}},Fn.push(S),S}var xn=function(){function IndexedDbHelper(g){dynamicProto(IndexedDbHelper,this,(function(m){var S=_getDbFactory()||null;function _createStoreContext(m,S){var v=m.db.transaction(S,In);return v.onabort=function(){_warnLog(g,m.dbName,"txn.onabort")},v.onerror=function(){_warnLog(g,m.dbName,"txn.onerror")},v.oncomplete=function(){_debugLog(m.dbName,"txn.oncomplete")},{db:m,store:v.objectStore(S),tx:v,tbl:S,openCursor:function(g,v){return _openCursor(m,S,g,v)},newTransaction:function(g){return _openStore(m,S,g)}}}function _openStore(g,m,S){if(!g||!g.db)return an.reject(new Error(Rn));try{var v=S(_createStoreContext(g,m));return v instanceof an?v:an.resolve(v)}catch(g){return an.reject(g)}}function _openCursor(g,m,S,v){if(!g||!g.db)return an.reject(new Error(Rn));var C=null;return S&&Ln(S)?C=new Un(S):S&&S.isMatch&&(C=S),new an((function(S,_){var E=[],T=null,I=null;C&&C.keyRange&&(I=C.keyRange());var b=_createStoreContext(g,m);(T=I?b.store.openCursor(I):b.store.openCursor()).onerror=_eventReject(b.db.dbName,Pn,_,"openCursor"),T.onsuccess=function(g){var m=g.target[bn];if(m){var T={store:b,cursor:m,continue:function(){m.continue()},done:function(){S(E)}},I=m.value;if(!C||C.isMatch(I))if(v)try{switch(v(T,I,E)){case 2:S(E);break;case 1:break;default:T.continue()}}catch(g){_(g)}else E.push(I),T.continue();else T.continue()}else S(E)}}))}function _scheduleEvent(g,m,S,v){return _getDbContext(g).sch.scheduleEvent(S,m,v)}m.isAvailable=function(){return!!S},m.openDb=function(m,v,C,_){return _scheduleEvent(m,"openDb",(function(E){return new an((function(T,I){var b=!1;function _createDbCtx(g,S,C,_,E){var T={db:S,dbName:m,dbVersion:v,ctx:null,isNew:_,txn:C?C.transaction:null};return E||(T.openStore=function(g,m){return _openStore(T,g,m)},T.openCursor=function(g,m,S){return _openCursor(T,g,m,S)}),T}function _databaseUpgrade(g,m){var S=_createDbCtx(null,g,m,!0,!0);if(_)b=!0,_(S).then((function(){S.txn||(S.txn=m.transaction)}),(function(g){try{m.transaction&&m.transaction.abort()}finally{I(g)}}));else try{m.transaction&&m.transaction.abort()}finally{I(new Error(Dn))}}function _databaseOpen(S,v){var _=_getDbContext(m);_.add(S),S.onabort=function(v){_warnLog(g,m,"onabort -- closing the Db"),_.remove(S)},S.onerror=function(v){_warnLog(g,m,"onerror -- closing the Db"),_.remove(S)},S.onclose=function(v){_warnLog(g,m,"onclose -- closing the Db"),_.remove(S)},S.onversionchange=function(v){_warnLog(g,m,"onversionchange -- force closing the Db"),S.close(),_.remove(S)};var E=null,A=null;_.dbHdl.length>0&&(A=_.dbHdl[0]),E=_createDbCtx(_,A,v,b);try{C(E).then((function(g){T(g)}),I)}catch(g){I(g)}}var A=_getDbContext(m);if(null==S)I(new Error("No available storage factory"));else if(A.isOpen()){var R=_createDbCtx(A,A.openHdl(),null,!1);C(R).then(T,I)}else{var P=S.open(m,v);P.onblocked=function(S){_warnLog(g,m,"Db Open Blocked event ["+E+"] - "+(P.error||"")),I(new Error(An))},P.onerror=function(S){_warnLog(g,m,"Db Open Error event ["+E+"] - "+(P.error||"")),I(new Error(An))},P.onupgradeneeded=function(g){_debugLog(m,"Db Open Create/Upgrade needed event ["+E+"]");try{var S=g.target[bn];if(!S)return void I(new Error(An));_databaseUpgrade(S,P)}catch(g){_eventReject(m,An,I,E)(g)}},P.onsuccess=function(g){var m=g.target[bn];m?_databaseOpen(m,P):I(new Error(An))}}}))}))},m.closeDb=function(g){_scheduleEvent(g,"closeDb",(function(m){var S=_getDbContext(g),v=S.dbHdl,C=v.length;if(C>0){for(var _=0;_<C;_++)v[_].close();S.dbHdl=[]}return an.resolve(1)}))},m.deleteDb=function(m){return null==S?an.resolve(!1):_scheduleEvent(m,"deleteDb",(function(v){var C=_getDbContext(m),_=C.dbHdl,E=_.length;if(E>0){_warnLog(g,m,"Db is open ["+E+"] force closing");for(var T=0;T<E;T++)_[T].close();C.dbHdl=[]}return new an((function(C,_){setTimeout((function(){try{_debugLog(m,"["+v+"] starting");var E=S.deleteDatabase(m);E.onerror=function(S){_warnLog(g,m,"["+v+"] error!!"),_(new Error(Mn))},E.onblocked=function(S){_warnLog(g,m,"["+v+"] blocked!!"),_(new Error(Mn))},E.onupgradeneeded=function(S){_warnLog(g,m,"["+v+"] upgrade needed!!"),_(new Error(Mn))},E.onsuccess=function(g){_debugLog(m,"["+v+"] complete"),C(!0)},_debugLog(m,"["+v+"] started")}catch(S){_warnLog(g,m,"["+v+"] threw - "+S),_(new Error(Mn+" - "+S))}}),0)}))}))},m.getDbDetails=function(g){return _scheduleEvent(g,"getDbDetails",(function(m){return null!=S&&S.databases?new an((function(m,v){S.databases().then((function(S){for(var C=0;C<S.length;C++)if(S[C].name===g)return void m(S[C]);v(new Error(wn))}),v)})):an.reject(new Error(On))}),2e3)}}))}return IndexedDbHelper}(),Un=function(){function SimpleQuery(g){var m=[],S=null;dynamicProto(SimpleQuery,this,(function(v){v.keyRange=function(){return S},v.parseQuery=function(g){if(m=[],g)for(var C=g.split(";"),_=0;_<C.length;_++){var E=C[_],T=E.indexOf("=");if(-1!==T){var I=E.substring(0,T),b=E.substring(T+1);0===I.indexOf("#")&&(I=I.substring(1),S||(S=IDBKeyRange.bound(b,b+"￿"))),v.startsWith(I,b)}}},v.startsWith=function(g,S){m.push({name:g,value:S,type:0})},v.contains=function(g,S){m.push({name:g,value:S,type:1})},v.isMatch=function(g){if(!m||0===m.length)return!0;if(!g)return!1;for(var S=0;S<m.length;S++){var v=m[S],C=g[v.name];if(C)if(0===v.type){if(0!==C.indexOf(v.value))return!1}else if(1===v.type&&-1===C.indexOf(v.value))return!1}return!0},g&&v.parseQuery(g)}))}return SimpleQuery}(),Vn=10,Bn=1,Hn=6e5,$n=1008e4,Gn="Unknown",jn=-1,qn="DBError: Unable to add event",Wn="DBError: Unable to update iKey",zn="AppInsightEvents.1",Kn=1,Jn="Evts",Yn="iKey",Qn=isValidPersistenceLevel;function _getTime$1(){return(new Date).getTime()}function _eventReject$1(g,m){return function(S){return m(new Error(g))}}function _createDb(g){g.objectStoreNames.contains(Jn)||g.createObjectStore(Jn,{keyPath:"key"}).createIndex("EvntId","key",{unique:!1});g.objectStoreNames.contains(Yn)||g.createObjectStore(Yn,{keyPath:"iKey"}).createIndex("iKey","iKey",{unique:!0})}function _updateiKey(g){return g.openStore(Yn,(function(m){return new an((function(S,v){var C={iKey:g.ctx.iKey,tm:_getTime$1()},_=m.store.put(C);_.onsuccess=function(g){S(_.result.toString())},_.onerror=function(g){v(new Error(qn))},_.onerror=_eventReject$1(Wn,v)}))}))}function _orderEventsByPriority(g){for(var m=[],S=nn.Critical;S>=nn.Normal;S--)for(var v=0;v<g.length;v++){var C=g[v];C&&C.evt.persistence===S&&m.push(C.evt)}return m}function _addEventByTime(g,m){for(var S=0;S<g.length;S++)if(m.tm<g[S].tm)return void g.splice(S,0,m);g.push(m)}function _getKeyIndex(g,m){for(var S=m.length,v=0;v<S;v++)if(g===m[v].id)return v;return-1}function _isOldItem(g,m){var S=g.tm;return _getTime$1()-S>m}function _cursorContinueEvent(g){return function(m){return g.continue()}}function _cursorDeleteAndContinue(g){var m=g.cursor.delete();return m.onerror=_cursorContinueEvent(g),m.onsuccess=_cursorContinueEvent(g),1}function _getAllEventsForiKey(g,m){return g.openCursor(Jn,m,(function(g,m,S){return S.push(m),0}))}function _deleteEvents(g,m,S){return g.openCursor(Jn,m,(function(g,m,v){return S(m)?(v.push(m),_cursorDeleteAndContinue(g)):0}))}function _deleteOrphanedEvents(g){return new an((function(m,S){var v=!1;g.openCursor(Yn,null,(function(g,m,S){var C=m.tm;return _getTime$1()-C<$n?0:(v=!0,2)})).then((function(){if(v){var C={};_deleteEvents(g,null,(function(g){if(!g||!g.evt||!g.evt.iKey)return!0;var m=g.tm;return _getTime$1()-m>$n||(C[g.evt.iKey]=1,!1)})).then((function(){var v=[];g.openCursor(Yn,null,(function(g,m,S){var _=m.tm;return _getTime$1()-_<$n||C[m.iKey]?0:(v.push(m),_cursorDeleteAndContinue(g))})).then((function(){m(v)}),S)}),S)}else m([])}),S)}))}function _moveOldEventsToCurrentStore(g){return g.openCursor(Jn,"#key="+g.ctx.iKeyPrefix(),(function(m,S){var v=S.key;if(0===v.indexOf(g.ctx.iKeyPrefix())&&-1===v.indexOf(g.ctx.evtKeyPrefix())&&_isOldItem(S,Hn)){S.key=g.ctx.evtKeyPrefix()+S.id;var C=m.store.store.put(S);return C.onerror=_cursorContinueEvent(m),C.onsuccess=function(g){try{_cursorDeleteAndContinue(m)}catch(g){m.continue()}},1}return 0}))}function _checkVersionAndMoveEventsToCurrentStorage(g){return new an((function(m,S){_deleteOrphanedEvents(g).then((function(){_moveOldEventsToCurrentStore(g).then(m,m)}),S)}))}function _dropEventsUpToPersistence$1(g,m){return new an((function(S,v){var C=0,_=g.ctx.evtKeyPrefix();function _resolveWithDroppedEvents(){S(C)}function _dropEvent(g,m){return new an((function(S){var v=g.store.delete(m.key);v.onsuccess=function(g){C++,S()},v.onerror=function(g){S()}}))}function _processCandidates(m){0!==m.length?g.openStore(Jn,(function(g){for(var S=[],v=0;v<m.length;v++)S.push(_dropEvent(g,m[v]));return an.all(S).then(_resolveWithDroppedEvents,_resolveWithDroppedEvents)})):_resolveWithDroppedEvents()}g.openCursor(Jn,"#key="+_,(function(g,S,v){return S.evt.persistence<=m&&0===S.key.indexOf(_)&&(_addEventByTime(v,S),v.length>Vn&&v.splice(v.length-1,1)),0})).then(_processCandidates,(function(){S(0)}))}))}var Xn=function(){function IndexedDbProvider(g){dynamicProto(IndexedDbProvider,this,(function(m){var S=null,v=null,C=Gn,_=null,E=null,T=null,I=jn,b=0;function _openDb(g){function _handleDbUpgrade(g){return new an((function(m,S){_createDb(g.db),m()}))}function _handleDbOpen(m){return new an((function(S,v){var I={iKey:C,storageId:_,iKeyPrefix:function(){return E},evtKeyPrefix:function(){return T}};m.ctx=I,_updateiKey(m).then((function(){g(m).then(S,v)}),v)}))}return S.openDb(v,Kn,_handleDbOpen,_handleDbUpgrade)}function _addDbEvent(g,m,S){return new an((function(v,C){function dropEvents(m,S){_dropEventsUpToPersistence$1(g,m).then((function(g){g>0&&(b-=g),S(g)}),(function(g){S(0)}))}function resolveAddEvent(g){v(m.evt)}function _insertNewEvent(){g.openStore(Jn,(function(_){var E=_.store.put(m);E.onsuccess=function(C){S&&_updateiKey(g).then(resolveAddEvent,resolveAddEvent),b++,v(m.evt)},E.onerror=function(_){function _retryAddEvent(S){0===S&&C(new Error(qn)),_addDbEvent(g,m,!1).then((function(g){v(m.evt)}),(function(){C(new Error(qn))}))}S?dropEvents(nn.Normal,(function(g){g>0?_retryAddEvent(g):m.evt.persistence>=nn.Critical?dropEvents(nn.Critical,(function(g){_retryAddEvent(g)})):C(new Error(qn))})):C(new Error(qn))}}))}I>0&&b>=I?dropEvents(nn.Normal,(function(g){0===g?m.evt.persistence>=nn.Critical?dropEvents(nn.Critical,(function(g){_insertNewEvent()})):C(new Error(qn)):_insertNewEvent()})):_insertNewEvent()}))}m.id=g,m.initialize=function(g){var b=g.itemCtx.diagLog();if(!(S=new xn(b)).isAvailable())return S=null,!1;var A=g.itemCtx.getCfg(),R=g.storageConfig||{};return v=R.indexedDbName||zn,C=A.instrumentationKey||C,_=m.id||g.id||newGuid$1(),T=(E=C+"::")+_+"::",I=R.maxStorageItems>0?R.maxStorageItems:I,_openDb((function(g){return g.isNew?an.resolve(!0):_checkVersionAndMoveEventsToCurrentStorage(g)})).then((function(g){}),(function(g){b.warnToConsole("IndexedDbProvider failed to initialize - "+(g||"<unknown>")),S=null})),!0},m.supportsSyncRequests=function(){return!1},m.getAllEvents=function(){return null!=S&&S.isAvailable()?_openDb((function(g){return new an((function(m,S){_getAllEventsForiKey(g,"#key="+g.ctx.evtKeyPrefix()).then((function(g){b=g.length,m(_orderEventsByPriority(g))}),S)}))})):an.resolve([])},m.addEvent=function(g,m,v){return null!=S&&S.isAvailable()?(m.id=m.id||newGuid$1(),Qn(m.persistence)||(m.persistence=nn.Normal),_openDb((function(S){var v=g||m.id,C={key:S.ctx.evtKeyPrefix()+v,id:v,evt:m,tm:_getTime$1(),v:Bn};return _addDbEvent(S,C,!0)}))):an.resolve(m)},m.removeEvents=function(g){if(null==S||!S.isAvailable())return an.resolve([]);var m=[];return new an((function(S,v){_openDb((function(S){return S.openCursor(Jn,"#key="+S.ctx.iKey,(function(S,v,C){if(-1!==_getKeyIndex(v.id,g)){var _=S.cursor.delete();return _.onerror=_cursorContinueEvent(S),_.onsuccess=function(){m.push(v.evt),S.continue()},1}return 0}))})).then((function(g){b-=m.length,S(m)}),(function(g){b-=m.length,S(m)}))}))},m.clear=function(){return null!=S&&S.isAvailable()?new an((function(g,m){_openDb((function(g){return _deleteEvents(g,"#key="+g.ctx.evtKeyPrefix(),(function(m){return 0===m.key.indexOf(g.ctx.evtKeyPrefix())}))})).then((function(m){b=0,g(_orderEventsByPriority(m))}),m)})):an.resolve([])},m.teardown=function(){S&&S.closeDb(v)}}))}return IndexedDbProvider}(),Zn="3.1.3",er="LocalStorage",tr=5,ir=isValidPersistenceLevel,nr=function(g){function LocalStorageChannel(){var m=g.call(this)||this;return m.identifier=er,m.priority=1009,m.version=Zn,dynamicProto(LocalStorageChannel,m,(function(g,m){var S=!1,v=!1,C=null,_=[];function _queueStorageEvent(g,m){C||(C=new gn("LocalStorage")),C.scheduleEvent((function(g){return m(g)}),g)}function _sendStoredEventsToNextPlugin(m){doPerf$1(g.core,(function(){return"LocalStorageChannel:_sendStoredEventsToNextPlugin"}),(function(){_queueStorageEvent("sendToNext",(function(S){return m.provider.getAllEvents().then((function(S){for(var v=0;v<S.length;v++)try{var C=S[v];(getTenantId$1(C.iKey)||C.iKey)===m.tenantId&&g.processNext(C,m.coreRootCtx.createNew())}catch(g){}}))}))}),(function(){return{iKeyConfig:m}}))}function _removeEvents(m,S){doPerf$1(g.core,(function(){return"LocalStorageChannel:_removeEvents"}),(function(){_queueStorageEvent("removeEvents",(function(g){var v=[];return arrForEach$1(S,(function(g){(getTenantId$1(g.iKey)||g.iKey)===m.tenantId&&v.push(g)})),v.length>0?m.provider.removeEvents(v).then((function(g){})).catch((function(g){})):an.resolve()}))}),(function(){return{iKeyConfig:m,events:S}}))}function _shouldCacheEvent(g,m){return!(m.sync||m.persistence<g.minPersistenceCacheLevel)}function _tryGetIndexedDbProvider(g){var m=new Xn;return m.initialize(g)||(m=null),m}function _tryGetWebStorageProvider(g,m){var S=new Tn(g);return S.initialize(m)||(S=null),S}function _initializeProvider(g){for(var m=g.storageConfig.providers,S=null,v=0;!S&&v<m.length&&v<tr;)switch(m[v++]){case un.LocalStorage:S=_tryGetWebStorageProvider("localStorage",g);break;case un.SessionStorage:S=_tryGetWebStorageProvider("sessionStorage",g);break;case un.IndexedDb:S=_tryGetIndexedDbProvider(g)}return S}function _getCoreItemCtx(m,S,v,C){m&&(m.extensionConfig=m.extensionConfig||[]),!C&&S&&(C=S.getProcessTelContext().getNext());var _=null,E=g._getTelCtx().getNext();return E&&(_=E.getPlugin()),new ji(C,m,S,_)}function _createIkeyConfig(m,S,v,C){var E=g.identifier,T=m.extensionConfig=m.extensionConfig||[],I=T[E]=T[E]||{};I.providers||(I.providers=[un.LocalStorage,un.IndexedDb]);var b=_getCoreItemCtx(m,S,v,C),A={itemCtx:b,storageConfig:I,id:g.id},R=_initializeProvider(A);if(R){var P={iKey:m.instrumentationKey,tenantId:getTenantId$1(m.instrumentationKey)||m.instrumentationKey,minPersistenceCacheLevel:nn.Normal,coreRootCtx:b,providerContext:A,provider:R};ir(I.minPersistenceLevel||-1)&&(P.minPersistenceCacheLevel=I.minPersistenceLevel),_.push(P),S.addNotificationListener({eventsSent:function(g){_removeEvents(P,g)},eventsDiscarded:function(g,m){_removeEvents(P,g)}}),_sendStoredEventsToNextPlugin(P)}}g.initialize=function(g,v,_,E){doPerf$1(v,(function(){return"LocalStorageChannel.initialize"}),(function(){S||(m.initialize(g,v,_),m.setInitialized(!1),S=!0,C=new gn("LocalStorage",v.logger)),_createIkeyConfig(g,v,_,E)}),(function(){return{coreConfig:g,core:v,extensions:_,pluginChain:E}}))},g.processTelemetry=function(m,S){S=g._getTelCtx(S),setProcessTelemetryTimings$1(m,g.identifier);var C=null;arrForEach$1(_,(function(g){g.iKey===m.iKey&&(C=g)}));var E=v,T=C?C.provider:null,I=m;!I.sync&&T?(I.id=I.id||newGuid$1(),isValidPersistenceLevel(I.persistence)||(I.persistence=1),_shouldCacheEvent(C,I)&&_queueStorageEvent("processTelemetry",(function(g){return T.addEvent(I.id,I,S)})),E||g.processNext(I,S)):g.processNext(I,S)},g.pause=function(){v=!0},g.resume=function(){doPerf$1(g.core,(function(){return"LocalStorageChannel:resume"}),(function(){v=!1,arrForEach$1(_,(function(g){g.provider&&_sendStoredEventsToNextPlugin(g)}))}))},g.teardown=function(){arrForEach$1(_,(function(g){var m=g.provider;m&&m.teardown()})),_=[]},g.flush=function(g,m){}})),m}return __extendsFn$1(LocalStorageChannel,g),LocalStorageChannel}(zi),rr="function",sr="object",ar="undefined",or="prototype",lr="hasOwnProperty",cr=Object,dr=cr.create,hr=null;function getGlobal$2(g){void 0===g&&(g=!0);var m=!1===g?null:hr;return m||(typeof globalThis!==ar&&(m=globalThis),m||typeof self===ar||(m=self),m||typeof window===ar||(m=window),m||typeof global===ar||(m=global),hr=m),m}function throwTypeError$2(g){throw new TypeError(g)}function objCreateFn$2(g){if(dr)return dr(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==sr&&m!==rr&&throwTypeError$2("Object prototype may only be an Object:"+g),tmpFunc[or]=g,new tmpFunc}(getGlobal$2()||{}).Symbol,(getGlobal$2()||{}).Reflect;var extendStaticsFn$2=function(g,m){return extendStaticsFn$2=cr.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m[lr](S)&&(g[S]=m[S])},extendStaticsFn$2(g,m)};function __extendsFn$2(g,m){function __(){this.constructor=g}typeof m!==rr&&null!==m&&throwTypeError$2("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn$2(g,m),g[or]=null===m?objCreateFn$2(m):(__[or]=m[or],new __)}var ur="REAL_TIME",gr="NEAR_REAL_TIME",pr="BEST_EFFORT",mr=function(){function EventBatch(g,m){var S=m?[].concat(m):[],v=this;v.iKey=function(){return g},v.count=function(){return S.length},v.events=function(){return S},v.addEvents=function(g,m){return void 0===m&&(m=!0),g&&g.length>0?(S=m?S.concat(g):g.concat(S),g.length):0},v.split=function(m,v){var C=new EventBatch(g);if(m<S.length){var _=S.length-m;isNullOrUndefined(v)||(_=v<_?v:_),C.addEvents(S.splice(m,_),!0)}return C}}return EventBatch.create=function(g,m){return new EventBatch(g,m)},EventBatch}(),fr=20,Sr=3984588,vr=65e3,Cr=2e6,_r=Math.min(Cr,vr),yr="metadata",Er="f",Tr=/\./,Ir=function(){function Serializer(g,m,S,v){var C="data",_="baseData",E="ext",T=!!v,I=!0,b=m,A={};dynamicProto(Serializer,this,(function(m){function _isReservedField(g,m){var S=A[g];return void 0===S&&(g.length>=7&&(S=strStartsWith(g,"ext.metadata")||strStartsWith(g,"ext.web")),A[g]=S),S}function _processPathKeys(g,m,v,C,_,E,I){objForEachKey(g,(function(g,A){var R=null;if(A||isValueAssigned(A)){var P=v,M=g,w=_,D=m;if(T&&!C&&Tr.test(g)){var O=g.split("."),N=O.length;if(N>1){w&&(w=w.slice());for(var k=0;k<N-1;k++){var L=O[k];D=D[L]=D[L]||{},P+="."+L,w&&w.push(L)}M=O[N-1]}}if(R=!(C&&_isReservedField(P))&&b&&b.handleField(P,M)?b.value(P,M,A,S):sanitizeProperty(M,A,S)){var F=R.value;if(D[M]=F,E&&E(w,M,R),I&&"object"==typeof F&&!isArray(F)){var x=w;x&&(x=x.slice()).push(M),_processPathKeys(A,F,P+"."+M,C,x,E,I)}}}}))}m.createPayload=function(g,m,S,v,C){return{apiKeys:[],payloadBlob:"",overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:g,isTeardown:m,isSync:S,isBeacon:v,sendReason:C}},m.appendPayload=function(S,v,C){var _=S&&v&&!S.overflow;return _&&doPerf(g,(function(){return"Serializer:appendPayload"}),(function(){for(var g=v.events(),_=S.payloadBlob,E=S.numEvents,T=!1,I=[],b=[],A=S.isBeacon,R=A?vr:Sr,P=A?_r:Cr,M=0,w=0;M<g.length;){var D=g[M];if(D){if(E>=C){S.overflow=v.split(M);break}var O=m.getEventBlob(D);if(O&&O.length<=P){var N=O.length;if(_.length+N>R){S.overflow=v.split(M);break}_&&(_+="\n"),_+=O,++w>fr&&(_.substr(0,1),w=0),T=!0,E++}else O?I.push(D):b.push(D),g.splice(M,1),M--}M++}if(I&&I.length>0&&S.sizeExceed.push(mr.create(v.iKey(),I)),b&&b.length>0&&S.failedEvts.push(mr.create(v.iKey(),b)),T){S.batches.push(v),S.payloadBlob=_,S.numEvents=E;var k=v.iKey();-1===arrIndexOf(S.apiKeys,k)&&S.apiKeys.push(k)}}),(function(){return{payload:S,theBatch:{iKey:v.iKey(),evts:v.events()},max:C}})),_},m.getEventBlob=function(m){try{return doPerf(g,(function(){return"Serializer.getEventBlob"}),(function(){var g={};g.name=m.name,g.time=m.time,g.ver=m.ver,g.iKey="o:"+getTenantId(m.iKey);var S={},v=m[E];v&&(g[E]=S,objForEachKey(v,(function(g,m){_processPathKeys(m,S[g]={},"ext."+g,!0,null,null,!0)})));var T=g[C]={};T.baseType=m.baseType;var b=T[_]={};return _processPathKeys(m.baseData,b,_,!1,[_],(function(g,m,v){_addJSONPropertyMetaData(S,g,m,v)}),I),_processPathKeys(m.data,T,C,!1,[],(function(g,m,v){_addJSONPropertyMetaData(S,g,m,v)}),I),JSON.stringify(g)}),(function(){return{item:m}}))}catch(g){return null}}}))}return Serializer}();function _addJSONPropertyMetaData(g,m,S,v){if(v&&g){var C=getCommonSchemaMetaData(v.value,v.kind,v.propertyType);if(C>-1){var _=g[yr];_||(_=g[yr]={f:{}});var E=_[Er];if(E||(E=_[Er]={}),m)for(var T=0;T<m.length;T++){var I=m[T];E[I]||(E[I]={f:{}});var b=E[I][Er];b||(b=E[I][Er]={}),E=b}E=E[S]={},isArray(v.value)?E.a={t:C}:E.t=C}}}
/**
	* RetryPolicy.ts
	* @author Abhilash Panwar (abpanwar)
	* @copyright Microsoft 2018
	*/var br,Ar=.8,Rr=1.2,Pr=3e3,Mr=6e5,wr=function(){function RetryPolicy(){}return RetryPolicy.shouldRetryForStatus=function(g){return!(g>=300&&g<500&&408!==g&&429!==g||501===g||505===g)},RetryPolicy.getMillisToBackoffForRetry=function(g){var m=0,S=Pr*Ar,v=Pr*Rr,C=Math.floor(Math.random()*(v-S))+S;return m=Math.pow(2,g)*C,Math.min(m,Mr)},RetryPolicy}(),Dr=1e3,Or=function(){function KillSwitch(){var g={};function _normalizeTenants(g){var m=[];return g&&arrForEach(g,(function(g){m.push(strTrim(g))})),m}dynamicProto(KillSwitch,this,(function(m){m.setKillSwitchTenants=function(m,S){if(m&&S)try{var v=_normalizeTenants(m.split(","));if("this-request-only"===S)return v;for(var C=parseInt(S,10)*Dr,_=0;_<v.length;++_)g[v[_]]=dateNow()+C}catch(g){return[]}return[]},m.isTenantKilled=function(m){var S=g,v=strTrim(m);return void 0!==S[v]&&S[v]>dateNow()||(delete S[v],!1)}}))}return KillSwitch}(),Nr=function(){function ClockSkewManager(){var g=!0,m=!0,S=!0,v="use-collector-delta",C=!1;dynamicProto(ClockSkewManager,this,(function(_){_.allowRequestSending=function(){return g},_.firstRequestSent=function(){S&&(S=!1,C||(g=!1))},_.shouldAddClockSkewHeaders=function(){return m},_.getClockSkewHeaderValue=function(){return v},_.setClockSkew=function(S){C||(S?(v=S,m=!0,C=!0):m=!1,g=!0)}}))}return ClockSkewManager}(),kr="POST",Lr="Microsoft_ApplicationInsights_BypassAjaxInstrumentation",Fr="drop",xr="send",Ur="requeue",Vr="rspFail",Br="oth",Hr="kill-tokens",$r="kill-duration",Gr="kill-duration-seconds",jr="time-delta-millis",qr=((br={})[1]=Ur,br[100]=Ur,br[200]="sent",br[8004]=Fr,br[8003]=Fr,br);function _getResponseText(g){try{return g.responseText}catch(g){}return""}var Wr=function(){function HttpManager(g,m,S,v){this._responseHandlers=[];var C,_,E,T,I,b="?cors=true&content-type=application/x-json-stream&client-id=NO_AUTH&client-version="+Xt,A=new Or,R=!1,P=new Nr,M=!1,w=0,D=!0,O=[],N={},k=[],L=null,F=!1;dynamicProto(HttpManager,this,(function(x){var U=!0;function _getSenderInterface(g){for(var m=0,S=null,v=0;null==S&&v<g.length;)1===(m=g[v])?useXDomainRequest()?S=_xdrSendPost:"undefined"!=typeof XMLHttpRequest&&(S=_xhrSendPost):2===m?S=_fetchSendPost:M&&3===m&&isBeaconsSupported()&&(S=_beaconSendPost),v++;return S?{_transport:m,sendPOST:S}:null}function _xdrSendPost(g,m,S){var v=new XDomainRequest;v.open(kr,g.urlString),v.onload=function(){var g=_getResponseText(v);_doOnComplete(m,200,{},g),_handleCollectorResponse(g)},v.onerror=function(){_doOnComplete(m,400,{})},v.ontimeout=function(){_doOnComplete(m,500,{})},v.onprogress=function(){},S?v.send(g.data):C._setTimeoutOverride((function(){v.send(g.data)}),0)}function _fetchSendPost(g,m){var S,v=((S={body:g.data,method:kr})[Lr]=!0,S);U&&(v.credentials="include"),g.headers&&objKeys(g.headers).length>0&&(v.headers=g.headers),fetch(g.urlString,v).then((function(g){var S={},v="";g.headers&&g.headers.forEach((function(g,m){S[m]=g})),g.body&&g.text().then((function(g){v=g})),_doOnComplete(m,g.status,S,v),_handleCollectorResponse(v)})).catch((function(g){_doOnComplete(m,0,{})}))}function _xhrSendPost(g,m,S){function _appendHeader(g,m,S){if(!g[S]&&m&&m.getResponseHeader){var v=m.getResponseHeader(S);v&&(g[S]=strTrim(v))}return g}function _getAllResponseHeaders(g){var m={};return g.getAllResponseHeaders?m=_convertAllHeadersToMap(g.getAllResponseHeaders()):(m=_appendHeader(m,g,jr),m=_appendHeader(m,g,$r),m=_appendHeader(m,g,Gr)),m}function xhrComplete(g,S){_doOnComplete(m,g.status,_getAllResponseHeaders(g),S)}var v=new XMLHttpRequest;try{v[Lr]=!0}catch(g){}U&&(v.withCredentials=!0),v.open(kr,g.urlString,!S),objForEachKey(g.headers,(function(g,m){v.setRequestHeader(g,m)})),v.onload=function(){var g=_getResponseText(v);xhrComplete(v,g),_handleCollectorResponse(g)},v.onerror=function(){xhrComplete(v)},v.ontimeout=function(){xhrComplete(v)},v.send(g.data)}function _doOnComplete(g,m,S,v){try{g(m,S,v)}catch(g){C.diagLog().throwInternal(be.WARNING,Qt.SendPostOnCompleteFailure,dumpObj(g))}}function _beaconSendPost(g,m,S){var v=200,_=g._thePayload;try{var E=getNavigator();if(!E.sendBeacon(g.urlString,g.data))if(_){var T=[];arrForEach(_.batches,(function(m){if(T&&m&&m.count()>0){for(var S=m.events(),v=0;v<S.length;v++)if(!E.sendBeacon(g.urlString,L.getEventBlob(S[v]))){T.push(m.split(v));break}}else T.push(m.split(0))})),_sendBatchesNotification(T,8003,_.isSync,!0)}else v=0}catch(g){C.diagLog().warnToConsole("Failed to send telemetry using sendBeacon API. Ex:"+g),v=0}finally{_doOnComplete(m,v,{},"")}}function _hasIdleConnection(){return!R&&w<m}function _clearQueue(){var g=k;return k=[],g}function _canSendPayload(g,m,S){var v=!1;return g&&g.length>0&&!R&&_&&L&&(v=m||_hasIdleConnection()&&(S>0||P.allowRequestSending())),v}function _createDebugBatches(g){var m={};return g&&arrForEach(g,(function(g,S){m[S]={iKey:g.iKey(),evts:g.events()}})),m}function _sendBatches(m,S,v,E,I,b){if(m&&0!==m.length)if(R)_sendBatchesNotification(m,1,E);else try{var P=m;doPerf(T,(function(){return"HttpManager:_sendBatches"}),(function(C){C&&(m=m.slice(0));for(var T=[],R=null,P=ii(),M=(b||_&&3===_._transport)&&_canUseSendBeaconApi();_canSendPayload(m,E,S);){var w=m.shift();w&&w.count()>0&&(A.isTenantKilled(w.iKey())?T.push(w):(R=R||L.createPayload(S,v,E,M,I),L.appendPayload(R,w,g)?null!==R.overflow&&(m=[R.overflow].concat(m),R.overflow=null,_doPayloadSend(R,P,ii(),I),P=ii(),R=null):(_doPayloadSend(R,P,ii(),I),P=ii(),m=[w].concat(m),R=null)))}R&&_doPayloadSend(R,P,ii(),I),m.length>0&&(k=m.concat(k)),_sendBatchesNotification(T,8004,E)}),(function(){return{batches:_createDebugBatches(P),retryCount:S,isTeardown:v,isSynchronous:E,sendReason:I,useSendBeacon:b}}),!E)}catch(g){C.diagLog().throwInternal(be.WARNING,Qt.CannotSerializeObject,"Unexpected Exception sending batch: "+dumpObj(g))}}function _buildQueryString(g){var m=b,S="";arrForEach(g.apiKeys,(function(g){S.length>0&&(S+=","),S+=g})),S.length>0&&(m+="&apikey="+S),m+="&upload-time="+dateNow().toString();var v=_getMsfpc(g);if(isValueAssigned(v)&&(m=m+"&ext.intweb.msfpc="+v),P.shouldAddClockSkewHeaders()&&(m+="&time-delta-to-apply-millis="+P.getClockSkewHeaderValue()),T.getWParam){var C=T.getWParam();C>=0&&(m+="&w="+C)}for(var _=0;_<O.length;_++)m+="&"+O[_].name+"="+O[_].value;return m}function _canUseSendBeaconApi(){return!D&&M&&isBeaconsSupported()}function _setTimingValue(g,m,S){g[m]=g[m]||{},g[m][C.identifier]=S}function _doPayloadSend(g,m,S,v){if(g&&g.payloadBlob&&g.payloadBlob.length>0){var I=_buildQueryString(g),b=ii(),A="sendAttempt";doPerf(T,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var R=0;R<g.batches.length;R++)for(var M=g.batches[R].events(),O=0;O<M.length;O++){var k=M[O];if(F){var L=k.timings=k.timings||{};_setTimingValue(L,"sendEventStart",b),_setTimingValue(L,"serializationStart",m),_setTimingValue(L,"serializationCompleted",S)}k[A]>0?k[A]++:k[A]=1}_sendBatchesNotification(g.batches,1e3+(v||0),g.isSync,!0);var U={data:g.payloadBlob,urlString:I,headers:extend({},N),_thePayload:g,_sendReason:v},V=null,B=!!x.sendHook,H=_;E&&g.isBeacon&&2===g.sendReason&&(H=E),H&&(V=function(m){P.firstRequestSent();var onComplete=function(m,S){_retryRequestIfNeeded(m,S,g,v)};try{H.sendPOST(m,onComplete,g.isTeardown||g.isSync),x.sendListener&&x.sendListener(U,m,g.isSync||g.isTeardown,g.isBeacon)}catch(g){C.diagLog().warnToConsole("Unexpected exception sending payload. Ex:"+dumpObj(g)),_doOnComplete(onComplete,0,{})}}),doPerf(T,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(V)if(g.isSync||g.isBeacon||w++,B&&!g.isBeacon&&3!==H._transport){var m={data:U.data,urlString:U.urlString,headers:U.headers},S=!1;doPerf(T,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{x.sendHook(m,(function(g){S=!0,D||g._thePayload||(g._thePayload=g._thePayload||U._thePayload,g._sendReason=g._sendReason||U._sendReason),V(g)}),g.isSync||g.isTeardown)}catch(g){S||V(U)}}))}else V(U)}))}),(function(){return{thePayload:g,serializationStart:m,serializationCompleted:S,sendReason:v}}),g.isSync)}g.sizeExceed&&g.sizeExceed.length>0&&_sendBatchesNotification(g.sizeExceed,8003,g.isSync),g.failedEvts&&g.failedEvts.length>0&&_sendBatchesNotification(g.failedEvts,8002,g.isSync)}function _addEventCompletedTimings(g,m){F&&arrForEach(g,(function(g){_setTimingValue(g.timings=g.timings||{},"sendEventCompleted",m)}))}function _retryRequestIfNeeded(g,m,v,C){var _=9e3,E=null,T=!1,I=!1;try{var b=!0;if(typeof g!==W){if(m){P.setClockSkew(m[jr]);var R=m[$r]||m["kill-duration-seconds"];arrForEach(A.setKillSwitchTenants(m[Hr],R),(function(g){arrForEach(v.batches,(function(m){if(m.iKey()===g){E=E||[];var S=m.split(0);v.numEvents-=S.count(),E.push(S)}}))}))}if(200===g)return void(_=200);(!wr.shouldRetryForStatus(g)||v.numEvents<=0)&&(b=!1),_=9e3+g%1e3}if(b){_=100;var M=v.retryCnt;v.isSync||v.isBeacon||(M<S?(T=!0,_doAction((function(){v.isSync||v.isBeacon||w--,_sendBatches(v.batches,M+1,v.isTeardown,v.isSync,5,v.isBeacon)}),!0,wr.getMillisToBackoffForRetry(M))):I=!0)}}finally{T||(P.setClockSkew(),_handleRequestFinished(v,_,C,I)),_sendBatchesNotification(E,8004,v.isSync)}}function _handleRequestFinished(g,m,S,v){try{v&&C._backOffTransmission(),200===m&&(v||g.isSync||C._clearBackOff(),_addCompleteTimings(g.batches)),_sendBatchesNotification(g.batches,m,g.isSync,!0)}finally{g.isSync||g.isBeacon||(w--,5!==S&&x.sendQueuedRequests(S,!g.isSync,g.isBeacon))}}function _addCompleteTimings(g){if(F){var m=ii();arrForEach(g,(function(g){g&&g.count()>0&&_addEventCompletedTimings(g.events(),m)}))}}function _doAction(g,m,S){m?g():C._setTimeoutOverride(g,S)}function _convertAllHeadersToMap(g){var m={};isString(g)&&arrForEach(strTrim(g).split(/[\r\n]+/),(function(g){if(g){var S=g.indexOf(": ");if(-1!==S){var v=strTrim(g.substring(0,S)).toLowerCase(),C=strTrim(g.substring(S+1));m[v]=C}else m[strTrim(g)]=1}}));return m}function _getMsfpc(g){for(var m=0;m<g.batches.length;m++)for(var S=g.batches[m].events(),v=0;v<S.length;v++){var C=(S[v].ext||{}).intweb||{};if(isValueAssigned(C.msfpc))return encodeURIComponent(C.msfpc)}return""}function _handleCollectorResponse(g){var m=x._responseHandlers;try{for(var S=0;S<m.length;S++)try{m[S](g)}catch(g){C.diagLog().throwInternal(be.CRITICAL,Qt.PostResponseHandler,"Response handler failed: "+g)}if(g){var v=JSON.parse(g);isValueAssigned(v.webResult)&&isValueAssigned(v.webResult.msfpc)&&I.set("MSFPC",v.webResult.msfpc,31536e3)}}catch(g){}}function _sendBatchesNotification(g,m,S,_){if(g&&g.length>0&&v){var E=v[_getNotificationAction(m)];E&&doPerf(T,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){_doAction((function(){try{E.call(v,g,m,S)}catch(g){C.diagLog().throwInternal(be.CRITICAL,Qt.NotificationException,"send request notification failed: "+g)}}),_||S,0)}),(function(){return{batches:_createDebugBatches(g),reason:m,isSync:S,sendSync:_}}),!S)}}function _getNotificationAction(g){var m=qr[g];return isValueAssigned(m)||(m=Br,g>=9e3&&g<=9999?m=Vr:g>=8e3&&g<=8999?m=Fr:g>=1e3&&g<=1999&&(m=xr)),m}x.initialize=function(g,m,S,v,A){A||(A={}),b=g+b,T=m,I=m.getCookieMgr(),F=!T.config.disableEventTimings;var R=!!T.config.enableCompoundKey;C=S;var P=A.valueSanitizer,w=A.stringifyObjects;if(isUndefined(A.enableCompoundKey)||(R=!!A.enableCompoundKey),M=!isReactNative(),L=new Ir(T,P,w,R),E=_getSenderInterface([3]),!(_=v)){D=!1;var O=getLocation();O&&O.protocol&&"file:"===O.protocol.toLowerCase()&&(U=!1);var N=[];N=isReactNative()?[2,1]:[1,2,3];var k=A.transports;k&&(isNumber(k)?N=[k].concat(N):isArray(k)&&(N=k.concat(N))),(_=_getSenderInterface(N))||C.diagLog().warnToConsole("No available transport to send events")}},x._getDbgPlgTargets=function(){return[_,A,L]},x.addQueryStringParameter=function(g,m){for(var S=0;S<O.length;S++)if(O[S].name===g)return void(O[S].value=m);O.push({name:g,value:m})},x.addHeader=function(g,m){N[g]=m},x.canSendRequest=function(){return _hasIdleConnection()&&P.allowRequestSending()},x.sendQueuedRequests=function(g,m,S){var v=!isNullOrUndefined(m)&&!m;_canSendPayload(k,v,0)&&_sendBatches(_clearQueue(),0,!1,v,g||0,!!S)},x.isCompletelyIdle=function(){return!R&&0===w&&0===k.length},x.addBatch=function(g){if(g&&g.count()>0){if(A.isTenantKilled(g.iKey()))return!1;k.push(g)}return!0},x.teardown=function(){k.length>0&&_sendBatches(_clearQueue(),0,!0,!0,2,!0)},x.pause=function(){R=!0},x.resume=function(){R=!1,x.sendQueuedRequests(4,!1)},x.sendSynchronousBatch=function(g,m,S){g&&g.count()>0&&_sendBatches([g],0,!1,!0,m||0,!!S)}}))}return HttpManager}(),zr=.25,Kr=500,Jr=20,Yr=6,Qr=4,Xr=ti?window:void 0,Zr=2,es=1,ts="eventsDiscarded",is="overrideInstrumentationKey",ns=function(g){function PostChannel(){var m,S=g.call(this)||this;S.identifier="PostChannel",S.priority=1011,S.version="3.1.2";var v,C,_,E,T,I=!1,b=[],A=null,R=!1,P=0,M=500,w=0,D=1e4,O={},N=ur,k=null,L=null,F=0,x=0,U={},V=-1,B=!0;return dynamicProto(PostChannel,S,(function(g,S){function _addEventToQueues(g,m){if(g.sendAttempt||(g.sendAttempt=0),g.latency||(g.latency=Jt.Normal),g.ext&&g.ext.trace&&delete g.ext.trace,g.ext&&g.ext.user&&g.ext.user.id&&delete g.ext.user.id,B&&(g.ext=optimizeObject(g.ext),g.baseData&&(g.baseData=optimizeObject(g.baseData)),g.data&&(g.data=optimizeObject(g.data))),g.sync)if(F||R)g.latency=Jt.RealTime,g.sync=!1;else if(C)return B&&(g=optimizeObject(g)),void C.sendSynchronousBatch(mr.create(g.iKey,[g]),3);var S=g.latency,v=w,_=D;S===Jt.Immediate&&(v=P,_=M);var E=!1;if(v<_)E=!_addEventToProperQueue(g,m);else{var T=Jt.Normal,I=Jr;S===Jt.Immediate&&(T=Jt.Immediate,I=1),E=!0,_dropEventWithLatencyOrLess(g.iKey,g.latency,T,I)&&(E=!_addEventToProperQueue(g,m))}E&&_notifyEvents(ts,[g],ne.QueueFull)}function _sendEventsForLatencyAndAbove(g,m,S,v){var _=_queueBatches(g,m,S);return C.sendQueuedRequests(m,S,v),_}function _hasEvents(){return w>0}function _scheduleTimer(){if(V>=0&&_queueBatches(V,T,!0)&&C.sendQueuedRequests(T,!0,!1),P>0&&!L&&!R){var g=O[N][2];g>=0&&(L=_createTimer((function(){L=null,_sendEventsForLatencyAndAbove(Jt.Immediate,1,!0),_scheduleTimer()}),g))}var m=O[N][1];!k&&!A&&m>=0&&!R&&(_hasEvents()?k=_createTimer((function(){k=null,_sendEventsForLatencyAndAbove(0===x?Jt.RealTime:Jt.Normal,1,!0),x++,x%=2,_scheduleTimer()}),m):x=0)}function _createTimer(m,S){0===S&&F&&(S=1);var v=1e3;return F&&(v=wr.getMillisToBackoffForRetry(F-1)),g._setTimeoutOverride(m,S*v)}function _clearScheduledTimer(){null!==k&&(g._clearTimeoutOverride(k),k=null,x=0)}function _releaseAllQueuesUsingBeacons(m,S){_clearScheduledTimer(),A&&(g._clearTimeoutOverride(A),A=null),R||_sendEventsForLatencyAndAbove(Jt.Normal,m,S,!0)}function _clearQueues(){U[Jt.Immediate]={batches:[],iKeyMap:{}},U[Jt.RealTime]={batches:[],iKeyMap:{}},U[Jt.CostDeferred]={batches:[],iKeyMap:{}},U[Jt.Normal]={batches:[],iKeyMap:{}}}function _getEventBatch(g,m,S){var v=U[m];v||(m=Jt.Normal,v=U[m]);var C=v.iKeyMap[g];return!C&&S&&(C=mr.create(g),v.batches.push(C),v.iKeyMap[g]=C),C}function _performAutoFlush(m,S){C.canSendRequest()&&!F&&(_>0&&w>_&&(S=!0),S&&null==A&&g.flush(m,null,20))}function _addEventToProperQueue(g,m){B&&(g=optimizeObject(g));var S=g.latency,v=_getEventBatch(g.iKey,S,!0);return!!v.addEvents([g],m)&&(S!==Jt.Immediate?(w++,m&&0===g.sendAttempt&&_performAutoFlush(!g.sync,E>0&&v.count()>=E)):P++,!0)}function _dropEventWithLatencyOrLess(g,m,S,v){for(;S<=m;){var C=_getEventBatch(g,m,!0);if(C&&C.count()>0){var _=C.split(0,v),E=_.count();if(E>0)return S===Jt.Immediate?P-=E:w-=E,_notifyBatchEvents(ts,[_],ne.QueueFull),!0}S++}return _resetQueueCounts(),!1}function _resetQueueCounts(){for(var g=0,m=0,_loop_1=function(S){var v=U[S];v&&v.batches&&arrForEach(v.batches,(function(v){S===Jt.Immediate?g+=v.count():m+=v.count()}))},S=Jt.Normal;S<=Jt.Immediate;S++)_loop_1(S);w=m,P=g}function _queueBatches(m,S,v){var _=!1;return!v||C.canSendRequest()?doPerf(g.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var g=[],S=Jt.Immediate;S>=m;){var v=U[S];v&&v.batches&&(arrForEach(v.batches,(function(m){C.addBatch(m)?_=_||m&&m.count()>0:g=g.concat(m.events()),S===Jt.Immediate?P-=m.count():w-=m.count()})),v.batches=[],v.iKeyMap={}),S--}g.length>0&&_notifyEvents(ts,g,ne.KillSwitch),_&&V>=m&&(V=-1,T=0)}),(function(){return{latency:m,sendReason:S}}),v):(V=V>=0?Math.min(V,m):m,T=Math.max(T,S)),_}function _flushImpl(g,m){_sendEventsForLatencyAndAbove(Jt.Normal,m,!0),_waitForIdleManager((function(){g&&g(),b.length>0?A=_createTimer((function(){return _flushImpl(b.shift(),m)}),0):(A=null,_hasEvents()&&_scheduleTimer())}))}function _waitForIdleManager(g){C.isCompletelyIdle()?g():A=_createTimer((function(){_waitForIdleManager(g)}),zr)}function _resetTransmitProfiles(){_clearScheduledTimer(),_initializeProfiles(),N=ur,_scheduleTimer()}function _initializeProfiles(){(O={})[ur]=[2,1,0],O[gr]=[6,3,0],O[pr]=[18,9,0]}function _requeueEvents(m,S){var v=[];arrForEach(m,(function(m){m&&m.count()>0&&arrForEach(m.events(),(function(m){m&&(m.sync&&(m.latency=Jt.RealTime,m.sync=!1),m.sendAttempt<Yr?(setProcessTelemetryTimings(m,g.identifier),_addEventToQueues(m,!1)):v.push(m))}))})),v.length>0&&_notifyEvents(ts,v,ne.NonRetryableStatus)}function _callNotification(m,S){var v=g._notificationManager||{},C=v[m];if(C)try{C.apply(v,S)}catch(S){g.diagLog().throwInternal(be.CRITICAL,Qt.NotificationException,m+" notification failed: "+S)}}function _notifyEvents(g,m){for(var S=[],v=2;v<arguments.length;v++)S[v-2]=arguments[v];m&&m.length>0&&_callNotification(g,[m].concat(S))}function _notifyBatchEvents(g,m){for(var S=[],v=2;v<arguments.length;v++)S[v-2]=arguments[v];m&&m.length>0&&arrForEach(m,(function(m){m&&m.count()>0&&_callNotification(g,[m.events()].concat(S))}))}function _sendingEvent(g,m,S){g&&g.length>0&&_callNotification("eventsSendRequest",[m>=1e3&&m<=1999?m-1e3:0,!0!==S])}function _eventsSentEvent(g,m){_notifyBatchEvents("eventsSent",g,m),_scheduleTimer()}function _eventsDropped(g,m){_notifyBatchEvents(ts,g,m>=8e3&&m<=8999?m-8e3:ne.Unknown)}function _eventsResponseFail(g){_notifyBatchEvents(ts,g,ne.NonRetryableStatus),_scheduleTimer()}function _otherEvent(g,m){_notifyBatchEvents(ts,g,ne.Unknown),_scheduleTimer()}function _setAutoLimits(){E=m&&m.disableAutoBatchFlushLimit?0:Math.max(Kr*(Zr+1),D/6)}_initializeProfiles(),_clearQueues(),_setAutoLimits(),C=new Wr(Kr,Zr,es,{requeue:_requeueEvents,send:_sendingEvent,sent:_eventsSentEvent,drop:_eventsDropped,rspFail:_eventsResponseFail,oth:_otherEvent}),g._getDbgPlgTargets=function(){return[C]},g.initialize=function(E,T,I){doPerf(T,(function(){return"PostChannel:initialize"}),(function(){var b=T;S.initialize(E,T,I),g.setInitialized(!1);var A=g._getTelCtx();E.extensionConfig[g.identifier]=E.extensionConfig[g.identifier]||{},m=A.getExtCfg(g.identifier),g._setTimeoutOverride=m.setTimeoutOverride?m.setTimeoutOverride:setTimeout.bind(Xr),g._clearTimeoutOverride=m.clearTimeoutOverride?m.clearTimeoutOverride:clearTimeout.bind(Xr),B=!m.disableOptimizeObj&&isChromium();var R=b.getWParam;b.getWParam=function(){var g=0;return m.ignoreMc1Ms0CookieProcessing&&(g|=2),g|R()},m.eventsLimitInMem>0&&(D=m.eventsLimitInMem),m.immediateEventLimit>0&&(M=m.immediateEventLimit),m.autoFlushEventsLimit>0&&(_=m.autoFlushEventsLimit),_setAutoLimits(),m.httpXHROverride&&m.httpXHROverride.sendPOST&&(v=m.httpXHROverride),isValueAssigned(E.anonCookieName)&&C.addQueryStringParameter("anoncknm",E.anonCookieName),C.sendHook=m.payloadPreprocessor,C.sendListener=m.payloadListener;var P=m.overrideEndpointUrl?m.overrideEndpointUrl:E.endpointUrl;g._notificationManager=E.extensionConfig.NotificationManager,C.initialize(P,g.core,g,v,m),addPageUnloadEventListener((function(){_releaseAllQueuesUsingBeacons(2,!1)})),g.setInitialized(!0)}),(function(){return{coreConfig:E,core:T,extensions:I}}))},g.processTelemetry=function(S,v){setProcessTelemetryTimings(S,g.identifier);var C=(v=g._getTelCtx(v)).getExtCfg(g.identifier),_=!!m.disableTelemetry;C&&(_=_||!!C.disableTelemetry);var E=S;_||I||(m[is]&&(E.iKey=m[is]),C&&C[is]&&(E.iKey=C[is]),_addEventToQueues(E,!0),_scheduleTimer()),g.processNext(E,v)},g.setEventQueueLimits=function(g,m){D=g>0?g:1e4,_=m>0?m:0,_setAutoLimits();var S=w>g;if(!S&&E>0)for(var v=Jt.Normal;!S&&v<=Jt.RealTime;v++){var C=U[v];C&&C.batches&&arrForEach(C.batches,(function(g){g&&g.count()>=E&&(S=!0)}))}_performAutoFlush(!0,S)},g.teardown=function(){_releaseAllQueuesUsingBeacons(2,!1),I=!0,C.teardown()},g.pause=function(){_clearScheduledTimer(),R=!0,C.pause()},g.resume=function(){R=!1,C.resume(),_scheduleTimer()},g.addResponseHandler=function(g){C._responseHandlers.push(g)},g._loadTransmitProfiles=function(g){_resetTransmitProfiles(),objForEachKey(g,(function(g,m){var S=m.length;if(S>=2){var v=S>2?m[2]:0;if(m.splice(0,S-2),m[1]<0&&(m[0]=-1),m[1]>0&&m[0]>0){var C=m[0]/m[1];m[0]=Math.ceil(C)*m[1]}v>=0&&m[1]>=0&&v>m[1]&&(v=m[1]),m.push(v),O[g]=m}}))},g.flush=function(g,m,S){void 0===g&&(g=!0),R||(_clearScheduledTimer(),S=S||1,g?(_queueBatches(Jt.Normal,S,g),_resetQueueCounts(),null==A?A=_createTimer((function(){_flushImpl(m,S)}),0):b.push(m)):(_sendEventsForLatencyAndAbove(Jt.Normal,S,!1),null!=m&&m()))},g.setMsaAuthTicket=function(g){C.addHeader("AuthMsaDeviceTicket",g)},g.hasEvents=_hasEvents,g._setTransmitProfile=function(g){N!==g&&void 0!==O[g]&&(_clearScheduledTimer(),N=g,_scheduleTimer())},g._backOffTransmission=function(){F<Qr&&(F++,_clearScheduledTimer(),_scheduleTimer())},g._clearBackOff=function(){F&&(F=0,_clearScheduledTimer(),_scheduleTimer())}})),S}return __extendsFn$2(PostChannel,g),PostChannel}(ut),rs=["AX","EX","SF","CS","CF","CT","CU","DC","DF","H5","HL","WS","WP"];function _validateAppExpId(g,m){void 0===m&&(m=rs);var S=null;if(g)for(var v=g.split(","),C=0;C<v.length;C++)_isValidAppFlightId(v[C],m)&&(S?S+=","+v[C]:S=v[C]);return S}function _isValidAppFlightId(g,m){if(void 0===m&&(m=rs),!g||g.length<4)return!1;for(var S=!1,v=256,C=g.substring(0,3).toString().toUpperCase(),_=0;_<m.length;_++)if(m[_]+":"===C&&g.length<=v){S=!0;break}return S}var ss=function(){function Application(g,m){this.core=m,this.appExpId=null,this.flightIdNameSpaces=rs.slice(0),this.expIdCookieName="Treatments",this._cookieMgr=safeGetCookieMgr(m),this._propertiesConfig=g;var S=getDocument();if(S){var v=S.documentElement;S&&(this.locale=v.lang)}this.env=g.env?g.env:this._getMetaDataFromDOM("awa-").env}return Application.prototype.getExpId=function(){return this._propertiesConfig.expId?this._readExpIdFromCoreData(this._propertiesConfig.expId):this._readExpIdFromCookie()},Application.prototype._getMetaDataFromDOM=function(g){var m,S={},v=getDocument();if(v){m=v&&v.querySelectorAll("meta");for(var C=0;C<m.length;C++){var _=m[C];if(_.name)if(0===_.name.toLowerCase().indexOf(g))S[_.name.replace(g,"")]=_.content}}return S},Application.prototype._setAppExpId=function(g){g!==this.appExpId&&(this.appExpId=_validateAppExpId(g,this.flightIdNameSpaces))},Application.prototype._getAppExpId=function(){return this.appExpId},Application.prototype._readExpIdFromCookie=function(){var g=getCookieValue(this._cookieMgr,this.expIdCookieName);return this._setAppExpId(g),this._getAppExpId()},Application.prototype._readExpIdFromCoreData=function(g){return this._setAppExpId(g),this._getAppExpId()},Application.validateAppExpId=_validateAppExpId,Application._staticInit=void objDefineAccessors(Application.prototype,"expId",Application.prototype.getExpId),Application}(),as=function(){function Cloud(){}return Cloud}(),os=function(){function User(g,m,S){this.core=S;var v=this._cookieMgr=safeGetCookieMgr(S,g);if(v&&v.isEnabled()){var C=getCookieValue(v,"MUID");if(C&&this.setLocalId("t:"+C),m.enableApplicationInsightsUser){var _=getCookieValue(v,User.userCookieName);if(_){var E=_.split(User.cookieSeparator);E.length>0&&(this.id=E[0])}if(!this.id){this.id=newId(g&&!isUndefined(g.idLength)?g.idLength:22);var T=toISOString(new Date);this.accountAcquisitionDate=T;var I=[this.id,T],b=m.cookieDomain?m.cookieDomain:void 0;v.set(User.userCookieName,I.join(User.cookieSeparator),31536e3,b)}}}if("undefined"!=typeof navigator){var A=navigator;this.locale=A.userLanguage||A.language}}return User.prototype.getLocalId=function(){if(this._customLocalId)return this._customLocalId;var g=getCookieValue(this._cookieMgr,"MUID");g&&this.setLocalId("t:"+g)},User.prototype.setLocalId=function(g){this._customLocalId=g},User.cookieSeparator="|",User.userCookieName="ai_user",User._staticInit=void objDefineAccessors(User.prototype,"localId",User.prototype.getLocalId,User.prototype.setLocalId),User}(),ls={MSIE:"MSIE",CHROME:"Chrome",FIREFOX:"Firefox",SAFARI:"Safari",EDGE:"Edge",ELECTRON:"Electron",SKYPE_SHELL:"SkypeShell",PHANTOMJS:"PhantomJS",OPERA:"Opera"},cs="([\\d,.]+)",ds="Unknown",hs="Edg/",us=function(){function Web(g,m){this._cookieMgr=safeGetCookieMgr(m),this._propertiesConfig=g;var S=getLocation();if(S){var v=S.hostname;v&&(this.domain="file:"===S.protocol?"local":v)}var C="undefined"!=typeof navigator?navigator.userAgent:"";if(g.userAgent&&(C=g.userAgent),g.populateBrowserInfo){if(C){var _=this._getBrowserName(C);this.browser=_,this.browserVer=this._getBrowserVersion(C,_)}var E=this._getScreenResolution();this.screenRes=E.w+"X"+E.h}}return Web.prototype.getUserConsent=function(){return this._propertiesConfig.userConsented||!!getCookieValue(this._cookieMgr,this._propertiesConfig.userConsentCookieName||"MSCC")},Web.prototype.getUserConsentDetails=function(){try{if(this._propertiesConfig.callback&&this._propertiesConfig.callback.userConsentDetails){var g=this._propertiesConfig.callback.userConsentDetails();if(g)return JSON.stringify({Required:!!g.Required&&g.Required,Analytics:!!g.Analytics&&g.Analytics,SocialMedia:!!g.SocialMedia&&g.SocialMedia,Advertising:!!g.Advertising&&g.Advertising})}}catch(g){}return null},Web.prototype._getBrowserName=function(g){return this._userAgentContainsString("OPR/",g)?ls.OPERA:this._userAgentContainsString(ls.PHANTOMJS,g)?ls.PHANTOMJS:this._userAgentContainsString(ls.EDGE,g)||this._userAgentContainsString(hs,g)?ls.EDGE:this._userAgentContainsString(ls.ELECTRON,g)?ls.ELECTRON:this._userAgentContainsString(ls.CHROME,g)?ls.CHROME:this._userAgentContainsString("Trident",g)?ls.MSIE:this._userAgentContainsString(ls.FIREFOX,g)?ls.FIREFOX:this._userAgentContainsString(ls.SAFARI,g)?ls.SAFARI:this._userAgentContainsString(ls.SKYPE_SHELL,g)?ls.SKYPE_SHELL:ds},Web.prototype._userAgentContainsString=function(g,m){return m.indexOf(g)>-1},Web.prototype._getBrowserVersion=function(g,m){return m===ls.MSIE?this._getIeVersion(g):this._getOtherVersion(m,g)},Web.prototype._getIeVersion=function(g){var m=g.match(new RegExp(ls.MSIE+" "+cs));if(m)return m[1];var S=g.match(new RegExp("rv:"+cs));return S?S[1]:void 0},Web.prototype._getOtherVersion=function(g,m){g===ls.SAFARI?g="Version":g===ls.EDGE&&this._userAgentContainsString(hs,m)&&(g="Edg");var S=m.match(new RegExp(g+"/"+cs));return S?S[1]:ds},Web.prototype._getScreenResolution=function(){var g={h:0,w:0},m=getWindow();return m&&m.screen&&(g.h=screen.height,g.w=screen.width),g},Web._staticInit=void objDefineAccessors(Web.prototype,"userConsent",Web.prototype.getUserConsent),Web}(),gs={WINDOWS:"Windows",MACOSX:"Mac OS X",ANDROID:"Android",IOS:"iOS"},ps={WIN:/(windows|win32)/i,WINRT:/ arm;/i,WINPHONE:/windows\sphone\s\d+\.\d+/i,OSX:/(macintosh|mac os x)/i,IOS:/(ipad|iphone|ipod)(?=.*like mac os x)/i,LINUX:/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,ANDROID:/android/i,CROS:/CrOS/i},ms={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},fs="([\\d,.]+)",Ss="([\\d,_,.]+)",vs="Unknown",Cs=function(){function OperatingSystem(g){var m="undefined"!=typeof navigator?navigator.userAgent:"";if(g.userAgent&&(m=g.userAgent),m&&g.populateOperatingSystemInfo){var S=this._getOsName(m.toLowerCase());this.name=S,this.ver=this._getOsVersion(m,S)}}return OperatingSystem.prototype._getOsName=function(g){return g.match(ps.WINPHONE)?"Windows Phone":g.match(ps.WINRT)?"Windows RT":g.match(ps.WIN)?gs.WINDOWS:g.match(ps.IOS)?gs.IOS:g.match(ps.ANDROID)?gs.ANDROID:g.match(ps.LINUX)?"Linux":g.match(ps.CROS)?"Chrome OS":-1!==g.indexOf("x11")?"Unix":-1!==g.indexOf("blackberry")?"BlackBerry":-1!==g.indexOf("symbian")?"Symbian":-1!==g.indexOf("nokia")?"Nokia":g.match(ps.OSX)?gs.MACOSX:vs},OperatingSystem.prototype._getOsVersion=function(g,m){return m===gs.WINDOWS?this._getGenericOsVersion(g,"Windows NT"):m===gs.ANDROID?this._getGenericOsVersion(g,m):m===gs.MACOSX?this._getMacOsxVersion(g):m===gs.IOS?this._getIosVersion(g):vs},OperatingSystem.prototype._getGenericOsVersion=function(g,m){var S=g.match(new RegExp(m+" "+fs));return S?ms[S[1]]?ms[S[1]]:S[1]:vs},OperatingSystem.prototype._getMacOsxVersion=function(g){var m=g.match(new RegExp(gs.MACOSX+" "+Ss));if(m){var S=m[1].replace(/_/g,".");if(S){var v=this._getDelimiter(S);return v?S.split(v)[0]:S}}return vs},OperatingSystem.prototype._getIosVersion=function(g){var m=g.match(new RegExp("OS "+Ss));if(m){var S=m[1].replace(/_/g,".");if(S){var v=this._getDelimiter(S);return v?S.split(v)[0]:S}}return vs},OperatingSystem.prototype._getDelimiter=function(g){return g.indexOf(".")>-1?".":g.indexOf("_")>-1?"_":null},OperatingSystem}(),_s=function(){function IntWeb(g,m){this.core=m,g.serviceName&&(this.serviceName=g.serviceName),this._cookieMgr=safeGetCookieMgr(m)}return IntWeb.prototype.getMsfpc=function(){return getCookieValue(this._cookieMgr,"MSFPC")},IntWeb.prototype.getAnid=function(){return getCookieValue(this._cookieMgr,"ANON").slice(0,34)},IntWeb._staticInit=(objDefineAccessors(IntWeb.prototype,"msfpc",IntWeb.prototype.getMsfpc),void objDefineAccessors(IntWeb.prototype,"anid",IntWeb.prototype.getAnid)),IntWeb}(),ys=1048576,Es=2097152,Ts=function(){function Utc(g){this.popSample=100,this.eventFlags=0,g.hashIdentifiers&&(this.eventFlags=this.eventFlags|ys),g.dropIdentifiers&&(this.eventFlags=this.eventFlags|Es)}return Utc}(),Is=function(){function Loc(){var g=(new Date).getTimezoneOffset(),m=g%60,S=(g-m)/60,v="+";S>0&&(v="-"),S=Math.abs(S),m=Math.abs(m),this.tz=v+(S<10?"0"+S:S.toString())+":"+(m<10?"0"+m:m.toString())}return Loc}(),bs=function(){function Device(){}return Device}(),As=function(){function Session(){}return Session.prototype.setId=function(g){this.customId=g},Session.prototype.getId=function(){return isString(this.customId)?this.customId:this.automaticId},Session._staticInit=void objDefineAccessors(Session.prototype,"id",Session.prototype.getId,Session.prototype.setId),Session}(),Rs=function(){function Trace(g,m,S,v){if(g.enableApplicationInsightsTrace){this.traceId=m||generateW3CId(),this.parentId=S,this.name=v;var C=getLocation();C&&C.pathname&&(this.name=C.pathname)}}return Trace}(),Ps=function(){function AppExtensionKeys(){}return AppExtensionKeys.id="id",AppExtensionKeys.ver="ver",AppExtensionKeys.appName="name",AppExtensionKeys.locale="locale",AppExtensionKeys.expId="expId",AppExtensionKeys.env="env",AppExtensionKeys}(),Ms=function(){function WebExtensionKeys(){}return WebExtensionKeys.domain="domain",WebExtensionKeys.browser="browser",WebExtensionKeys.browserVer="browserVer",WebExtensionKeys.screenRes="screenRes",WebExtensionKeys.userConsent="userConsent",WebExtensionKeys.consentDetails="consentDetails",WebExtensionKeys}(),ws=function(){function UserExtensionKeys(){}return UserExtensionKeys.locale="locale",UserExtensionKeys.localId="localId",UserExtensionKeys.id="id",UserExtensionKeys}(),Ds=function(){function OSExtKeys(){}return OSExtKeys.osName="name",OSExtKeys.ver="ver",OSExtKeys}(),Os=function(){function SDKExtKeys(){}return SDKExtKeys.ver="ver",SDKExtKeys.seq="seq",SDKExtKeys.installId="installId",SDKExtKeys.epoch="epoch",SDKExtKeys}(),Ns=function(){function IntWebExtKeys(){}return IntWebExtKeys.msfpc="msfpc",IntWebExtKeys.anid="anid",IntWebExtKeys.serviceName="serviceName",IntWebExtKeys}(),ks=function(){function UtcExtKeys(){}return UtcExtKeys.popSample="popSample",UtcExtKeys.eventFlags="eventFlags",UtcExtKeys}(),Ls=function(){function LocExtKeys(){}return LocExtKeys.tz="tz",LocExtKeys}(),Fs=function(){function SessionExtKeys(){}return SessionExtKeys.sessionId="sesId",SessionExtKeys}(),xs=function(){function DeviceExtKeys(){}return DeviceExtKeys.localId="localId",DeviceExtKeys.deviceClass="deviceClass",DeviceExtKeys.make="make",DeviceExtKeys.model="model",DeviceExtKeys}(),Us=function(){function CloudExtKeys(){}return CloudExtKeys.role="role",CloudExtKeys.roleInstance="roleInstance",CloudExtKeys.roleVer="roleVer",CloudExtKeys}(),Vs=function(){function TraceExtKeys(){}return TraceExtKeys.traceId="traceID",TraceExtKeys.traceName="name",TraceExtKeys.parentId="parentID",TraceExtKeys}(),Bs=function(){function Extensions(){}return Extensions.UserExt="user",Extensions.DeviceExt="device",Extensions.TraceExt="trace",Extensions.WebExt="web",Extensions.AppExt="app",Extensions.OSExt="os",Extensions.SdkExt="sdk",Extensions.IntWebExt="intweb",Extensions.UtcExt="utc",Extensions.LocExt="loc",Extensions.CloudExt="cloud",Extensions}(),Hs="MicrosoftApplicationsTelemetryDeviceId";
/**
	* Cloud.ts
	* @author Hector Hernandez (hectorh)
	* @copyright Microsoft 2020
	*/function _saveData(g,m,S,v){m?m.setProperty(S,v):g.set(S,v,31536e3)}function _getData(g,m,S){return m?m.getProperty(S)||"":getCookieValue(g,S)}var $s,Gs,js=function(){function Sdk(g,m){this._sequenceId=0;var S=g.propertyStorageOverride;this.seq=this._sequenceId,this.epoch=random32(!1).toString();var v=safeGetCookieMgr(m,g);if(v.isEnabled()||S){var C=_getData(v,S,Hs);C||(C=newGuid()),_saveData(v,S,Hs,C),this.installId=C}else v.purge(Hs)}return Sdk.prototype.getSequenceId=function(){return++this._sequenceId},Sdk}();function canUseLocalStorage(){return void 0===$s&&($s=!!_getVerifiedStorageObject(Gs.LocalStorage)),$s}function _getLocalStorageObject(){return canUseLocalStorage()?_getVerifiedStorageObject(Gs.LocalStorage):null}function _getVerifiedStorageObject(g){var m,S,v=null;try{var C=getGlobal();if(!C)return null;S=new Date,(v=g===Gs.LocalStorage?C.localStorage:C.sessionStorage)&&isFunction(v.setItem)&&(v.setItem(S,S),m=v.getItem(S)!==S,v.removeItem(S),m&&(v=null))}catch(g){v=null}return v}function setStorage(g,m,S){var v=_getLocalStorageObject();if(null!==v)try{return v.setItem(m,S),!0}catch(m){$s=!1,g.throwInternal(be.CRITICAL,Qt.BrowserCannotWriteLocalStorage,"Browser failed write to local storage. "+m)}return!1}function getStorage(g,m){var S=_getLocalStorageObject();if(null!==S)try{return S.getItem(m)}catch(m){$s=!1,g.throwInternal(be.CRITICAL,Qt.BrowserCannotReadLocalStorage,"Browser failed read of local storage. "+m)}return null}!function(g){g[g.LocalStorage=0]="LocalStorage",g[g.SessionStorage=1]="SessionStorage"}(Gs||(Gs={}));var qs=function(){function SessionManager(g,m){var S,v,C=safeGetLogger(g),_=safeGetCookieMgr(g);dynamicProto(SessionManager,this,(function(g){var E=getDefaultConfig(m);function getDefaultConfig(g){return{sessionRenewalMs:g.sessionRenewalMs&&function(){return g.sessionRenewalMs},sessionExpirationMs:g.sessionExpirationMs&&function(){return g.sessionExpirationMs},cookieDomain:g.cookieDomain&&function(){return g.cookieDomain},namePrefix:g.namePrefix&&function(){return g.namePrefix},sessionAsGuid:function(){return g.sessionAsGuid},idLength:function(){return g.idLength?g.idLength:22}}}function _initializeAutomaticSession(){var m=getCookie(v());if(m&&isFunction(m.split))_initializeAutomaticSessionWithData(m);else{var S=getStorage(C,v());S&&_initializeAutomaticSessionWithData(S)}g.automaticSession.getId()||_renew()}function _initializeAutomaticSessionWithData(m){var S=g.automaticSession,v=m.split("|");v.length>0&&S.setId(v[0]);try{if(v.length>1){var _=+v[1];S.acquisitionDate=+new Date(_),S.acquisitionDate=S.acquisitionDate>0?S.acquisitionDate:0}if(v.length>2){var E=+v[2];S.renewalDate=+new Date(E),S.renewalDate=S.renewalDate>0?S.renewalDate:0}}catch(g){C.throwInternal(be.CRITICAL,Qt.ErrorParsingAISessionCookie,"Error parsing ai_session cookie, session will be reset: "+g)}0===S.renewalDate&&C.throwInternal(be.WARNING,Qt.SessionRenewalDateIsZero,"AI session renewal date is 0, session will be reset.")}function _renew(){var m=g.automaticSession,S=(new Date).getTime(),v=g.config.sessionAsGuid();!isUndefined(v)&&v?isBoolean(v)?m.setId(createGuid()):m.setId(createGuid(v)):m.setId(newId(E&&E.idLength?E.idLength():22)),m.acquisitionDate=S,m.renewalDate=S,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate),canUseLocalStorage()||C.throwInternal(be.WARNING,Qt.BrowserDoesNotSupportLocalStorage,"Browser does not support local storage. Session durations will be inaccurate.")}function _setCookie(m,C,E){var T=C+g.config.sessionExpirationMs(),I=E+g.config.sessionRenewalMs(),b=new Date,A=[m,C,E];T<I?b.setTime(T):b.setTime(I);var R=g.config.cookieDomain?g.config.cookieDomain():null;_.set(v(),A.join("|")+";expires="+b.toUTCString(),null,R),S=(new Date).getTime()}function _setStorage(g,m,S){setStorage(C,v(),[g,m,S].join("|"))}isFunction(m.sessionExpirationMs)||(E.sessionExpirationMs=function(){return SessionManager.acquisitionSpan}),isFunction(m.sessionRenewalMs)||(E.sessionRenewalMs=function(){return SessionManager.renewalSpan}),g.config=E,v=function(){return g.config.namePrefix&&g.config.namePrefix()?SessionManager.cookieNameConst+g.config.namePrefix():SessionManager.cookieNameConst},g.automaticSession=new As,g.update=function(){g.automaticSession.getId()||_initializeAutomaticSession();var m=g.automaticSession,v=g.config,C=(new Date).getTime(),_=C-m.acquisitionDate>v.sessionExpirationMs(),E=C-m.renewalDate>v.sessionRenewalMs();if(_||E)_renew();else{(!S||C-S>SessionManager.cookieUpdateInterval)&&(m.renewalDate=C,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate))}},g.backup=function(){var m=g.automaticSession;_setStorage(m.getId(),m.acquisitionDate,m.renewalDate)}}))}return SessionManager.acquisitionSpan=864e5,SessionManager.renewalSpan=18e5,SessionManager.cookieUpdateInterval=6e4,SessionManager.cookieNameConst="ai_session",SessionManager}(),Ws=isString,zs=function(){function TelemetryContext(g,m,S){this.app=new ss(m,S),this.cloud=new as,this.user=new os(g,m,S),this.os=new Cs(m),this.web=new us(m,S),this.sdk=new js(g,S),this.intWeb=new _s(m,S),this.utc=new Ts(m),this.loc=new Is,this.device=new bs,this.telemetryTrace=new Rs(m),this.sessionManager=new qs(S,m),this.session=new As}return TelemetryContext.prototype.getSessionId=function(){var g=this.session;if(g&&Ws(g.customId))return g.customId;var m=this.sessionManager;m.update();var S=m.automaticSession;if(S){var v=S.getId();v&&Ws(v)&&(g.automaticId=v)}return g.automaticId},TelemetryContext.prototype.applyApplicationContext=function(g){var m=this.app;Ws(m.id)&&(g.ext[Bs.AppExt][Ps.id]=m.id),Ws(m.ver)&&(g.ext[Bs.AppExt][Ps.ver]=m.ver),Ws(m.name)&&(g.ext[Bs.AppExt][Ps.appName]=m.name),Ws(m.locale)&&(g.ext[Bs.AppExt][Ps.locale]=m.locale);var S=m.getExpId();Ws(S)&&(g.ext[Bs.AppExt][Ps.expId]=S),Ws(m.env)&&(g.ext[Bs.AppExt][Ps.env]=m.env)},TelemetryContext.prototype.applyUserContext=function(g){var m=this.user,S=m.getLocalId();Ws(S)&&(g.ext[Bs.UserExt][ws.localId]=S),Ws(m.locale)&&(g.ext[Bs.UserExt][ws.locale]=m.locale),Ws(m.id)&&(g.ext[Bs.UserExt][ws.id]=m.id)},TelemetryContext.prototype.applyWebContext=function(g){var m=this.web;Ws(m.domain)&&(g.ext[Bs.WebExt][Ms.domain]=m.domain),Ws(m.browser)&&(g.ext[Bs.WebExt][Ms.browser]=m.browser),Ws(m.browserVer)&&(g.ext[Bs.WebExt][Ms.browserVer]=m.browserVer),Ws(m.screenRes)&&(g.ext[Bs.WebExt][Ms.screenRes]=m.screenRes),g.ext[Bs.WebExt][Ms.userConsent]=m.getUserConsent(),g.ext[Bs.WebExt][Ms.consentDetails]=m.getUserConsentDetails()},TelemetryContext.prototype.applyOsContext=function(g){var m=this.os;Ws(m.name)&&(g.ext[Bs.OSExt][Ds.osName]=m.name),Ws(m.ver)&&(g.ext[Bs.OSExt][Ds.ver]=m.ver)},TelemetryContext.prototype.applySdkContext=function(g){var m=this.sdk;g.ext[Bs.SdkExt][Os.seq]=m.getSequenceId(),g.ext[Bs.SdkExt][Os.epoch]=m.epoch,Ws(m.installId)&&(g.ext[Bs.SdkExt][Os.installId]=m.installId)},TelemetryContext.prototype.applyIntWebContext=function(g){var m=this.intWeb,S=m.getMsfpc();Ws(S)&&(g.ext[Bs.IntWebExt][Ns.msfpc]=S);var v=m.getAnid();Ws(v)&&(g.ext[Bs.IntWebExt][Ns.anid]=v),Ws(m.serviceName)&&(g.ext[Bs.IntWebExt][Ns.serviceName]=m.serviceName)},TelemetryContext.prototype.applyUtcContext=function(g){var m=this.utc;g.ext[Bs.UtcExt][ks.popSample]=m.popSample,m.eventFlags>0&&(g.ext[Bs.UtcExt][ks.eventFlags]=m.eventFlags)},TelemetryContext.prototype.applyLocContext=function(g){g.ext[Bs.LocExt][Ls.tz]=this.loc.tz},TelemetryContext.prototype.applySessionContext=function(g){g.ext[Bs.AppExt][Fs.sessionId]=this.getSessionId()},TelemetryContext.prototype.applyDeviceContext=function(g){var m=this.device;Ws(m.localId)&&(g.ext[Bs.DeviceExt][xs.localId]=m.localId),Ws(m.make)&&(g.ext[Bs.DeviceExt][xs.make]=m.make),Ws(m.model)&&(g.ext[Bs.DeviceExt][xs.model]=m.model),Ws(m.deviceClass)&&(g.ext[Bs.DeviceExt][xs.deviceClass]=m.deviceClass)},TelemetryContext.prototype.applyCloudContext=function(g){var m=this.cloud;Ws(m.role)&&(g.ext[Bs.CloudExt][Us.role]=m.role),Ws(m.roleInstance)&&(g.ext[Bs.CloudExt][Us.roleInstance]=m.roleInstance),Ws(m.roleVer)&&(g.ext[Bs.CloudExt][Us.roleVer]=m.roleVer)},TelemetryContext.prototype.applyAITraceContext=function(g){var m=this.telemetryTrace;Ws(m.traceId)&&(g.ext[Bs.TraceExt][Vs.traceId]=m.traceId),Ws(m.name)&&(g.ext[Bs.TraceExt][Vs.traceName]=m.name),Ws(m.parentId)&&(g.ext[Bs.TraceExt][Vs.parentId]=m.parentId)},TelemetryContext}(),Ks=function(g){function PropertiesPlugin(){var m,S=g.call(this)||this;S.identifier="SystemPropertiesCollector",S.priority=3,S.version="3.1.2";var v={};return dynamicProto(PropertiesPlugin,S,(function(C,_){function _addPropertiesIfAbsent(g,m){g&&objForEachKey(g,(function(g,S){m[g]||(m[g]=S)}))}C.initialize=function(v,_,E){g.prototype.initialize.call(S,v,_,E),m=new zs(v,C._getTelCtx().getExtCfg(C.identifier),_)},C.processTelemetry=function(g,S){setProcessTelemetryTimings(g,C.identifier),S=C._getTelCtx(S);var _=g.ext=g.ext?g.ext:{};g.data=g.data?g.data:{},_[Bs.AppExt]=_[Bs.AppExt]||{},_[Bs.UserExt]=_[Bs.UserExt]||{},_[Bs.WebExt]=_[Bs.WebExt]||{},_[Bs.OSExt]=_[Bs.OSExt]||{},_[Bs.SdkExt]=_[Bs.SdkExt]||{},_[Bs.IntWebExt]=_[Bs.IntWebExt]||{},_[Bs.UtcExt]=_[Bs.UtcExt]||{},_[Bs.LocExt]=_[Bs.LocExt]||{},_[Bs.DeviceExt]=_[Bs.DeviceExt]||{},_[Bs.TraceExt]=_[Bs.TraceExt]||{},_[Bs.CloudExt]=_[Bs.CloudExt]||{},m.applyApplicationContext(g),m.applyUserContext(g),m.applyWebContext(g),m.applyOsContext(g),m.applySdkContext(g),m.applyIntWebContext(g),m.applyUtcContext(g),m.applyLocContext(g),m.applySessionContext(g),m.applyDeviceContext(g),m.applyAITraceContext(g),m.applyCloudContext(g),arrForEach(objKeys(_),(function(g){0===objKeys(_[g]).length&&delete _[g]})),_addPropertiesIfAbsent(v,g.data),C.processNext(g,S)},C.getPropertiesContext=function(){return m},C.setProperty=function(g,m){v[g]=m}})),S}return __extendsFn$2(PropertiesPlugin,g),PropertiesPlugin}(ut);const Js="Skype",Ys="ConfigIDs",Qs="This type of config is not currently supported.",Xs="Ecs Service has not yet responded. Try calling this API again in sometime.",Zs="Possible duplicate call. Ecs already initialized for this confiugration definition.",ea={Public:"https://ic3.events.data.microsoft.com/OneCollector/1.0/",PublicEUDB:"https://eu-ic3.events.data.microsoft.com/OneCollector/1.0/",GccHigh:"https://tb.events.data.microsoft.com/OneCollector/1.0/",Dod:"https://pf.events.data.microsoft.com/OneCollector/1.0/",AirGap08:"https://collector.azure.eaglex.ic.gov/OneCollector/1.0/",AirGap09:"https://collector.azure.microsoft.scloud/OneCollector/1.0/",Enterprise:"https://teams.events.data.microsoft.com/OneCollector/1.0",EnterpriseEUDB:"https://eu-teams.events.data.microsoft.com/OneCollector/1.0"};var ta,ia;!function(g){g.Public="Public",g.GccHigh="GCCHigh",g.Dod="DoD",g.AirGap08="AirGap08",g.AirGap09="AirGap09"}(ta||(ta={})),function(g){g.OrgId="orgid",g.Acs="acs",g.Spool="spool",g.GccHigh="gcch",g.GccHighAcs="gcch-acs",g.Dod="dod",g.DodAcs="dod-acs",g.AirGap08="ag08",g.AirGap08Acs="ag08-acs",g.AirGap09="ag09",g.AirGap09Acs="ag09-acs"}(ia||(ia={}));const na={Public_EcsServer_Url:"https://ecs.communication.microsoft.com",GccHigh_EcsServer_Url:"https://config.ecs.gov.teams.microsoft.us",Dod_EcsServer_Url:"https://config.ecs.dod.teams.microsoft.us",AirGap08_EcsServer_Url:"https://config.ecs.teams.eaglex.ic.go",AirGap09_EcsServer_Url:"https://config.ecs.teams.microsoft.scloud",Enterprise_Ecs_ServerUrl:"https://config.teams.microsoft.com"},ra={Public_ConversationServiceUrl:"https://api.flightproxy.skype.com/api/v2/cpconv",Public_TrouterServiceUrl:"https://go.trouter.communication.microsoft.com/v4/a",Public_RegistrarServiceUrl:"https://prod.registrar.skype.com/v3/registrations",Public_MdnTrapServiceUrl:"https://edge.skype.com/trap",Public_MdnTrapServiceTokenUrl:"https://edge.skype.com/trap/tokens",Public_MdnTrapRelaySkypeFqdns:"worldaz.tr.skype.com",Public_MdnTrapRelayTurnFqdns:"turn.azure.com",Public_MdnTrapRelayTurnUrl:"",GccHigh_ConversationServiceUrl:"https://api.cc.gov.teams.microsoft.us/conv/",GccHigh_TrouterServiceUrl:"https://go.trouter.gov.teams.microsoft.us/v4/a",GccHigh_RegistrarServiceUrl:"https://registrar.gov.teams.microsoft.us/v3/registrations",GccHigh_MdnTrapServiceUrl:"https://trap.gov.teams.microsoft.us",GccHigh_MdnTrapServiceTokenUrl:"https://trap.gov.teams.microsoft.us/tokens",GccHigh_MdnTrapRelaySkypeFqdns:"tr.gov.teams.microsoft.us",GccHigh_MdnTrapRelayTurnFqdns:"turn.gov.teams.microsoft.us",GccHigh_MdnTrapRelayTurnUrl:"https://turn.gov.teams.microsoft.us/relay",Dod_ConversationServiceUrl:"https://api.cc.dod.teams.microsoft.us/conv/",Dod_TrouterServiceUrl:"https://go.trouter.dod.teams.microsoft.us/v4/a",Dod_RegistrarServiceUrl:"https://registrar.dod.teams.microsoft.us/v3/registrations",Dod_MdnTrapServiceUrl:"https://trap.dod.teams.microsoft.us",Dod_MdnTrapServiceTokenUrl:"https://trap.dod.teams.microsoft.us/tokens",Dod_MdnTrapRelaySkypeFqdns:"tr.dod.teams.microsoft.us",Dod_MdnTrapRelayTurnFqdns:"turn.dod.teams.microsoft.us",Dod_MdnTrapRelayTurnUrl:"https://turn.dod.teams.microsoft.us/relay",AirGap08_ConversationServiceUrl:"https://api.cc.skype.com/conv/",AirGap08_TrouterServiceUrl:"https://go.trouter.teams.eaglex.ic.gov/v4/a",AirGap08_RegistrarServiceUrl:"https://api.registrar.teams.eaglex.ic.gov/v3/registrations",AirGap09_ConversationServiceUrl:"https://api.cc.skype.com/conv/",AirGap09_TrouterServiceUrl:"https://go.trouter.teams.microsoft.scloud/v4/a",AirGap09_RegistrarServiceUrl:"https://api.registrar.teams.microsoft.scloud/v3/registrations",Enterprise_ConversationServiceUrl:"https://api.flightproxy.teams.microsoft.com/api/v2/epconv",Enterprise_TrouterServiceUrl:"https://go.trouter.teams.microsoft.com/v4/a",Enterprise_RegistrarServiceUrl:"https://teams.microsoft.com/registrar/prod/v3/registrations",Enterprise_MdnTrapServiceUrl:"https://teams.microsoft.com/trap",Enterprise_MdnTrapServiceTokenUrl:"https://teams.microsoft.com/trap/tokens",Enterprise_MdnTrapRelaySkypeFqdns:"worldaz.relay.teams.microsoft.com",Enterprise_MdnTrapRelayTurnFqdns:"worldaz.relay.teams.microsoft.com",Enterprise_MdnTrapRelayTurnUrl:""};var sa;!function(g){g.Public_ConversationServiceUrl_EUDB="https://api.flightproxy.skype.com/api/v2/cpconv",g.Public_TrouterServiceUrl_EUDB="https://go-eu.trouter.communication.microsoft.com/v4/a",g.Public_RegistrarServiceUrl_EUDB="https://emea.prod.registrar.skype.com/v3/registrations",g.Public_MdnTrapServiceUrl_EUDB="https://edge.skype.com/trap",g.Public_MdnTrapServiceTokenUrl_EUDB="https://edge.skype.com/trap/tokens",g.Public_MdnTrapRelaySkypeFqdns_EUDB="eu.relay.skype.com",g.Public_MdnTrapRelayTurnFqdns_EUDB="eu.relay.skype.com",g.Public_MdnTrapRelayTurnUrl_EUDB="",g.Enterprise_ConversationServiceUrl_EUDB="https://api.flightproxy.teams.microsoft.com/api/v2/epconv",g.Enterprise_TrouterServiceUrl_EUDB="https://go-eu.trouter.teams.microsoft.com/v4/a",g.Enterprise_RegistrarServiceUrl_EUDB="https://teams.microsoft.com/registrar/prod/v3/registrations",g.Enterprise_MdnTrapServiceUrl_EUDB="https://teams.microsoft.com/trap",g.Enterprise_MdnTrapServiceTokenUrl_EUDB="https://teams.microsoft.com/trap/tokens",g.Enterprise_MdnTrapRelaySkypeFqdns_EUDB="euaz.relay.teams.microsoft.com",g.Enterprise_MdnTrapRelayTurnFqdns_EUDB="euaz.relay.teams.microsoft.com",g.Enterprise_MdnTrapRelayTurnUrl_EUDB=""}(sa||(sa={}));const aa={...ra,...na},oa={baseServiceUrl:"https://global.mtgw.prod.communication.microsoft.com/",policyUrlSuffix:"acsmt/v1/useraggregatepolicysettings/",policyUrlSuffixV2:"acsmt/v2/useraggregatepolicysettings/"};var la;!function(g){g.Consumer="consumer",g.Enterprise="enterprise"}(la||(la={}));const ca=["europe","france","germany","norway","switzerland","sweden"],da=["emea","fr","de","se"],ha=Array.from(new Set(ca.concat(["qatar","uae","africa","uk"]))),ua=["asiapacific","india","japan","korea","australia"],ga=["unitedstates","brazil","canada"];var pa,ma;!function(g){g.EU="EU",g.RoW="RoW"}(pa||(pa={})),function(g){g.APAC="APAC",g.NOAM="NOAM",g.EMEA="EMEA",g.UNKNOWN=""}(ma||(ma={}));const fa={AUDIO:{JITTER:{GOOD:30,AVERAGE:75},RTT:{GOOD:200,AVERAGE:350},PACKETS_LOSS_PERCENTAGE:{GOOD:3,AVERAGE:6}},VIDEO:{JITTER:{GOOD:20,AVERAGE:75},RTT:{GOOD:200,AVERAGE:350},PACKETS_LOSS_PERCENTAGE:{GOOD:3,AVERAGE:6}},BANDWIDTH:{GOOD:1500,AVERAGE:500},CALL:{DURATION_IN_SEC:30,GROUP_ID:generateGuid(),AGGREGATION:{INTERVAL:1e3,DATAPOINTS:1},VIDEO_SIZE:{heigth:720,width:1280},MEDIASTREAM_TIMEOUT_IN_SEC:15,CONNECT_TIMEOUT_IN_SEC:10}};var Sa;!function(g){g.AcsOrganizerRole="acsorganizer",g.AcsPresenterRole="acspresenter",g.AcsAttendeeRole="acsattendee",g.AcsConsumerRole="acsconsumer",g.TeamsOrganizer="organizer",g.TeamsAttendee="attendee",g.TeamsPresenter="presenter",g.TeamsCoorganizer="coorganizer"}(Sa||(Sa={}));const va=["airpod","bluetooth","hands-free","stereo","wireless","citrix hdx","remote audio","vmware","built-in","integrated","internal","teams","high definition","facetime","macbook","smartaudio","front","rear","back","iphone","ipad","display","displayport","dp","hdmi","amd","nvidia","intel","analog","digital","dock","line( in| out)?","s/pdif","external","thunderbolt\\d*","usb","panoramic","desktop","capture","cable","cam","virtual","manycam","snap camera","obs","vb-audio","vaio","effect","sink","source","default","test"];let Ca="3617";const getPlatformId=()=>Ca,_a=2e3,ya=5e4,Ea=3e4,Ta=25e3,Ia=6e3,ba=5e3,Aa=1e3,Ra=3,Pa="acs_broadcast_channel",Ma=5e3,wa=500,Da=!1,Oa=500,Na=512,ka=0,La=.4,Fa=200,xa=100,Ua=255,Va=-127,Ba=6e3,Ha=2500,$a=1500,Ga=5e3,ja=12,qa=2e4,Wa=6e4,za=0,Ka=6e3,Ja=100,Ya=4,Qa="4cf9ed87f7dc4e148f77855cd1f2fdca-61fb83a7-6672-4264-806f-7aded29f9b49-7618",Xa="53fdaa090eb946b5a1d6cbdeb4f2ef66-bcbf6380-2590-41cc-ae60-9e467cd51835-7413",Za="1cae5691997646c98b01d15beddae7a3-ce16e198-bc32-420f-ac64-42bb916111af-6865",eo="2efdf03d07594586a5977c404e185186-71b046c4-f48f-4ba7-96d3-2a74b54e1d46-7326",to="708a9eb9fe2646fe8f4c37b7eee2e3da-9b97485a-57b9-43a8-8177-07ca7a653a30-6706",io=7e3,no=10,ro="28:8133db4c-c049-4346-9edd-273f164a9227",so="28:b1902c3e-b9f7-4650-9b23-5772bd429747",ao="ACS-Public",oo="Teams-Public",lo=["en-us"],co=["en"],ho="en-us",uo=10,go="setLanguage",po="transcription",mo=["scheduledMeeting","adhocMeeting"],fo=["28:f4693563-c70b-4e4d-bda6-01792aa21440","28:e32c9418-a835-4eb1-bfb9-733fa74dd6e8"],So=["28:5f2511f1-6da9-41d9-80d9-af7da23a2c27","28:accb0009-8d12-4cfe-969c-39b204e3ed0c"],vo="tlePlayer",Co=256,_o="0.0",yo=!0,Eo=Symbol("global_telemetry_logger"),To=Symbol("global_call_client_index"),Io=107,bo="orgid",Ao="dod",Ro="gcch",Po="8:",Mo="28:",wo="4:",Do=":",Oo="Unknown",No="ACSWeb",ko=Po+(bo+Do),Lo=Po+(Ao+Do),Fo=Po+(Ro+Do),xo=Po+("teamsvisitor"+Do),Uo=Po+("acs"+Do),Vo=Po+("spool"+Do),Bo=Po+("dod-acs"+Do),Ho=Po+("gcch-acs"+Do),$o=Mo+(bo+Do),Go=Mo+(Ro+Do),jo=Mo+(Ao+Do),qo={audioBitrate:{aggregation_needed:!1,raw_data_reduction:!0},videoBitrate:{aggregation_needed:!1,raw_data_reduction:!0},downloadBitrate:{aggregation_needed:!0,multiplier:8,integer:!0,calculation_method:"rate"},bufferLengthInMs:{aggregation_needed:!0},mediaDelayInMs:{aggregation_needed:!0,is_internal:!0},videoHeight:{aggregation_needed:!1,raw_data_reduction:!0},videoWidth:{aggregation_needed:!1,raw_data_reduction:!0},playerHeight:{aggregation_needed:!1,raw_data_reduction:!0,is_internal:!0},playerWidth:{aggregation_needed:!1,raw_data_reduction:!0,is_internal:!0},currentPlayPosition:{aggregation_needed:!1,raw_data_reduction:!0}};var Wo,zo;!function(g){g.GroupCall="joinGroupId",g.GroupChatCall="joinThreadId",g.TeamsCoordinates="joinMeetingCoordinates",g.TeamsMeetingId="joinMeetingId",g.TeamsMeetingLink="joinMeetingLink",g.RoomCall="joinRoom",g.Unknown="Unknown"}(Wo||(Wo={})),function(g){g.Organizer="Organizer",g.Coorganizer="Co-organizer",g.Attendee="Attendee",g.Presenter="Presenter",g.Consumer="Consumer",g.Unknown="Unknown"}(zo||(zo={}));const Ko={"msft-acs-room-deviceType":"room","msft-acs-3proom-deviceType":"3proom","msft-acs-mesh-deviceType":"mesh","msft-acs-mesh-deviceType-v2":"meshV2"};var Jo,Yo;!function(g){g.onlyUsedProxy="onlyUsedProxy",g.onlyUsedNonMsftTurn="onlyUsedNonMsftTurn",g.usedProxyAndNonMsftTurn="usedProxyAndNonMsftTurn",g.noCustomProxyAndTurnUsed="noCustomProxyAndTurnUsed"}(Jo||(Jo={})),function(g){g.RoleRestricted="RoleRestricted",g.FeatureNotSupported="FeatureNotSupported",g.ClientRestricted="ClientRestricted",g.MeetingRestricted="MeetingRestricted",g.UserPolicyRestricted="UserPolicyRestricted",g.NotInitialized="NotInitialized",g.Capable="Capable",g.NotCapable="NotCapable",g.CapabilityNotApplicableForTheCallType="CapabilityNotApplicableForTheCallType"}(Yo||(Yo={}));const Qo="roomsRoleBasedCapabilities",Xo="teamsRoleBasedCapabilities",Zo=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,el=/(\:[0-9]{1,6})(?=$|\/|\?)/;var tl,il;!function(g){g.TeamsProMgmt="TeamsProMgmt"}(tl||(tl={})),function(g){g.Disabled="Disabled",g.DisabledUserOverride="DisabledUserOverride"}(il||(il={}));const nl={Unknown:"Unknown",UsbCamera:"UsbCamera",CaptureAdapter:"CaptureAdapter",Virtual:"Virtual",ScreenSharing:"ScreenSharing"};var rl;function getMriFromIdentifier(g){const m=S.getIdentifierKind(g);switch(m.kind){case rl.communicationUser:return m.communicationUserId;case rl.phoneNumber:if(m.rawId)return`${m.rawId}`;if(m.phoneNumber)return`${wo}${m.phoneNumber}`;throw new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_PHONENUMBER});case rl.microsoftTeamsUser:if(m.rawId)return m.rawId;if(m.microsoftTeamsUserId){if(m.isAnonymous)return`${xo}${m.microsoftTeamsUserId}`;if("public"===m.cloud)return`${ko}${m.microsoftTeamsUserId}`;if("dod"===m.cloud)return`${Lo}${m.microsoftTeamsUserId}`;if("gcch"===m.cloud)return`${Fo}${m.microsoftTeamsUserId}`;if(!m.cloud)return`${ko}${m.microsoftTeamsUserId}`}throw new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_MSFT_TEAMS_USER});case rl.microsoftTeamsApp:if(m.rawId)return m.rawId;if(m.teamsAppId){if("public"===m.cloud)return`${$o}${m.teamsAppId}`;if("dod"===m.cloud)return`${jo}${m.teamsAppId}`;if("gcch"===m.cloud)return`${Go}${m.teamsAppId}`;if(!m.cloud)return`${$o}${m.teamsAppId}`}throw new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_MSFT_TEAMS_APP});case"unknown":return m.id;default:throw new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_IDENTIFIER})}}function constructIdentifierKindFromMri(g){return g.startsWith(ko)?{kind:rl.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(8),isAnonymous:!1,cloud:"public"}:g.startsWith(Lo)?{kind:rl.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(6),isAnonymous:!1,cloud:"dod"}:g.startsWith(Fo)?{kind:rl.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(7),isAnonymous:!1,cloud:"gcch"}:g.startsWith(xo)?{kind:rl.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(15),isAnonymous:!0}:g.startsWith(wo)?{kind:rl.phoneNumber,rawId:g,phoneNumber:g.substring(2)}:g.startsWith(Uo)||g.startsWith(Vo)||g.startsWith(Ho)||g.startsWith(Bo)?{kind:rl.communicationUser,communicationUserId:g}:g.startsWith($o)?{kind:rl.microsoftTeamsApp,rawId:g,teamsAppId:g.substring(9),cloud:"public"}:g.startsWith(Go)?{kind:rl.microsoftTeamsApp,rawId:g,teamsAppId:g.substring(8),cloud:"gcch"}:g.startsWith(jo)?{kind:rl.microsoftTeamsApp,rawId:g,teamsAppId:g.substring(7),cloud:"dod"}:{kind:rl.unknown,id:g}}function isCallingApplication(g){return!!g.startsWith(Mo)}function isGlobalCallingApplication(g){return!(!g.startsWith(Mo)||g.startsWith($o)||g.startsWith(jo)||g.startsWith(Go))}function validateIdentifier(g){const m=S.getIdentifierKind(g);switch(m.kind){case rl.communicationUser:if(!(m.communicationUserId.startsWith(Uo)||m.communicationUserId.startsWith(Vo)||m.communicationUserId.startsWith(Ho)||m.communicationUserId.startsWith(Bo)))throw new CallingCommunicationError({defaultError:D.IDENTIFIER.INVALID_COMM_USER});return m;case"phoneNumber":return m;case rl.microsoftTeamsUser:if(m.rawId&&!m.rawId.startsWith(ko)&&!m.rawId.startsWith(Lo)&&!m.rawId.startsWith(Fo)&&!m.rawId.startsWith(xo))throw new CallingCommunicationError({defaultError:D.IDENTIFIER.INVALID_MSFT_TEAMS_USER_RAWID});if(!m.microsoftTeamsUserId)throw new CallingCommunicationError({defaultError:D.IDENTIFIER.INVALID_MSFT_TEAMS_USER_USERID});return m;case rl.microsoftTeamsApp:if(m.rawId&&!m.rawId.startsWith(Mo))throw new CallingCommunicationError({defaultError:D.IDENTIFIER.INVALID_MSFT_TEAMS_APP_RAWID});if(!m.teamsAppId)throw new CallingCommunicationError({defaultError:D.IDENTIFIER.INVALID_MSFT_TEAMS_APP_APPID});return m;case rl.unknown:if(!m.id)throw new CallingCommunicationError({defaultError:D.IDENTIFIER.INVALID_UNKNOWN_IDENTIFIER});return m;default:throw new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_INVALID_IDENTIFIER})}}function assertIsArrayOfIdentifiers(g){if(!(g instanceof Array))throw new CallingCommunicationError({defaultError:D.IDENTIFIER.INVALID_IDENTIFIER_ARRAY})}function getCloudTypeFromSkypeId(g){const m=g.substring(0,g.indexOf(":"));if(!m)throw new CallingCommunicationError({defaultError:D.IDENTIFIER.NO_CLOUD_PREFIX_FOUND});switch(m){case ia.OrgId:case ia.Acs:case ia.Spool:return ta.Public;case ia.GccHigh:case ia.GccHighAcs:return ta.GccHigh;case ia.Dod:case ia.DodAcs:return ta.Dod;case ia.AirGap08:case ia.AirGap08Acs:return ta.AirGap08;case ia.AirGap09:case ia.AirGap09Acs:return ta.AirGap09;default:return ta.Public}}!function(g){g.communicationUser="communicationUser",g.microsoftTeamsUser="microsoftTeamsUser",g.microsoftTeamsApp="microsoftTeamsApp",g.phoneNumber="phoneNumber",g.unknown="unknown",g.group="group"}(rl||(rl={}));const sl="1.23.1.0_stable",al="1.23.1";function getSdkInternalVersion(){const g="ACS_CLIENT_INTERNAL_SZK_VERSION".replace("Z","D");return sl===g?"1.0.0.0":sl}function getSdkVersion(){const g="ACS_CLIENT_SZK_VERSION".replace("Z","D");return al===g?"1.0.0.0":al}function getDateInIsoFormat(){return(new Date).toISOString()}function arrayMergeCustomizer(g,m){if(Array.isArray(g))return m.slice()}function isNonEmptyArray(g){return Array.isArray(g)&&0!==g.length}function isNullOrUndefined$2(g){return null==g||void 0===g}function valueOrDefault(g,m){return void 0!==g?g:m}function isPromiseLike(g){return!!g&&"function"==typeof g.then}function safeJsonStringify(g){try{return JSON.stringify(g,null,2)}catch(m){return`failed to stringify obj ${g}`}}function isIpv4Address(g){return new RegExp(Zo).test(g)}const ol={telemetry:{callStatsFlushTimeout:Ia,discardedTelemetryRetryTimeout:ba,discardedEventsBufferMaxLength:Aa,discardedEventsMaxRetries:Ra,telemetryFlushTimeout:_a,allowedEvents:[],blockedEvents:["acs_calling_feature_usage","acs_calling_call_client_init"],blockedKindOfEvents:[{name:"acs_calling_token_expiration_changed",kindOfEvents:["attempt","success"]}],limit:{outSideCall:{enabled:!1,deltaTimeInMs:15e3,includedEvents:[],excludedEvents:[]},rates:[]},telemetryBeforeUnload:!1,gzipTelemetryPayload:!0,localStorageEnable:!1,mediaStatsConfig:{enabled:!0,throttleTelemetry:1,aggregationInterval:10,dataPointsPerAggregation:6,metricsProperties:{},dataToSend:{raw:!1,min:!0,max:!0,sum:!0,count:!0}},liveStreamStatsConfig:{enabled:!1,fetchInterval:1,aggregationInterval:10,dataPointsPerAggregation:6,pollingMethod:"interval",additionalStats:{},dataToSend:{raw:!1,min:!0,max:!0,sum:!0,count:!0}},reportSdkUaToService:!1,reportEnvToService:!1,sendNetworkChangedTelemetry:!1,deviceChangedEvents:{enabled:!1,piiSafeWordsMode:"merge",piiSafeWords:va},maxExistingReportedParticipants:25},mediaStats:{blockMetrics:{},transformMetrics:{},fetchInterval:1,aggregationInterval:10,dataPointsPerAggregation:6,pollingMethod:"interval",timerThrottlingFilter:{enabled:!1,delayRatio:0,filterRange:{"audio.send":{bitrate:{min:0,max:535500},packetsPerSecond:{min:0,max:200},packetsLostPerSecond:{min:0,max:200}},"audio.receive":{bitrate:{min:0,max:535500},packetsPerSecond:{min:0,max:200},packetsLostPerSecond:{min:0,max:200}},"video.send":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateInput:{min:0,max:66},frameRateEncoded:{min:0,max:66},frameRateSent:{min:0,max:66}},"video.receive":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateOutput:{min:0,max:66},frameRateDecoded:{min:0,max:66},frameRateReceived:{min:0,max:66}},"screenShare.send":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateInput:{min:0,max:33},frameRateEncoded:{min:0,max:33},frameRateSent:{min:0,max:33}},"screenShare.receive":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateOutput:{min:0,max:33},frameRateDecoded:{min:0,max:33},frameRateReceived:{min:0,max:33}}}}},debugInfo:{broadcastChannelName:Pa,tabsBroadcastDelay:Ma,tabsUpdateDelay:wa,enableLogDump:Da,maxLogDumpLength:Oa,includeList:[],excludeList:[]},volumeIndicator:{fftSize:Na,minDecibels:Va,maxDecibels:ka,smoothingConstant:La,microphoneVolumeSampleIntervalMs:Fa,normalisedMaxVolume:xa,maxAvailableVolume:Ua},telemetryEvents:{eventNameToPriority:{eventName:["acs_calling_call_stats"],priority:[Jt.Immediate]}},rendering:{remoteVideo:{createViewTimeout:Ba,createViewUnsubscribeTimeout:Ha,debounceTimeout:$a,createViewSendMediaStats:!0,createViewSendMediaStatsMaxLength:120,createViewSendMediaStatsInitialMaxLength:1,createViewFailureNetworkUfdCheckWindowInMs:2e3,forceCheckIfVideoWasAttachedToDom:!0,checkIfVideoAttachedToDom_poll:!0,checkIfVideoAttachedToDom_intervalTime:Ga,checkIfVideoAttachedToDom_intervalMaxTries:ja,checkIfVideoAttachedToDom_timeout:qa,createViewSenderStatsDuration:Wa,registeredViewIdsMaxLength:za,getMediaStreamTimeout:Ka,largeMeeting:{handleVideoRendering:!0,participantCountThreshold:Ja,dominantSpeakersWithVideoOn_topCount:Ya}}},captions:{acsBotMri:ro,teamsBotMri:so,clientInfo:ao,availableLanguages:lo,enabled:!0,acs:{botMri:ro,clientInfo:{ring:ao},spokenLanguages:{enabled:!0,languages:lo}},teams:{botMri:so,clientInfo:{ring:oo},spokenLanguages:{enabled:!0,languages:lo},captionLanguages:{enabled:!1,languages:co}}},audioEffects:{enableAudioEffects:!1},videoEffects:{enableVideoEffects:!1,effectInitTimeThresholdInMs:2e4,fpsWarningThreshold:5,waitTimeToInitiateFpsChecksInMs:2e4,fpsCheckIntervalTimeInMs:3e3},calling:{enableMuteOthers:!0,enableSmePassFakeConversation:!1,doNotWaitForTrouter:!1,hangUpCallOnPageHide:!1,maxNumberOfTokenFetchRetries:10,deviceSelectionTimeoutInMs:3e3,deviceNotFunctioningMuted:!0,muteUnmuteOnMicrophoneNotFunctioning:!1,unmuteDelayForMicrophoneNotFunctioningInMs:0,preventStopAudio:!1,preventFakeMute:!1,osAutoRecoverAudio:!1,deviceCaptureMuteRecover:!1,allowMuteOnBadUfd:!0,preventStopVideo:!0,mediaMetricsDeviceEventsEnabled:!1,allowAccessRawMediaStream:!1,applyViewLimit:!1,deviceCaptureMutedVideo:!0,removeLvsCheckOnCallStartAndCallAccept:!1,removeLocalAudioStreamCheckOnCallStartAndCallAccept:!1,constraints:{enabled:!1,maxOutgoingResolution:0,maxOutgoingFrameRate:0,maxOutgoingVideoBitrate:0},supportLiveStreaming:!1,liveStreamingBotIds:fo,composedStreamBotIds:So,setDeviceType:!1,devicePermissions:{splitAskAudioVideo:!1,timeoutInBetween:0,getCurrentState:!0},applicationSettingsUrls:{Public_ConversationServiceUrl:aa.Public_ConversationServiceUrl,Public_TrouterServiceUrl:aa.Public_TrouterServiceUrl,Public_RegistrarServiceUrl:aa.Public_RegistrarServiceUrl,Public_MdnTrapServiceUrl:aa.Public_MdnTrapServiceUrl,Public_MdnTrapServiceTokenUrl:aa.Public_MdnTrapServiceTokenUrl,Public_MdnTrapRelaySkypeFqdns:aa.Public_MdnTrapRelaySkypeFqdns,Public_MdnTrapRelayTurnFqdns:aa.Public_MdnTrapRelayTurnFqdns,Public_MdnTrapRelayTurnUrl:aa.Public_MdnTrapRelayTurnUrl,GccHigh_ConversationServiceUrl:aa.GccHigh_ConversationServiceUrl,GccHigh_TrouterServiceUrl:aa.GccHigh_TrouterServiceUrl,GccHigh_RegistrarServiceUrl:aa.GccHigh_RegistrarServiceUrl,GccHigh_MdnTrapServiceUrl:aa.GccHigh_MdnTrapServiceUrl,GccHigh_MdnTrapServiceTokenUrl:aa.GccHigh_MdnTrapServiceTokenUrl,GccHigh_MdnTrapRelaySkypeFqdns:aa.GccHigh_MdnTrapRelaySkypeFqdns,GccHigh_MdnTrapRelayTurnFqdns:aa.GccHigh_MdnTrapRelayTurnFqdns,GccHigh_MdnTrapRelayTurnUrl:aa.GccHigh_MdnTrapRelayTurnUrl,Dod_ConversationServiceUrl:aa.Dod_ConversationServiceUrl,Dod_TrouterServiceUrl:aa.Dod_TrouterServiceUrl,Dod_RegistrarServiceUrl:aa.Dod_RegistrarServiceUrl,Dod_MdnTrapServiceUrl:aa.Dod_MdnTrapServiceUrl,Dod_MdnTrapServiceTokenUrl:aa.Dod_MdnTrapServiceTokenUrl,Dod_MdnTrapRelaySkypeFqdns:aa.Dod_MdnTrapRelaySkypeFqdns,Dod_MdnTrapRelayTurnFqdns:aa.Dod_MdnTrapRelayTurnFqdns,Dod_MdnTrapRelayTurnUrl:aa.Dod_MdnTrapRelayTurnUrl,AirGap08_ConversationServiceUrl:aa.AirGap08_ConversationServiceUrl,AirGap08_TrouterServiceUrl:aa.AirGap08_TrouterServiceUrl,AirGap08_RegistrarServiceUrl:aa.AirGap08_RegistrarServiceUrl,AirGap09_ConversationServiceUrl:aa.AirGap09_ConversationServiceUrl,AirGap09_TrouterServiceUrl:aa.AirGap09_TrouterServiceUrl,AirGap09_RegistrarServiceUrl:aa.AirGap09_RegistrarServiceUrl,Enterprise_ConversationServiceUrl:aa.Enterprise_ConversationServiceUrl,Enterprise_TrouterServiceUrl:aa.Enterprise_TrouterServiceUrl,Enterprise_RegistrarServiceUrl:aa.Enterprise_RegistrarServiceUrl,Enterprise_MdnTrapServiceUrl:aa.Enterprise_MdnTrapServiceUrl,Enterprise_MdnTrapServiceTokenUrl:aa.Enterprise_MdnTrapServiceTokenUrl,Enterprise_MdnTrapRelaySkypeFqdns:aa.Enterprise_MdnTrapRelaySkypeFqdns,Enterprise_MdnTrapRelayTurnFqdns:aa.Enterprise_MdnTrapRelayTurnFqdns,Enterprise_MdnTrapRelayTurnUrl:aa.Enterprise_MdnTrapRelayTurnUrl},applicationSettingsEudbUrls:{Public_ConversationServiceUrl_EUDB:sa.Public_ConversationServiceUrl_EUDB,Public_TrouterServiceUrl_EUDB:sa.Public_TrouterServiceUrl_EUDB,Public_RegistrarServiceUrl_EUDB:sa.Public_RegistrarServiceUrl_EUDB,Public_MdnTrapServiceUrl_EUDB:sa.Public_MdnTrapServiceUrl_EUDB,Public_MdnTrapServiceTokenUrl_EUDB:sa.Public_MdnTrapServiceTokenUrl_EUDB,Public_MdnTrapRelaySkypeFqdns_EUDB:sa.Public_MdnTrapRelaySkypeFqdns_EUDB,Public_MdnTrapRelayTurnFqdns_EUDB:sa.Public_MdnTrapRelayTurnFqdns_EUDB,Public_MdnTrapRelayTurnUrl_EUDB:sa.Public_MdnTrapRelayTurnUrl_EUDB,Enterprise_ConversationServiceUrl_EUDB:sa.Enterprise_ConversationServiceUrl_EUDB,Enterprise_TrouterServiceUrl_EUDB:sa.Enterprise_TrouterServiceUrl_EUDB,Enterprise_RegistrarServiceUrl_EUDB:sa.Enterprise_RegistrarServiceUrl_EUDB,Enterprise_MdnTrapServiceUrl_EUDB:sa.Enterprise_MdnTrapServiceUrl_EUDB,Enterprise_MdnTrapServiceTokenUrl_EUDB:sa.Enterprise_MdnTrapServiceTokenUrl_EUDB,Enterprise_MdnTrapRelaySkypeFqdns_EUDB:sa.Enterprise_MdnTrapRelaySkypeFqdns_EUDB,Enterprise_MdnTrapRelayTurnFqdns_EUDB:sa.Enterprise_MdnTrapRelayTurnFqdns_EUDB,Enterprise_MdnTrapRelayTurnUrl_EUDB:sa.Enterprise_MdnTrapRelayTurnUrl_EUDB},maxDisplayNameLength:256,callDiagnostics:fa,eudb:{isEnabled:!0,countries:ca,regions:da,defaultDataLocationEurope:!1,EmeaTenants:ha,ApacTenants:ua,NoamTenants:ga,acsCompliantEvents:{},isRgnClaimEnabledForACS:!0,sendRegionToNgc:!0},tfl:{isEnabled:!1,hosts:["teams.live.com"]},lobbyAdmitAndReject:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},localRecording:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},enableCustomTurnUsage:!1,allowProxyForTeamsCalls:!1,allowCustomTurnForTeamsCalls:!1,spotlight:{enabled:!0,maxSpotlightParticipants:7,supportedRoles:["presenter","organizer","coorganizer"],meetingTypes:["scheduledMeeting"]},teamsMeetingAudioConferencing:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},transfer:{autoAccept:!0},reaction:{enabled:!0,telemetryEventAggregationIntervalInSecond:3,enableStateServiceConsoleLogs:!0,StateServiceProxySettings:{batchedRequestsEnabled:!1,websocketAliveTimeAfterLoseFocusInMS:3e4,pingTimeoutInMs:2e4,pongTimeoutInMs:5e3,maxSessionRetries:2,offlineMessageCacheEnabled:!0,maxOfflineMessageCacheLength:64,maxOfflineMessageCacheTimeInMs:2e4,autoRoutingEnabled:!0}},pptlive:{enabled:!0,wdParams:{wdModernSlideShowInTeams:!0,wdPresenterViewInTeams:!1,wdForceModernSlideShowInTeams:!1,isMovePrivateViewingToPPTEnabled:!0},appSettings:{takeFocusOnBoot:!0,enableAdvanceOnClick:!1,enableAdvanceOnTap:!1},stateServiceProxySettings:{batchedRequestsEnabled:!1,maxRoundtripRaw:300,pingTimeoutInMs:15e3,pongTimeoutInMs:15e3,retryIntervalsInMs:[1e3,2e3,4e3],verbose:!1,websocketAliveTimeAfterLoseFocusInMS:3e4,autoRoutingEnabled:!0,useServiceGeneratedClientId:!0,offlineMessageCacheEnabled:!0,maxOfflineMessageCacheTimeInMs:2e4,maxOfflineMessageCacheLength:64,allowReconnectOnSendMessage:!0},enableStateServiceInPreviewerFeatures:'["Ink","Media","Nav","NavSync","PresUrl","PresUrlBoot"]',featureGates:'{"ModernSlideShowAllowListForFileType":"pptx;ppsx;potx;pptm;ppsm;pot;ppt;odp;pps"}'},blacklistedBots:[],musicOnHoldEnabled:!0},dataChannel:{maxReceiveBufferSize:2097152,receiveTimeoutInMs:12e4,maxSendBandwidth:5e5,maxBroadcastPacketRate:80,defaultBitrate:32e3,maxMessageSize:32768,enableBroadcastLimitOnReliableChannel:!1,dataIdConfigs:[]},unmixedAudio:{maxStreamSize:7,operationTimeoutInMs:1e4,skipProviderStateCheck:!1},roles:{acsOrganizer:Sa.AcsOrganizerRole,acsPresenter:Sa.AcsPresenterRole,acsAttendee:Sa.AcsAttendeeRole,acsConsumer:Sa.AcsConsumerRole,teamsAttendee:Sa.TeamsAttendee,teamsOrganizer:Sa.TeamsOrganizer,teamsPresenter:Sa.TeamsPresenter,teamsCoorganizer:Sa.TeamsCoorganizer},roomsRoleBasedCapabilities:{presenter:getDefaultCapabilities("roomJoin","Presenter"),attendee:getDefaultCapabilities("roomJoin","Attendee"),consumer:getDefaultCapabilities("roomJoin","Consumer")},teamsRoleBasedCapabilities:{organizer:getDefaultCapabilities("teamsMeetingJoin","Organizer"),coorganizer:getDefaultCapabilities("teamsMeetingJoin","Co-organizer"),presenter:getDefaultCapabilities("teamsMeetingJoin","Presenter"),attendee:getDefaultCapabilities("teamsMeetingJoin","Attendee")},environments:{android:{chrome:{minVersion:_o,isSupportedOnSdkVersion:yo},edgeanaheim:{minVersion:_o,isSupportedOnSdkVersion:yo}},ios:{safari:{minVersion:_o,isSupportedOnSdkVersion:yo},chrome:{minVersion:_o,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")},applewebview:{minVersion:_o,isSupportedOnSdkVersion:yo}},mac:{chrome:{minVersion:_o,isSupportedOnSdkVersion:yo},safari:{minVersion:_o,isSupportedOnSdkVersion:yo},edgeanaheim:{minVersion:_o,isSupportedOnSdkVersion:yo},firefox:{minVersion:_o,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")}},windows:{chrome:{minVersion:_o,isSupportedOnSdkVersion:yo},chromium:{minVersion:_o,isSupportedOnSdkVersion:yo},edgeanaheim:{minVersion:_o,isSupportedOnSdkVersion:yo},firefox:{minVersion:_o,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")}},linux:{chrome:{minVersion:_o,isSupportedOnSdkVersion:yo},firefox:{minVersion:_o,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")}}},MiddleTier:{enabled:!1,maxRetry:3,baseServiceUrl:oa.baseServiceUrl,policyUrlSuffix:oa.policyUrlSuffix,policyUrlSuffixV2:oa.policyUrlSuffixV2,userPolicySettingsApi:!1},PowerPointStateServiceUrl:{public:{amer:"https://usc.pptservicescast.officeapps.live.com",apac:"https://apac.pptservicescast.officeapps.live.com",emea:"https://emea.pptservicescast.officeapps.live.com",uk:"https://ukc.pptservicescast.officeapps.live.com",eu:"https://euc.pptservicescast.officeapps.live.com",in:"https://inc.pptservicescast.officeapps.live.com",au:"https://auc.pptservicescast.officeapps.live.com",ca:"https://canc.pptservicescast.officeapps.live.com",fr:"https://fr.pptservicescast.officeapps.live.com",jp:"https://jpc.pptservicescast.officeapps.live.com",ae:"https://ae.pptservicescast.officeapps.live.com",kr:"https://krc.pptservicescast.officeapps.live.com",sg:"https://sg.pptservicescast.officeapps.live.com",za:"https://za.pptservicescast.officeapps.live.com",de:"https://de.pptservicescast.officeapps.live.com",ch:"https://ch.pptservicescast.officeapps.live.com",no:"https://no.pptservicescast.officeapps.live.com",br:"https://pptservicescast.officeapps.live.com",se:"https://se.pptservicescast.officeapps.live.com",qa:"https://qa.pptservicescast.officeapps.live.com",gallatin:"https://pptservicescast.osi.microsoftonline.cn",pl:"https://pl.pptservicescast.officeapps.live.com",it:"https://euc.pptservicescast.officeapps.live.com",il:"https://pptservicescast.officeapps.live.com",mx:"https://pptservicescast.officeapps.live.com"},gcc:"https://pptservicescast.gcc.osi.office365.us",gcch:"https://pptservicescast.osi.office365.us",dod:"https://pptservicescast.osi.apps.mil",ag08:"https://pptservicescast.osi.eaglex.ic.gov",ag09:"https://pptservicescast.osi.microsoft.scloud"}};let ll;function setAcsEcsConfig(g){if(!g)throw new CallingCommunicationError({defaultError:D.INTERNAL.ECS_CONFIG_EMPTY});if(!g.AcsCallingSDKWeb)throw new CallingCommunicationError({defaultError:D.INTERNAL.ECS_CONFIG_MISSING_ACS});try{const m=ol.telemetry.deviceChangedEvents.piiSafeWords.slice();P.mergeWith(ol,g.AcsCallingSDKWeb,arrayMergeCustomizer);const S=ol.telemetry.deviceChangedEvents;"merge"===S.piiSafeWordsMode&&(S.piiSafeWords=P.union(m,S.piiSafeWords))}catch(g){throw new CallingCommunicationError({defaultError:D.INTERNAL.ECS_CONFIG_MERGING_ERROR})}}function getAcsEcsConfig(){return ol}function setMediaConfig(g){ll=g}function getMediaConfig(){return ll}function getDefaultCapabilities(g,m){let S={turnVideoOn:!0,unmuteMic:!0,shareScreen:!0,removeParticipant:!0,hangUpForEveryOne:!0,addCommunicationUser:!0,addTeamsUser:!0,addPhoneNumber:!0,manageLobby:!0,spotlightParticipant:!0,removeParticipantsSpotlight:!0,blurBackground:!0,startLiveCaptions:!0,stopLiveCaptions:!0,raiseHand:!0,pstnDialOut:!0,muteOthers:!0,useReactions:!0,viewAttendeeNames:!0};if("teamsMeetingJoin"==g){if("Presenter"==m||"Co-organizer"==m||"Organizer"==m)return{...S};if("Attendee"==m){let g={...S};return g.removeParticipant=!1,g.manageLobby=!1,g.spotlightParticipant=!1,g.removeParticipantsSpotlight=!1,g.shareScreen=!1,g.muteOthers=!1,g}}if("roomJoin"==g){let g={...S};if(g.removeParticipant=!1,g.hangUpForEveryOne=!1,g.addCommunicationUser=!1,g.addTeamsUser=!1,g.manageLobby=!1,g.spotlightParticipant=!1,g.removeParticipantsSpotlight=!1,g.blurBackground=!1,g.startLiveCaptions=!1,g.stopLiveCaptions=!1,g.raiseHand=!1,"Presenter"==m)return{...g};if("Attendee"==m){let m={...g};return m.shareScreen=!1,m.muteOthers=!1,m.addPhoneNumber=!1,m.pstnDialOut=!1,m}if("Consumer"==m){let m={...g};return m.turnVideoOn=!1,m.unmuteMic=!1,m.shareScreen=!1,m.muteOthers=!1,m.addPhoneNumber=!1,m.pstnDialOut=!1,m}}return S}const cl=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","phrase","subCode","reason"];function toTsScalingMode(g){switch(g){case"Crop":return 1;case"Fit":return 2;default:return 0}}function stringifyObject(g){return g.toString===Object.prototype.toString?JSON.stringify(g):g.toString()}function getSizeInBytes(g,m){try{return"string"==typeof g?new Blob([g]).size:g.byteLength}catch(g){return m.error(g),0}}function shallowEqual(g,m){const S=Object.keys(g);for(let v of S)if(g[v]!==m[v])return!1;return!0}function convertMapToFrozenJson(g){let m={};return g.forEach(((g,S)=>{m[S]=g})),Object.freeze(m)}function defer(){let g,m,S=!0;return{isPending:()=>S,promise:new Promise(((S,v)=>{g=S,m=v})),resolve:m=>{S&&(g(m),S=!1)},reject:g=>{S&&(m(g),S=!1)},dispose:()=>{S&&(m("disposed"),S=!1)}}}function timedDefer(g,m="Timed promise; rejected."){let S,v,C,_=!0;const timerStart=()=>{C=window.setTimeout((()=>{v(new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.EFFECT_PROVIDER_TIMEOUT}))}),g)},timerStop=()=>{window.clearTimeout(C)};let E=new Promise(((g,m)=>{S=m=>{timerStop(),_=!1,g(m)},v=g=>{timerStop(),_=!1,m(g)}}));return{timerStart:timerStart,timerStop:timerStop,deferredPromise:{promise:E,resolve:S,reject:v,isPending:()=>_,dispose:()=>{v("disposed")}}}}function assertNotNull(g,m){if(null==g)throw new CallingCommunicationError({defaultError:m})}function assertIsObject(g,m){if("object"!=typeof g)throw new CallingCommunicationError({defaultError:m})}function parseJWT(g){let[,m]=g?.split(".");if(void 0===m)throw new CallingCommunicationError({defaultError:D.INTERNAL.TOKEN_PAYLOAD_UNDEFINED});return m=m.replace(/-/g,"+").replace(/_/g,"/"),JSON.parse(decodeURIComponent(escape(atob(m))))}function logErrorAndThrow(g,m){throw m.error(`CallingCommunicationError: Message={${g.message},Code={${g.code}}, SubCode={${g.subCode}}, ResultCategories={${g.resultCategories}}`),new CallingCommunicationError({defaultError:g})}function noop(){}function isEudbLocation(g,m){const S=getGeoLocations(g);return!!m&&!!S.find((g=>g===m))}function isEudbConfigurationsApplicable(g,m){return getAcsEcsConfig().calling.eudb.isEnabled&&isEudbLocation(g,m||"")}function isRgnClaimApplicable(g){return getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS||!!g&&g===la.Enterprise||!1}function getGeoLocations(g){return isRgnClaimApplicable(g)?getAcsEcsConfig().calling.eudb.regions:getAcsEcsConfig().calling.eudb.countries}async function parseTokenCredential(g,m,S){let v;try{if(!g)throw new CallingCommunicationError({defaultError:D.INTERNAL.NO_TOKEN_PROVIDED});try{v=(await g.getToken(S))?.token}catch(g){throw new CallingCommunicationError("The token returned from the tokenRefresher is expired."===g.message?{defaultError:D.CALL_AGENT.ACCESSTOKEN_EXPIRED}:{defaultError:D.INTERNAL.GET_TOKEN})}if(!v)throw new CallingCommunicationError({defaultError:D.INTERNAL.EMPTY_TOKEN})}catch(g){throw new CallingCommunicationError({defaultError:D.INTERNAL.GET_TOKEN,originalError:g})}try{let g=parseJWT(v);if(!g)throw new CallingCommunicationError({defaultError:D.INTERNAL.TOKEN_UNDEFINED});if("string"!=typeof g.acsScope)throw new CallingCommunicationError({defaultError:D.INTERNAL.INVALID_TOKEN_SCOPE_FORMAT});if(!g.acsScope.split(",").find((g=>"voip"===g||"voip.join"===g)))throw new CallingCommunicationError({defaultError:D.INTERNAL.INVALID_TOKEN_SCOPE});const S=g.resourceId,C=constructIdentifierKindFromMri(`8:${g.skypeid}`);if(!S&&!("microsoftTeamsUser"===C?.kind))throw new CallingCommunicationError({defaultError:D.INTERNAL.RESOURCE_NOT_FOUND_IN_TOKEN});let _=g.skypeid;if(!_)throw new CallingCommunicationError({defaultError:D.INTERNAL.USERID_NOT_FOUND_IN_TOKEN});const E=getCloudTypeFromSkypeId(_),T=!!g.tid,I=!!g.rgn;return{jwtToken:v,acsResourceId:S,identityMri:_,cloudType:E,isCte:T,region:(T||m?g.rgn:g.resourceLocation)||"",rgnClaimExists:I,exp:1e3*g.exp}}catch(g){throw new CallingCommunicationError({defaultError:D.INTERNAL.PARSE_TOKEN_FAIL,originalError:g})}}function buildCallingUserAgent(g,m,S){const v=`azsdk-js-communication-calling/${g}`;let C="";if(S?.diagnostics?.appName){let g=S?.diagnostics?.appName.trim().replace(/\s/g,"_");g.length>64&&(m.warn("appName is too long, max allowed length is 64 chars, appName was truncated to max length"),g=g.substr(0,64)),C+=g?`${g}/`:"default/"}else C+="default/";if(S?.diagnostics?.appVersion){let g=S?.diagnostics?.appVersion.trim().replace(/\s/g,"_");g.length>64&&(m.warn("appVersion is too long, max allowed length is 64 chars, appVersion was truncated to max length"),g=g.substr(0,64)),C+=g||"0.0.0"}else C+="0.0.0";if(C+=` ${v}`,S?.diagnostics?.tags&&Array.isArray(S?.diagnostics?.tags)&&S?.diagnostics?.tags.length>0){let g=S?.diagnostics?.tags.map((g=>g.trim().replace(/\s/g,"_"))).filter((g=>!!g)).join(";");g.length>128&&(m.warn("tags are too long, max allowed length is 128 chars, tags were truncated to max length"),g=g.substr(0,128)),g.length>0&&(C+=" ("+g+").")}return C}function getJoinContextDescription(g){return g?g.groupId?Wo.GroupCall:!g.threadId||g.organizerId||g.tenantId||g.messageId?g.threadId&&g.organizerId&&g.tenantId&&g.messageId?Wo.TeamsCoordinates:g.meetingId?Wo.TeamsMeetingId:g.meetingLink?Wo.TeamsMeetingLink:g.roomId?Wo.RoomCall:Wo.Unknown:Wo.GroupChatCall:Wo.Unknown}function getPrintableObject(g,m=!1){const processStackTrace=g=>{try{return g.split("\n")[0]}catch(g){return"invalid stack"}};if(void 0===g)return"void";if(g instanceof Error)return g.toString();if(g instanceof String||g instanceof Number||g instanceof Boolean)return g.toString();try{return g.stack&&(g.stack=processStackTrace(g.stack)),(m?JSON.stringify(g):JSON.stringify(g,cl,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(m){return`failed to get error information:${g&&"function"==typeof g.toString&&g.toString()} ${g&&g.response&&JSON.stringify(g.response)}`}}function permissionStateToBool(g,m){return m.info("permission state to boolean",g),"granted"===g}function getSafeObjectDiff(g,m,S=[]){let v=[];try{const C=Array.isArray(g);for(const _ in g){const E=g[_],T=C?+_:_;if(!(_ in m)){v.push({type:"REMOVE",path:[T],oldValue:g[_]});continue}const I=m[_],b="object"==typeof E&&"object"==typeof I;if(E&&I&&b&&!U[Object.getPrototypeOf(E).constructor.name]&&!S.includes(E)){const g=getSafeObjectDiff(E,I);v.push.apply(v,g.map((g=>(g.path.unshift(T),g))))}else E===I||b&&(isNaN(E)?E+""==I+"":+E==+I)||v.push({path:[T],type:"CHANGE",value:I,oldValue:E})}const _=Array.isArray(m);for(const S in m)S in g||v.push({type:"CREATE",path:[_?+S:S],value:m[S]})}catch(g){}return v}function advancedMeetingRoleToParticipantRole(g,m){const S={[g.roles.acsOrganizer.toLowerCase()]:zo.Organizer,[g.roles.teamsOrganizer.toLowerCase()]:zo.Organizer,[g.roles.acsPresenter.toLowerCase()]:zo.Presenter,[g.roles.teamsPresenter.toLowerCase()]:zo.Presenter,[g.roles.acsAttendee.toLowerCase()]:zo.Attendee,[g.roles.teamsAttendee.toLowerCase()]:zo.Attendee,[g.roles.acsConsumer.toLowerCase()]:zo.Consumer,[g.roles.teamsCoorganizer.toLowerCase()]:zo.Coorganizer};return m&&S[m.toString().toLowerCase()]?S[m.toString().toLowerCase()]:zo.Unknown}function hasMeetingDetailsChanged(g,m){return null==m.meetingCapability&&null!=g.meetingCapability||(null==m.capabilities&&null!=g.capabilities||!(P.isEqual(m.capabilities,g.capabilities)&&P.isEqual(m.meetingCapability,g.meetingCapability)))}function hasCoreMeetingCapabilitiesChanged(g,m){return!(!g.capabilities||null==g.capabilities.allowVideo||null!=m.capabilities?.allowVideo&&m.capabilities.allowVideo==g.capabilities.allowVideo)||(!(!g.meetingCapability||null==g.meetingCapability.allowIPVideo||null!=m.meetingCapability?.allowIPVideo&&m.meetingCapability.allowIPVideo==g.meetingCapability.allowIPVideo)||(!(!g.meetingCapability||null==g.meetingCapability.attendeeRestrictions||null!=m.meetingCapability?.attendeeRestrictions&&m.meetingCapability.attendeeRestrictions==g.meetingCapability.attendeeRestrictions)||(!(!g.meetingCapability||null==g.meetingCapability.allowPstnConferencing||null!=m.meetingCapability?.allowPstnConferencing&&m.meetingCapability.allowPstnConferencing==g.meetingCapability.allowPstnConferencing)||(!(!g.meetingCapability||null==g.meetingCapability.allowTranslatedCaptions||null!=m.meetingCapability?.allowTranslatedCaptions&&m.meetingCapability?.allowTranslatedCaptions==g.meetingCapability.allowTranslatedCaptions)||(!(!g.meetingCapability||null==g.meetingCapability.allowTranslatedTranscriptions||null!=m.meetingCapability?.allowTranslatedTranscriptions&&m.meetingCapability?.allowTranslatedTranscriptions==g.meetingCapability.allowTranslatedTranscriptions)||(!(!g.meetingCapability||null==g.meetingCapability.allowRaiseHands||null!=m.meetingCapability?.allowRaiseHands&&m.meetingCapability?.allowRaiseHands==g.meetingCapability.allowRaiseHands)||(!(!g.meetingCapability||null==g.meetingCapability.allowTeamsMeetingReactions||null!=m.meetingCapability?.allowTeamsMeetingReactions&&m.meetingCapability?.allowTeamsMeetingReactions==g.meetingCapability.allowTeamsMeetingReactions)||(!(!g.meetingCapability||null==g.meetingCapability.presenterOption||null!=m.meetingCapability?.presenterOption&&m.meetingCapability?.presenterOption==g.meetingCapability.presenterOption)||!(!g.capabilities||null==g.capabilities.maskIdentitiesForRole||null!=m.capabilities?.maskIdentitiesForRole&&m.capabilities?.maskIdentitiesForRole==g.capabilities.maskIdentitiesForRole)))))))))}function isProxyAndCustomTurnAllowed(g,m,S,v,C){if(S||v&&"microsoftTeamsUser"===v.kind||C&&callContextHasTeamsJoinOptions(C)){const S=getAcsEcsConfig().calling.allowProxyForTeamsCalls,v=g.proxyInUse,C=getAcsEcsConfig().calling.allowCustomTurnForTeamsCalls,_=m.customRelayManagerInUse;if(v&&!S)return!1;if(_&&!C)return!1}return!0}function IsAdhocInteropCall(g){return!!g.find((g=>"microsoftTeamsUser"===S.getIdentifierKind(g).kind))}function callContextHasTeamsJoinOptions(g){return!!(g.meetingId||g.meetingLink||g.messageId||g.organizerId||g.tenantId||g.threadId)}function initializeUfdsCorrelationIdCache(){return{1:{0:void 0,1:void 0,2:void 0,3:void 0},2:{0:void 0,1:void 0,2:void 0,3:void 0},3:{0:void 0,1:void 0,2:void 0,3:void 0},4:{0:void 0,1:void 0,2:void 0,3:void 0},5:{0:void 0,1:void 0,2:void 0,3:void 0},6:{0:void 0,1:void 0,2:void 0,3:void 0},7:{0:void 0,1:void 0,2:void 0,3:void 0},8:{0:void 0,1:void 0,2:void 0,3:void 0},9:{0:void 0,1:void 0,2:void 0,3:void 0},10:{0:void 0,1:void 0,2:void 0,3:void 0},11:{0:void 0,1:void 0,2:void 0,3:void 0},12:{0:void 0,1:void 0,2:void 0,3:void 0},13:{0:void 0,1:void 0,2:void 0,3:void 0},14:{0:void 0,1:void 0,2:void 0,3:void 0},15:{0:void 0,1:void 0,2:void 0,3:void 0},16:{0:void 0,1:void 0,2:void 0,3:void 0},17:{0:void 0,1:void 0,2:void 0,3:void 0},18:{0:void 0,1:void 0,2:void 0,3:void 0},19:{0:void 0,1:void 0,2:void 0,3:void 0},20:{0:void 0,1:void 0,2:void 0,3:void 0},21:{0:void 0,1:void 0,2:void 0,3:void 0},22:{0:void 0,1:void 0,2:void 0,3:void 0},23:{0:void 0,1:void 0,2:void 0,3:void 0},24:{0:void 0,1:void 0,2:void 0,3:void 0},25:{0:void 0,1:void 0,2:void 0,3:void 0},26:{0:void 0,1:void 0,2:void 0,3:void 0},27:{0:void 0,1:void 0,2:void 0,3:void 0},28:{0:void 0,1:void 0,2:void 0,3:void 0},29:{0:void 0,1:void 0,2:void 0,3:void 0},30:{0:void 0,1:void 0,2:void 0,3:void 0},31:{0:void 0,1:void 0,2:void 0,3:void 0},32:{0:void 0,1:void 0,2:void 0,3:void 0},33:{0:void 0,1:void 0,2:void 0,3:void 0},34:{0:void 0,1:void 0,2:void 0,3:void 0},35:{0:void 0,1:void 0,2:void 0,3:void 0},36:{0:void 0,1:void 0,2:void 0,3:void 0},37:{0:void 0,1:void 0,2:void 0,3:void 0},38:{0:void 0,1:void 0,2:void 0,3:void 0},39:{0:void 0,1:void 0,2:void 0,3:void 0},40:{0:void 0,1:void 0,2:void 0,3:void 0},41:{0:void 0,1:void 0,2:void 0,3:void 0},42:{0:void 0,1:void 0,2:void 0,3:void 0},43:{0:void 0,1:void 0,2:void 0,3:void 0},44:{0:void 0,1:void 0,2:void 0,3:void 0},45:{0:void 0,1:void 0,2:void 0,3:void 0},46:{0:void 0,1:void 0,2:void 0,3:void 0},47:{0:void 0,1:void 0,2:void 0,3:void 0},48:{0:void 0,1:void 0,2:void 0,3:void 0},49:{0:void 0,1:void 0,2:void 0,3:void 0},50:{0:void 0,1:void 0,2:void 0,3:void 0},51:{0:void 0,1:void 0,2:void 0,3:void 0},52:{0:void 0,1:void 0,2:void 0,3:void 0},53:{0:void 0,1:void 0,2:void 0,3:void 0},54:{0:void 0,1:void 0,2:void 0,3:void 0},55:{0:void 0,1:void 0,2:void 0,3:void 0},56:{0:void 0,1:void 0,2:void 0,3:void 0},57:{0:void 0,1:void 0,2:void 0,3:void 0},58:{0:void 0,1:void 0,2:void 0,3:void 0},59:{0:void 0,1:void 0,2:void 0,3:void 0},60:{0:void 0,1:void 0,2:void 0,3:void 0},61:{0:void 0,1:void 0,2:void 0,3:void 0},62:{0:void 0,1:void 0,2:void 0,3:void 0},63:{0:void 0,1:void 0,2:void 0,3:void 0},64:{0:void 0,1:void 0,2:void 0,3:void 0},65:{0:void 0,1:void 0,2:void 0,3:void 0},66:{0:void 0,1:void 0,2:void 0,3:void 0},67:{0:void 0,1:void 0,2:void 0,3:void 0},68:{0:void 0,1:void 0,2:void 0,3:void 0},69:{0:void 0,1:void 0,2:void 0,3:void 0},70:{0:void 0,1:void 0,2:void 0,3:void 0},71:{0:void 0,1:void 0,2:void 0,3:void 0},72:{0:void 0,1:void 0,2:void 0,3:void 0},73:{0:void 0,1:void 0,2:void 0,3:void 0},74:{0:void 0,1:void 0,2:void 0,3:void 0},75:{0:void 0,1:void 0,2:void 0,3:void 0},76:{0:void 0,1:void 0,2:void 0,3:void 0},77:{0:void 0,1:void 0,2:void 0,3:void 0}}}var dl=createCommonjsModule((function(g,m){var S="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;m.assign=function(g){for(var m=Array.prototype.slice.call(arguments,1);m.length;){var S=m.shift();if(S){if("object"!=typeof S)throw new TypeError(S+"must be non-object");for(var v in S)S.hasOwnProperty(v)&&(g[v]=S[v])}}return g},m.shrinkBuf=function(g,m){return g.length===m?g:g.subarray?g.subarray(0,m):(g.length=m,g)};var v={arraySet:function(g,m,S,v,C){if(m.subarray&&g.subarray)g.set(m.subarray(S,S+v),C);else for(var _=0;_<v;_++)g[C+_]=m[S+_]},flattenChunks:function(g){var m,S,v,C,_,E;for(v=0,m=0,S=g.length;m<S;m++)v+=g[m].length;for(E=new Uint8Array(v),C=0,m=0,S=g.length;m<S;m++)_=g[m],E.set(_,C),C+=_.length;return E}},C={arraySet:function(g,m,S,v,C){for(var _=0;_<v;_++)g[C+_]=m[S+_]},flattenChunks:function(g){return[].concat.apply([],g)}};m.setTyped=function(g){g?(m.Buf8=Uint8Array,m.Buf16=Uint16Array,m.Buf32=Int32Array,m.assign(m,v)):(m.Buf8=Array,m.Buf16=Array,m.Buf32=Array,m.assign(m,C))},m.setTyped(S)})),hl=4,ul=0,gl=1,pl=2;function zero(g){for(var m=g.length;--m>=0;)g[m]=0}var ml=0,fl=1,Sl=2,vl=3,Cl=258,_l=29,yl=256,El=yl+1+_l,Tl=30,Il=19,bl=2*El+1,Al=15,Rl=16,Pl=7,Ml=256,wl=16,Dl=17,Ol=18,Nl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],kl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Ll=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Fl=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],xl=512,Ul=new Array(2*(El+2));zero(Ul);var Vl=new Array(2*Tl);zero(Vl);var Bl=new Array(xl);zero(Bl);var Hl=new Array(Cl-vl+1);zero(Hl);var $l=new Array(_l);zero($l);var Gl,jl,ql,Wl=new Array(Tl);function StaticTreeDesc(g,m,S,v,C){this.static_tree=g,this.extra_bits=m,this.extra_base=S,this.elems=v,this.max_length=C,this.has_stree=g&&g.length}function TreeDesc(g,m){this.dyn_tree=g,this.max_code=0,this.stat_desc=m}function d_code(g){return g<256?Bl[g]:Bl[256+(g>>>7)]}function put_short(g,m){g.pending_buf[g.pending++]=255&m,g.pending_buf[g.pending++]=m>>>8&255}function send_bits(g,m,S){g.bi_valid>Rl-S?(g.bi_buf|=m<<g.bi_valid&65535,put_short(g,g.bi_buf),g.bi_buf=m>>Rl-g.bi_valid,g.bi_valid+=S-Rl):(g.bi_buf|=m<<g.bi_valid&65535,g.bi_valid+=S)}function send_code(g,m,S){send_bits(g,S[2*m],S[2*m+1])}function bi_reverse(g,m){var S=0;do{S|=1&g,g>>>=1,S<<=1}while(--m>0);return S>>>1}function bi_flush(g){16===g.bi_valid?(put_short(g,g.bi_buf),g.bi_buf=0,g.bi_valid=0):g.bi_valid>=8&&(g.pending_buf[g.pending++]=255&g.bi_buf,g.bi_buf>>=8,g.bi_valid-=8)}function gen_bitlen(g,m){var S,v,C,_,E,T,I=m.dyn_tree,b=m.max_code,A=m.stat_desc.static_tree,R=m.stat_desc.has_stree,P=m.stat_desc.extra_bits,M=m.stat_desc.extra_base,w=m.stat_desc.max_length,D=0;for(_=0;_<=Al;_++)g.bl_count[_]=0;for(I[2*g.heap[g.heap_max]+1]=0,S=g.heap_max+1;S<bl;S++)(_=I[2*I[2*(v=g.heap[S])+1]+1]+1)>w&&(_=w,D++),I[2*v+1]=_,v>b||(g.bl_count[_]++,E=0,v>=M&&(E=P[v-M]),T=I[2*v],g.opt_len+=T*(_+E),R&&(g.static_len+=T*(A[2*v+1]+E)));if(0!==D){do{for(_=w-1;0===g.bl_count[_];)_--;g.bl_count[_]--,g.bl_count[_+1]+=2,g.bl_count[w]--,D-=2}while(D>0);for(_=w;0!==_;_--)for(v=g.bl_count[_];0!==v;)(C=g.heap[--S])>b||(I[2*C+1]!==_&&(g.opt_len+=(_-I[2*C+1])*I[2*C],I[2*C+1]=_),v--)}}function gen_codes(g,m,S){var v,C,_=new Array(Al+1),E=0;for(v=1;v<=Al;v++)_[v]=E=E+S[v-1]<<1;for(C=0;C<=m;C++){var T=g[2*C+1];0!==T&&(g[2*C]=bi_reverse(_[T]++,T))}}function tr_static_init(){var g,m,S,v,C,_=new Array(Al+1);for(S=0,v=0;v<_l-1;v++)for($l[v]=S,g=0;g<1<<Nl[v];g++)Hl[S++]=v;for(Hl[S-1]=v,C=0,v=0;v<16;v++)for(Wl[v]=C,g=0;g<1<<kl[v];g++)Bl[C++]=v;for(C>>=7;v<Tl;v++)for(Wl[v]=C<<7,g=0;g<1<<kl[v]-7;g++)Bl[256+C++]=v;for(m=0;m<=Al;m++)_[m]=0;for(g=0;g<=143;)Ul[2*g+1]=8,g++,_[8]++;for(;g<=255;)Ul[2*g+1]=9,g++,_[9]++;for(;g<=279;)Ul[2*g+1]=7,g++,_[7]++;for(;g<=287;)Ul[2*g+1]=8,g++,_[8]++;for(gen_codes(Ul,El+1,_),g=0;g<Tl;g++)Vl[2*g+1]=5,Vl[2*g]=bi_reverse(g,5);Gl=new StaticTreeDesc(Ul,Nl,yl+1,El,Al),jl=new StaticTreeDesc(Vl,kl,0,Tl,Al),ql=new StaticTreeDesc(new Array(0),Ll,0,Il,Pl)}function init_block(g){var m;for(m=0;m<El;m++)g.dyn_ltree[2*m]=0;for(m=0;m<Tl;m++)g.dyn_dtree[2*m]=0;for(m=0;m<Il;m++)g.bl_tree[2*m]=0;g.dyn_ltree[2*Ml]=1,g.opt_len=g.static_len=0,g.last_lit=g.matches=0}function bi_windup(g){g.bi_valid>8?put_short(g,g.bi_buf):g.bi_valid>0&&(g.pending_buf[g.pending++]=g.bi_buf),g.bi_buf=0,g.bi_valid=0}function copy_block(g,m,S,v){bi_windup(g),v&&(put_short(g,S),put_short(g,~S)),dl.arraySet(g.pending_buf,g.window,m,S,g.pending),g.pending+=S}function smaller(g,m,S,v){var C=2*m,_=2*S;return g[C]<g[_]||g[C]===g[_]&&v[m]<=v[S]}function pqdownheap(g,m,S){for(var v=g.heap[S],C=S<<1;C<=g.heap_len&&(C<g.heap_len&&smaller(m,g.heap[C+1],g.heap[C],g.depth)&&C++,!smaller(m,v,g.heap[C],g.depth));)g.heap[S]=g.heap[C],S=C,C<<=1;g.heap[S]=v}function compress_block(g,m,S){var v,C,_,E,T=0;if(0!==g.last_lit)do{v=g.pending_buf[g.d_buf+2*T]<<8|g.pending_buf[g.d_buf+2*T+1],C=g.pending_buf[g.l_buf+T],T++,0===v?send_code(g,C,m):(send_code(g,(_=Hl[C])+yl+1,m),0!==(E=Nl[_])&&send_bits(g,C-=$l[_],E),send_code(g,_=d_code(--v),S),0!==(E=kl[_])&&send_bits(g,v-=Wl[_],E))}while(T<g.last_lit);send_code(g,Ml,m)}function build_tree(g,m){var S,v,C,_=m.dyn_tree,E=m.stat_desc.static_tree,T=m.stat_desc.has_stree,I=m.stat_desc.elems,b=-1;for(g.heap_len=0,g.heap_max=bl,S=0;S<I;S++)0!==_[2*S]?(g.heap[++g.heap_len]=b=S,g.depth[S]=0):_[2*S+1]=0;for(;g.heap_len<2;)_[2*(C=g.heap[++g.heap_len]=b<2?++b:0)]=1,g.depth[C]=0,g.opt_len--,T&&(g.static_len-=E[2*C+1]);for(m.max_code=b,S=g.heap_len>>1;S>=1;S--)pqdownheap(g,_,S);C=I;do{S=g.heap[1],g.heap[1]=g.heap[g.heap_len--],pqdownheap(g,_,1),v=g.heap[1],g.heap[--g.heap_max]=S,g.heap[--g.heap_max]=v,_[2*C]=_[2*S]+_[2*v],g.depth[C]=(g.depth[S]>=g.depth[v]?g.depth[S]:g.depth[v])+1,_[2*S+1]=_[2*v+1]=C,g.heap[1]=C++,pqdownheap(g,_,1)}while(g.heap_len>=2);g.heap[--g.heap_max]=g.heap[1],gen_bitlen(g,m),gen_codes(_,b,g.bl_count)}function scan_tree(g,m,S){var v,C,_=-1,E=m[1],T=0,I=7,b=4;for(0===E&&(I=138,b=3),m[2*(S+1)+1]=65535,v=0;v<=S;v++)C=E,E=m[2*(v+1)+1],++T<I&&C===E||(T<b?g.bl_tree[2*C]+=T:0!==C?(C!==_&&g.bl_tree[2*C]++,g.bl_tree[2*wl]++):T<=10?g.bl_tree[2*Dl]++:g.bl_tree[2*Ol]++,T=0,_=C,0===E?(I=138,b=3):C===E?(I=6,b=3):(I=7,b=4))}function send_tree(g,m,S){var v,C,_=-1,E=m[1],T=0,I=7,b=4;for(0===E&&(I=138,b=3),v=0;v<=S;v++)if(C=E,E=m[2*(v+1)+1],!(++T<I&&C===E)){if(T<b)do{send_code(g,C,g.bl_tree)}while(0!=--T);else 0!==C?(C!==_&&(send_code(g,C,g.bl_tree),T--),send_code(g,wl,g.bl_tree),send_bits(g,T-3,2)):T<=10?(send_code(g,Dl,g.bl_tree),send_bits(g,T-3,3)):(send_code(g,Ol,g.bl_tree),send_bits(g,T-11,7));T=0,_=C,0===E?(I=138,b=3):C===E?(I=6,b=3):(I=7,b=4)}}function build_bl_tree(g){var m;for(scan_tree(g,g.dyn_ltree,g.l_desc.max_code),scan_tree(g,g.dyn_dtree,g.d_desc.max_code),build_tree(g,g.bl_desc),m=Il-1;m>=3&&0===g.bl_tree[2*Fl[m]+1];m--);return g.opt_len+=3*(m+1)+5+5+4,m}function send_all_trees(g,m,S,v){var C;for(send_bits(g,m-257,5),send_bits(g,S-1,5),send_bits(g,v-4,4),C=0;C<v;C++)send_bits(g,g.bl_tree[2*Fl[C]+1],3);send_tree(g,g.dyn_ltree,m-1),send_tree(g,g.dyn_dtree,S-1)}function detect_data_type(g){var m,S=4093624447;for(m=0;m<=31;m++,S>>>=1)if(1&S&&0!==g.dyn_ltree[2*m])return ul;if(0!==g.dyn_ltree[18]||0!==g.dyn_ltree[20]||0!==g.dyn_ltree[26])return gl;for(m=32;m<yl;m++)if(0!==g.dyn_ltree[2*m])return gl;return ul}zero(Wl);var zl=!1;function _tr_init(g){zl||(tr_static_init(),zl=!0),g.l_desc=new TreeDesc(g.dyn_ltree,Gl),g.d_desc=new TreeDesc(g.dyn_dtree,jl),g.bl_desc=new TreeDesc(g.bl_tree,ql),g.bi_buf=0,g.bi_valid=0,init_block(g)}function _tr_stored_block(g,m,S,v){send_bits(g,(ml<<1)+(v?1:0),3),copy_block(g,m,S,!0)}function _tr_align(g){send_bits(g,fl<<1,3),send_code(g,Ml,Ul),bi_flush(g)}function _tr_flush_block(g,m,S,v){var C,_,E=0;g.level>0?(g.strm.data_type===pl&&(g.strm.data_type=detect_data_type(g)),build_tree(g,g.l_desc),build_tree(g,g.d_desc),E=build_bl_tree(g),C=g.opt_len+3+7>>>3,(_=g.static_len+3+7>>>3)<=C&&(C=_)):C=_=S+5,S+4<=C&&-1!==m?_tr_stored_block(g,m,S,v):g.strategy===hl||_===C?(send_bits(g,(fl<<1)+(v?1:0),3),compress_block(g,Ul,Vl)):(send_bits(g,(Sl<<1)+(v?1:0),3),send_all_trees(g,g.l_desc.max_code+1,g.d_desc.max_code+1,E+1),compress_block(g,g.dyn_ltree,g.dyn_dtree)),init_block(g),v&&bi_windup(g)}function _tr_tally(g,m,S){return g.pending_buf[g.d_buf+2*g.last_lit]=m>>>8&255,g.pending_buf[g.d_buf+2*g.last_lit+1]=255&m,g.pending_buf[g.l_buf+g.last_lit]=255&S,g.last_lit++,0===m?g.dyn_ltree[2*S]++:(g.matches++,m--,g.dyn_ltree[2*(Hl[S]+yl+1)]++,g.dyn_dtree[2*d_code(m)]++),g.last_lit===g.lit_bufsize-1}var Kl={_tr_init:_tr_init,_tr_stored_block:_tr_stored_block,_tr_flush_block:_tr_flush_block,_tr_tally:_tr_tally,_tr_align:_tr_align};function adler32(g,m,S,v){for(var C=65535&g|0,_=g>>>16&65535|0,E=0;0!==S;){S-=E=S>2e3?2e3:S;do{_=_+(C=C+m[v++]|0)|0}while(--E);C%=65521,_%=65521}return C|_<<16|0}var Jl=adler32;function makeTable(){for(var g,m=[],S=0;S<256;S++){g=S;for(var v=0;v<8;v++)g=1&g?3988292384^g>>>1:g>>>1;m[S]=g}return m}var Yl=makeTable();function crc32(g,m,S,v){var C=Yl,_=v+S;g^=-1;for(var E=v;E<_;E++)g=g>>>8^C[255&(g^m[E])];return-1^g}var Ql,Xl=crc32,Zl={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ec=0,tc=1,ic=3,nc=4,rc=5,sc=0,ac=1,oc=-2,lc=-3,cc=-5,dc=-1,hc=1,uc=2,gc=3,pc=4,mc=0,fc=2,Sc=8,vc=9,Cc=15,_c=8,yc=256+1+29,Ec=30,Tc=19,Ic=2*yc+1,bc=15,Ac=3,Rc=258,Pc=Rc+Ac+1,Mc=32,wc=42,Dc=69,Oc=73,Nc=91,kc=103,Lc=113,Fc=666,xc=1,Uc=2,Vc=3,Bc=4,Hc=3;function err(g,m){return g.msg=Zl[m],m}function rank(g){return(g<<1)-(g>4?9:0)}function zero$1(g){for(var m=g.length;--m>=0;)g[m]=0}function flush_pending(g){var m=g.state,S=m.pending;S>g.avail_out&&(S=g.avail_out),0!==S&&(dl.arraySet(g.output,m.pending_buf,m.pending_out,S,g.next_out),g.next_out+=S,m.pending_out+=S,g.total_out+=S,g.avail_out-=S,m.pending-=S,0===m.pending&&(m.pending_out=0))}function flush_block_only(g,m){Kl._tr_flush_block(g,g.block_start>=0?g.block_start:-1,g.strstart-g.block_start,m),g.block_start=g.strstart,flush_pending(g.strm)}function put_byte(g,m){g.pending_buf[g.pending++]=m}function putShortMSB(g,m){g.pending_buf[g.pending++]=m>>>8&255,g.pending_buf[g.pending++]=255&m}function read_buf(g,m,S,v){var C=g.avail_in;return C>v&&(C=v),0===C?0:(g.avail_in-=C,dl.arraySet(m,g.input,g.next_in,C,S),1===g.state.wrap?g.adler=Jl(g.adler,m,C,S):2===g.state.wrap&&(g.adler=Xl(g.adler,m,C,S)),g.next_in+=C,g.total_in+=C,C)}function longest_match(g,m){var S,v,C=g.max_chain_length,_=g.strstart,E=g.prev_length,T=g.nice_match,I=g.strstart>g.w_size-Pc?g.strstart-(g.w_size-Pc):0,b=g.window,A=g.w_mask,R=g.prev,P=g.strstart+Rc,M=b[_+E-1],w=b[_+E];g.prev_length>=g.good_match&&(C>>=2),T>g.lookahead&&(T=g.lookahead);do{if(b[(S=m)+E]===w&&b[S+E-1]===M&&b[S]===b[_]&&b[++S]===b[_+1]){_+=2,S++;do{}while(b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&b[++_]===b[++S]&&_<P);if(v=Rc-(P-_),_=P-Rc,v>E){if(g.match_start=m,E=v,v>=T)break;M=b[_+E-1],w=b[_+E]}}}while((m=R[m&A])>I&&0!=--C);return E<=g.lookahead?E:g.lookahead}function fill_window(g){var m,S,v,C,_,E=g.w_size;do{if(C=g.window_size-g.lookahead-g.strstart,g.strstart>=E+(E-Pc)){dl.arraySet(g.window,g.window,E,E,0),g.match_start-=E,g.strstart-=E,g.block_start-=E,m=S=g.hash_size;do{v=g.head[--m],g.head[m]=v>=E?v-E:0}while(--S);m=S=E;do{v=g.prev[--m],g.prev[m]=v>=E?v-E:0}while(--S);C+=E}if(0===g.strm.avail_in)break;if(S=read_buf(g.strm,g.window,g.strstart+g.lookahead,C),g.lookahead+=S,g.lookahead+g.insert>=Ac)for(_=g.strstart-g.insert,g.ins_h=g.window[_],g.ins_h=(g.ins_h<<g.hash_shift^g.window[_+1])&g.hash_mask;g.insert&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[_+Ac-1])&g.hash_mask,g.prev[_&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=_,_++,g.insert--,!(g.lookahead+g.insert<Ac)););}while(g.lookahead<Pc&&0!==g.strm.avail_in)}function deflate_stored(g,m){var S=65535;for(S>g.pending_buf_size-5&&(S=g.pending_buf_size-5);;){if(g.lookahead<=1){if(fill_window(g),0===g.lookahead&&m===ec)return xc;if(0===g.lookahead)break}g.strstart+=g.lookahead,g.lookahead=0;var v=g.block_start+S;if((0===g.strstart||g.strstart>=v)&&(g.lookahead=g.strstart-v,g.strstart=v,flush_block_only(g,!1),0===g.strm.avail_out))return xc;if(g.strstart-g.block_start>=g.w_size-Pc&&(flush_block_only(g,!1),0===g.strm.avail_out))return xc}return g.insert=0,m===nc?(flush_block_only(g,!0),0===g.strm.avail_out?Vc:Bc):(g.strstart>g.block_start&&(flush_block_only(g,!1),g.strm.avail_out),xc)}function deflate_fast(g,m){for(var S,v;;){if(g.lookahead<Pc){if(fill_window(g),g.lookahead<Pc&&m===ec)return xc;if(0===g.lookahead)break}if(S=0,g.lookahead>=Ac&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+Ac-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),0!==S&&g.strstart-S<=g.w_size-Pc&&(g.match_length=longest_match(g,S)),g.match_length>=Ac)if(v=Kl._tr_tally(g,g.strstart-g.match_start,g.match_length-Ac),g.lookahead-=g.match_length,g.match_length<=g.max_lazy_match&&g.lookahead>=Ac){g.match_length--;do{g.strstart++,g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+Ac-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart}while(0!=--g.match_length);g.strstart++}else g.strstart+=g.match_length,g.match_length=0,g.ins_h=g.window[g.strstart],g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+1])&g.hash_mask;else v=Kl._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++;if(v&&(flush_block_only(g,!1),0===g.strm.avail_out))return xc}return g.insert=g.strstart<Ac-1?g.strstart:Ac-1,m===nc?(flush_block_only(g,!0),0===g.strm.avail_out?Vc:Bc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?xc:Uc}function deflate_slow(g,m){for(var S,v,C;;){if(g.lookahead<Pc){if(fill_window(g),g.lookahead<Pc&&m===ec)return xc;if(0===g.lookahead)break}if(S=0,g.lookahead>=Ac&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+Ac-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),g.prev_length=g.match_length,g.prev_match=g.match_start,g.match_length=Ac-1,0!==S&&g.prev_length<g.max_lazy_match&&g.strstart-S<=g.w_size-Pc&&(g.match_length=longest_match(g,S),g.match_length<=5&&(g.strategy===hc||g.match_length===Ac&&g.strstart-g.match_start>4096)&&(g.match_length=Ac-1)),g.prev_length>=Ac&&g.match_length<=g.prev_length){C=g.strstart+g.lookahead-Ac,v=Kl._tr_tally(g,g.strstart-1-g.prev_match,g.prev_length-Ac),g.lookahead-=g.prev_length-1,g.prev_length-=2;do{++g.strstart<=C&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+Ac-1])&g.hash_mask,S=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart)}while(0!=--g.prev_length);if(g.match_available=0,g.match_length=Ac-1,g.strstart++,v&&(flush_block_only(g,!1),0===g.strm.avail_out))return xc}else if(g.match_available){if((v=Kl._tr_tally(g,0,g.window[g.strstart-1]))&&flush_block_only(g,!1),g.strstart++,g.lookahead--,0===g.strm.avail_out)return xc}else g.match_available=1,g.strstart++,g.lookahead--}return g.match_available&&(v=Kl._tr_tally(g,0,g.window[g.strstart-1]),g.match_available=0),g.insert=g.strstart<Ac-1?g.strstart:Ac-1,m===nc?(flush_block_only(g,!0),0===g.strm.avail_out?Vc:Bc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?xc:Uc}function deflate_rle(g,m){for(var S,v,C,_,E=g.window;;){if(g.lookahead<=Rc){if(fill_window(g),g.lookahead<=Rc&&m===ec)return xc;if(0===g.lookahead)break}if(g.match_length=0,g.lookahead>=Ac&&g.strstart>0&&(v=E[C=g.strstart-1])===E[++C]&&v===E[++C]&&v===E[++C]){_=g.strstart+Rc;do{}while(v===E[++C]&&v===E[++C]&&v===E[++C]&&v===E[++C]&&v===E[++C]&&v===E[++C]&&v===E[++C]&&v===E[++C]&&C<_);g.match_length=Rc-(_-C),g.match_length>g.lookahead&&(g.match_length=g.lookahead)}if(g.match_length>=Ac?(S=Kl._tr_tally(g,1,g.match_length-Ac),g.lookahead-=g.match_length,g.strstart+=g.match_length,g.match_length=0):(S=Kl._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++),S&&(flush_block_only(g,!1),0===g.strm.avail_out))return xc}return g.insert=0,m===nc?(flush_block_only(g,!0),0===g.strm.avail_out?Vc:Bc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?xc:Uc}function deflate_huff(g,m){for(var S;;){if(0===g.lookahead&&(fill_window(g),0===g.lookahead)){if(m===ec)return xc;break}if(g.match_length=0,S=Kl._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++,S&&(flush_block_only(g,!1),0===g.strm.avail_out))return xc}return g.insert=0,m===nc?(flush_block_only(g,!0),0===g.strm.avail_out?Vc:Bc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?xc:Uc}function Config(g,m,S,v,C){this.good_length=g,this.max_lazy=m,this.nice_length=S,this.max_chain=v,this.func=C}function lm_init(g){g.window_size=2*g.w_size,zero$1(g.head),g.max_lazy_match=Ql[g.level].max_lazy,g.good_match=Ql[g.level].good_length,g.nice_match=Ql[g.level].nice_length,g.max_chain_length=Ql[g.level].max_chain,g.strstart=0,g.block_start=0,g.lookahead=0,g.insert=0,g.match_length=g.prev_length=Ac-1,g.match_available=0,g.ins_h=0}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Sc,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new dl.Buf16(2*Ic),this.dyn_dtree=new dl.Buf16(2*(2*Ec+1)),this.bl_tree=new dl.Buf16(2*(2*Tc+1)),zero$1(this.dyn_ltree),zero$1(this.dyn_dtree),zero$1(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new dl.Buf16(bc+1),this.heap=new dl.Buf16(2*yc+1),zero$1(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new dl.Buf16(2*yc+1),zero$1(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(g){var m;return g&&g.state?(g.total_in=g.total_out=0,g.data_type=fc,(m=g.state).pending=0,m.pending_out=0,m.wrap<0&&(m.wrap=-m.wrap),m.status=m.wrap?wc:Lc,g.adler=2===m.wrap?0:1,m.last_flush=ec,Kl._tr_init(m),sc):err(g,oc)}function deflateReset(g){var m=deflateResetKeep(g);return m===sc&&lm_init(g.state),m}function deflateSetHeader(g,m){return g&&g.state?2!==g.state.wrap?oc:(g.state.gzhead=m,sc):oc}function deflateInit2(g,m,S,v,C,_){if(!g)return oc;var E=1;if(m===dc&&(m=6),v<0?(E=0,v=-v):v>15&&(E=2,v-=16),C<1||C>vc||S!==Sc||v<8||v>15||m<0||m>9||_<0||_>pc)return err(g,oc);8===v&&(v=9);var T=new DeflateState;return g.state=T,T.strm=g,T.wrap=E,T.gzhead=null,T.w_bits=v,T.w_size=1<<T.w_bits,T.w_mask=T.w_size-1,T.hash_bits=C+7,T.hash_size=1<<T.hash_bits,T.hash_mask=T.hash_size-1,T.hash_shift=~~((T.hash_bits+Ac-1)/Ac),T.window=new dl.Buf8(2*T.w_size),T.head=new dl.Buf16(T.hash_size),T.prev=new dl.Buf16(T.w_size),T.lit_bufsize=1<<C+6,T.pending_buf_size=4*T.lit_bufsize,T.pending_buf=new dl.Buf8(T.pending_buf_size),T.d_buf=T.lit_bufsize>>1,T.l_buf=3*T.lit_bufsize,T.level=m,T.strategy=_,T.method=S,deflateReset(g)}function deflateInit(g,m){return deflateInit2(g,m,Sc,Cc,_c,mc)}function deflate(g,m){var S,v,C,_;if(!g||!g.state||m>rc||m<0)return g?err(g,oc):oc;if(v=g.state,!g.output||!g.input&&0!==g.avail_in||v.status===Fc&&m!==nc)return err(g,0===g.avail_out?cc:oc);if(v.strm=g,S=v.last_flush,v.last_flush=m,v.status===wc)if(2===v.wrap)g.adler=0,put_byte(v,31),put_byte(v,139),put_byte(v,8),v.gzhead?(put_byte(v,(v.gzhead.text?1:0)+(v.gzhead.hcrc?2:0)+(v.gzhead.extra?4:0)+(v.gzhead.name?8:0)+(v.gzhead.comment?16:0)),put_byte(v,255&v.gzhead.time),put_byte(v,v.gzhead.time>>8&255),put_byte(v,v.gzhead.time>>16&255),put_byte(v,v.gzhead.time>>24&255),put_byte(v,9===v.level?2:v.strategy>=uc||v.level<2?4:0),put_byte(v,255&v.gzhead.os),v.gzhead.extra&&v.gzhead.extra.length&&(put_byte(v,255&v.gzhead.extra.length),put_byte(v,v.gzhead.extra.length>>8&255)),v.gzhead.hcrc&&(g.adler=Xl(g.adler,v.pending_buf,v.pending,0)),v.gzindex=0,v.status=Dc):(put_byte(v,0),put_byte(v,0),put_byte(v,0),put_byte(v,0),put_byte(v,0),put_byte(v,9===v.level?2:v.strategy>=uc||v.level<2?4:0),put_byte(v,Hc),v.status=Lc);else{var E=Sc+(v.w_bits-8<<4)<<8;E|=(v.strategy>=uc||v.level<2?0:v.level<6?1:6===v.level?2:3)<<6,0!==v.strstart&&(E|=Mc),E+=31-E%31,v.status=Lc,putShortMSB(v,E),0!==v.strstart&&(putShortMSB(v,g.adler>>>16),putShortMSB(v,65535&g.adler)),g.adler=1}if(v.status===Dc)if(v.gzhead.extra){for(C=v.pending;v.gzindex<(65535&v.gzhead.extra.length)&&(v.pending!==v.pending_buf_size||(v.gzhead.hcrc&&v.pending>C&&(g.adler=Xl(g.adler,v.pending_buf,v.pending-C,C)),flush_pending(g),C=v.pending,v.pending!==v.pending_buf_size));)put_byte(v,255&v.gzhead.extra[v.gzindex]),v.gzindex++;v.gzhead.hcrc&&v.pending>C&&(g.adler=Xl(g.adler,v.pending_buf,v.pending-C,C)),v.gzindex===v.gzhead.extra.length&&(v.gzindex=0,v.status=Oc)}else v.status=Oc;if(v.status===Oc)if(v.gzhead.name){C=v.pending;do{if(v.pending===v.pending_buf_size&&(v.gzhead.hcrc&&v.pending>C&&(g.adler=Xl(g.adler,v.pending_buf,v.pending-C,C)),flush_pending(g),C=v.pending,v.pending===v.pending_buf_size)){_=1;break}_=v.gzindex<v.gzhead.name.length?255&v.gzhead.name.charCodeAt(v.gzindex++):0,put_byte(v,_)}while(0!==_);v.gzhead.hcrc&&v.pending>C&&(g.adler=Xl(g.adler,v.pending_buf,v.pending-C,C)),0===_&&(v.gzindex=0,v.status=Nc)}else v.status=Nc;if(v.status===Nc)if(v.gzhead.comment){C=v.pending;do{if(v.pending===v.pending_buf_size&&(v.gzhead.hcrc&&v.pending>C&&(g.adler=Xl(g.adler,v.pending_buf,v.pending-C,C)),flush_pending(g),C=v.pending,v.pending===v.pending_buf_size)){_=1;break}_=v.gzindex<v.gzhead.comment.length?255&v.gzhead.comment.charCodeAt(v.gzindex++):0,put_byte(v,_)}while(0!==_);v.gzhead.hcrc&&v.pending>C&&(g.adler=Xl(g.adler,v.pending_buf,v.pending-C,C)),0===_&&(v.status=kc)}else v.status=kc;if(v.status===kc&&(v.gzhead.hcrc?(v.pending+2>v.pending_buf_size&&flush_pending(g),v.pending+2<=v.pending_buf_size&&(put_byte(v,255&g.adler),put_byte(v,g.adler>>8&255),g.adler=0,v.status=Lc)):v.status=Lc),0!==v.pending){if(flush_pending(g),0===g.avail_out)return v.last_flush=-1,sc}else if(0===g.avail_in&&rank(m)<=rank(S)&&m!==nc)return err(g,cc);if(v.status===Fc&&0!==g.avail_in)return err(g,cc);if(0!==g.avail_in||0!==v.lookahead||m!==ec&&v.status!==Fc){var T=v.strategy===uc?deflate_huff(v,m):v.strategy===gc?deflate_rle(v,m):Ql[v.level].func(v,m);if(T!==Vc&&T!==Bc||(v.status=Fc),T===xc||T===Vc)return 0===g.avail_out&&(v.last_flush=-1),sc;if(T===Uc&&(m===tc?Kl._tr_align(v):m!==rc&&(Kl._tr_stored_block(v,0,0,!1),m===ic&&(zero$1(v.head),0===v.lookahead&&(v.strstart=0,v.block_start=0,v.insert=0))),flush_pending(g),0===g.avail_out))return v.last_flush=-1,sc}return m!==nc?sc:v.wrap<=0?ac:(2===v.wrap?(put_byte(v,255&g.adler),put_byte(v,g.adler>>8&255),put_byte(v,g.adler>>16&255),put_byte(v,g.adler>>24&255),put_byte(v,255&g.total_in),put_byte(v,g.total_in>>8&255),put_byte(v,g.total_in>>16&255),put_byte(v,g.total_in>>24&255)):(putShortMSB(v,g.adler>>>16),putShortMSB(v,65535&g.adler)),flush_pending(g),v.wrap>0&&(v.wrap=-v.wrap),0!==v.pending?sc:ac)}function deflateEnd(g){var m;return g&&g.state?(m=g.state.status)!==wc&&m!==Dc&&m!==Oc&&m!==Nc&&m!==kc&&m!==Lc&&m!==Fc?err(g,oc):(g.state=null,m===Lc?err(g,lc):sc):oc}function deflateSetDictionary(g,m){var S,v,C,_,E,T,I,b,A=m.length;if(!g||!g.state)return oc;if(2===(_=(S=g.state).wrap)||1===_&&S.status!==wc||S.lookahead)return oc;for(1===_&&(g.adler=Jl(g.adler,m,A,0)),S.wrap=0,A>=S.w_size&&(0===_&&(zero$1(S.head),S.strstart=0,S.block_start=0,S.insert=0),b=new dl.Buf8(S.w_size),dl.arraySet(b,m,A-S.w_size,S.w_size,0),m=b,A=S.w_size),E=g.avail_in,T=g.next_in,I=g.input,g.avail_in=A,g.next_in=0,g.input=m,fill_window(S);S.lookahead>=Ac;){v=S.strstart,C=S.lookahead-(Ac-1);do{S.ins_h=(S.ins_h<<S.hash_shift^S.window[v+Ac-1])&S.hash_mask,S.prev[v&S.w_mask]=S.head[S.ins_h],S.head[S.ins_h]=v,v++}while(--C);S.strstart=v,S.lookahead=Ac-1,fill_window(S)}return S.strstart+=S.lookahead,S.block_start=S.strstart,S.insert=S.lookahead,S.lookahead=0,S.match_length=S.prev_length=Ac-1,S.match_available=0,g.next_in=T,g.input=I,g.avail_in=E,S.wrap=_,sc}Ql=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)];var $c={deflateInit:deflateInit,deflateInit2:deflateInit2,deflateReset:deflateReset,deflateResetKeep:deflateResetKeep,deflateSetHeader:deflateSetHeader,deflate:deflate,deflateEnd:deflateEnd,deflateSetDictionary:deflateSetDictionary,deflateInfo:"pako deflate (from Nodeca project)"},Gc=!0,jc=!0;try{String.fromCharCode.apply(null,[0])}catch(g){Gc=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(g){jc=!1}for(var qc=new dl.Buf8(256),Wc=0;Wc<256;Wc++)qc[Wc]=Wc>=252?6:Wc>=248?5:Wc>=240?4:Wc>=224?3:Wc>=192?2:1;qc[254]=qc[254]=1;var string2buf=function(g){var m,S,v,C,_,E=g.length,T=0;for(C=0;C<E;C++)55296==(64512&(S=g.charCodeAt(C)))&&C+1<E&&56320==(64512&(v=g.charCodeAt(C+1)))&&(S=65536+(S-55296<<10)+(v-56320),C++),T+=S<128?1:S<2048?2:S<65536?3:4;for(m=new dl.Buf8(T),_=0,C=0;_<T;C++)55296==(64512&(S=g.charCodeAt(C)))&&C+1<E&&56320==(64512&(v=g.charCodeAt(C+1)))&&(S=65536+(S-55296<<10)+(v-56320),C++),S<128?m[_++]=S:S<2048?(m[_++]=192|S>>>6,m[_++]=128|63&S):S<65536?(m[_++]=224|S>>>12,m[_++]=128|S>>>6&63,m[_++]=128|63&S):(m[_++]=240|S>>>18,m[_++]=128|S>>>12&63,m[_++]=128|S>>>6&63,m[_++]=128|63&S);return m};function buf2binstring(g,m){if(m<65537&&(g.subarray&&jc||!g.subarray&&Gc))return String.fromCharCode.apply(null,dl.shrinkBuf(g,m));for(var S="",v=0;v<m;v++)S+=String.fromCharCode(g[v]);return S}var binstring2buf=function(g){for(var m=new dl.Buf8(g.length),S=0,v=m.length;S<v;S++)m[S]=g.charCodeAt(S);return m},buf2string=function(g,m){var S,v,C,_,E=m||g.length,T=new Array(2*E);for(v=0,S=0;S<E;)if((C=g[S++])<128)T[v++]=C;else if((_=qc[C])>4)T[v++]=65533,S+=_-1;else{for(C&=2===_?31:3===_?15:7;_>1&&S<E;)C=C<<6|63&g[S++],_--;_>1?T[v++]=65533:C<65536?T[v++]=C:(C-=65536,T[v++]=55296|C>>10&1023,T[v++]=56320|1023&C)}return buf2binstring(T,v)},zc={string2buf:string2buf,buf2binstring:function(g){return buf2binstring(g,g.length)},binstring2buf:binstring2buf,buf2string:buf2string,utf8border:function(g,m){var S;for((m=m||g.length)>g.length&&(m=g.length),S=m-1;S>=0&&128==(192&g[S]);)S--;return S<0||0===S?m:S+qc[g[S]]>m?S:m}};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var Kc=ZStream,Jc=Object.prototype.toString,Yc=0,Qc=4,Xc=0,Zc=1,ed=2,td=-1,id=0,nd=8;function Deflate(g){if(!(this instanceof Deflate))return new Deflate(g);this.options=dl.assign({level:td,method:nd,chunkSize:16384,windowBits:15,memLevel:8,strategy:id,to:""},g||{});var m=this.options;m.raw&&m.windowBits>0?m.windowBits=-m.windowBits:m.gzip&&m.windowBits>0&&m.windowBits<16&&(m.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Kc,this.strm.avail_out=0;var S=$c.deflateInit2(this.strm,m.level,m.method,m.windowBits,m.memLevel,m.strategy);if(S!==Xc)throw new Error(Zl[S]);if(m.header&&$c.deflateSetHeader(this.strm,m.header),m.dictionary){var v;if(v="string"==typeof m.dictionary?zc.string2buf(m.dictionary):"[object ArrayBuffer]"===Jc.call(m.dictionary)?new Uint8Array(m.dictionary):m.dictionary,(S=$c.deflateSetDictionary(this.strm,v))!==Xc)throw new Error(Zl[S]);this._dict_set=!0}}function deflate$1(g,m){var S=new Deflate(m);if(S.push(g,!0),S.err)throw S.msg;return S.result}function deflateRaw(g,m){return(m=m||{}).raw=!0,deflate$1(g,m)}function gzip(g,m){return(m=m||{}).gzip=!0,deflate$1(g,m)}Deflate.prototype.push=function(g,m){var S,v,C=this.strm,_=this.options.chunkSize;if(this.ended)return!1;v=m===~~m?m:!0===m?Qc:Yc,"string"==typeof g?C.input=zc.string2buf(g):"[object ArrayBuffer]"===Jc.call(g)?C.input=new Uint8Array(g):C.input=g,C.next_in=0,C.avail_in=C.input.length;do{if(0===C.avail_out&&(C.output=new dl.Buf8(_),C.next_out=0,C.avail_out=_),(S=$c.deflate(C,v))!==Zc&&S!==Xc)return this.onEnd(S),this.ended=!0,!1;0!==C.avail_out&&(0!==C.avail_in||v!==Qc&&v!==ed)||("string"===this.options.to?this.onData(zc.buf2binstring(dl.shrinkBuf(C.output,C.next_out))):this.onData(dl.shrinkBuf(C.output,C.next_out)))}while((C.avail_in>0||0===C.avail_out)&&S!==Zc);return v===Qc?(S=$c.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===Xc):v!==ed||(this.onEnd(Xc),C.avail_out=0,!0)},Deflate.prototype.onData=function(g){this.chunks.push(g)},Deflate.prototype.onEnd=function(g){g===Xc&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=dl.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg};var rd={Deflate:Deflate,deflate:deflate$1,deflateRaw:deflateRaw,gzip:gzip},sd=30,ad=12,od=function inflate_fast(g,m){var S,v,C,_,E,T,I,b,A,R,P,M,w,D,O,N,k,L,F,x,U,V,B,H,$;S=g.state,v=g.next_in,H=g.input,C=v+(g.avail_in-5),_=g.next_out,$=g.output,E=_-(m-g.avail_out),T=_+(g.avail_out-257),I=S.dmax,b=S.wsize,A=S.whave,R=S.wnext,P=S.window,M=S.hold,w=S.bits,D=S.lencode,O=S.distcode,N=(1<<S.lenbits)-1,k=(1<<S.distbits)-1;e:do{w<15&&(M+=H[v++]<<w,w+=8,M+=H[v++]<<w,w+=8),L=D[M&N];t:for(;;){if(M>>>=F=L>>>24,w-=F,0===(F=L>>>16&255))$[_++]=65535&L;else{if(!(16&F)){if(0==(64&F)){L=D[(65535&L)+(M&(1<<F)-1)];continue t}if(32&F){S.mode=ad;break e}g.msg="invalid literal/length code",S.mode=sd;break e}x=65535&L,(F&=15)&&(w<F&&(M+=H[v++]<<w,w+=8),x+=M&(1<<F)-1,M>>>=F,w-=F),w<15&&(M+=H[v++]<<w,w+=8,M+=H[v++]<<w,w+=8),L=O[M&k];i:for(;;){if(M>>>=F=L>>>24,w-=F,!(16&(F=L>>>16&255))){if(0==(64&F)){L=O[(65535&L)+(M&(1<<F)-1)];continue i}g.msg="invalid distance code",S.mode=sd;break e}if(U=65535&L,w<(F&=15)&&(M+=H[v++]<<w,(w+=8)<F&&(M+=H[v++]<<w,w+=8)),(U+=M&(1<<F)-1)>I){g.msg="invalid distance too far back",S.mode=sd;break e}if(M>>>=F,w-=F,U>(F=_-E)){if((F=U-F)>A&&S.sane){g.msg="invalid distance too far back",S.mode=sd;break e}if(V=0,B=P,0===R){if(V+=b-F,F<x){x-=F;do{$[_++]=P[V++]}while(--F);V=_-U,B=$}}else if(R<F){if(V+=b+R-F,(F-=R)<x){x-=F;do{$[_++]=P[V++]}while(--F);if(V=0,R<x){x-=F=R;do{$[_++]=P[V++]}while(--F);V=_-U,B=$}}}else if(V+=R-F,F<x){x-=F;do{$[_++]=P[V++]}while(--F);V=_-U,B=$}for(;x>2;)$[_++]=B[V++],$[_++]=B[V++],$[_++]=B[V++],x-=3;x&&($[_++]=B[V++],x>1&&($[_++]=B[V++]))}else{V=_-U;do{$[_++]=$[V++],$[_++]=$[V++],$[_++]=$[V++],x-=3}while(x>2);x&&($[_++]=$[V++],x>1&&($[_++]=$[V++]))}break}}break}}while(v<C&&_<T);v-=x=w>>3,M&=(1<<(w-=x<<3))-1,g.next_in=v,g.next_out=_,g.avail_in=v<C?C-v+5:5-(v-C),g.avail_out=_<T?T-_+257:257-(_-T),S.hold=M,S.bits=w},ld=15,cd=852,dd=592,hd=0,ud=1,gd=2,pd=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],md=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],fd=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],Sd=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],vd=function inflate_table(g,m,S,v,C,_,E,T){var I,b,A,R,P,M,w,D,O,N=T.bits,k=0,L=0,F=0,x=0,U=0,V=0,B=0,H=0,$=0,G=0,j=null,q=0,W=new dl.Buf16(ld+1),z=new dl.Buf16(ld+1),K=null,J=0;for(k=0;k<=ld;k++)W[k]=0;for(L=0;L<v;L++)W[m[S+L]]++;for(U=N,x=ld;x>=1&&0===W[x];x--);if(U>x&&(U=x),0===x)return C[_++]=20971520,C[_++]=20971520,T.bits=1,0;for(F=1;F<x&&0===W[F];F++);for(U<F&&(U=F),H=1,k=1;k<=ld;k++)if(H<<=1,(H-=W[k])<0)return-1;if(H>0&&(g===hd||1!==x))return-1;for(z[1]=0,k=1;k<ld;k++)z[k+1]=z[k]+W[k];for(L=0;L<v;L++)0!==m[S+L]&&(E[z[m[S+L]]++]=L);if(g===hd?(j=K=E,M=19):g===ud?(j=pd,q-=257,K=md,J-=257,M=256):(j=fd,K=Sd,M=-1),G=0,L=0,k=F,P=_,V=U,B=0,A=-1,R=($=1<<U)-1,g===ud&&$>cd||g===gd&&$>dd)return 1;for(;;){w=k-B,E[L]<M?(D=0,O=E[L]):E[L]>M?(D=K[J+E[L]],O=j[q+E[L]]):(D=96,O=0),I=1<<k-B,F=b=1<<V;do{C[P+(G>>B)+(b-=I)]=w<<24|D<<16|O|0}while(0!==b);for(I=1<<k-1;G&I;)I>>=1;if(0!==I?(G&=I-1,G+=I):G=0,L++,0==--W[k]){if(k===x)break;k=m[S+E[L]]}if(k>U&&(G&R)!==A){for(0===B&&(B=U),P+=F,H=1<<(V=k-B);V+B<x&&!((H-=W[V+B])<=0);)V++,H<<=1;if($+=1<<V,g===ud&&$>cd||g===gd&&$>dd)return 1;C[A=G&R]=U<<24|V<<16|P-_|0}}return 0!==G&&(C[P+G]=k-B<<24|64<<16|0),T.bits=U,0},Cd=0,_d=1,yd=2,Ed=4,Td=5,Id=6,bd=0,Ad=1,Rd=2,Pd=-2,Md=-3,wd=-4,Dd=-5,Od=8,Nd=1,kd=2,Ld=3,Fd=4,xd=5,Ud=6,Vd=7,Bd=8,Hd=9,$d=10,Gd=11,jd=12,qd=13,Wd=14,zd=15,Kd=16,Jd=17,Yd=18,Qd=19,Xd=20,Zd=21,eh=22,th=23,ih=24,nh=25,rh=26,sh=27,ah=28,oh=29,lh=30,ch=31,dh=852,hh=592,uh=15;function zswap32(g){return(g>>>24&255)+(g>>>8&65280)+((65280&g)<<8)+((255&g)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new dl.Buf16(320),this.work=new dl.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(g){var m;return g&&g.state?(m=g.state,g.total_in=g.total_out=m.total=0,g.msg="",m.wrap&&(g.adler=1&m.wrap),m.mode=Nd,m.last=0,m.havedict=0,m.dmax=32768,m.head=null,m.hold=0,m.bits=0,m.lencode=m.lendyn=new dl.Buf32(dh),m.distcode=m.distdyn=new dl.Buf32(hh),m.sane=1,m.back=-1,bd):Pd}function inflateReset(g){var m;return g&&g.state?((m=g.state).wsize=0,m.whave=0,m.wnext=0,inflateResetKeep(g)):Pd}function inflateReset2(g,m){var S,v;return g&&g.state?(v=g.state,m<0?(S=0,m=-m):(S=1+(m>>4),m<48&&(m&=15)),m&&(m<8||m>15)?Pd:(null!==v.window&&v.wbits!==m&&(v.window=null),v.wrap=S,v.wbits=m,inflateReset(g))):Pd}function inflateInit2(g,m){var S,v;return g?(v=new InflateState,g.state=v,v.window=null,(S=inflateReset2(g,m))!==bd&&(g.state=null),S):Pd}function inflateInit(g){return inflateInit2(g,uh)}var gh,ph,mh=!0;function fixedtables(g){if(mh){var m;for(gh=new dl.Buf32(512),ph=new dl.Buf32(32),m=0;m<144;)g.lens[m++]=8;for(;m<256;)g.lens[m++]=9;for(;m<280;)g.lens[m++]=7;for(;m<288;)g.lens[m++]=8;for(vd(_d,g.lens,0,288,gh,0,g.work,{bits:9}),m=0;m<32;)g.lens[m++]=5;vd(yd,g.lens,0,32,ph,0,g.work,{bits:5}),mh=!1}g.lencode=gh,g.lenbits=9,g.distcode=ph,g.distbits=5}function updatewindow(g,m,S,v){var C,_=g.state;return null===_.window&&(_.wsize=1<<_.wbits,_.wnext=0,_.whave=0,_.window=new dl.Buf8(_.wsize)),v>=_.wsize?(dl.arraySet(_.window,m,S-_.wsize,_.wsize,0),_.wnext=0,_.whave=_.wsize):((C=_.wsize-_.wnext)>v&&(C=v),dl.arraySet(_.window,m,S-v,C,_.wnext),(v-=C)?(dl.arraySet(_.window,m,S-v,v,0),_.wnext=v,_.whave=_.wsize):(_.wnext+=C,_.wnext===_.wsize&&(_.wnext=0),_.whave<_.wsize&&(_.whave+=C))),0}function inflate(g,m){var S,v,C,_,E,T,I,b,A,R,P,M,w,D,O,N,k,L,F,x,U,V,B,H,$=0,G=new dl.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!g||!g.state||!g.output||!g.input&&0!==g.avail_in)return Pd;(S=g.state).mode===jd&&(S.mode=qd),E=g.next_out,C=g.output,I=g.avail_out,_=g.next_in,v=g.input,T=g.avail_in,b=S.hold,A=S.bits,R=T,P=I,V=bd;e:for(;;)switch(S.mode){case Nd:if(0===S.wrap){S.mode=qd;break}for(;A<16;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(2&S.wrap&&35615===b){S.check=0,G[0]=255&b,G[1]=b>>>8&255,S.check=Xl(S.check,G,2,0),b=0,A=0,S.mode=kd;break}if(S.flags=0,S.head&&(S.head.done=!1),!(1&S.wrap)||(((255&b)<<8)+(b>>8))%31){g.msg="incorrect header check",S.mode=lh;break}if((15&b)!==Od){g.msg="unknown compression method",S.mode=lh;break}if(A-=4,U=8+(15&(b>>>=4)),0===S.wbits)S.wbits=U;else if(U>S.wbits){g.msg="invalid window size",S.mode=lh;break}S.dmax=1<<U,g.adler=S.check=1,S.mode=512&b?$d:jd,b=0,A=0;break;case kd:for(;A<16;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(S.flags=b,(255&S.flags)!==Od){g.msg="unknown compression method",S.mode=lh;break}if(57344&S.flags){g.msg="unknown header flags set",S.mode=lh;break}S.head&&(S.head.text=b>>8&1),512&S.flags&&(G[0]=255&b,G[1]=b>>>8&255,S.check=Xl(S.check,G,2,0)),b=0,A=0,S.mode=Ld;case Ld:for(;A<32;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}S.head&&(S.head.time=b),512&S.flags&&(G[0]=255&b,G[1]=b>>>8&255,G[2]=b>>>16&255,G[3]=b>>>24&255,S.check=Xl(S.check,G,4,0)),b=0,A=0,S.mode=Fd;case Fd:for(;A<16;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}S.head&&(S.head.xflags=255&b,S.head.os=b>>8),512&S.flags&&(G[0]=255&b,G[1]=b>>>8&255,S.check=Xl(S.check,G,2,0)),b=0,A=0,S.mode=xd;case xd:if(1024&S.flags){for(;A<16;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}S.length=b,S.head&&(S.head.extra_len=b),512&S.flags&&(G[0]=255&b,G[1]=b>>>8&255,S.check=Xl(S.check,G,2,0)),b=0,A=0}else S.head&&(S.head.extra=null);S.mode=Ud;case Ud:if(1024&S.flags&&((M=S.length)>T&&(M=T),M&&(S.head&&(U=S.head.extra_len-S.length,S.head.extra||(S.head.extra=new Array(S.head.extra_len)),dl.arraySet(S.head.extra,v,_,M,U)),512&S.flags&&(S.check=Xl(S.check,v,M,_)),T-=M,_+=M,S.length-=M),S.length))break e;S.length=0,S.mode=Vd;case Vd:if(2048&S.flags){if(0===T)break e;M=0;do{U=v[_+M++],S.head&&U&&S.length<65536&&(S.head.name+=String.fromCharCode(U))}while(U&&M<T);if(512&S.flags&&(S.check=Xl(S.check,v,M,_)),T-=M,_+=M,U)break e}else S.head&&(S.head.name=null);S.length=0,S.mode=Bd;case Bd:if(4096&S.flags){if(0===T)break e;M=0;do{U=v[_+M++],S.head&&U&&S.length<65536&&(S.head.comment+=String.fromCharCode(U))}while(U&&M<T);if(512&S.flags&&(S.check=Xl(S.check,v,M,_)),T-=M,_+=M,U)break e}else S.head&&(S.head.comment=null);S.mode=Hd;case Hd:if(512&S.flags){for(;A<16;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(b!==(65535&S.check)){g.msg="header crc mismatch",S.mode=lh;break}b=0,A=0}S.head&&(S.head.hcrc=S.flags>>9&1,S.head.done=!0),g.adler=S.check=0,S.mode=jd;break;case $d:for(;A<32;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}g.adler=S.check=zswap32(b),b=0,A=0,S.mode=Gd;case Gd:if(0===S.havedict)return g.next_out=E,g.avail_out=I,g.next_in=_,g.avail_in=T,S.hold=b,S.bits=A,Rd;g.adler=S.check=1,S.mode=jd;case jd:if(m===Td||m===Id)break e;case qd:if(S.last){b>>>=7&A,A-=7&A,S.mode=sh;break}for(;A<3;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}switch(S.last=1&b,A-=1,3&(b>>>=1)){case 0:S.mode=Wd;break;case 1:if(fixedtables(S),S.mode=Xd,m===Id){b>>>=2,A-=2;break e}break;case 2:S.mode=Jd;break;case 3:g.msg="invalid block type",S.mode=lh}b>>>=2,A-=2;break;case Wd:for(b>>>=7&A,A-=7&A;A<32;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if((65535&b)!=(b>>>16^65535)){g.msg="invalid stored block lengths",S.mode=lh;break}if(S.length=65535&b,b=0,A=0,S.mode=zd,m===Id)break e;case zd:S.mode=Kd;case Kd:if(M=S.length){if(M>T&&(M=T),M>I&&(M=I),0===M)break e;dl.arraySet(C,v,_,M,E),T-=M,_+=M,I-=M,E+=M,S.length-=M;break}S.mode=jd;break;case Jd:for(;A<14;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(S.nlen=257+(31&b),b>>>=5,A-=5,S.ndist=1+(31&b),b>>>=5,A-=5,S.ncode=4+(15&b),b>>>=4,A-=4,S.nlen>286||S.ndist>30){g.msg="too many length or distance symbols",S.mode=lh;break}S.have=0,S.mode=Yd;case Yd:for(;S.have<S.ncode;){for(;A<3;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}S.lens[j[S.have++]]=7&b,b>>>=3,A-=3}for(;S.have<19;)S.lens[j[S.have++]]=0;if(S.lencode=S.lendyn,S.lenbits=7,B={bits:S.lenbits},V=vd(Cd,S.lens,0,19,S.lencode,0,S.work,B),S.lenbits=B.bits,V){g.msg="invalid code lengths set",S.mode=lh;break}S.have=0,S.mode=Qd;case Qd:for(;S.have<S.nlen+S.ndist;){for(;N=($=S.lencode[b&(1<<S.lenbits)-1])>>>16&255,k=65535&$,!((O=$>>>24)<=A);){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(k<16)b>>>=O,A-=O,S.lens[S.have++]=k;else{if(16===k){for(H=O+2;A<H;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(b>>>=O,A-=O,0===S.have){g.msg="invalid bit length repeat",S.mode=lh;break}U=S.lens[S.have-1],M=3+(3&b),b>>>=2,A-=2}else if(17===k){for(H=O+3;A<H;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}A-=O,U=0,M=3+(7&(b>>>=O)),b>>>=3,A-=3}else{for(H=O+7;A<H;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}A-=O,U=0,M=11+(127&(b>>>=O)),b>>>=7,A-=7}if(S.have+M>S.nlen+S.ndist){g.msg="invalid bit length repeat",S.mode=lh;break}for(;M--;)S.lens[S.have++]=U}}if(S.mode===lh)break;if(0===S.lens[256]){g.msg="invalid code -- missing end-of-block",S.mode=lh;break}if(S.lenbits=9,B={bits:S.lenbits},V=vd(_d,S.lens,0,S.nlen,S.lencode,0,S.work,B),S.lenbits=B.bits,V){g.msg="invalid literal/lengths set",S.mode=lh;break}if(S.distbits=6,S.distcode=S.distdyn,B={bits:S.distbits},V=vd(yd,S.lens,S.nlen,S.ndist,S.distcode,0,S.work,B),S.distbits=B.bits,V){g.msg="invalid distances set",S.mode=lh;break}if(S.mode=Xd,m===Id)break e;case Xd:S.mode=Zd;case Zd:if(T>=6&&I>=258){g.next_out=E,g.avail_out=I,g.next_in=_,g.avail_in=T,S.hold=b,S.bits=A,od(g,P),E=g.next_out,C=g.output,I=g.avail_out,_=g.next_in,v=g.input,T=g.avail_in,b=S.hold,A=S.bits,S.mode===jd&&(S.back=-1);break}for(S.back=0;N=($=S.lencode[b&(1<<S.lenbits)-1])>>>16&255,k=65535&$,!((O=$>>>24)<=A);){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(N&&0==(240&N)){for(L=O,F=N,x=k;N=($=S.lencode[x+((b&(1<<L+F)-1)>>L)])>>>16&255,k=65535&$,!(L+(O=$>>>24)<=A);){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}b>>>=L,A-=L,S.back+=L}if(b>>>=O,A-=O,S.back+=O,S.length=k,0===N){S.mode=rh;break}if(32&N){S.back=-1,S.mode=jd;break}if(64&N){g.msg="invalid literal/length code",S.mode=lh;break}S.extra=15&N,S.mode=eh;case eh:if(S.extra){for(H=S.extra;A<H;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}S.length+=b&(1<<S.extra)-1,b>>>=S.extra,A-=S.extra,S.back+=S.extra}S.was=S.length,S.mode=th;case th:for(;N=($=S.distcode[b&(1<<S.distbits)-1])>>>16&255,k=65535&$,!((O=$>>>24)<=A);){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(0==(240&N)){for(L=O,F=N,x=k;N=($=S.distcode[x+((b&(1<<L+F)-1)>>L)])>>>16&255,k=65535&$,!(L+(O=$>>>24)<=A);){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}b>>>=L,A-=L,S.back+=L}if(b>>>=O,A-=O,S.back+=O,64&N){g.msg="invalid distance code",S.mode=lh;break}S.offset=k,S.extra=15&N,S.mode=ih;case ih:if(S.extra){for(H=S.extra;A<H;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}S.offset+=b&(1<<S.extra)-1,b>>>=S.extra,A-=S.extra,S.back+=S.extra}if(S.offset>S.dmax){g.msg="invalid distance too far back",S.mode=lh;break}S.mode=nh;case nh:if(0===I)break e;if(M=P-I,S.offset>M){if((M=S.offset-M)>S.whave&&S.sane){g.msg="invalid distance too far back",S.mode=lh;break}M>S.wnext?(M-=S.wnext,w=S.wsize-M):w=S.wnext-M,M>S.length&&(M=S.length),D=S.window}else D=C,w=E-S.offset,M=S.length;M>I&&(M=I),I-=M,S.length-=M;do{C[E++]=D[w++]}while(--M);0===S.length&&(S.mode=Zd);break;case rh:if(0===I)break e;C[E++]=S.length,I--,S.mode=Zd;break;case sh:if(S.wrap){for(;A<32;){if(0===T)break e;T--,b|=v[_++]<<A,A+=8}if(P-=I,g.total_out+=P,S.total+=P,P&&(g.adler=S.check=S.flags?Xl(S.check,C,P,E-P):Jl(S.check,C,P,E-P)),P=I,(S.flags?b:zswap32(b))!==S.check){g.msg="incorrect data check",S.mode=lh;break}b=0,A=0}S.mode=ah;case ah:if(S.wrap&&S.flags){for(;A<32;){if(0===T)break e;T--,b+=v[_++]<<A,A+=8}if(b!==(4294967295&S.total)){g.msg="incorrect length check",S.mode=lh;break}b=0,A=0}S.mode=oh;case oh:V=Ad;break e;case lh:V=Md;break e;case ch:return wd;default:return Pd}return g.next_out=E,g.avail_out=I,g.next_in=_,g.avail_in=T,S.hold=b,S.bits=A,(S.wsize||P!==g.avail_out&&S.mode<lh&&(S.mode<sh||m!==Ed))&&updatewindow(g,g.output,g.next_out,P-g.avail_out),R-=g.avail_in,P-=g.avail_out,g.total_in+=R,g.total_out+=P,S.total+=P,S.wrap&&P&&(g.adler=S.check=S.flags?Xl(S.check,C,P,g.next_out-P):Jl(S.check,C,P,g.next_out-P)),g.data_type=S.bits+(S.last?64:0)+(S.mode===jd?128:0)+(S.mode===Xd||S.mode===zd?256:0),(0===R&&0===P||m===Ed)&&V===bd&&(V=Dd),V}function inflateEnd(g){if(!g||!g.state)return Pd;var m=g.state;return m.window&&(m.window=null),g.state=null,bd}function inflateGetHeader(g,m){var S;return g&&g.state?0==(2&(S=g.state).wrap)?Pd:(S.head=m,m.done=!1,bd):Pd}function inflateSetDictionary(g,m){var S,v=m.length;return g&&g.state?0!==(S=g.state).wrap&&S.mode!==Gd?Pd:S.mode===Gd&&Jl(1,m,v,0)!==S.check?Md:updatewindow(g,m,v,v)?(S.mode=ch,wd):(S.havedict=1,bd):Pd}var fh={inflateReset:inflateReset,inflateReset2:inflateReset2,inflateResetKeep:inflateResetKeep,inflateInit:inflateInit,inflateInit2:inflateInit2,inflate:inflate,inflateEnd:inflateEnd,inflateGetHeader:inflateGetHeader,inflateSetDictionary:inflateSetDictionary,inflateInfo:"pako inflate (from Nodeca project)"},Sh={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var vh=GZheader,Ch=Object.prototype.toString;function Inflate(g){if(!(this instanceof Inflate))return new Inflate(g);this.options=dl.assign({chunkSize:16384,windowBits:0,to:""},g||{});var m=this.options;m.raw&&m.windowBits>=0&&m.windowBits<16&&(m.windowBits=-m.windowBits,0===m.windowBits&&(m.windowBits=-15)),!(m.windowBits>=0&&m.windowBits<16)||g&&g.windowBits||(m.windowBits+=32),m.windowBits>15&&m.windowBits<48&&0==(15&m.windowBits)&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Kc,this.strm.avail_out=0;var S=fh.inflateInit2(this.strm,m.windowBits);if(S!==Sh.Z_OK)throw new Error(Zl[S]);this.header=new vh,fh.inflateGetHeader(this.strm,this.header)}function inflate$1(g,m){var S=new Inflate(m);if(S.push(g,!0),S.err)throw S.msg;return S.result}function inflateRaw(g,m){return(m=m||{}).raw=!0,inflate$1(g,m)}Inflate.prototype.push=function(g,m){var S,v,C,_,E,T,I=this.strm,b=this.options.chunkSize,A=this.options.dictionary,R=!1;if(this.ended)return!1;v=m===~~m?m:!0===m?Sh.Z_FINISH:Sh.Z_NO_FLUSH,"string"==typeof g?I.input=zc.binstring2buf(g):"[object ArrayBuffer]"===Ch.call(g)?I.input=new Uint8Array(g):I.input=g,I.next_in=0,I.avail_in=I.input.length;do{if(0===I.avail_out&&(I.output=new dl.Buf8(b),I.next_out=0,I.avail_out=b),(S=fh.inflate(I,Sh.Z_NO_FLUSH))===Sh.Z_NEED_DICT&&A&&(T="string"==typeof A?zc.string2buf(A):"[object ArrayBuffer]"===Ch.call(A)?new Uint8Array(A):A,S=fh.inflateSetDictionary(this.strm,T)),S===Sh.Z_BUF_ERROR&&!0===R&&(S=Sh.Z_OK,R=!1),S!==Sh.Z_STREAM_END&&S!==Sh.Z_OK)return this.onEnd(S),this.ended=!0,!1;I.next_out&&(0!==I.avail_out&&S!==Sh.Z_STREAM_END&&(0!==I.avail_in||v!==Sh.Z_FINISH&&v!==Sh.Z_SYNC_FLUSH)||("string"===this.options.to?(C=zc.utf8border(I.output,I.next_out),_=I.next_out-C,E=zc.buf2string(I.output,C),I.next_out=_,I.avail_out=b-_,_&&dl.arraySet(I.output,I.output,C,_,0),this.onData(E)):this.onData(dl.shrinkBuf(I.output,I.next_out)))),0===I.avail_in&&0===I.avail_out&&(R=!0)}while((I.avail_in>0||0===I.avail_out)&&S!==Sh.Z_STREAM_END);return S===Sh.Z_STREAM_END&&(v=Sh.Z_FINISH),v===Sh.Z_FINISH?(S=fh.inflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===Sh.Z_OK):v!==Sh.Z_SYNC_FLUSH||(this.onEnd(Sh.Z_OK),I.avail_out=0,!0)},Inflate.prototype.onData=function(g){this.chunks.push(g)},Inflate.prototype.onEnd=function(g){g===Sh.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=dl.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg};var _h={Inflate:Inflate,inflate:inflate$1,inflateRaw:inflateRaw,ungzip:inflate$1},yh={};(0,dl.assign)(yh,rd,_h,Sh);var Eh=yh;function defer$1(){let g,m,S=!0;return{isPending:()=>S,promise:new Promise(((S,v)=>{g=S,m=v})),resolve:m=>{S&&(g(m),S=!1)},reject:g=>{S&&(m(g),S=!1)}}}function sleep(g){return new Promise((m=>_setTimeout(m,g)))}function _setTimeout(g,m){return globalThis.setTimeout(g,m)}function _clearTimeout(g){globalThis.clearTimeout(g)}function wait(g,m){const S=defer$1();let v;try{v=g()}catch(g){return Promise.reject(S.reject(g))}if(m<0)return v.finally((()=>{S.resolve(v)})),S.promise;const C=_setTimeout((()=>{S.isPending()&&S.reject(new CallingCommunicationError({defaultError:D.INTERNAL.OPERATION_TIMEDOUT}))}),m);return v.catch((g=>{_clearTimeout(C),S.isPending()&&S.reject(g)})).finally((()=>{_clearTimeout(C),S.isPending()&&S.resolve(v)})),S.promise}function dictOrderGreaterFirst(g,m){var S=g.toString(),v=m.toString();return S>v?1:S<v?-1:0}var Th=dictOrderGreaterFirst;function _classCallCheck(g,m){if(!(g instanceof m))throw new TypeError("Cannot call a class as a function")}function _defineProperties(g,m){for(var S=0;S<m.length;S++){var v=m[S];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(g,v.key,v)}}function _createClass(g,m,S){return m&&_defineProperties(g.prototype,m),S&&_defineProperties(g,S),g}function _defineProperty(g,m,S){return m in g?Object.defineProperty(g,m,{value:S,enumerable:!0,configurable:!0,writable:!0}):g[m]=S,g}var Ih=function(){function PriorityQueue(){var g=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).comparator,m=void 0===g?Th:g;_classCallCheck(this,PriorityQueue),_defineProperty(this,"comparator",void 0),this.comparator=m}return _createClass(PriorityQueue,null,[{key:"from",value:function from(g,m){throw new Error("not implemented")}}]),_createClass(PriorityQueue,[{key:"clear",value:function clear(){throw new Error("not implemented")}},{key:"toArray",value:function toArray(){throw new Error("not implemented")}},{key:"push",value:function push(g){throw new Error("not implemented")}},{key:"enqueue",value:function enqueue(g){return this.push(g)}},{key:"top",value:function top(){throw new Error("not implemented")}},{key:"peek",value:function peek(){return this.top()}},{key:"pop",value:function pop(){throw new Error("not implemented")}},{key:"dequeue",value:function dequeue(){return this.pop()}},{key:"merge",value:function merge(g){throw new Error("not implemented")}},{key:"isEmpty",value:function isEmpty(){throw new Error("not implemented")}},{key:"length",get:function get(){throw new Error("not implemented")}}]),PriorityQueue}();function _typeof(g){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(g){return typeof g}:function _typeof(g){return g&&"function"==typeof Symbol&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},_typeof(g)}function _toConsumableArray(g){return _arrayWithoutHoles(g)||_iterableToArray(g)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(g){if(Symbol.iterator in Object(g)||"[object Arguments]"===Object.prototype.toString.call(g))return Array.from(g)}function _arrayWithoutHoles(g){if(Array.isArray(g)){for(var m=0,S=new Array(g.length);m<g.length;m++)S[m]=g[m];return S}}function _classCallCheck$1(g,m){if(!(g instanceof m))throw new TypeError("Cannot call a class as a function")}function _defineProperties$1(g,m){for(var S=0;S<m.length;S++){var v=m[S];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(g,v.key,v)}}function _createClass$1(g,m,S){return m&&_defineProperties$1(g.prototype,m),S&&_defineProperties$1(g,S),g}function _possibleConstructorReturn(g,m){return!m||"object"!==_typeof(m)&&"function"!=typeof m?_assertThisInitialized(g):m}function _getPrototypeOf(g){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(g){return g.__proto__||Object.getPrototypeOf(g)},_getPrototypeOf(g)}function _assertThisInitialized(g){if(void 0===g)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return g}function _inherits(g,m){if("function"!=typeof m&&null!==m)throw new TypeError("Super expression must either be null or a function");g.prototype=Object.create(m&&m.prototype,{constructor:{value:g,writable:!0,configurable:!0}}),m&&_setPrototypeOf(g,m)}function _setPrototypeOf(g,m){return _setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(g,m){return g.__proto__=m,g},_setPrototypeOf(g,m)}function _defineProperty$1(g,m,S){return m in g?Object.defineProperty(g,m,{value:S,enumerable:!0,configurable:!0,writable:!0}):g[m]=S,g}function getLargestIndex(g,m,S){var v=2*m,C=2*m+1,_=m;return v<g.length&&S(g[_],g[v])<0&&(_=v),C<g.length&&S(g[_],g[C])<0&&(_=C),_}function heapify(g,m,S){var v=getLargestIndex(g,m,S);if(v!==m){var C=g[m];g[m]=g[v],g[v]=C,heapify(g,v,S)}}function heapifyAll(g){for(var m=Math.floor(g.collection.length/2)-1;m>=0;--m)heapify(g.collection,m,g.comparator)}var bh,Ah,Rh,Ph,Mh,wh,Dh,Oh=function(g){function BinaryHeap(){var g,m;_classCallCheck$1(this,BinaryHeap);for(var S=arguments.length,v=new Array(S),C=0;C<S;C++)v[C]=arguments[C];return _defineProperty$1(_assertThisInitialized(m=_possibleConstructorReturn(this,(g=_getPrototypeOf(BinaryHeap)).call.apply(g,[this].concat(v)))),"collection",[]),m}return _inherits(BinaryHeap,g),_createClass$1(BinaryHeap,[{key:"clear",value:function clear(){this.collection.length=0}},{key:"toArray",value:function toArray(){return _toConsumableArray(this.collection).sort(this.comparator)}},{key:"top",value:function top(){if(0===this.length)throw new Error("invalid operation: top() called for empty BinaryHeap");return this.collection[0]}},{key:"pop",value:function pop(){if(0===this.length)throw new Error("invalid operation: pop() called for empty BinaryHeap");var g=this.collection[0];return this.collection.length>1?(this.collection[0]=this.collection.pop(),heapify(this.collection,0,this.comparator)):this.collection.pop(),g}},{key:"push",value:function push(g){this.collection.push(g);for(var m=this.collection,S=m.length-1,v=Math.floor(S/2);S>0&&this.comparator(m[v],m[S])<0;S=v,v=Math.floor(v/2)){var C=m[S];m[S]=m[v],m[v]=C}}},{key:"merge",value:function merge(g){this.collection=g instanceof BinaryHeap?this.collection.concat(g.collection):this.collection.concat(g.toArray()),heapifyAll(this),g.clear()}},{key:"isEmpty",value:function isEmpty(){return!this.collection.length}},{key:"length",get:function get(){return this.collection.length}}],[{key:"from",value:function from(g){var m=new BinaryHeap(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return m.collection=Array.from(g),heapifyAll(m),m}}]),BinaryHeap}(Ih),Nh=Oh;class NotificationManager$1{constructor(g,m){this._tenantId=g,this.listeners=[],this._logger=m.createChild(`TelemetryLogger[${g}]`);const S=this._tenantId;m.log(`Notification Manager Notification Manager logger initialized for tenant ${S}`),this._discardedEventsBufferPQ=new Nh({comparator:(g,m)=>m.latency-g.latency})}addNotificationListener(g){this.listeners.find((m=>m===g))||this.listeners.push(g)}removeNotificationListener(g){this.listeners=this.listeners.filter((m=>m!==g))}eventsSent(g){const m=JSON.stringify(g);this._logger.log(`Notification Manager sent telemetry events ${m}`),this.listeners.forEach((m=>m.eventsSent&&m.eventsSent(g)))}eventsDiscarded(g,m){this._logger.log(`Notification Manager discarded telemetry events ${JSON.stringify(g)}, reason ${m} adding to retry buffer`),g.forEach((g=>{g.latency=g.latency||Jt.Normal;const m=g;(m.sendAttempt||0)<=getAcsEcsConfig().telemetry.discardedEventsMaxRetries?this._discardedEventsBufferPQ.push(m):this._logger.log(`Notification Manager dropping event due to too many retries ${JSON.stringify(g)}`)}));const S=getAcsEcsConfig().telemetry.discardedEventsBufferMaxLength;for(;this._discardedEventsBufferPQ.length>S;)this._logger.log(` dropping event from retry buffer ${this._discardedEventsBufferPQ.dequeue()} due to overflow`);this.listeners.forEach((S=>S.eventsDiscarded&&S.eventsDiscarded(g,m)))}getDiscardedEvents(){const g=[],m=this._discardedEventsBufferPQ.length;for(let S=0;S<m;S++)g.push(this._discardedEventsBufferPQ.dequeue());return g}}class TelemetryLogManager{constructor(g,m,S,v){this._telemetryLoggers=new Map,this._eventsBufferMap=new Map,this._initialized=!1,this.sdkDiagnosticInformation="",this._telemetryRateLimit=new Map,this._mediaEventsReportedForTheCall={},this._logger=g.createChild("TelemetryLogManager"),this.sdkDiagnosticInformation=m,this._sdkInternaVersion=getSdkInternalVersion(),this._acsProxy=S,this._acsCustomRelayManager=v,getAcsEcsConfig().telemetry.limit.rates.forEach((g=>{this._telemetryRateLimit.set(g.eventName,{...g,windowStartTime:Date.now(),eventCount:0})}))}getTelemetryLoggers(){return this._telemetryLoggers}getEventsBufferMap(){return this._eventsBufferMap}isInitialized(){return this._initialized}getCloudType(){return this._caConfigBag?.cloudType}getAcsResourceId(){return this._caConfigBag?.acsResourceId}getClientId(){return this._caConfigBag?.clientId}initialize(g){if(!g.cloudType)throw this._logger.error("Failed to initialize telemetry loggers, invalid cloud type provided."),new CallingCommunicationError({defaultError:D.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE_INVALID_CLOUD_TYPE});if(this._initialized)throw this._logger.error("Failed to initialize telemetry loggers, telemetry log manager is already initialized."),new CallingCommunicationError({defaultError:D.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE_ALREADY_INITIALIZED});this._telemetryLoggers.forEach(((m,S)=>{try{m.initialize(g),this._logger.log(`Initialized and flushed buffered telemetry logger for ${S}`)}catch(g){this._logger.warn(`Failed to initialize and flush buffered telemetry logger for ${S}`),this._telemetryLoggers.delete(S)}})),this._initialized=!0,this._caConfigBag=g,this._logger.log(`Telemetry log manager has been initialized for Call Client: ${this._caConfigBag.clientId}`)}clearTelemetryLoggers(){const g=this._telemetryLoggers.size;return this._telemetryLoggers=new Map,this._caConfigBag=void 0,this._initialized=!1,g}getMediaEventReportedPromise(g){if(!this._mediaEventsReportedForTheCall[g]){const m=defer();m.promise.catch(noop),this._mediaEventsReportedForTheCall[g]=m}return this._mediaEventsReportedForTheCall[g].promise}_reportMediaEventForTheCall(g){if(this._mediaEventsReportedForTheCall[g])this._mediaEventsReportedForTheCall[g].resolve();else{const m=defer();m.promise.catch(noop),m.resolve(),this._mediaEventsReportedForTheCall[g]=m}}_getEventDataWithoutPii(g){const m={};if(g.properties)for(const S of Object.keys(g.properties)){const v=g.properties[S];m[S]={value:v?.value??v,kind:v?.piiKind??0}}return m}sendEvent(g,m){try{if(this._logger.debug(`sending event=${g.name}`),this.checkIfEventIsBlocked(g)||this.shouldLimitSendingTelemetry(g.name)||this.isRateLimitExceeded(g.name))return void this._logger.debug(`event=${g.name} is blocked`);const S={name:g.name,data:g.properties};S?.name in Uh&&(S.data=this._getEventDataWithoutPii(g)),void 0===S.data&&(S.data={}),S?.name===Uh.mdsc_webrtc_session&&this._reportMediaEventForTheCall(S?.data?.CorrelationId),void 0!==typeof g.priority?S.latency=g.priority:S.latency=Jt.Normal;const v=getAcsEcsConfig().telemetryEvents.eventNameToPriority.eventName.indexOf(g.name);-1!==v&&(S.latency=getAcsEcsConfig().telemetryEvents.eventNameToPriority.priority[v]),S.data.sdkVersion=this._sdkInternaVersion,S.data.platformId=getPlatformId();const C=`${getPlatformId()}/${this._sdkInternaVersion}`;S.data.uiVersion=C,S.data.ui_version=C,S.data.Platform_Uiversion=C,S.data.userAgent=`${this.sdkDiagnosticInformation} ${navigator.userAgent}`,S.data.clientTimestamp=+new Date,S.data.customProxyAndRelayUsage=this.getCustomProxyAndRelayTag();const _=g.tenant;let E=this._eventsBufferMap.get(_);E||(E=this._eventsBufferMap.set(_,[]).get(_));let T=this._telemetryLoggers.get(_);if(T||(T=new TelemetryLogger(_,this._logger,E,this._acsProxy),this._telemetryLoggers.set(_,T),this._logger.log(`Created telemetry logger for ${_}`)),this._initialized){if(!T.isInitialized())try{T.initialize(this._caConfigBag),this._logger.log(`Created and initialized telemetry logger for ${_}`)}catch(g){throw this._telemetryLoggers.delete(_),E?.push(S),this._logger.error(`Failed to create and initialize telemetry logger for ${_}`),new CallingCommunicationError({defaultError:D.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE,defaultErrorMessageArgs:[_]})}m&&T.getAppInsightsCore()?.addNotificationListener(m),T.sendEvent(S)}else E?.push(S)}catch(m){this._logger.warn(`Failed to send event ${g?.name}`)}}async flushAllEvents(g){if(this._logger.debug(`flushing events: ${this._telemetryLoggers.size}`),-1!==getAcsEcsConfig().telemetry.telemetryFlushTimeout){const flushLogger=(m,S)=>{try{const v=defer();v.promise.catch(noop);const C=wait((async()=>(S===Za&&await this.getMediaEventReportedPromise(g),v.promise)),getAcsEcsConfig().telemetry.telemetryFlushTimeout);return m.flushEvents((()=>{this._logger.debug("events flushed"),v.resolve()})),C.then(noop)}catch(g){throw new CallingCommunicationError({defaultError:D.INTERNAL.TELEMETRY_FAILED_TO_FLUSH})}},m=[];return this._telemetryLoggers.forEach(((g,S)=>{m.push(flushLogger(g,S).catch((()=>{this._logger.warn("Failed to flush telemetry")})))})),Promise.all(m)}this._telemetryLoggers.forEach((g=>{try{g.flushEvents()}catch(g){this._logger.warn("Failed to flush telemetry")}}))}checkIfEventIsBlocked(g){const m=g.name,S=g.properties?.kindOfEvent,v=getAcsEcsConfig().telemetry.blockedEvents,C=getAcsEcsConfig().telemetry.blockedKindOfEvents;return v.includes(m)||void 0!==C.find((g=>g.name==m&&g.kindOfEvents.includes(S)))}shouldLimitSendingTelemetry(g){return getAcsEcsConfig().telemetry.limit.outSideCall.enabled&&(0===getAcsEcsConfig().telemetry.limit.outSideCall.includedEvents.length||getAcsEcsConfig().telemetry.limit.outSideCall.includedEvents.includes(g))&&!getAcsEcsConfig().telemetry.limit.outSideCall.excludedEvents.includes(g)&&TelemetryLogManager.callEndTimestamp!==Number.MAX_SAFE_INTEGER&&TelemetryLogManager.callEndTimestamp+getAcsEcsConfig().telemetry.limit.outSideCall.deltaTimeInMs-Date.now()<0}isRateLimitExceeded(g){const m=this._telemetryRateLimit.get(g);if(m){const S=Date.now();if(S-m.windowStartTime>m.windowSizeInMs&&(m.windowStartTime=S,m.eventCount=0),m.eventCount++,m.eventCount>m.maxEventPerWindow)return this._logger.info(`Telemetry event ${g} is rate limited`),!0}return!1}getCustomProxyAndRelayTag(){const g=this._acsProxy?.proxyInUse??!1,m=this._acsCustomRelayManager?.hasRelayConfig??!1;return g&&m?Jo.usedProxyAndNonMsftTurn:g?Jo.onlyUsedProxy:m?Jo.onlyUsedNonMsftTurn:Jo.noCustomProxyAndTurnUsed}}TelemetryLogManager.telemetryPayloadBytesOriginal=0,TelemetryLogManager.telemetryPayloadBytesCompressed=0,TelemetryLogManager.callEndTimestamp=0;class TelemetryLogger{constructor(g,m,S,v){this._tenantId=g,this._eventsBuffer=S,this._initialized=!1,this._networkOnline=!0,this._telemetryRetryIntervalRunning=!1,this._logger=m.createChild(`TelemetryLogger[${g}]`),this._acsProxy=v,window.addEventListener("online",(g=>{this._networkOnline=g.detail,this._networkOnline&&this._initialized&&!this._telemetryRetryIntervalRunning&&(this._logger.log("browser network back online starting telemetry send retry"),this.scheduleDiscardedTelemetryRetry())}))}initialize(g){if(this._initialized)this._logger.warn(`Telemetry logger for tenant: ${this._tenantId}, already initialized`);else try{const m=new Ks;this._appInsightsCore=new si,this._postChannel=new ns;const S={instrumentationKey:this._tenantId,extensions:[this._postChannel,m],disableCookiesUsage:!0},v={populateBrowserInfo:!0,populateOperatingSystemInfo:!0};void 0===S.extensionConfig&&(S.extensionConfig={}),S.extensionConfig[m.identifier]=v;const C={overrideEndpointUrl:this.getAriaCollectorUrl(g),payloadPreprocessor:getAcsEcsConfig().telemetry.gzipTelemetryPayload?(g,m)=>{this.gzipPayload(g,m)}:void 0};if(S.extensionConfig[this._postChannel.identifier]=C,Object.keys(getAcsEcsConfig().calling?.eudb?.acsCompliantEvents).length>0&&(kh={...kh,...getAcsEcsConfig().calling.eudb.acsCompliantEvents}),getAcsEcsConfig().telemetry.localStorageEnable){const g=new nr;S.extensions?.push(g);const m={storageKey:"WebSdkTelemetry"};S.extensionConfig[g.identifier]=m}this._NotificationManager=new NotificationManager$1(this._tenantId,this._logger),this._appInsightsCore.initialize(S,[],void 0,this._NotificationManager),this._caConfigBag=g,this.scheduleDiscardedTelemetryRetry(),this._initialized=!0,this._eventsBuffer.forEach((g=>{this.sendEvent(g)})),this._eventsBuffer.splice(0,this._eventsBuffer.length)}catch(g){throw this._logger.error(`Failed to initialize telemetry logger for tenant: ${this._tenantId}`),new CallingCommunicationError({defaultError:D.INTERNAL.TELEMETRY_LOGGER_INIT_FAIL})}}getCloudType(){return this._caConfigBag?.cloudType}getAcsResourceId(){return this._caConfigBag?.acsResourceId}getClientId(){return this._caConfigBag?.clientId}isInitialized(){return this._initialized}getAppInsightsCore(){return this._appInsightsCore}sendEvent(g){this._initialized&&(g?.name in kh&&this.appendEudbComplianceRegionToEvent(g),g?.data&&(g.data.clientId=this._caConfigBag?.clientId||"",0===g?.name?.indexOf("mdsc_webrtc")?g.data.metrics_AcsResourceId=this._caConfigBag?.acsResourceId||"":g.data.AcsResourceId=this._caConfigBag?.acsResourceId||"",g.data.cloudType=this._caConfigBag?.cloudType||"",g.data.identityType=this._caConfigBag?.identityType||""),this.sendAppInsightsCoreEvent(g))}scheduleDiscardedTelemetryRetry(){const g=getAcsEcsConfig().telemetry.discardedTelemetryRetryTimeout;let m=setInterval((async()=>{this._networkOnline?(this._NotificationManager?.getDiscardedEvents().forEach((g=>{this.sendEvent(g)})),this._telemetryRetryIntervalRunning=!0):(this._logger.log("browser lost network access stopping telemetry send retry"),clearInterval(m),this._telemetryRetryIntervalRunning=!1)}),g)}sendAppInsightsCoreEvent(g){this._appInsightsCore?.track(g)}flushEvents(g){this._initialized&&this._postChannel&&this._postChannel.flush(!1,g)}getAriaCollectorUrl(g){const m=isEudbConfigurationsApplicable(g.identityType,g.region);let S;if(g.identityType===la.Enterprise)S=m?ea.EnterpriseEUDB:ea.Enterprise;else switch(g.cloudType){case ta.Public:S=m?ea.PublicEUDB:ea.Public;break;case ta.GccHigh:S=ea.GccHigh;break;case ta.Dod:S=ea.Dod;break;case ta.AirGap08:S=ea.AirGap08;break;case ta.AirGap09:S=ea.AirGap09;break;default:S=ea.Public}return this._acsProxy?this._acsProxy.proxyfyUrl(S):S}gzipPayload(g,m){try{TelemetryLogManager.telemetryPayloadBytesOriginal+=getSizeInBytes(g.data,this._logger),g.data=Eh.gzip(g.data),g.urlString+="&content-encoding=gzip",TelemetryLogManager.telemetryPayloadBytesCompressed+=getSizeInBytes(g.data,this._logger)}catch(g){this._logger.warn("Failed to gzip with pako: ",g)}m(g)}getRegion(g){if(this._caConfigBag&&isRgnClaimApplicable(this._caConfigBag.identityType))switch(g){case"emea":case"de":return ma.EMEA;case"apac":return ma.APAC;case"noam":case"amer":return ma.NOAM;default:return this._logger.log(`Unable to map region \`${g}\`, to EudbTenantRegion`),ma.UNKNOWN}return g&&ha.includes(g)?ma.EMEA:g&&ua.includes(g)?ma.APAC:g&&ga.includes(g)?ma.NOAM:(this._logger.log(`Unable to map region \`${g}\`, to EudbTenantRegion`),ma.UNKNOWN)}appendEudbComplianceRegionToEvent(g){let m=this.getTenantComplianceRegion();const S=this.getRegion(this._caConfigBag?.region);if(g.data){let v={};v[Lh]=m,v[xh]=S,g.data[Fh]=v}}getTenantComplianceRegion(){return this._caConfigBag&&isEudbConfigurationsApplicable(this._caConfigBag.identityType,this._caConfigBag.region)?pa.EU:pa.RoW}}!function(g){g.remote_view="remote_view",g.remote_stream="remote_stream",g.network_quality="network_quality",g.video_device_issue="video_device_issue",g.other_diagnostic="other_diagnostic",g.logger_event="logger_event",g.number_of_participants="number_of_participants",g.media_metrics_device_events="media_metrics_device_events",g.sdk_active_in_another_tab="sdk_active_in_another_tab",g.network_changed="network_changed"}(bh||(bh={})),function(g){g.acs_calling_call_attempt="acs_calling_call_attempt",g.acs_calling_call_connected="acs_calling_call_connected",g.acs_calling_call_failed="acs_calling_call_failed",g.acs_calling_call_accept_attempt="acs_calling_call_accept_attempt",g.acs_calling_call_accept_connected="acs_calling_call_accept_connected",g.acs_calling_call_accept_failed="acs_calling_call_accept_failed",g.acs_calling_call_reject_attempt="acs_calling_call_reject_attempt",g.acs_calling_call_reject_success="acs_calling_call_reject_success",g.acs_calling_call_reject_failed="acs_calling_call_reject_failed",g.acs_calling_call_hangup_attempt="acs_calling_call_hangup_attempt",g.acs_calling_call_hangup_success="acs_calling_call_hangup_success",g.acs_calling_call_hangup_failure="acs_calling_call_hangup_failure",g.acs_calling_call_progress="acs_calling_call_progress",g.acs_calling_stack_init="acs_calling_stack_init",g.acs_calling_get_device_manager="acs_calling_get_device_manager",g.acs_calling_config_fetched_attempt="acs_calling_config_fetched_attempt",g.acs_calling_config_fetched_success="acs_calling_config_fetched_success",g.acs_calling_config_fetched_failure="acs_calling_config_fetched_failure",g.acs_calling_signaling_init="acs_calling_signaling_init",g.acs_calling_call_agent="acs_calling_call_agent",g.acs_calling_call_agent_init_attempt="acs_calling_call_agent_init_attempt",g.acs_calling_call_agent_init_success="acs_calling_call_agent_init_success",g.acs_calling_call_agent_init_failure="acs_calling_call_agent_init_failure",g.acs_calling_create_view_attempt="acs_calling_create_view_attempt",g.acs_calling_create_view_success="acs_calling_create_view_success",g.acs_calling_create_view_failure="acs_calling_create_view_failure",g.acs_calling_dispose_view_attempt="acs_calling_dispose_view_attempt",g.acs_calling_dispose_view_success="acs_calling_dispose_view_success",g.acs_calling_dispose_view_failure="acs_calling_dispose_view_failure",g.acs_calling_start_video_attempt="acs_calling_start_video_attempt",g.acs_calling_start_video_success="acs_calling_start_video_success",g.acs_calling_start_video_failure="acs_calling_start_video_failure",g.acs_calling_stop_video_on_ufd_attempt="acs_calling_stop_video_on_ufd_attempt",g.acs_calling_stop_video_attempt="acs_calling_stop_video_attempt",g.acs_calling_stop_video_success="acs_calling_stop_video_success",g.acs_calling_stop_video_failure="acs_calling_stop_video_failure",g.acs_calling_call_hold_and_resume="acs_calling_call_hold_and_resume",g.acs_calling_start_screen_share="acs_calling_start_screen_share",g.acs_calling_stop_screen_share="acs_calling_stop_screen_share",g.acs_calling_audio_stream_volume="acs_calling_audio_stream_volume",g.acs_calling_call_stats="acs_calling_call_stats",g.acs_calling_participant_added_or_removed="acs_calling_participant_added_or_removed",g.acs_calling_adp_attempt="acs_calling_adp_attempt",g.acs_calling_adp_success="acs_calling_adp_success",g.acs_calling_adp_failure="acs_calling_adp_failure",g.acs_calling_client_operations="acs_calling_client_operations",g.acs_calling_device_permission_changed="acs_calling_device_permission_changed",g.acs_calling_local_audio_source_changed="acs_calling_local_audio_source_changed",g.acs_calling_start_audio_stream_track="acs_calling_start_audio_stream_track",g.acs_calling_stop_audio_stream_track="acs_calling_stop_audio_stream_track",g.acs_calling_get_remote_audio_stream_track="acs_calling_get_remote_audio_stream_track",g.acs_calling_get_raw_device_media_stream="acs_calling_get_raw_device_media_stream",g.acs_calling_media_stream="acs_calling_media_stream",g.acs_calling_page_hidden="acs_calling_page_hidden",g.acs_calling_orientation_changed="acs_calling_orientation_changed",g.acs_calling_token_expiration_changed="acs_calling_token_expiration_changed",g.acs_calling_token_expiration_changed_failure="acs_calling_token_expiration_changed_failure",g.acs_calling_token_has_no_data_location="acs_calling_token_has_no_data_location",g.acs_calling_mute_on_ufd_attempt="acs_calling_mute_on_ufd_attempt",g.acs_calling_mute_attempt="acs_calling_mute_attempt",g.acs_calling_mute_success="acs_calling_mute_success",g.acs_calling_mute_failure="acs_calling_mute_failure",g.acs_calling_unmute_attempt="acs_calling_unmute_attempt",g.acs_calling_unmute_success="acs_calling_unmute_success",g.acs_calling_unmute_failure="acs_calling_unmute_failure",g.acs_calling_start_audio_attempt="acs_calling_start_audio_attempt",g.acs_calling_start_audio_success="acs_calling_start_audio_success",g.acs_calling_start_audio_failure="acs_calling_start_audio_failure",g.acs_calling_unmute_speaker_attempt="acs_calling_unmute_speaker_attempt",g.acs_calling_unmute_speaker_success="acs_calling_unmute_speaker_success",g.acs_calling_unmute_speaker_failure="acs_calling_unmute_speaker_failure",g.acs_calling_stop_audio_attempt="acs_calling_stop_audio_attempt",g.acs_calling_stop_audio_success="acs_calling_stop_audio_success",g.acs_calling_stop_audio_failure="acs_calling_stop_audio_failure",g.acs_calling_prevent_stop_audio="acs_calling_prevent_stop_audio",g.acs_calling_captions="acs_calling_captions",g.acs_calling_mid_call_media_stats="acs_calling_mid_call_media_stats",g.acs_calling_mid_call_new_media_stats="acs_calling_mid_call_new_media_stats",g.acs_calling_mid_call_raw_media_stats="acs_calling_mid_call_raw_media_stats",g.acs_calling_datachannel="acs_calling_datachannel",g.acs_calling_datachannel_stats="acs_calling_datachannel_stats",g.acs_calling_unmixed_audio="acs_calling_unmixed_audio",g.acs_calling_livestream_stats="acs_calling_livestream_stats",g.acs_calling_livestream_raw_stats="acs_calling_livestream_raw_stats",g.acs_calling_survey="acs_calling_survey",g.acs_calling_switch_video_source_attempt="acs_calling_switch_video_source_attempt",g.acs_calling_switch_video_source_success="acs_calling_switch_video_source_success",g.acs_calling_switch_video_source_failure="acs_calling_switch_video_source_failure",g.acs_calling_diagnostics_attempt="acs_calling_diagnostics_attempt",g.acs_calling_diagnostics_result="acs_calling_diagnostics_result",g.acs_calling_feature_usage="acs_calling_feature_usage",g.acs_calling_middletier_gateway_fetch_policy="acs_calling_middletier_gateway_fetch_policy",g.acs_calling_middletier_gateway_emergency_content="acs_calling_middletier_gateway_emergency_content",g.acs_calling_middletier_gateway_fetch_user_policies_for_captions="acs_calling_middletier_gateway_fetch_user_policies_for_captions",g.acs_calling_call_client_init="acs_calling_call_client_init",g.acs_calling_tab_events="acs_calling_tab_events",g.acs_calling_lobby_events="acs_calling_lobby_events",g.acs_calling_handle_push_notification="acs_calling_handle_push_notification"}(Ah||(Ah={})),function(g){g.attempt="attempt",g.success="success",g.failure="failure",g.getter="getter",g.setter="setter",g.subscribe="subscribe",g.unsubscribe="unsubscribe",g.initialize="initialize",g.event="event"}(Rh||(Rh={})),function(g){g.lobbyAdmit="lobbyAdmit",g.lobbyAdmitAll="lobbyAdmitAll",g.lobbyReject="lobbyReject"}(Ph||(Ph={})),function(g){g.MuteMicrophone="MuteMicrophone",g.MuteAllRemoteParticipants="MuteAllRemoteParticipants",g.MuteSpecificParticipant="MuteSpecificParticipant",g.UnmuteMicrophone="UnmuteMicrophone",g.MuteIncomingAudio="MuteIncomingAudio",g.UnmuteIncomingAudio="UnmuteIncomingAudio"}(Mh||(Mh={})),function(g){g.Expected="expected",g.Unexpected="unexpected",g.Unknown="unknown"}(wh||(wh={})),function(g){g.CaptionsKindChanged="CaptionsKindChanged",g.FirstCaptionReceived="FirstCaptionReceived",g.FirstCaptionParsingError="FirstCaptionParsingError",g.InitializeCaptions="InitializeCaptions",g.LanguageChanged="LanguageChanged",g.SetSpokenLanguage="SetSpokenLanguage",g.SetCaptionLanguage="SetCaptionLanguage",g.SpokenLanguageChanged="SpokenLanguageChanged",g.StartCaptions="StartCaptions",g.StopCaptions="StopCaptions",g.UpdateIsActive="UpdateIsActive"}(Dh||(Dh={}));let kh={...Ah,skypecosi_concore_web_csa_conversation_callmodality:"skypecosi_concore_web_csa_conversation_callmodality",skypecosi_concore_web_pluginless_modality_session:"skypecosi_concore_web_pluginless_modality_session",skypecosi_concore_web_pluginless_call_session:"skypecosi_concore_web_pluginless_call_session",skypecosi_concore_web_csa_conversation_httprequest:"skypecosi_concore_web_csa_conversation_httprequest"};const Lh="tenantComplianceRegion",Fh="acsCompliancePayload",xh="tenantRegion";var Uh,Vh,Bh,Hh,$h,Gh,jh,qh,Wh,zh,Kh,Jh,Yh,Qh,Xh,Zh,eu,tu,iu,nu,ru,su,au;function parseMeetingUrl(g){try{const m=new URL(g),S=m.pathname.split("/"),v=decodeURIComponent(S[3]),C=S[4],_=JSON.parse(decodeURIComponent(m.search.replace("?context=",""))),E=_.Oid;return{threadId:v,messageId:C,organizerId:E,tenantId:_.Tid}}catch(g){throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INVALID_MEETING_LINK,originalError:g})}}function parseTflMeetingLink(g){try{const m=new URL(g),S=m.pathname.split("/"),v=decodeURIComponent(S[2]),C=decodeURIComponent(g);return{meetingUrl:C,meetingCode:v,passcode:m.searchParams.get("p")??void 0}}catch(g){throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INVALID_TFL_MEETING_LINK,originalError:g})}}function base64UrlEncoding(g){let m=btoa(g).replace(/=/g,"");m=m.replace(/\+/g,"-"),m=m.replace(/\//g,"_");for(const g of m)if(g.match(/[^A-Za-z0-9-_]/))throw new CallingCommunicationError({defaultError:D.CALL.SERVER_CALL_ID});return m}!function(g){g.mdsc_webrtc_session="mdsc_webrtc_session",g.mdsc_webrtc_session_initial="mdsc_webrtc_session_initial"}(Uh||(Uh={})),function(g){g.Outgoing="Outgoing",g.Incoming="Incoming",g.TransferOutgoing="TransferOutgoing"}(Vh||(Vh={})),function(g){g.CreateCallAgent="CreateCallAgent",g.CreateTeamsCallAgent="CreateTeamsCallAgent",g.GetDeviceManager="GetDeviceManager",g.GetEnvironmentInfo="GetEnvironmentInfo",g.GetSDKVersion="GetSDKVersion",g.Feature="Feature"}(Bh||(Bh={})),function(g){g.StartCall="StartCall",g.Join="Join",g.HandlePushNotification="HandlePushNotification",g.Initialize="Initialize",g.Dispose="Dispose",g.CreateCall="CreateCall",g.Feature="Feature"}(Hh||(Hh={})),function(g){g.Call="Call",g.StartCall="StartCall",g.CallGroup="CallGroup",g.JoinGroup="JoinGroup",g.Accept="Accept",g.Reject="Reject",g.Mute="Mute",g.Unmute="Unmute",g.MuteAllRemoteParticipants="MuteAllRemoteParticipants",g.MuteIncomingAudio="MuteIncomingAudio",g.UnmuteIncomingAudio="UnmuteIncomingAudio",g.SendDtmf="SendDtmf",g.HangUp="HangUp",g.StartVideo="StartVideo",g.startAudio="startAudio",g.StopVideo="StopVideo",g.AddParticipant="AddParticipant",g.RemoveParticipant="RemoveParticipant",g.LobbyAdmitParticipant="LobbyAdmitParticipant",g.LobbyRejectParticipant="LobbyRejectParticipant",g.LobbyAdmitAll="LobbyAdmitAll",g.Hold="Hold",g.Resume="Resume",g.StartScreenShare="StartScreenShare",g.StopScreenShare="StopScreenShare",g.Transfer="Transfer",g.BindToCall="BindToCall",g.Feature="Feature",g.SetConstraints="SetConstraints"}($h||($h={})),function(g){g.Mute="Mute"}(Gh||(Gh={})),function(g){g.GetServerCallId="GetServerCallId"}(jh||(jh={})),function(g){g.CreateStackBase="CreateStackBase",g.GetDeviceManager="GetDeviceManager",g.InitializeStackForUser="InitializeStackForUser",g.InitializeEcsBase="InitializeEcsBase",g.InitializeEcsForUser="InitializeEcsForUser",g.Dispose="Dispose"}(qh||(qh={})),function(g){g.GetDeviceManager="GetDeviceManager",g.GetCameras="GetCameras",g.GetMicrophones="GetMicrophones",g.GetSpeakers="GetSpeakers",g.GetCamera="GetCamera",g.SelectCamera="SelectCamera",g.GetSelectedMicrophone="GetSelectedMicrophone",g.SelectMicrophone="SelectMicrophone",g.GetSelectedSpeaker="GetSelectedSpeaker",g.SelectSpeaker="SelectSpeaker",g.RenderPreviewVideo="RenderPreviewVideo",g.AskDevicePermission="AskDevicePermission"}(Wh||(Wh={})),function(g){g.Dispose="Dispose",g.UpdateScalingMode="UpdateScalingMode",g.Render="Render",g.RenderRemoteStream="RenderRemoteStream",g.RenderLocalStream="RenderLocalStream"}(zh||(zh={})),function(g){g.Dispose="Dispose",g.CreateView="CreateView"}(Kh||(Kh={})),function(g){g.SwitchSource="SwitchSource",g.Render="Render",g.GetMediaStream="GetMediaStream",g.SetMediaStream="SetMediaStream",g.SwitchVideo="SwitchVideo",g.Feature="Feature"}(Jh||(Jh={})),function(g){g.SwitchSource="SwitchSource",g.GetMediaStream="GetMediaStream",g.SetMediaStream="SetMediaStream",g.Feature="Feature"}(Yh||(Yh={})),function(g){g.SetScalingMode="SetScalingMode",g.Start="Start",g.Stop="Stop",g.SwitchDevice="SwitchDevice",g.Dispose="Dispose"}(Qh||(Qh={})),function(g){g.Render="Render",g.GetMediaStream="GetMediaStream"}(Xh||(Xh={})),function(g){g.Start="Start",g.Resume="Resume",g.Pause="Pause",g.SetScalingMode="SetScalingMode",g.Dispose="Dispose"}(Zh||(Zh={})),function(g){g.Start="Start",g.Resume="Resume",g.Pause="Pause",g.SetScalingMode="SetScalingMode",g.Dispose="Dispose",g.SetSourceObject="SetSourceObject"}(eu||(eu={})),function(g){g.SourceUnavailableError="SourceUnavailableError",g.PermissionDeniedError="permissionDeniedError",g.UnknownFailureForVideoOperation="UnknownFailureForVideoOperation"}(tu||(tu={})),function(g){g.BrowserNotSupported="BrowserNotSupported",g.IncompatibleVersions="IncompatibleVersions"}(iu||(iu={})),function(g){g.P2P="P2P",g.Multiparty="Multiparty",g.Unknown="Unknown"}(nu||(nu={})),function(g){g.GroupJoin="groupJoin",g.RoomJoin="roomJoin",g.TeamsMeetingJoin="teamsMeetingJoin",g.TransferToParticipant="transferToParticipant",g.TransferToCall="transferToCall",g.NoContext=""}(ru||(ru={})),function(g){g.Enabled="Enabled",g.UserOverride="UserOverride",g.Disabled="Disabled"}(su||(su={})),function(g){g.Standard="standard",g.MusicOnHold="musicOnHold"}(au||(au={}));var ou,lu,cu,du,hu,uu,__decorate=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallInfoCommonImpl{get threadId(){return this._threadId}get participantId(){return this._tsCall.participantId}constructor(g){this._tsCall=g,this._threadId=this._tsCall.threadId}initialize(g,m,S){this._logger=m,this._eventEmitter=g,this._threadId=this._tsCall.threadId,this._tsCallChangedListener=this._tsCall.changed((()=>this.threadIdChanged(this._tsCall)))}async getServerCallId(){const g=JSON.parse(await this._tsCall.getJoinBlob()),m=g?.conversationUrl;if(!m)throw new CallingCommunicationError({defaultError:D.CALL.GET_SERVER_CALL_ID});return base64UrlEncoding(m)}threadIdChanged(g){this._tsCall.threadId!==this._threadId&&(this._logger.log(`threadId changed from ${this._threadId} to ${g?.threadId}`),this._threadId=this._tsCall.threadId,this._eventEmitter.emit("threadIdChanged"))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._tsCallChangedListener?.dispose(),this._eventEmitter.removeAllListeners()}}__decorate([asyncOperation(jh.GetServerCallId),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],CallInfoCommonImpl.prototype,"getServerCallId",null);class CallInfoImpl extends CallInfoCommonImpl{get groupId(){return this._groupId}get roomId(){return this._roomId}get callScenario(){const g=this._tsCall.callType;return 1!==g&&2!==g?nu.Unknown:1===g?nu.P2P:nu.Multiparty}get direction(){return this._config?.isIncoming?Vh.Incoming:Vh.Outgoing}get initiatorKind(){return constructIdentifierKindFromMri(this._tsCall.callerMri?this._tsCall.callerMri:"").kind}get targetKind(){if(this._tsCall.groupId)return this._tsCall.groupId;if(this._config?.roomId)return this._config.roomId;if(this._tsCall.meetingData?.meetingUrl||this._tsCall.meetingData?.meetingCode)return"TeamsMeetingJoinLink";if(this._tsCall.transferorMri)return"Transferee";if(1===this._tsCall.participants.length){return constructIdentifierKindFromMri(this._tsCall.participants[0].id).kind}return this._tsCall.participants.filter((g=>g.id!==this._tsCall.callerMri)).map((g=>constructIdentifierKindFromMri(g.id).kind)).toString()}get transferorKind(){return this._tsCall.transferorMri?constructIdentifierKindFromMri(this._tsCall.transferorMri||"").kind:""}get context(){if(this._tsCall.groupId)return ru.GroupJoin;if(this._config?.roomId||this._roomId)return ru.RoomJoin;if(this._tsCall.meetingData?.meetingUrl||this._tsCall.meetingData?.passcode||this._tsCall.threadId)return ru.TeamsMeetingJoin;if("unknown"!==this.transferorKind){if("transfer"===this._tsCall.incomingCallType)return ru.TransferToParticipant;if("replaces"===this._tsCall.incomingCallType)return ru.TransferToCall}return ru.NoContext}constructor(g,m={}){super(g);const S=this._tsCall.groupId;this._groupId=!S||S.startsWith("19:")||S.startsWith("99:")?void 0:S,this._roomId=m.roomId,this._config=m.config}}!function(g){g.AudioRaw="AudioRaw",g.VideoRaw="VideoRaw",g.ScreenSharingRaw="ScreenSharingRaw",g.VideoRawOrScreenSharingRaw="VideoRawOrScreenSharingRaw",g.Audio="Audio",g.Video="Video"}(ou||(ou={})),function(g){g.Local="Local",g.Remote="Remote"}(lu||(lu={})),function(g){g.getMediaStream="getMediaStream",g.setMediaStream="setMediaStream",g.startEffects="startEffects",g.stopEffects="stopEffects",g.isSupported="isSupported",g.subscribe="subscribe",g.fpsWarningThresholdReached="fpsWarningThresholdReached",g.timeForEffectsWarningReached="timeForEffectsWarningReached",g.effectsError="effectsError",g.switchSource="switchSource",g.render="render"}(cu||(cu={})),function(g){g.stun="stun",g.turn="turn",g.turns="turns"}(du||(du={})),function(g){g.tcp="tcp",g.tls="tls",g.udp="udp"}(hu||(hu={})),function(g){g.Public_App="Public_App",g.Internal_LargeMeetingVideoRendering="Internal_LargeMeetingVideoRendering",g.Internal_RemoteVideoStreamDisposed="Internal_RemoteVideoStreamDisposed"}(uu||(uu={}));var gu,pu="object"==typeof Reflect?Reflect:null,mu=pu&&"function"==typeof pu.apply?pu.apply:function ReflectApply(g,m,S){return Function.prototype.apply.call(g,m,S)};function ProcessEmitWarning(g){console&&console.warn&&console.warn(g)}gu=pu&&"function"==typeof pu.ownKeys?pu.ownKeys:Object.getOwnPropertySymbols?function ReflectOwnKeys(g){return Object.getOwnPropertyNames(g).concat(Object.getOwnPropertySymbols(g))}:function ReflectOwnKeys(g){return Object.getOwnPropertyNames(g)};var fu=Number.isNaN||function NumberIsNaN(g){return g!=g};function EventEmitter(){EventEmitter.init.call(this)}var Su=EventEmitter,vu=once;EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var Cu,_u,yu=10;function checkListener(g){if("function"!=typeof g)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof g)}function _getMaxListeners(g){return void 0===g._maxListeners?EventEmitter.defaultMaxListeners:g._maxListeners}function _addListener(g,m,S,v){var C,_,E;if(checkListener(S),void 0===(_=g._events)?(_=g._events=Object.create(null),g._eventsCount=0):(void 0!==_.newListener&&(g.emit("newListener",m,S.listener?S.listener:S),_=g._events),E=_[m]),void 0===E)E=_[m]=S,++g._eventsCount;else if("function"==typeof E?E=_[m]=v?[S,E]:[E,S]:v?E.unshift(S):E.push(S),(C=_getMaxListeners(g))>0&&E.length>C&&!E.warned){E.warned=!0;var T=new Error("Possible EventEmitter memory leak detected. "+E.length+" "+String(m)+" listeners added. Use emitter.setMaxListeners() to increase limit");T.name="MaxListenersExceededWarning",T.emitter=g,T.type=m,T.count=E.length,ProcessEmitWarning(T)}return g}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(g,m,S){var v={fired:!1,wrapFn:void 0,target:g,type:m,listener:S},C=onceWrapper.bind(v);return C.listener=S,v.wrapFn=C,C}function _listeners(g,m,S){var v=g._events;if(void 0===v)return[];var C=v[m];return void 0===C?[]:"function"==typeof C?S?[C.listener||C]:[C]:S?unwrapListeners(C):arrayClone(C,C.length)}function listenerCount(g){var m=this._events;if(void 0!==m){var S=m[g];if("function"==typeof S)return 1;if(void 0!==S)return S.length}return 0}function arrayClone(g,m){for(var S=new Array(m),v=0;v<m;++v)S[v]=g[v];return S}function spliceOne(g,m){for(;m+1<g.length;m++)g[m]=g[m+1];g.pop()}function unwrapListeners(g){for(var m=new Array(g.length),S=0;S<m.length;++S)m[S]=g[S].listener||g[S];return m}function once(g,m){return new Promise((function(S,v){function eventListener(){void 0!==C&&g.removeListener("error",C),S([].slice.call(arguments))}var C;"error"!==m&&(C=function errorListener(S){g.removeListener(m,eventListener),v(S)},g.once("error",C)),g.once(m,eventListener)}))}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return yu},set:function(g){if("number"!=typeof g||g<0||fu(g))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+g+".");yu=g}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function setMaxListeners(g){if("number"!=typeof g||g<0||fu(g))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+g+".");return this._maxListeners=g,this},EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function emit(g){for(var m=[],S=1;S<arguments.length;S++)m.push(arguments[S]);var v="error"===g,C=this._events;if(void 0!==C)v=v&&void 0===C.error;else if(!v)return!1;if(v){var _;if(m.length>0&&(_=m[0]),_ instanceof Error)throw _;var E=new Error("Unhandled error."+(_?" ("+_.message+")":""));throw E.context=_,E}var T=C[g];if(void 0===T)return!1;if("function"==typeof T)mu(T,this,m);else{var I=T.length,b=arrayClone(T,I);for(S=0;S<I;++S)mu(b[S],this,m)}return!0},EventEmitter.prototype.addListener=function addListener(g,m){return _addListener(this,g,m,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function prependListener(g,m){return _addListener(this,g,m,!0)},EventEmitter.prototype.once=function once(g,m){return checkListener(m),this.on(g,_onceWrap(this,g,m)),this},EventEmitter.prototype.prependOnceListener=function prependOnceListener(g,m){return checkListener(m),this.prependListener(g,_onceWrap(this,g,m)),this},EventEmitter.prototype.removeListener=function removeListener(g,m){var S,v,C,_,E;if(checkListener(m),void 0===(v=this._events))return this;if(void 0===(S=v[g]))return this;if(S===m||S.listener===m)0==--this._eventsCount?this._events=Object.create(null):(delete v[g],v.removeListener&&this.emit("removeListener",g,S.listener||m));else if("function"!=typeof S){for(C=-1,_=S.length-1;_>=0;_--)if(S[_]===m||S[_].listener===m){E=S[_].listener,C=_;break}if(C<0)return this;0===C?S.shift():spliceOne(S,C),1===S.length&&(v[g]=S[0]),void 0!==v.removeListener&&this.emit("removeListener",g,E||m)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function removeAllListeners(g){var m,S,v;if(void 0===(S=this._events))return this;if(void 0===S.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==S[g]&&(0==--this._eventsCount?this._events=Object.create(null):delete S[g]),this;if(0===arguments.length){var C,_=Object.keys(S);for(v=0;v<_.length;++v)"removeListener"!==(C=_[v])&&this.removeAllListeners(C);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(m=S[g]))this.removeListener(g,m);else if(void 0!==m)for(v=m.length-1;v>=0;v--)this.removeListener(g,m[v]);return this},EventEmitter.prototype.listeners=function listeners(g){return _listeners(this,g,!0)},EventEmitter.prototype.rawListeners=function rawListeners(g){return _listeners(this,g,!1)},EventEmitter.listenerCount=function(g,m){return"function"==typeof g.listenerCount?g.listenerCount(m):listenerCount.call(g,m)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?gu(this._events):[]},Su.once=vu;class BaseCallAgentFeature{constructor(g){this.disposed=!1,this.callAgent=g.callAgent,this.callClient=g.callClient,this.eventEmitter=new Su.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class BaseCallClientFeature{constructor(g){this.disposed=!1,this.callClient=g.callClient,this.eventEmitter=new Su.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class BaseCallFeature{constructor(g){this.disposed=!1,this.call=g.call,this.callAgent=g.callAgent,this.callInfo=g.callInfo,this.eventEmitter=new Su.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class BaseVideoStreamFeature{constructor(g){this.disposed=!1,this.streamInstance=g.streamInstance,this.eventEmitter=new Su.EventEmitter}}class BaseAudioStreamFeature{constructor(g){this.disposed=!1,this.streamInstance=g.streamInstance,this.eventEmitter=new Su.EventEmitter}}!function(g){g[g.CallClientFeature=0]="CallClientFeature",g[g.CallAgentFeature=1]="CallAgentFeature",g[g.CallFeature=2]="CallFeature"}(Cu||(Cu={}));class FirstPartyCallFeature extends BaseCallFeature{}class FirstPartyCallAgentFeature extends BaseCallAgentFeature{}class FirstPartyCallClientFeature extends BaseCallClientFeature{}class FirstPartyVideoStreamFeature extends BaseVideoStreamFeature{}class FirstPartyAudioStreamFeature extends BaseAudioStreamFeature{}!function(g){g.Transfer="Transfer",g.StartCaptions="StartCaptions",g.StopCaptions="StopCaptions",g.SetSpokenLanguage="SetSpokenLanguage",g.SetCaptionLanguage="SetCaptionLanguage",g.getMediaStatsCollector="getMediaStatsCollector",g.disposeAllCollectors="disposeAllCollectors"}(_u||(_u={}));class ExtensibleFeatureImpl{constructor(g,m,S){this._logger=g,this._featureCtorContext=m,this._featureInitContext=S,this._apiObjInstances=new Map}getApiObjectInstance(g){if(!this._apiObjInstances.has(g)){const m=new g(this._featureCtorContext);return(m instanceof FirstPartyCallFeature||m instanceof FirstPartyCallAgentFeature||m instanceof FirstPartyCallClientFeature||m instanceof FirstPartyVideoStreamFeature||m instanceof FirstPartyAudioStreamFeature)&&m.initialize(this._featureInitContext,this._logger),this._apiObjInstances.set(g,m),m}return this._apiObjInstances.get(g)}dispose(){for(const[,g]of this._apiObjInstances)g.dispose()}}const Eu={commandUrl:"",processingModes:{closedCaptions:{state:"Inactive"},realTimeTranscript:{state:"Inactive"}},spokenLanguage:""};var Tu,Iu;!function(g){g.Acs="acs",g.Teams="teams",g.Unknown="unknown"}(Tu||(Tu={})),function(g){g.Captions="captions",g.TeamsCaptions="teams_captions"}(Iu||(Iu={}));class BaseLanguageCallFeatureImplOverTsCall{constructor(g){this._eventEmitter=g,this._captionsModeKey="closedCaptions",this._transcriptModeKey="realTimeTranscript",this._transcriptionDataId=3,this._isCaptionsBot=g=>g.id===this._captionsBotMri,this._getBotMetadata=g=>g?.endpoints?.endpointDetails[0]?.endpointMetadata??void 0,this._getBotDataMediaStreamSourceId=g=>{if(g?.endpoints?.endpointDetails[0]?.mediaStreams){let m=g?.endpoints?.endpointDetails[0]?.mediaStreams;if(m.length>0)for(let g in m)if("data"===m[g].type)return m[g].sourceId}},this._isCaptionsEnabled=g=>"Active"===g?.processingModes?.[this._captionsModeKey]?.state,this._isTranscriptionEnabled=g=>"Active"===g?.processingModes?.[this._transcriptModeKey]?.state,this._copyBotMetaData=g=>{const m=this._getBotMetadata(g)||Eu;return JSON.parse(JSON.stringify(m))},this._isSpokenLanguageChanged=g=>g?.spokenLanguage===this._acsMetadata?.spokenLanguage}dispose(){this._acsMetadata=void 0}}function callFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get callApiCtor(){return g},activationOptions:m,isCallFeature:!0}}function callClientFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get callClientApiCtor(){return g},activationOptions:m,isCallClientFeature:!0}}function videoStreamFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get videoStreamApiCtor(){return g},activationOptions:m,isVideoStreamFeature:!0}}function audioStreamFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get audioStreamApiCtor(){return g},activationOptions:m,isVideoStreamFeature:!0}}function getRoundedAverage(g,m,S=100){return Math.round((g/m+Number.EPSILON)*S)/S}function sendCallFeatureUsageTelemetry(g,m,S){try{const S={correlationId:g.correlationId||"",callId:g.callId,localParticipantId:g.localParticipantId,featureName:g.featureName,featureType:g.featureType,initializationType:g.initializationType,featureDetails:g.featureDetails,additionalDetails:g.additionalDetails||{}};m.sendEvent({name:Ah.acs_calling_feature_usage,tenant:Qa,properties:S})}catch(m){S.debug(`Unable to send ${g.featureName} feature usage telemtery`)}}function sendCallClientFeatureUsageTelemetry(g,m,S){try{const S={featureName:g.featureName,featureType:g.featureType,initializationType:g.initializationType,featureDetails:g.featureDetails};m.sendEvent({name:Ah.acs_calling_feature_usage,tenant:Qa,properties:S})}catch(m){S.debug(`Unable to send ${g.featureName} feature usage telemetry`)}}const bu={0:"",1:"Success",2:"NoNgcEndpoint",3:"NetworkError",4:"MediaDroppedError",5:"BadRequest",6:"CallEstablishmentTimeout",7:"CallSetupError",8:"NoPermission",9:"Missed",10:"Declined",11:"Busy",12:"Cancelled",13:"Dropped",14:"PstnInsufficientFunds",15:"PstnSkypeoutAccountBlocked",16:"PstnCouldNotConnectToSkypeProxy",17:"PstnBlockedByUs",18:"PstnBlockedRegulatoryIndia",19:"PstnInvalidNumber",20:"PstnNumberForbidden",21:"PstnCallTerminated",22:"PstnNumberUnavailable",23:"PstnEmergencyCallDenied",24:"CallNotFound",25:"LocalError",26:"NotAcceptableHere",27:"CallForwarded",28:"CallForwardedToVoicemail",29:"SkypeTokenError",30:"CallAccepted",31:"LocalHttpStackError",32:"UnknownError",33:"PstnNoSubscriptionCover",34:"SessionNotFound",35:"SessionTimedOut",36:"PstnCreditExpired",37:"PstnCreditExpiredButEnough",38:"RetargetNotSupported",39:"EnterprisePstnInternalError",40:"EnterprisePstnUnavailable",41:"EnterprisePstnForbidden",42:"EnterprisePstnInvalidNumber",43:"EnterprisePstnMiscError",44:"Kicked",45:"NetworkRequestTimeoutError",46:"CallDoesNotExist",47:"MediaSetupFailure",48:"ServiceUnavailable",49:"SignalingError",50:"ConversationEstablishmentFailed",51:"TemporarilyUnavailable",52:"CannotConnectToNetworkError",53:"MediaRelayWhiteListingIssue",54:"NoSignalingFromPeer",55:"DeniedInLobby",56:"TimedOutInLobby",57:"CallFailedConflict",58:"DevicePermissionDenied",59:"ConfParticipantCountLimitReached",60:"ActionNotAllowed",61:"Abandoned",62:"ForbiddenDueToPolicy",63:"InsufficientCapabilitiesForCallee",64:"UserBlocked",65:"AccessDenied",66:"AnonymousJoinDisabledByPolicy",67:"NoLobbyForBroadcastJoin",68:"NotAllowedDueToInformationBarrier",69:"BroadcastLimitReached",70:"TeamParkPolicyDisabled",71:"B2bJoinDisabledByPolicy",72:"LocationBasedRoutingError",73:"ConfLobbyParticipantCountLimitReached",74:"DowngradeToStreamingClient",75:"CallRedirected",76:"CallIsEndToEndEncrypted"},convertTerminatedReasonToString=g=>{const m="UnknownError";return"number"==typeof g&&bu[g]||m},Au={0:"",1:"AddingFailed",2:"NoResponse",3:"Declined",4:"NotReachable",5:"Blocked",6:"NotFriendOrAuthorized",7:"CallLimitReached",8:"CallNotFound",9:"NetworkError",10:"MediaDroppedError",11:"OtherError",12:"PstnInsufficientFunds",13:"PstnSkypeoutAccountBlocked",14:"PstnCouldNotConnectToSkypeProxy",15:"PstnBlockedByUs",16:"PstnBlockedRegulatoryIndia",17:"PstnInvalidNumber",18:"PstnNumberForbidden",19:"Busy",20:"PstnCallTerminated",21:"PstnNumberUnavailable",22:"PstnEmergencyCallDenied",23:"Cancelled",24:"Dropped",25:"PstnNoSubscriptionCover",26:"PstnCreditExpired",27:"PstnCreditExpiredButEnough",28:"EnterprisePstnInternalError",29:"EnterprisePstnUnavailable",30:"EnterprisePstnForbidden",31:"EnterprisePstnInvalidNumber",32:"EnterprisePstnMiscError",33:"Kicked",34:"NetworkRequestTimeoutError",35:"CallDoesNotExist",36:"MediaSetupFailure",37:"ServiceUnavailable",38:"SignalingError",39:"ConversationEstablishmentFailed",40:"TemporarilyUnavailable",41:"CannotConnectToNetworkError",42:"NoSignalingFromPeer",43:"ParticipantDoesNotExist",44:"DeniedInLobby",45:"TimedOutInLobby",46:"ConfParticipantCountLimitReached",47:"Abandoned",48:"ActionNotAllowed",49:"ForbiddenDueToPolicy",50:"InsufficientCapabilitiesForCallee",51:"AccessDenied",52:"NoPermission",53:"AnonymousJoinDisabledByPolicy",54:"NoLobbyForBroadcastJoin",55:"NotAllowedDueToInformationBarrier",56:"BroadcastLimitReached",57:"B2bJoinDisabledByPolicy",58:"LocationBasedRoutingError",59:"ConfLobbyParticipantCountLimitReached",60:"LobbyUserLeft"},convertParticipantStateReasonToString=g=>{const m="UnknownError";return"number"==typeof g&&Au[g]||m},Ru={0:"None",1:"Incoming Call",2:"Connecting",3:"Connected",4:"LocalHold",5:"RemoteHold",10:"InLobby",9:"EarlyMedia",6:"Disconnecting",7:"Disconnected",8:"Unknown",11:"Unknown",12:"Unknown",13:"Unknown",14:"Unknown",15:"Unknown"},Pu={0:"None",1:"RealTime",2:"Streaming"};function toDtmfTone(g){switch(g){case"Num0":return 0;case"Num1":return 1;case"Num2":return 2;case"Num3":return 3;case"Num4":return 4;case"Num5":return 5;case"Num6":return 6;case"Num7":return 7;case"Num8":return 8;case"Num9":return 9;case"Star":return 10;case"Pound":return 11;case"A":return 12;case"B":return 13;case"C":return 14;case"D":return 15;case"Flash":return 16;default:throw new CallingCommunicationError({defaultError:D.CALL.INVALID_DTMF_TONE})}}function getCallEndReason(g,m){let S=0,v=0,C=Oo,_=[];return g.tsCall&&(S=g.tsCall.callEndDiagnosticsInfo&&g.tsCall.callEndDiagnosticsInfo.callControllerCode||0,v=g.tsCall.callEndDiagnosticsInfo&&g.tsCall.callEndDiagnosticsInfo.callControllerSubCode||0,_=g.tsCall.callEndDiagnosticsInfo&&g.tsCall.callEndDiagnosticsInfo.resultCategories||["Success"]),C=convertTerminatedReasonToString(m||g.tsCall?.terminatedReason||0),g.logger.error(`Call end reason=${C}, code=${S}, subCode=${v}, resultCategories=${_.toString()}`),{callEndReason:{message:C,code:S,subCode:v,resultCategories:_},callingCommunicationError:new CallingCommunicationError({defaultError:{message:C,code:S,subCode:v,resultCategories:_}})}}function getRemoteParticipantCallEndReason(g,m,S){let v=0,C=0,_=Oo,E=[];if(m?.callEndDiagnosticsInfo)_=convertParticipantStateReasonToString(S||m.stateReason||0),v=m.callEndDiagnosticsInfo&&m.callEndDiagnosticsInfo.callControllerCode||0,C=m.callEndDiagnosticsInfo&&m.callEndDiagnosticsInfo.callControllerSubCode||0,E=m.callEndDiagnosticsInfo&&m.callEndDiagnosticsInfo.resultCategories||[];else{let m=getCallEndReason(g,S);v=m.callEndReason.code,C=m.callEndReason.subCode||0,E=m.callEndReason.resultCategories,_=m.callEndReason.message}return g.logger[0===v?"info":"error"](`Participant call end reason=${_}, code=${v}, subCode=${C}, resultCategories=${E.toString()}`),{callEndReason:{message:_,code:v,subCode:C,resultCategories:E},callingCommunicationError:new CallingCommunicationError({defaultError:{message:_,code:v,subCode:C,resultCategories:E}})}}function handleVideoOperationFailure(g,m){let S;switch(m?.type?m.type:tu.UnknownFailureForVideoOperation){case tu.SourceUnavailableError:S=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.SOURCE_UNAVAILABLE});break;case tu.PermissionDeniedError:S=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.PERMISSION_DENIED});break;default:S=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.UNKNOWN})}return S}function handleLobbyFailure(g,m,S){const v=void 0===m?.code?500:m?._code,C=m?.subCode||m?._subCode||0;return new CallingCommunicationError({defaultError:{message:S+", reason: "+(m?.phrase||m?.message||"unknown error"),code:v,subCode:C,resultCategories:m?.resultCategories||[]}})}function handleRaiseHandFailure(g,m){return new CallingCommunicationError({defaultError:{message:m.message,code:g?.response?.status||m.code,subCode:m.subCode,resultCategories:m.resultCategories},originalError:g})}function handleFetchPoliciesFromAcsMiddleTierFailure(g,m){return new CallingCommunicationError({defaultError:{message:g?.response?.data?.operationFailure?.phrase||m.message,code:g?.response?.data?.operationFailure?.code||m.code,subCode:g?.response?.data?.operationFailure?.subCode||m.subCode,resultCategories:g?.response?.data?.operationFailure?.resultCategories||m.resultCategories},originalError:g})}function extractCommunicationServicesErrorForTelemetry(g){return{communicationServicesError:{message:g.message||"Unknown error",code:void 0===g.code?F:g.code,subCode:g.subCode||0,resultCategories:void 0===g.resultCategories||0===g.resultCategories.length?["UnexpectedClientError"]:g.resultCategories}}}function extractCallEndReasonForTelemetry(g){return{callEndReason:{message:g.message,code:void 0===g.code?F:g.code,subCode:g.subCode||0,resultCategories:void 0===g.resultCategories||0===g.resultCategories.length?["UnexpectedClientError"]:g.resultCategories}}}var __decorate$1=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$1=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};const Mu=Date.UTC(1900,0,1),wu=3;class CaptionsCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new CaptionsCallFeatureImplOverTsCall(this.eventEmitter)}initialize(g,m){const S=generateGuid();this._impl.initialize(g.tsCall,g.call,g.callAgent,g.callAgent.getHttpRequestHelper(),g.telemetryLogManager,m,this._telemetryStartTime,S),this._logger=m,this._telemetryStartTime=+Date.now(),this._telemetryLogManager=g.telemetryLogManager,this._call=g.call}get name(){return this._sendFeatureUsage("name",Rh.getter),this._captionsTelemetryType.toString()}get _captionsTelemetryType(){return"TeamsCaptions"===this._impl.kind?Iu.TeamsCaptions:Iu.Captions}get captions(){return this._impl.captions}on(g,m){this.eventEmitter.on(g,m)}off(g,m){this.eventEmitter.off(g,m)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:this._captionsTelemetryType,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}class CaptionsCommonImpl{constructor(g,m){this._eventEmitter=m,this._impl=g}async startCaptions(g){await this._impl.startCaptions(g)}async stopCaptions(){await this._impl.stopCaptions()}async setSpokenLanguage(g){await this._impl.setSpokenLanguage(g)}get supportedSpokenLanguages(){return this._impl.supportedSpokenLanguages}get isCaptionsFeatureActive(){return this._impl.isCaptionsFeatureActive}get activeSpokenLanguage(){return this._impl.activeSpokenLanguage}get kind(){return this._impl.kind}}class CaptionsImpl extends CaptionsCommonImpl{constructor(g,m){super(g,m)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}}class TeamsCaptionsImpl extends CaptionsCommonImpl{constructor(g,m){super(g,m)}get supportedCaptionLanguages(){return this._impl.supportedCaptionLanguages}get activeCaptionLanguage(){return this._impl.activeCaptionLanguage}async setCaptionLanguage(g){await this._impl.setCaptionLanguage(g)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}}class CaptionsCallFeatureImplOverTsCall extends BaseLanguageCallFeatureImplOverTsCall{constructor(g,m,S,v){super(g),this._botParticipantId="",this._isCteUser=!1,this._isCaptionsActive=!1,this._firstTimeActive=!1,this._ecsCaptionsEnabled=!1,this._ecsSpokenLanguagesEnabled=!1,this._ecsSpokenLanguages=[],this._ecsCaptionLanguagesEnabled=!1,this._ecsCaptionLanguages=[],this._ecsAmtPolicyUrlSuffix="",this._hasReportedCaptionParseFailure=!1,this._hasReceivedFirstCaption=!1,this._currentLanguage="",this._currentCaptionLanguage="",this._participantSequenceIdMap={},this._addParticipantPromise=null,this._dataChannelHandler={onStarted:async(g,m)=>{},onStopped:async g=>{},onDataReceived:async(g,m,S)=>{let v;try{v=JSON.parse(m.toString())}catch(g){try{if(void 0===this._textDecoder)throw new Error("TextDecoder undefined.");v=JSON.parse(this._textDecoder.decode(m))}catch(g){return this._logger.error("Failed to parse Captions result",g),void(this._hasReportedCaptionParseFailure||(this._hasReportedCaptionParseFailure=!0,this._sendCaptionsEvent(Dh.FirstCaptionParsingError,Rh.failure,"",0,wh.Unexpected,"Could not decode data packet.")))}}if(v){let g=[];v.textTracks?g=v.textTracks:v.recognitionResults&&(g=v.recognitionResults),g.forEach((g=>{try{const[m,v]=g.id.split("/");let C=parseInt(v,10);if(this._participantSequenceIdMap[g.userId]&&this._botParticipantId==m&&this._participantSequenceIdMap[g.userId]>C)return;this._botParticipantId=m,this._participantSequenceIdMap[g.userId]=C;const _=this._tsCall.participants.find((m=>m.id===g.userId))?.displayName||(this._internalCallAgent.getUserMri()===g.userId?this._internalCallAgent?.displayName:void 0),E={resultType:g.isFinal?"Final":"Partial",captionText:g.text,spokenText:g.originalText??g.text,timestamp:new Date(new Date(g.timestampAudioSent/1e4).getTime()+Mu),speaker:{identifier:constructIdentifierKindFromMri(g.userId),displayName:_},spokenLanguage:g.spokenLanguage,captionLanguage:g.trackLanguage};if(this._currentLanguage!=g.spokenLanguage&&(this._currentLanguage=g.spokenLanguage,this._eventEmitter.emit("SpokenLanguageChanged")),!this.isCaptionsFeatureActive||this._mediaStreamSourceId!==S)return;this._hasReceivedFirstCaption||(this._hasReceivedFirstCaption=!0,this._sendCaptionsEvent(Dh.FirstCaptionReceived,Rh.success,"",0)),this._eventEmitter.emit("CaptionsReceived",E)}catch(g){this._logger.error("Failed to parse Captions result",g),this._hasReportedCaptionParseFailure||(this._hasReportedCaptionParseFailure=!0,this._sendCaptionsEvent(Dh.FirstCaptionParsingError,Rh.failure,"",0,wh.Unexpected,"Error thrown during incoming caption result mapping."))}}))}}},this._handleBotRemoved=g=>{this._acsMetadata&&this._isCaptionsBot(g)&&(this.isCaptionsFeatureActive&&(this._isCaptionsActive=!1,this._eventEmitter.emit("CaptionsActiveChanged")),this._acsMetadata=void 0,this._firstTimeActive=!1)},this._telemetryStartTime=Date.now()}get isCaptionsFeatureActive(){return!!this._acsMetadata&&this._isCaptionsEnabled(this._acsMetadata)&&this._isCaptionsActive}get supportedSpokenLanguages(){return this._ecsSpokenLanguages}get supportedCaptionLanguages(){return this._ecsCaptionLanguages}get captions(){return this._captions}get kind(){return this._name===Iu.TeamsCaptions?"TeamsCaptions":"Captions"}get activeSpokenLanguage(){return this._currentLanguage}get activeCaptionLanguage(){return this._currentCaptionLanguage}get isTeamsConversationType(){return mo.indexOf(this._tsCall.conversationType)>-1}get isTeamsUserInCall(){for(let g of this._tsCall.participants)if("microsoftTeamsUser"===constructIdentifierKindFromMri(g.id).kind)return!0;return!1}get isTeamsCallKind(){return this._call.kind===g.CallKind.TeamsCall}get isTeamsCaptionsBotInCall(){for(let g of this._tsCall.participants)if(g.id===getAcsEcsConfig().captions.teams.botMri)return!0;return!1}updateParticipantTranscriptionPrefsMetadata(g){let m;for(let g in this._tsCall.endpoints?.endpointDetails)if(this._tsCall.endpoints?.endpointDetails[g].participantId===this._tsCall.participantId){m=this._tsCall.endpoints?.endpointDetails[g];break}const S=m?.endpointMetadata??{transcriptionPrefs:{}};g?S.transcriptionPrefs?.closedCaptions?S.transcriptionPrefs.closedCaptions=g:S.transcriptionPrefs={closedCaptions:g}:S.transcriptionPrefs?.closedCaptions&&delete S.transcriptionPrefs.closedCaptions,this._tsCall.updateEndpointMetadata(JSON.stringify(S))}initialize(g,m,S,v,C,_,E,T){this._logger=_.createChild((()=>`CaptionsFeature::Call(id='${g.callId}', state='${g.state}')`)),this._tsCall=g,this._call=m,this._internalCallAgent=S,this._httpRequestHelper=v,this._telemetryLogManager=C,this._telemetryStartTime=E,this._isCteUser=S.isCteUser(),this._ecsCaptionsEnabled=getAcsEcsConfig().captions.enabled,this._name=this.isTeamsConversationType||this._isCteUser||this.isTeamsUserInCall||this.isTeamsCaptionsBotInCall||this.isTeamsCallKind?Iu.TeamsCaptions:Iu.Captions,this.updateCaptionsData(this._name),this._sendCaptionsEvent(Dh.InitializeCaptions,Rh.initialize,T,this._telemetryStartTime),this._initializationPromise=new Promise(((g,m)=>{this._initializeAsync(T).then((m=>g())).catch((g=>m(g)))}))}async _initializeAsync(g){try{this._textDecoder=new TextDecoder,this._tsCall.on("participantAdded",(async m=>{if(this._captions&&"Captions"===this._captions.kind&&"microsoftTeamsUser"===constructIdentifierKindFromMri(m.id).kind){if(this._captionsBotMri)try{await this._tsCall.removeParticipant(this._captionsBotMri)}catch(S){const v=new CallingCommunicationError({defaultError:{message:convertParticipantStateReasonToString(S),code:m.callEndDiagnosticsInfo?.callControllerCode||0,subCode:m.callEndDiagnosticsInfo?.callControllerSubCode||0,resultCategories:m.callEndDiagnosticsInfo?.resultCategories||["UnexpectedClientError"]},originalError:S});this._sendCaptionsEvent(Dh.CaptionsKindChanged,Rh.failure,g,this._telemetryStartTime,wh.Unexpected,v.message,v.code,v.subCode,extractCommunicationServicesErrorForTelemetry(v))}this.updateCaptionsData(Iu.TeamsCaptions),this._isCaptionsActive&&(this._currentLanguage&&this._ecsSpokenLanguages.includes(this._currentLanguage)?await this._captions.startCaptions({spokenLanguage:this._currentLanguage}):await this._captions.startCaptions()),this._eventEmitter.emit("CaptionsKindChanged"),this._sendCaptionsEvent(Dh.CaptionsKindChanged,Rh.success,g,this._telemetryStartTime)}})),this._tsCall.on("participantAdded",(async g=>{this._isCaptionsBot(g)&&(this._acsMetadata||(this._acsMetadata=this._copyBotMetaData(g),this._mediaStreamSourceId=this._getBotDataMediaStreamSourceId(g),await this._tsCall.startDataChannel(),await this._tsCall.dataChannelAdapter.addHandler(this._transcriptionDataId,this._dataChannelHandler)))})),this._tsCall.on("participantRemoved",(async g=>{this._isCaptionsBot(g)&&this._handleBotRemoved(g)})),this._tsCall.on("participantUpdated",(async g=>{this._getBotMetadata(g)&&this._isCaptionsBot(g)&&this._acsMetadata&&(this._acsMetadata=this._copyBotMetaData(g),this._mediaStreamSourceId=this._getBotDataMediaStreamSourceId(g),!this._firstTimeActive&&this.isCaptionsFeatureActive&&(this._firstTimeActive=!0,this._eventEmitter.emit("CaptionsActiveChanged")))}));const m=this._tsCall.participants.find((g=>g.id===this._captionsBotMri));m&&(this._acsMetadata=this._copyBotMetaData(m),this._mediaStreamSourceId=m.getSourceIdForMediaType(3),await this._tsCall.startDataChannel(),await this._tsCall.dataChannelAdapter.addHandler(this._transcriptionDataId,this._dataChannelHandler))}catch(m){const S=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.INITIALIZE});throw this._sendCaptionsEvent(Dh.InitializeCaptions,Rh.failure,g,this._telemetryStartTime,wh.Unexpected,S.message,S.code,S.subCode,extractCommunicationServicesErrorForTelemetry(S)),this._logger.error(S.message),S}}updateCaptionsData(g){g===Iu.Captions?(this._name=Iu.Captions,this._captionsBotMri=getAcsEcsConfig().captions.acs.botMri,this._clientInfo=getAcsEcsConfig().captions.acs.clientInfo.ring,this._ecsSpokenLanguagesEnabled=getAcsEcsConfig().captions.teams.spokenLanguages.enabled,this._ecsSpokenLanguages=getAcsEcsConfig().captions.teams.spokenLanguages.languages,this._captions=new CaptionsImpl(this,this._eventEmitter)):g===Iu.TeamsCaptions&&(this._name=Iu.TeamsCaptions,this._captionsBotMri=getAcsEcsConfig().captions.teams.botMri,this._clientInfo=getAcsEcsConfig().captions.teams.clientInfo.ring,this._ecsSpokenLanguagesEnabled=getAcsEcsConfig().captions.teams.spokenLanguages.enabled,this._ecsSpokenLanguages=getAcsEcsConfig().captions.teams.spokenLanguages.languages,this._ecsCaptionLanguagesEnabled=getAcsEcsConfig().captions.teams.captionLanguages.enabled,this._ecsCaptionLanguages=getAcsEcsConfig().captions.teams.captionLanguages.languages,this._ecsAmtPolicyUrlSuffix=getAcsEcsConfig().MiddleTier.policyUrlSuffixV2,this._captions=new TeamsCaptionsImpl(this,this._eventEmitter))}async startCaptions(g){this._telemetryStartTime=+Date.now();const m=generateGuid(),S=g?.spokenLanguage||ho;if(this._sendFeatureUsage("startCaptions",Rh.attempt),this._sendCaptionsEvent(Dh.StartCaptions,Rh.attempt,m,0),this._addParticipantPromise){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.ALREADY_STARTING});return this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),void this._sendFeatureUsage("startCaptions",Rh.failure)}if(await this._initializationPromise,!this._ecsCaptionsEnabled){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.DISABLED});return this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Rh.failure),void this._logger.error("Feature is not enabled.")}if(!this._ecsSpokenLanguages.includes(S)){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.SPOKEN_LANG_UNSUPPORTED});throw this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Rh.failure),this._logger.error("Spoken language requested is not supported."),g}if(this._name===Iu.TeamsCaptions&&(this._mtPolicy=this._internalCallAgent.mtPolicyService,this._isCteUser)){try{this._mtPolicy.initialize({localParticipant:this._internalCallAgent.getUserMri(),skypeToken:await this._internalCallAgent.tokenProvider(),telemetryLogManager:this._telemetryLogManager}),await this._mtPolicy.fetchUserPoliciesFromAcsMiddleTier(this._tsCall.callId,this._tsCall.participantId,{policyUrlSuffix:this._ecsAmtPolicyUrlSuffix,userPolicies:["TeamsCallingPolicy","TeamsMeetingPolicy"],userProperties:["FeatureTypes","PoliciesMetadata"]}),this._mtCaptionsPolicyResult=JSON.parse(this._mtPolicy.getTeamsUserCaptionsPoliciesData())}catch(g){const S=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.CTE_POLICY_FETCH_FAIL,originalError:g});this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Unexpected,S.message,S.code,S.subCode,extractCommunicationServicesErrorForTelemetry(S)),this._logger.error("Unable to fetch policies")}if(this._mtCaptionsPolicyResult)if(this.isTeamsConversationType){if(!this._mtCaptionsPolicyResult?.isLiveCaptionsEnabledForMeeting){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.MEETING_POLICY_DISABLED});throw this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Rh.failure),this._logger.error(g.message),g}}else if(!this._mtCaptionsPolicyResult?.isLiveCaptionsEnabledForCalling){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.CALLING_POLICY_DISABLED});throw this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Rh.failure),this._logger.error(g.message),g}}if(this._acsMetadata){if(this._isCaptionsEnabled(this._acsMetadata))if(this._isCaptionsActive){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.ALREADY_ACTIVE});this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Rh.failure)}else this._isCaptionsActive=!0,"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata(!0),this._sendCaptionsEvent(Dh.StartCaptions,Rh.success,m,this._telemetryStartTime),this._sendFeatureUsage("startCaptions",Rh.success),this._eventEmitter.emit("CaptionsActiveChanged")}else try{const g={participantInvitationData:{botData:{clientInfo:this._clientInfo,consumerType:"ACS",initiatorUserToken:this._name===Iu.TeamsCaptions?"":await this._internalCallAgent.tokenProvider(),spokenLanguage:S,mode:po,transcriptionModes:[this._captionsModeKey]}}};this._addParticipantPromise=this._tsCall.addParticipant(this._captionsBotMri,g),await this._addParticipantPromise,this._addParticipantPromise=null,this._currentLanguage!==S&&(this._currentLanguage=S,this._eventEmitter.emit("SpokenLanguageChanged")),this._isCaptionsActive=!0,"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata(!0),this._sendCaptionsEvent(Dh.StartCaptions,Rh.success,m,this._telemetryStartTime),this._sendFeatureUsage("startCaptions",Rh.success)}catch(g){this._addParticipantPromise=null;const S=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.START_FAILED});throw this._sendCaptionsEvent(Dh.StartCaptions,Rh.failure,m,this._telemetryStartTime,wh.Unexpected,S.message,S.code,S.subCode,extractCommunicationServicesErrorForTelemetry(S)),this._sendFeatureUsage("startCaptions",Rh.failure),this._logger.error(S.message),S}}async stopCaptions(){this._telemetryStartTime=+Date.now();const g=generateGuid();if(this._sendFeatureUsage("stopCaptions",Rh.attempt),this._sendCaptionsEvent(Dh.StopCaptions,Rh.attempt,g,0),this.isCaptionsFeatureActive)this._isCaptionsActive=!1,this._sendCaptionsEvent(Dh.StopCaptions,Rh.success,g,this._telemetryStartTime),this._sendFeatureUsage("stopCaptions",Rh.success),this._eventEmitter.emit("CaptionsActiveChanged"),"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata();else{const m=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.STOP_NOT_ACTIVE});this._sendCaptionsEvent(Dh.StopCaptions,Rh.failure,g,this._telemetryStartTime,wh.Expected,m.message,m.code,m.subCode,extractCommunicationServicesErrorForTelemetry(m)),this._logger.warn(m.message)}this._isCaptionsActive=!1}async setSpokenLanguage(g){this._telemetryStartTime=+Date.now();const m=generateGuid();if(this._sendFeatureUsage("setSpokenLanguage",Rh.attempt),this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.attempt,m,0),await this._initializationPromise,!this._acsMetadata?.commandUrl){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_LANGUAGE_NOT_STARTED});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Rh.failure),this._logger.error(g.message),g}if(!this._isCaptionsActive){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_LANGUAGE_NOT_STARTED});return this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Rh.failure),void this._logger.warn(g.message)}if(!this._ecsSpokenLanguagesEnabled){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.SPOKEN_LANG_DISABLED});return this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Rh.failure),void this._logger.error(g.message)}if(g==this._currentLanguage){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.SPOKEN_LANGUAGE_ALREADY_SET});return this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),void this._sendFeatureUsage("setSpokenLanguage",Rh.failure)}if(!this._ecsSpokenLanguages.includes(g)){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.SPOKEN_LANG_UNSUPPORTED});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Rh.failure),this._logger.error(g.message),g}try{const S=await this._internalCallAgent.tokenProvider();if(!S){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_LANGUAGE_GET_TOKEN});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Unexpected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),g}await this._sendSetLanguageRequest(g,"",S,this._acsMetadata.commandUrl),this._currentLanguage!==g&&(this._currentLanguage=g,this._eventEmitter.emit("SpokenLanguageChanged")),this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.success,m,this._telemetryStartTime),this._sendFeatureUsage("setSpokenLanguage",Rh.success)}catch(g){const S=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_LANGUAGE_FAILED,originalError:g});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Unexpected,S.message,S.code,S.subCode,extractCommunicationServicesErrorForTelemetry(S)),this._sendFeatureUsage("setSpokenLanguage",Rh.failure),this._logger.error(S.message),S}}async setCaptionLanguage(g){this._telemetryStartTime=+Date.now();const m=generateGuid();if(this._sendFeatureUsage("setCaptionLanguage",Rh.attempt),this._sendCaptionsEvent(Dh.SetCaptionLanguage,Rh.attempt,m,0),await this._initializationPromise,!this._acsMetadata?.commandUrl){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_CAPTIONS_NOT_STARTED});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Rh.failure),this._logger.error(g.message),g}if(!this._isCaptionsActive){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_CAPTIONS_NOT_ACTIVE});return this._sendCaptionsEvent(Dh.SetCaptionLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Rh.failure),void this._logger.warn(g.message)}if(!this._ecsCaptionLanguagesEnabled){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.CAPTIONS_LANG_DISABLED});return this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Rh.failure),void this._logger.error(g.message)}if(this._isTranslatedCaptionsAllowed||this._tsCall.meetingDetails?.meetingCapability&&this._tsCall.meetingDetails.meetingCapability.allowTranslatedCaptions&&(this._isTranslatedCaptionsAllowed=this._tsCall.meetingDetails.meetingCapability.allowTranslatedCaptions),!(this.isTeamsConversationType&&this._isTranslatedCaptionsAllowed||this._mtCaptionsPolicyResult?.isTeamsProMgmtSkuAvailable)){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.CAPTIONS_LANG_TEAMS_LICENSE});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Rh.failure),this._logger.error(g.message),g}if(g==this._currentCaptionLanguage){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.CAPTIONS_LANG_ALREADY_SET});return this._sendCaptionsEvent(Dh.SetCaptionLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),void this._sendFeatureUsage("setCaptionLanguage",Rh.failure)}if(!this._ecsCaptionLanguages.includes(g)){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.CAPTIONS_LANG_UNSUPPORTED});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Rh.failure),this._logger.error(g.message),g}try{const S=await this._internalCallAgent.tokenProvider();if(!S){const g=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_CAPTIONS_GET_TOKEN});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Unexpected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),g}await this._sendSetLanguageRequest("",g,S,this._acsMetadata.commandUrl),this._currentCaptionLanguage!==g&&(this._currentCaptionLanguage=g,this._eventEmitter.emit("CaptionLanguageChanged")),this._sendCaptionsEvent(Dh.SetCaptionLanguage,Rh.success,m,this._telemetryStartTime),this._sendFeatureUsage("setCaptionLanguage",Rh.success)}catch(g){const S=new CallingCommunicationError({defaultError:D.FEATURES.CAPTIONS.UPDATE_CAPTIONS_FAILED,originalError:g});throw this._sendCaptionsEvent(Dh.SetSpokenLanguage,Rh.failure,m,this._telemetryStartTime,wh.Unexpected,S.message,S.code,S.subCode,extractCommunicationServicesErrorForTelemetry(S)),this._sendFeatureUsage("setCaptionLanguage",Rh.failure),this._logger.error(S.message),S}}dispose(){this._acsMetadata=void 0,this._textDecoder=void 0}_sendCaptionsEvent(g,m,S,v,C,_,E,T,I){let b={eventName:Ah.acs_calling_captions,callId:this._call.id,correlationId:S,isExpected:C??"",localParticipantId:this._call.tsCall.participantId,featureType:this._name,featureDetails:{step:g},kindOfEvent:m,timestampInfo:v?{deltaTimeInMs:+Date.now()-v}:"",additionalDetails:{failureReason:_,code:E,subCode:T,...I}};try{this._telemetryLogManager.sendEvent({name:Ah.acs_calling_captions,tenant:Qa,properties:b})}catch(g){this._logger.debug(`Unable to send ${this._name} feature usage telemtery`)}}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this._name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}async _sendSetLanguageRequest(g,m,S,v){const C=g?{type:go,spokenLanguage:g}:{type:go,subtitleLanguages:[m]},_={timestamp:(new Date).toISOString(),participantMri:this._internalCallAgent.getUserMri(),participantLegId:this._tsCall.participantId,action:go,mode:po,actionParameters:C},E={headers:{"X-Microsoft-Skype-Chain-ID":this._tsCall.callId,Authorization:`Bearer ${S}`,"x-skypetoken":S},withCredentials:!0};return this._httpRequestHelper.sendRequestWithRetry("post",v,_,E,wu)}}__decorate$1([asyncOperation(_u.StartCaptions),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"startCaptions",null),__decorate$1([asyncOperation(_u.StopCaptions),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"stopCaptions",null),__decorate$1([asyncOperation(_u.SetSpokenLanguage),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"setSpokenLanguage",null),__decorate$1([asyncOperation(_u.SetCaptionLanguage),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"setCaptionLanguage",null);class RaiseHandCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new RaiseHandCallImplOverTsCall(this.eventEmitter)}get name(){return"RaiseHand"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)}async raiseHand(){return this._impl.raiseHand()}async lowerHand(){return this._impl.lowerHand()}async lowerHands(g){return this._impl.lowerHands(g)}lowerAllHands(){return this._impl.lowerAllHands()}getRaisedHands(){return this._sendFeatureUsage("getRaisedHands",Rh.getter),this._impl.raisedHands}on(g,m){this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Rh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"RaiseHand",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class RaiseHandCallImplOverTsCall{constructor(g){this.typeRankComparator=(g,m)=>void 0===g.publishedState?-1:void 0===m.publishedState?1:g.publishedState.typeRank-m.publishedState.typeRank,this._eventEmitter=g,this._currentRaiseHandStates=new Map}initialize(g,m,S,v){this._logger=v.createChild((()=>`RaiseHandFeature::Call(id='${g.callId}')`)),this._tsCall=g,this._telemetryLogManager=S,this._internalCallAgent=m,this._sendFeatureUsage("initialize",Rh.initialize);try{let extractMRIs=g=>new Map(this.getPublishedState(g).sort(this.typeRankComparator).map((g=>[g.id,g])));this._tsCall.on("publishedStatesChanged",(async g=>{let m=extractMRIs(g),S=this._currentRaiseHandStates;this._currentRaiseHandStates=m,this._currentRaiseHandStates.forEach(((g,m)=>{S.has(m)||this._eventEmitter.emit("raisedHandEvent",{identifier:constructIdentifierKindFromMri(m)})})),S.forEach(((g,m)=>{this._currentRaiseHandStates.has(m)||this._eventEmitter.emit("loweredHandEvent",{identifier:constructIdentifierKindFromMri(m)})}))})),this._tsCall.publishedStates&&(this._currentRaiseHandStates=extractMRIs(this._tsCall.publishedStates)),this._sendFeatureUsage("initialize",Rh.success)}catch(g){throw this._logger.error("Could not initialize raise hand feature.",g),this._sendFeatureUsage("initialize",Rh.failure),new CallingCommunicationError({defaultError:D.FEATURES.RAISE_HAND.INITIALIZE,originalError:g})}}async raiseHand(){this._sendFeatureUsage("raiseHand",Rh.attempt);try{if(void 0!==this.getLocalRaiseHandState())return void this._sendFeatureUsage("raiseHand",Rh.failure);const g={level:"user",type:"raiseHands",content:"{}"};if(!await this._tsCall.publishState(g,M.generateCauseId()))throw new CallingCommunicationError({defaultError:D.FEATURES.RAISE_HAND.RAISE_HAND_PUBLISH_STATE});this._sendFeatureUsage("raiseHand",Rh.success)}catch(g){throw this._logger.error("Could not change a participant state. Code: ",g?.response?.status),this._sendFeatureUsage("raiseHand",Rh.failure),handleRaiseHandFailure(g,D.FEATURES.RAISE_HAND.RAISE_HAND_FAIL)}}async lowerHand(){this._sendFeatureUsage("lowerHand",Rh.attempt);try{const g=this.getLocalRaiseHandState();if(void 0===g)return void this._sendFeatureUsage("lowerHand",Rh.failure);const m={stateIds:[g]};await this._tsCall.removeState(m,M.generateCauseId()),this._sendFeatureUsage("lowerHand",Rh.success)}catch(g){throw this._logger.error("Could not change a participant state. Code: ",g?.response?.status),this._sendFeatureUsage("lowerHand",Rh.failure),handleRaiseHandFailure(g,D.FEATURES.RAISE_HAND.LOWER_HAND_FAIL)}}async lowerHands(g){this._sendFeatureUsage("lowerHands",Rh.attempt);try{if(0===g.length)return void this._sendFeatureUsage("lowerHands",Rh.failure);if(0===this._currentRaiseHandStates.size)return void this._sendFeatureUsage("lowerHands",Rh.failure);const m=g.map((g=>getMriFromIdentifier(g))),S=this.findStateIdsForParticipantIds(m);await this._tsCall.removeState({stateIds:S},M.generateCauseId()),this._sendFeatureUsage("lowerHands",Rh.success)}catch(g){throw this._logger.error("Could not change a participant state.",g),this._sendFeatureUsage("lowerHands",Rh.failure),handleRaiseHandFailure(g,D.FEATURES.RAISE_HAND.LOWER_REMOTEPARTICIPANTS_HANDS_FAIL)}}async lowerAllHands(){this._sendFeatureUsage("lowerAllHands",Rh.attempt);try{await this._tsCall.removeStatesForEveryone({type:"raiseHands"},M.generateCauseId()),this._sendFeatureUsage("lowerAllHands",Rh.success)}catch(g){throw this._logger.error("Could not change a participant state.",g),this._sendFeatureUsage("lowerAllHands",Rh.failure),handleRaiseHandFailure(g,D.FEATURES.RAISE_HAND.LOWER_ALL_HANDS_FAIL)}}get raisedHands(){return 0===this._currentRaiseHandStates.size?[]:Array.from(this._currentRaiseHandStates.keys()).map(((g,m)=>({identifier:constructIdentifierKindFromMri(g),order:m+1})))}getLocalRaiseHandState(){const g=this.findStateIdsForParticipantIds([this._internalCallAgent.getUserMri()]);if(g&&g.length>0)return g[0]}findStateIdsForParticipantIds(g){return g&&0!==this._currentRaiseHandStates.size?Array.from(this._currentRaiseHandStates.entries()).filter((m=>g.includes(m[0]))).map((g=>g[1]?.publishedState?.stateId)).filter((g=>!!g)):[]}getPublishedState(g){return g.typeStates.filter((g=>"raiseHands"===g.type)).map((g=>g.participantStates)).flat()}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"RaiseHand",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}var Du;!function(g){g.turnVideoOn="turnVideoOn",g.unmuteMic="unmuteMic",g.shareScreen="shareScreen",g.removeParticipant="removeParticipant",g.hangUpForEveryOne="hangUpForEveryOne",g.addCommunicationUser="addCommunicationUser",g.addTeamsUser="addTeamsUser",g.addPhoneNumber="addPhoneNumber",g.manageLobby="manageLobby",g.spotlightParticipant="spotlightParticipant",g.removeParticipantsSpotlight="removeParticipantsSpotlight",g.blurBackground="blurBackground",g.startLiveCaptions="startLiveCaptions",g.stopLiveCaptions="stopLiveCaptions",g.raiseHand="raiseHand",g.pstnDialOut="pstnDialOut",g.muteOthers="muteOthers",g.useReactions="useReactions",g.viewAttendeeNames="viewAttendeeNames"}(Du||(Du={}));class RoomsCapabilityResolver{constructor(g){this._logger=g,this._ecsConfig=getAcsEcsConfig()}getResolvedCapabilitiesBasedOnRole(g,m){let S={...m},v=g.toLocaleLowerCase();return v!==zo.Attendee.toLocaleLowerCase()&&v!==zo.Presenter.toLocaleLowerCase()&&v!==zo.Consumer.toLocaleLowerCase()&&v!==zo.Organizer.toLocaleLowerCase()||(this._ecsConfig[Qo][v][Du.turnVideoOn]?S.turnVideoOn={isPresent:this._ecsConfig[Qo][v][Du.turnVideoOn],reason:Yo.Capable}:S.turnVideoOn={isPresent:this._ecsConfig[Qo][v][Du.turnVideoOn],reason:Yo.RoleRestricted},this._ecsConfig[Qo][v][Du.unmuteMic]?S.unmuteMic={isPresent:this._ecsConfig[Qo][v][Du.unmuteMic],reason:Yo.Capable}:S.unmuteMic={isPresent:this._ecsConfig[Qo][v][Du.unmuteMic],reason:Yo.RoleRestricted},this._ecsConfig[Qo][v][Du.shareScreen]?S.shareScreen={isPresent:this._ecsConfig[Qo][v][Du.shareScreen],reason:Yo.Capable}:S.shareScreen={isPresent:this._ecsConfig[Qo][v][Du.shareScreen],reason:Yo.RoleRestricted},this._ecsConfig[Qo][v][Du.removeParticipant]?S.removeParticipant={isPresent:this._ecsConfig[Qo][v][Du.removeParticipant],reason:Yo.Capable}:S.removeParticipant={isPresent:this._ecsConfig[Qo][v][Du.removeParticipant],reason:Yo.RoleRestricted},this._ecsConfig[Qo][v][Du.muteOthers]?S.muteOthers={isPresent:this._ecsConfig[Qo][v][Du.muteOthers],reason:Yo.Capable}:S.muteOthers={isPresent:this._ecsConfig[Qo][v][Du.muteOthers],reason:Yo.RoleRestricted},this._ecsConfig[Qo][v][Du.pstnDialOut]?S.pstnDialOut={isPresent:this._ecsConfig[Qo][v][Du.pstnDialOut],reason:Yo.Capable}:S.pstnDialOut={isPresent:this._ecsConfig[Qo][v][Du.pstnDialOut],reason:Yo.RoleRestricted},this._ecsConfig[Qo][v][Du.addPhoneNumber]?S.addPhoneNumber={isPresent:this._ecsConfig[Qo][v][Du.addPhoneNumber],reason:Yo.Capable}:S.addPhoneNumber={isPresent:this._ecsConfig[Qo][v][Du.addPhoneNumber],reason:Yo.RoleRestricted}),S.removeParticipant={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.hangUpForEveryOne={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.addCommunicationUser={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.addTeamsUser={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.manageLobby={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.spotlightParticipant={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.removeParticipantsSpotlight={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.blurBackground={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.startLiveCaptions={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.stopLiveCaptions={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.raiseHand={isPresent:!1,reason:Yo.CapabilityNotApplicableForTheCallType},S.useReactions={isPresent:!0,reason:Yo.Capable},S.viewAttendeeNames={isPresent:!0,reason:Yo.Capable},this._logger.log(`Capabilities resolved to : ${JSON.stringify(S)} on role change to ${g}`),S}}class TeamsCapabilityResolver{constructor(g){this._logger=g,this._ecsConfig=getAcsEcsConfig()}getResolvedCapabilitiesBasedOnRole(g,m){let S={...m},v=g.toLocaleLowerCase();return v!==zo.Attendee.toLocaleLowerCase()&&v!==zo.Presenter.toLocaleLowerCase()&&v!==zo.Consumer.toLocaleLowerCase()&&v!==zo.Organizer.toLocaleLowerCase()&&v!==zo.Coorganizer.toLocaleLowerCase()||(v=v.replace("-",""),m.turnVideoOn.reason!=Yo.MeetingRestricted&&(this._ecsConfig[Xo][v][Du.turnVideoOn]?S.turnVideoOn={isPresent:!0,reason:Yo.Capable}:S.turnVideoOn={isPresent:!1,reason:Yo.RoleRestricted}),m.unmuteMic.reason!=Yo.MeetingRestricted&&(this._ecsConfig[Xo][v][Du.unmuteMic]?S.unmuteMic={isPresent:!0,reason:Yo.Capable}:S.unmuteMic={isPresent:!1,reason:Yo.RoleRestricted}),m.shareScreen.reason!=Yo.UserPolicyRestricted&&(this._ecsConfig[Xo][v][Du.shareScreen]?S.shareScreen={isPresent:!0,reason:Yo.Capable}:S.shareScreen={isPresent:!1,reason:Yo.RoleRestricted}),this._ecsConfig[Xo][v][Du.removeParticipant]?S.removeParticipant={isPresent:!0,reason:Yo.Capable}:S.removeParticipant={isPresent:!1,reason:Yo.RoleRestricted},this._ecsConfig[Xo][v][Du.hangUpForEveryOne]?S.hangUpForEveryOne={isPresent:!0,reason:Yo.Capable}:S.hangUpForEveryOne={isPresent:!1,reason:Yo.RoleRestricted},this._ecsConfig[Xo][v][Du.addCommunicationUser]?S.addCommunicationUser={isPresent:!0,reason:Yo.Capable}:S.addCommunicationUser={isPresent:!1,reason:Yo.RoleRestricted},this._ecsConfig[Xo][v][Du.addTeamsUser]?S.addTeamsUser={isPresent:!0,reason:Yo.Capable}:S.addTeamsUser={isPresent:!1,reason:Yo.RoleRestricted},this._ecsConfig[Xo][v][Du.addPhoneNumber]?S.addPhoneNumber={isPresent:!0,reason:Yo.Capable}:S.addPhoneNumber={isPresent:!1,reason:Yo.RoleRestricted},this._ecsConfig[Xo][v][Du.manageLobby]?S.manageLobby={isPresent:!0,reason:Yo.Capable}:S.manageLobby={isPresent:!1,reason:Yo.RoleRestricted},this._ecsConfig[Xo][v][Du.spotlightParticipant]?S.spotlightParticipant={isPresent:!0,reason:Yo.Capable}:S.spotlightParticipant={isPresent:!1,reason:Yo.RoleRestricted},this._ecsConfig[Xo][v][Du.removeParticipantsSpotlight]?S.removeParticipantsSpotlight={isPresent:!0,reason:Yo.Capable}:S.removeParticipantsSpotlight={isPresent:!1,reason:Yo.RoleRestricted},m.blurBackground.reason!=Yo.UserPolicyRestricted&&(this._ecsConfig[Xo][v][Du.blurBackground]?S.blurBackground={isPresent:!0,reason:Yo.Capable}:S.blurBackground={isPresent:!1,reason:Yo.RoleRestricted}),m.startLiveCaptions.reason!=Yo.UserPolicyRestricted&&(this._ecsConfig[Xo][v][Du.startLiveCaptions]?S.startLiveCaptions={isPresent:!0,reason:Yo.Capable}:S.startLiveCaptions={isPresent:!1,reason:Yo.RoleRestricted}),m.stopLiveCaptions.reason!=Yo.UserPolicyRestricted&&(this._ecsConfig[Xo][v][Du.stopLiveCaptions]?S.stopLiveCaptions={isPresent:!0,reason:Yo.Capable}:S.stopLiveCaptions={isPresent:!1,reason:Yo.RoleRestricted}),m.raiseHand.reason!=Yo.MeetingRestricted&&(this._ecsConfig[Xo][v][Du.raiseHand]?S.raiseHand={isPresent:!0,reason:Yo.Capable}:S.raiseHand={isPresent:!1,reason:Yo.RoleRestricted}),m.pstnDialOut.reason!=Yo.MeetingRestricted&&(this._ecsConfig[Xo][v][Du.pstnDialOut]?S.pstnDialOut={isPresent:!0,reason:Yo.Capable}:S.pstnDialOut={isPresent:!1,reason:Yo.RoleRestricted}),m.muteOthers.reason!=Yo.MeetingRestricted&&(this._ecsConfig[Xo][v][Du.muteOthers]?S.muteOthers={isPresent:!0,reason:Yo.Capable}:S.muteOthers={isPresent:!1,reason:Yo.RoleRestricted}),m.useReactions.reason!=Yo.MeetingRestricted&&(this._ecsConfig[Xo][v][Du.useReactions]?S.useReactions={isPresent:!0,reason:Yo.Capable}:S.useReactions={isPresent:!1,reason:Yo.RoleRestricted}),m.viewAttendeeNames.reason!=Yo.MeetingRestricted&&(this._ecsConfig[Xo][v][Du.viewAttendeeNames]?S.viewAttendeeNames={isPresent:!0,reason:Yo.Capable}:S.viewAttendeeNames={isPresent:!1,reason:Yo.RoleRestricted})),this._logger.log(`Capabilities resolved to : ${JSON.stringify(S)} on role change to ${g}`),S}getResolvedCapabilitiesBasedOnMeetingCapabilities(g,m){let S={...m};return null!=g.attendeeRestrictions&&("DisableVideo"!=g.attendeeRestrictions&&"DisableAv"!=g.attendeeRestrictions?S.turnVideoOn={isPresent:!0,reason:Yo.Capable}:S.turnVideoOn={isPresent:!1,reason:Yo.MeetingRestricted}),null!=g.attendeeRestrictions&&("DisableAv"!=g.attendeeRestrictions?S.unmuteMic={isPresent:!0,reason:Yo.Capable}:S.unmuteMic={isPresent:!1,reason:Yo.MeetingRestricted}),null!=g.allowRaiseHands&&(g.allowRaiseHands?S.raiseHand={isPresent:!0,reason:Yo.Capable}:S.raiseHand={isPresent:!1,reason:Yo.MeetingRestricted}),null!=g.allowPstnConferencing&&(g.allowPstnConferencing?S.pstnDialOut={isPresent:!0,reason:Yo.Capable}:S.pstnDialOut={isPresent:!1,reason:Yo.MeetingRestricted}),null!=g.allowTeamsMeetingReactions&&(g.allowTeamsMeetingReactions?S.useReactions={isPresent:!0,reason:Yo.Capable}:S.useReactions={isPresent:!1,reason:Yo.MeetingRestricted}),null!=g.maskIdentitiesForRole&&(g.maskIdentitiesForRole?S.viewAttendeeNames={isPresent:!1,reason:Yo.MeetingRestricted}:S.viewAttendeeNames={isPresent:!0,reason:Yo.Capable}),this._logger.log(`Capabilities resolved to : ${JSON.stringify(S)} on meeting details change to ${g}`),S}getResolvedCapabilitiesBasedOnUserPolicy(g,m){let S={...m};return null!=g.teamsMeetingPolicy?.screenSharingMode&&("Disabled"==g.teamsMeetingPolicy?.screenSharingMode?S.shareScreen={isPresent:!1,reason:Yo.UserPolicyRestricted}:S.shareScreen={isPresent:!0,reason:Yo.Capable}),null!=g.teamsMeetingPolicy?.liveCaptionsEnabledType&&("Disabled"==g.teamsMeetingPolicy?.liveCaptionsEnabledType?S.startLiveCaptions={isPresent:!1,reason:Yo.UserPolicyRestricted}:S.startLiveCaptions={isPresent:!0,reason:Yo.Capable}),null!=g.teamsMeetingPolicy?.liveCaptionsEnabledType&&("Disabled"==g.teamsMeetingPolicy?.liveCaptionsEnabledType?S.stopLiveCaptions={isPresent:!1,reason:Yo.UserPolicyRestricted}:S.stopLiveCaptions={isPresent:!0,reason:Yo.Capable}),null!=g.teamsMeetingPolicy?.videoFiltersMode&&("NoFilters"==g.teamsMeetingPolicy?.videoFiltersMode?S.blurBackground={isPresent:!1,reason:Yo.UserPolicyRestricted}:S.blurBackground={isPresent:!0,reason:Yo.Capable}),this._logger.log(`Capabilities resolved to : ${JSON.stringify(S)} on user policy update to ${g}`),S}}class CapabilityResolverImpl{constructor(g,m,S,v,C,_){this._eventEmitter=g,this._logger=m,this._callInfo=v,this._tsCall=_,this._call=S,this._callAgent=C,this._capabilities=this.initializeCapabilities(),("roomJoin"==this._callInfo.context||"teamsMeetingJoin"==this._callInfo.context)&&this.doInitialCapabilityResolutionBasedOnRole(),"teamsMeetingJoin"==this._callInfo.context&&this.doInitialCapabilityResolutionBasedOnUserPolicy(),"teamsMeetingJoin"==this._callInfo.context&&this.doInitialCapabilityResolutionBasedOnMeetingCapabilities()}initializeCapabilities(){return this._logger.info("initializing capabilities"),"roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context?{turnVideoOn:{isPresent:!1,reason:Yo.FeatureNotSupported},unmuteMic:{isPresent:!1,reason:Yo.FeatureNotSupported},shareScreen:{isPresent:!1,reason:Yo.FeatureNotSupported},removeParticipant:{isPresent:!1,reason:Yo.FeatureNotSupported},hangUpForEveryOne:{isPresent:!1,reason:Yo.FeatureNotSupported},addCommunicationUser:{isPresent:!1,reason:Yo.FeatureNotSupported},addTeamsUser:{isPresent:!1,reason:Yo.FeatureNotSupported},addPhoneNumber:{isPresent:!1,reason:Yo.FeatureNotSupported},manageLobby:{isPresent:!1,reason:Yo.FeatureNotSupported},spotlightParticipant:{isPresent:!1,reason:Yo.FeatureNotSupported},removeParticipantsSpotlight:{isPresent:!1,reason:Yo.FeatureNotSupported},blurBackground:{isPresent:!1,reason:Yo.FeatureNotSupported},startLiveCaptions:{isPresent:!1,reason:Yo.FeatureNotSupported},stopLiveCaptions:{isPresent:!1,reason:Yo.FeatureNotSupported},raiseHand:{isPresent:!1,reason:Yo.FeatureNotSupported},pstnDialOut:{isPresent:!1,reason:Yo.FeatureNotSupported},muteOthers:{isPresent:!1,reason:Yo.FeatureNotSupported},useReactions:{isPresent:!1,reason:Yo.FeatureNotSupported},viewAttendeeNames:{isPresent:!1,reason:Yo.FeatureNotSupported}}:{turnVideoOn:{isPresent:!1,reason:Yo.NotInitialized},unmuteMic:{isPresent:!1,reason:Yo.NotInitialized},shareScreen:{isPresent:!1,reason:Yo.NotInitialized},removeParticipant:{isPresent:!1,reason:Yo.NotInitialized},hangUpForEveryOne:{isPresent:!1,reason:Yo.NotInitialized},addCommunicationUser:{isPresent:!1,reason:Yo.NotInitialized},addTeamsUser:{isPresent:!1,reason:Yo.NotInitialized},addPhoneNumber:{isPresent:!1,reason:Yo.NotInitialized},manageLobby:{isPresent:!1,reason:Yo.NotInitialized},spotlightParticipant:{isPresent:!1,reason:Yo.NotInitialized},removeParticipantsSpotlight:{isPresent:!1,reason:Yo.NotInitialized},blurBackground:{isPresent:!1,reason:Yo.NotInitialized},startLiveCaptions:{isPresent:!1,reason:Yo.NotInitialized},stopLiveCaptions:{isPresent:!1,reason:Yo.NotInitialized},raiseHand:{isPresent:!1,reason:Yo.NotInitialized},pstnDialOut:{isPresent:!1,reason:Yo.NotInitialized},muteOthers:{isPresent:!1,reason:Yo.NotInitialized},useReactions:{isPresent:!1,reason:Yo.NotInitialized},viewAttendeeNames:{isPresent:!1,reason:Yo.NotInitialized}}}doInitialCapabilityResolutionBasedOnRole(){this.resolveCapabilitiesBasedOnRole()}doInitialCapabilityResolutionBasedOnUserPolicy(){this.getCapabilityResolver()instanceof TeamsCapabilityResolver&&"roomJoin"!=this._callInfo.context&&this.resolveCapabilitiesBasedOnUserPolicy()}doInitialCapabilityResolutionBasedOnMeetingCapabilities(){this.resolveCapabilitiesBasedOnMeetingCapabilities()}getCapabilityResolver(){return this._callInfo.context?.match("roomJoin")?new RoomsCapabilityResolver(this._logger):(this._callInfo.context?.match("teamsMeetingJoin"),new TeamsCapabilityResolver(this._logger))}getCapabilities(){return this._capabilities}resolveCapabilitiesBasedOnRole(){if("roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context)return;let g=this._call.role;g==zo.Unknown&&(g="roomJoin"==this._callInfo.context?zo.Consumer:zo.Attendee);let m=this.getCapabilityResolver();if(m){let S=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=m.getResolvedCapabilitiesBasedOnRole(g,this._capabilities),!P.isEqual(S,this._capabilities)){const m=this.getChangedCapabilitiesInfo(S,this._capabilities,"RoleChanged");this._logger.info(`Capabilities has changed based on role update to ${g}, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(m)}`),this._eventEmitter.emit("capabilitiesChanged",m)}}}resolveCapabilitiesBasedOnMeetingCapabilities(){if("teamsMeetingJoin"!=this._callInfo.context)return;let g={};g={...this._tsCall.meetingDetails?.capabilities,...this._tsCall.meetingDetails?.meetingCapability};let m=this.getCapabilityResolver();if(m&&m){const S=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=m.getResolvedCapabilitiesBasedOnMeetingCapabilities(g,this._capabilities),!P.isEqual(S,this._capabilities)){const g=this.getChangedCapabilitiesInfo(S,this._capabilities,"MeetingOptionOrOrganizerPolicyChanged");this._logger.info(`Capabilities has changed due to meeting capabilities, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(g)}`),this._eventEmitter.emit("capabilitiesChanged",g)}}}resolveCapabilitiesBasedOnUserPolicy(){if("teamsMeetingJoin"!=this._callInfo.context)return;let g=this._callAgent.getUserPolicy(),m=this.getCapabilityResolver();if(m&&m&&g){let S=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=m.getResolvedCapabilitiesBasedOnUserPolicy(g,this._capabilities),!P.isEqual(S,this._capabilities)){const g=this.getChangedCapabilitiesInfo(S,this._capabilities,"UserPolicyChanged");this._logger.info(`Capabilities has changed due to user policy, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(g)}`),this._eventEmitter.emit("capabilitiesChanged",g)}}}getChangedCapabilitiesInfo(g,m,S){let v={},C={};return Object.keys(g).forEach((S=>{g[S].isPresent!=m[S].isPresent&&(v[S]=g[S],C[S]=m[S])})),{oldValue:v,newValue:C,reason:S}}}class CapabilitiesFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._callInfo=g.callInfo,this._impl=new CapabilitiesImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Rh.getter),"Capabilities"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.call,this._callInfo,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Rh.initialize)}get capabilities(){return this._sendFeatureUsage("getCapabilities",Rh.getter),this._impl.capabilities}on(g,m){this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Rh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Capabilities",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class CapabilitiesImplOverTsCall{constructor(g){this._eventEmitter=g}get capabilities(){return this._capabilityResolver.getCapabilities()}initialize(g,m,S,v,C,_){this._logger=_.createChild((()=>`CapabilitiesFeature::Call(id='${g.callId}')`)),this._tsCall=g,this._call=S,this._callInfo=v,this._internalCallAgent=m,this._timeToInitialize=new Date,this._capabilityResolver=new CapabilityResolverImpl(this._eventEmitter,this._logger,this._call,this._callInfo,this._internalCallAgent,this._tsCall),this._call.on("roleChanged",(()=>{this._capabilityResolver.resolveCapabilitiesBasedOnRole();let g=((new Date).getTime()-this._timeToInitialize.getTime())/1e3;this._logger.info("Time difference to initialize after role set is "+g)})),this._call.onMeetingCapabilitiesChanged("meetingCapabilitiesChanged",(()=>{this._capabilityResolver.resolveCapabilitiesBasedOnMeetingCapabilities();let g=((new Date).getTime()-this._timeToInitialize.getTime())/1e3;this._logger.info("Time difference to initialize after meeting set up is"+g)}))}}var Ou,Nu,bitwise=function(g){var m=0;if(0==g.length)return m;for(var S=0;S<g.length;S++){m=(m<<5)-m+g.charCodeAt(S),m&=m}return m},binaryTransfer=function(g,m){var S="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";m=m||62;var v,C=[],_="",E=g<0?"-":"";for(g=Math.abs(g);g>=m;)v=g%m,g=Math.floor(g/m),C.push(S[v]);g>0&&C.push(S[g]);for(var T=C.length-1;T>=0;T--)_+=C[T];return E+_},dist=function(g){var m=typeof g;if("string"===m||"number"===m)return binaryTransfer(bitwise(String(g)),61).replace("-","Z");throw new Error("Unexpected input type")};!function(g){g.ping="ping",g.pong="pong"}(Ou||(Ou={}));class DebugInfoCallClientFeatureImpl extends FirstPartyCallClientFeature{constructor(g){super(g),this._impl=new DebugInfoImplOverTsCall;try{getSdkVersion().includes("stable")||(this._browserTabInfoImpl=new BrowserTabInfoImpl(this.eventEmitter))}catch(m){g.callClient.logger.error("Feature to detect multiple tabs is not supported on the current environment.")}}get name(){return this._sendFeatureUsage("name",Rh.getter),"DebugInfo"}get lastLocalParticipantId(){return this._sendFeatureUsage("lastLocalParticipantId",Rh.getter),this._impl.lastLocalParticipantId}get logs(){return this._impl.logDump}get localParticipantIdMap(){return this._impl.localParticipantIdMap}get incommingCallIdMap(){return this._impl.incommingCallIdMap}get lastCallId(){if(this._sendFeatureUsage("lastCallId",Rh.getter),this.lastLocalParticipantId)return this._impl.localParticipantIdMap[this.lastLocalParticipantId].callIds.slice(-1)[0]}get diagnosticInformation(){return this._impl.diagnosticInformation}get sdkVersion(){return getSdkVersion()}get acsResourceId(){return this._impl.AcsResourceId}get clientId(){return this._impl.clientId}dumpDebugInfoAsJSONString(){try{return JSON.stringify(this.toZip())}catch(g){return`JSON.stringify threw: ${g}`}}toZip(){return{clientId:this.clientId,lastLocalParticipantId:this.lastLocalParticipantId,localParticipantIdMap:this.localParticipantIdMap,incommingCallMap:this.incommingCallIdMap,AcsResourceId:this.acsResourceId,diagnosticInformation:this.diagnosticInformation,sdkVersion:this.sdkVersion,logs:this.logs}}dumpDebugInfo(){this._sendFeatureUsage("dumpDebugInfo",Rh.attempt);try{const g=Eh.deflate(this.dumpDebugInfoAsJSONString(),{to:"string"}),m=dist(g);return this._sendFeatureUsage("dumpDebugInfo",Rh.success),{dump:g,dumpId:`${generateGuid()}-${m}`}}catch(g){const m=`failed to deflate, error: ${g}`;return this.logger.error(m),this._sendFeatureUsage("dumpDebugInfo",Rh.failure),{dump:Eh.deflate(m,{to:"string"}),dumpId:generateGuid()}}}initialize(g,m){this._impl.initialize(g,m),this.logger=m,this._telemetryLogManager=g.telemetryLogManager,this._callClient=g.callClient,this._browserTabInfoImpl&&this._browserTabInfoImpl.initialize(g.callClient,m,g.telemetryLogManager),this._sendFeatureUsage("initialize",Rh.initialize)}async getEnvironmentInfo(){return this._sendFeatureUsage("getEnvironmentInfo",Rh.getter),await this._callClient.getEnvironmentInfoInternal()}get isAnotherCallClientActiveInSameTab(){return this._sendFeatureUsage("isAnotherCallClientActiveInSameTab",Rh.getter),!!this._browserTabInfoImpl&&this._browserTabInfoImpl.isAnotherCallClientActiveInSameTab}get isCallClientActiveInAnotherTab(){return this._sendFeatureUsage("isCallClientActiveInAnotherTab",Rh.getter),!!this._browserTabInfoImpl&&this._browserTabInfoImpl.isCallClientActiveInAnotherTab}on(g,m){"isCallClientActiveInAnotherTabChanged"!==g&&"isAnotherCallClientActiveInSameTabChanged"!==g&&this.logger.error(`Not able to subscribe to event ${g}, unknown event name`),this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){"isCallClientActiveInAnotherTabChanged"!==g&&"isAnotherCallClientActiveInSameTabChanged"!==g&&this.logger.error(`Not able to unsubscribe to event ${g}, unknown event name`),this._sendFeatureUsage(g,Rh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallClientFeatureUsageTelemetry({featureName:"DebugInfo",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this.logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class DebugInfoImplOverTsCall{get diagnosticInformation(){return this._sdkDiagnosticInformation}get logDump(){return this._logger.log("Log dump requested"),this._logger.dumpAllLogs()}get AcsResourceId(){return this._callAgent?.getAcsResourceId()}get lastLocalParticipantId(){return this._lastLocalParticipantId}get localParticipantIdMap(){return this._localParticipantIdMap}get incommingCallIdMap(){return this._incommingCallIdMap}get clientId(){return this._callAgent?.getClientId()}constructor(){this._localParticipantIdMap={},this._incommingCallIdMap={}}initialize(g,m){this._logger=m,this._callAgent=g?.callClient?.callAgent,this._sdkDiagnosticInformation=g?.callClient.sdkDiagnosticInformation,this._logger.info("waiting for call agent to be created");const bindAndSubscribeToCallAgentEvents=()=>{this._callAgent=g?.callClient.callAgent,this.subscribeToCallAgentEvents()};g?.callClient.on("callAgentCreated",bindAndSubscribeToCallAgentEvents)}dispose(){}subscribeToCallAgentEvents(){try{this._callAgent?.on("callsUpdated",(g=>{[...g.added,...g.removed].forEach((g=>{this.updateLocalParticipantIdMap(g),g.on("idChanged",(()=>{this.updateLocalParticipantIdMap(g)}))}))})),this._callAgent?.on("incomingCall",(g=>{let m=g.incomingCall;m.on("callEnded",(g=>{try{this._incommingCallIdMap[m.id]=JSON.stringify(g.callEndReason)}catch(g){this._incommingCallIdMap[m.id]="callEnd reason unknown"}}));try{this._incommingCallIdMap[m.id]=JSON.stringify(g.incomingCall.callerInfo.identifier?.kind)}catch(g){this._incommingCallIdMap[m.id]="identifier kind unknown"}}))}catch(g){this._logger.info("failed to subscribe to call agent events, due to non initialized call agent")}}updateLocalParticipantIdMap(g){try{let m=this._localParticipantIdMap[g.tsCall.participantId]?.callIds.filter((m=>m!==g.tsCall.callId)).concat([g.tsCall.callId])??[g.tsCall.callId],S=[],v=[],C=g.callEndReason?JSON.stringify(g.callEndReason):g.state,_=g.state;this._localParticipantIdMap[g.tsCall.participantId]?.callEndReasons?(this._localParticipantIdMap[g.tsCall.participantId].callEndReasons.slice(-1)[0]!==C?(this._localParticipantIdMap[g.tsCall.participantId].callEndReasons.push(C),S=this._localParticipantIdMap[g.tsCall.participantId].callEndReasons):S=this._localParticipantIdMap[g.tsCall.participantId].callEndReasons,this._localParticipantIdMap[g.tsCall.participantId].stateTransitions.slice(-1)[0]!==_?(this._localParticipantIdMap[g.tsCall.participantId].stateTransitions.push(_),v=this._localParticipantIdMap[g.tsCall.participantId].stateTransitions):v=this._localParticipantIdMap[g.tsCall.participantId].stateTransitions):(S=[C],v=[g.state]),this._localParticipantIdMap[g.tsCall.participantId]={callIds:m,callEndReasons:S,stateTransitions:v},this._logger.info(`localParticipantIdMap: ${JSON.stringify(this._localParticipantIdMap)}`),g.on("stateChanged",(()=>{"Connected"===g.state&&(this._lastLocalParticipantId=g.tsCall.participantId,this._logger.info(`last patricipant id: ${this._lastLocalParticipantId}`)),this._localParticipantIdMap[g.tsCall.participantId].stateTransitions.slice(-1)[0]!==g.state&&this.localParticipantIdMap[g.tsCall.participantId].stateTransitions.push(g.state)}))}catch(g){this._logger.error(`exception occured while updating localParticipantId map: ${g}`)}}}class BrowserTabInfoImpl{get isCallClientActiveInAnotherTab(){return this._isCallClientActiveInAnotherTab}get isAnotherCallClientActiveInSameTab(){return this._isAnotherCallClientActiveInSameTab}constructor(g){this._eventEmitter=g,this._tabGroupId=BrowserTabInfoImpl.tabId,this._isCallClientActiveInAnotherTab=!1,this._isAnotherCallClientActiveInSameTab=!1,this._areThereMultipleTabs=null,this._manyCallClientInSameTab=null,this._isTabFirstLoadFlag=!0,this._intervalId=void 0,this._timeoutId=void 0,this._channel=new BroadcastChannel(getAcsEcsConfig().debugInfo.broadcastChannelName)}initialize(g,m,S){this._callClient=g,this._logger=m,this._telemetryLogManager=S;const v=getAcsEcsConfig().debugInfo.tabsBroadcastDelay,C=getAcsEcsConfig().debugInfo.tabsUpdateDelay;this.tabsCheck(),this._channel.postMessage({action:Ou.ping,tabId:BrowserTabInfoImpl.tabId,groupId:this._tabGroupId}),this._timeoutId=setTimeout((()=>{this._areThereMultipleTabs&&(this._isCallClientActiveInAnotherTab=this._areThereMultipleTabs),this._manyCallClientInSameTab&&(this._isAnotherCallClientActiveInSameTab=this._manyCallClientInSameTab),this.sendTabUpdateEvent(),this._isTabFirstLoadFlag=!1}),10),this._intervalId=setInterval((()=>{this._areThereMultipleTabs=null,this._manyCallClientInSameTab=null,this._channel.postMessage({action:Ou.ping,tabId:BrowserTabInfoImpl.tabId,groupId:this._tabGroupId}),setTimeout((()=>{null===this._areThereMultipleTabs&&(this._areThereMultipleTabs=!1),null===this._manyCallClientInSameTab&&(this._manyCallClientInSameTab=!1),this.tabsUpdate()}),C)}),v)}tabsCheck(){this._channel.addEventListener("message",(g=>{g.data?.action!==Ou.ping&&g.data?.action!==Ou.pong||(g.data?.action===Ou.ping&&(BrowserTabInfoImpl.tabId===g.data.tabId?this._manyCallClientInSameTab=!0:BrowserTabInfoImpl.tabId!==g.data.tabId&&(this._areThereMultipleTabs=!0),this._channel.postMessage({action:Ou.pong,tabId:BrowserTabInfoImpl.tabId,groupId:this._tabGroupId})),g.data?.action===Ou.pong&&(BrowserTabInfoImpl.tabId===g.data.tabId?this._manyCallClientInSameTab=!0:BrowserTabInfoImpl.tabId!==g.data.tabId&&(this._areThereMultipleTabs=!0),this._tabGroupId!==g.data.groupId&&(this._tabGroupId=g.data.groupId)),this.tabsUpdate())}))}sendTabUpdateToCallEvent(){this._callClient.callAgent?._calls?.forEach((g=>g?.stats?.recordEvent({name:bh.sdk_active_in_another_tab,callId:g.id,localParticipantId:g.tsCall.participantId,data:{tabId:BrowserTabInfoImpl.tabId,tabGroupId:this._tabGroupId,isCallClientActiveInAnotherTab:this._isCallClientActiveInAnotherTab,isAnotherCallClientActiveInSameTab:this._isAnotherCallClientActiveInSameTab}})))}sendTabUpdateEvent(){const g={tabId:BrowserTabInfoImpl.tabId,tabGroupId:this._tabGroupId,isCallClientActiveInAnotherTab:this._isCallClientActiveInAnotherTab,isAnotherCallClientActiveInSameTab:this._isAnotherCallClientActiveInSameTab};this._telemetryLogManager.sendEvent({name:Ah.acs_calling_tab_events,tenant:Qa,properties:g})}tabsUpdate(){this._isTabFirstLoadFlag||null===this._manyCallClientInSameTab||null===this._areThereMultipleTabs||this._isCallClientActiveInAnotherTab===this._areThereMultipleTabs&&this._isAnotherCallClientActiveInSameTab===this._manyCallClientInSameTab||(this._isAnotherCallClientActiveInSameTab!==this._manyCallClientInSameTab&&(this._logger.log(`isAnotherCallClientActiveInSameTab changed from ${this._isAnotherCallClientActiveInSameTab} to ${this._manyCallClientInSameTab}`),this._isAnotherCallClientActiveInSameTab=this._manyCallClientInSameTab,this._eventEmitter.emit("isAnotherCallClientActiveInSameTabChanged")),this._isCallClientActiveInAnotherTab!==this._areThereMultipleTabs&&(this._logger.log(`isCallClientActiveInAnotherTab changed from ${this._isCallClientActiveInAnotherTab} to ${this._areThereMultipleTabs}`),this._isCallClientActiveInAnotherTab=this._areThereMultipleTabs,this._eventEmitter.emit("isCallClientActiveInAnotherTabChanged")),this.sendTabUpdateEvent(),this.sendTabUpdateToCallEvent())}dispose(){this._channel.close(),void 0!==this._timeoutId&&clearTimeout(this._timeoutId),void 0!==this._intervalId&&clearInterval(this._intervalId)}}BrowserTabInfoImpl.tabId=generateGuid(),(Nu=g.DiagnosticQuality||(g.DiagnosticQuality={}))[Nu.Good=1]="Good",Nu[Nu.Poor=2]="Poor",Nu[Nu.Bad=3]="Bad";const ku="networkReconnect",Lu="networkReceiveQuality",Fu="networkSendQuality",xu="networkRelaysNotReachable",Uu="noNetwork",Vu="noSpeakerDevicesEnumerated",Bu="noMicrophoneDevicesEnumerated",Hu="microphoneNotFunctioning",$u="microphoneMuteUnexpectedly",Gu="cameraStoppedUnexpectedly",ju="capturerStoppedUnexpectedly",qu="speakingWhileMicrophoneIsMuted",Wu="cameraFreeze",zu="cameraStartFailed",Ku="capturerStartFailed",Ju="cameraStartTimedOut",Yu="screenshareRecordingDisabled",Qu="microphonePermissionDenied",Xu="cameraPermissionDenied";class UserFacingDiagnosticsFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new UserFacingDiagnosticsImplOverTsCall}get name(){return this._sendFeatureUsage("name",Rh.getter),"Diagnostics"}get network(){return this._sendFeatureUsage("network",Rh.getter),this._impl.network}get media(){return this._sendFeatureUsage("media",Rh.getter),this._impl.media}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g,m),this._sendFeatureUsage("initialize",Rh.initialize)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Diagnostics",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class UserFacingDiagnosticsImplOverTsCall{get network(){return this._network}get media(){return this._media}constructor(){}initialize(g,m){this._network=new NetworkDiagnosticsImpl(g,m),this._media=new MediaDiagnosticsImpl(g,m)}dispose(){}}class UserFacingDiagnosticsImpl{constructor(m,S){this.logger=S,this._tsUfdUnknownValue=0,this.tsQualityToAcsQualityMap={1:g.DiagnosticQuality.Good,2:g.DiagnosticQuality.Poor,3:g.DiagnosticQuality.Bad},this.tssQualityToAcsBooleanMap={3:!0,1:!1},this._tsCall=m.tsCall,this.eventEmitter=new Su.EventEmitter,this._tsCall.on("callQualityChanged",(m=>{try{const S=this.mapTSQualityEventType(m.type,m.mediaType);if(S){if(m.value===this._tsUfdUnknownValue)return;const v=S,C=this.mapTSQualityLevel(S,m.value);let _;if("number"!=typeof C||C!==g.DiagnosticQuality.Good&&C!==g.DiagnosticQuality.Poor&&C!==g.DiagnosticQuality.Bad){if("boolean"!=typeof C)throw new CallingCommunicationError({defaultError:D.FEATURES.DIAGNOSTICS.INCORRECT_VALUETYPE_MAPPED,defaultErrorMessageArgs:[typeof C,C,v]});_="DiagnosticFlag"}else _="DiagnosticQuality";let E={diagnostic:v,value:C,valueType:_};this.logger.log(`Call diagnostic changed, diagnostic='${E.diagnostic}', value='${E.value}'`);const T="DiagnosticFlag"===E.valueType&&!0===E.value,I="DiagnosticQuality"===E.valueType&&(E.value===g.DiagnosticQuality.Bad||E.value===g.DiagnosticQuality.Poor);(T||I)&&this.logger.warn(`Call diagnostic error raised!, diagnostic='${E.diagnostic}', value='${E.value}', value type='${E.valueType}'`),this.eventEmitter.emit("diagnosticChanged",E)}}catch(g){this.logger.error(`${g?.message})`)}}))}}class NetworkDiagnosticsImpl extends UserFacingDiagnosticsImpl{constructor(g,m){super(g,m.createChild((()=>`[UserFacingDiagnosticsFeature:NetworkDiagnostics:Call(id='${g.tsCall.callId}', state='${g.tsCall.state}')]`))),this.latestNetworkDiagnostics=new Map}on(g,m){if("diagnosticChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.DIAGNOSTICS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.on(g,m)}off(g,m){if("diagnosticChanged"!==g&&"diagnosticFlagChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.DIAGNOSTICS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.off(g,m)}getLatest(){try{return convertMapToFrozenJson(this.latestNetworkDiagnostics)}catch(g){return this.logger.error("Failed to get latest network diagnostics"),{}}}mapTSQualityEventType(g){return{5:ku,2:Lu,1:Fu,32:xu,37:Uu}[g]}mapTSQualityLevel(g,m){let S,v;switch(g){case ku:case Lu:case Fu:v="DiagnosticQuality",S=this.tsQualityToAcsQualityMap[m];break;case xu:case Uu:v="DiagnosticFlag",S=this.tssQualityToAcsBooleanMap[m]}if(void 0===S)throw new CallingCommunicationError({defaultError:D.FEATURES.DIAGNOSTICS.INCORRECT_VALUE_MAPPED,defaultErrorMessageArgs:[m,g]});return this.latestNetworkDiagnostics.set(g,{value:S,valueType:v}),S}}class MediaDiagnosticsImpl extends UserFacingDiagnosticsImpl{constructor(g,m){super(g,m.createChild((()=>`[UserFacingDiagnosticsFeature:MediaDiagnostics:Call(id='${g.tsCall.callId}', state='${g.tsCall.state}')]`))),this.latestMediaDiagnostics=new Map}on(g,m){if("diagnosticChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.DIAGNOSTICS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.on(g,m)}off(g,m){if("diagnosticChanged"!==g&&"diagnosticFlagChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.DIAGNOSTICS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.off(g,m)}getLatest(){try{return convertMapToFrozenJson(this.latestMediaDiagnostics)}catch(g){return this.logger.error("Failed to get latest media diagnostics"),{}}}mapTSQualityEventType(g,m){const S={44:Vu,43:Bu,9:Hu,25:$u,27:qu,45:Wu,33:zu,34:Ju,55:Yu,26:Qu,47:Xu};return this.overrideQualityEventsForMediaType(S[g],m)}overrideQualityEventsForMediaType(g,m){if(g===$u)switch(m){case 1:return Gu;case 2:return ju}return g===zu&&2===m?Ku:g}mapTSQualityLevel(g,m){let S,v;switch(g){case Vu:case Bu:case Hu:case $u:case qu:case Wu:case zu:case Ju:case Yu:case Qu:case Xu:case Gu:case ju:case Ku:v="DiagnosticFlag",S=this.tssQualityToAcsBooleanMap[m]}if(void 0===S)throw new CallingCommunicationError({defaultError:D.FEATURES.DIAGNOSTICS.INCORRECT_VALUE_MAPPED,defaultErrorMessageArgs:[m,g]});return this.latestMediaDiagnostics.set(g,{value:S,valueType:v}),S}}class DominantSpeakersCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new DominantSpeakersCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Rh.getter),"DominantSpeakers"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Rh.initialize)}get dominantSpeakers(){return this._sendFeatureUsage("dominantSpeakers",Rh.getter),this._impl.dominantSpeakers}on(g,m){this._sendFeatureUsage("dominantSpeakersChanged",Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage("dominantSpeakersChanged",Rh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"DominantSpeakers",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class DominantSpeakersCallImplOverTsCall{constructor(g){this._eventEmitter=g,this.localDominantList=[]}initialize(g,m,S,v,C=!1){this._logger=v.createChild((()=>`DominantSpeakersFeature${C?"Internal":""}::Call(id='${g.callId}')`)),this._tsCall=g,this.localDominantList=this._tsCall.dominantSpeakerInfo?.speakerList||[],this._tsCallChangedListener=this._tsCall.changed((()=>{let g=!1;if(this.localDominantList.length!=this._tsCall.dominantSpeakerInfo.speakerList.length)g=!0;else for(let m in this._tsCall.dominantSpeakerInfo.speakerList)if(this._tsCall.dominantSpeakerInfo.speakerList[m]!==this.localDominantList[m]){g=!0;break}g&&(this._logger.info("Dominant speakers list change detected"),this.localDominantList=this._tsCall.dominantSpeakerInfo.speakerList,this._eventEmitter.emit("dominantSpeakersChanged"))}))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}get dominantSpeakers(){let g=Array();return this._tsCall.dominantSpeakerInfo.speakerList.map((m=>{g.push(constructIdentifierKindFromMri(m))})),{speakersList:g,timestamp:this._tsCall.dominantSpeakerInfo.timestamp||new Date}}dispose(){this._eventEmitter.removeAllListeners(),this._tsCallChangedListener?.dispose()}}class CallingEventEmitter extends Su.EventEmitter{constructor(g,m){super(),this._options={enableLogOn:!0,enableLogOff:!0,enableLogOnce:!0,enableLogEmit:!0},this._logger=g.createChild("CallingEventEmitter"),m&&(this._options=m)}on(g,m){return!1!==this._options.enableLogOn&&this._logger.info(`event:subscribe to ${g.toString()}`),super.on(g,m)}once(g,m){return!1!==this._options.enableLogOnce&&this._logger.info(`event:subscribe once to ${g.toString()}`),super.once(g,m)}off(g,m){return!1!==this._options.enableLogOff&&this._logger.info(`event:unsubscribed ${g.toString()}`),super.off(g,m)}emit(g,...m){try{return!1!==this._options.enableLogEmit&&this._logger.info(`event:emit ${g.toString()}`),super.emit(g,...m)}catch(m){return this._logger.warn(`Application threw an error while it handled the ${g.toString()} event`),!1}}}function createMediaStatsReportInternalObject(){return{audio:{send:{},receive:{}},video:{send:{},receive:{}},screenShare:{send:{},receive:{}},dataChannel:{},transports:{}}}function getMax(g){let m=g.length>0?g[0]:0;return g.forEach((g=>{g>m&&(m=g)})),m}function getMin(g){let m=g.length>0?g[0]:0;return g.forEach((g=>{g<m&&(m=g)})),m}function getSum(g){let m=0,S=0;return g.forEach((g=>{const v=g-S,C=m+v;S=C-m-v,m=C})),m}const Zu=createMediaStatsReportInternalObject;class MediaStatsCalculator{constructor(g){this._metricsProperties=g,this._originalValues={},this._aggregateValues={},this._events=[],this._currentValues={}}addStats(g,m){const S=this._metricsProperties[g];if(void 0!==S&&!0!==S.skip){if(S.events){const v=S.output_key??g;m!==this._currentValues[v]&&(this._currentValues[v]=m,this._events.push({name:v,value:m,timestamp:Date.now()}))}else{let S=this._originalValues[g];void 0===S&&(S={raw:[],beginTime:Date.now()},this._originalValues[g]=S),S.raw.push(m)}return m}}aggregate(){for(const[g,m]of Object.entries(this._originalValues)){const S=this._metricsProperties[g],v=S.output_key??g;let C=this._aggregateValues[v];void 0===C&&(C={raw:[],timestamp:new Date(m.beginTime)},S.aggregable&&(C.aggregation={count:[],sum:[],max:[],min:[]}),this._aggregateValues[v]=C);const _=m.raw;let E=_;if(S.aggregable&&C.aggregation){const g=_.filter((g=>"number"==typeof g&&!isNaN(g)));C.aggregation.count.push(g.length),C.aggregation.sum.push(getSum(g)),C.aggregation.max.push(getMax(g)),C.aggregation.min.push(getMin(g)),E=g}S.raw_data_reduction&&E.length>0&&(C.reduced=C.reduced||[],C.reduced.push(E[E.length-1])),E.forEach((g=>C.raw.push(g)))}this._originalValues={}}popAggregates(){const g=this._aggregateValues;return this._aggregateValues={},g}popEvents(){const g=this._events;return this._events=[],g}}class TelemetryCollector{constructor(g,m){if(this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=Zu(),this._isActive=!1,m.aggregationInterval<1)throw new Error("invalid aggregationInterval value range");if(m.dataPointsPerAggregation<1)throw new Error("invalid dataPointsPerAggregation value range");this._metricsProperties=m.metricsPropertics,this._logger=g.createChild("TelemetryCollector"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._callStateChanged=defer$1(),this._aggregationInterval=m.aggregationInterval,this._dataPointsPerAggregation=m.dataPointsPerAggregation,this._run()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._disposed||(this._disposed=!0,this._callStateChanged.resolve(!1),this._eventEmitter.removeAllListeners(),this._mediaStatsSource?.removeSink(this))}get source(){return this._mediaStatsSource}set source(g){this._mediaStatsSource=g}onReport(g){this._processMediaStatsReport(g)}onAdded(g){this._isActive!==g&&(this._isActive=g,this._callStateChanged.resolve(g))}onRemoved(){this.dispose()}pause(){this._isActive&&(this._isActive=!1,this._callStateChanged.resolve(!1))}resume(){this._isActive||(this._isActive=!0,this._callStateChanged.resolve(!0))}stop(){this.dispose()}_processMediaStatsReport(g){try{const m=[[g.audio.send,this._calculators.audio.send,this._metricsProperties.audio.send,"send"],[g.audio.receive,this._calculators.audio.receive,this._metricsProperties.audio.receive,"recv"],[g.video.send,this._calculators.video.send,this._metricsProperties.video.send,"send"],[g.video.receive,this._calculators.video.receive,this._metricsProperties.video.receive,"recv"],[g.screenShare.send,this._calculators.screenShare.send,this._metricsProperties.screenShare.send,"send"],[g.screenShare.receive,this._calculators.screenShare.receive,this._metricsProperties.screenShare.receive,"recv"],[g.dataChannel,this._calculators.dataChannel,this._metricsProperties.dataChannel,""],[g.transports,this._calculators.transports,this._metricsProperties.transports,""]];for(const[S,v,C,_]of m){const m=[],E=Object.keys(v);Object.keys(S).forEach((E=>{const T=S[E],I=T.id;m.push(I),void 0===v[I]&&(v[I]=new MediaStatsCalculator(C));const addStats=(g,m)=>v[I].addStats(g,m);if(Object.keys(T).forEach((g=>addStats(g,T[g]))),"send"==_||"recv"==_){const m=T.transportId;if(void 0!==m){const S=g.transports[m];void 0!==S.rtt&&addStats("pairRttInMs",S.rttInMs),void 0!==S.availableIncomingBitrate&&"recv"==_&&addStats("availableBitrate",S.availableIncomingBitrate),void 0!==S.availableOutgoingBitrate&&"send"==_&&addStats("availableBitrate",S.availableOutgoingBitrate)}}}));E.filter((g=>!m.includes(g))).forEach((g=>{delete v[g]}))}}catch(g){this._logger.error(g)}}async _run(){let g=0;const flushData=()=>{if(0===g)return;const m={audio:{send:{},receive:{}},video:{send:{},receive:{}},screenShare:{send:{},receive:{}},dataChannel:{},transports:{}},S=[[m.audio.send,this._calculators.audio.send],[m.audio.receive,this._calculators.audio.receive],[m.video.send,this._calculators.video.send],[m.video.receive,this._calculators.video.receive],[m.screenShare.send,this._calculators.screenShare.send],[m.screenShare.receive,this._calculators.screenShare.receive],[m.dataChannel,this._calculators.dataChannel],[m.transports,this._calculators.transports]];for(const[g,m]of S)for(const[S,v]of Object.entries(m))g[S]={id:S,...v.popAggregates(),events:v.popEvents()};this._eventEmitter.emit("data",m),g=0};let m=1e3*this._aggregationInterval;for(;!this._disposed;){const S=[this._calculators.audio.send,this._calculators.audio.receive,this._calculators.video.send,this._calculators.video.receive,this._calculators.screenShare.send,this._calculators.screenShare.receive,this._calculators.dataChannel];if(this._isActive){m>0&&await wait((()=>this._callStateChanged.promise),m).catch((g=>{}));const v=Date.now();for(const g of S)for(const[,m]of Object.entries(g))m.aggregate();g++,g===this._dataPointsPerAggregation&&flushData();const C=Date.now();m=v+1e3*this._aggregationInterval-C}else flushData(),this._calculators=Zu(),await this._callStateChanged.promise.catch((g=>{})),m=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=defer$1())}flushData()}}function convertAltLayouts(g){const m=[];return g.sort(((g,m)=>g.id>m.id?1:g.id<m.id?-1:0)),g.forEach((g=>{const S=/^([^.]+)\.?([^.]+)?$/.exec(g.id);if(S&&S[2]){g.id=P.toString(S[2]);const v=P.toString(S[1]);if(m.length>0&&m[m.length-1].id===v){const S=m[m.length-1].altLayouts??[];S.push(g),m[m.length-1].altLayouts=S}else m.push(g)}else m.push(g)})),m}class MediaStatsCollectorImpl{constructor(g,m){if(this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=Zu(),this._isActive=!1,m.aggregationInterval<1)throw new CallingCommunicationError({defaultError:D.FEATURES.MEDIA_STATS.INVALID_AGGREGATION_INTERVAL_RANGE});if(m.dataPointsPerAggregation<1)throw new CallingCommunicationError({defaultError:D.FEATURES.MEDIA_STATS.INVALID_DATAPOINTS_AGGREGATION_RANGE});this._metricsProperties=m.metricsPropertics,this._logger=g.createChild("MediaStatsCollector"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._callStateChanged=defer$1(),this._aggregationInterval=m.aggregationInterval,this._dataPointsPerAggregation=m.dataPointsPerAggregation,this._run()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._disposed||(this._disposed=!0,this._callStateChanged.resolve(!1),this._eventEmitter.removeAllListeners(),this._mediaStatsSource?.removeSink(this))}get source(){return this._mediaStatsSource}set source(g){this._mediaStatsSource=g}onReport(g){this._processMediaStatsReport(g)}onAdded(g){this._isActive!==g&&(this._isActive=g,this._callStateChanged.resolve(g))}onRemoved(){this.dispose()}pause(){this._isActive&&(this._isActive=!1,this._callStateChanged.resolve(!1))}resume(){this._isActive||(this._isActive=!0,this._callStateChanged.resolve(!0))}stop(){this.dispose()}_processMediaStatsReport(g){const m={audio:{send:[],receive:[]},video:{send:[],receive:[]},screenShare:{send:[],receive:[]},transports:[]};try{const S=[[g.audio.send,m.audio.send,this._calculators.audio.send,this._metricsProperties.audio.send],[g.audio.receive,m.audio.receive,this._calculators.audio.receive,this._metricsProperties.audio.receive],[g.video.send,m.video.send,this._calculators.video.send,this._metricsProperties.video.send],[g.video.receive,m.video.receive,this._calculators.video.receive,this._metricsProperties.video.receive],[g.screenShare.send,m.screenShare.send,this._calculators.screenShare.send,this._metricsProperties.screenShare.send],[g.screenShare.receive,m.screenShare.receive,this._calculators.screenShare.receive,this._metricsProperties.screenShare.receive],[g.transports,m.transports,this._calculators.transports,this._metricsProperties.transports]];let v=!1;for(const[g,m,C,_]of S){const S=[],E=Object.keys(C);Object.keys(g).forEach((E=>{const T=g[E];let I=T.id;T.groupId&&(I=`${T.groupId}.${I}`,v=!0);const b={id:I};S.push(I),void 0===C[I]&&(C[I]=new MediaStatsCalculator(_)),Object.keys(T).forEach((g=>{const m=_[g];if(m&&!0!==m.skip){const S=C[I].addStats(g,T[g]),v=m.output_key??g;b[v]=S}})),m.push(b)}));E.filter((g=>!S.includes(g))).forEach((g=>{delete C[g]}))}v&&(m.video.send=convertAltLayouts(m.video.send),m.screenShare.send=convertAltLayouts(m.screenShare.send))}catch(g){this._logger.error(g)}this._eventEmitter.emit("sampleReported",m)}async _run(){let g=0;const flushData=()=>{if(0===g)return;const m={audio:{send:[],receive:[]},video:{send:[],receive:[]},screenShare:{send:[],receive:[]},transports:[]};for(const[g,S]of Object.entries(this._calculators.audio.send))m.audio.send.push({id:g,...S.popAggregates()});for(const[g,S]of Object.entries(this._calculators.audio.receive))m.audio.receive.push({id:g,...S.popAggregates()});for(const[g,S]of Object.entries(this._calculators.video.send))m.video.send.push({id:g,...S.popAggregates()});for(const[g,S]of Object.entries(this._calculators.video.receive))m.video.receive.push({id:g,...S.popAggregates()});for(const[g,S]of Object.entries(this._calculators.screenShare.send))m.screenShare.send.push({id:g,...S.popAggregates()});for(const[g,S]of Object.entries(this._calculators.screenShare.receive))m.screenShare.receive.push({id:g,...S.popAggregates()});for(const[g,S]of Object.entries(this._calculators.transports))m.transports.push({id:g,...S.popAggregates()});m.video.send=convertAltLayouts(m.video.send),m.screenShare.send=convertAltLayouts(m.screenShare.send),this._eventEmitter.emit("summaryReported",m),g=0};let m=1e3*this._aggregationInterval;for(;!this._disposed;){const S=[this._calculators.audio.send,this._calculators.audio.receive,this._calculators.video.send,this._calculators.video.receive,this._calculators.screenShare.send,this._calculators.screenShare.receive,this._calculators.transports];if(this._isActive){m>0&&await wait((()=>this._callStateChanged.promise),m).catch((g=>{}));const v=Date.now();for(const g of S)for(const[,m]of Object.entries(g))m.aggregate();g++,g===this._dataPointsPerAggregation&&flushData();const C=Date.now();m=v+1e3*this._aggregationInterval-C}else flushData(),this._calculators=Zu(),await this._callStateChanged.promise.catch((g=>{})),m=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=defer$1())}flushData()}}class AbstractTicker{constructor(){this._eventEmitter=new Su.EventEmitter,this._getCurrentTime=globalThis.performance&&"function"==typeof globalThis.performance.now?()=>globalThis.performance.now():()=>Date.now()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._eventEmitter.removeAllListeners()}}class IntervalTicker extends AbstractTicker{constructor(g){super(),this._intervalInMs=g,this._handle=0}start(){this._handle||(this._handle=globalThis.setInterval((()=>{this._eventEmitter.emit("tick")}),this._intervalInMs))}stop(){this._handle&&(globalThis.clearInterval(this._handle),this._handle=0)}dispose(){this.stop(),super.dispose()}}class ChainedTimeoutTicker extends AbstractTicker{constructor(g){super(),this._intervalInMs=g,this._callQueue=Promise.resolve(),this._state={isRunning:!1}}start(){if(this._state.isRunning)return;const g={isRunning:!0};this._state=g;const runLoop=async()=>{for(;g.isRunning;){const g=this._getCurrentTime();this._eventEmitter.emit("tick");const m=this._getCurrentTime()-g;m<this._intervalInMs&&await sleep(this._intervalInMs-m)}};this._callQueue=this._callQueue.then((()=>runLoop())).catch((()=>{}))}stop(){this._state.isRunning&&(this._state.isRunning=!1)}dispose(){this._state.isRunning=!1,super.dispose()}}class TickerFactory{static createTicker(g,m){if("interval"===g)return new IntervalTicker(m);if("timeout"===g)return new ChainedTimeoutTicker(m);throw new Error(`Invalid tickerType: ${g}`)}}class StatsPoller{constructor(g,m,S,v){this._tsCall=g,this._logger=m,this._dataEventRefCount=0,this._lastFetchTime=0,this._timerDelayRatio=0,this._pendingStats=!1,this._fetchInterval=S,this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1});const C=1e3*S;this._ticker=TickerFactory.createTicker(v,C),this._ticker.on("tick",(()=>{const g=Date.now();this._lastFetchTime>0&&(this._timerDelayRatio=(g-this._lastFetchTime)/C),this._lastFetchTime=g,this._dataEventRefCount>0&&!1===this._pendingStats&&(this._pendingStats=!0,this.getStats().then((g=>{g&&this._eventEmitter.emit("data",g)})).catch((g=>{this._logger.error(g)})).finally((()=>{this._pendingStats=!1})))}));const checkState=()=>{[10,3].includes(this._tsCall.state)?this._start():this._stop()};this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{checkState()})),checkState()}dispose(){this._callStateChangedHandle.dispose(),this._ticker.dispose()}get fetchInterval(){return this._fetchInterval}get timerDelayRatio(){return this._timerDelayRatio}_start(){this._lastFetchTime=0,this._timerDelayRatio=0,this._ticker.start()}_stop(){this._ticker.stop()}on(g,m){this._dataEventRefCount++,this._eventEmitter.on(g,m)}off(g,m){this._dataEventRefCount--,this._eventEmitter.off(g,m)}}class MediaStatsPoller extends StatsPoller{constructor(g,m,S){super(g,m.createChild("MediaStatsPoller"),S.fetchInterval,S.pollingMethod)}async getStats(){return{report:this._tsCall.getMediaSessionStats(),delayRatio:this.timerDelayRatio}}}var eg;!function(g){g[g.Running=0]="Running",g[g.Paused=1]="Paused",g[g.Stopped=2]="Stopped"}(eg||(eg={}));class MediaStatsSourceNode{constructor(){this._sinks=[],this._transformers=[],this._state=eg.Running}_setTransformers(g){this._transformers=g.slice()}addSink(g){g.source=this,this._sinks.push(g),g.onAdded(this._state===eg.Running)}removeSink(g){g.source===this&&(P.pull(this._sinks,g),g.source=void 0,g.onRemoved())}removeAllSinks(){const g=this._sinks;this._sinks=[],g.forEach((g=>{g.source=void 0,g.onRemoved()}))}send(g){if(this._state!==eg.Running)return;let m=g;this._transformers.length&&(m=this._transformers.reduce(((g,m)=>m.transform(g)),g)),this._sinks.forEach((g=>g.onReport(m)))}pause(){this._state===eg.Running&&(this._state=eg.Paused,this._sinks.forEach((g=>g.pause())))}resume(){this._state===eg.Paused&&(this._state=eg.Running,this._sinks.forEach((g=>g.resume())))}stop(){this._state!==eg.Stopped&&this._sinks.forEach((g=>g.stop()))}}class MediaStatsReportSourceNode extends MediaStatsSourceNode{constructor(g){super(),this._setTransformers(g)}onReport(g){if(void 0===g.report)return;const m=createMediaStatsReportInternalObject();m.metadata=m.metadata??{},m.metadata.delayRatio=g.delayRatio;const S=[[g.report.audio.send,m.audio.send],[g.report.audio.recv,m.audio.receive],[g.report.video.send,m.video.send],[g.report.video.recv,m.video.receive],[g.report.screenShare.send,m.screenShare.send],[g.report.screenShare.recv,m.screenShare.receive],[g.report.data,m.dataChannel],[g.report.transports,m.transports]],extractKV=g=>{const m={};return Object.entries(g).forEach((g=>{const S=g[0],v=g[1];"altLayouts"!==S&&null!=v&&(m[S]=v)})),m};S.forEach((g=>{const m=g[0];if(void 0!==m){const S=g[1];m.forEach((g=>{const m=P.toString(g.id);if(S[m]=extractKV(g),void 0!==g.altLayouts){g.altLayouts.forEach((g=>{const v=g.id,C=extractKV(g);C.groupId=m,S[v]=C}))}}))}})),this.send(m)}}class MediaStatsReportFilterNode extends MediaStatsSourceNode{constructor(g){super(),this._setTransformers(g)}onAdded(g){}onRemoved(){}onReport(g){this.send(g)}get source(){return this._mediaStatsSource}set source(g){this._mediaStatsSource=g}}class ParticipantMappingManager{constructor(g){this._tsCall=g,this._activeParticipantMris=new Set,this._sourceIdToParticipantInfo=new Map,this._listenerHandles=[],this._config=getAcsEcsConfig(),this._listenerHandles.push(this._tsCall.on("participantAdded",(g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(g=>{this._activeParticipantMris.has(g.id)&&this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(g=>{this._activeParticipantMris.delete(g.id),this._removeMapping(g)}))),this._tsCall.participants?.forEach((g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g)}))}_updateMapping(g){const m=g.id,S=[],v=this._config.calling.composedStreamBotIds;g.endpoints?.endpointDetails?.forEach((g=>{g.mediaStreams?.forEach((C=>{S.push(C.sourceId),this._sourceIdToParticipantInfo.set(C.sourceId,{mri:m,participantId:g.participantId,isComposedStream:v.includes(m)})}))}))}_removeMapping(g){g.endpoints?.endpointDetails?.forEach((g=>{g.mediaStreams?.forEach((g=>{this._sourceIdToParticipantInfo.delete(g.sourceId)}))}))}findParticipantInfo(g){let m=this._sourceIdToParticipantInfo.get(g);if(void 0===m&&this.isP2P()&&this._tsCall.participants.length&&this._tsCall.participants[0].endpoints?.endpointDetails.length){const g=this._tsCall.participants[0],S=g.endpoints?.endpointDetails[0];m={mri:g.id,participantId:S?.participantId??"",isComposedStream:!1}}return m}isP2P(){return 1===this._tsCall.callType}dispose(){this._activeParticipantMris.clear(),this._sourceIdToParticipantInfo.clear(),this._listenerHandles.forEach((g=>g.dispose()))}}class MediaStatsTelemetryLogger{constructor(g,m,S,v){this._tsCall=g,this._call=m,this._telemetryLogManager=S,this._config=v,this._participantMappingManager=new ParticipantMappingManager(this._tsCall)}dispose(){this._participantMappingManager.dispose()}log(g){const m=this._config.telemetry.mediaStatsConfig;[{type:"audio",direction:"send",value:g.audio.send},{type:"audio",direction:"recv",value:g.audio.receive},{type:"video",direction:"send",value:g.video.send},{type:"video",direction:"recv",value:g.video.receive},{type:"screen",direction:"send",value:g.screenShare.send},{type:"screen",direction:"recv",value:g.screenShare.receive},{type:"data",direction:"",value:g.dataChannel},{type:"transport",direction:"",value:g.transports}].forEach((g=>{const S=Object.values(g.value);S.forEach((v=>{const C={id:v.id},_={id:v.id};Object.keys(v).forEach((g=>{const S=g;if("id"===g)return;if("events"===g){const g=v[S];return void(g.length>0&&(C.events=JSON.stringify(g)))}const E=v[S];if(m.dataToSend.raw){const g={};E?.timestamp&&(g.timestamp=E?.timestamp),m.dataToSend.raw&&(g.raw=E?.raw),_[S]=g}const T={};void 0!==E.aggregation?(E.timestamp&&(T.timestamp=E.timestamp),m.dataToSend.min&&(T.min=E.aggregation.min),m.dataToSend.max&&(T.max=E.aggregation.max),m.dataToSend.sum&&(T.sum=E.aggregation.sum),m.dataToSend.count&&(T.count=E.aggregation.count)):(E.timestamp&&(T.timestamp=E.timestamp),E.reduced?T.raw=E.reduced:E.raw&&(T.raw=E.raw)),C[S]=T}));let E="",T="";if(("video"===g.type||"screen"===g.type)&&"recv"===g.direction){const g=v;if(void 0!==g.streamId&&g.streamId.raw?.length){const m=g.streamId.raw[0],S=this._participantMappingManager.findParticipantInfo(m);E=S?.participantId??"",T=S?.isComposedStream?"ComposedVideoStream":"RemoteVideoStream"}}if(Object.keys(C).length>1){const m={mediaType:g.type,mediaDirection:g.direction,stats:C,callId:this._tsCall.callId,remoteParticipantId:E,localParticipantId:this._tsCall.participantId,videoStreamKind:T,streamCount:S.length,appliedFrameHeightMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.frameHeight?.max,appliedBitrateMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.bitrate?.max,appliedFrameRateMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.frameRate?.max};this._sendMidCallNewMediaStats(m)}if(m.dataToSend.raw&&Object.keys(_).length>1){const m={mediaType:g.type,mediaDirection:g.direction,stats:_,callId:this._tsCall.callId,remoteParticipantId:E,localParticipantId:this._tsCall.participantId,videoStreamKind:T,streamCount:S.length};this._sendMidCallRawMediaStats(m)}}))}))}_sendMidCallNewMediaStats(g){this._telemetryLogManager.sendEvent({name:Ah.acs_calling_mid_call_new_media_stats,tenant:Qa,properties:g})}_sendMidCallRawMediaStats(g){this._telemetryLogManager.sendEvent({name:Ah.acs_calling_mid_call_raw_media_stats,tenant:Qa,properties:g})}}function cloneReport(){return{transform:g=>P.cloneDeep(g)}}function transformStatsReport(g){return{transform:m=>([[m.audio.send,g.audio.send],[m.audio.receive,g.audio.receive],[m.video.send,g.video.send],[m.video.receive,g.video.receive],[m.screenShare.send,g.screenShare.send],[m.screenShare.receive,g.screenShare.receive],[m.dataChannel,g.dataChannel],[m.transports,g.transports]].forEach((g=>{const m=g[0],S=g[1];P.forEach(S,((g,S)=>{!0!==g.disabled&&P.forEach(m,(m=>{let v=m[g.source];void 0!==v&&(void 0!==g.multiplier&&"number"==typeof v&&(v*=g.multiplier),g.integer&&(v=P.toInteger(v)),m[S]=v)}))}))})),m)}}function blockMetrics(g){const m=["audio.send","audio.receive","video.send","video.receive","screenShare.send","screenShare.receive","dataChannel","transports"];return{transform:S=>(P.forEach(m,(m=>{const v=P.get(S,m),C=P.get(g,m,[]);P.forEach(v,(g=>{C.forEach((m=>{"id"!==m&&delete g[m]}))}))})),S)}}function filterMetricsByRangeLimit(g,m){return{transform:S=>{const v=S.metadata?.delayRatio,C=g>0&&void 0!==v&&v>g;return P.forEach(m,((g,m)=>{const v=P.get(S,m);P.forEach(v,(m=>{P.forEach(g,((g,S)=>{if(C)delete m[S];else{const v=m[S];(void 0!==g.max&&v>g.max||void 0!==g.min&&v<g.min||P.isNaN(v))&&delete m[S]}}))}))})),S}}}const tg={codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},frameRateInput:{aggregable:!0},frameWidthInput:{aggregable:!0},frameHeightInput:{aggregable:!0},framesEncoded:{},frameRateEncoded:{aggregable:!0},framesSent:{},frameRateSent:{aggregable:!0},frameWidthSent:{aggregable:!0},frameHeightSent:{aggregable:!0},keyFramesEncoded:{},transportId:{}},ig={codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},streamId:{},jitterBufferDelayInMs:{aggregable:!0},frameRateDecoded:{aggregable:!0},frameRateReceived:{aggregable:!0},frameWidthReceived:{aggregable:!0},frameHeightReceived:{aggregable:!0},longestFreezeDurationInMs:{},totalFreezeDurationInMs:{},framesReceived:{},framesDropped:{},framesDecoded:{},keyFramesDecoded:{},transportId:{}},ng={audio:{send:{codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},audioInputLevel:{aggregable:!0},transportId:{}},receive:{codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},jitterBufferDelayInMs:{aggregable:!0},audioOutputLevel:{aggregable:!0},healedRatio:{aggregable:!0},transportId:{}}},video:{send:tg,receive:ig},screenShare:{send:tg,receive:ig},dataChannel:{incomingBitrate:{aggregable:!0},outgoingBitrate:{aggregable:!0},messagesSentPerSecond:{aggregable:!0},messagesReceivedPerSecond:{aggregable:!0}},transports:{rttInMs:{aggregable:!0},availableIncomingBitrate:{aggregable:!0},availableOutgoingBitrate:{aggregable:!0}}},rg={codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},framesEncoded:{raw_data_reduction:!0},framesSent:{raw_data_reduction:!0},keyFramesEncoded:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0},groupId:{raw_data_reduction:!0}},sg={codecName:{raw_data_reduction:!0},streamId:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},jitterBufferDelayInMs:{output_key:"jitterBufferInMs"},longestFreezeDurationInMs:{skip:!0},totalFreezeDurationInMs:{raw_data_reduction:!0},framesReceived:{raw_data_reduction:!0},framesDropped:{raw_data_reduction:!0},framesDecoded:{raw_data_reduction:!0},keyFramesDecoded:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}},ag={audio:{send:{codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}},receive:{codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},jitterBufferDelayInMs:{output_key:"jitterBufferInMs"},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}}},video:{send:rg,receive:sg},screenShare:{send:rg,receive:sg},dataChannel:{state:{raw_data_reduction:!0},dataChannelIdentifier:{raw_data_reduction:!0},messagesSent:{raw_data_reduction:!0},bytesSent:{raw_data_reduction:!0},messagesReceived:{raw_data_reduction:!0},bytesReceived:{raw_data_reduction:!0}},transports:{candidateType:{events:!0},relayProtocol:{events:!0}}},og={multiplier:1e3,integer:!0,source:"jitter"},lg={multiplier:1e3,integer:!0,source:"rtt"},cg={integer:!0,source:"jitterBufferMs"},dg={jitterInMs:og,rttInMs:lg},hg={jitterInMs:og,rttInMs:lg,jitterBufferDelayInMs:cg,streamId:{source:"msi"},longestFreezeDurationInMs:{multiplier:1e3,integer:!0,source:"longestFreezeDuration"},totalFreezeDurationInMs:{multiplier:1e3,integer:!0,source:"totalFreezeDuration"}},ug={audio:{send:{jitterInMs:og,rttInMs:lg,audioInputLevel:{multiplier:65536,integer:!0,source:"audioLevel"}},receive:{jitterInMs:og,rttInMs:lg,jitterBufferDelayInMs:cg,audioOutputLevel:{multiplier:65536,integer:!0,source:"audioLevel"}}},video:{send:dg,receive:hg},screenShare:{send:dg,receive:hg},dataChannel:{incomingBitrate:{source:"recvBitrate"},outgoingBitrate:{source:"sendBitrate"}},transports:{rttInMs:lg}};class MediaStatsManager{constructor(g,m,S,v){this._tsCall=g,this._call=m,this._logger=S,this._disposed=!1;const C=getAcsEcsConfig();this._config=C.mediaStats,this._statsPoller=new MediaStatsPoller(this._tsCall,this._logger,this._config);const _=[transformStatsReport(P.merge(P.cloneDeep(ug),this._config.transformMetrics))];this._config.timerThrottlingFilter.enabled&&_.push(filterMetricsByRangeLimit(this._config.timerThrottlingFilter.delayRatio,this._config.timerThrottlingFilter.filterRange)),this._mediaStatsSourceNode=new MediaStatsReportSourceNode(_);const E=[3,10];this._isCallActive=E.includes(this._tsCall.state),this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{const g=E.includes(this._tsCall.state);this._isCallActive!==g&&(this._isCallActive=g,g?this._mediaStatsSourceNode.resume():this._mediaStatsSourceNode.pause())}));const T=this._config.blockMetrics;if(Object.keys(T).length>0){const g=new MediaStatsReportFilterNode([cloneReport(),blockMetrics(T)]);this._mediaStatsSourceNode.addSink(g),this._collectorsSourceNode=g}else this._collectorsSourceNode=this._mediaStatsSourceNode;const I=C.telemetry.mediaStatsConfig;if(I.enabled){const g=new MediaStatsTelemetryLogger(this._tsCall,this._call,v,C),m=P.merge(P.cloneDeep(ng),ag,I.metricsProperties),S=new TelemetryCollector(this._logger,{aggregationInterval:I.aggregationInterval,dataPointsPerAggregation:I.dataPointsPerAggregation,metricsPropertics:m});S.on("data",(m=>g.log(m))),this._mediaStatsSourceNode.addSink(S)}this._isCallActive?this._mediaStatsSourceNode.resume():this._mediaStatsSourceNode.pause(),this._dataEventListener=g=>{this._mediaStatsSourceNode.onReport(g)},this._statsPoller.on("data",this._dataEventListener)}createCollector(g){if(this._disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.MEDIA_STATS.DISPOSED});const m=this._config,S=new MediaStatsCollectorImpl(this._logger,{aggregationInterval:g?.aggregationInterval??m.aggregationInterval,dataPointsPerAggregation:g?.dataPointsPerAggregation??m.dataPointsPerAggregation,metricsPropertics:ng});return this._collectorsSourceNode.addSink(S),S}dispose(){this._disposed||(this._disposed=!0,this._statsPoller.off("data",this._dataEventListener),this._mediaStatsSourceNode.stop(),this._callStateChangedHandle.dispose())}}class MediaStatsCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g)}get name(){return this._sendFeatureUsage("name",Rh.getter),"MediaStats"}createCollector(g){this._sendFeatureUsage("createCollector",Rh.attempt);const m=this._statsManager.createCollector(g);return this._sendFeatureUsage("creaetCollector",Rh.success),m}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._statsManager=new MediaStatsManager(g.tsCall,this._call,this._logger,this._telemetryLogManager),this._sendFeatureUsage("initialize",Rh.initialize)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"MediaStats",featureType:"Call",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._statsManager.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}var gg,pg;(gg=g.RecordingState||(g.RecordingState={}))[gg.None=0]="None",gg[gg.Started=1]="Started",gg[gg.Paused=2]="Paused",gg[gg.Ended=3]="Ended";class RecordingCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new RecordingCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Rh.getter),"Recording"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Rh.initialize)}get isRecordingActive(){return this._sendFeatureUsage("isRecordingActive",Rh.getter),this._impl.isRecordingActive}get recordings(){return this._sendFeatureUsage("recordings",Rh.getter),this._impl.recordings}on(g,m){if("isRecordingActiveChanged"!==g&&"recordingsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.RECORDING.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){if("isRecordingActiveChanged"!==g&&"recordingsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.RECORDING.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._sendFeatureUsage(g,Rh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Recording",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class RecordingCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._recordingBots=new Map,this._recordingBotChangedSubs=new WeakMap,this._recordingInitiatorMap=new Map,this._isRecordingActive=!1,this._updateIsCallRecorded=g=>this._isRecordingActive!==g&&(this._isRecordingActive=g,this._logger.info(`Updating isCallRecorded to ${g}`),!0),this._handleRecordingBotAdded=g=>{const handleRecordingBotChanged=()=>{let m,S=!1,v=!1;if(this._hasRecordingState(g)){if(this._recordingBots.has(g.id)){let S=this._getRecordingBotEndpoint(g);if(m=this._recordingBots.get(g.id),S&&m){m.endpoint=S;let g=S.userId?this._recordingInitiatorMap.get(S.userId):void 0;v=m.recordingInfo?.update(S,g)??!1}}else m=this._getRecordingBotInfo(g),m&&(this._logger.info("Adding recording bot"),this._recordingBots.set(g.id,m),S=!0);this._sendEvents(v?[m]:void 0,S?[m]:void 0,void 0,this._updateIsCallRecorded(this._isRecordingEnabled()))}};handleRecordingBotChanged(),this._recordingBotChangedSubs.set(g,g.changed(handleRecordingBotChanged))},this._handleRecordingBotRemoved=g=>{let m=this._recordingBots.get(g.id);this._recordingBots.delete(g.id),this._recordingBotChangedSubs.get(g)?.dispose(),this._recordingBotChangedSubs.delete(g),this._logger.info(`Updating recordingState to ${m?.endpoint?.state}`),m?.recordingInfo?.dispose(),this._sendEvents([m],void 0,[m],this._updateIsCallRecorded(this._isRecordingEnabled()))},this._sendEvents=(g,m,S,v)=>{g&&g.forEach((g=>g?.recordingInfo?.sendRecordingStateChanged()));let C=!!m&&m.length>0,_=!!S&&S.length>0;(C||_)&&this._eventEmitter.emit("recordingsUpdated",{added:this._getRecordingInfos(m),removed:this._getRecordingInfos(S)}),v&&this._eventEmitter.emit("isRecordingActiveChanged")},this._hasRecordingState=g=>g?.endpoints?.endpointDetails?.some((g=>!!g?.endpointMetadata?.__platform?.recording?.compliance?.state||!!g?.endpointMetadata?.processingModes?.recording?.state))??!1,this._getRecordingInfos=g=>{if(g)return g.map((g=>g?.recordingInfo)).filter((g=>!!g))},this._isRecordingEnabled=()=>{let g=!1;try{this._recordingBots.forEach((m=>{g||(g="Active"===m?.endpoint?.state)}))}catch(g){this._logger.info("Unable to read recording state: ",g)}return g},this._getRecordingInfoImpl=g=>{if(null==g)return;if("Active"!==g.state&&"Inactive"!==g.state)return;let m;return void 0!==g.userId&&(m=this._recordingInitiatorMap.get(g.userId)),new RecordingInfoImpl(g.state,this._eventEmitter,m)},this._getRecordingBotInfo=g=>{let m=this._getRecordingBotEndpoint(g);return m?{endpoint:m,recordingInfo:this._getRecordingInfoImpl(m)}:void 0},this._getRecordingBotEndpoint=g=>{let m=g.endpoints?.endpointDetails.map((g=>{let m=g?.endpointMetadata?.__platform?.recording?.compliance?.state,S=g?.endpointMetadata?.__platform?.recording?.compliance?.userId,v=g?.endpointMetadata?.processingModes?.recording?.state,C=g?.endpointMetadata?.processingModes?.recording?.userId;if(m||v)return{state:m??v,userId:S??C}})).filter((g=>null!=g));if(m&&0!=m.length)return m.length>1&&this._logger.log(`Unexpected: multiple recording endpoints: ${m?.map((g=>g?.state??"undefined")).join(", ")}`),m[0]}}get isRecordingActive(){return this._isRecordingActive}get recordings(){return Array.from(this._recordingBots.values()).map((g=>g?.recordingInfo)).filter((g=>!!g))}initialize(g,m,S){this._logger=S.createChild((()=>`RecordingFeature::Call(id='${g.callId}', state='${g.state}')`)),g.on("callStateChanged",(async()=>{3===g.state&&this._initInitiatorMap(g)})),g.on("participantAdded",(async g=>{isCallingApplication(g.id)?this._handleRecordingBotAdded(g):void 0===g||this._recordingInitiatorMap.has(g.id)||this._recordingInitiatorMap.set(g.id,g.displayName)})),g.on("participantRemoved",(async g=>{isCallingApplication(g.id)?this._handleRecordingBotRemoved(g):void 0!==g&&this._recordingInitiatorMap.has(g.id)&&this._recordingInitiatorMap.delete(g.id)})),g.on("participantUpdated",(async g=>{void 0!==g&&this._recordingInitiatorMap.has(g.id)&&this._recordingInitiatorMap.set(g.id,g.displayName)}))}dispose(){let g=this._updateIsCallRecorded(!1),m=Array.from(this._recordingBots.values());m.forEach((g=>g?.recordingInfo?.dispose())),this._sendEvents(void 0,void 0,m,g)}_initInitiatorMap(g){const{participants:m}=g;[...m].forEach((g=>{isCallingApplication(g.id)||this._recordingInitiatorMap.set(g.id,g.displayName)}))}}class RecordingInfoImpl{constructor(g,m,S){this.state=this.getRecordingState(g),this._eventEmitter=m,this.displayName=S}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}update(g,m){if(null==g)return!1;let S=this.getRecordingState(g.state);return S!=this.state&&(this.state=S,void 0!==m&&(this.displayName=m),!0)}dispose(){this.state=g.RecordingState.Ended}sendRecordingStateChanged(){this._eventEmitter.emit("recordingStateChanged")}getRecordingState(m){let S=g.RecordingState.None;switch(m?.toLocaleLowerCase()){case"active":S=g.RecordingState.Started;break;case"inactive":S=g.RecordingState.Paused;break;default:S=g.RecordingState.None}return S}}(pg=g.LocalRecordingState||(g.LocalRecordingState={}))[pg.None=0]="None",pg[pg.Started=1]="Started",pg[pg.Ended=2]="Ended";const mg={ACTIVE:"active",INACTIVE:"inactive"};class LocalRecordingCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new LocalRecordingCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Rh.getter),"LocalRecording"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Rh.initialize)}get isRecordingActive(){return this._sendFeatureUsage("isRecordingActive",Rh.getter),this._impl.isRecordingActive}get recordings(){return this._sendFeatureUsage("recordings",Rh.getter),this._impl.recordings}on(g,m){if("isLocalRecordingActiveChanged"!==g&&"localRecordingsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.RECORDING.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){if("isLocalRecordingActiveChanged"!==g&&"localRecordingsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.RECORDING.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._sendFeatureUsage(g,Rh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m,S){let v=S?{code:S?.code||F,subCode:S?.subCode||0,failureReason:S?.message||""}:void 0;sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"LocalRecording",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:v},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class LocalRecordingCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._localRecordingInitiators=new Map,this._sendEvents=(g,m,S)=>{let v=!!g&&g.length>0,C=!!m&&m.length>0;(v||C)&&this._eventEmitter.emit("localRecordingsUpdated",{added:g,removed:m}),S&&this._eventEmitter.emit("isLocalRecordingActiveChanged")},this._isEnabled=getAcsEcsConfig().calling.localRecording.enabled,this._supportedConversationTypes=getAcsEcsConfig().calling.localRecording.supportedConversationTypes}get isRecordingActive(){return this._localRecordingInitiators.size>0}get recordings(){return Array.from(this._localRecordingInitiators.values())}initialize(g,m,S){if(this._logger=S.createChild((()=>`LocalRecordingFeature::Call(id='${g.callId}', state='${g.state}')`)),!this._isEnabled){const g="Local Recording feature is is disabled",m=new CallingCommunicationError({defaultError:D.FEATURES.LOCAL_RECORDING.DISABLED});throw this._logger.error(g),m}g.on("callStateChanged",(async()=>{if(3===g.state){if(!this._supportedConversationTypes.includes(g.conversationType)){const g="Local Recording feature is only available in meetings",m=new CallingCommunicationError({defaultError:D.FEATURES.LOCAL_RECORDING.ONLY_AVAILABLE_IN_MEETINGS});throw this._logger.error(g),m}this.initLocalRecordingStatus(g)}})),g.on("participantUpdated",(m=>this._onParticipantUpdatedEvent(g,m,m.endpoints?.endpointDetails)))}dispose(){let g=this._localRecordingInitiators.size>0,m=Array.from(this._localRecordingInitiators.values());m.forEach((g=>g?.dispose())),g&&(g=0==this._localRecordingInitiators.size),this._sendEvents(void 0,m,g)}hasOngoingLocalRecording(g){return g?.some((g=>(g.propertyBag?.localRecording?.value?.state||"")===mg.ACTIVE))||!1}initLocalRecordingStatus(g){const{participants:m}=g,S=[...m];this._localRecordingInitiators=new Map(S.filter((g=>this.hasOngoingLocalRecording(g.endpoints?.endpointDetails))).map((g=>[g.id,this._getLocalRecordingInfo(g)])))}_onParticipantUpdatedEvent(g,m,S){m?isCallingApplication(m.id)||(this.hasOngoingLocalRecording(S)?this._tryAddLocalRecordingInitiator(g,m):this._tryRemoveLocalRecordingInitiator(g,m)):this._logger.error(`Empty participant, skip update event processing. CallId: ${g.callId}`)}_tryAddLocalRecordingInitiator(g,m){const{callId:S}=g;if(!this._localRecordingInitiators.has(m.id)){this._logger.info(`Add local recording participant: ${m.id}, callId: ${S}`);let g=this._getLocalRecordingInfo(m);this._localRecordingInitiators.set(m.id,g),this._sendEvents([g],void 0,1==this._localRecordingInitiators.size)}}_tryRemoveLocalRecordingInitiator(g,m){const{callId:S}=g;if(this._localRecordingInitiators.has(m.id)){this._logger.info(`Remove local recording participant: ${m.id}, callId: ${S}`);let g=this._localRecordingInitiators.get(m.id);g.update(mg.INACTIVE),this._localRecordingInitiators.delete(m.id),this._sendEvents(void 0,[g],0==this._localRecordingInitiators.size)}}_getLocalRecordingInfo(g){let m=g.displayName;return new LocalRecordingInfoImpl(mg.ACTIVE,m)}}class LocalRecordingInfoImpl{constructor(g,m){this.state=this.getRecordingState(g),this.displayName=m}update(g){let m=this.getRecordingState(g);return m!=this.state&&(this.state=m,!0)}dispose(){this.state=g.LocalRecordingState.Ended}getRecordingState(m){let S=g.LocalRecordingState.None;switch(m?.toLocaleLowerCase()){case"active":S=g.LocalRecordingState.Started;break;case"inactive":S=g.LocalRecordingState.Ended;break;default:S=g.LocalRecordingState.None}return S}}class TranscriptionCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new TranscriptionCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Rh.getter),"Transcription"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Rh.initialize)}get isTranscriptionActive(){return this._sendFeatureUsage("isTranscriptionActive",Rh.getter),this._impl.isTranscriptionActive}on(g,m){this._sendFeatureUsage("isTranscriptionActiveChanged",Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage("isTranscriptionActiveChanged",Rh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Transcription",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class TranscriptionCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._botChangedSubs=new Map,this._isTranscriptionActive=!1,this._updateIsTranscriptionActive=g=>{this._isTranscriptionActive!==g&&(this._isTranscriptionActive=g,this._logger.info(`Updating isTranscriptionActive to ${g}`),this._eventEmitter.emit("isTranscriptionActiveChanged"))},this._isCallingApplication=g=>isCallingApplication(g.id),this._handleBotRemoved=g=>{this._botChangedSubs.get(g)?.dispose(),this._botChangedSubs.delete(g),this._checkIfAbotIsTranscribing()},this._handleBotAdded=g=>{this._botChangedSubs.set(g,g.changed(this._checkIfAbotIsTranscribing)),this._checkIfAbotIsTranscribing()},this._checkIfAbotIsTranscribing=()=>{try{Array.from(this._botChangedSubs.keys()).find((g=>g.endpoints?.endpointDetails?.find((g=>"Active"===g?.endpointMetadata?.processingModes?.realTimeTranscript?.state))))?this._updateIsTranscriptionActive(!0):this._updateIsTranscriptionActive(!1)}catch(g){this._logger.warn("Unable to read transcription state: ",g)}}}get isTranscriptionActive(){return this._isTranscriptionActive}initialize(g,m,S){this._logger=S.createChild((()=>`TranscriptionFeature::Call(id='${g.callId}', state='${g.state}')`)),g.on("participantAdded",(g=>{this._isCallingApplication(g)&&this._handleBotAdded(g)})),g.participants.forEach((g=>{this._isCallingApplication(g)&&this._handleBotAdded(g)})),g.on("participantRemoved",(g=>{this._isCallingApplication(g)&&this._handleBotRemoved(g)}))}dispose(){this._updateIsTranscriptionActive(!1),this._botChangedSubs.forEach(((g,m)=>g.dispose())),this._botChangedSubs.clear()}}class TransferImpl{get state(){return this._state}get error(){return this._error}constructor(g,m,S=!0){return this._eventEmitter=new Su.EventEmitter,this._lastTsTransferState=0,this._getTransferEndReason=(g,m=0)=>{let S=m,v=0,C=g||"Unknown";this._tsCall&&(S=this._tsCall.transferDiagnosticsInfo&&this._tsCall.transferDiagnosticsInfo.callControllerCode||m,v=this._tsCall.transferDiagnosticsInfo&&this._tsCall.transferDiagnosticsInfo?.callControllerSubCode||0,C=convertTerminatedReasonToString(this._tsCall.terminatedReason));const _={code:S,subCode:v};return this._logger[0===S?"info":"error"](`Transfer end reason=${C}, code=${S}, subCode=${v}`),_},this._state="None",this._logger=m.createChild((()=>"Transfer")),this._logger.log("created"),this._tsCall=g,S?4!==g.state?(this._logger.error("Transfer end reason= call must be on hold before transfer"),this._error={code:k},void this.setTransferState(4)):(this._lastTsTransferState=this._tsCall.transferState,this.setTransferState(this._tsCall.transferState),void this._tsCall.changed((()=>{this._tsCall.transferState!==this._lastTsTransferState&&(this._logger.log(`tsCall transfer state changed=${this._tsCall.transferState}`),this._lastTsTransferState=this._tsCall.transferState,this.setTransferState(this._tsCall.transferState))}))):(this._logger.error("Transfer end reason= call was not found with this callId"),this._error={code:k},void this.setTransferState(4))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}setTransferState(g){let m,S;const v={0:"None",1:"Transferring",2:"Transferring",3:"Transferred",4:"Failed"};v[g]?(m=v[g],"Failed"===m&&(S=this._getTransferEndReason(),this._error=S),this._logger.log(`Mapped ts transfer state:[${g}] to [${m}]`),this._setTransferState(m)):this._logger.warn(`unable to map tsCall state=[${g}] to transfer state`)}_setTransferState(g){g!==this._state&&(this._logger.log(`transfer state changed [${this._state}]=>[${this.state}]`),this._state=g,this._eventEmitter.emit("stateChanged"))}}var __decorate$2=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$2=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class TransferCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new TransferCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Rh.getter),"Transfer"}transfer(g,m){return this._impl.transfer(g,m)}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Rh.initialize)}on(g,m){this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Transfer",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class TransferCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._autoAccept=getAcsEcsConfig().calling.transfer.autoAccept}initialize(g,m,S,v){this._logger=v.createChild((()=>`TransferFeature::Call(id='${g.callId}', state='${g.state}')`)),this._telemetryLogManager=S,this._tsCall=g,this._callAgent=m,g.on("transferRequested",(g=>{const m=this.getTransferRequestPayload(g);if(this._autoAccept){const g=m.accept();this._eventEmitter.emit("transferAccepted",{targetCall:g})}}))}transfer(g,m){let S="safe";if(g.targetCallId&&(S="consultative"),this._sendFeatureUsage(S,Rh.attempt),!this.isTransferable(this._tsCall))throw this._sendFeatureUsage(S,Rh.failure),new CallingCommunicationError({defaultError:D.FEATURES.TRANSFER.UNSUPPORTED_CALL_TYPE});try{let v;switch(S){case"safe":return v=this.transferToParticipant(g.targetParticipant,m),this._sendFeatureUsage(S,Rh.success),v;case"consultative":return v=this.transferToCall(g.targetCallId,m),this._sendFeatureUsage(S,Rh.success),v}}catch(g){if(this._sendFeatureUsage(S,Rh.failure),g instanceof CallingCommunicationError)throw g}throw this._sendFeatureUsage(S,Rh.failure),new CallingCommunicationError({defaultError:D.FEATURES.TRANSFER.TARGET_NOT_RECOGNIZED})}getTransferRequestPayload(g){const m=constructIdentifierKindFromMri(g.transferContext.targetMri);if("communicationUser"===m.kind||"phoneNumber"===m.kind||"microsoftTeamsUser"===m.kind||"unknown"===m.kind||"microsoftTeamsApp"===m.kind){let m=!1;const S={accept:()=>{let S;try{if(S=this._callAgent.createTransferTargetCall(g.transferContext),m)return this._logger.info("Transfer accept was called when transfer action is already in progress."),S;m=!0;const v={threadId:"",messageId:void 0,transferContext:g.transferContext,mediaPeerType:0};S.startCallInternal(void 0,!1,void 0,v).catch((S=>{m=!1,g.onCompleted(7),this._logger.error("Transfer to target failed at call start")}));const callReplacementCallBack=()=>{if(m)switch(S.state){case"Connected":m=!1,g.onCompleted(1),this._logger.info("Transfer Completed"),S.off("stateChanged",(()=>{}));break;case"Disconnected":m=!1,g.onCompleted(7),this._logger.info(`Transfer call disconnected. \n                                            code = ${S.callEndReason?.code} \n                                            subcode = ${S.callEndReason?.subCode} \n                                            message = ${S.callEndReason?.message} \n                                            result categories = ${S.callEndReason?.resultCategories}`),S.off("stateChanged",(()=>{}))}};return S.on("stateChanged",callReplacementCallBack),S}catch(S){throw m=!1,g.onCompleted(7),this._logger.error("Transfer to target failed at call create"),new CallingCommunicationError({defaultError:D.FEATURES.TRANSFER.TRANSFER_TO_TARGET_FAILED,originalError:S})}}};return S}throw new CallingCommunicationError({defaultError:D.FEATURES.TRANSFER.INVALID_TARGET_TYPE,defaultErrorMessageArgs:[m]})}isTransferable(g){return 1===g.callType||g.participants.filter((g=>!isCallingApplication(g.id))).length<=2}transferToParticipant(g,m){let S=getMriFromIdentifier(g);4===this._tsCall.state&&this._tsCall.callSafeTransfer(S,void 0,m);return new TransferImpl(this._tsCall,this._logger)}transferToCall(g,m){const S=this._callAgent.getCallByCallId(g);if(S&&!this.isTransferable(S))throw new CallingCommunicationError({defaultError:D.FEATURES.TRANSFER.UNSUPPORTED_CALL_TYPE});S&&4===this._tsCall.state&&this._tsCall.callConsultativeTransfer(S,void 0,void 0,m);return new TransferImpl(this._tsCall,this._logger,!!S)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Transfer",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){}}__decorate$2([syncOperation(_u.Transfer),__metadata$2("design:type",Function),__metadata$2("design:paramtypes",[Object,Object]),__metadata$2("design:returntype",Object)],TransferCallImplOverTsCall.prototype,"transfer",null);class VideoDeviceInfoImpl{constructor(g,m,S,v){this._name=g,this._id=m,this._deviceType=S,this._deviceManager=v}get name(){return this._name}setName(g){this._name=g}get id(){return this._id}setId(g){this._id=g}get deviceType(){return this._deviceType}setDeviceType(g){this._deviceType=g}get deviceManager(){return this._deviceManager}}function loggerProperty(g,m){Reflect.defineMetadata(B,m,g)}function Deque(g){if(this._capacity=getCapacity(g),this._length=0,this._front=0,fg(g)){for(var m=g.length,S=0;S<m;++S)this[S]=g[S];this._length=m}}Deque.prototype.toArray=function Deque$toArray(){for(var g=this._length,m=new Array(g),S=this._front,v=this._capacity,C=0;C<g;++C)m[C]=this[S+C&v-1];return m},Deque.prototype.push=function Deque$push(g){var m=arguments.length,S=this._length;if(m>1){var v=this._capacity;if(S+m>v){for(var C=0;C<m;++C){this._checkCapacity(S+1),this[_=this._front+S&this._capacity-1]=arguments[C],S++,this._length=S}return S}for(var _=this._front,C=0;C<m;++C)this[_+S&v-1]=arguments[C],_++;return this._length=S+m,S+m}return 0===m?S:(this._checkCapacity(S+1),this[C=this._front+S&this._capacity-1]=g,this._length=S+1,S+1)},Deque.prototype.pop=function Deque$pop(){var g=this._length;if(0!==g){var m=this._front+g-1&this._capacity-1,S=this[m];return this[m]=void 0,this._length=g-1,S}},Deque.prototype.shift=function Deque$shift(){var g=this._length;if(0!==g){var m=this._front,S=this[m];return this[m]=void 0,this._front=m+1&this._capacity-1,this._length=g-1,S}},Deque.prototype.unshift=function Deque$unshift(g){var m=this._length,S=arguments.length;if(S>1){if(m+S>(C=this._capacity)){for(var v=S-1;v>=0;v--){this._checkCapacity(m+1);var C=this._capacity;this[E=(this._front-1&C-1^C)-C]=arguments[v],m++,this._length=m,this._front=E}return m}var _=this._front;for(v=S-1;v>=0;v--){var E;this[E=(_-1&C-1^C)-C]=arguments[v],_=E}return this._front=_,this._length=m+S,m+S}if(0===S)return m;this._checkCapacity(m+1);C=this._capacity;return this[v=(this._front-1&C-1^C)-C]=g,this._length=m+1,this._front=v,m+1},Deque.prototype.peekBack=function Deque$peekBack(){var g=this._length;if(0!==g)return this[this._front+g-1&this._capacity-1]},Deque.prototype.peekFront=function Deque$peekFront(){if(0!==this._length)return this[this._front]},Deque.prototype.get=function Deque$get(g){var m=g;if(m===(0|m)){var S=this._length;if(m<0&&(m+=S),!(m<0||m>=S))return this[this._front+m&this._capacity-1]}},Deque.prototype.isEmpty=function Deque$isEmpty(){return 0===this._length},Deque.prototype.clear=function Deque$clear(){for(var g=this._length,m=this._front,S=this._capacity,v=0;v<g;++v)this[m+v&S-1]=void 0;this._length=0,this._front=0},Deque.prototype.toString=function Deque$toString(){return this.toArray().toString()},Deque.prototype.valueOf=Deque.prototype.toString,Deque.prototype.removeFront=Deque.prototype.shift,Deque.prototype.removeBack=Deque.prototype.pop,Deque.prototype.insertFront=Deque.prototype.unshift,Deque.prototype.insertBack=Deque.prototype.push,Deque.prototype.enqueue=Deque.prototype.push,Deque.prototype.dequeue=Deque.prototype.shift,Deque.prototype.toJSON=Deque.prototype.toArray,Object.defineProperty(Deque.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),Deque.prototype._checkCapacity=function Deque$_checkCapacity(g){this._capacity<g&&this._resizeTo(getCapacity(1.5*this._capacity+16))},Deque.prototype._resizeTo=function Deque$_resizeTo(g){var m=this._capacity;this._capacity=g;var S=this._front,v=this._length;S+v>m&&arrayMove(this,0,this,m,S+v&m-1)};var fg=Array.isArray;function arrayMove(g,m,S,v,C){for(var _=0;_<C;++_)S[_+v]=g[_+m],g[_+m]=void 0}function pow2AtLeast(g){return g>>>=0,g-=1,g|=g>>1,g|=g>>2,g|=g>>4,g|=g>>8,(g|=g>>16)+1}function getCapacity(g){if("number"!=typeof g){if(!fg(g))return 16;g=g.length}return pow2AtLeast(Math.min(Math.max(16,g),1073741824))}var Sg=Deque;class DefaultLogger{static overrideDefaultLogDump(){if(DefaultLogger.logDump.isEmpty())DefaultLogger.logDump=new Sg(getAcsEcsConfig()?.debugInfo?.maxLogDumpLength);else{let g=new Sg(getAcsEcsConfig()?.debugInfo?.maxLogDumpLength);for(;DefaultLogger.logDump.length>0;){const m=DefaultLogger.logDump.shift();m&&g.push(m)}DefaultLogger.logDump=g}}constructor(g,m=[],S=DefaultLogger.defaultLogRedirect){this._azureLogger=g,this._namespace=m,this._logRedirectCallback=S}createChild(g){return new DefaultLogger(this._azureLogger,[...this._namespace,"string"==typeof g?()=>g:g])}createFnLogger(g,m,...S){return this.createChild(this.getPrefix(g,m)+S.join(""))}log(...g){const m=this.getMessage(g);this._azureLogger.verbose(m),this._logRedirectCallback(`log:${m}`)}debug(...g){const m=this.getMessage(g);this._azureLogger.verbose(m),this._logRedirectCallback(`debug:${m}`)}info(...g){const m=this.getMessage(g);this._azureLogger.info(m),this._logRedirectCallback(`info:${m}`)}warn(...g){const m=this.getMessage(g);this._azureLogger.warning(m),this._logRedirectCallback(`warn:${m}`)}error(...g){const m=this.getMessage(g);this._azureLogger.error(this.getMessage(g)),this._logRedirectCallback(`error::${m}`)}getMessage(...g){return`${getDateInIsoFormat()} ${this.getNamespace()} ${g.join(" ")}`}getNamespace(){return this._namespace.map((g=>g())).join(":")}getPrefix(g,m){let S="";return m&&(S+=m),g&&(S+=g),S}redirectLog(g){this._logRedirectCallback=m=>{DefaultLogger.defaultLogRedirect(m),g(m)}}dumpAllLogs(){return[...DefaultLogger.logDump.toArray()]}}DefaultLogger.logDump=new Sg(Oa),DefaultLogger.defaultLogRedirect=g=>{if(getAcsEcsConfig()?.debugInfo?.enableLogDump){const sizeCheck=()=>{DefaultLogger.logDump.length>getAcsEcsConfig()?.debugInfo?.maxLogDumpLength&&DefaultLogger.logDump.shift()};if(getAcsEcsConfig()?.debugInfo?.includeList.some((m=>P.includes(g,m))))return DefaultLogger.logDump.push(g),void sizeCheck();if(!getAcsEcsConfig()?.debugInfo?.excludeList.some((m=>P.includes(g,m))))return DefaultLogger.logDump.push(g),void sizeCheck()}};var __decorate$3=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$3=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class StreamTelemetryEventSender{constructor(g){this._telemetryLogManager=g}sendMediaStreamEvent(g){this._telemetryLogManager?.sendEvent({name:Ah.acs_calling_media_stream,tenant:Qa,properties:{correlationId:g.correlationId,mediaType:g.mediaType,operation:g.operation,timestampInfo:g.timestampInfo,streamType:g.streamType||lu.Local,additionalDetails:g.additionalDetails||"",kindOfEvent:g.kindOfEvent||"",callId:g.callId||"",localPaticipantId:g.localParticipantId||""}})}}__decorate$3([loggerProperty,__metadata$3("design:type",Object)],StreamTelemetryEventSender.prototype,"logger",void 0);var vg,__decorate$4=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$4=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LocalVideoStream{constructor(g){if(this._disposed=!1,this._call=new Set,this._canStartEffects=!1,this.kind="LocalVideoStream",this._renderers=[],this._disposeRenderer=g=>{this.logger.log("disposing renderer");try{g.dispose(),this.logger.log("renderer disposed")}catch(g){this.logger.log("failed to dispose renderer")}},!(g instanceof VideoDeviceInfoImpl||g instanceof MediaStream))throw new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.WRONG_STREAM_TYPE});const S=m.createClientLogger("ACS-calling");this.logger=new DefaultLogger(S,[()=>`LocalVideoStream:${g.id}`]),this.logger.info("created"),this._eventEmitter=new CallingEventEmitter(this.logger),this.setSource(g),this._localStreamTelemetryEventSender=new StreamTelemetryEventSender(this._telemetryLogManager)}on(g,m){if("videoSourceChanged"!==g)throw new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("videoSourceChanged"!==g)throw new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}get source(){return this._source}get mediaStreamType(){return this._mediaStreamType}get telemetryLogManager(){return this._telemetryLogManager}get callStackWebCVProvider(){return this.source?.deviceManager?.callStackWebCvProvider??null}get callStackEffectsStatusManager(){return this.source?.deviceManager?.callStackVideoEffectsStatusManager??null}get canStartEffects(){return this._canStartEffects}async switchSource(g){const m=this.logger.createFnLogger(Jh.SwitchSource),S=+new Date,v=generateGuid(),C={timestampInfo:{attemptTimestamp:S},correlationId:v,operation:cu.switchSource,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",kindOfEvent:Rh.attempt,mediaType:ou.Video,streamType:lu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(C),!(g instanceof VideoDeviceInfoImpl)){const g=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.SWITCH_SOURCE_WRONG_TYPE}),m={correlationId:v,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.switchSource,additionalDetails:{failureReason:g.message,code:L,...extractCommunicationServicesErrorForTelemetry(g)},timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,mediaType:ou.Video,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(m),g}if(this._source===g){const g=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.SWITCH_SAME_SOURCE}),m={correlationId:v,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.switchSource,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,mediaType:ou.Video,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(m),g}try{if("RawMedia"===this._mediaStreamType){Array.from(this._call.values()).some((g=>g.localVideoStream===this))&&g.deviceManager.getTsDeviceManager().unsetRawMediaStream?.(1)}g.deviceManager.getTsDeviceManager().selectDevices({camera:g.id}),this.setSource(g);const m={correlationId:v,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:ou.Video,operation:cu.switchSource,timestampInfo:{deltaTimeInMs:+new Date-S},streamType:lu.Local,kindOfEvent:Rh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(m)}catch(g){const C=handleVideoOperationFailure(m,g),_={correlationId:v,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.switchSource,additionalDetails:{failureReason:C.message,code:L,...extractCommunicationServicesErrorForTelemetry(C)},timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,mediaType:ou.Video,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(_),C}}dispose(){this.logger.log("Disposing LocalVideoStream."),this._disposed?this.logger.log("already disposed"):(this.disposeRawStream(),this._renderers.forEach((g=>this._disposeRenderer(g))),this._renderers=[],this._disposed=!0)}async getMediaStream(){const g=generateGuid();let m=+new Date;const S={correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",timestampInfo:{attemptTimestamp:m},operation:cu.getMediaStream,kindOfEvent:Rh.attempt,mediaType:ou.VideoRaw,streamType:lu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),this.subscribeToRawStreamChangedIfNeeded(),this._mediaStreamSource){const S={correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:ou.VideoRaw,operation:cu.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:lu.Local,kindOfEvent:Rh.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),new MediaStream(this._mediaStreamSource.clone())}try{let S;if("ScreenSharing"===this._source.deviceType?S=2:"UsbCamera"!==this._source.deviceType&&"CaptureAdapter"!==this._source.deviceType&&"Virtual"!==this._source.deviceType||(S=1),!S)throw new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.CANT_GET_DEVICE_TYPE});this._rawStream||(this._rawStream=this.source.deviceManager.getRawDeviceMediaStream(S));const v={correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:ou.VideoRaw,operation:cu.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:lu.Local,kindOfEvent:Rh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(v);const C=await(this._rawStream?.getMediaStream());return new MediaStream(C.clone())}catch(S){const v=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.GET_MEDIA_STREAM,originalError:S}),C={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.getMediaStream,additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v)},kindOfEvent:Rh.failure,mediaType:ou.VideoRaw,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(C),v}}async setMediaStream(g){const m=generateGuid();let S,v=+new Date,C=!1,_=!1,E=ou.VideoRawOrScreenSharingRaw;for(let g of this._call){const m=g;if(m.localScreenSharingStream===this||m.localVideoStream===this){S=m.deviceManager,_=!0,m.localVideoStream===this?(C=!0,E=ou.VideoRaw):m.localScreenSharingStream===this&&(C=!1,E=ou.ScreenSharingRaw);break}}const T={timestampInfo:{attemptTimestamp:v},correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.setMediaStream,kindOfEvent:Rh.attempt,mediaType:E,streamType:lu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(T),!(g instanceof MediaStream)){const g=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM_WRONG_TYPE}),S={timestampInfo:{deltaTimeInMs:+new Date-v},correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.setMediaStream,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},kindOfEvent:Rh.failure,mediaType:E,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),g}if(this.setSource(g),getAcsEcsConfig()?.calling?.allowAccessRawMediaStream)try{if(_){const m=S?.getTsDeviceManager();if(!m?.setRawMediaStream)throw new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM_UNDEFINED_FUNC});C?m.setRawMediaStream(g,1):m.setRawMediaStream(g,2)}this._renderers.forEach((m=>{m.setSourceObject(g)}));const T={timestampInfo:{deltaTimeInMs:+new Date-v},correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.setMediaStream,kindOfEvent:Rh.success,mediaType:E,streamType:lu.Local};this._localStreamTelemetryEventSender.sendMediaStreamEvent(T)}catch(g){const S=new CallingCommunicationError({defaultError:D.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM,originalError:g}),C={correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:cu.setMediaStream,additionalDetails:{failureReason:S.message,code:S.code,...extractCommunicationServicesErrorForTelemetry(S)},timestampInfo:{deltaTimeInMs:+new Date-v},kindOfEvent:Rh.failure,mediaType:E,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(C),S}}addCall(g){this._call.add(g)}removeCall(g){this._call.delete(g)}feature(g){return this._extensibleApi||(this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{streamInstance:this},{streamInstance:this,telemetryLogManager:this.telemetryLogManager})),this._extensibleApi.getApiObjectInstance(g.videoStreamApiCtor)}registerRenderer(g){this._renderers.push(g)}unregisterRenderer(g){const m=this._renderers.indexOf(g);-1!==m&&this._renderers.splice(m,1)}getStreamMetadata(){let g,m,S=this.getCall();this._source instanceof VideoDeviceInfoImpl?(g=this.source.deviceManager,m=this.source.deviceType):this._mediaStreamSource instanceof MediaStream&&S&&(g=S.deviceManager);let v=-1;return S&&("Video"===this._mediaStreamType||"RawMedia"===this.mediaStreamType&&S.localVideoStream===this?v=S.tsCall.mediaStreams[0][0]?.id||-1:("ScreenSharing"===this._mediaStreamType||"RawMedia"===this.mediaStreamType&&S.localScreenSharingStream===this)&&(v=S.tsCall.mediaStreams[1][0]?.id||-1)),{source:"local",sourceId:v,streamType:this.mediaStreamType,deviceType:m||"",callId:S?.id||"",localParticipantId:S?.tsCall.participantId||"",deviceManagerPermissionState:g?JSON.stringify({cameraPermission:g.getVideoDevicePermission(),microphonePermission:g.getAudioDevicePermission()}):"",acsResourceId:g?.getAcsResourceId()||"",clientId:g?.getClientId()||""}}getLocalParticipantId(){let g="";const m=this.getCall();return m&&(g=m.tsCall.participantId),g}getCall(){for(const g of this._call)if(g.localVideoStreams.includes(this))return g}setSource(g){if(g instanceof VideoDeviceInfoImpl)this._telemetryLogManager=g.deviceManager.telemetryLogManager,this._source=g,this._mediaStreamType="ScreenSharing"===g.deviceType?"ScreenSharing":"Video",this._mediaStreamSource=void 0,this._rawStream=void 0,this._canStartEffects=!0;else{try{1===globalThis[To]&&(this._telemetryLogManager=globalThis[Eo])}catch(g){this.logger.error("Failed to retrive telemetry logger for localVideoStream")}this._source={name:"CustomMediaStream",id:generateGuid(),deviceType:"Virtual"},this._mediaStreamSource=g,this._mediaStreamType="RawMedia",this._canStartEffects=!1}this._eventEmitter.emit("videoSourceChanged",{source:this})}subscribeToRawStreamChangedIfNeeded(){this._source instanceof VideoDeviceInfoImpl&&!this._videoSourceChangedSub&&(this._videoSourceChangedSub=this._rawStream?.changed((()=>{this._eventEmitter.emit("videoSourceChanged",{source:this})})))}disposeRawStream(){this._rawStream&&this._rawStream.dispose(),this._videoSourceChangedSub?.dispose(),this._videoSourceChangedSub=void 0}}__decorate$4([loggerProperty,__metadata$4("design:type",Object)],LocalVideoStream.prototype,"logger",void 0),__decorate$4([asyncOperation(Jh.SwitchSource),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[Object]),__metadata$4("design:returntype",Promise)],LocalVideoStream.prototype,"switchSource",null),__decorate$4([asyncOperation(Jh.GetMediaStream),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[]),__metadata$4("design:returntype",Promise)],LocalVideoStream.prototype,"getMediaStream",null),__decorate$4([asyncOperation(Jh.SetMediaStream),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[MediaStream]),__metadata$4("design:returntype",Promise)],LocalVideoStream.prototype,"setMediaStream",null),__decorate$4([syncOperation(Jh.Feature),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[Object]),__metadata$4("design:returntype","function"==typeof(vg="undefined"!=typeof TFeature&&TFeature)?vg:Object)],LocalVideoStream.prototype,"feature",null);class AudioDeviceInfoImpl{constructor(g,m,S,v,C){this._name=g,this._id=m,this._isSystemDefault=S,this._deviceType=v,this._deviceManager=C}get name(){return this._name}setName(g){this._name=g}get id(){return this._id}setId(g){this._id=g}get isSystemDefault(){return this._isSystemDefault}setIsSystemDefault(g){this._isSystemDefault=g}get deviceType(){return this._deviceType}setDeviceType(g){this._deviceType=g}get deviceManager(){return this._deviceManager}}var __decorate$5=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$5=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class VolumeImpl{constructor(g,m,S,v,C){this._workQueue=Promise.resolve(),this.logger=g.createChild("volume indicator"),this._eventEmitter=new CallingEventEmitter(this.logger,{enableLogEmit:!1}),this._isInitialized=!1,this._level=0,this._streamType=m,this._callId=v,this._localParticipantId=C,this._telemetryLogManager=S}get isInitialized(){return this._isInitialized}initialize(g){if(void 0===g)throw this.logger.error("failed to getMediaStreamTrack"),new CallingCommunicationError({defaultError:D.CALL.VOLUME_TRACK});const m=generateGuid(),S=+new Date;try{this.sendVolumeEvent({eventName:Ah.acs_calling_audio_stream_volume,correlationId:m,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),this.bindToAudioStreamVolume(g),this.sendVolumeEvent({eventName:Ah.acs_calling_audio_stream_volume,correlationId:m,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-S},additionalDetails:""})}catch(g){const v=new CallingCommunicationError({defaultError:D.CALL.VOLUME_INIT,originalError:g});throw this.logger.error(v.message),this.sendVolumeEvent({eventName:Ah.acs_calling_audio_stream_volume,correlationId:m,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-S},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)}}),v}}bindToAudioStreamVolume(g){let[m,S]=this.setupVolumeCalculator(g);this._level=m();let v=setInterval((()=>{let g=m();g!==this._level&&(this._level=g,this._eventEmitter.emit("levelChanged"))}),getAcsEcsConfig()?.volumeIndicator?.microphoneVolumeSampleIntervalMs);this._volumeCallBackInterval=v,this._audioContext=S}setupVolumeCalculator(g){const m=new MediaStream(g),S=new AudioContext,v=S.createMediaStreamSource(m),C=S.createAnalyser();v.connect(C),C.fftSize=getAcsEcsConfig().volumeIndicator.fftSize,C.minDecibels=getAcsEcsConfig().volumeIndicator.minDecibels,C.maxDecibels=getAcsEcsConfig().volumeIndicator.maxDecibels,C.smoothingTimeConstant=getAcsEcsConfig().volumeIndicator.smoothingConstant;const _=new Uint8Array(C.frequencyBinCount);return[()=>{try{C.getByteFrequencyData(_);let g=0;for(const m of _)g+=m;const m=g/_.length;return m*getAcsEcsConfig().volumeIndicator.normalisedMaxVolume/getAcsEcsConfig().volumeIndicator.maxAvailableVolume}catch(g){return this.logger.error("error in calculating audio stream volume"),0}},S]}dispose(){this._isInitialized=!1;try{this._audioContext?.close().catch((g=>{this.logger.error("unable to close AudioContext")}))}catch(g){this.logger.error("unable to close MicrophoneAudioContext")}this._volumeCallBackInterval&&clearInterval(this._volumeCallBackInterval)}on(g,m){if("levelChanged"!==g)throw new CallingCommunicationError({defaultError:D.CALL.VOLUME_EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("levelChanged"!==g)throw new CallingCommunicationError({defaultError:D.CALL.VOLUME_EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});"levelChanged"===g&&1===this._eventEmitter.listenerCount("levelChanged")&&this.dispose()}get level(){return this._level}getVolumeIndicator(g){const executeSerialisedAsync=()=>{if(!this.isInitialized)try{this.initialize(g),this._isInitialized=!0}catch(g){const m=new CallingCommunicationError({defaultError:D.CALL.VOLUME_GET,originalError:g});throw this.logger.error(m.message),m}return this},m=this._workQueue.then((()=>executeSerialisedAsync()));return this._workQueue=m.then(noop,noop),m}sendVolumeEvent(g){try{this._telemetryLogManager?.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send screen share telemetry")}}}__decorate$5([loggerProperty,__metadata$5("design:type",Object)],VolumeImpl.prototype,"logger",void 0);var Cg,_g,yg,__decorate$6=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$6=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LocalAudioStream{constructor(g){this.canStartEffects=!1;const S=m.createClientLogger("ACS-calling");if(this.logger=new DefaultLogger(S,[()=>`LocalAudioStream for default device with source: ${!!g}`]),this._eventEmitter=new CallingEventEmitter(this.logger),!(g instanceof AudioDeviceInfoImpl||g instanceof MediaStream))throw new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.WRONG_STREAM_TYPE});if(g instanceof AudioDeviceInfoImpl&&"Microphone"!==g.deviceType)throw new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.SOURCE_WRONG_TYPE});g instanceof AudioDeviceInfoImpl?(this._source=g,this._mediaStreamType="Audio",this.canStartEffects=!0):(this._source={name:"CustomMediaStream",id:generateGuid(),deviceType:"Virtual",isSystemDefault:!1},this._mediaStreamSource=g,this._mediaStreamType="RawMedia",this.canStartEffects=!1),this._disposed=!1;try{1===globalThis[To]&&(this._telemetryLogManager=globalThis[Eo])}catch(g){this.logger.error("Failed to retrive telemetry logger for localAudioStream")}g instanceof AudioDeviceInfoImpl&&(this._telemetryLogManager=g.deviceManager.telemetryLogManager),this._localStreamTelemetryEventSender=new StreamTelemetryEventSender(this._telemetryLogManager),this._volumeIndicator=new VolumeImpl(this.logger,"LocalAudioStream",this._telemetryLogManager),this.logger.info("created")}on(g,m){if("audioSourceChanged"!==g)throw new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("audioSourceChanged"!==g)throw new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}feature(g){return this._extensibleApi||(this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{streamInstance:this},{streamInstance:this,telemetryLogManager:this.telemetryLogManager})),this._extensibleApi.getApiObjectInstance(g.audioStreamApiCtor)}get mediaStreamType(){return this._mediaStreamType}get source(){return this._source}get telemetryLogManager(){return this._telemetryLogManager}get callStackWasmVqeProvider(){return this.source?.deviceManager?.callStackWasmVqeProvider??null}get callStackEffectsStatusManager(){return this.source?.deviceManager?.callStackAudioEffectsStatusManager??null}async getMediaStream(){const g=generateGuid(),m=+new Date,S={timestampInfo:{attemptTimestamp:m},correlationId:g,operation:cu.getMediaStream,kindOfEvent:Rh.attempt,mediaType:ou.AudioRaw,streamType:lu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),this.subscribeToRawStreamChangedIfNeeded(),this._mediaStreamSource){const S={correlationId:g,mediaType:ou.AudioRaw,operation:cu.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:lu.Local,kindOfEvent:Rh.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),this._mediaStreamSource}if(this._source instanceof AudioDeviceInfoImpl)try{this._rawStream=this._source.deviceManager.getRawDeviceMediaStream(0);const S=await(this._rawStream?.getMediaStream()),v={correlationId:g,mediaType:ou.AudioRaw,operation:cu.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:lu.Local,kindOfEvent:Rh.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),S}catch(v){const S=new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.GET_MEDIA_STREAM,originalError:v}),C={correlationId:g,operation:cu.getMediaStream,additionalDetails:{failureReason:S.message,code:S.code,...extractCommunicationServicesErrorForTelemetry(S)},timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Rh.failure,mediaType:ou.AudioRaw,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(C),S}const v=new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.GET_MEDIA_STREAM}),C={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,operation:cu.getMediaStream,additionalDetails:{failureReason:v.message,code:L,...extractCommunicationServicesErrorForTelemetry(v)},kindOfEvent:Rh.failure,mediaType:ou.AudioRaw,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(C),v}async setMediaStream(g){const m=generateGuid();let S=+new Date;const v={timestampInfo:{attemptTimestamp:S},correlationId:m,operation:cu.setMediaStream,kindOfEvent:Rh.attempt,mediaType:ou.AudioRaw,streamType:lu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),!(g instanceof MediaStream)){const g=new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.SET_MEDIA_STREAM_WRONG_TYPE}),v={timestampInfo:{deltaTimeInMs:+new Date-S},correlationId:m,operation:cu.setMediaStream,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},kindOfEvent:Rh.failure,mediaType:ou.AudioRaw,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),g}this.canStartEffects=!1,this._mediaStreamSource=new MediaStream(g.getAudioTracks()),this._eventEmitter.emit("audioSourceChanged",{source:this}),this._volumeIndicator.dispose();const C={correlationId:m,mediaType:ou.AudioRaw,operation:cu.setMediaStream,timestampInfo:{deltaTimeInMs:+new Date-S},streamType:lu.Local,kindOfEvent:Rh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(C)}async switchSource(g){const m=+new Date,S=generateGuid();this.canStartEffects=!0;const v={timestampInfo:{attemptTimestamp:m},correlationId:S,operation:cu.switchSource,kindOfEvent:Rh.attempt,mediaType:ou.Audio,streamType:lu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),g instanceof AudioDeviceInfoImpl&&"Microphone"!==g.deviceType){const g=new CallingCommunicationError({defaultError:D.LOCAL_AUDIO_STREAM.SWITCH_SOURCE_WRONG_TYPE}),v={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:S,operation:cu.switchSource,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},kindOfEvent:Rh.failure,mediaType:ou.Audio,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),g}this._source!==g&&(this._source.deviceManager.selectMicrophone(g),this._eventEmitter.emit("audioSourceChanged",{source:this}),this._volumeIndicator.dispose());const C={correlationId:S,mediaType:ou.Audio,operation:cu.switchSource,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:lu.Local,kindOfEvent:Rh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(C)}dispose(){this.logger.log("LocalAudioStream disposing"),this._disposed?this.logger.log("Already disposed"):(this._disposed=!0,this.disposeRawStream(),this._volumeIndicator.dispose(),this._eventEmitter.removeAllListeners(),this.logger.log("LocalAudioStream disposed"))}async getVolume(){return this._volumeIndicator.isInitialized?this._volumeIndicator:this._volumeIndicator.getVolumeIndicator(await this.getMediaStream())}subscribeToRawStreamChangedIfNeeded(){this._source instanceof AudioDeviceInfoImpl&&!this._audioSourceChangedSub&&(this._audioSourceChangedSub=this._rawStream?.changed((()=>{this._eventEmitter.emit("audioSourceChanged",{source:this}),this._volumeIndicator.dispose()})))}disposeRawStream(){this._audioSourceChangedSub?.dispose(),this._rawStream?.dispose(),this._audioSourceChangedSub=void 0}getStreamMetadata(){const g=this.source.deviceManager;return{source:"local",streamType:this.mediaStreamType,deviceType:this.source.deviceType,deviceManagerPermissionState:JSON.stringify({cameraPermission:g.getVideoDevicePermission(),microphonePermission:g.getAudioDevicePermission()}),acsResourceId:g.getAcsResourceId()||"",clientId:g.getClientId()}}}__decorate$6([loggerProperty,__metadata$6("design:type",Object)],LocalAudioStream.prototype,"logger",void 0),__decorate$6([syncOperation(Yh.Feature),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[Object]),__metadata$6("design:returntype","function"==typeof(Cg="undefined"!=typeof TFeature&&TFeature)?Cg:Object)],LocalAudioStream.prototype,"feature",null),__decorate$6([asyncOperation(Yh.GetMediaStream),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[]),__metadata$6("design:returntype",Promise)],LocalAudioStream.prototype,"getMediaStream",null),__decorate$6([asyncOperation(Yh.SetMediaStream),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[MediaStream]),__metadata$6("design:returntype",Promise)],LocalAudioStream.prototype,"setMediaStream",null),__decorate$6([asyncOperation(Yh.SwitchSource),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[Object]),__metadata$6("design:returntype",Promise)],LocalAudioStream.prototype,"switchSource",null),function(g){g[g.JITTER=0]="JITTER",g[g.RTT=1]="RTT",g[g.PACKETS_LOSS=2]="PACKETS_LOSS",g[g.BIT_RATE=3]="BIT_RATE",g[g.BANDWIDTH=4]="BANDWIDTH"}(_g||(_g={})),function(g){g[g.AUDIO=0]="AUDIO",g[g.VIDEO=1]="VIDEO"}(yg||(yg={}));const Eg="Unknown";var Tg,Ig;function collectMediaStatsForCreateView(g,m,S,v){const C=getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStatsMaxLength,_=getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStatsInitialMaxLength,E=["bitrate","packetsPerSecond","packetsLostPerSecond","jitterInMs","rttInMs","pairRttInMs","healedRatio","lossRate"],T=["bitrate","packetsPerSecond","packetsLostPerSecond","jitterInMs","rttInMs","pairRttInMs","frameRateDecoded","frameRateReceived","frameWidthReceived","frameHeightReceived","longestFreezeDurationInMs","totalFreezeDurationInMs","framesReceived","framesDropped","framesDecoded","keyFramesDecoded"],I=T;if(S.audio.receive.length>0){const v=S.audio.receive[0];g.audio=g.audio??{},m.audio=m.audio??{},E.forEach((S=>{const E=S;if(void 0!==v[E]&&g.audio){const m=v[E];if(void 0===g.audio[E])g.audio[E]=[m];else{const S=g.audio[E]?.length;S>=C&&g.audio[E]?.shift(),g.audio[E]?.push(m)}}if(void 0!==v[E]&&m.audio){const g=v[E];if(void 0===m.audio[E])m.audio[E]=[g];else{const S=m.audio[E]?.length;S<_&&m.audio[E]?.push(g)}}}))}if(S.video.receive.length>0){const E=S.video.receive.find((g=>g.streamId===v));void 0!==E&&(g.video=g.video??{},m.video=m.video??{},T.forEach((S=>{const v=S;if(void 0!==E[v]&&g.video){const m=E[v];if(void 0===g.video[v])g.video[v]=[m];else{const S=g.video[v]?.length;S>=C&&g.video[v]?.shift(),g.video[v]?.push(m)}}if(void 0!==E[v]&&m.video){const g=E[v];if(void 0===m.video[v])m.video[v]=[g];else{const S=m.video[v]?.length;S<_&&m.video[v]?.push(g)}}})))}if(S.screenShare.receive.length>0){const E=S.screenShare.receive.find((g=>g.streamId===v));void 0!==E&&(g.screenShare=g.screenShare??{},m.screenShare=m.screenShare??{},I.forEach((S=>{const v=S;if(void 0!==E[v]&&g.screenShare){const m=E[v];if(void 0===g.screenShare[v])g.screenShare[v]=[m];else{const S=g.screenShare[v]?.length;S>=C&&g.screenShare[v]?.shift(),g.screenShare[v]?.push(m)}}if(void 0!==E[v]&&m.screenShare){const g=E[v];if(void 0===m.screenShare[v])m.screenShare[v]=[g];else{const S=m.screenShare[v]?.length;S<_&&m.screenShare[v]?.push(g)}}})))}}function calculateFirstAverage(g){if(g?.count.length&&g?.count[0]){return getRoundedAverage(g.sum[0],g.count[0])}return NaN}function calculateFirstSum(g){return g?.count.length&&g?.count[0]?g.sum[0]:NaN}!function(g){g.Supported="Supported",g.NotSupported="NotSupported",g.Unknown="Unknown"}(Tg||(Tg={})),function(g){g.CompleteTest="CompleteTest",g.StartTest="StartTest",g.DeviceAccess="DeviceAccess",g.DeviceEnumerations="DeviceEnumerations",g.InCallDiagnostics="InCallDiagnostics",g.BrowserSupport="BrowserSupport"}(Ig||(Ig={}));class PreCallDiagnosticsFeatureImpl extends FirstPartyCallClientFeature{constructor(g){super(g),this._impl=new PreCallDiagnosticsImpl}initialize(g,m){const S=g.callClient;this._logger=m;const v={diagnostics:{tags:["diagnostics"]}},C=S.createInstance(v);this._telemetryLogManager=C.telemetryLogManager,this._impl.intialize(S,C,m,this._telemetryLogManager),this._sendFeatureUsage("initialize",Rh.initialize)}get name(){return this._sendFeatureUsage("name",Rh.getter),"PreCallDiagnostics"}startTest(g,m){return this._impl.startTest(g,m)}_sendFeatureUsage(g,m){sendCallClientFeatureUsageTelemetry({featureName:"PreCallDiagnostics",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Rh.attempt),this.disposed?this._sendFeatureUsage("dispose",Rh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Rh.success))}}class PreCallDiagnosticsImpl{constructor(){this._printableObjectAll=!0,this._completeTestInfo={name:"",succeeded:!0},this._diagnosticsTestRunIds=[],this._callMediaStatistics=defer(),this._inCallDiagnostics={connected:!1,diagnostics:{audio:{jitter:Eg,packetLoss:Eg,rtt:Eg},video:{jitter:Eg,packetLoss:Eg,rtt:Eg}},bandWidth:Eg},this._diagnosticsMediaTelemetry={jitter:{audio:{inbound:0,outbound:0},video:{inbound:0,outbound:0}},rtt:{audio:0,video:0},packets:{audioSent:0,audioSentLost:0,audioReceived:0,audioReceivedLost:0,videoSent:0,videoSentLost:0,videoReceived:0,videoReceivedLost:0},bandWidth:0},this._isCreatingNewCallAgent=!1}intialize(g,m,S,v){this._internalCallClient=m,this._mainCallClient=g,this._logger=S,this._telemetryLogManager=v}async getDevices(g,m){let S=[];try{switch(m){case"Speaker":S=await g.getSpeakers();break;case"Microphone":S=await g.getMicrophones();break;default:S=await g.getCameras()}}catch(g){this._logger.warn("Failed to get speakers")}return S}async startTest(g,m){this._sendFeatureUsage("startTest",Rh.attempt),this._currentTestRunId=generateGuid(),this._diagnosticsTestRunIds.push(this._currentTestRunId),this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Ig.CompleteTest}}),this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Ig.StartTest}});try{this._internalDeviceManager=await this._internalCallClient.getDeviceManager();const g=this._internalCallClient.callAgent,m=await this._mainCallClient.getDeviceManager();g?.tsStack?.getDeviceManager().selectDevices({speaker:m.selectedSpeaker?.id,microphone:m.selectedMicrophone?.id});const S=await this._internalCallClient.getDeviceManager(),v={mic:(await this.getDevices(S,"Microphone")).length,speaker:(await this.getDevices(S,"Speaker")).length};this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.StartTest,!0,`Device selection successful. Result: ${getPrintableObject(v,this._printableObjectAll)}`)})}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.SET_DEVICE_FAIL,originalError:g});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.StartTest,!1,"Device selection failed."),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.warn(g),this._sendFeatureUsage("startTest",Rh.failure),m}try{return this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.StartTest,!0,"StartTest succeeded")}),this._sendFeatureUsage("startTest",Rh.success),m?{deviceAccess:m.deviceAccess?this.deviceAccess():void 0,deviceEnumeration:m.deviceEnumeration?this.deviceEnumeration():void 0,inCallDiagnostics:m.inCallDiagnostics?this.getInCallDiagnostics(g):void 0,browserSupport:m.browserSupport?this.getBrowserSupport():void 0,callMediaStatistics:m.callMediaStatistics?this.getcallMediaStatistics():void 0,id:this._currentTestRunId}:{deviceAccess:this.deviceAccess(),deviceEnumeration:this.deviceEnumeration(),inCallDiagnostics:this.getInCallDiagnostics(g),browserSupport:this.getBrowserSupport(),callMediaStatistics:this.getcallMediaStatistics(),id:this._currentTestRunId}}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.GET_DIAGNOSTICS_INFO,originalError:g});throw this._logger.error(m.message),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.StartTest,!1,"StartTest failed."),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._sendFeatureUsage("startTest",Rh.failure),m}}async getBrowserSupport(){let g;this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Ig.BrowserSupport}});try{const m=await this._mainCallClient.getEnvironmentInfoInternal();g={browser:m.isSupportedBrowser?Tg.Supported:Tg.NotSupported,os:m.isSupportedPlatform?Tg.Supported:Tg.NotSupported},this.updateTestInfo(Ig.BrowserSupport,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Browser support successful. Result: ${getPrintableObject(g,this._printableObjectAll)}`,name:Ig.BrowserSupport}})}catch(m){g={browser:Tg.Unknown,os:Tg.Unknown},this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.BrowserSupport,!1,`Browser support failed. Error: ${getPrintableObject(m)}`)}),this._logger.error(`Browser support failed: ${m}`)}return new Promise((m=>m(g)))}async renderHiddenVideoElement(g,m){let S,v=g.tsCall,C=v.mediaStreams;try{await new Promise(((g,m)=>{S=v.changed((()=>{void 0!==C[0]&&C[0].length>0&&C[0][0].isAvailable&&(g(),S?.dispose(),this.updateTestInfo(Ig.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Call mediaStreams successful.",name:Ig.InCallDiagnostics}}))})),setTimeout((()=>{this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.InCallDiagnostics,!1,"Call mediaStreams failed. Error: Timeout")}),m(new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.VIDEO_STREAM_TIMEOUT}))}),1e3*this._diagnosticsEcsConfig.CALL.MEDIASTREAM_TIMEOUT_IN_SEC)}));let _=v.mediaStreams[0][0],E=document.getElementById("_hiddenSelfRemoteStream");E&&E.remove(),E=document.createElement("div"),E.id="_hiddenSelfRemoteStream",E.style.position="relative",E.style.height="0px",E.style.width="0px";const T=document.createElement("div");T.style.position="absolute",T.style.height=this._diagnosticsEcsConfig.CALL.VIDEO_SIZE.heigth+"px",T.style.width=this._diagnosticsEcsConfig.CALL.VIDEO_SIZE.width+"px",T.style.bottom="0px",T.style.left="-2000px",E.appendChild(T),document.getElementsByTagName("body")[0].appendChild(E),this.updateTestInfo(Ig.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Video element rendering successful. CallId: ${g.id}, localParticipantId: ${m}`,name:Ig.InCallDiagnostics}}),await _.start(T)}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.InCallDiagnostics,!1,`Call mediaStreams failed. Error: ${getPrintableObject(g)}`)}),this._logger.warn("Failed to render hidden video element")}}sineWaveAudioStream(){const g=new window.AudioContext,m=g.createMediaStreamDestination(),S=g.createOscillator();S.type="sine",S.frequency.value=500,S.connect(m),S.start();const{stream:v}=m;return new LocalAudioStream(v)}async receiveAndPlayCallAudio(g,m){try{const S=new window.AudioContext,v=new MediaStream;S.createMediaStreamSource(v).connect(S.destination),this.updateTestInfo(Ig.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Call mediaStreams audio track succeeded. CallId: ${g.id}, localParticipantId: ${m}`,name:Ig.InCallDiagnostics}})}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.InCallDiagnostics,!1,`Call mediaStreams audio track failed. Error: ${getPrintableObject(g)}`)}),this._logger.warn("Failed to send audio to call.")}}async getcallMediaStatistics(){return this._callMediaStatistics.promise}setEcsConfig(){this._diagnosticsEcsConfig=getAcsEcsConfig()?.calling?.callDiagnostics}async getInCallDiagnostics(g){this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Ig.InCallDiagnostics}}),this.setEcsConfig();const m={groupId:this._diagnosticsEcsConfig.CALL.GROUP_ID},S=await this.getDevices(this._internalDeviceManager,"Camera");let v,C="";0!==S.length&&(v=[new LocalVideoStream(S[0])]);const _={videoOptions:{localVideoStreams:v},audioOptions:{muted:!1,localAudioStreams:[this.sineWaveAudioStream()]}};let E;try{E=await(this._mainCallClient.callAgent?.getExistingCallAgentWithToken(g)),E?this._internalCallClient.setCallAgent(E):(this._isCreatingNewCallAgent=!0,await this._internalCallClient.createCallAgent(g)),this.updateTestInfo(Ig.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Create CallAgent successful.",name:Ig.InCallDiagnostics}})}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.GET_CALL_AGENT,originalError:g});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.error(m.message),m}const T=this._internalCallClient.callAgent?.join(m,_);if(T){try{await this.waitCallConnected(T),C=T.tsCall.participantId,this.updateTestInfo(Ig.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Call connected successfully",name:Ig.InCallDiagnostics}})}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.CONNECT_FAIL,originalError:g});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.error(m.message),m}try{this.updateTestInfo(Ig.InCallDiagnostics,!0),await this.renderHiddenVideoElement(T,C)}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.RENDER_VIDEO,originalError:g});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),m}this.receiveAndPlayCallAudio(T,C);const g=T.feature(callFeatureFactory(MediaStatsCallFeatureImpl,{activationEvent:"OnExtendedObjectConstructor"}));this._callMediaStatistics.resolve(g);g.createCollector({aggregationInterval:this._diagnosticsEcsConfig.CALL.AGGREGATION.INTERVAL,dataPointsPerAggregation:this._diagnosticsEcsConfig.CALL.AGGREGATION.DATAPOINTS}).on("summaryReported",(g=>this.gatherCallStatistics(g)));try{await sleep(1e3*this._diagnosticsEcsConfig.CALL.DURATION_IN_SEC),await T.hangUp({forEveryone:!0}),this.updateTestInfo(Ig.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Call hangup successful. Result: ${getPrintableObject(this._inCallDiagnostics,this._printableObjectAll)}`,name:Ig.InCallDiagnostics}})}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.HANGUP_FAIL,originalError:g});throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.error(m.message),m}this.dispose()}return this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:this._completeTestInfo.succeeded,result:this._completeTestInfo.result||"InCallDiagnostics succeeded.",name:Ig.CompleteTest}}),this._inCallDiagnostics}async waitCallConnected(g){await new Promise((async(m,S)=>{g.on("stateChanged",(()=>{"Connected"==g.state&&(this._inCallDiagnostics.connected=!0,m()),"Disconnected"==g.state&&S("Call disconnected")}));const v=this._diagnosticsEcsConfig.CALL.CONNECT_TIMEOUT_IN_SEC;await sleep(1e3*v),S(new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.CALL_CONNECT_TIMEOUT,defaultErrorMessageArgs:[v]}))}))}qualityGrade(g,m,S){return g<=m?"Good":g>=S?"Bad":"Average"}bandwidthQualityGrade(g,m,S){return g>=m?"Good":g<=S?"Bad":"Average"}getQualityGradeForMetric(g,m,S){switch(g){case _g.JITTER:return S===yg.AUDIO?this.qualityGrade(m,this._diagnosticsEcsConfig.AUDIO.JITTER.GOOD,this._diagnosticsEcsConfig.AUDIO.JITTER.AVERAGE):this.qualityGrade(m,this._diagnosticsEcsConfig.VIDEO.JITTER.GOOD,this._diagnosticsEcsConfig.VIDEO.JITTER.AVERAGE);case _g.RTT:return S===yg.AUDIO?this.qualityGrade(m,this._diagnosticsEcsConfig.AUDIO.RTT.GOOD,this._diagnosticsEcsConfig.AUDIO.RTT.AVERAGE):this.qualityGrade(m,this._diagnosticsEcsConfig.VIDEO.RTT.GOOD,this._diagnosticsEcsConfig.VIDEO.RTT.AVERAGE);case _g.PACKETS_LOSS:return S===yg.AUDIO?this.qualityGrade(m,this._diagnosticsEcsConfig.AUDIO.PACKETS_LOSS_PERCENTAGE.GOOD,this._diagnosticsEcsConfig.AUDIO.PACKETS_LOSS_PERCENTAGE.AVERAGE):this.qualityGrade(m,this._diagnosticsEcsConfig.VIDEO.PACKETS_LOSS_PERCENTAGE.GOOD,this._diagnosticsEcsConfig.VIDEO.PACKETS_LOSS_PERCENTAGE.AVERAGE);case _g.BANDWIDTH:return this.bandwidthQualityGrade(m,this._diagnosticsEcsConfig.BANDWIDTH.GOOD,this._diagnosticsEcsConfig.BANDWIDTH.AVERAGE);default:return Eg}}gatherCallStatistics(g){try{const m=g.audio.receive.length?g.audio.receive[0]:void 0,S=g.audio.send.length?g.audio.send[0]:void 0,v=g.video.receive.length?g.video.receive[0]:void 0,C=g.video.send.length?g.video.send[0]:void 0,_=g.transports.length?g.transports[0]:void 0;this._diagnosticsMediaTelemetry.jitter.audio.inbound=calculateFirstAverage(m?.jitterInMs?.aggregation),this._diagnosticsMediaTelemetry.jitter.audio.outbound=calculateFirstAverage(S?.jitterInMs?.aggregation);const E=Math.max(this._diagnosticsMediaTelemetry.jitter.audio?.inbound,this._diagnosticsMediaTelemetry.jitter.audio?.outbound);this._inCallDiagnostics.diagnostics.audio.jitter=this.getQualityGradeForMetric(_g.JITTER,E,yg.AUDIO),this._diagnosticsMediaTelemetry.rtt.audio=calculateFirstAverage(S?.rttInMs?.aggregation),this._inCallDiagnostics.diagnostics.audio.rtt=this.getQualityGradeForMetric(_g.JITTER,this._diagnosticsMediaTelemetry.rtt.audio,yg.AUDIO),this._diagnosticsMediaTelemetry.packets.audioSent=calculateFirstSum(S?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioSentLost=calculateFirstSum(S?.packetsLostPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioReceived=calculateFirstSum(m?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioReceivedLost=calculateFirstSum(m?.packetsLostPerSecond?.aggregation);const T=this._diagnosticsMediaTelemetry.packets.audioSent-this._diagnosticsMediaTelemetry.packets.audioSentLost,I=this._diagnosticsMediaTelemetry.packets.audioReceived-this._diagnosticsMediaTelemetry.packets.audioReceivedLost,b=Math.max(T,I)/this._diagnosticsMediaTelemetry.packets.audioSent*100;this._inCallDiagnostics.diagnostics.audio.packetLoss=this.getQualityGradeForMetric(_g.PACKETS_LOSS,b,yg.AUDIO),this._diagnosticsMediaTelemetry.jitter.video.inbound=calculateFirstAverage(v?.jitterInMs?.aggregation),this._diagnosticsMediaTelemetry.jitter.video.outbound=calculateFirstAverage(C?.jitterInMs?.aggregation);const A=Math.max(this._diagnosticsMediaTelemetry.jitter.video.inbound,this._diagnosticsMediaTelemetry.jitter.video.outbound);this._inCallDiagnostics.diagnostics.video.jitter=this.getQualityGradeForMetric(_g.JITTER,A,yg.VIDEO),this._diagnosticsMediaTelemetry.rtt.video=calculateFirstAverage(C?.rttInMs?.aggregation),this._inCallDiagnostics.diagnostics.video.rtt=this.getQualityGradeForMetric(_g.RTT,this._diagnosticsMediaTelemetry.rtt.video,yg.VIDEO),this._diagnosticsMediaTelemetry.packets.videoSent=calculateFirstSum(C?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoSentLost=calculateFirstSum(C?.packetsLostPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoReceived=calculateFirstSum(v?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoReceivedLost=calculateFirstSum(v?.packetsLostPerSecond?.aggregation);const R=this._diagnosticsMediaTelemetry.packets.videoSent-this._diagnosticsMediaTelemetry.packets.videoSentLost,P=this._diagnosticsMediaTelemetry.packets.videoReceived-this._diagnosticsMediaTelemetry.packets.videoReceivedLost,M=Math.max(R,P)/this._diagnosticsMediaTelemetry.packets.videoSent*100;this._inCallDiagnostics.diagnostics.video.packetLoss=this.getQualityGradeForMetric(_g.PACKETS_LOSS,M,yg.VIDEO),this._diagnosticsMediaTelemetry.bandWidth=calculateFirstAverage(_?.availableOutgoingBitrate?.aggregation),this._inCallDiagnostics.bandWidth=this.getQualityGradeForMetric(_g.BANDWIDTH,this._diagnosticsMediaTelemetry.bandWidth,yg.AUDIO)}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.PRECALL_DIAGNOSTICS.VIDEO_MEDIASTATS,originalError:g});this._logger.error("Failed to get audio call media stats:",m.message),this._callMediaStatistics.reject(m)}}async deviceAccess(){this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Ig.DeviceAccess}});const g=this._internalDeviceManager.askDevicePermission({audio:!0,video:!0});try{const m=await g;this.updateTestInfo(Ig.DeviceAccess,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Device Access successful. Result: ${getPrintableObject(m,this._printableObjectAll)}`,name:Ig.DeviceAccess}})}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.DeviceAccess,!1,"Device Access failed.")})}return g}async deviceEnumeration(){const g={microphone:Eg,camera:Eg,speaker:Eg};this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Ig.DeviceEnumerations}});try{const m=0!==(await this.getDevices(this._internalDeviceManager,"Microphone")).length,S=0!==(await this.getDevices(this._internalDeviceManager,"Camera")).length,v=0!==(await this.getDevices(this._internalDeviceManager,"Speaker")).length;g.microphone=m?"Available":"NotAvailable",g.camera=S?"Available":"NotAvailable",g.speaker=v?"Available":"NotAvailable",this.updateTestInfo(Ig.DeviceEnumerations,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Device Enumeration successful. Result: ${getPrintableObject(g,this._printableObjectAll)}`,name:Ig.DeviceEnumerations}})}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Ig.DeviceEnumerations,!1,"Device Enumeration failed.")}),this._logger.error(`Couldn't find mic, camera, or speaker: ${g}`)}return g}telemetryLogAttemptEvents(g){this._telemetryLogManager.sendEvent({name:Ah.acs_calling_diagnostics_attempt,tenant:Qa,properties:{name:g.testAttemptDetails.name,diagnosticsTestRunId:g.diagnosticsTestRunId}})}telemetryLogResultEvents(g){this._telemetryLogManager.sendEvent({name:Ah.acs_calling_diagnostics_result,tenant:Qa,properties:{name:g.testResultDetails.name,diagnosticsTestRunId:g.diagnosticsTestRunId,succeeded:g.testResultDetails.succeeded,result:g.testResultDetails.result,additionalDetails:g.additionalDetails||{}}})}updateTestInfo(g,m,S){return this._completeTestInfo.succeeded&&(this._completeTestInfo={succeeded:m,name:g,result:S}),{succeeded:m,name:g,result:S||""}}_sendFeatureUsage(g,m){sendCallClientFeatureUsageTelemetry({featureName:"PreCallDiagnostics",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._isCreatingNewCallAgent&&this._internalCallClient.callAgent?.dispose()}}class Debounce{constructor(g,m){this._debounce=void 0,this._updateFunction=g,this._timeout=m}debounce(){this._debounce?(clearTimeout(this._debounce),this._debounce=setTimeout((()=>{this._updateFunction(),this._debounce=void 0}),this._timeout)):(this._updateFunction(),this._debounce=setTimeout((()=>{this._debounce=void 0}),this._timeout))}flush(){this._debounce&&(clearTimeout(this._debounce),this._debounce=void 0,this._updateFunction())}}class RemoteVideoStreamCommonImpl{constructor(g,m,S,v,C,_){this._isReceiving=!1,this._mediaStreamType="Video",this._renderers=[],this._disposed=!1,this._size={height:0,width:0},this._setType=g=>{0===g.type?this._mediaStreamType="Video":1===g.type?this._mediaStreamType="ScreenSharing":2===g.type&&(this._mediaStreamType="LiveStream")},this._disposeRenderer=g=>{this.logger.log("disposing renderer");try{g.dispose(uu.Internal_RemoteVideoStreamDisposed),this.logger.log("renderer disposed")}catch(g){this.logger.log("failed to dispose renderer")}},this.tsStream=g,this._setType(this.tsStream),this.logger=m.createChild((()=>`Stream:{id=${this.tsStream.id}}:{type=${this._mediaStreamType}}`)),this.telemetryLogManager=C,this.kind=_,this._eventEmitter=new CallingEventEmitter(this.logger),this.call=S,this._tsParticipantId=v,this.sendRemoteVideoStreamTelemetry(),this._debounceSize=this.createDebounceSize(),this._debounceIsReceiving=new Debounce((()=>{const g=this._renderers?.filter((g=>!!g?.isRendering)).length>0;this._isReceiving!==g&&(this._isReceiving=g,this.logger.info(`isReceiving changed to ${this._isReceiving}`),this._eventEmitter.emit("isReceivingChanged"),this.sendRemoteVideoStreamTelemetry())}),getAcsEcsConfig().rendering.remoteVideo.debounceTimeout),this._registeredViewIdsMaxLength=getAcsEcsConfig().rendering.remoteVideo.registeredViewIdsMaxLength,this.logger.info("created")}on(g,m){if("sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}get id(){return this.tsStream.id}get isReceiving(){return this._isReceiving}get tsParticipantId(){return this._tsParticipantId}get remoteParticipantId(){return this.tsStream.participantId??""}get mediaStreamType(){return this._mediaStreamType}get size(){return{height:this._size.height,width:this._size.width}}updateSize(){this._debounceSize.debounce()}updateIsReceiving(){this._debounceIsReceiving.debounce()}flushIsReceiving(){this._debounceIsReceiving.flush()}registerRenderer(g){this._renderers.push(g),this.logger.info(`Renderer registered, view id: ${g.viewId}`)}unregisterRenderer(g){const m=this._renderers.indexOf(g);-1!==m&&(this._renderers.splice(m,1),this.logger.info(`Renderer un-registered, view id: ${g.viewId}`))}dispose(){this.logger.log("dispose"),this._disposed?this.logger.log("already disposed"):(this._disposed=!0,this._streamChangedHandler&&this._streamChangedHandler.dispose(),this._renderers.forEach((g=>this._disposeRenderer(g))),this._renderers=[],this._eventEmitter.removeAllListeners())}getRegisteredViewIds(){let g=this._renderers.map((g=>g.viewId));return this._registeredViewIdsMaxLength&&(g=g.slice(0,this._registeredViewIdsMaxLength)),g.join(", ")}sendRemoteVideoStreamTelemetry(){this.call.stats.recordEvent({name:bh.remote_stream,callId:this.call.id,localParticipantId:this.call.tsCall.participantId,data:{...this.getStreamMetadata()}})}createDebounceSize(){return new Debounce((()=>{let g={height:0,width:0};this._renderers?.forEach((m=>{m?.isRendering&&m.size.height>g.height&&m.size.width>g.width&&(g.height=m.size.height,g.width=m.size.width)}),getAcsEcsConfig().rendering.remoteVideo.debounceTimeout),this._size.height===g.height&&this._size.width===g.width||(this._size.height=g.height,this._size.width=g.width,this.logger.info(`stream size changed to { height: ${this._size.height}, width: ${this._size.width} }`),this._eventEmitter.emit("sizeChanged"),this.sendRemoteVideoStreamTelemetry())}),getAcsEcsConfig().rendering.remoteVideo.debounceTimeout)}}class LiveStreamStatsCalculator{constructor(g){this._statsInfo=g,this._originalValues={},this._aggregateValues={}}isDiffMethod(g){return"diff"==g||"last2"==g||"rate"===g}addStats(g,m){const S=this._statsInfo[g];let v=this._originalValues[g];if(void 0===v&&(v={raw:[],calc:[],lastTime:Date.now(),beginTime:Date.now()},this._originalValues[g]=v),this.isDiffMethod(S.calculation_method)){v.raw.push(m);const g=Date.now(),C=v.lastTime;if(v.lastTime=g,v.raw.length>1){m=v.raw[v.raw.length-1]-v.raw[v.raw.length-2],"rate"===S.calculation_method&&(m=m/(g-C)*1e3),void 0!==S.multiplier&&(m*=S.multiplier),!0===S.integer&&(m|=0),v.calc.push(m)}else"rate"===S.calculation_method&&(m=0)}else void 0!==S.multiplier&&"number"==typeof m&&(m*=S.multiplier),!0===S.integer&&(m|=0),v.raw.push(m);return m}aggregate(){const g={};for(const[m,S]of Object.entries(this._originalValues)){const v=this._statsInfo[m];if(void 0===v||!1===v.show)continue;this.isDiffMethod(v.calculation_method)&&S.raw.length>0&&(g[m]={raw:[S.raw[S.raw.length-1]],calc:[],lastTime:S.lastTime,beginTime:0});let C=this._aggregateValues[m];void 0===C&&(C={raw:[],timestamp:new Date(S.beginTime)},v.aggregation_needed&&(C.aggregation={count:[],sum:[],max:[],min:[]}),this._aggregateValues[m]=C);const _=S.calc?.length?S.calc:S.raw;let E=_;if(v.aggregation_needed&&C.aggregation){const g=_.filter((g=>"number"==typeof g&&!isNaN(g)));C.aggregation.count.push(g.length),C.aggregation.sum.push(getSum(g)),C.aggregation.max.push(getMax(g)),C.aggregation.min.push(getMin(g)),E=g}v.raw_data_reduction&&E.length>0&&(C.reduced=C.reduced||[],C.reduced.push(E[E.length-1])),E.forEach((g=>C.raw.push(g)))}this._originalValues=g}popAggregates(){const g={};for(const[m,S]of Object.entries(this._aggregateValues)){g[this._statsInfo[m].name??m]=S}return this._aggregateValues={},g}}class LiveStreamStatsCollectorImpl{constructor(g,m,S){if(this._tsCall=g,this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=new Map,S.aggregationInterval<1)throw new CallingCommunicationError({defaultError:D.FEATURES.LIVE_STREAM.INVALID_AGGREGATION_INTERVAL_RANGE});if(S.dataPointsPerAggregation<1)throw new CallingCommunicationError({defaultError:D.FEATURES.LIVE_STREAM.INVALID_DATAPOINTS_AGGREGATION_RANGE});this._logger=m.createChild("LiveStreamStatsCollector"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._callStateChanged=defer$1(),this._statsPoller=S.statsPoller,this._statsInfo=S.statsInfo,this._aggregationInterval=S.aggregationInterval,this._dataPointsPerAggregation=S.dataPointsPerAggregation,this._isInternal=S.isInternal,this._dataEventListener=g=>{void 0!==g&&this._processData(g)},this._statsPoller.on("data",this._dataEventListener);const v=[3,10];let C=v.includes(this._tsCall.state);this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{C!==v.includes(this._tsCall.state)&&(C=!C,this._callStateChanged.resolve(C))})),this._run()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._disposed||(this._disposed=!0,this._callStateChangedHandle.dispose(),this._callStateChanged.resolve(!1),this._statsPoller.off("data",this._dataEventListener),this._eventEmitter.emit("dispose"),this._eventEmitter.removeAllListeners())}_processData(g){const m={},S=Object.keys(g);0!==S.length&&(S.forEach((S=>{const v=g[S],C={};let _=this._calculators.get(S);_||(_=new LiveStreamStatsCalculator(this._statsInfo),this._calculators.set(S,_));for(const[g,m]of Object.entries(v)){const S=this._statsInfo[g];if(S&&!1!==S.show&&(this._isInternal||!S.is_internal)){const v=_.addStats(g,m);C[S.name??g]=v}}m[S]=C})),Object.keys(m).length>0&&this._eventEmitter.emit("sampleReported",m))}async _run(){let g=0;const filterReducedRaw=g=>(Object.keys(g).forEach((m=>{g[m].reduced&&!this._isInternal&&delete g[m].reduced})),g),flushData=()=>{if(0===this._calculators.size||0===g)return;const m=[],S={};this._calculators.forEach(((g,v)=>{const C=filterReducedRaw(g.popAggregates());0===Object.keys(C).length?m.push(v):(C.reduced&&!this._isInternal&&delete C.reduced,S[v]=C)}));try{this._eventEmitter.emit("summaryReported",S)}catch(g){this._logger.error(`summary event: ${g}`)}m.forEach((g=>{this._calculators.delete(g)})),g=0},m=[3,10];let S=1e3*this._aggregationInterval;for(;!this._disposed;){if(m.includes(this._tsCall.state)){S>0&&await wait((()=>this._callStateChanged.promise),S).catch((g=>{}));const m=Date.now();this._calculators.size>0&&(this._calculators.forEach((g=>{g.aggregate()})),g++,g===this._dataPointsPerAggregation&&flushData());const v=Date.now();S=m+1e3*this._aggregationInterval-v}else flushData(),this._calculators.clear(),await this._callStateChanged.promise.catch((g=>{})),S=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=defer$1())}flushData()}}class LiveStreamStatsPoller extends StatsPoller{constructor(g,m,S,v){super(g,m.createChild("LiveStreamStatsPoller"),S.fetchInterval,S.pollingMethod),this._liveStreams=v}async getStats(){const g={};return this._liveStreams.forEach(((m,S)=>{try{const S=m.tsStream.getStats();if(S){const m=S.id.toString(),v={id:m};"number"==typeof S.player_downloadBitrate&&(v.videoBitrate=S.player_downloadBitrate),"number"==typeof S.player_audioDownloadBitrate&&(v.audioBitrate=S.player_audioDownloadBitrate),"number"==typeof S.player_totalDownloadedBytes&&(v.downloadBitrate=S.player_totalDownloadedBytes,v.totalDownloadBytes=S.player_totalDownloadedBytes),"number"==typeof S.player_videoBufferLength&&(v.bufferLengthInMs=Math.round(1e3*S.player_videoBufferLength)),void 0!==S.player_mediaHeight&&(v.videoHeight=S.player_mediaHeight),void 0!==S.player_mediaWidth&&(v.videoWidth=S.player_mediaWidth),void 0!==S.player_playerHeight&&(v.playerHeight=S.player_playerHeight),void 0!==S.player_playerWidth&&(v.playerWidth=S.player_playerWidth),"number"==typeof S.player_mediaDelay&&(v.mediaDelayInMs=Math.round(1e3*S.player_mediaDelay)),"number"==typeof S.player_currentPlayPosition&&(v.currentPlayPosition=Math.round(1e3*S.player_currentPlayPosition)/1e3),g[m]=v}}catch(g){this._logger.error(`fetch live stream stats failed: ${g}`)}})),Object.keys(g).length>0?g:void 0}}class LiveStreamStatsTelemetryLogger{constructor(g,m,S){this._tsCall=g,this._telemetryLogManager=m,this._config=S}log(g){Object.entries(g).forEach((([g,m])=>{const S={id:g},v={id:g};if(Object.entries(m).forEach((([g,m])=>{const C=g,_={};if(this._config.dataToSend.raw){const g={};m?.timestamp&&(g.timestamp=m.timestamp),m?.raw&&(g.raw=m?.raw),void 0===g.raw&&delete v[C],v[C]=g}void 0!==m?.aggregation?(m?.timestamp&&(_.timestamp=m?.timestamp),this._config.dataToSend.min&&(_.min=m?.aggregation.min),this._config.dataToSend.max&&(_.max=m?.aggregation.max),this._config.dataToSend.sum&&(_.sum=m?.aggregation.sum),this._config.dataToSend.count&&(_.count=m?.aggregation.count),m?.aggregation.sum&&m?.aggregation.count&&(_.average=getSum(m?.aggregation.sum)/getSum(m?.aggregation.count))):(m?.timestamp&&(_.timestamp=m.timestamp),m?.reduced?_.raw=m?.reduced:void 0!==m?.raw&&(_.raw=m?.raw)),S[C]=_})),Object.keys(S).length>1){const g={stats:S,callId:this._tsCall.callId||"",localParticipantId:this._tsCall.participantId||""};this._sendLiveStreamStatsEvent(g)}if(this._config.dataToSend.raw&&Object.keys(v).length>1){const g={stats:v,callId:this._tsCall.callId||"",localParticipantId:this._tsCall.participantId||""};this._sendLiveStreamRawStatsEvent(g)}}))}_sendLiveStreamStatsEvent(g){this._telemetryLogManager.sendEvent({name:Ah.acs_calling_livestream_stats,tenant:Qa,properties:g})}_sendLiveStreamRawStatsEvent(g){this._telemetryLogManager.sendEvent({name:Ah.acs_calling_livestream_raw_stats,tenant:Qa,properties:g})}}class LiveStreamStatsManager{constructor(g,m,S,v){this._tsCall=g,this._logger=m,this._collectors=[],this._disposed=!1,this._externalStatsInfo={};const C=getAcsEcsConfig().telemetry.liveStreamStatsConfig;this._config=C,this._statsPoller=new LiveStreamStatsPoller(this._tsCall,this._logger,C,v);const _={...qo,...C.additionalStats};if(Object.entries(_).filter((([,g])=>!g.is_internal)).forEach((([g,m])=>{this._externalStatsInfo[g]=m})),C.enabled){const g=new LiveStreamStatsCollectorImpl(this._tsCall,this._logger,{statsPoller:this._statsPoller,aggregationInterval:C.aggregationInterval,dataPointsPerAggregation:C.dataPointsPerAggregation,statsInfo:_,isInternal:!0}),m=new LiveStreamStatsTelemetryLogger(this._tsCall,S,C);g.on("summaryReported",(g=>{m.log(g)})),this._collectors.push(g)}}createStatsCollector(g){if(this._disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.LIVE_STREAM.DISPOSED});const m=this._config,S=new LiveStreamStatsCollectorImpl(this._tsCall,this._logger,{statsPoller:this._statsPoller,aggregationInterval:g?.aggregationInterval??m.aggregationInterval,dataPointsPerAggregation:g?.dataPointsPerAggregation??m.dataPointsPerAggregation,statsInfo:this._externalStatsInfo,isInternal:!1});return S.on("dispose",(()=>{this._collectors=this._collectors.filter((g=>g!==S))})),this._collectors.push(S),S}dispose(){this._disposed||(this._disposed=!0,this._collectors.forEach((g=>{g.dispose()})))}}class BotStreamCommonCallFeature{constructor(g,m){this._featureName=g,this._targetBotIds=m,this._streamIdToStreamMap=new Map}initialize(g,m,S,v,C){this._logger=C.createChild((()=>`${this._featureName}::Call(id='${g.callId}')`)),this._telemetryLogManager=v,this._call=S,this._tsCall=g,this.observeBotParticipantsAlreadyInCall(),this._tsCall.on("participantAdded",(async g=>{this.observeBotParticipantJustJoinedCall(g)})),this._tsCall.on("participantRemoved",(async g=>{this.removeStreamOfTheBotJustRemovedFromCall(g)}))}disposeAllBotStreams(){this._streamIdToStreamMap.forEach((g=>g.dispose())),this._streamIdToStreamMap.clear()}observeBotParticipantsAlreadyInCall(){this._tsCall.participants.forEach((g=>{this.isExpectedBotParticipant(g)&&(this._logger.info(`${this._featureName} Bot already in the call`),this.observeBotParticipant(g))}))}observeBotParticipantJustJoinedCall(g){this.isExpectedBotParticipant(g)&&(this._logger.info(`${this._featureName} Bot added`),this.observeBotParticipant(g))}removeStreamOfTheBotJustRemovedFromCall(g){if(this.isExpectedBotParticipant(g)){this._logger.info(`${this._featureName} Bot removed`);const m=[];this.removeAllStreams(g,m),this.checkVideoStreamAddedOrRemoved([],m)}}observeBotParticipant(g){g.changed((()=>{this._logger.info(`${this._featureName} Bot - changed event triggered. state: ${g.state}`),this._mapStreams(g)})),this._logger.info(`Composition Bot state: ${g.state}`),this._mapStreams(g)}_mapStreams(g){const m=[],S=[],mapStreamsOfType=v=>{if(g)if(isNonEmptyArray(g.streams&&g.streams[v])){let C=g.streams[v];this._logger.log(`Stream Type: ${v}`),C.forEach((S=>{if(void 0===S.id&&(S.id=-1),!this._streamIdToStreamMap.get(S.id)){const v=this.createConcreteVideoStream(S,g.id);this._logger.log(`${this._featureName} stream created, type==${v.mediaStreamType} id=${S.id}`),m.push(v)}})),this._streamIdToStreamMap.forEach((m=>{m.tsParticipantId!==g.id||C.some((g=>g.id===m.id))||S.push(m)}))}else this.removeAllStreams(g,S)};this.getStreamTypes().forEach((g=>mapStreamsOfType(g))),this.checkVideoStreamAddedOrRemoved(m,S)}removeAllStreams(g,m){this._streamIdToStreamMap.forEach((S=>{S.tsParticipantId===g.id&&m.push(S)}))}checkVideoStreamAddedOrRemoved(g,m){if(g.length>0||m.length>0){const handleNewStream=g=>{this._streamIdToStreamMap.set(g.id,g)},handleRemovedStream=g=>{const m=this._streamIdToStreamMap.get(g.id);m&&(this._logger.log(`stream removed, type==${m.mediaStreamType} id=${g.id}`),this._streamIdToStreamMap.delete(g.id),m.dispose())};g.forEach(handleNewStream),m.forEach(handleRemovedStream),this.emitVideoStreamsUpdatedEvent({added:g,removed:m})}}isExpectedBotParticipant(g){return this._targetBotIds.includes(g.id)}}class LiveStreamCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new LiveStreamCallFeatureImplOverTsCall(this.eventEmitter,this.name)}get name(){return"LiveStream"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}dispose(){this._impl.dispose(),super.dispose()}get liveStreams(){return this._impl.liveStreams}get participantCount(){return this._impl.streamingClientCount}on(g,m){if("liveStreamsUpdated"!==g&&"participantCountChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.LIVE_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.on(g,m)}off(g,m){if("liveStreamsUpdated"!==g&&"participantCount"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.LIVE_STREAM.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.off(g,m)}createStatsCollector(g){return this._impl.createStatsCollector(g)}}class LiveStreamCallFeatureImplOverTsCall extends BotStreamCommonCallFeature{constructor(g,m){super(m,getAcsEcsConfig().calling.liveStreamingBotIds),this._eventEmitter=g}initialize(g,m,S,v,C){super.initialize(g,m,S,v,C),this._statsManager=new LiveStreamStatsManager(g,C,v,this._streamIdToStreamMap),this._tsCall.participantCounts&&null!=this._tsCall.participantCounts.streamingClients&&(this._participantCount=this._tsCall.participantCounts.streamingClients),this._tsCall.on("participantCountsUpdated",(()=>{if(this._tsCall.participantCounts&&this._participantCount!==this._tsCall.participantCounts.streamingClients){const g=this._participantCount;this._participantCount=this._tsCall.participantCounts.streamingClients,this._logger.log(`tsCall participantCount changed from ${g} to ${this._participantCount}`),this._eventEmitter.emit("participantCountChanged")}}))}dispose(){super.disposeAllBotStreams(),this._statsManager.dispose()}createStatsCollector(g){return this._statsManager.createStatsCollector(g)}get liveStreams(){return[...this._streamIdToStreamMap.values()].map((g=>g))}get streamingClientCount(){return this._participantCount??0}createConcreteVideoStream(g,m){return new LiveVideoStreamImpl(g,this._logger,this._call,this._callAgent,m,this._telemetryLogManager)}getStreamTypes(){return[2]}emitVideoStreamsUpdatedEvent(g){return this._eventEmitter.emit("liveStreamsUpdated",g)}}class LiveVideoStreamImpl extends RemoteVideoStreamCommonImpl{constructor(g,m,S,v,C,_){super(g,m,S,C,_,"LiveVideoStream")}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this.getRegisteredViewIds(),height:this._size.height,width:this._size.width,isDisposed:this._disposed}}}class ComposedStreamCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new ComposedStreamCallFeatureImplOverTsCall(this.eventEmitter,this.name)}get name(){return"ComposedStream"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}dispose(){this._impl.dispose(),super.dispose()}get composedStreams(){return this._impl.composedStreams}on(g,m){this.eventEmitter.on(g,m)}off(g,m){this.eventEmitter.off(g,m)}}class ComposedStreamCallFeatureImplOverTsCall extends BotStreamCommonCallFeature{constructor(g,m){super(m,getAcsEcsConfig().calling.composedStreamBotIds),this._eventEmitter=g}initialize(g,m,S,v,C){super.initialize(g,m,S,v,C)}dispose(){super.disposeAllBotStreams()}get composedStreams(){return[...this._streamIdToStreamMap.values()].map((g=>g))}createConcreteVideoStream(g,m){return new ComposedVideoStreamImpl(g,this._logger,this._call,this._callAgent,m,this._telemetryLogManager)}getStreamTypes(){return[0]}emitVideoStreamsUpdatedEvent(g){return this._eventEmitter.emit("composedStreamsUpdated",g)}}class ComposedVideoStreamImpl extends RemoteVideoStreamCommonImpl{constructor(g,m,S,v,C,_){super(g,m,S,C,_,"ComposedVideoStream")}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this.getRegisteredViewIds(),height:this._size.height,width:this._size.width,isDisposed:this._disposed}}}class EffectsCapabilityChecker{constructor(g,m){this._logger=g,this._environmentInfo=m,this._videoEffectsEnabled=!1,this._audioEffectsEnabled=!1,this._videoEffectsSupported=!1,this._audioEffectsSupported=!1,this._config=getAcsEcsConfig(),this._mediaConfig=getMediaConfig(),this._videoEffectsEnabled=!(!this._mediaConfig?.enableVideoEffects||!this._config?.videoEffects?.enableVideoEffects),this._audioEffectsEnabled=!!this._config?.audioEffects?.enableAudioEffects,this._videoEffectsEnabled&&(this._videoEffectsSupported=this._mediaConfig?.webcv?.useWasmEffects?this._isWasmVideoEffectSupported():this._isWebgl2EffectSupported())}async videoEffectsSupported(){if(this._videoEffectsEnabled){const g=this._mediaConfig?.webcv?.useWasmEffects?this._isWasmVideoEffectSupported():this._isWebgl2EffectSupported();this._videoEffectsSupported=g&&this._isCurrentEnvironmentSDKSupported()}else this._logger.info("Video effects are disabled."),this._videoEffectsSupported=!1;return this._videoEffectsSupported}async audioEffectsSupported(g){return this._audioEffectsEnabled?this._audioEffectsSupported=this._isBrowserEffect(g)?this._isBrowserEffectSupported(g):await this._isWasmAudioEffectSupported():(this._logger.info("Audio effects are disabled."),this._audioEffectsSupported=!1),this._audioEffectsSupported}_isBrowserEffect(g){if("string"==typeof g)switch(g){case"BrowserEchoCancellation":case"BrowserNoiseSuppression":case"BrowserAutoGainControl":return!0;default:return!1}return!1}_isBrowserEffectSupported(g){const m=window.navigator?.mediaDevices?.getSupportedConstraints?.();if(m)switch(g){case"BrowserEchoCancellation":return!!m.echoCancellation;case"BrowserNoiseSuppression":return!!m.noiseSuppression;case"BrowserAutoGainControl":return!!m.autoGainControl;default:return!1}return!1}_isCurrentEnvironmentSDKSupported(){return!!(this._environmentInfo.isSupportedBrowser&&this._environmentInfo.isSupportedBrowserVersion&&this._environmentInfo.isSupportedEnvironment&&this._environmentInfo.isSupportedPlatform)}_isWasmVideoEffectSupported(){return this._mediaConfig?.webcv?.useWasmEffects?!!window.MediaStreamTrackProcessor||(this._logger.info("WASM effects disabled, insertable streams are not supported"),!1):(this._logger.info("WASM effects disabled by WebCV feature flag"),!1)}_isWebgl2EffectSupported(){return this._isCurrentRendererSupported()&&this._isWebGL2Supported()}_isCurrentRendererSupported(){const g=this._mediaConfig?.webcv?.webGLUnsupportedRenderers??[];let m=!1;try{const S=document.createElement("canvas").getContext("webgl"),v=S?.getExtension("WEBGL_debug_renderer_info"),C=v&&S?.getParameter(v.UNMASKED_RENDERER_WEBGL);return C&&!g.some((g=>g===C))?m=!0:this._logger.info(`Unsupported renderer: ${stringifyObject(C)}`),m}catch(g){return this._logger.warn(`Error trying to check compatibility: ${JSON.stringify(g)}`),!1}}_isWebGL2Supported(){try{const g=document.createElement("canvas").getContext("webgl2");if(!g)return this._logger.info("WebGL2 context is not supported"),!1;const m=g.getSupportedExtensions(),S=this._mediaConfig?.webcv?.webGLRequiredExtensions.filter((g=>!m?.includes(g)));if(S.length>0)return this._logger.info(`Unsupported WebGL2 extensions: ${stringifyObject(S)}`),!1}catch(g){return this._logger.error(`isWebGL2Supported: ${stringifyObject(g)}`),!1}return!0}async _isWasmAudioEffectSupported(){return window.AudioWorkletNode?!!window.WebAssembly||(this._logger.info("WebAssembly is not supported"),!1):(this._logger.info("AudioWorkletNode is not supported"),!1)}}const bg=[{acsEffect:"Off",tsCallingEffect:0},{acsEffect:"BackgroundBlur",tsCallingEffect:1},{acsEffect:"BackgroundReplacement",tsCallingEffect:16}];class VideoEffectsFeatureImpl extends FirstPartyVideoStreamFeature{constructor(){super(...arguments),this._effect=null,this._fpsWarningEventIntervalIds=[],this._fpsWarningEventTimeoutIds=[],this._tsCallingEffectCapability=0,this._tsCallingSupportedEffects=[{acsEffect:"Off",tsCallingEffect:0}],this._activeEffects=[],this.configUpdatedCallback=async g=>{console.log("config updated callback");const m=this._internalDeviceManager.getTsDeviceManager();if("BackgroundReplacement"===g){const g=(this._effect?._internalHandle?.effectConfig).backgroundImageUrl;g&&await m.setBackgroundImageAsync("",g)}},this.processingErrorCallback=async g=>{const m=generateGuid();this.eventEmitter.emit("effectsError",g);const S=this.getEffectNameForTelemetry(this._effect?.name),v=this.getUsageDetailsForTelemetry("Internal handle error",S);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.effectsError,kindOfEvent:Rh.failure,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g),usageDetails:v}}),await this.stopEffects()},this.effectStatusChangedCallback=(g,m)=>{if(m.length>0){const g=this._effect?.name?[this._effect.name]:m;this.eventEmitter.emit("effectsStarted",g)}else{const m=this._effect?.name?[this._effect.name]:g;this.eventEmitter.emit("effectsStopped",m)}}}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this.updateEffectStatusManager()}get name(){return"VideoEffects"}get activeEffects(){return this._effectsStatusManager?.getActiveEffects?.()??this._activeEffects}on(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g&&"fpsWarningThresholdReached"!==g&&"timeForEffectsWarningReached"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.on(g,m);const S=generateGuid();this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:S,operation:cu.subscribe,additionalDetails:{usageDetails:`Subscribed to ${g}`}})}off(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g&&"fpsWarningThresholdReached"!==g&&"timeForEffectsWarningReached"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.off(g,m)}async isSupported(g){const m=generateGuid(),S=+new Date,v=this.getEffectNameForTelemetry(g?.name),C=this.getUsageDetailsForTelemetry("",v);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.isSupported,kindOfEvent:Rh.attempt,additionalDetails:{usageDetails:C}});try{const v=this.getEffectInternalCast(g);if(this.disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_SOURCE});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const C=this._internalDeviceManager.getEnvironmentInfoInternal();this._supportChecker||(this._supportChecker=new EffectsCapabilityChecker(this._logger,C));const _=await this._supportChecker.videoEffectsSupported();this._logger.info(`Support check for ${v.name} resulted in: ${_}`);const E=this.getUsageDetailsForTelemetry("",v.name);return this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.isSupported,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.success,additionalDetails:{usageDetails:E}}),_}catch(v){const C=new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.SUPPORT_CHECK_FAILED,originalError:v});this._logger.error(C.message);const _=this.getEffectNameForTelemetry(g?.name),E=this.getUsageDetailsForTelemetry("",_);throw this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.isSupported,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,additionalDetails:{failureReason:C.message,code:C.code,...extractCommunicationServicesErrorForTelemetry(C),usageDetails:E}}),C}}async startEffects(g){const m=generateGuid(),S=+new Date,v=this.getEffectNameForTelemetry(g?.name),C=this.getUsageDetailsForTelemetry("",v);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.startEffects,kindOfEvent:Rh.attempt,additionalDetails:{usageDetails:C}});try{if(!getAcsEcsConfig().videoEffects.enableVideoEffects)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.DISABLED});if(this.disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_SOURCE});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this.updateEffectStatusManager(),this.subscribeToStreamInstanceEvents();const v=window.performance.now();this._effect=this.getEffectInternalCast(g);if(!await this.isSupported(g))throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT});const C=this._internalDeviceManager.getTsDeviceManager();if(!C)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.START_DEVICE_MANAGER});this.setConfigForEffects(),this.disposeEffectEventSubscriptions(),this.subscribeToEffectEvents();const _=await this._effect._internalHandle.getEffectProvider();if(!_)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.PROVIDER_UNAVAILABLE});const E=await _.getVideoEffectProvider(),T=this.streamInstance.callStackWebCVProvider;if(!T)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.WEBCV_PROVIDER_FAILED});T.videoEffectProviderDeferredPromise.resolve(E),0===this._tsCallingEffectCapability&&(this._tsCallingEffectCapability=await(C?.getDeviceEffectsCapabilityAsync(""))),this._tsCallingSupportedEffects=this.getTsCallingSupportedEffects();const I=this._tsCallingSupportedEffects.find((g=>g.acsEffect===this._effect?.name));if(!I)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT});await(C?.setDeviceEffectsAsync("",I.tsCallingEffect)),this._effectsStatusManager.setActiveEffects([this._effect.name]),this._logger.info(`Video effects started: ${this._effect.name}`);const b=window.performance.now();this.handleEffectsInitTimeEvent(v,b),this.handleFpsWarningEvent();const A=this.getUsageDetailsForTelemetry("",this._effect.name);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.startEffects,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.success,additionalDetails:{usageDetails:A}})}catch(v){const C=new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.START_FAILED,originalError:v});this._logger?.error(C.message),this.eventEmitter.emit("effectsError",C),this.clearFpsCheckInterval();const _=this.getEffectNameForTelemetry(g?.name),E=this.getUsageDetailsForTelemetry("",_);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.startEffects,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,additionalDetails:{failureReason:C.message,code:C.code,...extractCommunicationServicesErrorForTelemetry(C),usageDetails:E}})}}async stopEffects(){const g=generateGuid(),m=+new Date;this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:g,operation:cu.stopEffects,kindOfEvent:Rh.attempt});try{if(this.clearFpsCheckInterval(),this.disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.STOP_DISPOSED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const S=this._internalDeviceManager.getTsDeviceManager();if(!S)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.STOP_DEVICE_MANAGER});this.updateEffectStatusManager();const v=this._tsCallingSupportedEffects.find((g=>"Off"===g.acsEffect));if(!v)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT});await S.setDeviceEffectsAsync("",v.tsCallingEffect),this._effectsStatusManager?.setActiveEffects([]);const C=this.getEffectNameForTelemetry(this._effect?.name);this._logger.info(`Video effects stopped: ${C}`),this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:g,operation:cu.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Rh.success})}catch(S){const v=new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.STOP_FAILED,originalError:S});this._logger?.error(v.message),this.eventEmitter.emit("effectsError",v),this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:g,operation:cu.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Rh.failure,additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v)}})}}async dispose(){try{if(this.disposed)return void this._logger.info("VideoEffects feature already disposed");this._effect&&(await this.stopEffects(),this._effect._internalHandle.dispose(),this._effect=null),this.eventEmitter.removeAllListeners(),this._effectsStatusManager?.off("statusChanged",this.effectStatusChangedCallback),this.disposed=!0,this._logger.info("VideoEffects feature disposed")}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.DISPOSE_FAILED,originalError:g});this._logger?.error(m.message),this.eventEmitter.emit("effectsError",m)}}getEffectInternalCast(g){if("BackgroundBlur"===g?.name&&this.isValidEffectInstance(g))return g;if("BackgroundReplacement"===g?.name&&this.isValidEffectInstance(g))return g;throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.INVALID_EFFECT})}isValidEffectInstance(g){let m;return("BackgroundBlur"===g.name&&void 0!==g._internalHandle||"BackgroundReplacement"===g.name&&void 0!==g._internalHandle)&&(m=g,this.hasValidInternalHandle(m._internalHandle))}hasValidInternalHandle(g){return void 0!==g.effectConfig&&void 0!==g.getEffectProvider&&void 0!==g.dispose&&void 0!==g.getStats&&void 0!==g.setConfig}getTsCallingSupportedEffects(){const g=[];return Object.values(bg).forEach((m=>{(this._tsCallingEffectCapability&m.tsCallingEffect)===m.tsCallingEffect&&g.push(m)})),g}subscribeToEffectEvents(){this._effect&&this._internalDeviceManager?(this._effect._internalHandle.on("configUpdated",this.configUpdatedCallback),this._effect._internalHandle.on("processingError",this.processingErrorCallback)):this._logger.debug("No effect instance found.")}disposeEffectEventSubscriptions(){this._effect?(this._effect._internalHandle.off("configUpdated",this.configUpdatedCallback),this._effect._internalHandle.off("processingError",this.processingErrorCallback)):this._logger.debug("No effect instance found.")}subscribeToStreamInstanceEvents(){this.streamInstance.on("videoSourceChanged",(async g=>{g.source&&"Video"!==g.source.mediaStreamType&&await this.stopEffects()}))}handleEffectsInitTimeEvent(g,m){if(!this._effect)return void this._logger.debug("No effect active");const S=generateGuid(),v=m-g,C=this._effect._internalHandle.effectConfig.effectInitTimeThresholdInMs;if(this._logger.info(`Time for effects to start: ${v}ms`),C&&v>C){this.eventEmitter.emit("timeForEffectsWarningReached",this._effect.name);const g=this.getUsageDetailsForTelemetry(`Threshold value: ${C}ms`,this._effect.name);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:S,operation:cu.timeForEffectsWarningReached,additionalDetails:{usageDetails:g}})}}handleFpsWarningEvent(){if(!this._effect)return void this._logger.debug("No effect active");this.clearFpsCheckInterval();const g=getAcsEcsConfig(),m=generateGuid(),S=g.videoEffects.waitTimeToInitiateFpsChecksInMs,v=g.videoEffects.fpsCheckIntervalTimeInMs;this._fpsWarningThresholdValue=this._effect._internalHandle.effectConfig.fpsWarningThreshold??g.videoEffects.fpsWarningThreshold;const startFpsChecker=()=>{const g=window.setInterval((()=>{const S=this._effect?._internalHandle.getStats(),v=S?.processor.fpsAvg;if(this._logger.info(`Effects avg fps check interval poll. Current Avg - ${v}`),v&&v<this._fpsWarningThresholdValue){this.eventEmitter.emit("fpsWarningThresholdReached",this._effect?.name),window.clearInterval(g),this._logger.info(`Effects fps warning threshold hit at ${v}fps`);const S=this.getUsageDetailsForTelemetry(`Fps reported: ${v}, Fps warning threshold value: ${this._fpsWarningThresholdValue}`,this._effect?.name);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.fpsWarningThresholdReached,additionalDetails:{usageDetails:S}})}}),v);this._fpsWarningEventIntervalIds.push(g)},C=window.setTimeout(startFpsChecker,S);this._fpsWarningEventTimeoutIds.push(C)}setConfigForEffects(){if(!this._effect)return void this._logger.debug("No effect active");const g=this._effect._internalHandle.configProvider.config.videoEffects??this._effect._internalHandle.configProvider.config,m=getMediaConfig(),S=getAcsEcsConfig();if(m?.enableVideoEffects&&S?.videoEffects?.enableVideoEffects&&(g.enableVideoEffects=m.enableVideoEffects&&S.videoEffects.enableVideoEffects),g.effectConfig={...g.effectConfig,effectInitTimeThresholdInMs:S.videoEffects.effectInitTimeThresholdInMs,fpsWarningThreshold:S.videoEffects.fpsWarningThreshold},m.webcv){const S=m.webcv;g.webcvConfig={...g.webcvConfig,...S}}this._effect._internalHandle.setConfig(g),this._logger.info(`Config for effects set: ${stringifyObject(g)}`)}sendFeatureUsageTelemetry(g){if(this._telemetryLogManager)try{const m={correlationId:g.correlationId,mediaType:ou.VideoRaw,streamType:lu.Local,operation:g.operation,timestampInfo:g.timestampInfo||{},kindOfEvent:g.kindOfEvent||"",additionalDetails:g.additionalDetails||""};this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:m})}catch(m){this._logger.debug(`Unable to send ${g.operation} telemetry`)}else this._logger.debug("Telemetry error. Instance is undefined.")}getEffectNameForTelemetry(g){let m="UNKNOWN";return g?m="string"==typeof g?g:JSON.stringify(g):this._effect?.name?m=this._effect.name:this._activeEffects?.[0]&&(m=JSON.stringify(this._activeEffects[0])),m}getUsageDetailsForTelemetry(g,m=""){return`${m?`[${m}] `:""}${g}`}clearFpsCheckInterval(){this._fpsWarningEventIntervalIds.forEach((g=>{window.clearInterval(g)})),this._fpsWarningEventTimeoutIds.forEach((g=>{window.clearTimeout(g)})),this._fpsWarningEventIntervalIds=[],this._fpsWarningEventTimeoutIds=[]}updateEffectStatusManager(){this.streamInstance.canStartEffects?(this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this._effectsStatusManager||(this._effectsStatusManager=this._internalDeviceManager.callStackVideoEffectsStatusManager,this._effectsStatusManager.on("statusChanged",this.effectStatusChangedCallback)),this._activeEffects=this._effectsStatusManager.getActiveEffects()):this._logger.warn("Cannot update status manager, current source is not supported.")}}class ParticipantMappingManager$1{constructor(g){this._tsCall=g,this._activeParticipantMris=new Set,this._participantMriToSourceId=new Map,this._sourceIdToParticipantMri=new Map,this._sourceIdToParticipantId=new Map,this._listenerHandles=[],this._eventEmitter=new Su.EventEmitter,this._listenerHandles.push(this._tsCall.on("participantAdded",(g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g),this._eventEmitter.emit("participantAdded",g.id)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(g=>{this._activeParticipantMris.has(g.id)&&this._updateMapping(g)&&this._eventEmitter.emit("participantUpdated",g.id)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(g=>{this._activeParticipantMris.delete(g.id),this._removeMapping(g),this._eventEmitter.emit("participantRemoved",g.id)}))),this._tsCall.participants.forEach((g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g)}))}_updateMapping(g){const m=g.id,S=[];g.endpoints?.endpointDetails?.forEach((g=>{const m=g.mediaStreams?.find((g=>"data"===g.type));m&&(S.push(m.sourceId),this._sourceIdToParticipantId.set(m.sourceId,g.participantId))}));const v=this._participantMriToSourceId.get(m);return S.sort(),!P.isEqual(S,v)&&(this._participantMriToSourceId.set(m,S),S.forEach((g=>{this._sourceIdToParticipantMri.set(g,m)})),!0)}_removeMapping(g){const m=g.id,S=this._participantMriToSourceId.get(m)||[];this._participantMriToSourceId.delete(m),S.forEach((g=>{this._sourceIdToParticipantMri.delete(g),this._sourceIdToParticipantId.delete(g)}))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}findParticipantMri(g){let m=this._sourceIdToParticipantMri.get(g);return void 0===m&&this.isP2P()&&this._tsCall.participants.length&&(m=this._tsCall.participants[0].id),m}findParticipantId(g){let m=this._sourceIdToParticipantId.get(g);if(void 0===m&&this.isP2P()&&this._tsCall.participants.length&&this._tsCall.participants[0].endpoints?.endpointDetails.length){const g=this._tsCall.participants[0].endpoints?.endpointDetails[0];m=g.participantId}return m}findSourceIds(g){return this._participantMriToSourceId.get(g)??[]}isP2P(){return 1===this._tsCall.callType}dispose(){this._activeParticipantMris.clear(),this._participantMriToSourceId.clear(),this._sourceIdToParticipantMri.clear(),this._sourceIdToParticipantId.clear(),this._listenerHandles.forEach((g=>g.dispose())),this._eventEmitter.removeAllListeners()}}const Ag=2147483648,Rg=65535,Pg=1024,Mg=255,wg=8,Dg=64,Og=4294967295,Ng="Normal",kg="Durable",Lg=.4,Fg=.8;function invalidEventSubscription(g,m){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[m,g]})}function wrongArgumentType(g,m){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.WRONG_ARGUMENT_TYPE,defaultErrorMessageArgs:[g,m]})}function wrongArgumentValue(g,m){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.WRONG_ARGUMENT_VALUE,defaultErrorMessageArgs:[g,m]})}function dataChannelHasBeenDisposed(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.DISPOSED})}function senderIsNotReady(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.SENDER_NOT_READY})}function noAvailableChannelId(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.NO_AVAILABLE_CHANNEL_ID})}function invalidChannelId(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.INVALID_CHANNEL_ID})}function tooManyParticipants(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.TOO_MANY_PARTICIPANTS})}function noValidParticipants(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.NO_VALID_PARTICIPANT})}function messageDataIsEmpty(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.MSG_DATA_EMPTY})}function messageDataSizeIsTooLarge(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.MSG_DATA_TOO_LARGE})}function invalidMessageLength(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.INVALID_MSG_LENGTH})}function sendBufferIsFull(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.BUFFER_FULL})}function senderIsClosed(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.SENDER_CLOSED})}function noAvailableReliableDataId(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.NO_AVAILABLE_RELIABLE_CHANNEL})}function noAvailableUnreliableDataId(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.NO_AVAILABLE_UNRELIABLE_CHANNEL})}function channelHasBeenAllocated(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.CHANNEL_ALREADY_ALLOCATED})}function channelNotFound(g){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.CANT_FIND_CHANNEL_ID,defaultErrorMessageArgs:[g]})}function trafficLimited(){return new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.TRAFFIC_LIMITED})}function getErrorString(g){return g?.message??"Unknown"}function logError(g,m,S){const v=S.value;return S.value=function(...g){try{return v?.apply(this,g)}catch(g){throw this?._logger?.error(`${m}: ${getErrorString(g)}`),g}},S}function logErrorAsync(g,m,S){const v=S.value;return S.value=async function(...g){try{return await(v?.apply(this,g))}catch(g){throw this?._logger?.error(`${m}: ${getErrorString(g)}`),g}},S}class Message{constructor(){this._firstByte=0,this._channelVersion=0,this._channelId=0,this._sequenceNumber=0}static parse(g){if(g.length<Message.headerLength)throw invalidMessageLength();const m=new DataView(g.buffer),S=m.getUint8(0),v=m.getUint8(1),C=m.getUint16(2),_=m.getUint32(4),E=g.slice(Message.headerLength),T=new Message;return T._firstByte=S,T._channelVersion=v,T._channelId=C,T._sequenceNumber=_,T._data=E,T._serializedData=g,T}static create(g,m,S,v){const C=new Message,_=new Uint8Array(Message.headerLength+v.length),E=new DataView(_.buffer);return m&=255,g&=65535,S>>>=0,E.setUint8(0,0),E.setUint8(1,m),E.setUint16(2,g),E.setUint32(4,S),_.set(v,Message.headerLength),C._channelVersion=m,C._channelId=g,C._sequenceNumber=S,C._data=v,C._serializedData=_,C}get channelId(){return this._channelId}set channelId(g){this._channelId=g}get channelVersion(){return this._channelVersion}get sequenceNumber(){return this._sequenceNumber}get data(){return this._data}get serializedData(){return this._serializedData}isInternal(){return 0!=(128&this._firstByte)}isEmpty(){return 0===this._data.length}}var xg;Message.headerLength=wg,(xg=g.DataChannelState||(g.DataChannelState={}))[xg.Initializing=0]="Initializing",xg[xg.Initialized=1]="Initialized",xg[xg.Started=2]="Started",xg[xg.Stopped=3]="Stopped",xg[xg.Destroyed=4]="Destroyed";class DataChannelAdapter{constructor(m,S){this._eventEmitter=new Su.EventEmitter,this._state=g.DataChannelState.Initializing,this._tsCall=m,this._dataId=S}async initialize(){const m={onStarted:async(m,S,v)=>{this._dataSendFunction=S,this._getStats=v,this._state=g.DataChannelState.Started,this._eventEmitter.emit("stateChanged",this._state)},onStopped:async m=>{this._dataSendFunction=void 0,this._getStats=void 0,this._state=g.DataChannelState.Stopped,this._eventEmitter.emit("stateChanged",this._state)},onDataReceived:async(g,m,S)=>{const v={sourceId:S,data:m};this._eventEmitter.emit("message",v)}};await(this._tsCall.dataChannelAdapter?.addHandler(this._dataId,m)),this._state<g.DataChannelState.Initialized&&(this._state=g.DataChannelState.Initialized)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}send(g,m){return this._dataSendFunction?this._dataSendFunction(g,m):Promise.reject(senderIsNotReady())}getStats(){return this._getStats?this._getStats():Promise.resolve({bufferSize:0,remainingBytes:0,remainingPackets:0})}get state(){return this._state}dispose(){if(this._state===g.DataChannelState.Destroyed)return;const m=this._state;this._state=g.DataChannelState.Destroyed,this._dataSendFunction=void 0,this._getStats=void 0,m!==g.DataChannelState.Initializing&&this._tsCall.dataChannelAdapter?.removeHandler(this._dataId).catch(noop),this._eventEmitter.emit("stateChanged",this._state),this._eventEmitter.removeAllListeners()}}class DataChannelProcessor{constructor(g,m,S){const v=g.dataId;this._logger=S.createChild(`DataChannelProcessor(${v})`),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogOn:!1,enableLogOff:!1,enableLogOnce:!1,enableLogEmit:!1}),this._bufferFullErrorMessage=`dataId ${v} send queue is full`,this._dataChannelAdapter=new DataChannelAdapter(m,v),this._dataChannelAdapter.on("message",(g=>{try{const m=g.sourceId,S=Message.parse(g.data),v={sourceId:m,message:S};S.isInternal()?this._eventEmitter.emit("internalMessage",v):this._eventEmitter.emit("message",v)}catch(g){this._logger.error(`process message error: ${getErrorString(g)}`)}}))}async initialize(){await this._dataChannelAdapter.initialize()}async send(g){try{if(void 0===g.recipients)throw noValidParticipants();if(g.recipients.length>Dg)throw tooManyParticipants();await this._dataChannelAdapter.send(g.data,g.recipients)}catch(g){throw g?.message===this._bufferFullErrorMessage?sendBufferIsFull():new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.SEND_FAIL,originalError:g})}}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._eventEmitter.removeAllListeners(),this._dataChannelAdapter.dispose()}}class RecipientsManager{constructor(g){this._sourceIds=[],this._participantMappingManager=g,this._participantMapping=new Map,g.on("participantAdded",(g=>{if(this._participantMapping.has(g)){const m=this._participantMappingManager.findSourceIds(g);this._participantMapping.set(g,m),this._updateSourceIds()}})),g.on("participantUpdated",(g=>{if(this._participantMapping.has(g)){const m=this._participantMappingManager.findSourceIds(g);this._participantMapping.set(g,m),this._updateSourceIds()}})),g.on("participantRemoved",(g=>{this._participantMapping.has(g)&&(this._participantMapping.set(g,[]),this._updateSourceIds())}))}get sourceIds(){if(this._participantMappingManager.isP2P()||!(this._participantMapping.size>0)||0!==this._sourceIds.length)return this._sourceIds}setParticipants(g){const m=[];g.forEach((g=>{validateIdentifier(g),m.push(getMriFromIdentifier(g))})),this._participantMapping.clear(),m.forEach((g=>{const m=this._participantMappingManager.findSourceIds(g);this._participantMapping.set(g,m)})),this._updateSourceIds()}_updateSourceIds(){this._sourceIds=Array.from(this._participantMapping.values()).flat()}}var Ug,__decorate$7=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$7=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};!function(g){g[g.Open=0]="Open",g[g.Closed=1]="Closed",g[g.Destroyed=2]="Destroyed"}(Ug||(Ug={}));class DataChannelSenderImpl{constructor(g,m,S,v,C,_){this._state=Ug.Open;const E=getAcsEcsConfig().dataChannel;this._eventEmitter=new Su.EventEmitter,this._channelId=g,this._channelVersion=m,this._sequenceNumber=Math.floor(Math.random()*(Og+1)),this._recipientsManager=new RecipientsManager(v),this._dataChannelMonitor=C,this._sendMessageFunction=S,this._maxMessageSize=E.maxMessageSize,this._logger=_.createChild(`DataChannelSender(${g},${m})`),this._logger.info("opened")}get channelId(){return this._channelId}get maxMessageSize(){return this._maxMessageSize}setParticipants(g){if(!Array.isArray(g))throw wrongArgumentType("participants","CommunicationIdentifier[]");if(g.length>Dg)throw tooManyParticipants();this._recipientsManager.setParticipants(g),this._logger.info(`participant size: ${g.length}`)}async sendMessage(g){if(this._dataChannelMonitor.updateAttemptStats(g.length),!(g instanceof Uint8Array))throw wrongArgumentType("data","Uint8Array");if(this._state===Ug.Closed)throw senderIsClosed();if(0===g.length)throw messageDataIsEmpty();if(g.length>this._maxMessageSize)throw messageDataSizeIsTooLarge();const m=this._recipientsManager.sourceIds;await this._sendMessage(g,m),this._dataChannelMonitor.updateCommitStats(g.length)}close(){this._state<Ug.Closed&&(this._sendMessage(new Uint8Array,[]).catch(noop),this._state=Ug.Closed,this._eventEmitter.emit("close"),this._logger.info("closed"),this._dataChannelMonitor.close())}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this.close(),this._state!==Ug.Destroyed&&(this._eventEmitter.removeAllListeners(),this._state=Ug.Destroyed,this._logger.info("disposed"))}get channelVersion(){return this._channelVersion}get state(){return this._state}async _sendMessage(g,m){const S=Message.create(this._channelId,this._channelVersion,this._sequenceNumber,g);this._sequenceNumber=(this._sequenceNumber+1)%(Og+1);const v={channelId:this._channelId,channelVersion:this._channelVersion,recipients:m,data:S.serializedData};await this._sendMessageFunction(v)}}__decorate$7([logError,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[Array]),__metadata$7("design:returntype",void 0)],DataChannelSenderImpl.prototype,"setParticipants",null),__decorate$7([logErrorAsync,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[Uint8Array]),__metadata$7("design:returntype",Promise)],DataChannelSenderImpl.prototype,"sendMessage",null),__decorate$7([logError,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[]),__metadata$7("design:returntype",void 0)],DataChannelSenderImpl.prototype,"close",null),__decorate$7([logError,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[]),__metadata$7("design:returntype",void 0)],DataChannelSenderImpl.prototype,"dispose",null);class Node$1{constructor(g){this.value=g,this.next=void 0}}class Queue{constructor(){this.length=0,this.front=void 0,this.rear=void 0}enqueue(g){const m=new Node$1(g);this.front?(this.rear.next=m,this.rear=m):(this.front=m,this.rear=m),this.length++}dequeue(){if(!this.front)return;const g=this.front;return this.front===this.rear?(this.front=void 0,this.rear=void 0):this.front=this.front.next,this.length--,g.value}peek(){return this.front?.value}size(){return this.length}back(){return this.rear?.value}isEmpty(){return 0===length}clear(){this.front=void 0,this.rear=void 0,this.length=0}}var Vg,__decorate$8=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$8=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};!function(g){g[g.Open=0]="Open",g[g.Closed=1]="Closed",g[g.Destroyed=2]="Destroyed"}(Vg||(Vg={}));class DataChannelReceiverImpl{constructor(g,m,S,v,C,_){this._receiveBuffers=new Queue,this._remainingBytes=0,this._state=Vg.Open,this._channelVersion=0;const E=getAcsEcsConfig().dataChannel;this._logger=_.createChild(`DataChannelReceiver(${g},${v},${S})`),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._maxBufferSize=E.maxReceiveBufferSize,this._dataChannelMonitor=C,this._channelId=g,this._senderParticipantIdentifier=constructIdentifierKindFromMri(m),this._channelVersion=v,this._lastMessageTimestamp=Date.now(),this._logger.info("created.")}get channelId(){return this._channelId}get senderParticipantIdentifier(){return this._senderParticipantIdentifier}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}readMessage(){const g=this._receiveBuffers.dequeue();return g?.data&&(this._remainingBytes-=g.data.length),g}dispose(){this._state!==Vg.Destroyed&&(this.close(),this._state=Vg.Destroyed,this._receiveBuffers.clear(),this._eventEmitter.removeAllListeners())}close(){this._state===Vg.Open&&(this._state=Vg.Closed,this._eventEmitter.emit("close"),this._dataChannelMonitor.close())}get channelVersion(){return this._channelVersion}get lastMessageTimestamp(){return this._lastMessageTimestamp}get state(){return this._state}appendMessage(g){if(this._dataChannelMonitor.updateAttemptStats(g.data.length),this._state!==Vg.Open)return;if(0===g.data.length)return void this.close();if(this._lastMessageTimestamp=Date.now(),this._remainingBytes+g.data.length>this._maxBufferSize)return;const m={sequenceNumber:g.sequenceNumber,data:g.data};this._receiveBuffers.enqueue(m),this._remainingBytes+=g.data.length,this._eventEmitter.emit("messageReady"),this._dataChannelMonitor.updateCommitStats(g.data.length)}}function logSenderOptions(g){const m=[];return void 0!==g.bitrateInKbps&&m.push(`bitrateInKbps=${g.bitrateInKbps}`),void 0!==g.channelId&&m.push(`channelId=${g.channelId}`),void 0!==g.participants&&m.push(`participants size=${g.participants.length}`),void 0!==g.priority&&m.push(`priority=${g.priority}`),void 0!==g.reliability&&m.push(`reliability=${g.reliability}`),m.join(",")}function compareChannelVersion(g,m){if(g===m)return 0;if(-1===m)return 1;const S=g-m;return S>0?S<Mg/2?1:-1:-S>Mg/2?1:-1}function nextChannelVersion(g){return g===Mg?0:g+1}__decorate$8([logError,__metadata$8("design:type",Function),__metadata$8("design:paramtypes",[]),__metadata$8("design:returntype",Object)],DataChannelReceiverImpl.prototype,"readMessage",null),__decorate$8([logError,__metadata$8("design:type",Function),__metadata$8("design:paramtypes",[Message]),__metadata$8("design:returntype",void 0)],DataChannelReceiverImpl.prototype,"appendMessage",null);class DataChannelReceiversManager{constructor(g,m,S){this._timeoutHandle=0;const v=getAcsEcsConfig().dataChannel;this._eventEmitter=new Su.EventEmitter,this._participantMappingManager=g,this._dataChannelMonitor=m,this._logger=S,this._receivers=new Map,this._lastestVersion=new Map,this._receiveTimeoutInMs=v.receiveTimeoutInMs}_checkTimeoutReceivers(){Array.from(this._receivers.keys()).forEach((g=>{const m=this._receivers.get(g);if(void 0!==m){Date.now()-m.lastMessageTimestamp>=this._receiveTimeoutInMs&&m.close()}})),this._receivers.size>0&&(this._timeoutHandle=window.setTimeout((()=>{this._timeoutHandle=0,this._checkTimeoutReceivers(),Math.ceil(this._receiveTimeoutInMs/2)})))}appendMessage(g){const m=`${g.sourceId},${g.message.channelId}`,S=`${g.sourceId},${g.message.channelId},${g.message.channelVersion}`;let v=this._lastestVersion.get(m),C=this._receivers.get(S);const _=g.message;if(void 0===C){if(void 0!==v){if(-1===compareChannelVersion(_.channelVersion,v))return}if(this._lastestVersion.set(m,_.channelVersion),_.isEmpty())return;if(0===this._eventEmitter.listenerCount("dataChannelReceiverCreated"))return;const E=this._participantMappingManager.findParticipantMri(g.sourceId)??"",T=this._participantMappingManager.findParticipantId(g.sourceId)??"",I=this._dataChannelMonitor.createReceiverMonitor(_.channelId,_.channelVersion,T);this._logger.info(`channelId:${_.channelId} message from ${T}, sourceId:${g.sourceId}, channelVersion:${_.channelVersion}`),C=new DataChannelReceiverImpl(_.channelId,E,g.sourceId,_.channelVersion,I,this._logger),C.on("close",(()=>{this._receivers.delete(S)})),this._receivers.set(S,C),this._eventEmitter.emit("dataChannelReceiverCreated",C),0===this._timeoutHandle&&this._checkTimeoutReceivers()}C.appendMessage(_),_.isEmpty()&&this._receivers.delete(S)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){window.clearTimeout(this._timeoutHandle),this._timeoutHandle=0,this._receivers.forEach(((g,m)=>{g.dispose()})),this._lastestVersion.clear(),this._receivers.clear(),this._eventEmitter.removeAllListeners()}}const Bg=Rg-Pg+1;class RandomPickStrategy{constructor(g){this._channelIdsInUse=g}findAvailableChannelId(){if(this._channelIdsInUse.size>=Bg)throw noAvailableChannelId();const genId=()=>Math.floor(Math.random()*Bg)+Pg;let g;for(;(g=genId())&&this._channelIdsInUse.has(g););return g}}class ShuffleArrayStrategy{constructor(g){this._availableChannelIds=[],this._channelIdsInUse=g,this._initArray()}findAvailableChannelId(){if(0===this._availableChannelIds.length){if(this._channelIdsInUse.size>=Bg)throw noAvailableChannelId();this._initArray()}return this._availableChannelIds.pop()}_initArray(){const g=Array.from(this._channelIdsInUse,(g=>g)).sort();let m=0,S=0;for(;m<=Rg&&S<g.length;)m<g[S]?(this._availableChannelIds.push(m),m++):(m>g[S]||m++,S++);for(;m<=Rg;)this._availableChannelIds.push(m),m++;this._availableChannelIds=P.shuffle(this._availableChannelIds)}}class RandomChannelIdManager{constructor(){this._channelIdsInUse=new Set,this._highWaterMark=Math.ceil(Bg*Fg),this._lowWaterMark=Math.floor(Bg*Lg),this._strategy=new RandomPickStrategy(this._channelIdsInUse)}addChannelId(g){g>=Pg&&g<=Rg&&(this._channelIdsInUse.add(g),this._channelIdsInUse.size>=this._highWaterMark&&this._strategy instanceof RandomPickStrategy&&(this._strategy=new ShuffleArrayStrategy(this._channelIdsInUse)))}removeChannelId(g){this._channelIdsInUse.delete(g),this._channelIdsInUse.size<this._lowWaterMark&&this._strategy instanceof ShuffleArrayStrategy&&(this._strategy=new RandomPickStrategy(this._channelIdsInUse))}findAvailableChannelId(){return this._strategy.findAvailableChannelId()}}class DurableDataIdResourceManager{constructor(g){this._dataIds=[],this._channelIds=new Map,g.forEach((g=>{this._dataIds.push({dataId:g.dataId,bandwidth:g.bandwidth,allocatedBandwidth:0})}))}allocate(g){const m=P.maxBy(this._dataIds,(m=>1-(m.allocatedBandwidth+g.bitrate)/m.bandwidth));if(void 0===m)throw noAvailableReliableDataId();return m.allocatedBandwidth+=g.bitrate,this._channelIds.set(g.channelId,{dataId:m.dataId,allocatedBandwidth:g.bitrate}),m.dataId}deallocate(g){const m=this._channelIds.get(g);if(void 0!==m){const S=this._dataIds.find((g=>g.dataId===m.dataId));void 0!==S&&(S.allocatedBandwidth-=m.allocatedBandwidth),this._channelIds.delete(g)}}getDataIds(g){const m=this._channelIds.get(g);return void 0!==m?[m.dataId]:[]}}function isPowerOf2(g){if(g.find((g=>!Number.isInteger(Math.log2(g)))))return!1;for(let m=1;m<g.length;m++)if(g[m]!==2*g[m-1])return!1;return!0}class DataIdSelectionNullStrategy{getDataIds(g){throw noAvailableUnreliableDataId()}getAllSum(){return 0}}class DataIdSelectionPower2Strategy{constructor(g){this._acsDataIdConfigs=[],this._bandwidthList=[],this._acsDataIdConfigs=g,g.forEach((g=>{this._bandwidthList.push(g.bandwidth/1e3)})),this._allSum=P.sumBy(g,(g=>g.bandwidth))}getDataIds(g){let m=[];const S=Math.ceil(g/1e3);if(S>=this._allSum)m=this._acsDataIdConfigs.map((g=>g.dataId));else{const g=this._bandwidthList[0]-1;let v=0;0!=(S&g)&&(v=this._bandwidthList.findIndex((g=>0==(g&S))),-1!==v&&(m.push(this._acsDataIdConfigs[v].dataId),v++));for(let g=v;g<this._bandwidthList.length;g++)this._bandwidthList[g]&S&&m.push(this._acsDataIdConfigs[g].dataId)}return m}getAllSum(){return this._allSum}}function powerSet(g){const m=[[]];return g.forEach((g=>{const S=[];m.forEach((m=>{S.push([...m,g])})),m.push(...S)})),m}class DataIdSelectionPowerSetSumStrategy{constructor(g){this._bandwidthMap=new Map,this._bandwidthMap.set(0,[]);powerSet(g).forEach((g=>{const m=P.sumBy(g,(g=>g.bandwidth)),S=this._bandwidthMap.get(m);(void 0===S||g.length<S.length)&&this._bandwidthMap.set(m,g.map((g=>g.dataId)))})),this._bandwidthList=Array.from(this._bandwidthMap.keys()).sort(((g,m)=>g-m))}getDataIds(g){const m=P.sortedIndex(this._bandwidthList,g),S=this._bandwidthList[m]??this._bandwidthList[this._bandwidthList.length-1];return this._bandwidthMap.get(S)||[]}getAllSum(){return P.last(this._bandwidthList)||0}}class BandwidthTable{constructor(g){(g=P.sortBy(g,(g=>g.bandwidth))).length?isPowerOf2(g.map((g=>g.bandwidth/1e3)))?this._dataIdSelectionStrategy=new DataIdSelectionPower2Strategy(g):this._dataIdSelectionStrategy=new DataIdSelectionPowerSetSumStrategy(g):this._dataIdSelectionStrategy=new DataIdSelectionNullStrategy}getDataIds(g){return this._dataIdSelectionStrategy.getDataIds(g)}getAllSum(){return this._dataIdSelectionStrategy.getAllSum()}}class LossyDataIdResourceManager{constructor(g){this._totalNormalPriorityBandwidth=0,this._totalHighPriorityBandwidth=0,this._configs=new Map,this._currentNormalPriorityDataIds=[],this._currentHighPriorityDataIds=[],this._normalPriorityTable=new BandwidthTable(g.filter((g=>"normal"===g.priority))),this._highPriorityTable=new BandwidthTable(g.filter((g=>"high"===g.priority)))}allocate(g){this._configs.set(g.channelId,g),"Normal"===g.priority?this._totalNormalPriorityBandwidth+=g.bitrate:"High"===g.priority&&(this._totalHighPriorityBandwidth+=g.bitrate),this._updateDataIds()}deallocate(g){const m=this._configs.get(g);void 0!==m&&(this._configs.delete(g),"Normal"===m.priority?this._totalNormalPriorityBandwidth-=m.bitrate:"High"===m.priority&&(this._totalHighPriorityBandwidth-=m.bitrate),this._updateDataIds())}getDataIds(g){const m=this._configs.get(g);if(void 0!==m){if("Normal"===m.priority)return this._currentNormalPriorityDataIds;if("High"===m.priority)return this._currentHighPriorityDataIds}return[]}_updateDataIds(){const g=this._highPriorityTable.getAllSum(),m=this._totalHighPriorityBandwidth-g;if(m>0){const g=this._totalNormalPriorityBandwidth+m;this._currentNormalPriorityDataIds=this._normalPriorityTable.getDataIds(g),this._currentHighPriorityDataIds=this._highPriorityTable.getDataIds(this._totalHighPriorityBandwidth).concat(this._currentNormalPriorityDataIds)}else this._currentNormalPriorityDataIds=this._normalPriorityTable.getDataIds(this._totalNormalPriorityBandwidth),this._currentHighPriorityDataIds=this._highPriorityTable.getDataIds(this._totalHighPriorityBandwidth)}}class DataIdMappingManager{constructor(g){const m=g.filter((g=>"reliable"===g.category)),S=g.filter((g=>"unicast"===g.category)),v=g.filter((g=>"broadcast"===g.category));this._reliableDataIdManager=new DurableDataIdResourceManager(m),this._unicastDataIdManager=new LossyDataIdResourceManager(S),this._broadcastDataIdManager=new LossyDataIdResourceManager(v),this._configs=new Map}allocate(g){let m=-1;if(this._configs.has(g.channelId))throw channelHasBeenAllocated();try{"Durable"===g.reliability?m=this._reliableDataIdManager.allocate(g):(this._unicastDataIdManager.allocate(g),this._broadcastDataIdManager.allocate(g)),this._configs.set(g.channelId,g)}catch(m){throw"Durable"===g.reliability?this._reliableDataIdManager.deallocate(g.channelId):(this._unicastDataIdManager.deallocate(g.channelId),this._broadcastDataIdManager.deallocate(g.channelId)),m}return m}deallocate(g){const m=this._configs.get(g);void 0!==m&&("Durable"===m.reliability?this._reliableDataIdManager.deallocate(g):(this._unicastDataIdManager.deallocate(g),this._broadcastDataIdManager.deallocate(g)),this._configs.delete(g))}getDataIdToSend(g,m,S){const v=this._configs.get(g);if(void 0!==v)return"Durable"===v.reliability?this._reliableDataIdManager.getDataIds(g):S?this._broadcastDataIdManager.getDataIds(g):this._unicastDataIdManager.getDataIds(g);throw channelNotFound(g)}}class DataChannelSendRecvMonitor{constructor(g){this._attemptCount=0,this._attemptBytes=0,this._commitCount=0,this._commitBytes=0,this._dataChannelTelemetryLogger=g,this._openTime=new Date,this._closeTime=this._openTime}updateAttemptStats(g){this._attemptCount++,this._attemptBytes+=g}updateCommitStats(g){this._commitCount++,this._commitBytes+=g}close(){this._closeTime=new Date}}class DataChannelSenderMonitor extends DataChannelSendRecvMonitor{constructor(g,m,S,v){super(v),this._channelId=g,this._channelVersion=m,this._correlationId=S}close(){super.close();const g={direction:"send",channelId:this._channelId,channelVersion:this._channelVersion,openTime:this._openTime,closeTime:this._closeTime,attemptCount:this._attemptCount,attemptBytes:this._attemptBytes,commitCount:this._commitCount,commitBytes:this._commitBytes,correlationId:this._correlationId};this._dataChannelTelemetryLogger.sendStatsEvent(g)}}class DataChannelReceiverMonitor extends DataChannelSendRecvMonitor{constructor(g,m,S,v){super(v),this._channelId=g,this._channelVersion=m,this._remoteParticipantId=S}close(){super.close();const g={direction:"recv",channelId:this._channelId,channelVersion:this._channelVersion,openTime:this._openTime,closeTime:this._closeTime,attemptCount:this._attemptCount,attemptBytes:this._attemptBytes,commitCount:this._commitCount,commitBytes:this._commitBytes,remoteParticipantId:this._remoteParticipantId};this._dataChannelTelemetryLogger.sendStatsEvent(g)}}class DataChannelMonitor{constructor(g){this._dataChannelTelemetryLogger=g}createSenderMonitor(g,m,S){return new DataChannelSenderMonitor(g,m,S,this._dataChannelTelemetryLogger)}createReceiverMonitor(g,m,S){return new DataChannelReceiverMonitor(g,m,S,this._dataChannelTelemetryLogger)}}class PacketRateLimiter{constructor(g){this._timeBucket=0,this._maxPacketRate=0,this._packetCount=0,this._maxPacketRate=g}canSend(g){let m=Math.ceil(g/1200);const S=window.performance.now();return Math.floor(S/1e3)==this._timeBucket&&(m+=this._packetCount),m<=this._maxPacketRate}update(g){let m=Math.ceil(g/1200);const S=window.performance.now(),v=Math.floor(S/1e3);v!==this._timeBucket&&(this._timeBucket=v,this._packetCount=0),this._packetCount+=m}}class BitrateLimiter{constructor(g){this._endTime=0,this._maxDataRate=0,this._maxDataRate=g/8}canSend(g){if(0===this._maxDataRate)return!0;const m=window.performance.now(),S=(this._endTime-m)/1e3;return!(S>0)||S+g/this._maxDataRate<=1}update(g){const m=window.performance.now(),S=this._maxDataRate?g/this._maxDataRate*1e3:0;this._endTime<m?this._endTime=m+S:this._endTime+=S}changeBitrate(g){this._maxDataRate=g/8}}class BitrateCalculator{constructor(){this._totalBytes=0,this._lastUpdateTime=window.performance.now(),this._lastUpdateBytes=0,this._currentBitrate=0}getBitrate(){return this._currentBitrate}update(g){this._totalBytes+=g}calculateBitrate(){const g=window.performance.now();g-this._lastUpdateTime>0&&(this._currentBitrate=8*(this._totalBytes-this._lastUpdateBytes)/(g-this._lastUpdateTime)),this._lastUpdateTime=g,this._lastUpdateBytes=this._totalBytes}}class SendTrafficLimiter{constructor(g,m){this._availableBytes=0,this._reducedBytes=0,this._lastUpdateTime=window.performance.now(),this._packetRateLimiter=new PacketRateLimiter(m),this._receiveBitrate=new BitrateCalculator,this._bitrateTimer=window.setInterval((()=>{this._receiveBitrate.calculateBitrate();const m=window.performance.now(),S=(m-this._lastUpdateTime)/1e3;this._availableBytes=g/8*S,this._reducedBytes=.8*this._receiveBitrate.getBitrate()/8*S,this._lastUpdateTime=m}),1e3)}canSend(g,m){return m?!!this._packetRateLimiter.canSend(g)&&this._availableBytes-this._reducedBytes>=g:this._availableBytes>=g}updateSendBytes(g,m){m&&this._packetRateLimiter.update(g),this._availableBytes-=g}updateReceiveBytes(g){this._receiveBitrate.update(g)}dispose(){window.clearInterval(this._bitrateTimer)}}var Hg,$g;!function(g){g[g.Initializing=0]="Initializing",g[g.Initialized=1]="Initialized",g[g.Destroyed=2]="Destroyed"}(Hg||(Hg={}));class DataChannelManager{constructor(g,m,S){this._state=Hg.Initializing,this._initializedDefer=defer$1();const v=getAcsEcsConfig();this._logger=m,this._tsCall=g,this._dataChannelTelemtryLogger=S,this._participantMappingManager=new ParticipantMappingManager$1(g),this._dataChannelMonitor=new DataChannelMonitor(S),this._senders=new Map,this._receiversManager=new DataChannelReceiversManager(this._participantMappingManager,this._dataChannelMonitor,m),this._processors=new Map,this._channelVersions=new Map,this._randomChannelIdManager=new RandomChannelIdManager,this._dataIds=new Map,v.dataChannel.dataIdConfigs.forEach((g=>{const m=this._dataIds.get(g.dataId)??[];m.push(g.raw?{dataId:g.dataId,raw:g.raw}:{dataId:g.dataId,raw:g.raw,bandwidth:g.bandwidth??0,priority:g.priority??"normal",category:g.category??"reliable"}),this._dataIds.set(g.dataId,m)})),this._rateLimiters=new Map,this._sendTrafficLimiter=new SendTrafficLimiter(v.dataChannel.maxSendBandwidth,v.dataChannel.maxBroadcastPacketRate),this._enableBroadcastLimitOnReliableChannel=v.dataChannel.enableBroadcastLimitOnReliableChannel}async initialize(){const createProcessor=async g=>{const m=new DataChannelProcessor(g,this._tsCall,this._logger);return m.on("message",(m=>{const S=m.message;g.raw?S.channelId=g.dataId+Ag:this._sendTrafficLimiter.updateReceiveBytes(S.data.length);try{this._receiversManager.appendMessage(m)}catch(m){this._logger.error(`Failed to appendMessage on dataId ${g.dataId}: ${getErrorString(m)}`)}})),await m.initialize(),m},g=[],m=new Map,S=Array.from(this._dataIds.keys());for(let v=0;v<S.length;v++){const C=S[v],_=this._dataIds.get(C)[0];try{const g=await createProcessor(_);m.set(C,g)}catch(m){g.push(C),this._dataIds.delete(C)}}const v=P.flatten(Array.from(this._dataIds.values())).filter((g=>!g.raw));this._dataIdMappingManager=new DataIdMappingManager(v),this._state===Hg.Initializing?(this._processors=m,v.forEach((g=>{this._rateLimiters.has(g.dataId)||this._rateLimiters.set(g.dataId,new BitrateLimiter(g.bandwidth))})),g.length&&this._dataChannelTelemtryLogger.sendCreateProcessorEvent({kindOfEvent:"failure",dataIds:g}),this._state=Hg.Initialized,this._initializedDefer.resolve()):m.forEach((g=>{g.dispose()}))}createSender(g,m){let S=g.channelId,v=!1;if(S>=Ag){if(!0!==this._dataIds.get(S-Ag)?.[0].raw)throw invalidChannelId();v=!0}else{if(S<0||S>Rg)throw invalidChannelId();0===S&&(S=this._randomChannelIdManager.findAvailableChannelId())}this._senders.get(S)?.close();const C=nextChannelVersion(this._channelVersions.get(S)??-1);let _=S>=Ag?S-Ag:-1,E=!1;-1===_&&this._state===Hg.Initialized&&(_=this._dataIdMappingManager.allocate({channelId:S,reliability:g.reliability,priority:g.priority,bitrate:1e3*g.bitrateInKbps}),E=!0);const sendFunction=async m=>{const C=m.data.length;if(-1===_&&!E){if(C===wg)return;await this._initializedDefer.promise,E||(_=this._dataIdMappingManager.allocate({channelId:S,reliability:g.reliability,priority:g.priority,bitrate:1e3*g.bitrateInKbps}),E=!0)}const T=0===m.recipients?.length&&!this._participantMappingManager.isP2P();if(-1!==_)if(this._enableBroadcastLimitOnReliableChannel&&T&&!v){if(!this._sendTrafficLimiter.canSend(C,T))throw trafficLimited();const g=this._processors.get(_);await(g?.send(m)),this._sendTrafficLimiter.updateSendBytes(C,T)}else{const g=this._processors.get(_);await(g?.send(m))}else{const v=this._dataIdMappingManager.getDataIdToSend(S,C,T);try{const S=!this._sendTrafficLimiter.canSend(C,T);if(S&&"High"!==g.priority)throw trafficLimited();if(0===v.length)throw noAvailableUnreliableDataId();for(let g=0;g<v.length;g++)try{const _=v[g],E=this._dataIds.get(_)[0];if(S&&"normal"===E.priority)continue;const I=this._rateLimiters.get(_);if(I?.canSend(C)??!0){const g=this._processors.get(_);return await(g?.send(m)),I?.update(C),void this._sendTrafficLimiter.updateSendBytes(C,T)}}catch(g){}throw trafficLimited()}catch(g){this._logger.error(`Failed to send channelId ${S} message: ${getErrorString(g)}`)}}},T=this._dataChannelMonitor.createSenderMonitor(S,C,m),I=new DataChannelSenderImpl(S,C,sendFunction,this._participantMappingManager,T,this._logger);return I.on("close",(()=>{E&&this._dataIdMappingManager.deallocate(S),this._randomChannelIdManager.removeChannelId(S),this._senders.delete(S),setTimeout((()=>I.dispose()),0)})),void 0!==g.participants&&I.setParticipants(g.participants),this._senders.set(S,I),this._randomChannelIdManager.addChannelId(S),this._channelVersions.set(S,C),I}on(g,m){"dataChannelReceiverCreated"===g&&this._receiversManager.on("dataChannelReceiverCreated",m)}off(g,m){"dataChannelReceiverCreated"===g&&this._receiversManager.off("dataChannelReceiverCreated",m)}dispose(){this._state!==Hg.Destroyed&&(this._state=Hg.Destroyed,this._initializedDefer.isPending()&&this._initializedDefer.reject(dataChannelHasBeenDisposed()),this._senders.forEach((g=>{g.dispose()})),this._receiversManager.dispose(),this._processors.forEach((g=>{g.dispose()})),this._sendTrafficLimiter.dispose(),this._participantMappingManager.dispose())}}class DataChannelTelemetryLogger{constructor(g,m){this._tsCall=g,this._telemetryLogManager=m}sendStatsEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId},...g};this._telemetryLogManager.sendEvent({name:Ah.acs_calling_datachannel_stats,tenant:Qa,properties:m})}sendCreateSenderEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,operation:"createSender"},...g};this._telemetryLogManager.sendEvent({name:Ah.acs_calling_datachannel,tenant:Qa,properties:m})}sendCreateProcessorEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,operation:"createProcessor"},...g};this._telemetryLogManager.sendEvent({name:Ah.acs_calling_datachannel,tenant:Qa,properties:m})}}class DataChannelCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g)}createDataChannelSender(g){const m=generateGuid(),S=getAcsEcsConfig();try{if(void 0!==g.bitrateInKbps&&"number"!=typeof g.bitrateInKbps)throw wrongArgumentType("bitrateInKbps","number");if(void 0!==g.channelId&&"number"!=typeof g.channelId)throw wrongArgumentType("channelId","number");if(void 0!==g.participants&&!Array.isArray(g.participants))throw wrongArgumentType("participants","CommunicationIdentifier[]");if(void 0!==g.priority&&-1===["High","Normal"].indexOf(g.priority))throw wrongArgumentValue("priority","High,Normal");if(void 0!==g.reliability&&-1===["Durable","Lossy"].indexOf(g.reliability))throw wrongArgumentValue("reliability","Durable,Lossy");const v={bitrateInKbps:Math.ceil(g.bitrateInKbps??S.dataChannel.defaultBitrate/1e3),channelId:g.channelId??0,participants:g.participants??[],priority:g.priority??Ng,reliability:g.reliability??kg};this._logger.info(`createDataChannelSender: ${logSenderOptions(g)}`),this._sendFeatureUsage("createDataChannelSender",Rh.attempt),this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"attempt",correlationId:m,senderOptions:{channelId:g.channelId,bitrateInKbps:g.bitrateInKbps,participantsSize:g.participants?.length,priority:g.priority,reliability:g.reliability}});const C=this._dataChannelManager.createSender(v,m);return this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"success",correlationId:m,senderOptions:{channelId:C.channelId,bitrateInKbps:v.bitrateInKbps,participantsSize:v.participants?.length,priority:v.priority,reliability:v.reliability}}),this._logger.info(`The sender is created. channel id=${C.channelId}`),this._sendFeatureUsage("createDataChannelSender",Rh.success),C}catch(g){const S=new CallingCommunicationError({defaultError:D.FEATURES.DATA_CHANNEL.FAILED_TO_CREATE_SENDER,originalError:g});throw this._logger.info(`Failed to create the sender: ${S.message}`),this._sendFeatureUsage("createDataChannelSender",Rh.failure),this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"failure",correlationId:m,failureReason:S.message,additionalDetails:{...extractCommunicationServicesErrorForTelemetry(S)}}),S}}async createDataChannelAdapter(g){const m=new DataChannelAdapter(this._tsCall,g);return await m.initialize(),m}initialize(g,m){this._tsCall=g.tsCall,this._logger=m.createChild("DataChannelCallFeature"),this._telemetryLogManager=g.telemetryLogManager,this._dataChannelTelemetryLogger=new DataChannelTelemetryLogger(this._tsCall,this._telemetryLogManager);const S=new DataChannelManager(this._tsCall,this._logger,this._dataChannelTelemetryLogger);this._dataChannelManager=S,this._dataChannelManager.initialize().then((()=>{this._sendFeatureUsage("initialize",Rh.initialize)})).catch((g=>{this._logger.error(`initialize:${getErrorString(g)}`)}))}get name(){return this._sendFeatureUsage("name",Rh.getter),"DataChannel"}dispose(){this.disposed||(this._dataChannelManager?.dispose(),super.dispose())}on(g,m){if("dataChannelReceiverCreated"!==g)throw invalidEventSubscription(g,"subscribe");this._sendFeatureUsage(g,Rh.subscribe),"dataChannelReceiverCreated"===g&&this._dataChannelManager?.on("dataChannelReceiverCreated",m)}off(g,m){if("dataChannelReceiverCreated"!==g)throw invalidEventSubscription(g,"unsubscribe");this._sendFeatureUsage(g,Rh.unsubscribe),"dataChannelReceiverCreated"===g&&this._dataChannelManager?.off("dataChannelReceiverCreated",m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"DataChannel",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}class SpotlightCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new SpotlightCallImplOverTsCall(this.eventEmitter),this._isSpotlightFeatureEnabled=getAcsEcsConfig().calling.spotlight.enabled}get name(){return"Spotlight"}initialize(g,m){this._logger=m,this._logger.info(`Spotlight feature enable flag: ${this._isSpotlightFeatureEnabled}`),this._isSpotlightFeatureEnabled?(this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)):this._logger.warn("Calls to spotlight APIs will perform no action or return default values where applicable")}async startSpotlight(g){this._isSpotlightFeatureEnabled&&this.validateIdentifierParam(g)&&await this._impl.startSpotlight(g)}async stopSpotlight(g){this._isSpotlightFeatureEnabled&&this.validateIdentifierParam(g)&&await this._impl.stopSpotlight(g)}async stopAllSpotlight(){this._isSpotlightFeatureEnabled&&await this._impl.stopAllSpotlight()}getSpotlightedParticipants(){return this._isSpotlightFeatureEnabled?(this._sendFeatureUsage("getSpotlightedParticipants",Rh.getter),this._impl.spotlightedParticipants):[]}get maxParticipantsToSpotlight(){return this._isSpotlightFeatureEnabled?(this._sendFeatureUsage("maxSpotlightSupportedState",Rh.getter),this._impl.maxSpotlightStateSupported):0}on(g,m){this._isSpotlightFeatureEnabled&&(this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m))}off(g,m){this._isSpotlightFeatureEnabled&&(this._sendFeatureUsage(g,Rh.unsubscribe),this.eventEmitter.off(g,m))}validateIdentifierParam(g=[]){try{return g.forEach((g=>validateIdentifier(g))),!0}catch(g){return!1}}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class SpotlightCallImplOverTsCall{constructor(g){this.typeRankComparator=(g,m)=>void 0===g.publishedState?-1:void 0===m.publishedState?1:g.publishedState.typeRank-m.publishedState.typeRank,this._eventEmitter=g,this._currentSpotlightStates=new Map;const m=getAcsEcsConfig().calling.spotlight;this._maxSpotlightStateSupported=m.maxSpotlightParticipants,this._supportedUserRoles=m.supportedRoles,this._meetingTypes=m.meetingTypes}initialize(g,m,S,v){this._logger=v.createChild((()=>`SpotlightFeature::Call(id='${g.callId}')`)),this._tsCall=g,this._telemetryLogManager=S,this._internalCallAgent=m;const C="initialize";this._sendFeatureUsage(C,Rh.initialize);try{let extractMRIs=g=>new Map(this.getPublishedState(g).sort(this.typeRankComparator).map(((g,m)=>[g.id,{spotlightStateId:g.publishedState?.stateId,index:m+1}])));this._tsCall.on("publishedStatesChanged",(async g=>{let m=extractMRIs(g),S=[];m.forEach(((g,m)=>{this._currentSpotlightStates.has(m)||S.push({identifier:constructIdentifierKindFromMri(m),order:g?.index})}));let v=[];this._currentSpotlightStates.forEach(((g,S)=>{m.has(S)||v.push({identifier:constructIdentifierKindFromMri(S)})})),this._currentSpotlightStates=m,(S.length||v.length)&&this._eventEmitter.emit("spotlightChanged",{added:S,removed:v})})),this._tsCall.publishedStates&&(this._currentSpotlightStates=extractMRIs(this._tsCall.publishedStates)),this._sendFeatureUsage(C,Rh.success)}catch(g){this.handleSpotlightFailure(C,g)}}async startSpotlight(g){const m="startSpotlight";try{this._sendFeatureUsage(m,Rh.attempt);let S=this.getIdentifiersMri(g).filter((g=>!this._currentSpotlightStates.has(g)));if(!S.length)throw new CallingCommunicationError({defaultError:D.FEATURES.SPOTLIGHT.ALREADY_SPOTLIGHTED});this.validateStartSpotlightConditions(S);const v={level:"user",type:"spotlight",content:"{}",participantIds:S};if(!await this._tsCall.publishState(v,M.generateCauseId()))throw new CallingCommunicationError({defaultError:D.FEATURES.SPOTLIGHT.START_SPOTLIGHT_FAILED});this._sendFeatureUsage(m,Rh.success)}catch(g){this.handleSpotlightFailure(m,g)}}async stopSpotlight(g){const m="stopSpotlight";this._tsCall.publishedStates||this._logger.warn(`${m}: no participants is currently Spotlighted`);try{this._sendFeatureUsage(m,Rh.attempt);let S=this.getIdentifiersMri(g);this.validateStopSpotlightConditions(S);const v=this.findStateIdsForParticipantIds(S);await this._tsCall.removeState({stateIds:v},M.generateCauseId()),this._sendFeatureUsage(m,Rh.success)}catch(g){this.handleSpotlightFailure(m,g)}}async stopAllSpotlight(){const g="stopAllSpotlight";try{this._sendFeatureUsage(g,Rh.attempt),this.validateStopSpotlightConditions([]),await this._tsCall.removeStatesForEveryone({type:"spotlight"},M.generateCauseId()),this._sendFeatureUsage(g,Rh.success)}catch(m){this.handleSpotlightFailure(g,m)}}get spotlightedParticipants(){return this._tsCall.publishedStates?Array.from(this._currentSpotlightStates.keys()).map((g=>({identifier:constructIdentifierKindFromMri(g),order:this._currentSpotlightStates.get(g)?.index}))):[]}get maxSpotlightStateSupported(){return this._maxSpotlightStateSupported}findStateIdsForParticipantIds(g){return g.length&&this._tsCall.publishedStates?g.map((g=>this._currentSpotlightStates.get(g)?.spotlightStateId||"")).filter((g=>g.length)):[]}getPublishedState(g){return g.typeStates.filter((g=>"spotlight"===g.type)).map((g=>g.participantStates)).flat()}isUserRoleEligible(){const g=this._tsCall.advancedMeetingRole;return!!g&&!!this._supportedUserRoles.find((m=>m===g))}isRoleBasedConversationType(){const g=this._tsCall.conversationType;return!!g&&!!this._meetingTypes.find((m=>m===g))}getIdentifiersMri(g){return g&&g?.length?g.map((g=>getMriFromIdentifier(g))):[this._internalCallAgent.getUserMri()]}validateStartSpotlightConditions(g){if(this.spotlightedParticipants.length+g.length>this._maxSpotlightStateSupported)throw new CallingCommunicationError({defaultError:D.FEATURES.SPOTLIGHT.SPOTLIGHT_LIGHT_MAX_REACHED,defaultErrorMessageArgs:[this._maxSpotlightStateSupported]});if(this.isRoleBasedConversationType()&&!this.isUserRoleEligible())throw new CallingCommunicationError({defaultError:D.FEATURES.SPOTLIGHT.UNSUPPORTED_ROLE_TYPE,defaultErrorMessageArgs:["Start",this._tsCall.conversationType]})}validateStopSpotlightConditions(g){if(!(1===g.length&&g[0]===this._internalCallAgent.getUserMri())&&this.isRoleBasedConversationType()&&!this.isUserRoleEligible())throw new CallingCommunicationError({defaultError:D.FEATURES.SPOTLIGHT.UNSUPPORTED_ROLE_TYPE,defaultErrorMessageArgs:["Stop",this._tsCall.conversationType]})}handleSpotlightFailure(g,m){throw this._logger.error(JSON.stringify(m)),this._sendFeatureUsage(g,Rh.failure,m),m}_sendFeatureUsage(g,m,S){let v=S?{code:S?.code||F,subCode:S?.subCode||0,failureReason:S?.message||"",...extractCommunicationServicesErrorForTelemetry(S)}:void 0;sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Spotlight",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:v},this._telemetryLogManager,this._logger)}}class CallSurveyFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new CallSurveyFeatureImplOverTsCall}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}get name(){return"CallSurvey"}dispose(){super.dispose()}submitSurvey(g){return this._impl.submitSurvey(g)}}class CallSurveyFeatureImplOverTsCall{initialize(g,m,S,v,C){this._tsCall=g,this._telemetryLogManager=v,this._logger=C}async submitSurvey(g){const m=+new Date,S=generateGuid();this.sendEndOfCallEvent("attempt",S);const v=this.validateSurvey(g);if(v){const g=new CallingCommunicationError({defaultError:D.FEATURES.CALL_SURVEY.INVALID_SURVEY,defaultErrorMessageArgs:[v]});throw this.sendEndOfCallEvent("failure",S,m,{failureReason:v,code:O,...extractCommunicationServicesErrorForTelemetry(g),isExpected:!0}),g}return new Promise(((v,C)=>{const _=this.createCallSurveyInternal(g);this.registerNotificationEventListener(_,S,m,v,C),this.sendEndOfCallEvent("success",S,m,void 0,_)}))}registerNotificationEventListener(g,m,S,v,C){const _={id:m,callId:g.callId,localParticipantId:g.localParticipantId,overallRating:g.overallRating,audioRating:g.audioRating,videoRating:g.videoRating,screenshareRating:g.screenshareRating};CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER.eventsSent=g=>{g.find((g=>g.name===Ah.acs_calling_survey&&g.data?.correlationId===m&&"success"===g.data?.kindOfEvent))&&v(_)},CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER.eventsDiscarded=(g,v)=>{if(g.find((g=>g.name===Ah.acs_calling_survey&&g.data?.correlationId===m&&"success"===g.data?.kindOfEvent))){const g=new CallingCommunicationError({defaultError:D.FEATURES.CALL_SURVEY.SUBMIT_TIMEOUT});this.sendEndOfCallEvent("failure",m,S,{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)}),C(g)}}}sendEndOfCallEvent(g,m,S,v,C){try{const _={eventName:Ah.acs_calling_survey,callId:this._tsCall?.callId,localParticipantId:this._tsCall?.participantId,correlationId:m,kindOfEvent:g,timestampInfo:{deltaTimeInMs:0},additionalDetails:v};if(S){const g=+new Date;_.timestampInfo.deltaTimeInMs=g-S}"success"===g&&C?(_.overallRating=C.overallRating,_.audioRating=C.audioRating,_.videoRating=C.videoRating,_.screenshareRating=C.screenshareRating,this._telemetryLogManager.sendEvent({name:Ah.acs_calling_survey,tenant:Qa,priority:Jt.Immediate,properties:_},CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER)):this._telemetryLogManager.sendEvent({name:_.eventName,tenant:Qa,properties:_})}catch(g){this._logger.debug("Unable to send call survey telemetry")}}createCallSurveyInternal(g){let m={callId:this._tsCall?.callId,localParticipantId:this._tsCall?.participantId};return g&&(m.overallRating=g.overallRating,m.audioRating=g.audioRating,m.videoRating=g.videoRating,m.screenshareRating=g.screenshareRating),m}validateSurvey(g){let m="";return m=this.validateOverallRating(g.overallRating),m+=this.validateAudioRating(g.audioRating),m+=this.validateVideoRating(g.videoRating),m+=this.validateScreenshareRating(g.screenshareRating),""!==m||g.overallRating||g.audioRating||g.videoRating||g.screenshareRating||(m="At least one survey rating is required."),""===m&&(m=this.validateCallSurveyTypes(g)),m.trim()}validateOverallRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("overallRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("overallRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE),m}validateAudioRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("audioRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("audioRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE),m}validateVideoRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("videoRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("videoRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE),m}validateScreenshareRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("screenshareRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("screenshareRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE),m}validateCallSurveyTypes(g){let m="";return g.overallRating&&(m=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE,g.overallRating.score),g.overallRating.issues&&(this.isArray(g.overallRating.issues)?g.overallRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.OVERALL_ISSUES[g]!==g))&&(m+="overallRating.issues array should be of type OverallIssue. "):m+="overallRating.issues should be of type Array<OverallIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("overallRating.scale",g.overallRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("overallRating",g.overallRating)),g.audioRating&&(m+=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE,g.audioRating.score),g.audioRating.issues&&(this.isArray(g.audioRating.issues)?g.audioRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.AUDIO_ISSUES[g]!==g))&&(m+="audioRating.issues array should be of type AudioIssue. "):m+="audioRating.issues should be of type Array<AudioIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("audioRating.scale",g.audioRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("audioRating",g.audioRating)),g.videoRating&&(m+=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE,g.videoRating.score),g.videoRating.issues&&(this.isArray(g.videoRating.issues)?g.videoRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.VIDEO_ISSUES[g]!==g))&&(m+="videoRating.issues array should be of type VideoIssue. "):m+="videoRating.issues should be of type Array<VideoIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("videoRating.scale",g.videoRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("videoRating",g.videoRating)),g.screenshareRating&&(m+=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE,g.screenshareRating.score),g.screenshareRating.issues&&(this.isArray(g.screenshareRating.issues)?g.screenshareRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.SCREENSHARE_ISSUES[g]!==g))&&(m+="screenshareRating.issues array should be of type ScreenshareIssue. "):m+="screenshareRating.issues should be of type Array<ScreenshareIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("screenshareRating.scale",g.screenshareRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("screenshareRating",g.screenshareRating)),m}isNumber(g){return null!==g&&"number"==typeof g}isArray(g){return null!==g&&Array.isArray(g)}isValidFiveStarRating(g){return null==g||void 0!==g.scale||g.score>=1&&g.score<=5}isRatingValueMatchesRatingScale(g,m){return g>=m.lowerBound&&g<=m.upperBound}isValidQualityThreshold(g){return g.lowScoreThreshold>=g.lowerBound&&g.lowScoreThreshold<=g.upperBound}isValidRatingScale(g){return g.lowerBound>=0&&g.upperBound<=100}valueShouldBeNumber(g,m){return this.isNumber(m)?"":`${g} should be of type number. `}ratingScaleShouldNotHaveUnexpectedProperties(g,m){let S="";if(!m)return S;for(let v in m)void 0===CallSurveyFeatureImplOverTsCall.RATING_SCALE_KEYS[v]&&(S+=`${g} should not have ${v}. `);return S}ratingShouldNotHaveUnexpectedProperties(g,m){let S="";if(!m)return S;for(let v in m)void 0===CallSurveyFeatureImplOverTsCall.CALL_RATING_KEYS[v]&&(S+=`${g} should not have ${v}. `);return S}defaultRatingScaleMessage(g){return`In default scale ${g} should be 1 to 5. `}ratingOutOfRangeMessage(g,m){return`${g}: ${m.score} should be between ${m.scale?.lowerBound} and ${m.scale?.upperBound}. `}thresholdOutOfRangeMessage(g,m){return`${g}: ${m.scale?.lowScoreThreshold} should be between ${m.scale?.lowerBound} and ${m.scale?.upperBound}. `}ratingScaleOutOfRangeMessage(g,m){return`${g} lowerBound: ${m.scale?.lowerBound} and upperBound: ${m.scale?.upperBound} should be between 0 and 100. `}}CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE="overallRating.score",CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE="audioRating.score",CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE="videoRating.score",CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE="screenshareRating.score",CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER={},CallSurveyFeatureImplOverTsCall.OVERALL_ISSUES={CallCannotInvite:"CallCannotInvite",CallCannotJoin:"CallCannotJoin",CallEndedUnexpectedly:"CallEndedUnexpectedly",HadToRejoin:"HadToRejoin",OtherIssues:"OtherIssues"},CallSurveyFeatureImplOverTsCall.AUDIO_ISSUES={AudioInterruption:"AudioInterruption",AudioNoise:"AudioNoise",AudioStoppedUnexpectedly:"AudioStoppedUnexpectedly",DistortedSpeech:"DistortedSpeech",Echo:"Echo",LowVolume:"LowVolume",NoLocalAudio:"NoLocalAudio",NoRemoteAudio:"NoRemoteAudio",OtherIssues:"OtherIssues"},CallSurveyFeatureImplOverTsCall.VIDEO_ISSUES={AudioVideoOutOfSync:"AudioVideoOutOfSync",DarkVideoReceived:"DarkVideoReceived",Freezes:"Freezes",LowQuality:"LowQuality",NoVideoReceived:"NoVideoReceived",NoVideoSent:"NoVideoSent",OtherIssues:"OtherIssues",StoppedUnexpectedly:"StoppedUnexpectedly"},CallSurveyFeatureImplOverTsCall.SCREENSHARE_ISSUES={CannotPresent:"CannotPresent",Freezes:"Freezes",LargeDelay:"LargeDelay",LowQuality:"LowQuality",NoContentLocal:"NoContentLocal",NoContentRemote:"NoContentRemote",OtherIssues:"OtherIssues",StoppedUnexpectedly:"StoppedUnexpectedly"},CallSurveyFeatureImplOverTsCall.CALL_RATING_KEYS={score:"score",issues:"issues",scale:"scale"},CallSurveyFeatureImplOverTsCall.RATING_SCALE_KEYS={lowerBound:"lowerBound",upperBound:"upperBound",lowScoreThreshold:"lowScoreThreshold"};class AudioZonesCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new AudioZonesImpl(this.eventEmitter,this.name)}get name(){return"AudioZones"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}updateAudioZone(g){return this._impl.updateAudioZone(g)}dispose(){this._impl.dispose(),super.dispose()}get meetingGroupDetails(){return this._impl.meetingGroupDetails}on(g,m){this.eventEmitter.on(g,m)}off(g,m){this.eventEmitter.off(g,m)}}class AudioZonesImpl{constructor(g,m){this._eventEmitter=g,this._featureName=m}initialize(g,m,S,v,C){this._logger=C.createChild((()=>`${this._featureName}::Call(id='${g.callId}')`)),this._tsCall=g,this._tsCall.changed((()=>{this._logger.log("tsCall changed"),this.updateMeetingGroupDetails()}))}updateAudioZone(g){const m="updateAudioZone_"+generateGuid();return this._logger.log(`updateAudioZone toGroup=${g}, causeId=${m}`),this._tsCall.updateMeetingGroups(m,{scope:4,toGroup:g})}dispose(){this._meetingGroupDetails=void 0}get meetingGroupDetails(){return this._meetingGroupDetails}updateMeetingGroupDetails(){const g=this._tsCall.meetingGroupDetails;P.isEqual(g,this._meetingGroupDetails)||(this._meetingGroupDetails=g,this._eventEmitter.emit("meetingGroupDetailsChanged"))}}class OptimalVideoCountCallFeatureImpl extends FirstPartyCallFeature{_sendOVCTelemetryEvent(g){if(!this._telemetryLogManager)return;const m={callId:this._call?.id||"",localParticipantId:this._tsCall?.participantId||"",featureName:"OptimalVideoCount",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{step:g}};this._telemetryLogManager.sendEvent({name:Ah.acs_calling_feature_usage,tenant:Qa,properties:m})}get optimalVideoCount(){return this._sendOVCTelemetryEvent(Rh.getter),this._tsCall?.optimalVideoCount?this._tsCall.optimalVideoCount:1}constructor(g){super(g),this.name="OptimalVideoCount",this._impl=new OptimalVideoCountCallFeatureImplOverTsCall(this.name,this.eventEmitter,this.optimalVideoCount)}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m),this._tsCall=g.tsCall,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call}on(g,m){if("optimalVideoCountChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.OPTIMAL_VIDEO_COUNT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._sendOVCTelemetryEvent(Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){if("optimalVideoCountChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.OPTIMAL_VIDEO_COUNT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._sendOVCTelemetryEvent(Rh.unsubscribe),this.eventEmitter.off(g,m)}}class OptimalVideoCountCallFeatureImplOverTsCall{constructor(g,m,S){this._featureName=g,this._eventEmitter=m,this._optimalVideoCount=S}initialize(g,m,S,v,C){this._tsCall=g,this._logger=C,this._logger?.createChild((()=>`${this._featureName}::Call(id='${this._tsCall?.callId}')`)),this._tsCall.changed((()=>this.ovcChanged(g)))}ovcChanged(g){g?.optimalVideoCount&&g.optimalVideoCount!==this._optimalVideoCount&&(this._logger.log(`tsCall optimalVideoCount changed from ${this._optimalVideoCount} to ${g?.optimalVideoCount}`),this._eventEmitter.emit("optimalVideoCountChanged"))}}class BrowserAudioEffectsHelper{constructor(g,m){this._effectsStatusManager=g,this._logger=m,this._currentActiveBrowserEffects={},this._updateCurrentActive()}async setBrowserAudioEffects(g,m,S){try{this._updateCurrentActive(m);const v={autoGainControl:void 0!==S.autoGainControl?S.autoGainControl:this._currentActiveBrowserEffects.autoGainControl,echoCancellation:void 0!==S.echoCancellation?S.echoCancellation:this._currentActiveBrowserEffects.echoCancellation,noiseSuppression:void 0!==S.noiseSuppression?S.noiseSuppression:this._currentActiveBrowserEffects.noiseSuppression},C=this._calculateFlags(v);this._logger.info(`Setting browser audio processing flags to ${C}`),await g.setAudioProcessingFlags(C)}catch(g){throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.AUDIO_FLAGS,originalError:g})}}_updateCurrentActive(g){const m=g??this._effectsStatusManager.getActiveEffects();this._currentActiveBrowserEffects={},"BrowserAutoGainControl"===m?.autoGainControl?.[0]&&(this._currentActiveBrowserEffects.autoGainControl=!0),"BrowserEchoCancellation"===m?.echoCancellation?.[0]&&(this._currentActiveBrowserEffects.echoCancellation=!0),"BrowserNoiseSuppression"===m?.noiseSuppression?.[0]&&(this._currentActiveBrowserEffects.noiseSuppression=!0)}_calculateFlags(g){let m=0;return g.autoGainControl&&(m+=1),g.echoCancellation&&(m+=2),g.noiseSuppression&&(m+=4),m}}class AudioEffectsFeatureImpl extends FirstPartyAudioStreamFeature{constructor(){super(...arguments),this._wasmVqeInitialized=!1,this._activeEffects={echoCancellation:[],noiseSuppression:[],autoGainControl:[]},this._currentEffects={},this._previousTsWasmEffectType=0,this._currentTsWasmEffectType=0,this.effectStatusChangedCallback=(g,m,S)=>{"start"===S&&this.eventEmitter.emit("effectsStarted",m),"stop"===S&&this.eventEmitter.emit("effectsStopped",m)},this.configUpdatedCallback=async g=>{this._logger?.info("configUpdated callback, no-op.")},this.processingErrorCallback=async g=>{const m=generateGuid();this._logger?.info("processingError callback"),this.eventEmitter.emit("effectsError",g);const S=this.getEffectsNameForTelemetry(this.activeEffects),v=this.getUsageDetailsForTelemetry("Internal handle error",S);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.stopEffects,kindOfEvent:Rh.failure,additionalDetails:{failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g),usageDetails:v}}),await this.stopEffects({echoCancellation:!0,noiseSuppression:!0})}}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this.updateAudioEffectsStatusManager()}get name(){return"AudioEffects"}get activeEffects(){return this._effectsStatusManager?.getActiveEffects?.()??this._activeEffects}on(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.on(g,m)}off(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.off(g,m)}async isSupported(g){const m=generateGuid(),S=+new Date,v=this.getUsageDetailsForTelemetry("",this.getEffectsNameForTelemetry(g));this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.isSupported,kindOfEvent:Rh.attempt,additionalDetails:{usageDetails:v}});try{if(this.disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.SOURCE_UNSUPPORTED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const v=this._internalDeviceManager.getEnvironmentInfoInternal();this._supportChecker||(this._supportChecker=new EffectsCapabilityChecker(this._logger,v));let C=!1;if("object"==typeof g){const m=this.getEffectInternalCast(g);C=await this._supportChecker.audioEffectsSupported(m),this._logger?.info(`Support check for ${m.name} resulted in: ${C}`)}else"string"==typeof g&&(C=await this._supportChecker.audioEffectsSupported(g),this._logger?.info(`Support check for ${g} resulted in: ${C}`));const _=this.getEffectsNameForTelemetry(g),E=this.getUsageDetailsForTelemetry("",_);return this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.isSupported,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.success,additionalDetails:{usageDetails:E}}),C}catch(v){const C=new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.SUPPORT_CHECK_FAILED,originalError:v});this._logger?.error(C.message);const _=this.getEffectsNameForTelemetry(g),E=this.getUsageDetailsForTelemetry("",_);throw this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.isSupported,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,additionalDetails:{failureReason:C.message,code:C.code,...extractCommunicationServicesErrorForTelemetry(C),usageDetails:E}}),C}}async startEffects(g){const m=generateGuid(),S=+new Date,v=this.getUsageDetailsForTelemetry("",this.getEffectsNameForTelemetry(g));this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.startEffects,kindOfEvent:Rh.attempt,additionalDetails:{usageDetails:v}});try{const v=getAcsEcsConfig();if(!v?.audioEffects?.enableAudioEffects)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.DISABLED});if(this.disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.START_DISPOSED});if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.SOURCE_UNSUPPORTED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const C=this._internalDeviceManager.getTsDeviceManager();if(!C)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.START_DEVICE_MANAGER});this.updateAudioEffectsStatusManager(),this.subscribeToStreamInstanceEvents(),this.disposeEffectEventSubscriptions(),this.subscribeToEffectEvents();let _=this.activeEffects;g?.autoGainControl&&(_=await this.startStopAutoGainControl(C,_,!0,g.autoGainControl)),g?.echoCancellation&&(_=await this.startStopEchoCancellation(C,_,!0,g.echoCancellation)),g?.noiseSuppression&&(_=await this.startStopNoiseSuppression(C,_,!0,g.noiseSuppression)),this._currentTsWasmEffectType!==this._previousTsWasmEffectType&&await C.setAudioEffectsAsync("",this._currentTsWasmEffectType),this._effectsStatusManager?.setActiveEffects(_,"start");const E=this.getEffectsNameForTelemetry(_),T=this.getUsageDetailsForTelemetry("",E);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.startEffects,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.success,additionalDetails:{usageDetails:T}})}catch(v){const C=new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.START_FAILED,originalError:v});this._logger?.error(C.message),this.eventEmitter.emit("effectsError",C);const _=this.getEffectsNameForTelemetry(g),E=this.getUsageDetailsForTelemetry("",_);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.startEffects,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,additionalDetails:{failureReason:C.message,code:C.code,...extractCommunicationServicesErrorForTelemetry(C),usageDetails:E}})}}async stopEffects(g){const m=generateGuid(),S=+new Date,v=this.getEffectsNameForTelemetry(g),C=this.getUsageDetailsForTelemetry("",v);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.stopEffects,kindOfEvent:Rh.attempt,additionalDetails:{usageDetails:C}});try{if(this.disposed)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.STOP_DISPOSED});this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const v=this._internalDeviceManager.getTsDeviceManager();if(!v)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.STOP_DEVICE_MANAGER});this.updateAudioEffectsStatusManager();let C=this.activeEffects;g?.autoGainControl&&(C=await this.startStopAutoGainControl(v,C,!1)),g?.echoCancellation&&(C=await this.startStopEchoCancellation(v,C,!1)),g?.noiseSuppression&&(C=await this.startStopNoiseSuppression(v,C,!1)),this._currentTsWasmEffectType!==this._previousTsWasmEffectType&&await v.setAudioEffectsAsync("",this._currentTsWasmEffectType),this._effectsStatusManager?.setActiveEffects(C,"stop");const _=this.getEffectsNameForTelemetry(C),E=this.getUsageDetailsForTelemetry("",_);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.success,additionalDetails:{usageDetails:E}})}catch(v){const C=new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.STOP_FAILED,originalError:v});this._logger?.error(C.message),this.eventEmitter.emit("effectsError",C);const _=this.getEffectsNameForTelemetry(g),E=this.getUsageDetailsForTelemetry("",_);this.sendFeatureUsageTelemetry({eventName:Ah.acs_calling_media_stream,correlationId:m,operation:cu.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Rh.failure,additionalDetails:{failureReason:C.message,code:C.code,...extractCommunicationServicesErrorForTelemetry(C),usageDetails:E}})}}async dispose(){try{if(this.disposed)return void this._logger?.info("AudioEffects feature already disposed");await this.stopEffects({echoCancellation:!0,noiseSuppression:!0}),this._currentEffects={},this.eventEmitter.removeAllListeners(),this._effectsStatusManager?.off("statusChanged",this.effectStatusChangedCallback),this.disposed=!0,this._logger?.info("AudioEffects feature disposed")}catch(g){const m=new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.DISPOSE_FAILED,originalError:g});this._logger?.error(m.message),this.eventEmitter.emit("effectsError",m)}}updateAudioEffectsStatusManager(){this.streamInstance.canStartEffects?(this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this._effectsStatusManager||(this._effectsStatusManager=this._internalDeviceManager.callStackAudioEffectsStatusManager,this._effectsStatusManager.on("statusChanged",this.effectStatusChangedCallback)),this._activeEffects=this._effectsStatusManager.getActiveEffects(),this._browserAudioEffectsManager=new BrowserAudioEffectsHelper(this._effectsStatusManager,this._logger)):this._logger?.warn("Cannot update status manager, current source is not supported.")}async initializeWasmVqeInStack(g){if(this._wasmVqeInitialized)return void this._logger?.info("WasmVqe initialized already");if(!this._internalDeviceManager)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.FAILED_TO_GET_DM});const m=await g._internalHandle.getEffectProvider();if(!m)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.PROVIDER_UNAVAILABLE});const S=await m.getAudioEffectProvider(),v=this.streamInstance.callStackWasmVqeProvider;if(!v)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.AEC_PROVIDER_MISSING});v.providerValue=S,this._wasmVqeInitialized=!0}getEffectInternalCast(g){if("EchoCancellation"===g?.name&&this.isValidEffectInstance(g))return g;if("NoiseSuppression"===g?.name&&this.isValidEffectInstance(g))return g;if("DeepNoiseSuppression"===g?.name&&this.isValidEffectInstance(g))return g;throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT})}isValidEffectInstance(g){let m;return("EchoCancellation"===g.name&&g._internalHandle||"NoiseSuppression"===g.name&&g._internalHandle||!("DeepNoiseSuppression"!==g.name||!g._internalHandle))&&(m=g,this.hasValidInternalHandle(m._internalHandle))}hasValidInternalHandle(g){return!!(g.getEffectProvider&&g.dispose&&g.setConfig&&g.handleProcessingError)}updateCurrentTsWasmAudioEffectType(g,m,S){const v=S??this._effectsStatusManager?.getActiveEffects();let C=!!v?.echoCancellation?.includes("EchoCancellation"),_=!!v?.noiseSuppression?.includes("NoiseSuppression"),E=!!v?.noiseSuppression?.includes("DeepNoiseSuppression");switch(g){case"EchoCancellation":C=m;break;case"NoiseSuppression":_=m;break;case"DeepNoiseSuppression":E=m}this._previousTsWasmEffectType=this._currentTsWasmEffectType,C&&_?this._currentTsWasmEffectType=8:C&&E?this._currentTsWasmEffectType=16:C?this._currentTsWasmEffectType=4:_?this._currentTsWasmEffectType=1:E&&(this._currentTsWasmEffectType=2)}subscribeToStreamInstanceEvents(){this.streamInstance.on("audioSourceChanged",(async g=>{g.source&&"Audio"!==g.source.mediaStreamType&&await this.stopEffects({echoCancellation:!0,noiseSuppression:!0})}))}subscribeToEffectEvents(){"object"==typeof this._currentEffects.echoCancellation&&(this._currentEffects.echoCancellation?._internalHandle.on("configUpdated",this.configUpdatedCallback),this._currentEffects.echoCancellation?._internalHandle.on("processingError",this.processingErrorCallback)),"object"==typeof this._currentEffects.noiseSuppression&&(this._currentEffects.noiseSuppression?._internalHandle.on("configUpdated",this.configUpdatedCallback),this._currentEffects.noiseSuppression?._internalHandle.on("processingError",this.processingErrorCallback))}disposeEffectEventSubscriptions(){"object"==typeof this._currentEffects.echoCancellation&&(this._currentEffects.echoCancellation?._internalHandle.off("configUpdated",this.configUpdatedCallback),this._currentEffects.echoCancellation?._internalHandle.off("processingError",this.processingErrorCallback)),"object"==typeof this._currentEffects.noiseSuppression&&(this._currentEffects.noiseSuppression?._internalHandle.off("configUpdated",this.configUpdatedCallback),this._currentEffects.noiseSuppression?._internalHandle.off("processingError",this.processingErrorCallback))}setConfigForEffects(g){const m=g._internalHandle.configProvider.config.audioEffects,S=getMediaConfig(),v=getAcsEcsConfig();S?.wasmvqe?.enableVqe&&v?.audioEffects?.enableAudioEffects&&(m.enableAudioEffects=S?.wasmvqe?.enableVqe&&v.audioEffects.enableAudioEffects),g._internalHandle.setConfig(m),this._logger?.info(`Config for audio effects set: ${stringifyObject(m)}`)}async startStopAutoGainControl(g,m,S,v){try{if(S&&v){if(!await this.isSupported(v))throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT,defaultErrorMessageArgs:[JSON.stringify(v)]});if("BrowserAutoGainControl"!==v)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_GAINCONTROL});return await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{autoGainControl:!0})),this._logger?.info("Browser auto gain control started"),this._currentEffects.autoGainControl=v,m.autoGainControl=[v],m}switch(m?.autoGainControl?.[0]??""){case"":case"BrowserAutoGainControl":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{autoGainControl:!1})),this._logger?.info("Browser auto gain control stopped")}return m.autoGainControl=[],this._currentEffects.autoGainControl=void 0,m}catch(g){throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.SET_AUTO_GAIN_CONTROL,defaultErrorMessageArgs:[S],originalError:g})}}async startStopEchoCancellation(g,m,S,v){try{if(S&&v){if(!await this.isSupported(v))throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT,defaultErrorMessageArgs:[JSON.stringify(v)]});if("string"==typeof v&&"BrowserEchoCancellation"===v)await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{echoCancellation:!0})),this._logger?.info("Browser echo cancellation started"),this._currentEffects.echoCancellation=v,m.echoCancellation=[v];else{if("object"!=typeof v)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_ECHO});this._currentEffects.echoCancellation=this.getEffectInternalCast(v),this.setConfigForEffects(this._currentEffects.echoCancellation),await this.initializeWasmVqeInStack(this._currentEffects.echoCancellation),this.updateCurrentTsWasmAudioEffectType(this._currentEffects.echoCancellation.name,!0,m),m.echoCancellation=[this._currentEffects.echoCancellation.name]}return m}switch(m?.echoCancellation?.[0]??""){case"":case"BrowserEchoCancellation":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{echoCancellation:!1})),this._logger?.info("Browser echo cancellation stopped");break;case"EchoCancellation":await this.initializeWasmVqeInStack(this._currentEffects.echoCancellation),this.updateCurrentTsWasmAudioEffectType("EchoCancellation",!1,m)}return m.echoCancellation=[],this._currentEffects.echoCancellation=void 0,m}catch(g){throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.SET_ECHO_CANCELLATION,defaultErrorMessageArgs:[S],originalError:g})}}async startStopNoiseSuppression(g,m,S,v){try{if(S&&v){if(!await this.isSupported(v))throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT,defaultErrorMessageArgs:[JSON.stringify(v)]});if("string"==typeof v&&"BrowserNoiseSuppression"===v)await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{noiseSuppression:!0})),this._logger?.info("Browser noise cancellation started"),m.noiseSuppression=[v],this._currentEffects.noiseSuppression=v;else{if("object"!=typeof v)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_NOISE_SUPP});this._currentEffects.noiseSuppression=this.getEffectInternalCast(v),this.setConfigForEffects(this._currentEffects.noiseSuppression),await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType(this._currentEffects.noiseSuppression.name,!0,m),m.noiseSuppression=[this._currentEffects.noiseSuppression.name]}return m}switch(m?.noiseSuppression?.[0]??""){case"":case"BrowserNoiseSuppression":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{noiseSuppression:!1})),this._logger?.info("Browser noise suppression stopped");break;case"NoiseSuppression":await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType("NoiseSuppression",!1,m);break;case"DeepNoiseSuppression":await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType("DeepNoiseSuppression",!1,m)}return m.noiseSuppression=[],this._currentEffects.noiseSuppression=void 0,m}catch(g){throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.SET_NOISE_SUPPRESSION,defaultErrorMessageArgs:[S],originalError:g})}}sendFeatureUsageTelemetry(g){if(this._telemetryLogManager)try{const m={correlationId:g.correlationId,mediaType:ou.AudioRaw,streamType:lu.Local,operation:g.operation,timestampInfo:g.timestampInfo||{},kindOfEvent:g.kindOfEvent||"",additionalDetails:g.additionalDetails||""};this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:m})}catch(m){this._logger?.debug(`Unable to send ${g.operation} telemetry`)}else this._logger?.debug("Telemetry error. Instance is undefined.")}getEffectsNameForTelemetry(g){return g?stringifyObject(g):"UNKNOWN"}getUsageDetailsForTelemetry(g,m){return`${m?`[${m}] `:""}${g}`}}function invalidEventSubscription$1(g,m){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.EVENT_SUBSCIBE_UNSUBSCRIBE,defaultErrorMessageArgs:[m,g]})}function unmixedAudioIsNotAvailable(){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.UNAVAILABLE})}function getErrorString$1(g){return P.isString(g)?g:g?.message??"Unknown"}function rethrowError(g){throw g instanceof CallingCommunicationError?g:new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.UNKNOWN_ERROR})}function hasPendingOpertion(){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.PENDING_OPERATION})}function notSupportP2P(){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.UNSUPPORTED_OPERATION})}function unmixedAudioHasBeenEnabled(){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.ENABLED})}function unmixedAudioHasBeenDisabled(){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.DISABLED})}function unmixedAudioHasBeenDisposed(){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.DISPOSED})}function invalidState(g){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.INVALID_STATE,defaultErrorMessageArgs:[g]})}function failedToInitialize(g){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.FAILED_TO_INITIALIZE,originalError:g})}function failedToEnable(g,m){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.FAILED_TO_ENABLE,defaultErrorMessageArgs:[m.audioContextState||"undefined",m.unmixedAudioState||"undefined"],originalError:g})}function failedToDisable(g,m){return new CallingCommunicationError({defaultError:D.FEATURES.UNMIXED_AUDIO.FAILED_TO_DISABLE,defaultErrorMessageArgs:[m.audioContextState||"undefined",m.unmixedAudioState||"undefined"],originalError:g})}class ParticipantMappingManager$2{constructor(g){this._tsCall=g,this._sourceIdMapping=new Map,this._participantIdMapping=new Map,this._listenerHandles=[],this._listenerHandles.push(this._tsCall.on("participantAdded",(g=>{this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(g=>{this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(g=>{this._removeMapping(g)}))),this._tsCall.participants.forEach((g=>{this._updateMapping(g)}))}_updateMapping(g){g.endpoints?.endpointDetails?.forEach((m=>{const S=m.mediaStreams?.find((g=>"audio"===g.type));if(S){const v={sourceId:S.sourceId,participantId:m.participantId,mri:g.id};this._sourceIdMapping.set(S.sourceId,v),this._participantIdMapping.set(m.participantId,v)}}))}_removeMapping(g){g.endpoints?.endpointDetails?.forEach((g=>{const m=g.mediaStreams?.find((g=>"audio"===g.type));m&&(this._sourceIdMapping.delete(m.sourceId),this._participantIdMapping.delete(g.participantId))}))}findParticipantInfoBySourceId(g){return this._sourceIdMapping.get(g)}findParticipantInfoByParticipantId(g){return this._participantIdMapping.get(g)}dispose(){this._sourceIdMapping.clear(),this._participantIdMapping.clear(),this._listenerHandles.forEach((g=>g.dispose()))}}class UnmixedAudioTelemetryLogger{constructor(g,m){this._tsCall=g,this._telemetryLogManager=m}sendActionEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId},...g};this._telemetryLogManager.sendEvent({name:Ah.acs_calling_unmixed_audio,tenant:Qa,properties:m})}}class UnmixedAudioActionTelemetryLogger{constructor(g,m){this._unmixedAudioTelemetryLogger=g,this._action=m,this._correlationId=generateGuid()}logAttempt(){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"attempt",correlationId:this._correlationId})}logSuccess(){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"success",correlationId:this._correlationId})}logFailure(g,m){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"failure",correlationId:this._correlationId,failureReason:g.message,...m,additionalDetails:{...extractCommunicationServicesErrorForTelemetry(g)}})}}class StatePromise{constructor(g,m){this._waitTimeoutInMs=g,this._expectedState=m,this._result=defer(),this._wait=wait((()=>this._result.promise),this._waitTimeoutInMs)}updateState(g){this._result.isPending()&&(g===this._expectedState?this._result.resolve():this._result.reject(new Error(`Unexpected active state: ${g}`)))}get waitState(){return this._expectedState}async wait(){await this._wait}cancel(){this._result.isPending()&&this._result.reject(new Error("Operation cancelled"))}}class UnmixedAudioContext{constructor(g,m){this._logger=g.createChild(`AudioContext:${m}`);const S=new AudioContext,stateChangeHandler=()=>{this._logger.info(`The AudioContext:${m} state changed to ${S.state}`),"closed"===S.state&&S.removeEventListener("statechange",stateChangeHandler)};S.addEventListener("statechange",stateChangeHandler),this._audioContext=S}async resume(g=0){if("closed"===this._audioContext.state)throw invalidState(this._audioContext.state);if("running"===this._audioContext.state)return;const m=new StatePromise(g,!0);return this._audioContext.resume().then((()=>{m.updateState(!0),this._logger.info("resumed")})).catch((g=>{this._logger.info(`Failed to resume: ${getErrorString$1(g)}`),m.updateState(!1)})),m.wait()}async close(){"closed"!==this._audioContext.state&&await this._audioContext.close().then((()=>{this._logger.info("closed")})).catch((g=>{this._logger.info(`Failed to close: ${getErrorString$1(g)}`)}))}get state(){return this._audioContext.state}get value(){return this._audioContext}}function getStateString(g){switch(g){case $g.Uninitialized:return"Uninitialized";case $g.Initializing:return"Initializing";case $g.Initialized:return"Initialized";case $g.Destroyed:return"Destroyed";case $g.Aborted:return"Aborted"}}!function(g){g[g.Uninitialized=0]="Uninitialized",g[g.Initializing=1]="Initializing",g[g.Initialized=2]="Initialized",g[g.Destroyed=3]="Destroyed",g[g.Aborted=4]="Aborted"}($g||($g={}));class UnmixedAudioManager{constructor(g,m,S,v){this._state=$g.Uninitialized,this._listenerHandles=[],this._audioContextSeq=0,this._activeStatePromises=new Set,this._lastestSpatialAudioRequest="none",this._pendingOperation=!1,this._initializedDefer=defer();try{this._tsCall=g,this._logger=m.createChild("UnmixedAudioManager"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._unmixedAudioTelemetryLogger=S,this._participantManager=new ParticipantMappingManager$2(g),this._destinationStreamInfoMap=new Map,this._destinationStreamInfoList=new Array(v.maxStreamSize),this._sourceStreamInfoList=new Array(v.maxStreamSize),this._maxStreamSize=v.maxStreamSize,this._operationTimeoutInMs=v.operationTimeoutInMs,this._skipProviderStateCheck=v.skipProviderStateCheck}catch(g){throw this._state=$g.Aborted,m.info(`Failed to create UnmixedAudioManager: ${getErrorString$1(g)}`),failedToInitialize(g)}}async initialize(){if(this._state!==$g.Uninitialized)throw invalidState(getStateString(this._state));this._initializedDefer.isPending()||(this._initializedDefer=defer());const g=new UnmixedAudioActionTelemetryLogger(this._unmixedAudioTelemetryLogger,"initialize");this._state=$g.Initializing;try{if(g.logAttempt(),!this._tsCall.getUnmixedAudioProvider)throw unmixedAudioIsNotAvailable();if(this._tsUnmixedAudioProvider=this._tsUnmixedAudioProvider??await this._tsCall.getUnmixedAudioProvider(),!this._tsUnmixedAudioProvider)throw unmixedAudioIsNotAvailable();this._audioContext=this._audioContext??new UnmixedAudioContext(this._logger,this._audioContextSeq++),0===this._listenerHandles.length&&(this._listenerHandles.push(this._tsUnmixedAudioProvider.on("onStreamSourcesUpdated",(g=>{this._state===$g.Initialized&&this._onStreamSourcesUpdatedHandler(g)}))),this._listenerHandles.push(this._tsUnmixedAudioProvider.on("onActiveStateChanged",(()=>{if(this._state!==$g.Initialized)return;const g=this._tsUnmixedAudioProvider?.active??!1;this._logger.info(`activeStateChanged to ${g}`),this._activeStatePromises.forEach((m=>{m.updateState(g)})),this._activeStatePromises.clear()})))),g.logSuccess(),this._logger.info(`Initialized with maxStreamSize ${this._maxStreamSize}. The AudioContext state is ${this._getAudioContextState()}.`),this._state=$g.Initialized,this._initializedDefer.resolve()}catch(m){this._state=$g.Uninitialized;const S=getErrorString$1(m);this._logger.info(`Failed to initialize: ${S}`);const v=failedToInitialize(m);g.logFailure(v),this._initializedDefer.reject(v)}return this._initializedDefer.promise}async enableUnmixedAudio(){const g=new UnmixedAudioActionTelemetryLogger(this._unmixedAudioTelemetryLogger,"enable");try{if(![$g.Uninitialized,$g.Initializing,$g.Initialized].includes(this._state))throw invalidState(getStateString(this._state));if(1===this._tsCall.callType)throw notSupportP2P();if(this._pendingOperation)throw hasPendingOpertion();if("enable"===this._lastestSpatialAudioRequest&&!this._skipProviderStateCheck&&"active"===this._getUnmixedAudioProviderState()&&"running"===this._getAudioContextState())throw unmixedAudioHasBeenEnabled();let m;this._pendingOperation=!0,g.logAttempt(),this._state===$g.Uninitialized?await this.initialize():this._state===$g.Initializing&&await this._initializedDefer.promise,void 0!==this._audioContext&&"closed"!==this._getAudioContextState()||(this._cleaupAudioNodes(),this._audioContext=new UnmixedAudioContext(this._logger,this._audioContextSeq++)),"active"!==this._getUnmixedAudioProviderState()&&(m=new StatePromise(this._operationTimeoutInMs,!0),this._activeStatePromises.add(m));const S=[["resume AudioContext","running"===this._getAudioContextState()?void 0:this._audioContext.resume(this._operationTimeoutInMs)],["enable spatial audio config",this._enableSpatialAudio(!0)],["wait for the unmixed audio active state to change to true",m?.wait()]];await this._runTasks(S),this._pendingOperation=!1,g.logSuccess(),this._logger.info(`UnmixedAudio is enabled. The AudioContext state is ${this._getAudioContextState()}.`)}catch(m){const S=this._getAudioContextState(),v=this._getUnmixedAudioProviderState(),C=getErrorString$1(m);this._logger.info(`Failed to enable unmixed audio: ${C}. AudioContext=${S}, UnmixedAudio=${v}`);const _={audioContextState:S,unmixedAudioState:v},E=failedToEnable(m,_);!1===this._pendingOperation&&rethrowError(E),g.logFailure(E,_),this._pendingOperation=!1,rethrowError(E)}}async disableUnmixedAudio(){const g=new UnmixedAudioActionTelemetryLogger(this._unmixedAudioTelemetryLogger,"disable");try{if(![$g.Initializing,$g.Initialized].includes(this._state))throw invalidState(getStateString(this._state));if(1===this._tsCall.callType)throw notSupportP2P();if(this._pendingOperation)throw hasPendingOpertion();if("disable"===this._lastestSpatialAudioRequest&&"active"!==this._getUnmixedAudioProviderState())throw unmixedAudioHasBeenDisabled();let m;this._pendingOperation=!0,g.logAttempt(),this._state===$g.Initializing&&await this._initializedDefer.promise,"inactive"!==this._getUnmixedAudioProviderState()&&(m=new StatePromise(this._operationTimeoutInMs,!1),this._activeStatePromises.add(m));const S=[["disable spatial audio config",this._enableSpatialAudio(!1)],["wait for the unmixed audio active state to change to false",m?.wait()]];await this._runTasks(S),this._pendingOperation=!1,g.logSuccess(),this._logger.info("UnmixedAudio is disabled")}catch(m){const S=this._getAudioContextState(),v=this._getUnmixedAudioProviderState(),C=getErrorString$1(m);this._logger.info(`Failed to disable unmixed audio: ${C}. AudioContext=${S}, UnmixedAudio=${v}`);const _={audioContextState:S,unmixedAudioState:v},E=failedToDisable(m,_);!1===this._pendingOperation&&rethrowError(E),g.logFailure(E,_),this._pendingOperation=!1,rethrowError(E)}}get isUnmixedAudioActive(){return this._state===$g.Initialized&&("active"===this._getUnmixedAudioProviderState()&&"running"===this._getAudioContextState())}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._state!==$g.Destroyed&&(this._state=$g.Destroyed,this._initializedDefer.isPending()&&this._initializedDefer.reject(unmixedAudioHasBeenDisposed()),this._listenerHandles.forEach((g=>g.dispose())),this._cleaupAudioNodes(),this._participantManager.dispose(),this._audioContext?.close(),this._activeStatePromises.forEach((g=>{g.cancel()})),this._activeStatePromises.clear(),this._eventEmitter.removeAllListeners())}_getAudioContextState(){return this._audioContext?.state??"unavailable"}_getUnmixedAudioProviderState(){return this._tsUnmixedAudioProvider?this._tsUnmixedAudioProvider.active?"active":"inactive":"unavailable"}_cleaupAudioNodes(){this._sourceStreamInfoList.forEach(((g,m)=>{const S=this._destinationStreamInfoList[m];void 0!==g&&void 0!==S&&g.audioNode.disconnect(S.audioNode),this._sourceStreamInfoList[m]=void 0,this._destinationStreamInfoList[m]=void 0})),this._destinationStreamInfoMap.clear()}_onStreamSourcesUpdatedHandler(g){const m=this._audioContext?.value;if(void 0===m||"running"!==m.state)return;const S=[];for(let v=0;v<this._maxStreamSize;v++){const C=v<g.length?g[v]:0,_=C?this._participantManager.findParticipantInfoBySourceId(C):void 0;let E=this._destinationStreamInfoList[v],T=this._sourceStreamInfoList[v];if(void 0===_)void 0!==E&&void 0!==T&&(T.audioNode.disconnect(E.audioNode),this._destinationStreamInfoList[v]=void 0);else{const g=this._tsUnmixedAudioProvider?.streams[v]??void 0;if(void 0!==T&&T.mediaStream!==g&&(void 0!==E&&T.audioNode.disconnect(E.audioNode),T=void 0,this._sourceStreamInfoList[v]=void 0),!g)continue;let C=!1;void 0!==T&&void 0!==E&&_.participantId!==E.participantId&&(T.audioNode.disconnect(E.audioNode),E=void 0,this._destinationStreamInfoList[v]=void 0),void 0===E&&(E=this._destinationStreamInfoMap.get(_.participantId),void 0===E&&(E={participantId:_.participantId,identifier:constructIdentifierKindFromMri(_.mri),audioNode:m.createMediaStreamDestination()},this._destinationStreamInfoMap.set(_.participantId,E)),this._destinationStreamInfoList[v]=E,C=!0),void 0===T&&(T={mediaStream:g,audioNode:m.createMediaStreamSource(g)},this._sourceStreamInfoList[v]=T,C=!0),C&&T.audioNode.connect(E.audioNode),S.push({id:_.sourceId,stream:E.audioNode.stream,participantId:_.participantId,identifier:E.identifier})}}this._eventEmitter.emit("participantSpeaking",{speakers:S})}async _enableSpatialAudio(g){await this._tsCall.setAudioMidcallConfigJson({enableSpatialAudio:g}),this._lastestSpatialAudioRequest=g?"enable":"disable"}async _runTasks(g){let m;if((await Promise.allSettled(g.map((g=>g[1])))).forEach(((S,v)=>{"rejected"===S.status&&(this._logger.info(`Failed to ${g[v][0]}: ${getErrorString$1(S.reason)}}`),m=S)})),void 0!==m)throw m.reason}}class UnmixedAudioCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g)}initialize(g,m){const S=getAcsEcsConfig().unmixedAudio;this._tsCall=g.tsCall,this._logger=m.createChild("UnmixedAudioCallFeature"),this._telemetryLogManager=g.telemetryLogManager;const v=new UnmixedAudioTelemetryLogger(this._tsCall,this._telemetryLogManager);this._unmixedAudioManager=new UnmixedAudioManager(this._tsCall,this._logger,v,S),this._unmixedAudioManager.initialize().then((()=>{this._sendFeatureUsage("initialize",Rh.initialize)})).catch((g=>{}))}get name(){return this._sendFeatureUsage("name",Rh.getter),"UnmixedAudio"}dispose(){this.disposed||(this._unmixedAudioManager.dispose(),super.dispose())}enableUnmixedAudio(){return this._unmixedAudioManager.enableUnmixedAudio()}disableUnmixedAudio(){return this._unmixedAudioManager.disableUnmixedAudio()}get isUnmixedAudioActive(){return this._unmixedAudioManager.isUnmixedAudioActive}on(g,m){if("participantSpeaking"!==g)throw invalidEventSubscription$1(g,"subscribe");this._sendFeatureUsage(g,Rh.subscribe),this._unmixedAudioManager.on(g,m)}off(g,m){if("participantSpeaking"!==g)throw invalidEventSubscription$1(g,"unsubscribe");this._sendFeatureUsage(g,Rh.unsubscribe),this._unmixedAudioManager.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"UnmixedAudio",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}class TeamsMeetingAudioConferencingCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new TeamsMeetingConferencingCallFeatureImplOverTsCall}get name(){return"TeamsMeetingAudioConferencing"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)}async getTeamsMeetingAudioConferencingDetails(){return this._impl.getTeamsMeetingAudioConferencingDetails()}dispose(){this.disposed||super.dispose()}}class TeamsMeetingConferencingCallFeatureImplOverTsCall{constructor(){this._isEnabled=getAcsEcsConfig().calling.teamsMeetingAudioConferencing.enabled,this._supportedConversationTypes=getAcsEcsConfig().calling.teamsMeetingAudioConferencing.supportedConversationTypes}initialize(g,m,S,v){this._logger=v.createChild((()=>`teamsMeetingAudioConferencing::Call(id='${g.callId}')`)),this._tsCall=g,this._telemetryLogManager=S,this._internalCallAgent=m;const C="initialize";if(this.sendFeatureUsage(C,Rh.initialize),!this.isSupportedConversationType()){const g=new CallingCommunicationError({defaultError:D.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.ONLY_AVAILABLE_IN_MEETINGS});throw this._logger.error(g.message),this.sendFeatureUsage(C,Rh.failure,g),g}this.sendFeatureUsage(C,Rh.success)}getTeamsMeetingAudioConferencingDetails(){const g="getTeamsMeetingAudioConferencingDetails";if(this.sendFeatureUsage(g,Rh.attempt),!this._isEnabled){const m=new CallingCommunicationError({defaultError:D.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.DISABLED});return this._logger.error(m.message),this.sendFeatureUsage(g,Rh.failure,m),Promise.reject(m)}if(!this.isSupportedConversationType()){const m=new CallingCommunicationError({defaultError:D.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.ONLY_AVAILABLE_IN_MEETINGS});return this._logger.error(m.message),this.sendFeatureUsage(g,Rh.failure,m),Promise.reject(m)}let m;if(3!==this._tsCall.state)return m=new CallingCommunicationError({defaultError:D.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.UNAVAILABLE_BEFORE_JOINING}),10===this._tsCall.state&&(m=new CallingCommunicationError({defaultError:D.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.UNVAILABLE_IN_LOBBY})),this.sendFeatureUsage(g,Rh.failure,m),this._logger.error(m.message),Promise.reject(m);let S={phoneNumbers:[],phoneConferenceId:""};try{const m=this._tsCall?.meetingDetails?.pstnDetails?.acpMcuInfo?.settings;if(!m)throw new CallingCommunicationError({defaultError:D.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.DETAILS_NOT_CONFIGURED});{let g={tollPhoneNumber:m.tollNumber&&constructIdentifierKindFromMri(wo+m.tollNumber),tollFreePhoneNumber:m.tollFreeNumber&&constructIdentifierKindFromMri(wo+m.tollFreeNumber)};S={phoneNumbers:[g],phoneConferenceId:m.participantPasscode||""},this._logger.info("Teams meeting audio conferencing details was retrieved successfully")}return this.sendFeatureUsage(g,Rh.success),Promise.resolve(S)}catch(m){const S=new CallingCommunicationError({defaultError:D.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.GET_DETAILS_FAILED,originalError:m});throw this.sendFeatureUsage(g,Rh.failure,S),S}}isSupportedConversationType(){const g=this._tsCall.conversationType;let m=this._supportedConversationTypes.find((m=>m===g));return this._logger.info(`TeamsMeetingAudioConferencingDetails::ConversationType = \n            ${g}. ConversationType is supported = ${m}`),m}sendFeatureUsage(g,m,S){let v=S?{code:S?.code||F,subCode:S?.subCode||0,failureReason:S?.message||"",...extractCommunicationServicesErrorForTelemetry(S)}:void 0;sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"TeamsMeetingAudioConferencing",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:v},this._telemetryLogManager,this._logger)}}var Gg,jg=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.TraceLevel=void 0,function(g){g[g.Error=10]="Error",g[g.Warning=15]="Warning",g[g.Info=50]="Info"}(m.TraceLevel||(m.TraceLevel={}))})),qg=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.MessageTrackingOption=m.ConnectionState=m.ServiceGeneratedClientIdName=m.SystemCommandsStateName=m.ConfigurationName=m.SystemSessionStateName=m.StateSubscriptionsName=void 0,m.StateSubscriptionsName="ConfigStateSubscriptions",m.SystemSessionStateName="systemSessionState",m.ConfigurationName="config",m.SystemCommandsStateName="systemCommands",m.ServiceGeneratedClientIdName="serviceGeneratedClientId",function(g){g[g.Disconnected=0]="Disconnected",g[g.Connected=1]="Connected",g[g.Connecting=2]="Connecting"}(m.ConnectionState||(m.ConnectionState={})),function(g){g[g.All=0]="All",g[g.Last=1]="Last",g[g.None=2]="None"}(m.MessageTrackingOption||(m.MessageTrackingOption={}))})),Wg=function bind(g,m){return function wrap(){for(var S=new Array(arguments.length),v=0;v<S.length;v++)S[v]=arguments[v];return g.apply(m,S)}},zg=Object.prototype.toString,Kg=(Gg=Object.create(null),function(g){var m=zg.call(g);return Gg[m]||(Gg[m]=m.slice(8,-1).toLowerCase())});function kindOfTest(g){return g=g.toLowerCase(),function isKindOf(m){return Kg(m)===g}}function isArray$3(g){return Array.isArray(g)}function isUndefined$2(g){return void 0===g}function isBuffer(g){return null!==g&&!isUndefined$2(g)&&null!==g.constructor&&!isUndefined$2(g.constructor)&&"function"==typeof g.constructor.isBuffer&&g.constructor.isBuffer(g)}var Jg=kindOfTest("ArrayBuffer");function isArrayBufferView(g){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(g):g&&g.buffer&&Jg(g.buffer)}function isString$2(g){return"string"==typeof g}function isNumber$2(g){return"number"==typeof g}function isObject$1(g){return null!==g&&"object"==typeof g}function isPlainObject(g){if("object"!==Kg(g))return!1;var m=Object.getPrototypeOf(g);return null===m||m===Object.prototype}var Yg=kindOfTest("Date"),Qg=kindOfTest("File"),Xg=kindOfTest("Blob"),Zg=kindOfTest("FileList");function isFunction$2(g){return"[object Function]"===zg.call(g)}function isStream(g){return isObject$1(g)&&isFunction$2(g.pipe)}function isFormData(g){var m="[object FormData]";return g&&("function"==typeof FormData&&g instanceof FormData||zg.call(g)===m||isFunction$2(g.toString)&&g.toString()===m)}var ep=kindOfTest("URLSearchParams");function trim(g){return g.trim?g.trim():g.replace(/^\s+|\s+$/g,"")}function isStandardBrowserEnv(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)}function forEach(g,m){if(null!=g)if("object"!=typeof g&&(g=[g]),isArray$3(g))for(var S=0,v=g.length;S<v;S++)m.call(null,g[S],S,g);else for(var C in g)Object.prototype.hasOwnProperty.call(g,C)&&m.call(null,g[C],C,g)}function merge(){var g={};function assignValue(m,S){isPlainObject(g[S])&&isPlainObject(m)?g[S]=merge(g[S],m):isPlainObject(m)?g[S]=merge({},m):isArray$3(m)?g[S]=m.slice():g[S]=m}for(var m=0,S=arguments.length;m<S;m++)forEach(arguments[m],assignValue);return g}function extend$1(g,m,S){return forEach(m,(function assignValue(m,v){g[v]=S&&"function"==typeof m?Wg(m,S):m})),g}function stripBOM(g){return 65279===g.charCodeAt(0)&&(g=g.slice(1)),g}function inherits(g,m,S,v){g.prototype=Object.create(m.prototype,v),g.prototype.constructor=g,S&&Object.assign(g.prototype,S)}function toFlatObject(g,m,S){var v,C,_,E={};m=m||{};do{for(C=(v=Object.getOwnPropertyNames(g)).length;C-- >0;)E[_=v[C]]||(m[_]=g[_],E[_]=!0);g=Object.getPrototypeOf(g)}while(g&&(!S||S(g,m))&&g!==Object.prototype);return m}function endsWith(g,m,S){g=String(g),(void 0===S||S>g.length)&&(S=g.length),S-=m.length;var v=g.indexOf(m,S);return-1!==v&&v===S}function toArray(g){if(!g)return null;var m=g.length;if(isUndefined$2(m))return null;for(var S=new Array(m);m-- >0;)S[m]=g[m];return S}var tp,ip=(tp="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(g){return tp&&g instanceof tp}),np={isArray:isArray$3,isArrayBuffer:Jg,isBuffer:isBuffer,isFormData:isFormData,isArrayBufferView:isArrayBufferView,isString:isString$2,isNumber:isNumber$2,isObject:isObject$1,isPlainObject:isPlainObject,isUndefined:isUndefined$2,isDate:Yg,isFile:Qg,isBlob:Xg,isFunction:isFunction$2,isStream:isStream,isURLSearchParams:ep,isStandardBrowserEnv:isStandardBrowserEnv,forEach:forEach,merge:merge,extend:extend$1,trim:trim,stripBOM:stripBOM,inherits:inherits,toFlatObject:toFlatObject,kindOf:Kg,kindOfTest:kindOfTest,endsWith:endsWith,toArray:toArray,isTypedArray:ip,isFileList:Zg};function encode(g){return encodeURIComponent(g).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var rp=function buildURL(g,m,S){if(!m)return g;var v;if(S)v=S(m);else if(np.isURLSearchParams(m))v=m.toString();else{var C=[];np.forEach(m,(function serialize(g,m){null!=g&&(np.isArray(g)?m+="[]":g=[g],np.forEach(g,(function parseValue(g){np.isDate(g)?g=g.toISOString():np.isObject(g)&&(g=JSON.stringify(g)),C.push(encode(m)+"="+encode(g))})))})),v=C.join("&")}if(v){var _=g.indexOf("#");-1!==_&&(g=g.slice(0,_)),g+=(-1===g.indexOf("?")?"?":"&")+v}return g};function InterceptorManager(){this.handlers=[]}InterceptorManager.prototype.use=function use(g,m,S){return this.handlers.push({fulfilled:g,rejected:m,synchronous:!!S&&S.synchronous,runWhen:S?S.runWhen:null}),this.handlers.length-1},InterceptorManager.prototype.eject=function eject(g){this.handlers[g]&&(this.handlers[g]=null)},InterceptorManager.prototype.forEach=function forEach(g){np.forEach(this.handlers,(function forEachHandler(m){null!==m&&g(m)}))};var sp=InterceptorManager,ap=function normalizeHeaderName(g,m){np.forEach(g,(function processHeader(S,v){v!==m&&v.toUpperCase()===m.toUpperCase()&&(g[m]=S,delete g[v])}))};function AxiosError(g,m,S,v,C){Error.call(this),this.message=g,this.name="AxiosError",m&&(this.code=m),S&&(this.config=S),v&&(this.request=v),C&&(this.response=C)}np.inherits(AxiosError,Error,{toJSON:function toJSON(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var op=AxiosError.prototype,lp={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(g){lp[g]={value:g}})),Object.defineProperties(AxiosError,lp),Object.defineProperty(op,"isAxiosError",{value:!0}),AxiosError.from=function(g,m,S,v,C,_){var E=Object.create(op);return np.toFlatObject(g,E,(function filter(g){return g!==Error.prototype})),AxiosError.call(E,g.message,m,S,v,C),E.name=g.name,_&&Object.assign(E,_),E};var cp=AxiosError,dp={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function toFormData(g,m){m=m||new FormData;var S=[];function convertValue(g){return null===g?"":np.isDate(g)?g.toISOString():np.isArrayBuffer(g)||np.isTypedArray(g)?"function"==typeof Blob?new Blob([g]):Buffer.from(g):g}function build(g,v){if(np.isPlainObject(g)||np.isArray(g)){if(-1!==S.indexOf(g))throw Error("Circular reference detected in "+v);S.push(g),np.forEach(g,(function each(g,S){if(!np.isUndefined(g)){var C,_=v?v+"."+S:S;if(g&&!v&&"object"==typeof g)if(np.endsWith(S,"{}"))g=JSON.stringify(g);else if(np.endsWith(S,"[]")&&(C=np.toArray(g)))return void C.forEach((function(g){!np.isUndefined(g)&&m.append(_,convertValue(g))}));build(g,_)}})),S.pop()}else m.append(v,convertValue(g))}return build(g),m}var hp=toFormData,up=function settle(g,m,S){var v=S.config.validateStatus;S.status&&v&&!v(S.status)?m(new cp("Request failed with status code "+S.status,[cp.ERR_BAD_REQUEST,cp.ERR_BAD_RESPONSE][Math.floor(S.status/100)-4],S.config,S.request,S)):g(S)},gp=np.isStandardBrowserEnv()?function standardBrowserEnv(){return{write:function write(g,m,S,v,C,_){var E=[];E.push(g+"="+encodeURIComponent(m)),np.isNumber(S)&&E.push("expires="+new Date(S).toGMTString()),np.isString(v)&&E.push("path="+v),np.isString(C)&&E.push("domain="+C),!0===_&&E.push("secure"),document.cookie=E.join("; ")},read:function read(g){var m=document.cookie.match(new RegExp("(^|;\\s*)("+g+")=([^;]*)"));return m?decodeURIComponent(m[3]):null},remove:function remove(g){this.write(g,"",Date.now()-864e5)}}}():{write:function write(){},read:function read(){return null},remove:function remove(){}},pp=function isAbsoluteURL(g){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(g)},mp=function combineURLs(g,m){return m?g.replace(/\/+$/,"")+"/"+m.replace(/^\/+/,""):g},fp=function buildFullPath(g,m){return g&&!pp(m)?mp(g,m):m},Sp=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],vp=function parseHeaders(g){var m,S,v,C={};return g?(np.forEach(g.split("\n"),(function parser(g){if(v=g.indexOf(":"),m=np.trim(g.substr(0,v)).toLowerCase(),S=np.trim(g.substr(v+1)),m){if(C[m]&&Sp.indexOf(m)>=0)return;C[m]="set-cookie"===m?(C[m]?C[m]:[]).concat([S]):C[m]?C[m]+", "+S:S}})),C):C},Cp=np.isStandardBrowserEnv()?function standardBrowserEnv(){var g,m=/(msie|trident)/i.test(navigator.userAgent),S=document.createElement("a");function resolveURL(g){var v=g;return m&&(S.setAttribute("href",v),v=S.href),S.setAttribute("href",v),{href:S.href,protocol:S.protocol?S.protocol.replace(/:$/,""):"",host:S.host,search:S.search?S.search.replace(/^\?/,""):"",hash:S.hash?S.hash.replace(/^#/,""):"",hostname:S.hostname,port:S.port,pathname:"/"===S.pathname.charAt(0)?S.pathname:"/"+S.pathname}}return g=resolveURL(window.location.href),function isURLSameOrigin(m){var S=np.isString(m)?resolveURL(m):m;return S.protocol===g.protocol&&S.host===g.host}}():function isURLSameOrigin(){return!0};function CanceledError(g){cp.call(this,null==g?"canceled":g,cp.ERR_CANCELED),this.name="CanceledError"}np.inherits(CanceledError,cp,{__CANCEL__:!0});var _p=CanceledError,yp=function parseProtocol(g){var m=/^([-+\w]{1,25})(:?\/\/|:)/.exec(g);return m&&m[1]||""},Ep=function xhrAdapter(g){return new Promise((function dispatchXhrRequest(m,S){var v,C=g.data,_=g.headers,E=g.responseType;function done(){g.cancelToken&&g.cancelToken.unsubscribe(v),g.signal&&g.signal.removeEventListener("abort",v)}np.isFormData(C)&&np.isStandardBrowserEnv()&&delete _["Content-Type"];var T=new XMLHttpRequest;if(g.auth){var I=g.auth.username||"",b=g.auth.password?unescape(encodeURIComponent(g.auth.password)):"";_.Authorization="Basic "+btoa(I+":"+b)}var A=fp(g.baseURL,g.url);function onloadend(){if(T){var v="getAllResponseHeaders"in T?vp(T.getAllResponseHeaders()):null,C={data:E&&"text"!==E&&"json"!==E?T.response:T.responseText,status:T.status,statusText:T.statusText,headers:v,config:g,request:T};up((function _resolve(g){m(g),done()}),(function _reject(g){S(g),done()}),C),T=null}}if(T.open(g.method.toUpperCase(),rp(A,g.params,g.paramsSerializer),!0),T.timeout=g.timeout,"onloadend"in T?T.onloadend=onloadend:T.onreadystatechange=function handleLoad(){T&&4===T.readyState&&(0!==T.status||T.responseURL&&0===T.responseURL.indexOf("file:"))&&setTimeout(onloadend)},T.onabort=function handleAbort(){T&&(S(new cp("Request aborted",cp.ECONNABORTED,g,T)),T=null)},T.onerror=function handleError(){S(new cp("Network Error",cp.ERR_NETWORK,g,T,T)),T=null},T.ontimeout=function handleTimeout(){var m=g.timeout?"timeout of "+g.timeout+"ms exceeded":"timeout exceeded",v=g.transitional||dp;g.timeoutErrorMessage&&(m=g.timeoutErrorMessage),S(new cp(m,v.clarifyTimeoutError?cp.ETIMEDOUT:cp.ECONNABORTED,g,T)),T=null},np.isStandardBrowserEnv()){var R=(g.withCredentials||Cp(A))&&g.xsrfCookieName?gp.read(g.xsrfCookieName):void 0;R&&(_[g.xsrfHeaderName]=R)}"setRequestHeader"in T&&np.forEach(_,(function setRequestHeader(g,m){void 0===C&&"content-type"===m.toLowerCase()?delete _[m]:T.setRequestHeader(m,g)})),np.isUndefined(g.withCredentials)||(T.withCredentials=!!g.withCredentials),E&&"json"!==E&&(T.responseType=g.responseType),"function"==typeof g.onDownloadProgress&&T.addEventListener("progress",g.onDownloadProgress),"function"==typeof g.onUploadProgress&&T.upload&&T.upload.addEventListener("progress",g.onUploadProgress),(g.cancelToken||g.signal)&&(v=function(g){T&&(S(!g||g&&g.type?new _p:g),T.abort(),T=null)},g.cancelToken&&g.cancelToken.subscribe(v),g.signal&&(g.signal.aborted?v():g.signal.addEventListener("abort",v))),C||(C=null);var P=yp(A);P&&-1===["http","https","file"].indexOf(P)?S(new cp("Unsupported protocol "+P+":",cp.ERR_BAD_REQUEST,g)):T.send(C)}))},Tp=null,Ip={"Content-Type":"application/x-www-form-urlencoded"};function setContentTypeIfUnset(g,m){!np.isUndefined(g)&&np.isUndefined(g["Content-Type"])&&(g["Content-Type"]=m)}function getDefaultAdapter(){var g;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(g=Ep),g}function stringifySafely(g,m,S){if(np.isString(g))try{return(m||JSON.parse)(g),np.trim(g)}catch(g){if("SyntaxError"!==g.name)throw g}return(S||JSON.stringify)(g)}var bp={transitional:dp,adapter:getDefaultAdapter(),transformRequest:[function transformRequest(g,m){if(ap(m,"Accept"),ap(m,"Content-Type"),np.isFormData(g)||np.isArrayBuffer(g)||np.isBuffer(g)||np.isStream(g)||np.isFile(g)||np.isBlob(g))return g;if(np.isArrayBufferView(g))return g.buffer;if(np.isURLSearchParams(g))return setContentTypeIfUnset(m,"application/x-www-form-urlencoded;charset=utf-8"),g.toString();var S,v=np.isObject(g),C=m&&m["Content-Type"];if((S=np.isFileList(g))||v&&"multipart/form-data"===C){var _=this.env&&this.env.FormData;return hp(S?{"files[]":g}:g,_&&new _)}return v||"application/json"===C?(setContentTypeIfUnset(m,"application/json"),stringifySafely(g)):g}],transformResponse:[function transformResponse(g){var m=this.transitional||bp.transitional,S=m&&m.silentJSONParsing,v=m&&m.forcedJSONParsing,C=!S&&"json"===this.responseType;if(C||v&&np.isString(g)&&g.length)try{return JSON.parse(g)}catch(g){if(C){if("SyntaxError"===g.name)throw cp.from(g,cp.ERR_BAD_RESPONSE,this,null,this.response);throw g}}return g}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Tp},validateStatus:function validateStatus(g){return g>=200&&g<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};np.forEach(["delete","get","head"],(function forEachMethodNoData(g){bp.headers[g]={}})),np.forEach(["post","put","patch"],(function forEachMethodWithData(g){bp.headers[g]=np.merge(Ip)}));var Ap=bp,Rp=function transformData(g,m,S){var v=this||Ap;return np.forEach(S,(function transform(S){g=S.call(v,g,m)})),g},Pp=function isCancel(g){return!(!g||!g.__CANCEL__)};function throwIfCancellationRequested(g){if(g.cancelToken&&g.cancelToken.throwIfRequested(),g.signal&&g.signal.aborted)throw new _p}var Mp=function dispatchRequest(g){return throwIfCancellationRequested(g),g.headers=g.headers||{},g.data=Rp.call(g,g.data,g.headers,g.transformRequest),g.headers=np.merge(g.headers.common||{},g.headers[g.method]||{},g.headers),np.forEach(["delete","get","head","post","put","patch","common"],(function cleanHeaderConfig(m){delete g.headers[m]})),(g.adapter||Ap.adapter)(g).then((function onAdapterResolution(m){return throwIfCancellationRequested(g),m.data=Rp.call(g,m.data,m.headers,g.transformResponse),m}),(function onAdapterRejection(m){return Pp(m)||(throwIfCancellationRequested(g),m&&m.response&&(m.response.data=Rp.call(g,m.response.data,m.response.headers,g.transformResponse))),Promise.reject(m)}))},wp=function mergeConfig(g,m){m=m||{};var S={};function getMergedValue(g,m){return np.isPlainObject(g)&&np.isPlainObject(m)?np.merge(g,m):np.isPlainObject(m)?np.merge({},m):np.isArray(m)?m.slice():m}function mergeDeepProperties(S){return np.isUndefined(m[S])?np.isUndefined(g[S])?void 0:getMergedValue(void 0,g[S]):getMergedValue(g[S],m[S])}function valueFromConfig2(g){if(!np.isUndefined(m[g]))return getMergedValue(void 0,m[g])}function defaultToConfig2(S){return np.isUndefined(m[S])?np.isUndefined(g[S])?void 0:getMergedValue(void 0,g[S]):getMergedValue(void 0,m[S])}function mergeDirectKeys(S){return S in m?getMergedValue(g[S],m[S]):S in g?getMergedValue(void 0,g[S]):void 0}var v={url:valueFromConfig2,method:valueFromConfig2,data:valueFromConfig2,baseURL:defaultToConfig2,transformRequest:defaultToConfig2,transformResponse:defaultToConfig2,paramsSerializer:defaultToConfig2,timeout:defaultToConfig2,timeoutMessage:defaultToConfig2,withCredentials:defaultToConfig2,adapter:defaultToConfig2,responseType:defaultToConfig2,xsrfCookieName:defaultToConfig2,xsrfHeaderName:defaultToConfig2,onUploadProgress:defaultToConfig2,onDownloadProgress:defaultToConfig2,decompress:defaultToConfig2,maxContentLength:defaultToConfig2,maxBodyLength:defaultToConfig2,beforeRedirect:defaultToConfig2,transport:defaultToConfig2,httpAgent:defaultToConfig2,httpsAgent:defaultToConfig2,cancelToken:defaultToConfig2,socketPath:defaultToConfig2,responseEncoding:defaultToConfig2,validateStatus:mergeDirectKeys};return np.forEach(Object.keys(g).concat(Object.keys(m)),(function computeConfigValue(g){var m=v[g]||mergeDeepProperties,C=m(g);np.isUndefined(C)&&m!==mergeDirectKeys||(S[g]=C)})),S},Dp={version:"0.27.2"},Op=Dp.version,Np={};["object","boolean","number","function","string","symbol"].forEach((function(g,m){Np[g]=function validator(S){return typeof S===g||"a"+(m<1?"n ":" ")+g}}));var kp={};function assertOptions(g,m,S){if("object"!=typeof g)throw new cp("options must be an object",cp.ERR_BAD_OPTION_VALUE);for(var v=Object.keys(g),C=v.length;C-- >0;){var _=v[C],E=m[_];if(E){var T=g[_],I=void 0===T||E(T,_,g);if(!0!==I)throw new cp("option "+_+" must be "+I,cp.ERR_BAD_OPTION_VALUE)}else if(!0!==S)throw new cp("Unknown option "+_,cp.ERR_BAD_OPTION)}}Np.transitional=function transitional(g,m,S){function formatMessage(g,m){return"[Axios v"+Op+"] Transitional option '"+g+"'"+m+(S?". "+S:"")}return function(S,v,C){if(!1===g)throw new cp(formatMessage(v," has been removed"+(m?" in "+m:"")),cp.ERR_DEPRECATED);return m&&!kp[v]&&(kp[v]=!0,console.warn(formatMessage(v," has been deprecated since v"+m+" and will be removed in the near future"))),!g||g(S,v,C)}};var Lp={assertOptions:assertOptions,validators:Np},Fp=Lp.validators;function Axios(g){this.defaults=g,this.interceptors={request:new sp,response:new sp}}Axios.prototype.request=function request(g,m){"string"==typeof g?(m=m||{}).url=g:m=g||{},(m=wp(this.defaults,m)).method?m.method=m.method.toLowerCase():this.defaults.method?m.method=this.defaults.method.toLowerCase():m.method="get";var S=m.transitional;void 0!==S&&Lp.assertOptions(S,{silentJSONParsing:Fp.transitional(Fp.boolean),forcedJSONParsing:Fp.transitional(Fp.boolean),clarifyTimeoutError:Fp.transitional(Fp.boolean)},!1);var v=[],C=!0;this.interceptors.request.forEach((function unshiftRequestInterceptors(g){"function"==typeof g.runWhen&&!1===g.runWhen(m)||(C=C&&g.synchronous,v.unshift(g.fulfilled,g.rejected))}));var _,E=[];if(this.interceptors.response.forEach((function pushResponseInterceptors(g){E.push(g.fulfilled,g.rejected)})),!C){var T=[Mp,void 0];for(Array.prototype.unshift.apply(T,v),T=T.concat(E),_=Promise.resolve(m);T.length;)_=_.then(T.shift(),T.shift());return _}for(var I=m;v.length;){var b=v.shift(),A=v.shift();try{I=b(I)}catch(g){A(g);break}}try{_=Mp(I)}catch(g){return Promise.reject(g)}for(;E.length;)_=_.then(E.shift(),E.shift());return _},Axios.prototype.getUri=function getUri(g){g=wp(this.defaults,g);var m=fp(g.baseURL,g.url);return rp(m,g.params,g.paramsSerializer)},np.forEach(["delete","get","head","options"],(function forEachMethodNoData(g){Axios.prototype[g]=function(m,S){return this.request(wp(S||{},{method:g,url:m,data:(S||{}).data}))}})),np.forEach(["post","put","patch"],(function forEachMethodWithData(g){function generateHTTPMethod(m){return function httpMethod(S,v,C){return this.request(wp(C||{},{method:g,headers:m?{"Content-Type":"multipart/form-data"}:{},url:S,data:v}))}}Axios.prototype[g]=generateHTTPMethod(),Axios.prototype[g+"Form"]=generateHTTPMethod(!0)}));var xp=Axios;function CancelToken(g){if("function"!=typeof g)throw new TypeError("executor must be a function.");var m;this.promise=new Promise((function promiseExecutor(g){m=g}));var S=this;this.promise.then((function(g){if(S._listeners){var m,v=S._listeners.length;for(m=0;m<v;m++)S._listeners[m](g);S._listeners=null}})),this.promise.then=function(g){var m,v=new Promise((function(g){S.subscribe(g),m=g})).then(g);return v.cancel=function reject(){S.unsubscribe(m)},v},g((function cancel(g){S.reason||(S.reason=new _p(g),m(S.reason))}))}CancelToken.prototype.throwIfRequested=function throwIfRequested(){if(this.reason)throw this.reason},CancelToken.prototype.subscribe=function subscribe(g){this.reason?g(this.reason):this._listeners?this._listeners.push(g):this._listeners=[g]},CancelToken.prototype.unsubscribe=function unsubscribe(g){if(this._listeners){var m=this._listeners.indexOf(g);-1!==m&&this._listeners.splice(m,1)}},CancelToken.source=function source(){var g;return{token:new CancelToken((function executor(m){g=m})),cancel:g}};var Up=CancelToken,Vp=function spread(g){return function wrap(m){return g.apply(null,m)}},Bp=function isAxiosError(g){return np.isObject(g)&&!0===g.isAxiosError};function createInstance(g){var m=new xp(g),S=Wg(xp.prototype.request,m);return np.extend(S,xp.prototype,m),np.extend(S,m),S.create=function create(m){return createInstance(wp(g,m))},S}var Hp=createInstance(Ap);Hp.Axios=xp,Hp.CanceledError=_p,Hp.CancelToken=Up,Hp.isCancel=Pp,Hp.VERSION=Dp.version,Hp.toFormData=hp,Hp.AxiosError=cp,Hp.Cancel=Hp.CanceledError,Hp.all=function all(g){return Promise.all(g)},Hp.spread=Vp,Hp.isAxiosError=Bp;var $p=Hp,Gp=Hp;$p.default=Gp;for(var jp=$p,qp=createCommonjsModule((function(g){var m="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(m){var S=new Uint8Array(16);g.exports=function whatwgRNG(){return m(S),S}}else{var v=new Array(16);g.exports=function mathRNG(){for(var g,m=0;m<16;m++)0==(3&m)&&(g=4294967296*Math.random()),v[m]=g>>>((3&m)<<3)&255;return v}}})),Wp=[],zp=0;zp<256;++zp)Wp[zp]=(zp+256).toString(16).substr(1);function bytesToUuid(g,m){var S=m||0,v=Wp;return[v[g[S++]],v[g[S++]],v[g[S++]],v[g[S++]],"-",v[g[S++]],v[g[S++]],"-",v[g[S++]],v[g[S++]],"-",v[g[S++]],v[g[S++]],"-",v[g[S++]],v[g[S++]],v[g[S++]],v[g[S++]],v[g[S++]],v[g[S++]]].join("")}var Kp,Jp,Yp=bytesToUuid,Qp=0,Xp=0;function v1(g,m,S){var v=m&&S||0,C=m||[],_=(g=g||{}).node||Kp,E=void 0!==g.clockseq?g.clockseq:Jp;if(null==_||null==E){var T=qp();null==_&&(_=Kp=[1|T[0],T[1],T[2],T[3],T[4],T[5]]),null==E&&(E=Jp=16383&(T[6]<<8|T[7]))}var I=void 0!==g.msecs?g.msecs:(new Date).getTime(),b=void 0!==g.nsecs?g.nsecs:Xp+1,A=I-Qp+(b-Xp)/1e4;if(A<0&&void 0===g.clockseq&&(E=E+1&16383),(A<0||I>Qp)&&void 0===g.nsecs&&(b=0),b>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Qp=I,Xp=b,Jp=E;var R=(1e4*(268435455&(I+=122192928e5))+b)%4294967296;C[v++]=R>>>24&255,C[v++]=R>>>16&255,C[v++]=R>>>8&255,C[v++]=255&R;var P=I/4294967296*1e4&268435455;C[v++]=P>>>8&255,C[v++]=255&P,C[v++]=P>>>24&15|16,C[v++]=P>>>16&255,C[v++]=E>>>8|128,C[v++]=255&E;for(var M=0;M<6;++M)C[v+M]=_[M];return m||Yp(C)}var Zp=v1;function v4(g,m,S){var v=m&&S||0;"string"==typeof g&&(m="binary"===g?new Array(16):null,g=null);var C=(g=g||{}).random||(g.rng||qp)();if(C[6]=15&C[6]|64,C[8]=63&C[8]|128,m)for(var _=0;_<16;++_)m[v+_]=C[_];return m||Yp(C)}var em=v4,tm=em;tm.v1=Zp,tm.v4=em;var im=tm,nm=createCommonjsModule((function(g,m){var S=C&&C.__assign||function(){return S=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},S.apply(this,arguments)};function errorToString(g,m){if(void 0===m&&(m=!0),null==g)return"";if("string"==typeof g)return g;try{return JSON.stringify(g,circularReplacer(buildErrorJsonReplacer(m)))}catch(g){return"Stringifying error failed"}}Object.defineProperty(m,"__esModule",{value:!0}),m.errorToString=void 0,m.errorToString=errorToString;var buildErrorJsonReplacer=function(g){return void 0===g&&(g=!1),function(m,v){return v instanceof Error?S({name:v.name,message:v.message,stack:g?[]:("string"==typeof v.stack?v.stack:"").split("\n").map((function(g){return g.trim()})).filter((function(g){return!!g}))},v):v}},circularReplacer=function(g){var m=new WeakSet;return function(S,v){if("object"==typeof v&&null!==v){if(m.has(v))return;m.add(v)}return g(S,v)}}})),rm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.EvictingQueue=void 0;var S=function(){function EvictingQueue(g){this.maxSize=g,this._store=[]}return Object.defineProperty(EvictingQueue.prototype,"store",{get:function(){return this._store},enumerable:!1,configurable:!0}),Object.defineProperty(EvictingQueue.prototype,"size",{get:function(){return this._store.length},enumerable:!1,configurable:!0}),EvictingQueue.prototype.enqueue=function(g){this._store.length>=this.maxSize&&this._store.shift(),this._store.push(g)},EvictingQueue.prototype.dequeue=function(){return this._store.shift()},EvictingQueue.prototype.clear=function(){this._store=[]},EvictingQueue.prototype.forEach=function(g){this._store.forEach(g)},EvictingQueue}();m.EvictingQueue=S})),sm=createCommonjsModule((function(g,m){var S=C&&C.__awaiter||function(g,m,S,v){function adopt(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function fulfilled(g){try{step(v.next(g))}catch(g){C(g)}}function rejected(g){try{step(v.throw(g))}catch(g){C(g)}}function step(g){g.done?S(g.value):adopt(g.value).then(fulfilled,rejected)}step((v=v.apply(g,m||[])).next())}))},v=C&&C.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function verb(g){return function(m){return step([g,m])}}function step(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=E.trys,(C=C.length>0&&C[C.length-1])||6!==_[0]&&2!==_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}};Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleSyncCell=void 0;var _=function(){function SimpleSyncCell(g,m,S,v,C){this.m_id=g,this.m_sender=m,this.m_shouldEmitEventForAllMessages=S,this.aggregation=C,this.m_events=new Su.EventEmitter,this.m_emitUnacknowledgedEventFor=null!=v?v:qg.MessageTrackingOption.None}return SimpleSyncCell.prototype.on=function(g,m){return this.m_events.on(g,m),this},SimpleSyncCell.prototype.off=function(g,m){return this.m_events.off(g,m),this},SimpleSyncCell.prototype.removeAllListeners=function(g){return this.m_events.removeAllListeners(g),this},SimpleSyncCell.prototype.id=function(){return this.m_id},SimpleSyncCell.prototype.messageTrackingOption=function(){return this.m_emitUnacknowledgedEventFor},SimpleSyncCell.prototype.getAsync=function(){return S(this,void 0,void 0,(function(){return v(this,(function(g){return[2,this.m_value]}))}))},SimpleSyncCell.prototype.setAsync=function(g){return S(this,void 0,void 0,(function(){var m;return v(this,(function(S){return this.m_value=g,m={messageId:im.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"cell",operation:"set",value:JSON.stringify(this.m_value)},this.m_sender.sendStateMessage(m),[2]}))}))},SimpleSyncCell.prototype.delete=function(){this.m_value=void 0;var g={messageId:im.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"cell",operation:"delete",value:""};this.m_sender.sendStateMessage(g)},SimpleSyncCell.prototype.handleStateMessage=function(g){switch(g.operation){case"set":return void((JSON.stringify(this.m_value)!==g.value||this.m_shouldEmitEventForAllMessages)&&(this.m_value=JSON.parse(g.value),this.m_events.emit("valueChanged",this.m_value,g)));case"delete":return this.m_value=void 0,void this.m_events.emit("valueDeleted",this.m_value,g);default:return}},SimpleSyncCell.prototype.handleUnacknowledgedMessage=function(g){this.m_events.emit("valueUnacknowledged",g)},SimpleSyncCell.prototype.beginAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.beginAggregatedStateUpdating()},SimpleSyncCell.prototype.endAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.endAggregatedStateUpdating()},SimpleSyncCell}();m.SimpleSyncCell=_})),am=createCommonjsModule((function(g,m){function isPrefixDeleteMessage(g){return"delete"===g.operation&&"prefix"===g.value}Object.defineProperty(m,"__esModule",{value:!0}),m.isPrefixDeleteMessage=void 0,m.isPrefixDeleteMessage=isPrefixDeleteMessage})),om=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleSyncMap=void 0;var S=function(){function SimpleSyncMap(g,m,S,v,C){this.m_id=g,this.m_sender=m,this.m_shouldEmitEventForAllMessages=S,this.aggregation=C,this.m_events=new Su.EventEmitter,this.m_map=new Map,this.m_emitUnacknowledgedEventFor=null!=v?v:qg.MessageTrackingOption.None}return SimpleSyncMap.prototype.on=function(g,m){return this.m_events.on(g,m),this},SimpleSyncMap.prototype.off=function(g,m){return this.m_events.off(g,m),this},SimpleSyncMap.prototype.removeAllListeners=function(g){return this.m_events.removeAllListeners(g),this},SimpleSyncMap.prototype.id=function(){return this.m_id},SimpleSyncMap.prototype.messageTrackingOption=function(){return this.m_emitUnacknowledgedEventFor},SimpleSyncMap.prototype.get=function(g){return this.m_map.get(g)},SimpleSyncMap.prototype.set=function(g,m){this.m_map.set(g,m);var S={messageId:im.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"set",property:g,value:JSON.stringify(m)};this.m_sender.sendStateMessage(S)},SimpleSyncMap.prototype.delete=function(g){var m={messageId:im.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"delete",property:g,value:""};this.performLocalDelete(m),this.m_sender.sendStateMessage(m)},SimpleSyncMap.prototype.deleteWithPrefix=function(g){var m={messageId:im.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"delete",property:g,value:"prefix"};this.performLocalDelete(m),this.m_sender.sendStateMessage(m)},SimpleSyncMap.prototype.forEach=function(g){this.m_map.forEach(g)},SimpleSyncMap.prototype.handleStateMessage=function(g){switch(g.operation){case"set":return void this.handleSet(g);case"delete":return void this.handleDelete(g);default:return}},SimpleSyncMap.prototype.handleSet=function(g){if(!g.property)throw new Error("property is missing for a map.");(JSON.stringify(this.m_map.get(g.property))!==g.value||this.m_shouldEmitEventForAllMessages)&&(this.m_map.set(g.property,JSON.parse(g.value)),this.m_events.emit("valueChanged",g.property,g))},SimpleSyncMap.prototype.handleDelete=function(g){this.performLocalDelete(g),am.isPrefixDeleteMessage(g)?this.m_events.emit("valuesDeletedWithPrefix",g.property,g):this.m_events.emit("valueDeleted",g.property||"",g)},SimpleSyncMap.prototype.handleUnacknowledgedMessage=function(g){this.m_events.emit("valueUnacknowledged",g)},SimpleSyncMap.prototype.beginAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.beginAggregatedStateUpdating()},SimpleSyncMap.prototype.endAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.endAggregatedStateUpdating()},SimpleSyncMap.prototype.performLocalDelete=function(g){var m=this;if(g.property){var S=g.property;am.isPrefixDeleteMessage(g)?this.m_map.forEach((function(g,v){v.startsWith(S)&&m.m_map.delete(v)})):this.m_map.delete(g.property)}else this.m_map.clear()},SimpleSyncMap}();m.SimpleSyncMap=S})),lm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleServicePerformanceTelemetry=m.SimpleServiceTelemetry=void 0;var S=function(){function SimpleServiceTelemetry(g,m,S){this.backendService="SimpleService",this.clientId=g,this.sessionId=m,this.wsReconnectCount=0,this.wsState=qg.ConnectionState[qg.ConnectionState.Disconnected],this.maxRoundtripRaw=S||0,this.roundtripTelemetry=new v,this.messageHandleTelemetry=new v,this.offlineCacheTelemetry={cachedCount:0,resentCount:0,expiredCount:0,rejectedCount:0},this.maxRoundtripRaw>0&&(this.roundtripRaw=[]),this.messagePendingAckCount=0,this.unacknowledgedMessagesCount=0,this.messageRequested={},this.messageReceived={},this.messageAcknowledged={}}return SimpleServiceTelemetry.prototype.addRoundtripLatency=function(g){this.roundtripRaw&&this.roundtripRaw.length<this.maxRoundtripRaw&&this.roundtripRaw.push(g),this.roundtripTelemetry.addLatency(g)},SimpleServiceTelemetry.prototype.addMessageHandleLatency=function(g){this.messageHandleTelemetry.addLatency(g)},SimpleServiceTelemetry.prototype.incrementAcknowledgedCount=function(g){this.incrementMessageCount(this.messageAcknowledged,g)},SimpleServiceTelemetry.prototype.incrementRequestedCount=function(g){this.incrementMessageCount(this.messageRequested,g)},SimpleServiceTelemetry.prototype.incrementReceivedCount=function(g){this.incrementMessageCount(this.messageReceived,g)},SimpleServiceTelemetry.prototype.incrementMessageCount=function(g,m){var S=g[m],v=void 0===S?1:S+1;g[m]=v},SimpleServiceTelemetry}();m.SimpleServiceTelemetry=S;var v=function(){function SimpleServicePerformanceTelemetry(){this.count=0,this.minValue=0,this.maxValue=0,this.avgValue=0}return SimpleServicePerformanceTelemetry.prototype.addLatency=function(g){this.count+=1,this.avgValue=this.avgValue+(g-this.avgValue)/this.count,this.minValue=this.count>1?Math.min(g,this.minValue):g,this.maxValue=Math.max(this.maxValue,g)},SimpleServicePerformanceTelemetry}();m.SimpleServicePerformanceTelemetry=v})),cm=createCommonjsModule((function(g,m){var S=C&&C.__awaiter||function(g,m,S,v){function adopt(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function fulfilled(g){try{step(v.next(g))}catch(g){C(g)}}function rejected(g){try{step(v.throw(g))}catch(g){C(g)}}function step(g){g.done?S(g.value):adopt(g.value).then(fulfilled,rejected)}step((v=v.apply(g,m||[])).next())}))},v=C&&C.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function verb(g){return function(m){return step([g,m])}}function step(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=E.trys,(C=C.length>0&&C[C.length-1])||6!==_[0]&&2!==_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}};Object.defineProperty(m,"__esModule",{value:!0}),m.StateServiceWebSocketConnection=void 0;var _=function(){function StateServiceWebSocketConnection(g,m){var C=this;this.onopen=null,this.onclose=null,this.onerror=null,this.onmessage=null,this.onlog=null,this.ws=new WebSocket(g),this.settings=m,this.ws.onopen=function(g){return S(C,void 0,void 0,(function(){return v(this,(function(m){switch(m.label){case 0:return this.onopen&&this.onopen(g),[4,this.sendSetupMessages()];case 1:return m.sent(),[2]}}))}))},this.ws.onclose=function(g){C.onclose&&C.onclose(g)},this.ws.onerror=function(g){C.onerror&&C.onerror(g)},this.ws.onmessage=function(g){C.onmessage&&C.onmessage(g)}}return StateServiceWebSocketConnection.CreateAsync=function(g,m){return S(this,void 0,void 0,(function(){return v(this,(function(S){return[2,new StateServiceWebSocketConnection(g,m)]}))}))},Object.defineProperty(StateServiceWebSocketConnection.prototype,"name",{get:function(){return"WebSocket"},enumerable:!1,configurable:!0}),Object.defineProperty(StateServiceWebSocketConnection.prototype,"readyState",{get:function(){return this.ws.readyState},enumerable:!1,configurable:!0}),Object.defineProperty(StateServiceWebSocketConnection.prototype,"isOpen",{get:function(){return this.ws.readyState===WebSocket.OPEN},enumerable:!1,configurable:!0}),Object.defineProperty(StateServiceWebSocketConnection.prototype,"shouldSendPings",{get:function(){return!0},enumerable:!1,configurable:!0}),StateServiceWebSocketConnection.prototype.close=function(){this.ws.close()},StateServiceWebSocketConnection.prototype.send=function(g){this.ws.send(g)},StateServiceWebSocketConnection.prototype.sendSetupMessages=function(){return S(this,void 0,void 0,(function(){var g,m,S,C,_,E,T=this;return v(this,(function(v){switch(v.label){case 0:return(m=this.settings.getAuthTokenAsync)?[4,this.settings.getAuthTokenAsync()]:[3,2];case 1:m=v.sent(),v.label=2;case 2:return g=m,S=this.settings,C=S.metadata,_=S.subscriptions,E={authToken:g,metadata:C,subscriptions:_},this.settings.createSetupMessage(E).forEach((function(g){return T.send(g)})),[2]}}))}))},StateServiceWebSocketConnection}();m.StateServiceWebSocketConnection=_})),dm=createCommonjsModule((function(g,m){var S=C&&C.__awaiter||function(g,m,S,v){function adopt(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function fulfilled(g){try{step(v.next(g))}catch(g){C(g)}}function rejected(g){try{step(v.throw(g))}catch(g){C(g)}}function step(g){g.done?S(g.value):adopt(g.value).then(fulfilled,rejected)}step((v=v.apply(g,m||[])).next())}))},v=C&&C.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function verb(g){return function(m){return step([g,m])}}function step(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=E.trys,(C=C.length>0&&C[C.length-1])||6!==_[0]&&2!==_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}},_=C&&C.__values||function(g){var m="function"==typeof Symbol&&Symbol.iterator,S=m&&g[m],v=0;if(S)return S.call(g);if(g&&"number"==typeof g.length)return{next:function(){return g&&v>=g.length&&(g=void 0),{value:g&&g[v++],done:!g}}};throw new TypeError(m?"Object is not iterable.":"Symbol.iterator is not defined.")},E=C&&C.__importDefault||function(g){return g&&g.__esModule?g:{default:g}};Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleStateServiceProxy=void 0;var T=E(jp),I=[2e3,2e3,3e3,3e3,5e3],b=4321,A=function(){function SimpleStateServiceProxy(g,m,S,v,C,_){var E;this.m_events=new Su.EventEmitter,this.m_clientId="",this.m_connectionState=qg.ConnectionState.Disconnected,this.m_handlers=new Map,this.m_connection=null,this.m_clientIds=new Set,this.m_initTimeoutDurationInMS=0,this.m_retryAttempts=0,this.m_sessionRetryAttempts=0,this.m_maxSessionRetries=0,this.m_outboundMessageInfo=new Map,this.m_initPromise={promise:null,resolve:null,reject:null},this.m_messageBuffer=[],this.m_batchWaitTimeMS=20,this.m_batchMessageTypeName="list",this.m_closeConnectionTimer=null,this.m_lastCloseCode=0,this.m_lastCloseReason="",this.m_offlineMessageCache=[],this.m_unacknowledgedMessages=new Map,this.m_sessionId=g,this.m_logger=v,this.m_connectionAliveTimeAfterLoseFocusInMS=C.websocketAliveTimeAfterLoseFocusInMS,this.m_useServiceGeneratedClientId=C.useServiceGeneratedClientId||!1,this.m_wsUrl=S+"?docId="+this.m_sessionId+"&clientType="+m,C.correlationId&&(this.m_wsUrl+="&cid="+C.correlationId),C.isAutomation&&(this.m_wsUrl+="&automation=true"),C.autoRoutingEnabled&&(this.m_wsUrl+="&routing=true"),this.m_useServiceGeneratedClientId||(this.m_clientId=C.customClientId||im.v4(),this.m_wsUrl+="&clientId="+this.m_clientId),this.m_deltasBaseUrl=S.replace("wss://","https://").replace("ws://","http://"),this.setupSystemClientsCell(),this.setUpSystemCommandsCell(),this.setupServiceGeneratedClientIdCell(),this.m_useServiceGeneratedClientId&&(this.m_clientIdEvictingQueue=new rm.EvictingQueue(20)),this.m_telemetry=new lm.SimpleServiceTelemetry(this.m_clientId,this.m_sessionId,C.maxRoundtripRaw),this.m_verbose=C.verbose||!1,this.m_batchedRequestsEnabled=C.batchedRequestsEnabled,this.m_initTimeoutDurationInMS=C.initTimeoutDurationInMs||0,this.m_pingTimeoutInMs=C.pingTimeoutInMs,this.m_pongTimeoutInMs=C.pongTimeoutInMs,this.m_user=_,this.m_metadata=C.metadata,this.m_retryIntervalsInMs=C.retryIntervalsInMs||I,this.m_maxSessionRetries=C.maxSessionRetries,this.m_offlineMessageCacheEnabled=C.offlineMessageCacheEnabled,this.m_maxOfflineMessageCacheTimeInMs=C.maxOfflineMessageCacheTimeInMs,this.m_maxOfflineMessageCacheLength=C.maxOfflineMessageCacheLength,this.m_allowReconnectOnMessageSend=C.allowReconnectOnSendMessage||!1,this.m_unacknowledgedMaxTimeInMs=null!==(E=C.unacknowledgeMessageTimeoutInMs)&&void 0!==E?E:0,this.m_subscriptions=C.subscriptions,this.m_connectionSettings={getAuthTokenAsync:this.getAuthToken.bind(this),createSetupMessage:this.createSetupMessage.bind(this),metadata:this.m_metadata,subscriptions:this.m_subscriptions}}return Object.defineProperty(SimpleStateServiceProxy.prototype,"lastCloseReason",{get:function(){return this.m_lastCloseReason},enumerable:!1,configurable:!0}),SimpleStateServiceProxy.prototype.senderId=function(){return this.m_clientId},SimpleStateServiceProxy.prototype.countOfOutboundMessagesNotRoundTrippedYet=function(){return this.m_outboundMessageInfo.size},SimpleStateServiceProxy.prototype.canRetry=function(){return this.m_connectionState===qg.ConnectionState.Disconnected&&this.m_lastCloseCode!==b},SimpleStateServiceProxy.prototype.getServiceTelemetry=function(){return this.m_telemetry.wsState=qg.ConnectionState[this.getConnectionState()],this.m_telemetry.messagePendingAckCount=this.m_outboundMessageInfo.size,this.m_telemetry},SimpleStateServiceProxy.prototype.activeClientCount=function(){return this.m_clientIds.size},SimpleStateServiceProxy.prototype.activeClientIds=function(){return this.m_clientIds},SimpleStateServiceProxy.prototype.clientId=function(){return this.m_clientId},SimpleStateServiceProxy.prototype.getConnectionState=function(){return this.m_connectionState},SimpleStateServiceProxy.prototype.on=function(g,m){return this.m_events.on(g,m),this},SimpleStateServiceProxy.prototype.connectAsync=function(){return S(this,void 0,void 0,(function(){var g=this;return v(this,(function(m){return this.m_initPromise.promise=new Promise((function(m,S){g.m_initPromise.resolve=m,g.m_initPromise.reject=S})),this.setConnectionState(qg.ConnectionState.Connecting),[2,new Promise((function(m,C){return S(g,void 0,void 0,(function(){var g,S=this;return v(this,(function(v){switch(v.label){case 0:return g=this,[4,cm.StateServiceWebSocketConnection.CreateAsync(this.m_wsUrl,this.m_connectionSettings)];case 1:return g.m_connection=v.sent(),this.m_connection.onopen=function(){S.handleConnectionOpen(),S.startInitTimeoutTimerWithRetry(S.m_initTimeoutDurationInMS,S.m_initPromise.reject),m()},this.m_connection.onerror=function(g){var v;S.m_logger.sendTraceTag(590213388,jg.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(v=S.m_connection)||void 0===v?void 0:v.name)+" onerror. {sessionId: "+S.m_sessionId+", ClientId: "+S.m_clientId+", Error: "+JSON.stringify(g)+"}"),S.retryConnection((function(g){var m,v="failed to reconnect after "+(null===(m=S.m_connection)||void 0===m?void 0:m.name)+" error: "+nm.errorToString(g);S.m_logger.sendTraceTag(579463185,jg.TraceLevel.Error,v),C(v)}),!1,(function(){return m()}))},this.m_connection.onlog=function(g){var m;S.m_logger.sendTraceTag(556909603,g.detail.level,"SimpleStateServiceProxy::log - "+(null===(m=S.m_connection)||void 0===m?void 0:m.name)+" {sessionId: "+S.m_sessionId+", ClientId: "+S.m_clientId+", Message: "+g.detail.message+"}")},this.m_connection.onclose=function(g){var v,_;S.m_logger.sendTraceTag(590213389,jg.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(v=S.m_connection)||void 0===v?void 0:v.name)+" onclose. {sessionId: "+S.m_sessionId+", ClientId: "+S.m_clientId+", Code: "+g.code+", Reason: "+g.reason+"}"),S.m_lastCloseCode=g.code,S.m_lastCloseReason=g.reason,g.code!==b?S.retryConnection((function(g){var m="failed to reconnect after service side disconnect: "+nm.errorToString(g);S.m_logger.sendTraceTag(579463186,jg.TraceLevel.Error,m),C(m)}),!1,(function(){return m()})):(S.setConnectionState(qg.ConnectionState.Disconnected),S.m_logger.sendTraceTag(588009741,jg.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(_=S.m_connection)||void 0===_?void 0:_.name)+" onclose. Not retryable close code. {sessionId: "+S.m_sessionId+", ClientId: "+S.m_clientId+"}"))},this.m_connection.onmessage=function(g){var m;try{S.handleConnectionMessage(g)}catch(g){S.m_logger.sendTraceTag(590213390,jg.TraceLevel.Error,"SimpleStateServiceProxy::onmessage - "+(null===(m=S.m_connection)||void 0===m?void 0:m.name)+" error. {sessionId: "+S.m_sessionId+", ClientId: "+S.m_clientId+", Error: "+nm.errorToString(g)+"}")}},[2]}}))}))}))]}))}))},SimpleStateServiceProxy.prototype.close=function(){var g;this.m_logger.sendTraceTag(590213400,jg.TraceLevel.Info,"SimpleStateServiceProxy::close. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.closeAndClearConnection(),this.m_retryTimer&&(clearTimeout(this.m_retryTimer),this.m_retryTimer=null),this.m_unacknowledgedMessages.clear(),this.clearPingPongTimer(),this.clearOfflineMessageCacheTimer(),this.clearInitTimeoutTimer(),this.clearUnacknowledgedTimer(),null===(g=this.m_clientIdEvictingQueue)||void 0===g||g.clear(),0!==this.countOfOutboundMessagesNotRoundTrippedYet()&&(this.m_events.emit("messageFailedToRoundTripOnClose",this.m_outboundMessageInfo.size),this.m_outboundMessageInfo.clear())},SimpleStateServiceProxy.prototype.sendStateMessage=function(g){this.sendStateMessageImpl(g)},SimpleStateServiceProxy.prototype.createMapAsync=function(g,m,C,_){return S(this,void 0,void 0,(function(){var S;return v(this,(function(v){return S=new om.SimpleSyncMap(g,this,m,C,_),this.m_handlers.set(g,S),[2,S]}))}))},SimpleStateServiceProxy.prototype.getMapAsync=function(g){return S(this,void 0,void 0,(function(){var m;return v(this,(function(S){return(m=this.m_handlers.get(g))?[2,m]:[2,null]}))}))},SimpleStateServiceProxy.prototype.waitMapAsync=function(g,m,C,_){return S(this,void 0,void 0,(function(){var S;return v(this,(function(v){switch(v.label){case 0:return[4,this.m_initPromise.promise];case 1:return v.sent(),[4,this.getMapAsync(g)];case 2:return(S=v.sent())?[3,4]:[4,this.createMapAsync(g,m,C,_)];case 3:S=v.sent(),v.label=4;case 4:return[2,S]}}))}))},SimpleStateServiceProxy.prototype.createCellAsync=function(g,m,C,_){return S(this,void 0,void 0,(function(){var S;return v(this,(function(v){return S=new sm.SimpleSyncCell(g,this,m,C,_),this.m_handlers.set(g,S),[2,S]}))}))},SimpleStateServiceProxy.prototype.getCellAsync=function(g){return S(this,void 0,void 0,(function(){var m;return v(this,(function(S){return(m=this.m_handlers.get(g))?[2,m]:[2,null]}))}))},SimpleStateServiceProxy.prototype.waitCellAsync=function(g,m,C,_){return S(this,void 0,void 0,(function(){var S;return v(this,(function(v){switch(v.label){case 0:return this.m_logger.sendTraceTag(520161040,jg.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - awaiting initPromise "+g),[4,this.m_initPromise.promise];case 1:return v.sent(),this.m_logger.sendTraceTag(520161039,jg.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - getCellAsync "+g),[4,this.getCellAsync(g)];case 2:return(S=v.sent())?[3,4]:(this.m_logger.sendTraceTag(520161038,jg.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - createCellAsync "+g),[4,this.createCellAsync(g,m,C,_)]);case 3:S=v.sent(),v.label=4;case 4:return[2,S]}}))}))},SimpleStateServiceProxy.prototype.onFocusChanged=function(g){var m=this;g?(window.clearTimeout(this.m_closeConnectionTimer),this.m_connection||(this.m_logger.sendTraceTag(590213392,jg.TraceLevel.Info,"SimpleStateServiceProxy::onFocusChanged - retryConnection due to getting focus again. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.retryConnection((function(g){m.m_logger.sendTraceTag(579463187,jg.TraceLevel.Error,"failed to reconnect after regaining focus: "+nm.errorToString(g))}),!0))):this.m_closeConnectionTimer=window.setTimeout((function(){var g;m.m_connection&&(m.m_logger.sendTraceTag(590213391,jg.TraceLevel.Info,"SimpleStateServiceProxy::onFocusChanged - "+(null===(g=m.m_connection)||void 0===g?void 0:g.name)+" close due to losing focus. {sessionId: "+m.m_sessionId+", ClientId: "+m.m_clientId+"}"),m.m_connection.onclose=function(){},m.m_connection.close(),m.m_connection=null)}),this.m_connectionAliveTimeAfterLoseFocusInMS)},SimpleStateServiceProxy.prototype.getHistoryAsync=function(g,m){return S(this,void 0,void 0,(function(){var S,C;return v(this,(function(v){switch(v.label){case 0:return(S=new URL(this.m_deltasBaseUrl)).searchParams.append("action","deltas"),S.searchParams.append("docId",this.m_sessionId),S.searchParams.append("cid",this.m_clientId),S.searchParams.append("objectId",g),m&&S.searchParams.append("property",m),[4,T.default.get(S.toString())];case 1:return(C=v.sent().data).forEach((function(g){return g.value=JSON.parse(g.value)})),[2,C]}}))}))},SimpleStateServiceProxy.prototype.getHistoryWithPaginationAsync=function(g,m,C){return S(this,void 0,void 0,(function(){var S,_;return v(this,(function(v){switch(v.label){case 0:return(S=new URL(this.m_deltasBaseUrl)).searchParams.append("action","deltas"),S.searchParams.append("docId",this.m_sessionId),S.searchParams.append("cid",this.m_clientId),S.searchParams.append("objectId",g),S.searchParams.append("pagination","true"),C&&S.searchParams.append("cursor",C),m&&S.searchParams.append("property",m),[4,T.default.get(S.toString())];case 1:return(_=v.sent().data).messages.forEach((function(g){return g.value=JSON.parse(g.value)})),[2,_]}}))}))},SimpleStateServiceProxy.prototype.setupSystemClientsCell=function(){var g=this;this.m_clientsCell=new sm.SimpleSyncCell("systemClients",this),this.m_handlers.set(this.m_clientsCell.id(),this.m_clientsCell),this.m_clientsCell.on("valueChanged",(function(m){g.m_clientIds=new Set(m),g.m_events.emit("activeClientCountChanged")}))},SimpleStateServiceProxy.prototype.setUpSystemCommandsCell=function(){var g=this;this.m_systemCommandsCell=new sm.SimpleSyncCell(qg.SystemCommandsStateName,this),this.m_handlers.set(this.m_systemCommandsCell.id(),this.m_systemCommandsCell),this.m_systemCommandsCell.on("valueChanged",(function(m){return S(g,void 0,void 0,(function(){var g,S,C;return v(this,(function(v){switch(v.label){case 0:return"refreshToken"===m?[3,1]:[3,6];case 1:if(!this.m_user||!this.m_user.getForceRefreshedTokenAsync)return[3,5];v.label=2;case 2:return v.trys.push([2,4,,5]),[4,this.m_user.getForceRefreshedTokenAsync()];case 3:return g=v.sent(),S={},g&&(S.authorization=g.token,S.authProvider=g.authProvider,S.mri=g.mri||"",S.huid=g.hashedUserEmail||""),this.sendConfigMessage(S),[3,5];case 4:return C=v.sent(),this.m_logger.sendTraceTag(574107847,jg.TraceLevel.Error,"Error getting force refreshed auth token: "+nm.errorToString(C)),[3,5];case 5:return[3,7];case 6:return this.m_logger.sendTraceTag(574107848,jg.TraceLevel.Error,"Unknown system command cell value: "+m),[3,7];case 7:return[2]}}))}))}))},SimpleStateServiceProxy.prototype.setupServiceGeneratedClientIdCell=function(){var g=this;this.m_serviceGeneratedClientIdCell=new sm.SimpleSyncCell(qg.ServiceGeneratedClientIdName,this),this.m_handlers.set(this.m_serviceGeneratedClientIdCell.id(),this.m_serviceGeneratedClientIdCell),this.m_serviceGeneratedClientIdCell.on("valueChanged",(function(m){g.m_logger.sendTraceTag(520161037,jg.TraceLevel.Info,"SimpleStateServiceProxy::serviceGeneratedClientId changed to "+m+"}"),g.setClientId(m,!0),g.processClientIdQueue(),g.m_useServiceGeneratedClientId&&(g.processOfflineMessageCache(!0),g.clearOfflineMessageCacheTimer())})),this.m_logger.sendTraceTag(509743689,jg.TraceLevel.Info,"SimpleStateServiceProxy::setupServiceGeneratedClientIdCell completed.")},SimpleStateServiceProxy.prototype.handleConnectionOpen=function(){var g;this.m_logger.sendTraceTag(590213387,jg.TraceLevel.Info,"SimpleStateServiceProxy::connect - "+(null===(g=this.m_connection)||void 0===g?void 0:g.name)+" onopen. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.m_retryAttempts=0,this.setConnectionState(qg.ConnectionState.Connected),this.startPingTimer(),this.m_useServiceGeneratedClientId||(this.processOfflineMessageCache(!1),this.clearOfflineMessageCacheTimer())},SimpleStateServiceProxy.prototype.setConnectionState=function(g){this.m_connectionState!==g&&(this.m_connectionState=g,g===qg.ConnectionState.Disconnected&&this.m_useServiceGeneratedClientId&&this.setClientId("",!1),this.m_events.emit("connectionStateChanged"))},SimpleStateServiceProxy.prototype.setClientId=function(g,m){this.m_clientId!==g&&(this.m_clientId=g,m&&this.m_events.emit("clientIdChanged"))},SimpleStateServiceProxy.prototype.processClientIdQueue=function(){var g=this;this.m_clientIdEvictingQueue&&this.m_clientIdEvictingQueue.forEach((function(m){m.senderId=g.m_clientId,g.sendConnectionMessage(m,!0)}))},SimpleStateServiceProxy.prototype.sendGetInitialSystemStateMessages=function(){try{var g={messageId:im.v4(),senderId:this.senderId(),objectId:qg.SystemSessionStateName,type:"",operation:"get",value:""};this.sendStateMessage(g);var m={messageId:im.v4(),senderId:this.senderId(),objectId:qg.ServiceGeneratedClientIdName,type:"",operation:"get",value:""};this.sendStateMessage(m),this.m_logger.sendTraceTag(509141838,jg.TraceLevel.Info,"SimpleStateServiceProxy::sendGetInitialSystemStateMessages - sent messages.")}catch(g){this.m_logger.sendTraceTag(509141837,jg.TraceLevel.Error,"SimpleStateServiceProxy::sendGetInitialSystemStateMessages - caught error "+g)}},SimpleStateServiceProxy.prototype.createSetupMessage=function(g){var m=g.authToken,S=g.metadata,v=g.subscriptions,C=[];if(m||S){var _={};m&&(_.authorization=m.token,_.authProvider=m.authProvider,_.mri=m.mri||"",_.huid=m.hashedUserEmail||""),S&&(_.metadata=JSON.stringify(S));var E={messageId:im.v4(),senderId:this.senderId(),objectId:qg.ConfigurationName,type:"",operation:"",value:JSON.stringify(_)};C.push(JSON.stringify(E))}if(v){E={messageId:im.v4(),senderId:this.senderId(),objectId:qg.StateSubscriptionsName,type:"",operation:"",value:JSON.stringify(v)};C.push(JSON.stringify(E))}return C},SimpleStateServiceProxy.prototype.sendConfigMessage=function(g){var m={messageId:im.v4(),senderId:this.senderId(),objectId:qg.ConfigurationName,type:"",operation:"",value:JSON.stringify(g)};this.sendStateMessage(m)},SimpleStateServiceProxy.prototype.retryConnection=function(g,m,C){var _=this;if(this.clearPingPongTimer(),this.clearInitTimeoutTimer(),this.m_retryAttempts>=this.m_retryIntervalsInMs.length||this.m_sessionRetryAttempts>=this.m_maxSessionRetries)return this.setConnectionState(qg.ConnectionState.Disconnected),this.m_logger.sendTraceTag(590213393,jg.TraceLevel.Error,"SimpleStateServiceProxy::retryConnection reached max retry attempts. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),void(g&&g(new Error("reached max retry attempts")));if(this.setConnectionState(qg.ConnectionState.Connecting),m||this.m_connection&&!this.m_retryTimer){var E=this.m_retryIntervalsInMs[this.m_retryAttempts];this.m_retryAttempts+=1,this.m_sessionRetryAttempts+=1,this.m_telemetry.wsReconnectCount+=1,this.closeAndClearConnection(),this.m_retryTimer=setTimeout((function(){return S(_,void 0,void 0,(function(){var m;return v(this,(function(S){switch(S.label){case 0:this.m_logger.sendTraceTag(590213395,jg.TraceLevel.Info,"SimpleStateServiceProxy::retryConnection. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.m_retryTimer=null,S.label=1;case 1:return S.trys.push([1,3,,4]),[4,this.connectAsync()];case 2:return S.sent(),C&&C(),[3,4];case 3:return m=S.sent(),this.setConnectionState(qg.ConnectionState.Disconnected),this.m_logger.sendTraceTag(590213396,jg.TraceLevel.Error,"SimpleStateServiceProxy::retryConnection failed. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}, "+nm.errorToString(m)),this.m_retryAttempts>=this.m_retryIntervalsInMs.length&&g(m),[3,4];case 4:return[2]}}))}))}),E)}else this.m_logger.sendTraceTag(590213394,jg.TraceLevel.Info,"SimpleStateServiceProxy::retryConnection skipped. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", NullConnection: "+(null===this.m_connection)+", NullRetryTimer: "+(null===this.m_retryTimer)+"}")},SimpleStateServiceProxy.prototype.startPingTimer=function(){var g=this;this.m_connection&&this.m_connection.shouldSendPings&&(this.m_pingTimeoutInMs<=0||this.m_pongTimeoutInMs<=0||(this.clearPingPongTimer(),this.m_pingTimer=setTimeout((function(){return S(g,void 0,void 0,(function(){return v(this,(function(g){return this.sendPingMessage(),this.m_pingTimer=null,[2]}))}))}),this.m_pingTimeoutInMs)))},SimpleStateServiceProxy.prototype.sendPingMessage=function(){var g=this;this.m_connection&&(this.m_connection.isOpen?(this.m_verbose&&this.m_logger.sendTraceTag(559952470,jg.TraceLevel.Info,"SimpleStateServiceProxy::sendPingMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", __ping__"),this.m_connection.send("__ping__"),this.clearPongTimer(),this.m_pongTimer=setTimeout((function(){return S(g,void 0,void 0,(function(){var g=this;return v(this,(function(m){return this.retryConnection((function(m){g.m_logger.sendTraceTag(579463188,jg.TraceLevel.Error,"failed to reconnect after missing ping: "+nm.errorToString(m))}),!1),this.m_pongTimer=null,[2]}))}))}),this.m_pongTimeoutInMs)):(this.retryConnection((function(m){g.m_logger.sendTraceTag(579463189,jg.TraceLevel.Error,"failed to reconnect after closed connection: "+nm.errorToString(m))}),!1),this.clearPongTimer()))},SimpleStateServiceProxy.prototype.clearPingPongTimer=function(){this.clearPingTimer(),this.clearPongTimer()},SimpleStateServiceProxy.prototype.clearPingTimer=function(){this.m_pingTimer&&(clearTimeout(this.m_pingTimer),this.m_pingTimer=null)},SimpleStateServiceProxy.prototype.clearPongTimer=function(){this.m_pongTimer&&(clearTimeout(this.m_pongTimer),this.m_pongTimer=null)},SimpleStateServiceProxy.prototype.handleConnectionMessage=function(g){if("string"==typeof g.data){if(this.startPingTimer(),"__pong__"===g.data)return void(this.m_verbose&&this.m_logger.sendTraceTag(559952471,jg.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", __pong__"));var m=Date.now();try{var S=JSON.parse(g.data);Array.isArray(S)&&S.length>0?this.handleAggregatedStateMessages(S):this.handleStateMessage(S),this.m_telemetry.addMessageHandleLatency(Date.now()-m),S.objectId===qg.SystemSessionStateName?(this.m_logger.sendTraceTag(520161036,jg.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage - systemSessionState - initPromise resolved."),this.m_initPromise.resolve(),this.clearInitTimeoutTimer()):S.objectId===qg.ServiceGeneratedClientIdName&&this.m_logger.sendTraceTag(509743688,jg.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage - serviceGeneratedClientId received.")}catch(g){this.m_logger.sendTraceTag(578102302,jg.TraceLevel.Error,"handleConnectionMessage: "+nm.errorToString(g))}}else this.m_logger.sendTraceTag(590213397,jg.TraceLevel.Error,"SimpleStateServiceProxy::handleConnectionMessage - Unknown data type. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Type: "+typeof g.data+"}")},SimpleStateServiceProxy.prototype.handleAggregatedStateMessages=function(g){var m,S,v=this;if(g&&0!==g.length){var C=g.map((function(g){return JSON.parse(g)})),E={};C.forEach((function(g){return E[g.objectId]=1+(E[g.objectId]||0)})),Object.keys(E).forEach((function(g){if(E[g]>1){var m=v.m_handlers.get(g);m&&m.beginAggregatedStateUpdating&&m.beginAggregatedStateUpdating()}}));try{for(var T=_(C),I=T.next();!I.done;I=T.next()){var b=I.value;this.handleStateMessage(b)}}catch(g){m={error:g}}finally{try{I&&!I.done&&(S=T.return)&&S.call(T)}finally{if(m)throw m.error}}Object.keys(E).forEach((function(g){if(E[g]>1){var m=v.m_handlers.get(g);m&&m.endAggregatedStateUpdating&&m.endAggregatedStateUpdating()}}))}},SimpleStateServiceProxy.prototype.handleStateMessage=function(g){var m=this;if(this.m_verbose&&this.m_logger.sendTraceTag(590213398,jg.TraceLevel.Info,"SimpleStateServiceProxy::handleStateMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}"),"list"===g.type){JSON.parse(g.value).forEach((function(g){m.handleStateMessage(g)}))}else{if(this.m_user&&this.m_user.validateMessage&&!this.m_user.validateMessage(g))return void this.m_logger.sendTraceTag(588009742,jg.TraceLevel.Error,"SimpleStateServiceProxy::handleStateMessage rejected message: {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}");var S=this.getHandlerForMessage(g);if(g.senderId===this.senderId()&&(this.acknowledgeMessage(g,S),this.m_telemetry.incrementAcknowledgedCount(g.objectId)),this.measureMessageRoundTripLatency(g),this.m_telemetry.incrementReceivedCount(g.objectId),S)return void S.handleStateMessage(g)}},SimpleStateServiceProxy.prototype.getAuthToken=function(){return S(this,void 0,void 0,(function(){var g,m;return v(this,(function(S){switch(S.label){case 0:if(!this.m_user||!this.m_user.getAuthTokenAsync)return[3,4];S.label=1;case 1:return S.trys.push([1,3,,4]),[4,this.m_user.getAuthTokenAsync()];case 2:return g=S.sent(),[3,4];case 3:return m=S.sent(),this.m_logger.sendTraceTag(578102469,jg.TraceLevel.Error,"Error getting auth token: "+nm.errorToString(m)),[3,4];case 4:return[2,g]}}))}))},SimpleStateServiceProxy.prototype.getHandlerForMessage=function(g){var m=this.m_handlers.get(g.objectId);return m||("cell"===g.type?m=new sm.SimpleSyncCell(g.objectId,this):"map"===g.type?m=new om.SimpleSyncMap(g.objectId,this):this.m_logger.sendTraceTag(559204164,jg.TraceLevel.Error,"SimpleStateServiceProxy::handleStateMessage - Unknown message type. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Type: "+g.type+"}"),m&&this.m_handlers.set(g.objectId,m),m)},SimpleStateServiceProxy.prototype.sendStateMessageImpl=function(g){var m,S=this;if(this.m_verbose&&this.m_logger.sendTraceTag(590213403,jg.TraceLevel.Info,"SimpleStateServiceProxy::sendStateMessageImpl. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}"),g.objectId!==qg.StateSubscriptionsName&&g.objectId!==qg.ConfigurationName){if(this.m_outboundMessageInfo.set(g.messageId,Date.now()),this.m_telemetry.incrementRequestedCount(g.objectId),this.m_unacknowledgedMaxTimeInMs>0){var v=null===(m=this.getHandlerForMessage(g))||void 0===m?void 0:m.messageTrackingOption();if(v&&v!==qg.MessageTrackingOption.None){var C=this.getUnacknowledgedMessagesMapKey(g,v);this.m_unacknowledgedMessages.set(C,{message:g,timestamp:Date.now()}),this.startUnacknowledgeMessageTimer()}}if(this.m_useServiceGeneratedClientId&&this.m_clientIdEvictingQueue&&!this.m_clientId&&"get"!==g.operation)return this.m_logger.sendTraceTag(508348254,jg.TraceLevel.Info,"SimpleStateServiceProxy::enqueueMessage "+JSON.stringify(g)),void this.m_clientIdEvictingQueue.enqueue(g)}this.m_user&&this.m_user.patchMessage&&this.m_user.patchMessage(g),this.m_batchedRequestsEnabled?(this.m_messageBuffer.push(g),this.m_processBufferTimer||(this.m_processBufferTimer=setTimeout((function(){S.processMessageBuffer()}),this.m_batchWaitTimeMS))):this.sendConnectionMessage(g,!0)},SimpleStateServiceProxy.prototype.createListMessage=function(g){if(0!==g.length)return 1===g.length?g[0]:{value:JSON.stringify(g),type:this.m_batchMessageTypeName,operation:"",messageId:im.v4(),objectId:"batch",senderId:this.senderId()}},SimpleStateServiceProxy.prototype.processMessageBuffer=function(){var g=this.m_messageBuffer.length,m=this.m_messageBuffer.splice(0,g),S=this.createListMessage(m);this.m_processBufferTimer&&clearTimeout(this.m_processBufferTimer),this.m_processBufferTimer=null,S&&this.sendConnectionMessage(S,!0)},SimpleStateServiceProxy.prototype.processOfflineMessageCache=function(g){var m=this;this.m_offlineMessageCacheEnabled&&(this.m_offlineMessageCache.forEach((function(S){g&&(S.message.senderId=m.m_clientId),m.sendConnectionMessage(S.message,!1),m.m_telemetry.offlineCacheTelemetry.resentCount+=1})),this.m_offlineMessageCache=[])},SimpleStateServiceProxy.prototype.purgeOfflineMessageCache=function(){var g=this;if(this.m_offlineMessageCacheEnabled&&this.m_maxOfflineMessageCacheTimeInMs){var m=Date.now(),S=this.m_offlineMessageCache.filter((function(S){return g.m_maxOfflineMessageCacheTimeInMs&&S.timestamp+g.m_maxOfflineMessageCacheTimeInMs>=m}));this.m_telemetry.offlineCacheTelemetry.expiredCount+=this.m_offlineMessageCache.length-S.length,this.m_offlineMessageCache=S,0===this.m_offlineMessageCache.length&&this.clearOfflineMessageCacheTimer()}},SimpleStateServiceProxy.prototype.clearOfflineMessageCacheTimer=function(){this.m_offlineMessageCacheEnabled&&this.m_offlineMessageCacheTimer&&(clearInterval(this.m_offlineMessageCacheTimer),this.m_offlineMessageCacheTimer=null)},SimpleStateServiceProxy.prototype.getUnacknowledgedMessagesMapKey=function(g,m){return m===qg.MessageTrackingOption.None?"":m===qg.MessageTrackingOption.All?g.messageId:g.objectId},SimpleStateServiceProxy.prototype.startUnacknowledgeMessageTimer=function(){var g=this;this.m_unacknowledgedMaxTimeInMs>0&&!this.m_unacknowledgedTimer&&(this.m_unacknowledgedTimer=setInterval((function(){g.notifyUnacknowledgedMessages(),g.m_unacknowledgedMessages.size<=0&&g.clearUnacknowledgedTimer()}),this.m_unacknowledgedMaxTimeInMs/2))},SimpleStateServiceProxy.prototype.acknowledgeMessage=function(g,m){if(g.senderId===this.senderId()&&m&&!(this.m_unacknowledgedMessages.size<=0)){var S=this.getUnacknowledgedMessagesMapKey(g,m.messageTrackingOption()),v=this.m_unacknowledgedMessages.get(S);v&&g.messageId===v.message.messageId&&this.m_unacknowledgedMessages.delete(S)}},SimpleStateServiceProxy.prototype.notifyUnacknowledgedMessages=function(){var g=this,m=Date.now();this.m_unacknowledgedMessages.forEach((function(S,v){if(S.timestamp+g.m_unacknowledgedMaxTimeInMs<m){var C=g.getHandlerForMessage(S.message);null==C||C.handleUnacknowledgedMessage(S.message),g.m_unacknowledgedMessages.delete(v),g.m_telemetry.unacknowledgedMessagesCount+=1}}))},SimpleStateServiceProxy.prototype.clearUnacknowledgedTimer=function(){this.m_unacknowledgedTimer&&(clearInterval(this.m_unacknowledgedTimer),this.m_unacknowledgedTimer=null)},SimpleStateServiceProxy.prototype.startInitTimeoutTimerWithRetry=function(g,m){var S=this;this.startInitTimeoutTimer(g,(function(){S.m_logger.sendTraceTag(509141836,jg.TraceLevel.Error,"SimpleStateServiceProxy::startInitTimeoutTimer - failed to init after "+g+" ms; requesting get messages and retrying"),S.sendGetInitialSystemStateMessages(),S.startInitTimeoutTimer(g,m)}))},SimpleStateServiceProxy.prototype.startInitTimeoutTimer=function(g,m){g>0&&(this.clearInitTimeoutTimer(),this.m_initTimeoutTimer=setTimeout((function(){m("Initialization timed out after "+g+" ms")}),g))},SimpleStateServiceProxy.prototype.clearInitTimeoutTimer=function(){this.m_initTimeoutTimer&&clearTimeout(this.m_initTimeoutTimer)},SimpleStateServiceProxy.prototype.sendConnectionMessage=function(g,m){var S,v,C=this;if(this.m_allowReconnectOnMessageSend&&this.m_connectionState===qg.ConnectionState.Disconnected&&(this.updateRetryAttempts(),this.retryConnection((function(g){C.m_logger.sendTraceTag(559428289,jg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - failed to reconnect with error: "+nm.errorToString(g)+" ")}),!1)),this.m_offlineMessageCacheEnabled&&m){if(!this.m_connection||this.m_connectionState!==qg.ConnectionState.Connected)return!this.m_maxOfflineMessageCacheLength||this.m_offlineMessageCache.length>=this.m_maxOfflineMessageCacheLength?(this.m_telemetry.offlineCacheTelemetry.rejectedCount+=1,void this.m_logger.sendTraceTag(570807006,jg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - Dropping message because offline cache is full. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Status: "+(null===(S=this.m_connection)||void 0===S?void 0:S.readyState)+"}")):(!this.m_offlineMessageCacheTimer&&this.m_maxOfflineMessageCacheTimeInMs&&(this.m_offlineMessageCacheTimer=setInterval((function(){C.purgeOfflineMessageCache()}),this.m_maxOfflineMessageCacheTimeInMs/2)),this.m_offlineMessageCache.push({message:g,timestamp:Date.now()}),void(this.m_telemetry.offlineCacheTelemetry.cachedCount+=1))}else{if(!this.m_connection)return void this.m_logger.sendTraceTag(590213401,jg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - connection is not set. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}");if(!this.m_connection.isOpen)return void this.m_logger.sendTraceTag(590213402,jg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - "+this.m_connection.name+" status is not open. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Status: "+this.m_connection.readyState+"}")}null===(v=this.m_connection)||void 0===v||v.send(JSON.stringify(g))},SimpleStateServiceProxy.prototype.closeAndClearConnection=function(){if(this.m_connection){if(this.m_connection.onclose=function(){},this.m_connection.isOpen)this.m_connection.close();else{var g=this.m_connection;g.onopen=function(){return g.close()}}this.m_connection=null}},SimpleStateServiceProxy.prototype.updateRetryAttempts=function(){this.m_retryAttempts>=this.m_retryIntervalsInMs.length&&(this.m_retryAttempts=0),this.m_sessionRetryAttempts>=this.m_maxSessionRetries&&(this.m_sessionRetryAttempts=0)},SimpleStateServiceProxy.prototype.measureMessageRoundTripLatency=function(g){if(g.senderId===this.senderId())try{var m=this.m_outboundMessageInfo.get(g.messageId);if(void 0!==m){this.m_outboundMessageInfo.delete(g.messageId);var S=Date.now()-m;this.m_events.emit("messageRoundTripped",{clientId:this.m_clientId,sessionId:this.m_sessionId,messageId:g.messageId,objectId:g.objectId,operation:g.operation,latencyInMs:S}),this.m_telemetry.addRoundtripLatency(S)}else this.m_verbose&&this.m_logger.sendTraceTag(590213404,jg.TraceLevel.Info,"SimpleStateServiceProxy::measureMessageRoundTripLatency. Failed to find outbound message info for {SessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}")}catch(m){this.m_logger.sendTraceTag(590213405,jg.TraceLevel.Error,"SimpleStateServiceProxy::measureMessageRoundTripLatency - Exception thrown error. {SessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", MessageId: "+g.messageId+", Error: "+m.message+"}")}},SimpleStateServiceProxy}();m.SimpleStateServiceProxy=A})),hm=createCommonjsModule((function(g,m){var S=C&&C.__awaiter||function(g,m,S,v){function adopt(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function fulfilled(g){try{step(v.next(g))}catch(g){C(g)}}function rejected(g){try{step(v.throw(g))}catch(g){C(g)}}function step(g){g.done?S(g.value):adopt(g.value).then(fulfilled,rejected)}step((v=v.apply(g,m||[])).next())}))},v=C&&C.__generator||function(g,m){var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_;function verb(g){return function(m){return step([g,m])}}function step(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=E.trys,(C=C.length>0&&C[C.length-1])||6!==_[0]&&2!==_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}};function createStateServiceProxyAsync(g,m,C,_,E,T){return S(this,void 0,void 0,(function(){var S;return v(this,(function(v){switch(v.label){case 0:return[4,(S=new dm.SimpleStateServiceProxy(g,m,C,_,E,T)).connectAsync()];case 1:return v.sent(),[2,S]}}))}))}Object.defineProperty(m,"__esModule",{value:!0}),m.createStateServiceProxyAsync=void 0,m.createStateServiceProxyAsync=createStateServiceProxyAsync})),um=createCommonjsModule((function(g,m){var S=C&&C.__createBinding||(Object.create?function(g,m,S,v){void 0===v&&(v=S),Object.defineProperty(g,v,{enumerable:!0,get:function(){return m[S]}})}:function(g,m,S,v){void 0===v&&(v=S),g[v]=m[S]}),v=C&&C.__exportStar||function(g,m){for(var v in g)"default"===v||m.hasOwnProperty(v)||S(m,g,v)};Object.defineProperty(m,"__esModule",{value:!0}),v(jg,m),v(qg,m),v(hm,m)}));class ReactionLogger{constructor(g){this.enableConsoleLog=getAcsEcsConfig().calling.reaction.enableStateServiceConsoleLogs,this._logger=g}sendTraceTag(g,m,S){this.enableConsoleLog&&this._logger.info(`Tag: ${g}, Leve: ${m}, Message: ${S}`)}}class ReactionFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new ReactionImplOverStateService(this.eventEmitter),this._isReactionFeatureEnabled=getAcsEcsConfig().calling.reaction.enabled,this._callInfo=g.callInfo}get name(){return"Reaction"}initialize(g,m){this._tsCall=g.tsCall,this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._logger.info(`Meeting Reaction feature enable flag: ${this._isReactionFeatureEnabled}`),this._isReactionFeatureEnabled&&3===g.tsCall.state?this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m,this._callInfo):g.tsCall.on("callStateChanged",(()=>{this._isReactionFeatureEnabled&&3===g.tsCall.state?this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m,this._callInfo):this._logger.warn("Calls to reaction APIs will perform no action or return default values where applicable")}))}async sendReaction(g){let m=generateGuid();if(this._sendFeatureUsage("sendReaction",Rh.attempt,void 0,m),3!=this._tsCall.state||1===this._tsCall.callType){const g=new CallingCommunicationError({defaultError:3!=this._tsCall.state?D.FEATURES.REACTION.CALL_NOT_CONNECTED:D.FEATURES.REACTION.NOT_SUPPORTED_1TO1_CTE});throw this._sendFeatureUsage("sendReaction",Rh.failure,g,m),g}await this._impl.sendReaction(g,m)}on(g,m){if("reaction"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.REACTION.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});if(!this._isReactionFeatureEnabled){const g=new CallingCommunicationError({defaultError:D.FEATURES.REACTION.EVENT_SUBSCRIBE_FAIL_POLICY});throw this._sendFeatureUsage("receiveReaction",Rh.failure,g),g}this._sendFeatureUsage("receiveReaction",Rh.subscribe),this._impl.on(g,m)}off(g,m){if("reaction"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.REACTION.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});if(!this._isReactionFeatureEnabled){const g=new CallingCommunicationError({defaultError:D.FEATURES.REACTION.EVENT_UNSUBSCRIBE_FAIL_POLICY});throw this._sendFeatureUsage("receiveReaction",Rh.failure,g),g}this._sendFeatureUsage("receiveReaction",Rh.unsubscribe),this._impl.off(g,m)}dispose(){this.disposed||(this._impl.dispose(),super.dispose())}_sendFeatureUsage(g,m,S,v){let C=S?{code:S?.code||F,subCode:S?.subCode||0,failureReason:S?.message||"",...extractCommunicationServicesErrorForTelemetry(S)}:void 0;sendCallFeatureUsageTelemetry({correlationId:v,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:C},this._telemetryLogManager,this._logger)}}class ReactionImplOverStateService{constructor(g){this._wsUrl="",this.name="Reaction",this.capabilityChangeHandler=g=>{g.newValue.useReactions&&(this._participantCapability=this._call.getParticipantCapabilities().useReactions,this._logger.log(`participant capabilitity to useReactions feature is ${this._participantCapability}`))},this._eventEmitter=g,this._participantCapability={isPresent:!0,reason:"Capable"},this._isReactionFeatureEnabled=getAcsEcsConfig().calling.reaction.enabled}initialize(g,m,S,v,C,_){void 0===this._proxy||this._proxy?.getConnectionState()===um.ConnectionState.Disconnected?(this._logger=C.createChild((()=>`ReactionImplOverStateService::Call(id='${this._tsCall.callId}')`)),this._internalCallAgent=m,this._tsCall=g,this._call=S,this._callInfo=_,this._docId=this._tsCall.callId,this._wsUrl=this.getEndpointUrl(),this._telemetryLogManager=v,this._sendAttempOrFailureFeatureUsage("initialize",Rh.attempt),this.start()):C.info("State Service Proxy already has an active connection."),"teamsMeetingJoin"==this._callInfo.context&&(this._participantCapability=this._call.getParticipantCapabilities().useReactions,this._logger.log(`participant capabilitity to useReactions feature is ${this._participantCapability}`),this._call.onParticipantCapabilitiesChanged("capabilitiesChanged",this.capabilityChangeHandler),this._logger.log("participant capabilities change event listener registered"))}async start(){const g=getAcsEcsConfig().calling.reaction.StateServiceProxySettings,m=No,S={getAuthTokenAsync:this.getAuthToken.bind(this)};try{this._proxy=await um.createStateServiceProxyAsync(this._docId,m,this._wsUrl,new ReactionLogger(this._logger),g,S)}catch(g){return this._logger.error("Could not create state service proxy",g),void this._sendAttempOrFailureFeatureUsage("initialize",Rh.failure,new CallingCommunicationError({defaultError:D.FEATURES.REACTION.STATE_SERVICE_CONNECT_FAIL,originalError:g}))}try{this._reactionsMap=await this._proxy.createMapAsync("reactions",!0)}catch(g){return this._logger.error("Could not create state service proxy reaction map",g),void this._sendAttempOrFailureFeatureUsage("initialize",Rh.failure,new CallingCommunicationError({defaultError:D.FEATURES.REACTION.MAP_CREATE_FAIL,originalError:g}))}this._sendSuccessFeatureUsage("initialize",Rh.success),this._reactionsMap?.on("valueChanged",this.onReactionsReceived.bind(this))}async getAuthToken(){const g={token:await this._internalCallAgent.tokenProvider(),authProvider:"SKYPE",mri:this._internalCallAgent.getUserMri()};return Promise.resolve(g)}async sendReaction(g,m){if(!this._isReactionFeatureEnabled||!this._participantCapability.isPresent){const g=new CallingCommunicationError({defaultError:D.FEATURES.REACTION.SEND_FAIL_POLICY});throw this._sendAttempOrFailureFeatureUsage("sendReaction",Rh.failure,g,m),g}if(!this._reactionsMap){this._logger.error("Reaction Map has not yet been initialized.");const g=new CallingCommunicationError({defaultError:D.FEATURES.REACTION.NOT_INIT_YET});throw this._sendAttempOrFailureFeatureUsage("sendReaction",Rh.failure,g,m),g}try{return this._reactionsMap?.set(this._internalCallAgent.getUserMri(),{name:g.reactionType}),void this._sendSuccessFeatureUsage("sendReaction",Rh.success,m,g.reactionType)}catch(g){this._logger.error("Unable to send reaction",g);const S=new CallingCommunicationError({defaultError:D.FEATURES.REACTION.SEND_REACTION_FAIL,originalError:g});throw this._sendAttempOrFailureFeatureUsage("sendReaction",Rh.failure,S,m),S}}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}async onReactionsReceived(g){if(3===this._tsCall.state&&this._participantCapability.isPresent){const m=generateGuid();this._sendAttempOrFailureFeatureUsage("receiveReaction",Rh.attempt,void 0,m);try{const S={reactionType:(await(this._reactionsMap?.get(g))).name};this._eventEmitter.emit("reaction",{identifier:g,reactionMessage:S}),this._sendSuccessFeatureUsage("receiveReaction",Rh.success,m,S.reactionType)}catch(g){this._logger.error("Unable to parse reaction",g);let S=new CallingCommunicationError({defaultError:D.FEATURES.REACTION.RECEIVE_REACTION_FAIL,originalError:g});this._sendAttempOrFailureFeatureUsage("receiveReaction",Rh.failure,S,m)}}}dispose(){void 0!==this._telemetryLogManager&&(this._proxy?.getConnectionState()===um.ConnectionState.Connected?(this._reactionsMap?.removeAllListeners("valueChanged"),this._proxy.close(),this._sendSuccessFeatureUsage("dispose",Rh.success),this._call.offParticipantCapabilitiesChanged("capabilitiesChanged",this.capabilityChangeHandler)):this._sendSuccessFeatureUsage("dispose",Rh.failure))}_sendAttempOrFailureFeatureUsage(g,m,S,v){let C=S?{code:S?.code||F,subCode:S?.subCode||0,failureReason:S?.message||"",...extractCommunicationServicesErrorForTelemetry(S)}:void 0;sendCallFeatureUsageTelemetry({correlationId:v,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:C},this._telemetryLogManager,this._logger)}_sendSuccessFeatureUsage(g,m,S,v){let C;C="initialize"===g||"dispose"==g?void 0:{reactionConstraint:{reactionType:v}},sendCallFeatureUsageTelemetry({correlationId:S,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:C},this._telemetryLogManager,this._logger)}getEndpointUrl(){const g=this._internalCallAgent._caConfigBag,m=g&&isEudbConfigurationsApplicable(g.identityType,g.region);var S=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer;switch(g?.cloudType){case ta.Public:m&&(S=getAcsEcsConfig().PowerPointStateServiceUrl.public.eu);break;case ta.GccHigh:S=getAcsEcsConfig().PowerPointStateServiceUrl.gcch;break;case ta.AirGap08:S=getAcsEcsConfig().PowerPointStateServiceUrl.ag08;break;case ta.AirGap09:S=getAcsEcsConfig().PowerPointStateServiceUrl.ag09;break;case ta.Dod:S=getAcsEcsConfig().PowerPointStateServiceUrl.dod;break;default:S=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer}return`wss://${new URL(S).hostname}/StateServiceHandler.ashx`}}class ContentSharingSession{get contentSharingSession(){return this._contentSharingSession}constructor(g){this._contentSharingSession=g}getFileDetails(){if(this.contentSharingSession){return JSON.parse(atob(this.contentSharingSession.contentSharingIdentity))}}}const gm="azure_communication_calling_pptLive";class PPTLiveCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new PPTLiveCallImplOverTsCall(this.eventEmitter)}on(g,m){this._sendFeatureUsage(g,Rh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Rh.unsubscribe),this.eventEmitter.off(g,m)}get isActive(){return this._impl.isActive}get target(){return this._impl.target}get name(){return"PPTLive"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:g,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class PPTLiveCallImplOverTsCall{constructor(g){this._isActive=!1,this._isInitializingPPTLive=!1,this._updateIsActive=g=>this._isActive!==g&&(this._isActive=g,this._logger.info(`Updating isActive to ${g}`),!0),this._eventEmitter=g,this._target=document.createElement("div"),this._target.id=gm,this._target.style.width="100%",this._target.style.height="100%"}initialize(g,m,S,v){this._logger=v.createChild((()=>`PPTLive::Call(id='${g.callId}')`)),this._tsCall=g,this._internalCallAgent=m,this._telemetryLogManager=S,this._tsCall.on("contentSharingChanged",(()=>{this._checkContentSharingSession(this._tsCall.contentSharingSessions)})),this._tsCall.on("callStateChanged",(()=>{this._updatePPTLive(this._tsCall.state)}))}get isActive(){return this._isActive}get target(){return this._target}_checkContentSharingSession(g){if(this._contentSharing&&0===g.length)this._updateIsActive(!1),this._contentSharing=void 0,this._target.innerHTML="",this._isInitializingPPTLive=!1,this._eventEmitter.emit("isActiveChanged"),this._sendFeatureUsage("endedPPTLive",Rh.success);else if(!this._contentSharing&&0!==g.length){if(!getAcsEcsConfig().calling.pptlive.enabled)return;this._contentSharing=new ContentSharingSession(g[0]),this._updatePPTLive(this._tsCall.state),this._sendFeatureUsage("startedPPTLive",Rh.attempt,this._contentSharing?.contentSharingSession?.contentSharingGuid)}}async _updatePPTLive(g){this._fileDetails=this._contentSharing?.getFileDetails(),this._fileDetails&&"ppt"===this._fileDetails.type&&3===g&&await this._startPPTLive(this._target)}_sendFeatureUsage(g,m,S){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"PPTLive",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:{pptLiveConstraint:{contentId:S}}},this._telemetryLogManager,this._logger)}_observeDivMount(){const g=new MutationObserver((async m=>{if(this._isActive){if(!this._isInitializingPPTLive)for(const S of m)for(let m=0;m<S.addedNodes.length;m++){const v=S.addedNodes[m];if(v.nodeType===Node.ELEMENT_NODE){if(v.matches(`#${gm}`)){await this._startPPTLive(this._target),g.disconnect();break}}}}else g.disconnect()}));g.observe(document.body,{childList:!0,subtree:!0})}_initViewerWithExperiment(g,m,S,v,C,_,E,T,I,b,A,R,P,M,w){const D={getAuthTokenAsync:!1,getForceRefreshedTokenAsync:!1},O=window.Microsoft,OnInitSuccess=g=>{g.GoToSlide(m,[],""),this._isInitializingPPTLive=!1,this._observeDivMount(),this._sendFeatureUsage("startedPPTLive",Rh.success,this._contentSharing?.contentSharingSession?.contentSharingGuid)},OnInitFailure=g=>{this._isInitializingPPTLive=!1;var m="Category: "+g.Category+"\nMessage: "+g.Message+"\nExtraInfo: "+g.ExtraInfo;this._sendFeatureUsage("startedPPTLive",Rh.failure,this._contentSharing?.contentSharingSession?.contentSharingGuid),this._logger.error(m)},N=getAcsEcsConfig().calling.pptlive,k={entryPoint:"null"},L={Container:g,SessionInformation:{DocumentClickTime:new Date,HostInitTime:new Date,UiLocale:R,DataLocale:R,IsPresenter:!1,WdParams:{wdModernSlideShowInTeams:N.wdParams.wdModernSlideShowInTeams,wdPresenterViewInTeams:N.wdParams.wdPresenterViewInTeams,wdForceModernSlideShowInTeams:N.wdParams.wdForceModernSlideShowInTeams,isMovePrivateViewingToPPTEnabled:N.wdParams.isMovePrivateViewingToPPTEnabled},PptFeatureGates:N.featureGates,ParticipantId:T,EnableStateServiceInPreviewerFeatures:JSON.parse(N.enableStateServiceInPreviewerFeatures),StateServiceSettings:{stateServiceProxySettings:N.stateServiceProxySettings,regionalEndpointUrl:this._getEndpointUrl(),authEnabled:!1,rosterCheckEnabled:!1,stateServiceUser:D},ContentId:P,EndpointId:E,CallId:M,HostName:"ACSWeb",HostSessionId:I},WopiPrecheckInfo:{FileName:v,FileGetUrl:_,FileSize:C,CustomFontCatalogUrl:w,BundleInfo:{MajorVersion:S,Url:b},CreateNewInfo:null},ApplicationCustomSettings:{TakeFocusOnBoot:N.appSettings.takeFocusOnBoot,EnableAdvanceOnClick:N.appSettings.enableAdvanceOnClick,EnableAdvanceOnTap:N.appSettings.enableAdvanceOnTap},Diagnostics:k,FnOnInitializeSuccess:OnInitSuccess,FnOnInitializeFailure:OnInitFailure};A&&(L.ApplicationCustomSettings.EnableWacFallback=!1,L.ApplicationUrl=A),O.Office.PowerPoint.Bootstrap.Prefetch(),O.Office.PowerPoint.Bootstrap.InitializeWopiPending(L),this._updateIsActive(!0),this._eventEmitter.emit("isActiveChanged"),this._sendFeatureUsage("startedPPTLive",Rh.initialize,this._contentSharing?.contentSharingSession?.contentSharingGuid)}async _startPPTLive(g){this._fileDetails?.bootstrapperUrl&&(this._isInitializingPPTLive=!0,g.innerHTML="",await this._loadDynamicModule(this._fileDetails.bootstrapperUrl).then((()=>{this._fileDetails&&this._initViewerWithExperiment(g,Number(this._contentSharing?.contentSharingSession?.contentSharingState),this._fileDetails.majorVersion,this._fileDetails.name,this._fileDetails.fileSize,this._fileDetails.fileGetUrl,this._tsCall.endpointId,this._tsCall.participantId,generateGuid(),this._fileDetails.contentBundleUrl,this._fileDetails.wacUrl,navigator.language,this._fileDetails.id,this._tsCall.callId,this._fileDetails.customFontCatalogUrl)})).catch((()=>{this._sendFeatureUsage("startedPPTLive",Rh.failure,this._contentSharing?.contentSharingSession?.contentSharingGuid)})))}_getEndpointUrl(){const g=this._internalCallAgent._caConfigBag,m=g&&isEudbConfigurationsApplicable(g.identityType,g.region);let S=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer;switch(g?.cloudType){case ta.Public:m&&(S=getAcsEcsConfig().PowerPointStateServiceUrl.public.eu);break;case ta.GccHigh:S=getAcsEcsConfig().PowerPointStateServiceUrl.gcch;break;case ta.AirGap08:S=getAcsEcsConfig().PowerPointStateServiceUrl.ag08;break;case ta.AirGap09:S=getAcsEcsConfig().PowerPointStateServiceUrl.ag09;break;case ta.Dod:S=getAcsEcsConfig().PowerPointStateServiceUrl.dod;break;default:S=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer}return S}async _loadDynamicModule(g){return new Function(`return (async () => await import('${g}'))()`)()}}const pm={Recording:callFeatureFactory(RecordingCallFeatureImpl),Transfer:callFeatureFactory(TransferCallFeatureImpl),Transcription:callFeatureFactory(TranscriptionCallFeatureImpl),Captions:callFeatureFactory(CaptionsCallFeatureImpl),RaiseHand:callFeatureFactory(RaiseHandCallFeatureImpl),LocalRecording:callFeatureFactory(LocalRecordingCallFeatureImpl),Reaction:callFeatureFactory(ReactionFeatureImpl),Spotlight:callFeatureFactory(SpotlightCallFeatureImpl),PPTLive:callFeatureFactory(PPTLiveCallFeatureImpl),Capabilities:callFeatureFactory(CapabilitiesFeatureImpl),DominantSpeakers:callFeatureFactory(DominantSpeakersCallFeatureImpl),LiveStream:callFeatureFactory(LiveStreamCallFeatureImpl),ComposedStream:callFeatureFactory(ComposedStreamCallFeatureImpl),CallSurvey:callFeatureFactory(CallSurveyFeatureImpl),UserFacingDiagnostics:callFeatureFactory(UserFacingDiagnosticsFeatureImpl),MediaStats:callFeatureFactory(MediaStatsCallFeatureImpl,{activationEvent:"OnExtendedObjectConstructor"}),DebugInfo:callClientFeatureFactory(DebugInfoCallClientFeatureImpl,{activationEvent:"OnExtendedObjectConstructor"}),PreCallDiagnostics:callClientFeatureFactory(PreCallDiagnosticsFeatureImpl),VideoEffects:videoStreamFeatureFactory(VideoEffectsFeatureImpl),AudioEffects:audioStreamFeatureFactory(AudioEffectsFeatureImpl),DataChannel:callFeatureFactory(DataChannelCallFeatureImpl),OptimalVideoCount:callFeatureFactory(OptimalVideoCountCallFeatureImpl),UnmixedAudio:callFeatureFactory(UnmixedAudioCallFeatureImpl),AudioZones:callFeatureFactory(AudioZonesCallFeatureImpl),TeamsMeetingAudioConferencing:callFeatureFactory(TeamsMeetingAudioConferencingCallFeatureImpl)};function getRegisteredFeatures(g){switch(g){case Cu.CallClientFeature:return Object.entries(pm).filter((g=>!0===g[1].isCallClientFeature)).map((g=>g[1]));case Cu.CallAgentFeature:return Object.entries(pm).filter((g=>!0===g[1].isCallAgentFeature)).map((g=>g[1]));case Cu.CallFeature:return Object.entries(pm).filter((g=>!0===g[1].isCallFeature)).map((g=>g[1]))}}class CallStats{constructor(g,m){this._eventBag=[],this.resetEventBag=()=>{this._eventBag=[]},this._logger=g.createChild("CallStats"),this._telemetryLogManager=m}recordEvent(g){try{if(getAcsEcsConfig()?.telemetry?.callStatsFlushTimeout<0)return;if(getAcsEcsConfig()?.telemetry?.blockedEvents?.indexOf(g.name)>-1)return;const m={...g,timestamp:+new Date};this._logger.debug(`CallStat recorded=${g.name}`),this._eventBag.push(m),this.scheduleTelemtryFlush()}catch(g){this._logger.debug("Failed to record call stats")}}flushEvents(){if(this._logger.debug(`CallStats sending telemetry, number of events=${this._eventBag.length}`),0!==this._eventBag.length)try{const g=this._eventBag.reduce(((g,m)=>(g[m.localParticipantId]?g[m.localParticipantId].events.push({name:m.name,timestamp:m.timestamp,...m.data}):g[m.localParticipantId]={callId:m.callId,localParticipantId:m.localParticipantId,events:[{name:m.name,timestamp:m.timestamp,...m.data}]},g)),{});Object.keys(g).forEach((m=>{this._telemetryLogManager.sendEvent({name:Ah.acs_calling_call_stats,tenant:Qa,properties:{...g[m]}})})),this.resetEventBag()}catch(g){this._logger.debug("Failed to send call stats")}}scheduleTelemtryFlush(){this._callStatSendTimeout||(this._callStatSendTimeout=window.setTimeout((()=>{this.flushEvents(),this._callStatSendTimeout=void 0}),getAcsEcsConfig().telemetry.callStatsFlushTimeout))}}var __decorate$9=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$9=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class RemoteAudioStreamImpl{constructor(g,S,v,C){const _=m.createClientLogger("ACS-calling");this.logger=new DefaultLogger(_,[()=>"RemoteAudioStream for media stream"]),this._source=g,this._disposed=!1,this._volumeIndicator=new VolumeImpl(this.logger,"RemoteAudioStream",S,v,C),this.logger.info("created")}async getMediaStream(){return await this._source.getMediaStream()}get source(){return this._source}dispose(){this.logger.log("dispose"),this._disposed?this.logger.log("already disposed"):(this._source?.dispose(),this._volumeIndicator.dispose(),this._disposed=!0)}async getVolume(){return this._volumeIndicator.isInitialized?this._volumeIndicator:this._volumeIndicator.getVolumeIndicator(await this.getMediaStream())}}__decorate$9([loggerProperty,__metadata$9("design:type",Object)],RemoteAudioStreamImpl.prototype,"logger",void 0);var mm=createCommonjsModule((function(g,m){!function(S,v){var C="1.0.33",_="",E="?",T="function",I="undefined",b="object",A="string",R="major",P="model",M="name",w="type",D="vendor",O="version",N="architecture",k="console",L="mobile",F="tablet",x="smarttv",U="wearable",V="embedded",B=350,H="Amazon",$="Apple",G="ASUS",j="BlackBerry",q="Browser",W="Chrome",z="Firefox",K="Google",J="Huawei",Y="LG",Q="Microsoft",X="Motorola",Z="Opera",ee="Samsung",te="Sharp",ie="Sony",ne="Xiaomi",re="Zebra",se="Facebook",extend=function(g,m){var S={};for(var v in g)m[v]&&m[v].length%2==0?S[v]=m[v].concat(g[v]):S[v]=g[v];return S},enumerize=function(g){for(var m={},S=0;S<g.length;S++)m[g[S].toUpperCase()]=g[S];return m},has=function(g,m){return typeof g===A&&-1!==lowerize(m).indexOf(lowerize(g))},lowerize=function(g){return g.toLowerCase()},majorize=function(g){return typeof g===A?g.replace(/[^\d\.]/g,_).split(".")[0]:v},trim=function(g,m){if(typeof g===A)return g=g.replace(/^\s\s*/,_),typeof m===I?g:g.substring(0,B)},rgxMapper=function(g,m){for(var S,C,_,E,I,A,R=0;R<m.length&&!I;){var P=m[R],M=m[R+1];for(S=C=0;S<P.length&&!I;)if(I=P[S++].exec(g))for(_=0;_<M.length;_++)A=I[++C],typeof(E=M[_])===b&&E.length>0?2===E.length?typeof E[1]==T?this[E[0]]=E[1].call(this,A):this[E[0]]=E[1]:3===E.length?typeof E[1]!==T||E[1].exec&&E[1].test?this[E[0]]=A?A.replace(E[1],E[2]):v:this[E[0]]=A?E[1].call(this,A,E[2]):v:4===E.length&&(this[E[0]]=A?E[3].call(this,A.replace(E[1],E[2])):v):this[E]=A||v;R+=2}},strMapper=function(g,m){for(var S in m)if(typeof m[S]===b&&m[S].length>0){for(var C=0;C<m[S].length;C++)if(has(m[S][C],g))return S===E?v:S}else if(has(m[S],g))return S===E?v:S;return g},ae={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},oe={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[O,[M,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[O,[M,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[M,O],[/opios[\/ ]+([\w\.]+)/i],[O,[M,Z+" Mini"]],[/\bopr\/([\w\.]+)/i],[O,[M,Z]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[M,O],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[O,[M,"UC"+q]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[O,[M,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[O,[M,"WeChat"]],[/konqueror\/([\w\.]+)/i],[O,[M,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[O,[M,"IE"]],[/yabrowser\/([\w\.]+)/i],[O,[M,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[M,/(.+)/,"$1 Secure "+q],O],[/\bfocus\/([\w\.]+)/i],[O,[M,z+" Focus"]],[/\bopt\/([\w\.]+)/i],[O,[M,Z+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[O,[M,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[O,[M,"Dolphin"]],[/coast\/([\w\.]+)/i],[O,[M,Z+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[O,[M,"MIUI "+q]],[/fxios\/([-\w\.]+)/i],[O,[M,z]],[/\bqihu|(qi?ho?o?|360)browser/i],[[M,"360 "+q]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[M,/(.+)/,"$1 "+q],O],[/(comodo_dragon)\/([\w\.]+)/i],[[M,/_/g," "],O],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[M,O],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[M],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[M,se],O],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[M,O],[/\bgsa\/([\w\.]+) .*safari\//i],[O,[M,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[O,[M,W+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[M,W+" WebView"],O],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[O,[M,"Android "+q]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[M,O],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[O,[M,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[O,M],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[M,[O,strMapper,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[M,O],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[M,"Netscape"],O],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[O,[M,z+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[M,O],[/(cobalt)\/([\w\.]+)/i],[M,[O,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[N,"amd64"]],[/(ia32(?=;))/i],[[N,lowerize]],[/((?:i[346]|x)86)[;\)]/i],[[N,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[N,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[N,"armhf"]],[/windows (ce|mobile); ppc;/i],[[N,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[N,/ower/,_,lowerize]],[/(sun4\w)[;\)]/i],[[N,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[N,lowerize]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[P,[D,ee],[w,F]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[P,[D,ee],[w,L]],[/\((ip(?:hone|od)[\w ]*);/i],[P,[D,$],[w,L]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[P,[D,$],[w,F]],[/(macintosh);/i],[P,[D,$]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[P,[D,J],[w,F]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[P,[D,J],[w,L]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[P,/_/g," "],[D,ne],[w,L]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[P,/_/g," "],[D,ne],[w,F]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[P,[D,"OPPO"],[w,L]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[P,[D,"Vivo"],[w,L]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[P,[D,"Realme"],[w,L]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[P,[D,X],[w,L]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[P,[D,X],[w,F]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[P,[D,Y],[w,F]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[P,[D,Y],[w,L]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[P,[D,"Lenovo"],[w,F]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[P,/_/g," "],[D,"Nokia"],[w,L]],[/(pixel c)\b/i],[P,[D,K],[w,F]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[P,[D,K],[w,L]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[P,[D,ie],[w,L]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[P,"Xperia Tablet"],[D,ie],[w,F]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[P,[D,"OnePlus"],[w,L]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[P,[D,H],[w,F]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[P,/(.+)/g,"Fire Phone $1"],[D,H],[w,L]],[/(playbook);[-\w\),; ]+(rim)/i],[P,D,[w,F]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[P,[D,j],[w,L]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[P,[D,G],[w,F]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[P,[D,G],[w,L]],[/(nexus 9)/i],[P,[D,"HTC"],[w,F]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony(?!-bra))[-_ ]?([-\w]*)/i],[D,[P,/_/g," "],[w,L]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[P,[D,"Acer"],[w,F]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[P,[D,"Meizu"],[w,L]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[P,[D,te],[w,L]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[D,P,[w,L]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[D,P,[w,F]],[/(surface duo)/i],[P,[D,Q],[w,F]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[P,[D,"Fairphone"],[w,L]],[/(u304aa)/i],[P,[D,"AT&T"],[w,L]],[/\bsie-(\w*)/i],[P,[D,"Siemens"],[w,L]],[/\b(rct\w+) b/i],[P,[D,"RCA"],[w,F]],[/\b(venue[\d ]{2,7}) b/i],[P,[D,"Dell"],[w,F]],[/\b(q(?:mv|ta)\w+) b/i],[P,[D,"Verizon"],[w,F]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[P,[D,"Barnes & Noble"],[w,F]],[/\b(tm\d{3}\w+) b/i],[P,[D,"NuVision"],[w,F]],[/\b(k88) b/i],[P,[D,"ZTE"],[w,F]],[/\b(nx\d{3}j) b/i],[P,[D,"ZTE"],[w,L]],[/\b(gen\d{3}) b.+49h/i],[P,[D,"Swiss"],[w,L]],[/\b(zur\d{3}) b/i],[P,[D,"Swiss"],[w,F]],[/\b((zeki)?tb.*\b) b/i],[P,[D,"Zeki"],[w,F]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[D,"Dragon Touch"],P,[w,F]],[/\b(ns-?\w{0,9}) b/i],[P,[D,"Insignia"],[w,F]],[/\b((nxa|next)-?\w{0,9}) b/i],[P,[D,"NextBook"],[w,F]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[D,"Voice"],P,[w,L]],[/\b(lvtel\-)?(v1[12]) b/i],[[D,"LvTel"],P,[w,L]],[/\b(ph-1) /i],[P,[D,"Essential"],[w,L]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[P,[D,"Envizen"],[w,F]],[/\b(trio[-\w\. ]+) b/i],[P,[D,"MachSpeed"],[w,F]],[/\btu_(1491) b/i],[P,[D,"Rotor"],[w,F]],[/(shield[\w ]+) b/i],[P,[D,"Nvidia"],[w,F]],[/(sprint) (\w+)/i],[D,P,[w,L]],[/(kin\.[onetw]{3})/i],[[P,/\./g," "],[D,Q],[w,L]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[P,[D,re],[w,F]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[P,[D,re],[w,L]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[D,P,[w,k]],[/droid.+; (shield) bui/i],[P,[D,"Nvidia"],[w,k]],[/(playstation [345portablevi]+)/i],[P,[D,ie],[w,k]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[P,[D,Q],[w,k]],[/smart-tv.+(samsung)/i],[D,[w,x]],[/hbbtv.+maple;(\d+)/i],[[P,/^/,"SmartTV"],[D,ee],[w,x]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[D,Y],[w,x]],[/(apple) ?tv/i],[D,[P,$+" TV"],[w,x]],[/crkey/i],[[P,W+"cast"],[D,K],[w,x]],[/droid.+aft(\w)( bui|\))/i],[P,[D,H],[w,x]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[P,[D,te],[w,x]],[/(bravia[\w ]+)( bui|\))/i],[P,[D,ie],[w,x]],[/(mitv-\w{5}) bui/i],[P,[D,ne],[w,x]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[D,trim],[P,trim],[w,x]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[w,x]],[/((pebble))app/i],[D,P,[w,U]],[/droid.+; (glass) \d/i],[P,[D,K],[w,U]],[/droid.+; (wt63?0{2,3})\)/i],[P,[D,re],[w,U]],[/(quest( 2)?)/i],[P,[D,se],[w,U]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[D,[w,V]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[P,[w,L]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[P,[w,F]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[w,F]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[w,L]],[/(android[-\w\. ]{0,9});.+buil/i],[P,[D,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[O,[M,"Edge"+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[O,[M,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[M,O],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[O,M]],os:[[/microsoft (windows) (vista|xp)/i],[M,O],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[M,[O,strMapper,ae]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[M,"Windows"],[O,strMapper,ae]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[O,/_/g,"."],[M,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[M,"Mac OS"],[O,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[O,M],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[M,O],[/\(bb(10);/i],[O,[M,j]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[O,[M,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[O,[M,z+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[O,[M,"webOS"]],[/crkey\/([\d\.]+)/i],[O,[M,W+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[M,"Chromium OS"],O],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[M,O],[/(sunos) ?([\w\.\d]*)/i],[[M,"Solaris"],O],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[M,O]]},UAParser=function(g,m){if(typeof g===b&&(m=g,g=v),!(this instanceof UAParser))return new UAParser(g,m).getResult();var C=g||(typeof S!==I&&S.navigator&&S.navigator.userAgent?S.navigator.userAgent:_),E=m?extend(oe,m):oe;return this.getBrowser=function(){var g={};return g[M]=v,g[O]=v,rgxMapper.call(g,C,E.browser),g.major=majorize(g.version),g},this.getCPU=function(){var g={};return g[N]=v,rgxMapper.call(g,C,E.cpu),g},this.getDevice=function(){var g={};return g[D]=v,g[P]=v,g[w]=v,rgxMapper.call(g,C,E.device),g},this.getEngine=function(){var g={};return g[M]=v,g[O]=v,rgxMapper.call(g,C,E.engine),g},this.getOS=function(){var g={};return g[M]=v,g[O]=v,rgxMapper.call(g,C,E.os),g},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return C},this.setUA=function(g){return C=typeof g===A&&g.length>B?trim(g,B):g,this},this.setUA(C),this};UAParser.VERSION=C,UAParser.BROWSER=enumerize([M,O,R]),UAParser.CPU=enumerize([N]),UAParser.DEVICE=enumerize([P,D,w,k,L,x,F,U,V]),UAParser.ENGINE=UAParser.OS=enumerize([M,O]),g.exports&&(m=g.exports=UAParser),m.UAParser=UAParser;var le=typeof S!==I&&(S.jQuery||S.Zepto);if(le&&!le.ua){var ce=new UAParser;le.ua=ce.getResult(),le.ua.get=function(){return ce.getUA()},le.ua.set=function(g){ce.setUA(g);var m=ce.getResult();for(var S in m)le.ua[S]=m[S]}}}("object"==typeof window?window:C)}));const fm=[{name:"edge",engine:"Edge",key:"Edge"},{name:"edgeanaheim",engine:"Chromium",key:"Edg"},{name:"chromium",engine:"Chromium",key:"Chromium"},{name:"opera",engine:"Chromium",key:"OPR"},{name:"yandexbrowser",engine:"Chromium",key:"YaBrowser"},{name:"electron",engine:"Chromium",key:"Electron"},{name:"chrome",engine:"Chromium",key:"Chrome"},{name:"firefox",engine:"Firefox",key:"Firefox"},{name:"safari",engine:"Safari",key:"Safari"},{name:"applewebview",engine:"Safari",key:"Mac OS X"},{name:"ie",engine:"MSIE",key:"Trident"}],Sm="0.0",vm="unknown";function getFormFactor(g){return/iPhone|iPad|iPod|Android|Mobi/i.test(g)?"Mobile":"Desktop"}function isAndroid(g){const m=!/like android/i.test(g),S=/android/i.test(g);return m&&S}let Cm=new mm.UAParser;function getEnvironmentDetails(){Cm||(Cm=new mm.UAParser);return Cm.getResult()}function getPlatformName(){const g=getEnvironmentDetails().ua;return-1!==g.indexOf("Edge")?"edge":-1!==g.indexOf("Electron")?"electron":-1!==g.indexOf("Chrome")?"chrome":-1!==g.indexOf("Firefox")?"firefox":-1!==g.indexOf("Safari")?"safari":-1!==g.indexOf("Mac OS X")?"applewebview":-1!==g.indexOf("Trident")?"ie":"unknown"}function updateBrowserName(g,m){return"edge"!==g&&"edgeanaheim"!==g||((m.includes("Edg/")||m.includes("EdgA/")||m.includes("EdgiOS/"))&&(g="edgeanaheim"),m.includes("Edge/")&&(g="edge")),g}function getBrowserName(g,m){const S=m.find((({key:m})=>g.includes(m)));if(!S)return vm;let v=S.name;return v=updateBrowserName(v,getEnvironmentDetails().ua),v}function updateBrowserEngine(g,m){const S=getOS();return"chrome"===g&&"ios"===S&&(m="Safari"),m}function getBrowserEngine(g,m){const S=m.find((({name:m})=>m===g));if(!S)return vm;let v=S.engine;return v=updateBrowserEngine(g,v),v}function getBrowserVersion(){const g=getEnvironmentDetails();return"WebKit"===g.browser.name&&-1!==g.ua.indexOf("Mac OS X")?g.os.version??Sm:void 0!==g.browser.version?g.browser.version:Sm}function getBrowserInfo(){const g=getEnvironmentDetails(),m=g.ua,S=getBrowserName(g.browser.name,fm);return{name:S,engine:getBrowserEngine(S,fm),version:getBrowserVersion(),formFactor:getFormFactor(m)}}function getOS(){const g=getEnvironmentDetails().ua;return/windows phone/i.test(g)?"windowsphone":/windows /i.test(g)?"windows":/macintosh/i.test(g)?"mac":/(ipod|iphone|ipad)/i.test(g)?"ios":isAndroid(g)?"android":/(web|hpw)[o0]s/i.test(g)?"webos":/tizen/i.test(g)?"tizen":/headlesschrome(?:\/([\w\.]+)| )/i.test(g)?"headlesschrome":/linux/i.test(g)?"linux":/CrOS/.test(g)?"chrome":"other"}function getInternalEnvInfo(){const g=getBrowserInfo();return`${`os=${getOS()};`} ${`osVer=${getOSVersion()};`} ${`browser=${g.name};`} ${`browserVer=${g.version};`} ${`formFactor=${g.formFactor};`}`}function getOSVersion(){const g=getEnvironmentDetails();return void 0!==g.os.version?g.os.version:Sm}function isDigitMade(g){return/^\d+$/.test(g)}function checkVersionSupport(g,S){g=g.replace(/,/g,".").trim(),S=S.replace(/,/g,".").trim();let v=g.split("."),C=S.split("."),_=0;try{if(!v.every(isDigitMade)||!C.every(isDigitMade))return-2;for(;v.length<C.length;)v.push("0");for(;C.length<v.length;)C.push("0");let g=v.map(Number),m=C.map(Number);for(var E=0;E<g.length;E++)if(g[E]!==m[E]){if(g[E]>m[E])return 1;if(g[E]<m[E])return-1}}catch(g){m.AzureLogger.log(`Error in browser check version support: ${g}`)}return _}function checkOsSupport(g){let m=getAcsEcsConfig()?.environments;return!!m.hasOwnProperty(g)}function checkOsBrowserSupport(g,m){let S=getAcsEcsConfig()?.environments;return!(!checkOsSupport(g)||!S[g].hasOwnProperty(m))&&S[g][m].isSupportedOnSdkVersion}function getMinBrowserVersion(g,m){let S=getAcsEcsConfig()?.environments;return S.hasOwnProperty(g)&&S[g].hasOwnProperty(m)?S[g][m].minVersion:Sm}function getEnvironmentInfos(){let g,m,S=!1;const v=getEnvironmentDetails(),C=getOS(),_=getBrowserInfo().name,E=getBrowserInfo().version,T=checkOsSupport(C),I=checkOsBrowserSupport(C,_);if(I){checkVersionSupport(E,getMinBrowserVersion(C,_))>=0&&(S=!0)}return m={platform:v.os.name,browser:v.browser.name,browserVersion:v.browser.version},g={environment:m,isSupportedPlatform:T,isSupportedBrowser:I,isSupportedBrowserVersion:S,isSupportedEnvironment:T&&I&&S},g}var __decorate$a=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$a=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class MediaConstraintsManager{get currentVideoConstraints(){return this._currentVideoConstraints}constructor(g,m,S){this._tsCall=g,this._currentVideoConstraints={send:{frameHeight:{max:void 0},frameRate:{max:void 0},bitrate:{max:void 0}}},this._logger=m.createChild("MediaConstraintsManager"),this._telemetryLogManager=S}async setVideoConstraints(g,m,S,v){const C=this.getTelemetryPayload({video:g}),sendSuccessOrFailureTelemetryEvent=g=>{let C=g?{failureReason:g?g.message:void 0,code:g?g.code:void 0,...extractCommunicationServicesErrorForTelemetry(g)}:void 0;sendCallFeatureUsageTelemetry({correlationId:S,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"SetConstraints",featureType:"Call",initializationType:"None",timestampInfo:{deltaTimeInMs:+new Date-v},featureDetails:{name:"setConstraints",step:g?Rh.failure:Rh.success,stage:m},additionalDetails:{constraints:this.getTelemetryPayload({video:this._currentVideoConstraints}),...C}},this._telemetryLogManager,this._logger)};try{sendCallFeatureUsageTelemetry({correlationId:S,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"SetConstraints",featureType:"Call",initializationType:"None",timestampInfo:"",featureDetails:{name:"setConstraints",step:Rh.attempt,stage:m},additionalDetails:{constraints:C}},this._telemetryLogManager,this._logger);if(!getAcsEcsConfig().calling.constraints.enabled)throw this._logger.error("Setting call constraints is disabled"),new CallingCommunicationError({defaultError:D.CALL.MEDIA_CONSTRAINTS_DISABLED});this._updateVideoConstraintsCache(g);const v={outgoingVideoLimit:{maxResolution:this._currentVideoConstraints.send?.frameHeight?.max,maxFramerate:this._currentVideoConstraints.send?.frameRate?.max,maxBitrate:this._currentVideoConstraints.send?.bitrate?.max}},_=this._tsCall.setCallConstraints?.(v);if("mid-call"!==m)_?.then((()=>{this._logger.info(`Successfully set call constraints at call ${m} - ${JSON.stringify(this._currentVideoConstraints)}`),sendSuccessOrFailureTelemetryEvent()})).catch((g=>{this._logger.error(`Error setting call constraints at call ${m}`);const S=new CallingCommunicationError({defaultError:D.CALL.SET_CONSTRAINTS_START_OR_ACCEPT,defaultErrorMessageArgs:[m],originalError:g});sendSuccessOrFailureTelemetryEvent(S)}));else try{await _,this._logger.info(`Successfully set call constraints during ${m} - ${JSON.stringify(this._currentVideoConstraints)}`),sendSuccessOrFailureTelemetryEvent()}catch(g){throw new CallingCommunicationError({defaultError:D.CALL.SET_CONSTRAINTS_MID_CALL,originalError:g})}return this._currentVideoConstraints}catch(g){const S=new CallingCommunicationError({defaultError:D.CALL.SET_CONSTRAINTS,defaultErrorMessageArgs:[m],originalError:g});throw sendSuccessOrFailureTelemetryEvent(S),S}}getTelemetryPayload(g){return{video:{send:{frameHeight:{max:g.video?.send?.frameHeight?.max},frameRate:{max:g.video?.send?.frameRate?.max},bitrate:{max:g.video?.send?.bitrate?.max}}}}}_updateVideoConstraintsCache(g){const m=getAcsEcsConfig(),S=m.calling.constraints.maxOutgoingResolution,v=m.calling.constraints.maxOutgoingFrameRate,C=m.calling.constraints.maxOutgoingVideoBitrate,_=g?.send?.frameHeight?.max??this._currentVideoConstraints.send?.frameHeight?.max,E=g?.send?.frameRate?.max??this._currentVideoConstraints.send?.frameRate?.max,T=g?.send?.bitrate?.max??this._currentVideoConstraints.send?.bitrate?.max;this._currentVideoConstraints={send:{frameHeight:{max:this._getConstraintValue(S,"maxOutgoingResolution",_)},frameRate:{max:this._getConstraintValue(v,"maxOutgoingFrameRate",E)},bitrate:{max:this._getConstraintValue(C,"maxOutgoingBitrate",T)}}}}_getConstraintValue(g,m,S){return"number"==typeof S?S<1?void this._logger.info(`Received ${m} as 0 or less, removing ${m} constraint`):(g>0&&S>g&&(this._logger.info(`${m} value ${S} is larger than ${g}, resetting to ${g}`),S=g),S):void this._logger.warn(`Received invalid ${m} value, removing ${m} constraint`)}}__decorate$a([loggerProperty,__metadata$a("design:type",Object)],MediaConstraintsManager.prototype,"_logger",void 0);var __decorate$b=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$b=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LobbyImpl{constructor(g,m,S,v){this.logger=S.createChild("Lobby"),this._tsCall=g,this._eventEmitter=new CallingEventEmitter(this.logger),this._participants=new Map,this._call=m,this._telemetryLogManager=v,this._lobbySupportedConversationTypes=getAcsEcsConfig().calling.lobbyAdmitAndReject.supportedConversationTypes,this._isLobbyEnabled=getAcsEcsConfig().calling.lobbyAdmitAndReject.enabled,this._hasExpectedError=!1,this._isLobbyEnabled&&(this.getInLobbyParticipants(m.remoteParticipants),this._remoteParticipantUpdatedListener=g=>{if(0!==g.added.length&&g.added.forEach((g=>{"InLobby"===g.state&&this.addLobbyParticipant(g),g.on("stateChanged",(()=>{"InLobby"===g.state?this.addLobbyParticipant(g):"Connected"===g.state&&this.removeLobbyParticipant(g)}))})),0!==g.removed.length){if(0===this._call.remoteParticipants.length)return void this.removeAllLobbyParticipants();g.removed.forEach((g=>{this.removeLobbyParticipant(g)}))}},this._call.on("remoteParticipantsUpdated",this._remoteParticipantUpdatedListener))}on(g,m){if("lobbyParticipantsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.LOBBY.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("lobbyParticipantsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.LOBBY.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}async admit(g,m){if(!this._isLobbyEnabled)return void this.logger.warn("Lobby is not enabled");const S=generateGuid(),v=+new Date;this._sendLobbyAdmitAndRejectUsage("Start admit participant",Ph.lobbyAdmit,S,Rh.attempt,void 0);try{validateIdentifier(g),this.validateLobbyOperation(g),await this._tsCall.admitParticipant(getMriFromIdentifier(g));const m=+new Date;this._sendLobbyAdmitAndRejectUsage("Lobby participant admitted successfully",Ph.lobbyAdmit,S,Rh.success,m-v)}catch(g){let m=wh.Unexpected;this._hasExpectedError&&(m=wh.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to admit participant from lobby",g,S,v,Ph.lobbyAdmit,m)}}async reject(g,m){if(!this._isLobbyEnabled)return void this.logger.warn("Lobby is not enabled");const S=generateGuid(),v=+new Date;this._sendLobbyAdmitAndRejectUsage("Start reject participant",Ph.lobbyReject,S,Rh.attempt,void 0);try{validateIdentifier(g),this.validateLobbyOperation(g),await this._tsCall.removeParticipant(getMriFromIdentifier(g));const m=+new Date;this._sendLobbyAdmitAndRejectUsage("Lobby participant rejected successfully",Ph.lobbyReject,S,Rh.success,m-v)}catch(g){let m=wh.Unexpected;this._hasExpectedError&&(m=wh.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to reject participant from lobby",g,S,v,Ph.lobbyReject,m)}}async admitAll(g){const m=generateGuid(),S=+new Date;let v,C=0,_=0;if(!this._isLobbyEnabled)return this.logger.warn("Lobby is not enabled"),{successCount:C,failureCount:_};this._sendLobbyAdmitAndRejectUsage("Start admit all participants",Ph.lobbyAdmitAll,m,Rh.attempt,void 0);try{this.validateLobbyOperation(),await this._tsCall.admit({scope:"all"},M.generateCauseId()).then((g=>{if(v=g,g.result){const m=JSON.parse(g.result);C=m.successCount,_=m.failureCount}}));const g=+new Date;if(0!==_)return this._sendLobbyAdmitAndRejectUsage(`${C} participants are admitted successfully, ${_} participants admit failed. TransactionEnd: ${v}`,Ph.lobbyAdmitAll,m,Rh.success,g-S),{successCount:C,failureCount:_};this._sendLobbyAdmitAndRejectUsage("All participants are admitted successfully",Ph.lobbyAdmitAll,m,Rh.success,g-S)}catch(g){let v=wh.Unexpected;this._hasExpectedError&&(v=wh.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to admit all participants from lobby",g,m,S,Ph.lobbyAdmitAll,v)}return{successCount:C,failureCount:_}}get participants(){return this._isLobbyEnabled?Array.from(this._participants.values()):(this.logger.warn("Lobby is not enabled"),[])}getInLobbyParticipants(g){g.forEach((g=>{if("InLobby"===g.state){const m=getMriFromIdentifier(g.identifier);this._participants.set(m,g)}}))}removeAllLobbyParticipants(){if(0===this._participants.size)return;const g=Array.from(this._participants.values());this._participants.clear(),this.logger.info("All participants are removed from lobby"),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[],removed:g})}removeLobbyParticipant(g){const m=getMriFromIdentifier(g.identifier);this._participants.has(m)&&(this.logger.info(`${S.getIdentifierKind(g.identifier).kind} is removed from lobby`),this._participants.delete(m),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[],removed:[g]}))}addLobbyParticipant(g){const m=getMriFromIdentifier(g.identifier);this._participants.has(m)||(this.logger.info(`${S.getIdentifierKind(g.identifier).kind} is added to lobby`),this._participants.set(m,g),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[g],removed:[]}))}validateLobbyOperation(g){const m=this._tsCall.conversationType?this._tsCall.conversationType:"oneToOneCall";if(this.logger.info("Current conversation type is: ",m),!this._lobbySupportedConversationTypes.find((g=>g===m)))throw this._hasExpectedError=!0,new CallingCommunicationError({defaultError:D.LOBBY.CONV_UNSUPPORTED});if(g){let m=this._call.remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));if(m&&"Connected"===m.state)throw this._hasExpectedError=!0,new CallingCommunicationError({defaultError:D.LOBBY.ALREADY_IN_MEETING,defaultErrorMessageArgs:[S.getIdentifierKind(g).kind]});if(m&&"InLobby"!==m.state||!m)throw this._hasExpectedError=!0,new CallingCommunicationError({defaultError:D.LOBBY.NOT_IN_LOBBY,defaultErrorMessageArgs:[S.getIdentifierKind(g).kind]})}if(this._call.role!==zo.Presenter&&this._call.role!==zo.Organizer&&this._call.role!==zo.Coorganizer)throw this._hasExpectedError=!0,new CallingCommunicationError({defaultError:D.LOBBY.UNAUTHORIZED_ADMIT_REJECT})}handleLobbyAdmitAndRejectFailure(g,m,S,v,C,_){const E=+new Date,T=handleLobbyFailure(this.logger,m,g);throw this._sendLobbyAdmitAndRejectUsage(T.message,C,S,Rh.failure,E-v,_,m),T}_sendLobbyAdmitAndRejectUsage(g,m,S,v,C,_,E){v===Rh.failure?this.logger.error(g):this.logger.info(g),this.sendLobbyAdmitAndRejectEvent({eventName:Ah.acs_calling_lobby_events,callId:this._call.id,localParticipantId:this._tsCall.participantId,correlationId:S,kindOfEvent:v,operation:m,isExpected:_??"",timestampInfo:C?{deltaTimeInMs:C}:"",additionalDetails:E?{failureReason:E.message,code:E.code,subCode:E.subCode,...extractCommunicationServicesErrorForTelemetry(E)}:""})}sendLobbyAdmitAndRejectEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send lobby admit and reject telemetry")}}}function getMmrRdpState(){const g=window.navigator.mediaDevices;if(g?.isRemote){const m=g?.MSRDC_MMR_Shim?.remoteObjectManager?.isConnected;if(!0===m)return"connected";if(!1===m)return"disconnected"}return""}function getMMRInfo(){const g=window.navigator.mediaDevices,m={isMMREnabled:g?.isRemote??!1};return m.isMMREnabled&&(g?.mmrClientVersion&&(m.mmrClientVersion=g.mmrClientVersion),g?.mmrExtensionVersion&&(m.mmrExtensionVersion=g.mmrExtensionVersion),g?.mmrHostVersion&&(m.mmrHostVersion=g.mmrHostVersion),g?.activityId&&(m.mmrActivityId=g.activityId),g?.connectionId&&(m.mmrConnectionId=g.connectionId),m.mmrRdpState=getMmrRdpState()),m}__decorate$b([loggerProperty,__metadata$b("design:type",Object)],LobbyImpl.prototype,"logger",void 0),__decorate$b([asyncOperation($h.LobbyAdmitParticipant),__metadata$b("design:type",Function),__metadata$b("design:paramtypes",[Object,Object]),__metadata$b("design:returntype",Promise)],LobbyImpl.prototype,"admit",null),__decorate$b([asyncOperation($h.LobbyRejectParticipant),__metadata$b("design:type",Function),__metadata$b("design:paramtypes",[Object,Object]),__metadata$b("design:returntype",Promise)],LobbyImpl.prototype,"reject",null),__decorate$b([asyncOperation($h.LobbyAdmitAll),__metadata$b("design:type",Function),__metadata$b("design:paramtypes",[Object]),__metadata$b("design:returntype",Promise)],LobbyImpl.prototype,"admitAll",null);class MmrRdpConnectionManager{constructor(g){this._lastState="",this._callback=g=>{const m=g?.detail?.state??"";m?m!==this._lastState&&(this._logger.info(`connection state is ${m}`),this._eventEmitter.emit("stateChange",m),this._lastState=m):this._logger.info("connection state is unknown")},this._logger=g.createChild("MmrRdpConnectionManager"),this._eventEmitter=new Su.EventEmitter;const m=window.navigator.mediaDevices;m?.isRemote&&(m?.addEventListener("rdpClientConnectionStateChanged",this._callback),this._logger.info("listener registered"))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}get state(){return getMmrRdpState()}dispose(){const g=window.navigator.mediaDevices;g?.isRemote&&(g?.removeEventListener("rdpClientConnectionStateChanged",this._callback),this._logger.info("event listener unregistered")),this._eventEmitter.removeAllListeners()}}var __decorate$c=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$c=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class RemoteVideoStreamImpl extends RemoteVideoStreamCommonImpl{constructor(g,m,S,v,C,_,E){super(g,m,S,C,_,"RemoteVideoStream"),this._remoteParticipantIdentifier=E,this._isAvailable=!1,this.setIsAvailable=g=>{g!==this._isAvailable&&(this._isAvailable=!!g,this.logger.log(`isAvailable changed to ${this._isAvailable}`),this._eventEmitter.emit("isAvailableChanged",this._isAvailable),this.call.isHandlingLargeMeetingVideoRendering&&this.call.handleDominantSpeakersVideos(),super.sendRemoteVideoStreamTelemetry())};const handleIsAvailable=()=>{if("Video"===this.mediaStreamType&&S.isHandlingLargeMeetingVideoRendering){for(let g of S.getTopNDominantSpeakersWithVideoOn())if(this.tsStream.isAvailable&&getMriFromIdentifier(g.identifier)===getMriFromIdentifier(this._remoteParticipantIdentifier))return void this.setIsAvailable(!0);this.setIsAvailable(!1)}else this.setIsAvailable(this.tsStream.isAvailable)};this._streamChangedHandler=this.tsStream.changed((()=>{handleIsAvailable()})),handleIsAvailable()}on(g,m){if("isAvailableChanged"!==g&&"sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("isAvailableChanged"!==g&&"sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}get isAvailable(){return this._isAvailable}async getMediaStream(){const g=generateGuid();let m=+new Date;const S={correlationId:g,additionalDetails:{remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},operation:cu.getMediaStream,mediaType:this.getMediaType(),streamType:lu.Remote,timestampInfo:{attemptTimestamp:m},kindOfEvent:Rh.attempt,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};this.sendMediaStreamEvent(S);try{if(!this.tsStream.getRawStream)throw new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.GET_RAW_MEDIA_STREAM});if(!this.tsStream.isAvailable)throw new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.STREAM_NOT_AVAILABLE});const S=this.tsStream.getRawStream(),v=new Promise((async(g,m)=>{const v=setTimeout((()=>{C.dispose(),m(new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.SUBSCRIBE_MEDIA_STREAM_TIMEOUT}))}),getAcsEcsConfig().rendering.remoteVideo.getMediaStreamTimeout),C=S.changed((()=>{tryToResolveGetStreamPromise()})),tryToResolveGetStreamPromise=async()=>{try{const m=await S.getMediaStream();if(!m)return void this.logger.warn("MediaStream is not yet ready.");clearTimeout(v),C.dispose(),g(m)}catch(g){this.logger.warn(`MediaStream is not yet ready, error=${g?.message||"unknown"}`)}};tryToResolveGetStreamPromise()})),C=await v,_=C.getVideoTracks()[0];if(!_)throw new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.GET_TRACK});const E=new Promise(((g,m)=>{const resolveUnmutedPromise=()=>{_.removeEventListener("unmute",resolveUnmutedPromise,!1),g()};_.addEventListener("unmute",resolveUnmutedPromise,!1),_.muted?setTimeout((()=>{_.removeEventListener("unmute",resolveUnmutedPromise,!1),m(new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.TRACK_UNMUTED_TIMEOUT}))}),getAcsEcsConfig().rendering.remoteVideo.getMediaStreamTimeout):resolveUnmutedPromise()}));await E;const T={correlationId:g,additionalDetails:{remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},operation:cu.getMediaStream,mediaType:this.getMediaType(),streamType:lu.Remote,timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Rh.success,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};return this.sendMediaStreamEvent(T),C}catch(S){const v={correlationId:g,operation:cu.getMediaStream,mediaType:this.getMediaType(),streamType:lu.Remote,additionalDetails:{failureReason:S?.message||"",code:S.code||F,...extractCommunicationServicesErrorForTelemetry(S),remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Rh.failure,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};throw this.sendMediaStreamEvent(v),new CallingCommunicationError({defaultError:D.REMOTE_VIDEO_STREAM.GET_MEDIA_STREAM,originalError:S})}}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",rank:this.tsStream.rank,isAvailable:this.tsStream.isAvailable,isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this._renderers.map((g=>g.viewId)).join(", "),height:this._size.height,width:this._size.width,isDisposed:this._disposed,optimalVideoCount:this.call?.tsCall.optimalVideoCount||1,currentNumberOfVideosRendered:this.call?.activeRemoteVideoStreamViews?.size||0}}dispose(){this.setIsAvailable(!1),super.dispose()}getMediaType(){return"ScreenSharing"===this.mediaStreamType?ou.ScreenSharingRaw:ou.VideoRaw}sendMediaStreamEvent(g){this.telemetryLogManager.sendEvent({name:Ah.acs_calling_media_stream,tenant:Qa,properties:{timestampInfo:g.timestampInfo,correlationId:g.correlationId,additionalDetails:g.additionalDetails||"",kindOfEvent:g.kindOfEvent||"",mediaType:g.mediaType,streamType:g.streamType,operation:g.operation,localParticipantId:g.localParticipantId||"",callId:g.callId||""}})}}__decorate$c([asyncOperation(Xh.GetMediaStream),__metadata$c("design:type",Function),__metadata$c("design:paramtypes",[]),__metadata$c("design:returntype",Promise)],RemoteVideoStreamImpl.prototype,"getMediaStream",null);var __decorate$d=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$d=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let _m=1;class RemoteStreamRenderer{get isRendering(){return this._isRendering}get scalingMode(){return this._scalingMode}get isMirrored(){return this._isMirrored}get target(){return this._target}get viewId(){return this._viewId}get size(){return{height:this._size.height,width:this._size.width}}constructor(g,m,S,v,C,_){this._target=g,this._viewId=m,this._videoStream=S,this._onDisposedCallback=C,this._eventEmitter=new Su.EventEmitter,this._isRendering=!1,this._scalingMode="Stretch",this._isMirrored=!1,this._size={height:0,width:0},this._disposed=!1,this._handleTsRendererChanged=g=>{if(this.logger.debug(`rendering state is ${this._isRendering}, changed to ${this._tsRenderer?.isRendering}`),this._tsRenderer)if(this._tsRenderer.isRendering!==this._isRendering&&(this._isRendering=this._tsRenderer.isRendering,this._videoStream.updateIsReceiving(),this._isRendering&&this._renderingDeferred&&this._renderingDeferred.isPending()&&this._renderingDeferred.resolve(),g.log(`isRendering change to ${this._isRendering}`)),this._tsRenderer.isRendering){const g=this._tsRenderer.streamSize.height,m=this._tsRenderer.streamSize.width;g===this._size.height&&m===this._size.width||(this._size.height=g,this._size.width=m,this._videoStream.updateSize())}else this._size.height=0,this._size.width=0,this._videoStream.updateSize();this.sendRendererTelemetry()},this.sendRendererTelemetry=()=>{if(this._tsRenderer)try{const g={isRendering:this._tsRenderer.isRendering,streamWidth:this._tsRenderer.streamSize.width,streamHeight:this._tsRenderer.streamSize.height,isVideoAttached:this._target.isConnected,rendererWidth:this._target?.offsetWidth,rendererHeight:this._target?.offsetHeight};if(this.previousStats){if(shallowEqual(this.previousStats,g))return}else this.previousStats=g;this.previousStats=g;const m=this._videoStream.getStreamMetadata(),{callId:S,localParticipantId:v,isDisposed:C,viewIdsRegistered:_,height:E,width:T,...I}=m,b={...g,...I,viewId:this._viewId,disposed:this._disposed};this._videoStream.call.stats.recordEvent({name:bh.remote_view,callId:S,localParticipantId:v,data:b})}catch(g){}},this._unsubscribeAvailabilityCallback=()=>{this._availableCallback&&("RemoteVideoStream"===this._videoStream.kind&&this._videoStream?.off("isAvailableChanged",this._availableCallback),this._availableCallback=void 0)},this._disposeTsRendererChangedObservable=()=>{this._tsRendererChanged&&(this._tsRendererChanged.dispose(),this._tsRendererChanged=void 0)},this._attemptToDisposeTsRenderer=()=>{if(this._tsRenderer){this.logger.debug("disposing underlying remote renderer");try{this._tsRenderer?.dispose(),this._tsRenderer=void 0}catch(g){throw this.logger.warn(`underlying remote renderer dispose failed with ${g?.message} error`),new CallingCommunicationError({defaultError:D.VIEW.REMOTE_RENDERER_DISPOSE_FAIL})}}},this.logger=v.createChild("RemoteStreamRenderer"+_m++),this.logger.log("created"),void 0!==_?.scalingMode&&(this._scalingMode=_.scalingMode),void 0!==_?.isMirrored&&(this._isMirrored=_.isMirrored),this._remoteStreamTelemetryEventSender=new StreamTelemetryEventSender(this._videoStream.telemetryLogManager)}async start(){const g=generateGuid(),m=+new Date,S=this.logger.createFnLogger(Zh.Start),v={timestampInfo:{attemptTimestamp:m},correlationId:g,operation:cu.render,kindOfEvent:Rh.attempt,mediaType:this._videoStream.mediaStreamType,streamType:lu.Remote};if(this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(v),this._disposed)throw this.logger.warn("already disposed"),new CallingCommunicationError({defaultError:D.VIEW.START_ALREADY_DISPOSED});try{S.info(`scalingMode=${toTsScalingMode(this._scalingMode)}`),this._videoStream.registerRenderer(this),this._renderingDeferred=defer$1(),this._renderingDeferred.promise.catch(noop),"RemoteVideoStream"===this._videoStream.kind&&(this._availableCallback=()=>{this._videoStream.isAvailable||(S.warn("stream isAvailable changed to false, attempting to reject operation"),this._renderingDeferred?.isPending()&&!this._disposed&&this._renderingDeferred?.reject(new CallingCommunicationError({defaultError:D.VIEW.STREAM_BECAME_UNAVAILABLE})))},this._videoStream.on("isAvailableChanged",this._availableCallback)),this._videoStream.tsStream.start(this._target,{scalingMode:toTsScalingMode(this._scalingMode),transparent:!1}).then((g=>{if(this._isMirrored&&(this._target.style.transform="rotateY(180deg)",this._target.style.webkitTransform="rotateY(180deg)"),this._tsRenderer=g,this.logger.info("subscribed to video, waiting for the first frame"),this._disposed)throw this.logger.warn("already disposed, dispose underlying renderer"),this._attemptToDisposeTsRenderer(),new CallingCommunicationError({defaultError:D.VIEW.START_ALREADY_DISPOSED});this.logger.info(`current state of rendering is ${this._tsRenderer.isRendering}`),this.sendRendererTelemetry(),-1!==getAcsEcsConfig().rendering.remoteVideo.createViewTimeout&&setTimeout((()=>{if(this._renderingDeferred?.isPending())try{this._renderingDeferred.reject(new CallingCommunicationError({defaultError:D.VIEW.TIMEOUT}))}catch(g){}}),getAcsEcsConfig().rendering.remoteVideo.createViewTimeout),this._tsRendererChanged=this._tsRenderer.changed((()=>this._handleTsRendererChanged(S))),this._tsRenderer.isRendering&&this._renderingDeferred?.isPending()&&(this._isRendering=!0,this._videoStream.updateIsReceiving(),this._size.width=g.streamSize.width,this._size.height=g.streamSize.height,this._videoStream.updateSize(),this._renderingDeferred.resolve())})).catch((g=>{if(this.logger.info("Failed to subscribe to video"),this._renderingDeferred?.isPending()){const m=new CallingCommunicationError({defaultError:D.VIEW.SUBSCRIBE,originalError:g});this._renderingDeferred.reject(m)}})),await this._renderingDeferred.promise,this._videoStream.flushIsReceiving(),this._unsubscribeAvailabilityCallback(),getAcsEcsConfig().rendering.remoteVideo.forceCheckIfVideoWasAttachedToDom&&this._checkIfVideoWasAttachedToDom();const v={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,operation:cu.render,kindOfEvent:Rh.success,mediaType:this._videoStream.mediaStreamType,streamType:lu.Remote};return this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(v),this}catch(S){this.logger.warn(`Failed to render, message=${S}`);try{this.dispose()}catch(g){this.logger.warn(`dispose failed with ${g?.message} error`)}const v=new CallingCommunicationError({defaultError:D.VIEW.START,originalError:S});if(v.message!==D.VIEW.LARGE_MEETING_VIEW_DISPOSED.message&&v.message!==D.VIEW.REMOTE_VIDEO_STREAM_DISPOSED.message){const S={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,operation:cu.render,additionalDetails:{failureReason:v.message,code:L,...extractCommunicationServicesErrorForTelemetry(v)},kindOfEvent:Rh.failure,mediaType:this._videoStream.mediaStreamType,streamType:lu.Remote};this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(S)}throw v}}async setScalingMode(g){if(!this._tsRenderer)throw new CallingCommunicationError({defaultError:D.VIEW.SCALING_MODE});await this._tsRenderer.setScalingMode(toTsScalingMode(g)),this._scalingMode=g}dispose(g=uu.Public_App){if(this._disposed)throw new CallingCommunicationError({defaultError:D.VIEW.RENDERER_DISPOSE_ALREADY_DISPOSED});if(this._disposed=!0,this._disposeTsRendererChangedObservable(),this._unsubscribeAvailabilityCallback(),this._attemptToDisposeTsRenderer(),this._renderingDeferred?.isPending()){let m;switch(g){case uu.Internal_LargeMeetingVideoRendering:m=D.VIEW.LARGE_MEETING_VIEW_DISPOSED;break;case uu.Internal_RemoteVideoStreamDisposed:m=D.VIEW.REMOTE_VIDEO_STREAM_DISPOSED;break;default:m=D.VIEW.APP_VIEW_DISPOSED}this._renderingDeferred.reject(new CallingCommunicationError({defaultError:m}))}this._target&&this._target.remove();try{g!==uu.Public_App&&this._onDisposedCallback(g)}catch(g){this.logger.debug(`dispose callback failed with ${g?.message} error`)}this._videoStream.unregisterRenderer(this),this._size.height=0,this._size.width=0,this._videoStream.updateSize(),this._isRendering=!1,this._videoStream.updateIsReceiving(),this._eventEmitter.removeAllListeners(),this._renderingDeferred=void 0}_checkIfVideoWasAttachedToDom(){if(getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_poll){let g=getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_intervalMaxTries;const check=()=>{this._target.isConnected||g<=0?this.sendRendererTelemetry():(g--,g>=0&&setTimeout((()=>check),getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_intervalTime))};check()}else setTimeout((()=>{this._target.isConnected&&this.sendRendererTelemetry()}),getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_timeout)}}__decorate$d([loggerProperty,__metadata$d("design:type",Object)],RemoteStreamRenderer.prototype,"logger",void 0),__decorate$d([asyncOperation(Zh.Start),__metadata$d("design:type",Function),__metadata$d("design:paramtypes",[]),__metadata$d("design:returntype",Promise)],RemoteStreamRenderer.prototype,"start",null),__decorate$d([syncOperation(Zh.Dispose),__metadata$d("design:type",Function),__metadata$d("design:paramtypes",[String]),__metadata$d("design:returntype",void 0)],RemoteStreamRenderer.prototype,"dispose",null);var __decorate$e=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$e=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LocalStreamRenderer{get isRendering(){return this._isRendering}get scalingMode(){return this._scalingMode}get isMirrored(){return this._isMirrored}get target(){return this._target}constructor(g,m,S,v,C){this._target=g,this._videoStream=m,this._onDisposed=v,this._eventEmitter=new Su.EventEmitter,this._isRendering=!1,this._scalingMode="Stretch",this._isMirrored=!0,this._disposed=!1,this.logger=S.createChild("LocalStreamRenderer"),this.logger.log("created"),void 0!==C?.scalingMode&&(this._scalingMode=C.scalingMode),void 0!==C?.isMirrored?this._isMirrored=C.isMirrored:"ScreenSharing"===this._videoStream.mediaStreamType&&(this._isMirrored=!1),this._localStreamTelemetryEventSender=new StreamTelemetryEventSender(this._videoStream.telemetryLogManager)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}async start(){const g=generateGuid(),m=this.logger.createFnLogger(Zh.Start),S=+new Date,v={timestampInfo:{attemptTimestamp:S},correlationId:g,operation:cu.render,kindOfEvent:Rh.attempt,mediaType:this._videoStream.mediaStreamType,streamType:lu.Local};this._localStreamTelemetryEventSender.sendMediaStreamEvent(v);try{if(m.info("attempting to select new device as a source"),this._videoStream.source instanceof VideoDeviceInfoImpl&&"Video"===this._videoStream.mediaStreamType){const g=this._videoStream.source.deviceManager.getTsDeviceManager();g.selectDevices({camera:this._videoStream.source.id}),m.info("device selected"),m.info("creating preview"),this._tsRenderer=await g.createPreview(this._target,{kind:"camera"},{scalingMode:toTsScalingMode(this._scalingMode),transparent:!1,ignoreMirroring:!1,disposeRendererWhenStreamisNotAvailable:()=>!0})}else{if("RawMedia"!==this._videoStream.mediaStreamType&&"ScreenSharing"!==this._videoStream.mediaStreamType)throw new CallingCommunicationError({defaultError:D.VIEW.UNKNOWN_STREAM_TYPE});{const g=document.createElement("video");g.srcObject=await this._videoStream.getMediaStream(),g.play(),this._target.appendChild(g)}}this._isMirrored&&(this._target.style.transform="rotateY(180deg)",this._target.style.webkitTransform="rotateY(180deg)"),this._videoStream.registerRenderer(this);const v={timestampInfo:{deltaTimeInMs:+new Date-S},correlationId:g,operation:cu.render,kindOfEvent:Rh.success,mediaType:this._videoStream.mediaStreamType,streamType:lu.Local};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),this}catch(v){this.dispose();const C=handleVideoOperationFailure(m,v),_={timestampInfo:{deltaTimeInMs:+new Date-S},correlationId:g,operation:cu.render,additionalDetails:{failureReason:C.message,code:C.code,subCode:C.subCode,...extractCommunicationServicesErrorForTelemetry(C)},kindOfEvent:Rh.failure,mediaType:this._videoStream.mediaStreamType,streamType:lu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(_),C}}setScalingMode(g){if(!this._tsRenderer)throw new CallingCommunicationError({defaultError:D.VIEW.SCALING_MODE});this._tsRenderer.setScalingMode(toTsScalingMode(g)),this._scalingMode=g}setSourceObject(g){this.disposeScreenSharingMediaStream();const m=this._target.querySelector("video");m&&(m.srcObject=g,m.play())}dispose(){if(!this._disposed){if(this._tsRenderer)try{this.logger.log("disposing underlying local renderer"),this._tsRenderer.dispose(),this._tsRenderer=void 0}catch(g){throw this.logger.warn(`underlying local renderer dispose failed with ${g?.message} error`),new CallingCommunicationError({defaultError:D.VIEW.LOCAL_RENDERER_DISPOSE_FAIL})}this.disposeScreenSharingMediaStream(),this._target.remove(),this._onDisposed&&this._onDisposed(this),this._eventEmitter.removeAllListeners(),this._disposed=!0}}disposeScreenSharingMediaStream(){if(this._videoStream.getCall()?.localScreenSharingStream){const g=this._target.querySelector("video"),m=g?.srcObject;m&&(m.getVideoTracks().forEach((g=>{g.stop()})),g.srcObject=null,this.logger.info("disposed of ScreenSharing MediaStream"))}}}__decorate$e([loggerProperty,__metadata$e("design:type",Object)],LocalStreamRenderer.prototype,"logger",void 0),__decorate$e([asyncOperation(eu.Start),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[]),__metadata$e("design:returntype",Promise)],LocalStreamRenderer.prototype,"start",null),__decorate$e([syncOperation(eu.SetScalingMode),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[String]),__metadata$e("design:returntype",void 0)],LocalStreamRenderer.prototype,"setScalingMode",null),__decorate$e([syncOperation(eu.SetSourceObject),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[MediaStream]),__metadata$e("design:returntype",void 0)],LocalStreamRenderer.prototype,"setSourceObject",null),__decorate$e([syncOperation(eu.Dispose),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[]),__metadata$e("design:returntype",void 0)],LocalStreamRenderer.prototype,"dispose",null);var __decorate$f=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$f=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let ym=1;class VideoStreamRendererViewImpl{get scalingMode(){return this._streamRenderer.scalingMode}get isMirrored(){return this._streamRenderer.isMirrored}get disposed(){return this._disposed}constructor(g,m,S,v){if(this._videoStream=g,this._viewId=S,this._options=v,this._disposed=!1,this._deleteActiveRemoteVideoStreamView=(g,m)=>{if(g.call.activeRemoteVideoStreamViews?.has(g.id)){let S=g.call.activeRemoteVideoStreamViews?.get(g.id);S?.delete(m),0==S?.size&&g.call.activeRemoteVideoStreamViews?.delete(g.id)}},this.logger=m.createChild("VideoStreamRendererView"+ym++),this.target=document.createElement("div"),this.target.style.width="100%",this.target.style.height="100%",this._videoStream instanceof RemoteVideoStreamCommonImpl)this._streamRenderer=new RemoteStreamRenderer(this.target,this._viewId,this._videoStream,this.logger,(g=>{this._disposed?noop():this.dispose(g)}),this._options);else{if(!(this._videoStream instanceof LocalVideoStream))throw new CallingCommunicationError({defaultError:D.VIEW.VIEW_WRONG_STREAM_TYPE});this._streamRenderer=new LocalStreamRenderer(this.target,this._videoStream,this.logger,(()=>this.dispose),this._options)}this._telemetryLogManager=this._videoStream.telemetryLogManager,this.logger.info("created")}async render(){const g=this.logger.createFnLogger(this._videoStream instanceof RemoteVideoStreamCommonImpl?zh.RenderRemoteStream:zh.RenderLocalStream);if(this._disposed)throw g.log("failed, stream disposed!"),new CallingCommunicationError({defaultError:D.VIEW.RENDER_FAIL_STREAM_DISPOSED});try{await this._streamRenderer.start()}catch(m){g.error("failed");try{this.dispose()}catch(g){this.logger.warn(`Failed to dispose, message=${g.message}`)}throw m}}async updateScalingMode(g){if(this._disposed)throw new CallingCommunicationError({defaultError:D.VIEW.SCALING_MODE_DISPOSED});if("Crop"!==g&&"Fit"!==g&&"Stretch"!==g)throw new CallingCommunicationError({defaultError:D.VIEW.SCALING_MODE_WRONG_VAL});try{await this._streamRenderer.setScalingMode(g)}catch(g){throw new CallingCommunicationError({defaultError:D.VIEW.SCALING_MODE,originalError:g})}}dispose(g=uu.Public_App){if(this._disposed)throw new CallingCommunicationError({defaultError:D.VIEW.VIEW_ALREADY_DISPOSED});this._disposed=!0;const m=+new Date,S=generateGuid();try{g===uu.Public_App&&this.sendDisposeViewEvent({eventName:Ah.acs_calling_dispose_view_attempt,correlationId:S,timestampInfo:{attemptTimestamp:m}}),this._videoStream instanceof RemoteVideoStreamImpl&&this._deleteActiveRemoteVideoStreamView(this._videoStream,this._viewId),this.logger.debug("attempt to dispose stream renderer"),this._streamRenderer.dispose(g),this.target?.remove();const v=+new Date;g===uu.Public_App&&this.sendDisposeViewEvent({eventName:Ah.acs_calling_dispose_view_success,correlationId:S,timestampInfo:{deltaTimeInMs:v-m}})}catch(v){const C=new CallingCommunicationError({defaultError:D.VIEW.DISPOSE_FAIL,originalError:v});if(g===uu.Public_App){const g=+new Date;this.sendDisposeViewEvent({eventName:Ah.acs_calling_dispose_view_failure,correlationId:S,timestampInfo:{deltaTimeInMS:g-m}},C)}throw C}}sendDisposeViewEvent(g,m){try{let S,v;m&&(S="string"==typeof m?.message?m?.message:"",v={...extractCommunicationServicesErrorForTelemetry(m)}),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:{...this._videoStream.getStreamMetadata(),viewId:this._viewId,correlationId:g.correlationId,timestampInfo:g.timestampInfo,failureReason:S,additionalDetails:v}})}catch(g){this.logger.debug("Unable to send telemtery")}}}function collectLiveStreamStatsForCreateView(g,m,S,v){const C=["audioBitrate","videoBitrate","downloadBitrate","bufferLengthInMs","videoHeight","videoWidth","currentPlayPosition"],_=m[S.toString()];void 0!==_&&C.forEach((m=>{const S=m,C=m;if(void 0!==_[S]){const m=_[S];if(void 0===g[C])g[C]=[m];else{const S=g[C]?.length;S>=v&&g[C]?.shift(),g[C]?.push(m)}}}))}__decorate$f([loggerProperty,__metadata$f("design:type",Object)],VideoStreamRendererViewImpl.prototype,"logger",void 0),__decorate$f([asyncOperation(zh.Render),__metadata$f("design:type",Function),__metadata$f("design:paramtypes",[]),__metadata$f("design:returntype",Promise)],VideoStreamRendererViewImpl.prototype,"render",null),__decorate$f([asyncOperation(zh.UpdateScalingMode),__metadata$f("design:type",Function),__metadata$f("design:paramtypes",[String]),__metadata$f("design:returntype",Promise)],VideoStreamRendererViewImpl.prototype,"updateScalingMode",null),__decorate$f([syncOperation(zh.Dispose),__metadata$f("design:type",Function),__metadata$f("design:paramtypes",[String]),__metadata$f("design:returntype",void 0)],VideoStreamRendererViewImpl.prototype,"dispose",null);class CreateViewTelemetryHelper{get createViewStats(){return this._createViewStats}get initialCreateViewStats(){return this._initialCreateViewStats}constructor(g,m,S,v,C){this._statsCollector=g,this._streamId=m,this._logger=S,this._call=v,this._attemptTimestamp=C,this._createViewFailureStats={},this._createViewStats={},this._initialCreateViewStats={},this._statsCollector.on("sampleReported",(g=>{collectMediaStatsForCreateView(this.createViewStats,this.initialCreateViewStats,g,this._streamId)}))}getCreateViewFailureStats(){try{let g=0,m=NaN;void 0!==this.createViewStats.video?.framesDropped&&void 0!==this.initialCreateViewStats.video?.framesDropped&&(g=this.createViewStats.video?.framesDropped.length,m=this.createViewStats.video?.framesDropped[g-1]-this.initialCreateViewStats.video?.framesDropped[0]);let S=NaN,v=NaN;void 0!==this.createViewStats.video?.framesReceived&&void 0!==this.initialCreateViewStats.video?.framesReceived&&(g=this.createViewStats.video.framesReceived.length,S=this.createViewStats.video.framesReceived[g-1]-this.initialCreateViewStats.video?.framesReceived[0],g=this.initialCreateViewStats.video.framesReceived.length,v=this.initialCreateViewStats.video.framesReceived[0]);let C=NaN;void 0!==this.createViewStats.video?.framesDecoded&&void 0!==this.initialCreateViewStats.video?.framesDecoded&&(g=this.createViewStats.video.framesDecoded.length,C=this.createViewStats.video.framesDecoded[g-1]-this.initialCreateViewStats.video?.framesDecoded[0]);let _=NaN;void 0!==this.createViewStats.video?.keyFramesDecoded&&void 0!==this.initialCreateViewStats.video?.keyFramesDecoded&&(g=this.createViewStats.video.keyFramesDecoded.length,_=this.createViewStats.video.keyFramesDecoded[g-1]-this.initialCreateViewStats.video?.keyFramesDecoded[0]);let E=0;!isNaN(m)&&!isNaN(S)&&S>0&&(E=Number((m/S*100).toFixed(7)));let T=!1;S>0&&0===C&&(T=!0);let I=!1;isNaN(C)||isNaN(_)||C!==_||(I=!0);const b=[],A=this._call.networkQualityUfdEventDetails,R=getAcsEcsConfig().rendering.remoteVideo.createViewFailureNetworkUfdCheckWindowInMs;A.forEach((g=>{Math.abs(g.timestampInfo-this._attemptTimestamp)<=R&&b.push(g)}));let P=!1;isNaN(S)||isNaN(v)||S!==v||(P=!0),this._createViewFailureStats.video={framesDroppedPercentage:E,framesReceivedButNothingDecoded:T,onlyKeyFramesDecoded:I,networkQualityEventsDuringAttempt:b,zeroFramesReceived:P}}catch(g){this._logger.debug("Error calculating create view failure stats!")}return this._createViewFailureStats}}class CreateViewLiveStreamTelemetryHelper{constructor(g,m){this._liveStreamStatsCollector=g,this._streamId=m,this._liveStreamStats={},this._initialLiveStreamStats={};const S=getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStatsMaxLength;this._liveStreamStatsCollector.on("sampleReported",(g=>{collectLiveStreamStatsForCreateView(this._liveStreamStats,g,this._streamId,S),P.isEmpty(this._initialLiveStreamStats)&&(this._initialLiveStreamStats=this._liveStreamStats)}))}get initialCreateViewLiveStreamStats(){return this._initialLiveStreamStats}get createViewLiveStreamStats(){return this._liveStreamStats}}var __decorate$g=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$g=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class VideoStreamRenderer{get _createViewStats(){return"RemoteVideoStream"!==this._videoStream.kind&&"ComposedVideoStream"!==this._videoStream.kind||!this._createViewTelemetryHelper?"LiveVideoStream"===this._videoStream.kind&&this._createViewLiveStreamTelemetryHelper?this._createViewLiveStreamTelemetryHelper.createViewLiveStreamStats:{}:this._createViewTelemetryHelper.createViewStats}constructor(g){if(this.size={height:0,width:0},this.views=new Map,this.disposed=!1,this._attemptToDisposeView=g=>{try{g?.dispose()}catch(g){this.logger.warn(g?.message||"Failed to dispose, unknown error")}},this._addActiveRemoteVideoStreamView=(g,m,S)=>{if(g.call.activeRemoteVideoStreamViews?.has(g.id)){let v=g.call.activeRemoteVideoStreamViews?.get(g.id);v&&v.set(m,S)}else{let v=new Map;v.set(m,S),g.call.activeRemoteVideoStreamViews?.set(g.id,v)}},!(g instanceof LocalVideoStream||g instanceof RemoteVideoStreamCommonImpl||g instanceof RemoteVideoStreamImpl))throw new CallingCommunicationError({defaultError:D.VIEW.RENDERER_WRONG_STREAM_TYPE});const S=m.createClientLogger("ACS");this._videoStream=g,this._telemetryLogManager=g.telemetryLogManager,this.logger=new DefaultLogger(S,g instanceof LocalVideoStream?[()=>`VideoStreamRenderer:LocalVideoStream:${R.pii.Omit(g?.source?.id)}`]:[()=>`VideoStreamRenderer:${g.kind}:${g?.id}`]),this.logger.info("created")}async createView(g){if(this.disposed)throw new CallingCommunicationError({defaultError:D.VIEW.RENDERER_DISPOSED});const m=+new Date,S=generateGuid(),v=generateGuid();let C,_;try{if(this.sendCreateViewEvent({eventName:Ah.acs_calling_create_view_attempt,viewId:S,correlationId:v,timestampInfo:{attemptTimestamp:m}}),"RemoteVideoStream"===this._videoStream.kind&&!this._videoStream.isAvailable){const g=new CallingCommunicationError({defaultError:D.VIEW.ISAVAILABLE_FALSE}),C=+new Date;throw this.sendCreateViewEvent({eventName:Ah.acs_calling_create_view_failure,viewId:S,correlationId:v,timestampInfo:{deltaTimeInMs:C-m}},g),g}if("RemoteVideoStream"===this._videoStream.kind&&"ScreenSharing"!==this._videoStream.mediaStreamType&&getAcsEcsConfig()?.calling.applyViewLimit&&getMediaConfig()?.numVideoChannelsGvc){const g=getMediaConfig().numVideoChannelsGvc,C=this._videoStream;if(!C.call.activeRemoteVideoStreamViews?.has(C.id)&&C.call.activeRemoteVideoStreamViews?.size>=g){const C=new CallingCommunicationError({defaultError:D.VIEW.MAX_NUM_OF_VIEWS_REACHED,defaultErrorMessageArgs:[g]}),_=+new Date;throw this.sendCreateViewEvent({eventName:Ah.acs_calling_create_view_failure,viewId:S,correlationId:v,timestampInfo:{deltaTimeInMs:_-m}},C),C}}if(getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStats)if("RemoteVideoStream"===this._videoStream.kind||"ComposedVideoStream"===this._videoStream.kind){const g=this._videoStream,S=g.call;_=g.call.feature(pm.MediaStats).createCollector();const v=g.id;this._createViewTelemetryHelper=new CreateViewTelemetryHelper(_,v,this.logger,S,m)}else if("LiveVideoStream"===this._videoStream.kind){const g=this._videoStream;_=g.call.feature(pm.LiveStream).createStatsCollector();const m=g.id;this._createViewLiveStreamTelemetryHelper=new CreateViewLiveStreamTelemetryHelper(_,m)}C=new VideoStreamRendererViewImpl(this._videoStream,this.logger,S,g),this.views.set(S,C),await C.render(),"RemoteVideoStream"===this._videoStream.kind&&"ScreenSharing"!==this._videoStream.mediaStreamType&&this._addActiveRemoteVideoStreamView(this._videoStream,S,C);const E=+new Date;return this.sendCreateViewEvent({eventName:Ah.acs_calling_create_view_success,viewId:S,correlationId:v,timestampInfo:{deltaTimeInMs:E-m}}),_?.dispose(),C}catch(g){const E=new CallingCommunicationError({defaultError:D.VIEW.CREATE_VIEW_FAILED,originalError:g});if(this.views.delete(S),this._attemptToDisposeView(C),_?.dispose(),E.message!==D.VIEW.LARGE_MEETING_VIEW_DISPOSED.message&&E.message!==D.VIEW.REMOTE_VIDEO_STREAM_DISPOSED.message){const g=+new Date;this.sendCreateViewEvent({eventName:Ah.acs_calling_create_view_failure,viewId:S,correlationId:v,timestampInfo:{deltaTimeInMs:g-m}},E)}throw E}}async sendCreateViewEvent(g,m){try{let S={},v={},C={};if(getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStats&&(g.eventName===Ah.acs_calling_create_view_failure||g.eventName===Ah.acs_calling_create_view_success)){if("RemoteVideoStream"===this._videoStream.kind){const g=this._videoStream.call,m=g.tsCall.getMediaSessionStats();S={videoSubscriptionEvents:m?.extensions?.Video_SubscriptionEvents,screenSharingSubscriptionEvents:m?.extensions?.Sharing_SubscriptionEvents,videoSendMaxCapabilities:m?.extensions?.Video_send_MaxCapabilities,screenSharingSendMaxCapabilities:m?.extensions?.Sharing_send_MaxCapabilities,iceConnectedStateTime:m?.metrics?.IceConnectedStateTime,relayCandidate:m?.extensions?.RelayCandidate,videoRecvTimeToFirstFrame:m?.extensions?.Video_recv_TimeToFirstFrame,screenSharingRecvTimeToFirstFrame:m?.extensions?.Sharing_recv_TimeToFirstFrame,optimalVideoCount:g.tsCall.optimalVideoCount||1,currentNumberOfVideosRendered:g.activeRemoteVideoStreamViews?.size||0}}g.eventName===Ah.acs_calling_create_view_failure&&(C=this._createViewTelemetryHelper?.getCreateViewFailureStats()??{},v=this._createViewStats)}S.visibilityState=document.visibilityState;let _="",E={};m&&(_="string"==typeof m?.message?m?.message:"",E={...extractCommunicationServicesErrorForTelemetry(m)}),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:{viewId:g.viewId,correlationId:g.correlationId,timestampInfo:g.timestampInfo,...this._videoStream.getStreamMetadata(),failureReason:_,additionalProperties:S,additionalDetails:E,stats:v,createViewFailureDebugStats:C,videoStreamKind:this._videoStream.kind}})}catch(g){this.logger.debug("Unable to send telemtery")}}dispose(){if(this.disposed)throw new CallingCommunicationError({defaultError:D.VIEW.RENDERER_ALREADY_DISPOSED});this.disposed=!0,this.views.forEach(this._attemptToDisposeView),this.views.clear()}}__decorate$g([loggerProperty,__metadata$g("design:type",Object)],VideoStreamRenderer.prototype,"logger",void 0),__decorate$g([asyncOperation(Kh.CreateView),__metadata$g("design:type",Function),__metadata$g("design:paramtypes",[Object]),__metadata$g("design:returntype",Promise)],VideoStreamRenderer.prototype,"createView",null),__decorate$g([syncOperation(Kh.Dispose),__metadata$g("design:type",Function),__metadata$g("design:paramtypes",[]),__metadata$g("design:returntype",void 0)],VideoStreamRenderer.prototype,"dispose",null);var __decorate$h=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$h=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class RemoteParticipantImpl{get identifier(){return this._identifier}get endpointDetails(){return this._tsParticipant?.endpoints?.endpointDetails.map((g=>({participantId:g.participantId})))||[]}get state(){return this._state}get videoStreams(){return[...this._mappedStreams.values()]}get isMuted(){return this._isMuted}get isSpeaking(){return this._isSpeaking}get callEndReason(){return this._callEndReason}get displayName(){return this._displayName}get role(){return this._role}constructor(g,m,S,v,C){this._mappedStreams=new Map,this._state="Idle",this._lastTsParticipantState=0,this._isMuted=!1,this._isSpeaking=!1,this._displayName="",this._role="Unknown",this.acsToTsStreamType=g=>"Video"===g?0:"ScreenSharing"===g?1:void 0,this._identifier=g,this.logger=m.createChild((()=>`RemoteParticipant{${this._identifier.kind}}`)),this._telemetryLogManager=C,this._eventEmitter=new CallingEventEmitter(this.logger),this._callAgent=v,this._call=S,this.logger.log("created"),this._renderers={Video:{renderingState:{}},ScreenSharing:{renderingState:{}}}}on(g,m){if("stateChanged"!==g&&"isMutedChanged"!==g&&"isSpeakingChanged"!==g&&"displayNameChanged"!==g&&"roleChanged"!==g&&"videoStreamsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.REMOTE_PARTICIPANT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("stateChanged"!==g&&"isMutedChanged"!==g&&"isSpeakingChanged"!==g&&"displayNameChanged"!==g&&"roleChanged"!==g&&"videoStreamsUpdated"!==g)throw new CallingCommunicationError({defaultError:D.REMOTE_PARTICIPANT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}async mute(){if(!getAcsEcsConfig().calling.enableMuteOthers)throw new CallingCommunicationError({defaultError:D.REMOTE_PARTICIPANT.MUTE_PARTICIPANT_DISABLED});const g=this.logger.createFnLogger(Gh.Mute),m=+new Date,S=generateGuid();this.sendAudioEvent({eventName:Ah.acs_calling_mute_attempt,eventType:Mh.MuteSpecificParticipant,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"});try{g.info("remote mute specific");var v=[];void 0!==this._tsParticipant&&(v=v.concat(this._tsParticipant)),await this._call.tsCall.muteParticipants(1,v),g.info("remote mute specific success");const C=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_mute_success,eventType:Mh.MuteSpecificParticipant,timestampInfo:{deltaTimeInMs:C-m},correlationId:S,step:"mid-call"})}catch(v){const C=new CallingCommunicationError({defaultError:D.REMOTE_PARTICIPANT.MUTE_PARTICIPANT_FAILED,originalError:v});g.error(C.message);const _=+new Date;throw this.sendAudioEvent({eventName:Ah.acs_calling_mute_failure,eventType:Mh.MuteSpecificParticipant,timestampInfo:{deltaTimeInMs:_-m},correlationId:S,step:"mid-call"},C),C}}_dispose(){this.logger.log("dispose"),this._participantChangedHandler&&this._participantChangedHandler.dispose(),this._mappedStreams.forEach((g=>g.dispose())),this._eventEmitter.emit("stateChanged",this._state),this._eventEmitter.removeAllListeners(),this._disposeVideo(0),this._disposeVideo(1)}get tsRemoteParticipant(){return this._tsParticipant}get kind(){return"RemoteParticipant"}setCallEndReason(g){this._callEndReason=g}observeParticipant(g){this._tsParticipant||(this._tsParticipant=g,this._displayName=g.displayName,this._isMuted=g.isServerMuted,this._participantChangedHandler=this._tsParticipant.changed((()=>{if(this._tsParticipant&&this._tsParticipant.state!==this._lastTsParticipantState&&(this._lastTsParticipantState=this._tsParticipant.state,this._mapTsParticipantState(this._tsParticipant.state)),this._mapStreams(),this._tsParticipant&&this._tsParticipant.isServerMuted!==this._isMuted&&(this._isMuted=this._tsParticipant.isServerMuted,this._eventEmitter.emit("isMutedChanged")),this._tsParticipant&&this._tsParticipant.displayName!==this._displayName&&(this._displayName=g.displayName,this._eventEmitter.emit("displayNameChanged")),this._tsParticipant&&this._tsParticipant.advancedMeetingRole!==this._lastTsParticipantAdvancedRole&&(this._lastTsParticipantAdvancedRole=g.advancedMeetingRole,this._setParticipantRole(this._tsParticipant.advancedMeetingRole)),this._tsParticipant){const g=0!==this._tsParticipant.voiceLevel;g!==this._isSpeaking&&(this._isSpeaking=g,this._eventEmitter.emit("isSpeakingChanged"))}})),this._mapTsParticipantState(this._tsParticipant.state),this._mapStreams(),this._lastTsParticipantAdvancedRole=this._tsParticipant.advancedMeetingRole,this._setParticipantRole(this._tsParticipant.advancedMeetingRole))}setParticipantState(g){g!==this._state&&(this.logger.log(`state changed ${this._state}=>${this.state}`),this._state=g,"Disconnected"==this._state?this._dispose():this._eventEmitter.emit("stateChanged",this._state))}async stopRenderingVideo(){this._disposeVideo(0)}async renderVideo(g,m){if("function"==typeof g)return this._updateRenderingState(g,"Video",m);return await this._renderStreamForParticipant(g,0,m)}async _updateRenderingState(g,m,S){if("function"==typeof g){let v;const C="Video"===m?0:1;this._tsParticipant&&(v=S?.stream?S.stream:new RemoteVideoStreamImpl(this._tsParticipant.streams[C][0],this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier),v.on("isReceivingChanged",(()=>{this._renderers[m].renderingState.isFrozen=!v.isReceiving,g(this._renderers[m].renderingState)})),v.on("isAvailableChanged",(async()=>{this._renderers[m].renderingState.isStreaming!==v?.isAvailable&&(this._renderers[m].renderingState.isStreaming=v.isAvailable,this._renderers[m].renderingState.isStreaming&&!this._renderers[m].renderer&&(this._renderers[m].renderer=this._renderers[m]?.renderer?this._renderers[m].renderer:new VideoStreamRenderer(v),this._renderers[m].view||(this._renderers[m].view=await(this._renderers[m].renderer?.createView(S?.viewOptions))),this._renderers[m].renderingState.videoTarget=this._renderers[m].view?.target)),g(this._renderers[m].renderingState)})))}}async renderScreenShare(g,m){if("function"==typeof g)return this._updateRenderingState(g,"ScreenSharing",m);return this._renderStreamForParticipant(g,1,m)}async _renderStreamForParticipant(g,m,S){if(this._tsParticipant){const v=0===m?"Video":"ScreenSharing",C=S?.stream?S.stream:new RemoteVideoStreamImpl(this._tsParticipant.streams[m][0],this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier);return C.isAvailable&&(this._renderers[v].view=await this._appendVideo(g,m,C,S?.viewOptions)),C.on("isAvailableChanged",(async()=>{C.isAvailable?this._renderers[v].view=await this._appendVideo(g,m,C,S?.viewOptions):this._renderers[v]?.view&&this._renderers[v].view?.target&&this._renderers[v].view?.target.parentNode?.removeChild(this._renderers[v].view?.target)})),Promise.resolve({stream:C,view:this._renderers[v]?.view})}return Promise.reject()}async _appendVideo(g,m,S,v){try{const C=0===m?"Video":"ScreenSharing";if(0===m&&(this._renderers[C]?.renderer||(this._renderers[C].renderer=this._renderers[C]?.renderer?this._renderers[C].renderer:new VideoStreamRenderer(S),this._renderers[C].view=await(this._renderers[C].renderer?.createView(v))),this._renderers[C].view))return g.appendChild(this._renderers[C].view?.target||document.createElement("emptyNode")),Promise.resolve(this._renderers[C].view)}catch(g){return Promise.reject(g)}return Promise.reject()}async _disposeVideo(g){const m=0===g?"Video":"ScreenSharing";this._renderers[m].view?.dispose(),this._renderers[m].renderer?.dispose(),this._renderers[m]={renderingState:{}}}_setParticipantRole(g){let m=advancedMeetingRoleToParticipantRole(getAcsEcsConfig(),g);"Unknown"===m?this.logger.log(`tsParticipant advancedMeetingRole=${g} had no mapping`):this.logger.log(`mapped tsParticipant advancedMeetingRole=${g}=>${m}`),this._role!=m&&(this.logger.log(`role changed ${this._role}=>${g}`),this._role=m,this._eventEmitter.emit("roleChanged"))}_mapTsParticipantState(g){let m;const S={0:"Idle",1:"Connecting",2:"Ringing",3:"Connected",4:"Disconnected",5:"Hold",7:"InLobby",6:"EarlyMedia"};S[g]?(m=S[g],this.logger.log(`mapped tsParticipant ${g}=>${this._state}`),this.setParticipantState(m)):this.logger.log(`unable to map tsCall state=${g} to call state`)}_mapStreams(){const g=[],m=[],handleNewStream=g=>{this._mappedStreams.set(g.id,g)},handleRemovedStream=g=>{const m=this._mappedStreams.get(g.id);m&&(this.logger.log(`stream removed, type==${m.mediaStreamType} id=${g.id}`),this._mappedStreams.delete(g.id),m.dispose())},mapStreamsOfType=S=>{if(this._tsParticipant)if(this._tsParticipant.streams&&isNonEmptyArray(this._tsParticipant.streams[S])){let v=[];this._tsParticipant&&(v=this._tsParticipant.streams[S]),v.forEach((m=>{if(!this._mappedStreams.get(m.id)){const S=new RemoteVideoStreamImpl(m,this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier);this.logger.log(`stream created, type==${S.mediaStreamType} id=${m.id}`),g.push(S)}})),this._mappedStreams.forEach((g=>{if(this.acsToTsStreamType(g.mediaStreamType)===S){v.some((m=>m.id===g.id))||m.push(g)}}))}else this._mappedStreams.forEach((g=>{this.acsToTsStreamType(g.mediaStreamType)===S&&m.push(g)}))};mapStreamsOfType(0),mapStreamsOfType(1),(g.length>0||m.length>0)&&(g.forEach(handleNewStream),m.forEach(handleRemovedStream),this._eventEmitter.emit("videoStreamsUpdated",{added:g,removed:m}))}sendAudioEvent(g,m){try{let S,v;m&&(S=m.message,v=extractCommunicationServicesErrorForTelemetry(m));const C={callId:this._call.id,timestampInfo:g.timestampInfo,correlationId:g.correlationId,step:g.step||"",failureReason:S||"",additionalDetails:{...v}};void 0!==g.eventType&&(C.eventType=g.eventType),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:C})}catch(g){this.logger.debug("Unable to send mute others audio telemetry")}}}__decorate$h([loggerProperty,__metadata$h("design:type",Object)],RemoteParticipantImpl.prototype,"logger",void 0),__decorate$h([asyncOperation(Gh.Mute),__metadata$h("design:type",Function),__metadata$h("design:paramtypes",[]),__metadata$h("design:returntype",Promise)],RemoteParticipantImpl.prototype,"mute",null);class SelectedDeviceManager{constructor(g){this._deviceManager=g,this._eventEmitter=new Su.EventEmitter,this._selectedDeviceListeners=new Map,this._selectedDevices=new Map,this._deviceInfoMapper=this._deviceManager.deviceInfoMapper;const createSelectedDeviceListener=g=>()=>{const m=this._selectedDevices.get(g),S=(()=>"Speaker"===g?this._deviceManager.selectedSpeaker:"Microphone"===g?this._deviceManager.selectedMicrophone:void 0)(),v=void 0===S?void 0:{id:this._deviceInfoMapper.getDeviceId(S.id),name:this._deviceInfoMapper.scrubDeviceLabel(S.name)};this._selectedDevices.set(g,v),this._eventEmitter.emit("selectedDeviceChanged",{selectedDeviceType:g,oldDevice:m,newDevice:v})},m=createSelectedDeviceListener("Speaker");this._selectedDeviceListeners.set("Speaker",m),this._deviceManager.on("selectedSpeakerChanged",m),m();const S=createSelectedDeviceListener("Microphone");this._selectedDeviceListeners.set("Microphone",S),this._deviceManager.on("selectedMicrophoneChanged",S),S()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}selectedDevice(g){return this._selectedDevices.get(g)}dispose(){const g=this._selectedDeviceListeners.get("Speaker");g&&this._deviceManager.off("selectedSpeakerChanged",g);const m=this._selectedDeviceListeners.get("Microphone");m&&this._deviceManager.off("selectedMicrophoneChanged",m),this._eventEmitter.removeAllListeners()}}function getCallProgressCommonPayload(m,S,v,C){const _=C===Wo.RoomCall||m.kind===g.CallKind.Call&&"Incoming"==m.direction&&!m.tsCall.groupId&&!!m.tsCall.meetingData?.meetingCode&&!m.tsCall.threadId,E=!_&&C===Wo.TeamsMeetingLink||C===Wo.TeamsMeetingId||C===Wo.TeamsCoordinates||"Incoming"==m.direction&&!m.tsCall.groupId&&!!m.tsCall.meetingData&&!!m.tsCall.threadId;return{timestampInfo:{attemptTimestamp:+new Date},correlationId:v,localParticipantId:m.tsCall.participantId||"",callId:m.tsCall.callId||"",callType:m.tsCall.callType||"",callDirection:m.direction,state:"Ringing"===m.state?"Ringing":Ru[m.tsCall.state],groupJoin:!!m.tsCall.groupId,roomJoin:_,meetingJoin:E,callEndDiagnosticsInfo:m.tsCall.callEndDiagnosticsInfo||{},isSupportedEnvironment:S?.runningEnvironmentInfo?.isSupportedEnvironment,diagnosticInfo:{...m.tsCall.callEndDiagnosticsInfo,telemetryPayloadBytesOriginal:TelemetryLogManager.telemetryPayloadBytesOriginal,telemetryPayloadBytesCompressed:TelemetryLogManager.telemetryPayloadBytesCompressed}}}function sendCallProgressEvent(g,m,S){try{"state-changed"===S.step&&"Connecting"===S.newState&&(TelemetryLogManager.telemetryPayloadBytesOriginal=0,TelemetryLogManager.telemetryPayloadBytesCompressed=0),g.sendEvent({name:Ah.acs_calling_call_progress,tenant:Qa,properties:S})}catch(g){m.error(`Failed to send event: ${Ah.acs_calling_call_progress} step: ${S.step}`)}}var Em,__decorate$i=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$i=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallCommonImpl{get id(){return this._id}get callerInfo(){return{identifier:this._callerIdentity,displayName:this._callerDisplayName}}get state(){return this._state}get role(){return this._role}get callEndReason(){return this._callEndReason}get kind(){return this._kind}get direction(){return this._direction}get isMuted(){return this._isMuted}get isScreenSharingOn(){return this._isScreenSharingOn}get isLocalVideoStarted(){return this._isLocalVideoStarted}get localVideoStreams(){return this._localVideoStreams}get localAudioStreams(){return this._localAudioStreams}get isIncomingAudioMuted(){return this._isIncomingAudioMuted}get remoteParticipants(){return this._remoteParticipants}get totalParticipantCount(){return this._totalParticipantCount}get lobby(){return this._lobby}subscribeToGetRemoteAudioStream(){if(!this._rawAudioStreamChangedSubscription)try{let g=this.tsCall.getIncomingRawAudioStream(),populateRemoteAudioStreamCollection=async()=>{try{if(0===this._remoteAudioStreams.length){if(void 0===await g.getMediaStream())throw new CallingCommunicationError({defaultError:D.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_UNDEFINED});this._remoteAudioStreams.push(new RemoteAudioStreamImpl(g,this._telemetryLogManager,this.id,this.tsCall.participantId)),this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:this._remoteAudioStreams,removed:[]})}else if(void 0===await g.getMediaStream()){const g=this._remoteAudioStreams[0];g.dispose(),this._remoteAudioStreams=[],this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:[],removed:[g]})}}catch(g){throw new CallingCommunicationError({defaultError:D.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_RETURNED_ERROR,originalError:g})}};this._rawAudioStreamChangedSubscription=g.changed((()=>{this.logger.info(`Changed fired ${this.tsCall.state}, ${this.state}`),populateRemoteAudioStreamCollection().catch(noop)})),populateRemoteAudioStreamCollection().catch((()=>{this.logger.info("Failed to update remote audio stream collection, retrying on changed")}))}catch(g){this.logger.info("Failed to get raw audio stream from the stack")}}get remoteAudioStreams(){if(!getAcsEcsConfig().calling.allowAccessRawMediaStream)throw new CallingCommunicationError({defaultError:D.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_DISABLED});return this._remoteAudioStreams}get deviceManager(){return this._callAgent.deviceManager}get mediaConstraintsManager(){return this._mediaConstraintsManager}get isHandlingLargeMeetingVideoRendering(){return this._isHandlingLargeMeetingVideoRendering}get networkQualityUfdEventDetails(){return this._networkQualityUfdEventDetails}get acsProxy(){return this._callAgent.acsProxy}get acsCustomRelayManager(){return this._callAgent.acsCustomRelayManager}constructor(g,m,S,v,C){this._callAgent=m,this._isMuted=!1,this._isMuted_correlationIdCache=generateGuid(),this._isIncomingAudioMuted=!1,this._isIncomingAudioMuted_correlationIdCache=generateGuid(),this._isScreenSharingOn=!1,this._isLocalVideoStarted=!1,this._localVideoStreams=[],this._localAudioStreams=[],this._remoteAudioStreams=[],this._totalParticipantCount=1,this._isDeviceNotFunctioningMuted=!1,this.__attemptedToRecoverMicNotFunctioningBySDK=!1,this._isMicrophoneMuted=!1,this._disposed=!1,this._lastTsCallState=0,this._isSpeakerMuted=!1,this._callMode=0,this._role=Oo,this._lastTsCallMeetingDetails={},this._isHandlingLargeMeetingVideoRendering=!1,this._joinContextDescription=Wo.Unknown,this._remoteParticipantsChangedListeners=[],this._localRingingStateSet=!1,this._networkQualityUfdEventDetails=[],this._mriToRemoteParticipantMap=new Map,this._remoteParticipants=[],this._state="None",this.localVideoStream=void 0,this.localScreenSharingStream=void 0,this._handleCallingApplicationIdentifier=g=>{this._isClosedCaptionsBot(g)&&this.logger.info("Handle participant: Ignore closed captions application")},this._handleMuteChanges=()=>{const g=new CallInfoImpl(this.tsCall,{config:this._config}),m=this.tsCall.conversationType||g.context===ru.RoomJoin?!!(this.tsCall.isMuted||10!==this.tsCall.state&&this.tsCall.isServerMuted||this._isDeviceNotFunctioningMuted):!(!this.tsCall.isMuted&&!this._isDeviceNotFunctioningMuted);if(this._isMuted!=m){this.logger.info(`isMuted changed from ${this._isMuted} to ${m}`);let g=[];this.tsCall.isMuted&&g.push("isMicrophoneMuted"),this.tsCall.isServerMuted&&g.push("isServerMuted"),this._isDeviceNotFunctioningMuted&&g.push("isDeviceNotFunctioningMuted");let S="";g.length>=1&&(S=g.join(", ")),m&&(this._isMuted_correlationIdCache=generateGuid()),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,this._isMuted_correlationIdCache,this._joinContextDescription),step:"isMuted-changed",oldIsMuted:this._isMuted,newIsMuted:m,reason:S}),this._isMuted=m,this._eventEmitter.emit("isMutedChanged")}},this._handleIncomingAudioMuteChanges=()=>{const g=this._isSpeakerMuted;this._isIncomingAudioMuted!=g&&(this.logger.info(`newIncomingAudioMuted changed from ${this._isIncomingAudioMuted} to ${g}`),g&&(this._isIncomingAudioMuted_correlationIdCache=generateGuid()),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,this._isIncomingAudioMuted_correlationIdCache,this._joinContextDescription),step:"isIncomingAudioMuted-changed",oldIsMuted:this._isIncomingAudioMuted,newIsMuted:g,reason:""}),this._isIncomingAudioMuted=g,this._eventEmitter.emit("isIncomingAudioMutedChanged"))},this._isClosedCaptionsBot=g=>"28:b1902c3e-b9f7-4650-9b23-5772bd429747"===g.id,this.getTotalNotBotParticipantCount=()=>{let g=1;if(this.tsCall.participantCounts&&this.tsCall.participantCounts.totalParticipants>0&&(g=this.tsCall.participantCounts.totalParticipants),this.tsCall.participants){g-=this.tsCall.participants.filter((g=>this.isHiddenBot(g))).length}return g},this._id=g.callId,this.tsCall=S,this._direction=g.isIncoming?"Incoming":"Outgoing",this._config=g,this.logger=this._callAgent.logger.createChild((()=>`Call:${this._id}:${this._state}`)),this._telemetryLogManager=v,this.stats=new CallStats(this.logger,this._telemetryLogManager),this._eventEmitter=new CallingEventEmitter(this.logger),this.activeRemoteVideoStreamViews=new Map,this._mediaMetricsDeviceEvents={},this._kind=C,this._optimalVideoCount=1,this._ufdsCorrelationIdCache=initializeUfdsCorrelationIdCache();const _=new CallInfoImpl(this.tsCall,{config:this._config});this._capabilityResolver=new CapabilityResolverImpl(this._eventEmitter,this.logger,this,_,m,S),getAcsEcsConfig().calling.mediaMetricsDeviceEventsEnabled&&(this._dmDevicesChangedSub=this._callAgent.tsStack?.getDeviceManager().on("devicesChanged",(()=>{this.setOrUpdateMediaMetricsDeviceEvents()}))),this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{call:this,callAgent:this._callAgent,callInfo:new CallInfoImpl(this.tsCall,{config:this._config})},{tsCall:this.tsCall,callAgent:this._callAgent,call:this,telemetryLogManager:this._telemetryLogManager}),this._lobby=new LobbyImpl(this.tsCall,this,this.logger,this._telemetryLogManager);const E=getRegisteredFeatures(Cu.CallFeature);for(const g of E)"OnExtendedObjectConstructor"===g.activationOptions.activationEvent&&this.feature(g);this._mmrRdpConnectionManager=new MmrRdpConnectionManager(this.logger),getAcsEcsConfig().telemetry.sendNetworkChangedTelemetry&&this._sendNetworkChangedTelemetry(),getAcsEcsConfig().telemetry.deviceChangedEvents.enabled&&(this._selectedDeviceManager=new SelectedDeviceManager(this.deviceManager),this._setupSelectedDeviceChangedTelemetry()),this._mediaConstraintsManager=new MediaConstraintsManager(this.tsCall,this.logger,this._telemetryLogManager)}async accept(g={}){const m=g.audioOptions?.muted??!1,S=this.getLocalVideoStreamFromCallOptions(g),v=this.getLocalAudioStreamFromCallOptions(g),C=+new Date,_=generateGuid(),E=this._callAgent.getEcsConfigIds();let T={joinContextDescription:"",additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),muted:m,withVideo:!!S,...getMMRInfo(),AcsCallingSDKWeb_ecsConfigId:E.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:E.SkypeWebMedia},additionalDetails:{}};const handleError=(g,m)=>{const E=+new Date;let I,b={...T};if(m){const{callEndReason:m,callingCommunicationError:S}=getCallEndReason(g,this);b.additionalDetails.callEndReason=m,I=S}else I=new CallingCommunicationError({defaultError:D.CALL.ACCEPT_INCOMING_CALL,originalError:g}),b.additionalDetails.communicationServicesError=extractCommunicationServicesErrorForTelemetry(I).communicationServicesError;return this.sendCallStageEvent({eventName:Ah.acs_calling_call_accept_failed,correlationId:_,timestampInfo:{deltaTimeInMs:E-C},additionalPayload:b},I),S&&(this.sendVideoEvent({correlationId:_,eventName:Ah.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:E-C},localVideoStream:S,step:"accept",isScreenSharingOnFlag:this._isScreenSharingOn},I),this.removeLocalVideoStream(S)),v&&this.removeLocalAudioStream(v),I};try{if(g?.videoOptions?.constraints){let m=this._mediaConstraintsManager.getTelemetryPayload({video:g?.videoOptions?.constraints});T.additionalProperties.constraints=m}this.sendCallStageEvent({eventName:Ah.acs_calling_call_accept_attempt,correlationId:_,timestampInfo:{attemptTimestamp:C},additionalPayload:T});let E={...T};if(S&&this.setLocalVideoStream(S),this.setLocalAudioStream(v),S&&this.sendVideoEvent({eventName:Ah.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:C},correlationId:_,step:"accept",isScreenSharingOnFlag:this._isScreenSharingOn}),1!==this.tsCall.state)throw new CallingCommunicationError({defaultError:D.CALL.ACCEPT_NOT_RINGING});try{if(g?.videoOptions?.constraints){const m=await this._mediaConstraintsManager.setVideoConstraints(g?.videoOptions?.constraints,"accept",_,C),S=this._mediaConstraintsManager.getTelemetryPayload({video:m});E.additionalProperties.constraints=S}}catch(g){const m=new CallingCommunicationError({defaultError:D.CALL.ACCEPT_VIDEO_CONSTRAINTS,originalError:g});this.logger.error(`${m.message}`)}const I={withVideo:!!S,receiveOnlyAudioOnCallStart:!!v,muted:m};return m&&(I.muteFlags=1),getAcsEcsConfig()?.calling?.enableCustomTurnUsage&&this.acsCustomRelayManager?.customRelayManagerInUse&&(I.mediaConfiguration={connectionType:"NoDirectConnection"}),"RawMedia"===S?.mediaStreamType&&await this._setRawStream(S,1),this.tsCall.accept(I).then((async()=>{const g=+new Date;S&&this.shallRemoveLvsAfterConnectedSuccessfully(S,"accept",_,g,C),v&&(this.startAudioInternal(v,!0).catch((g=>{})),this.shallRemoveLasAfterConnectedSuccessfully(v,"accept",_,g,C)),this.sendCallStageEvent({eventName:Ah.acs_calling_call_accept_connected,correlationId:_,timestampInfo:{deltaTimeInMs:g-C},additionalPayload:E})})).catch((g=>{handleError(g,!0)})),this}catch(g){throw handleError(g,!1)}}async reject(){const g=+new Date,m=generateGuid();this.sendCallStageEvent({eventName:Ah.acs_calling_call_reject_attempt,correlationId:m,timestampInfo:{attemptTimestamp:g}});const S=this._callAgent.getEcsConfigIds(),v={additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:S.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:S.SkypeWebMedia},additionalDetails:{}};if(1!==this.tsCall.state){const S=new CallingCommunicationError({defaultError:D.CALL.REJECT_NOT_RINGING});v.additionalDetails.communicationServicesError=extractCommunicationServicesErrorForTelemetry(S).communicationServicesError;const C=+new Date;throw this.sendCallStageEvent({eventName:Ah.acs_calling_call_reject_failed,correlationId:m,timestampInfo:{deltaTimeInMs:C-g},additionalPayload:v},S),S}return this.tsCall.reject().then((()=>{const S=+new Date;this.sendCallStageEvent({eventName:Ah.acs_calling_call_reject_success,correlationId:m,timestampInfo:{deltaTimeInMs:S-g}})})).catch((S=>{const C=+new Date,{callEndReason:_,callingCommunicationError:E}=getCallEndReason(this,S);throw v.additionalDetails.callEndReason=_,this.sendCallStageEvent({eventName:Ah.acs_calling_call_reject_failed,correlationId:m,timestampInfo:{deltaTimeInMs:C-g},additionalPayload:v},E),E}))}dispose(){this._disposed||(this._dmDevicesChangedSub&&this._dmDevicesChangedSub.dispose(),this._dmDevicesChangedSub=void 0,this._extensibleApi.dispose(),this._eventEmitter.removeAllListeners(),this._onlineListener&&window.removeEventListener("online",this._onlineListener),this._offlineListener&&window.removeEventListener("offline",this._offlineListener),this._trouterStateChangedListener&&this._callAgent.offTrouterStateChanged(this._trouterStateChangedListener),this._mmrRdpConnectionManager.dispose(),this._selectedDeviceManager?.dispose(),this._disposed=!0)}async startAudioInternal(g,m=!1){const S=generateGuid(),v=+new Date;let C;this.sendRawMediaEvent({eventName:Ah.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Rh.attempt,isInternal:m,timestampInfo:"",additionalDetails:""});try{C=await g.getMediaStream()}catch(g){const C=new CallingCommunicationError({defaultError:D.CALL.LOCAL_AUDIO_GET_MEDIA_STREAM,originalError:g});this.logger.error(`Failed to get raw stream with error: ${g}`);const _=+new Date;throw this.sendRawMediaEvent({eventName:Ah.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,isInternal:m,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:_-v},additionalDetails:{failureReason:C.message||"",code:C.code,subCode:C.subCode,...extractCommunicationServicesErrorForTelemetry(C)}}),C}const _=this._callAgent.tsStack?.getDeviceManager();if(!getAcsEcsConfig()?.calling?.allowAccessRawMediaStream||!_?.setRawMediaStream){const g=new CallingCommunicationError({defaultError:D.CALL.LOCAL_AUDIO_SET_MEDIA_STREAM});this.logger.error("Failed to set raw input audio stream");const C=+new Date;throw this.sendRawMediaEvent({eventName:Ah.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,isInternal:m,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:C-v},additionalDetails:{failureReason:g.message||"",code:g.code,subCode:g.subCode,...extractCommunicationServicesErrorForTelemetry(g)}}),g}const E=new MediaStream(C);_?.setRawMediaStream(E,0),this.removeLocalAudioStream(this.localAudioStreams[0]),this.setLocalAudioStream(g);const T=+new Date;this.sendRawMediaEvent({eventName:Ah.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Rh.success,isInternal:m,localAudioStream:this.localAudioStreams[0],timestampInfo:{deltaTimeInMs:T-v},additionalDetails:""})}stopAudioInternal(g=!1){const m=generateGuid(),S=+new Date;this.sendRawMediaEvent({eventName:Ah.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,kindOfEvent:Rh.attempt,isInternal:g,timestampInfo:"",additionalDetails:""});const v=this._callAgent.tsStack?.getDeviceManager();if(!getAcsEcsConfig()?.calling?.allowAccessRawMediaStream||!v?.unsetRawMediaStream){const v=new CallingCommunicationError({defaultError:D.CALL.LOCAL_AUDIO_UNSET_MEDIA_STREAM});this.logger.error("Failed to unset raw input audio stream");const C=+new Date;throw this.sendRawMediaEvent({eventName:Ah.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,isInternal:g,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:C-S},additionalDetails:{failureReason:v.message||"",code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)}}),v}v.unsetRawMediaStream(0),this.removeLocalAudioStream(this.localAudioStreams[0]);const C=+new Date;this.sendRawMediaEvent({eventName:Ah.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,kindOfEvent:Rh.success,isInternal:g,localAudioStream:this.localAudioStreams[0],timestampInfo:{deltaTimeInMs:C-S},additionalDetails:""})}bindTsCall(){void 0!==this.tsCall.callerMri&&(this._callerIdentity=constructIdentifierKindFromMri(this.tsCall.callerMri),this._callerDisplayName=this.tsCall.participants.find((g=>g.id===this.tsCall.callerMri))?.displayName),this._lastTsCallState=this.tsCall.state,this.mapTsCallState(this.tsCall.state),this._setCallRole(this.tsCall.advancedMeetingRole),this.updateCallMode(),this.tsCall.changed((()=>{this.tsCall.callId!==this._id&&(this.logger.log(`tsCall callId changed from ${this._id} to ${this.tsCall.callId}`),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"id-changed",oldCallId:this._id,newCallId:this.tsCall.callId}),this._id=this.tsCall.callId,this._eventEmitter.emit("idChanged")),this.tsCall.state!==this._lastTsCallState&&(this.logger.log(`tsCall state changed=${this.tsCall.state}`),this._lastTsCallState=this.tsCall.state,this.mapTsCallState(this.tsCall.state),this._handleMuteChanges()),this._isScreenSharingOn!==this.tsCall.isScreenSharingOn&&(this.logger.log(`tsCall isScreenSharingOn changed=${this.tsCall.isScreenSharingOn}`),this._isScreenSharingOn=this.tsCall.isScreenSharingOn,this._isScreenSharingOn||this.removeScreenSharingStream(),this._eventEmitter.emit("isScreenSharingOnChanged")),this._isMicrophoneMuted!==this.tsCall.isMuted&&(this.logger.log(`tsCall isMuted changed=${this.tsCall.isMuted}`),this._isMicrophoneMuted=this.tsCall.isMuted,this._handleMuteChanges()),this._isSpeakerMuted!==this.tsCall.isSpeakerMuted&&(this.logger.log(`tsCall _isSpeakerMuted changed=${this.tsCall.isSpeakerMuted}`),this._isSpeakerMuted=this.tsCall.isSpeakerMuted,this._handleIncomingAudioMuteChanges()),this.tsCall.advancedMeetingRole!==this._lastTsCallAdvancedMeetingRole&&(this.logger.log(`tsCall advancedMeetingRole changed=${this.tsCall.advancedMeetingRole}`),this._setCallRole(this.tsCall.advancedMeetingRole)),(this.tsCall.meetingData?.meetingUrl||this.tsCall.meetingData?.passcode||this.tsCall.threadId)&&this.tsCall.meetingDetails&&hasMeetingDetailsChanged(this.tsCall.meetingDetails,this._lastTsCallMeetingDetails)&&this._setMeetingCapabilities(this.tsCall.meetingDetails),this.updateCallMode(),this.optimalVideoCountChanged()})),this.tsCall.on("serverMutedChanged",(()=>{this.logger.log(`tsCall isServerMuted changed=${this.tsCall.isServerMuted}`),this._handleMuteChanges()})),this._totalParticipantCount=this.getTotalNotBotParticipantCount(),this.tsCall.on("participantCountsUpdated",(()=>{const g=this.getTotalNotBotParticipantCount();if(this._totalParticipantCount!==g){const m=this._totalParticipantCount;this._totalParticipantCount=g,this.logger.log(`tsCall totalParticipantCount changed from ${m} to ${this._totalParticipantCount}`),getAcsEcsConfig().rendering.remoteVideo.largeMeeting.handleVideoRendering&&this._enableOrDisable_largeMeeting_videoRendering(),this._eventEmitter.emit("totalParticipantCountChanged");try{this.stats.recordEvent({name:bh.number_of_participants,callId:this.id,localParticipantId:this.tsCall.participantId,data:{totalParticipantCount:this._totalParticipantCount,participantCounts:this.tsCall.participantCounts||{},previousParticipantCount:m}})}catch(g){this.logger.error("failed to send participant count change telemetry")}}})),this.tsCall.on("callQualityChanged",(async g=>{try{let m;5===g.type||32===g.type||2===g.type||1===g.type||37===g.type?(m=bh.network_quality,this._trackNetworkQualityUfdEventDetails(g.type)):m=44===g.type||43===g.type||9===g.type||25===g.type||27===g.type||45===g.type||33===g.type||34===g.type||55===g.type||26===g.type||47===g.type?bh.video_device_issue:bh.other_diagnostic,3===g.value||2===g.value?(this.logger.warn(`Ufd error raised!, ufd=${g.type}, value=${g.value}, kind=${m}`),m===bh.network_quality&&window.dispatchEvent(new CustomEvent("online",{detail:!1}))):(this.logger.warn(`Ufd error recovered!, ufd=${g.type}, value=${g.value}, kind=${m}`),m===bh.network_quality&&window.dispatchEvent(new CustomEvent("online",{detail:!0})));let S="";const v=this._ufdsCorrelationIdCache[g.type][g.mediaType];3==g.value||2==g.value?v?S=v:(S=generateGuid(),this._ufdsCorrelationIdCache[g.type][g.mediaType]=S):(v&&(S=v),this._ufdsCorrelationIdCache[g.type][g.mediaType]=void 0);const C={type:g.type.toString(),level:g.value,mediaType:g.mediaType,correlationId:S};if(this.stats.recordEvent({name:m,callId:this.id,localParticipantId:this.tsCall.participantId,data:C}),this.shallStopVideo(g)){const m=+new Date,S=generateGuid();this.logger.warn(`Attempting to stop video gracefully due to video ufd being raised.UFD: ${g.type}, value: ${g.value}, call direction: ${this._direction}`),this.sendAudioEvent({eventName:Ah.acs_calling_stop_video_on_ufd_attempt,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"});try{this.localVideoStream&&this.stopVideo(this.localVideoStream)}catch(m){const S=`Failed to stop video on video device start failed or capture mute event ${g.type} with value ${g.value}`;this.logger.error(S)}}if(this.shallRemoveLocalVideoStreamOnBadUfd(g)){this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream);const m=new CallingCommunicationError({defaultError:D.CALL.REMOVE_LOCAL_VIDEO_ON_BAD_UFD,defaultErrorMessageArgs:[g.type,g.value,this._direction]});this.logger.error(m.message)}if(this.shallStopAudio(g)){const m=+new Date,S=generateGuid();if(getAcsEcsConfig()?.calling?.allowMuteOnBadUfd&&!this.tsCall.isMuted){this.sendAudioEvent({eventName:Ah.acs_calling_mute_on_ufd_attempt,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"});try{await this.mute()}catch(m){const S=`Failed to mute on microphone device not functioning or capture mute event ${g.type} with value ${g.value}`;this.logger.error(S)}}const v=getAcsEcsConfig()?.calling?.preventStopAudio;if(v)return this.sendAudioEvent({eventName:Ah.acs_calling_prevent_stop_audio,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"}),void(!getAcsEcsConfig()?.calling?.preventFakeMute&&this.markCallMuted());this.sendAudioEvent({eventName:Ah.acs_calling_stop_audio_attempt,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"});try{await this.tsCall.stopAudio(),this.markCallMuted();const g=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_stop_audio_success,timestampInfo:{deltaTimeInMs:g-m},correlationId:S,step:"mid-call"})}catch(v){const C=new CallingCommunicationError({defaultError:D.CALL.STOP_AUDIO_ON_BAD_UFD,defaultErrorMessageArgs:[g.type,g.value],originalError:v});this.logger.error(C.message);const _=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_stop_audio_failure,timestampInfo:{deltaTimeInMs:_-m},correlationId:S,step:"mid-call"},C)}}this.muteUnmuteOnMicrophoneNotFunctioningUfd(g),this.audioDidAutoRecover(g)&&(this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges())}catch(g){this.logger.error("Failed to send ufd telemetry")}})),this.tsCall.on("participantAdded",(async g=>{this.logger.debug("tsCall participant added");const m=[];g.endpoints?.endpointDetails.forEach((g=>m.push(g.participantId))),0===m.length&&m.push("remoteParticipantId unavailable");const S=constructIdentifierKindFromMri(g.id);if(this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:m,participantAddedOrRemoved:"added",kindOfEvent:Rh.event}),this.isHiddenBot(g))return this.logger.info("Add participant: Handle hidden calling application"),void this._handleCallingApplicationIdentifier(g);this._handleLocalRingingCallState(g);try{const m=this.getOrCreateRemoteParticipant(S,g);this._eventEmitter.emit("remoteParticipantsUpdated",{added:[m],removed:[]})}catch(g){this.logger.log("unable to map call participant to ACS user")}})),this.logger.debug(`tsCall current participant count=${this.tsCall?.participants?.length}`),this.tsCall.participants.forEach((g=>{const m=constructIdentifierKindFromMri(g.id);this.getOrCreateRemoteParticipant(m,g),this._handleLocalRingingCallState(g)}));try{const g=[];this.tsCall.participants.forEach((m=>{m.endpoints?.endpointDetails.forEach((m=>g.push(m.participantId)))})),this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:g,participantAddedOrRemoved:"added",kindOfEvent:Rh.initialize})}catch(g){this.logger.info("Remove participant: Ignore calling application")}this.tsCall.on("participantRemoved",(async g=>{this.logger.debug("tsCall participant removed");const m=[];if(g.endpoints?.endpointDetails.forEach((g=>m.push(g.participantId))),0===m.length&&m.push("remoteParticipantId unavailable"),this.isHiddenBot(g))return this.logger.info("Remove participant: Ignore calling application"),void this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:m,participantAddedOrRemoved:"removed",kindOfEvent:Rh.event});const S=g.id;if(S){const v=this._remoteParticipants.find((g=>getMriFromIdentifier(g.identifier)===S));if(v){const{callEndReason:S}=getRemoteParticipantCallEndReason(this,g);v.setCallEndReason(S),this.deleteRemoteParticipant(v),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[v]}),this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:m,participantAddedOrRemoved:"removed",kindOfEvent:Rh.event,additionalDetails:{...extractCallEndReasonForTelemetry(S)}})}else this.logger.log("unable to find participant to remove")}}))}_trackNetworkQualityUfdEventDetails(g){const m=+new Date;let S="";switch(g){case 5:S=ku;break;case 32:S=xu;break;case 2:S=Lu;break;case 1:S=Fu;break;case 37:S=Uu}this._networkQualityUfdEventDetails.push({eventName:S,timestampInfo:m})}async muteUnmuteOnMicrophoneNotFunctioningUfd(g){try{const m=getAcsEcsConfig().calling;if(!m.muteUnmuteOnMicrophoneNotFunctioning||this._isMuted||9!==g.type||3!==g.value)return;this.__attemptedToRecoverMicNotFunctioningBySDK=!0,await this.mute(),m.unmuteDelayForMicrophoneNotFunctioningInMs>=0&&await sleep(m.unmuteDelayForMicrophoneNotFunctioningInMs),await this.unmute()}catch(g){this.logger.info("Unable to perform mute and unmute to recover microphoneNotFunctioning",g)}finally{this.__attemptedToRecoverMicNotFunctioningBySDK=!1}}updateCallMode(){this.tsCall.callMode&&this._callMode!==this.tsCall.callMode&&(this.logger.log(`tsCall callMode changed from ${this._callMode} to ${this.tsCall.callMode}`),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"callMode-changed",oldState:Pu[this._callMode],newState:Pu[this.tsCall.callMode]}),this._callMode=this.tsCall.callMode)}async startCallInternal(g,m,S,v){const C=!!g?.audioOptions?.muted,_=this.getLocalVideoStreamFromCallOptions(g),E=this.getLocalAudioStreamFromCallOptions(g);let T;const I=+new Date,b=generateGuid();this._joinContextDescription=getJoinContextDescription(S);const A=this._callAgent.getEcsConfigIds(),R={joinContextDescription:this._joinContextDescription,additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,IsEmergencyCall:v?.isEmergency||!1,trouterState:this._callAgent.getTrouterState(),muted:C,withVideo:!!_,...getMMRInfo(),AcsCallingSDKWeb_ecsConfigId:A.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:A.SkypeWebMedia},additionalDetails:{}};g?.videoOptions?.constraints&&(R.additionalProperties.constraints=this._mediaConstraintsManager.getTelemetryPayload({video:g?.videoOptions?.constraints})),v?.meetingInfo?.tenantId&&(this._teamsMeetingTenantId=v.meetingInfo.tenantId,R.additionalProperties.teamsMeetingTenantId=v.meetingInfo.tenantId),v?.threadId&&(this._teamsMeetingThreadId=v.threadId,R.additionalProperties.teamsMeetingThreadId=v.threadId),getAcsEcsConfig().calling.setDeviceType&&"default"!==this._callAgent.getDeviceType()&&(R.additionalProperties.firstPartyOptions={deviceType:this._callAgent.getDeviceType(),isImmersiveMode:g?.firstPartyOptions?.isImmersiveMode}),this.sendCallStageEvent({eventName:Ah.acs_calling_call_attempt,correlationId:b,timestampInfo:{attemptTimestamp:I},additionalPayload:R});let P={...R},w={...R};try{this._isMicrophoneMuted=C,g?.alternateCallerId&&(T=getMriFromIdentifier(g.alternateCallerId)),_&&this.setLocalVideoStream(_),this.setLocalAudioStream(E)}catch(g){const m=+new Date,S=new CallingCommunicationError({defaultError:D.CALL.INSTANTIATE_CALL,originalError:g});throw P.additionalDetails.communicationServicesError=extractCommunicationServicesErrorForTelemetry(S).communicationServicesError,this.sendCallStageEvent({eventName:Ah.acs_calling_call_failed,correlationId:b,timestampInfo:{deltaTimeInMs:m-I},additionalPayload:P},S),this.logger.error(S.message),S}try{const S={...v};!getAcsEcsConfig().calling.setDeviceType||"mesh"!==this._callAgent.getDeviceType()&&"meshV2"!==this._callAgent.getDeviceType()||(S.endpointMetadata=JSON.stringify({meshapp:!0})),this.tsCall.init(S),_&&this.sendVideoEvent({correlationId:b,eventName:Ah.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:I},localVideoStream:_,step:"start",isScreenSharingOnFlag:this._isScreenSharingOn});try{if(g?.videoOptions?.constraints){const m=await this._mediaConstraintsManager.setVideoConstraints(g?.videoOptions?.constraints,"start",b,I),S=this._mediaConstraintsManager.getTelemetryPayload({video:m});w.additionalProperties.constraints=S}}catch(g){const m=new CallingCommunicationError({defaultError:D.CALL.CALLSTART_VIDEO_CONSTRAINTS,originalError:g});this.logger.error(`${m.message}`)}let A=this.setClientEndpointCapabilities(g);getAcsEcsConfig()?.calling?.enableCustomTurnUsage&&this.acsCustomRelayManager?.customRelayManagerInUse&&(A.mediaConfiguration={connectionType:"NoDirectConnection"}),C&&(A.muteFlags=1),"RawMedia"===_?.mediaStreamType&&await this._setRawStream(_,1),m?await this.tsCall.startWithMeetingData(M.generateCauseId(),{withVideo:!!_,muted:C,ringOthers:!0,alternateId:T,shouldResurrect:"resurrect",receiveOnlyAudioOnCallStart:!!E,...A}):await this.tsCall.start({withVideo:!!_,muted:C,ringOthers:!0,alternateId:T,receiveOnlyAudioOnCallStart:!!E,...A});const R=+new Date;this.sendCallStageEvent({eventName:Ah.acs_calling_call_connected,correlationId:b,timestampInfo:{deltaTimeInMs:R-I},additionalPayload:w}),_&&this.shallRemoveLvsAfterConnectedSuccessfully(_,"start",b,R,I),E&&(this.startAudioInternal(E,!0).catch((g=>{})),this.shallRemoveLasAfterConnectedSuccessfully(E,"start",b,R,I))}catch(g){const m=+new Date,{callEndReason:S,callingCommunicationError:v}=getCallEndReason(this,g);throw _&&(this.sendVideoEvent({correlationId:b,eventName:Ah.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:m-I},localVideoStream:_,step:"start",isScreenSharingOnFlag:this._isScreenSharingOn},v),this.removeLocalVideoStream(_)),E&&this.removeLocalAudioStream(E),P.additionalDetails.callEndReason=extractCallEndReasonForTelemetry(S).callEndReason,this.sendCallStageEvent({eventName:Ah.acs_calling_call_failed,correlationId:b,timestampInfo:{deltaTimeInMs:m-I},additionalPayload:P},v),this.logger.error(`Failed to start the call, message=${S?.message}, code=${S?.code}, subCode=${S?.subCode}, resultCategories=${S?.resultCategories}`),v}}getTopNDominantSpeakersWithVideoOn(){if(this._internalDominantSpeakersListener){const g=this._internalDominantSpeakersListener.dominantSpeakers.speakersList.map((g=>this._mriToRemoteParticipantMap.get(getMriFromIdentifier(g)))).filter((g=>!!g)).filter((g=>!!g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).find((g=>g.tsStream.isAvailable))));if(this.logger.info(`There are currently ${g.length} top-n dominant speakers with video on in the large meeting where topCount is ${getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount}`),g.length<getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount){const m=this._remoteParticipants.filter((g=>!!g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).find((g=>g.tsStream.isAvailable)))).filter((m=>!g.includes(m)));m.sort(((g,m)=>{const S=g.tsRemoteParticipant?.endpoints?.endpointDetails[0]?.mediaStreams?.filter((g=>"audio"===g.type)).map((g=>g.sourceId))??[],v=S.length>0?Math.min(...S):void 0,C=m.tsRemoteParticipant?.endpoints?.endpointDetails[0]?.mediaStreams?.filter((g=>"audio"===g.type)).map((g=>g.sourceId))??[],_=C.length>0?Math.min(...C):void 0;return void 0!==v&&null!=_?v-_:0}));for(const S of m){if(g.length===getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount)break;g.push(S)}}else g.splice(getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount);return g}return[]}getParticipantCapabilities(){const g=this._capabilityResolver.getCapabilities();return this.logger.log(`participant capabilities are ${g}`),g}feature(g){return this._extensibleApi.getApiObjectInstance(g.callApiCtor)}async hangUp(g){const m=+new Date,S=generateGuid();return this.sendCallStageEvent({eventName:Ah.acs_calling_call_hangup_attempt,correlationId:S,timestampInfo:{attemptTimestamp:m}}),this.tsCall.stop(g?.forEveryone).then((()=>{const g=+new Date;this.sendCallStageEvent({eventName:Ah.acs_calling_call_hangup_success,correlationId:S,timestampInfo:{deltaTimeInMs:g-m}})})).catch((g=>{const v=+new Date,{callEndReason:C,callingCommunicationError:_}=getCallEndReason(this,g),E=this._callAgent.getEcsConfigIds(),T={additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:E.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:E.SkypeWebMedia},additionalDetails:{...extractCallEndReasonForTelemetry(C)}};throw this.sendCallStageEvent({eventName:Ah.acs_calling_call_hangup_failure,correlationId:S,timestampInfo:{deltaTimeInMs:v-m},additionalPayload:T},_),_}))}async mute(){const g=this.logger.createFnLogger($h.Mute),m=+new Date,S=generateGuid();this.sendAudioEvent({eventName:Ah.acs_calling_mute_attempt,eventType:Mh.MuteMicrophone,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});try{g.info("mute"),await this.tsCall.mute(),g.info("mute success");const v=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_mute_success,eventType:Mh.MuteMicrophone,timestampInfo:{deltaTimeInMs:v-m},correlationId:S,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK})}catch(v){const C=new CallingCommunicationError({defaultError:D.CALL.MIC_MUTE,originalError:v});g.error("Failed to mute microphone");const _=+new Date;throw this.sendAudioEvent({eventName:Ah.acs_calling_mute_failure,eventType:Mh.MuteMicrophone,timestampInfo:{deltaTimeInMs:_-m},correlationId:S,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK},C),C}}async unmute(){const g=this.logger.createFnLogger($h.Unmute),m=+new Date,S=generateGuid();let v=!1;this.sendAudioEvent({eventName:Ah.acs_calling_unmute_attempt,eventType:Mh.UnmuteMicrophone,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});try{g.info("unmute"),await this.tsCall.unmute(),g.info("unmute success");const C=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_unmute_success,eventType:Mh.UnmuteMicrophone,timestampInfo:{deltaTimeInMs:C-m},correlationId:S,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});const _=+new Date,E=getAcsEcsConfig()?.calling?.preventStopAudio;if(!E&&this._isDeviceNotFunctioningMuted){this.sendAudioEvent({eventName:Ah.acs_calling_start_audio_attempt,timestampInfo:{attemptTimestamp:_},correlationId:S,step:"mid-call"}),v=!0,g.info("start audio"),await this.tsCall.startAudio(),g.info("start audio success");const m=+new Date;this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges(),this.sendAudioEvent({eventName:Ah.acs_calling_start_audio_success,timestampInfo:{deltaTimeInMs:m-_},correlationId:S,step:"mid-call"})}}catch(C){const _=v?D.CALL.MIC_UNMUTE_AND_STARTAUDIO:D.CALL.MIC_UNMUTE,E=new CallingCommunicationError({defaultError:_,originalError:C});g.error(_.message);const T=+new Date;throw this.sendAudioEvent({eventName:v?Ah.acs_calling_start_audio_failure:Ah.acs_calling_unmute_failure,eventType:v?void 0:Mh.UnmuteMicrophone,timestampInfo:{deltaTimeInMs:T-m},correlationId:S,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK&&!v},E),E}}async muteAllRemoteParticipants(){if(!getAcsEcsConfig().calling.enableMuteOthers)throw new CallingCommunicationError({defaultError:D.CALL.MUTE_ALL_PARTICIPANTS_DISABLED});const g=this.logger.createFnLogger($h.MuteAllRemoteParticipants),m=+new Date,S=generateGuid();this.sendAudioEvent({eventName:Ah.acs_calling_mute_attempt,eventType:Mh.MuteAllRemoteParticipants,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"});try{g.info("mute all others"),await this.tsCall.muteParticipants(0,[]),g.info("mute all others success");const v=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_mute_success,eventType:Mh.MuteAllRemoteParticipants,timestampInfo:{deltaTimeInMs:v-m},correlationId:S,step:"mid-call"})}catch(v){const C=new CallingCommunicationError({defaultError:D.CALL.MUTE_ALL_PARTICIPANTS,originalError:v});g.error(C.message);const _=+new Date;throw this.sendAudioEvent({eventName:Ah.acs_calling_mute_failure,eventType:Mh.MuteAllRemoteParticipants,timestampInfo:{deltaTimeInMs:_-m},correlationId:S,step:"mid-call"},C),C}}async muteIncomingAudio(){const g=this.logger.createFnLogger($h.MuteIncomingAudio),m=+new Date,S=generateGuid();this.sendAudioEvent({eventName:Ah.acs_calling_mute_attempt,eventType:Mh.MuteIncomingAudio,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"});try{await this.tsCall.muteSpeaker();const g=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_mute_success,eventType:Mh.MuteIncomingAudio,timestampInfo:{deltaTimeInMs:g-m},correlationId:S,step:"mid-call"})}catch(v){const C=new CallingCommunicationError({defaultError:D.CALL.MUTE_INCOMING_AUDIO,originalError:v});g.error(C.message);const _=+new Date;throw this.sendAudioEvent({eventName:Ah.acs_calling_mute_failure,eventType:Mh.MuteIncomingAudio,timestampInfo:{deltaTimeInMs:_-m},correlationId:S,step:"mid-call"},C),C}}async unmuteIncomingAudio(){const g=this.logger.createFnLogger($h.MuteIncomingAudio),m=+new Date,S=generateGuid();this.sendAudioEvent({eventName:Ah.acs_calling_unmute_attempt,eventType:Mh.UnmuteIncomingAudio,timestampInfo:{attemptTimestamp:m},correlationId:S,step:"mid-call"});try{await this.tsCall.unmuteSpeaker();const g=+new Date;this.sendAudioEvent({eventName:Ah.acs_calling_unmute_success,eventType:Mh.UnmuteIncomingAudio,timestampInfo:{deltaTimeInMs:g-m},correlationId:S,step:"mid-call"})}catch(v){const C=new CallingCommunicationError({defaultError:D.CALL.UNMUTE_INCOMING_AUDIO,originalError:v});g.error(C.message);const _=+new Date;throw this.sendAudioEvent({eventName:Ah.acs_calling_unmute_failure,eventType:Mh.UnmuteIncomingAudio,timestampInfo:{deltaTimeInMs:_-m},correlationId:S,step:"mid-call"},C),C}}async sendDtmf(g){const m=toDtmfTone(g);return this.tsCall.sendDtmfTone(m).catch((g=>{throw this.logger.error("Failed to send DTMF tone"),new CallingCommunicationError({defaultError:D.CALL.DTMF_TONE})}))}async startVideo(g){const m=this.logger.createFnLogger($h.StartVideo),S=+new Date,v=generateGuid(),C=getAcsEcsConfig()?.calling?.preventStopAudio;if(this.sendVideoEvent({eventName:Ah.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:S},localVideoStream:g,correlationId:v,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),this._isDeviceNotFunctioningMuted&&!C){this.sendAudioEvent({eventName:Ah.acs_calling_start_audio_attempt,timestampInfo:{attemptTimestamp:S},correlationId:v,step:"mid-call"});try{m.info("start audio before starting video"),await this.tsCall.startAudio(),m.info("start audio success before starting video");const g=+new Date;this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges(),this.sendAudioEvent({eventName:Ah.acs_calling_start_audio_success,timestampInfo:{deltaTimeInMs:g-S},correlationId:v,step:"mid-call"})}catch(g){const C="Failed to start audio before starting video",_=new CallingCommunicationError({defaultError:D.CALL.START_AUDIO_BEFORE_VIDEO,originalError:g});m.error(C);const E=+new Date;throw this.sendAudioEvent({eventName:Ah.acs_calling_start_audio_failure,timestampInfo:{deltaTimeInMs:E-S},correlationId:v,step:"mid-call"},_),_}}try{if(!g)throw new CallingCommunicationError({defaultError:D.CALL.STREAM_NULL});if(!(g instanceof LocalVideoStream))throw new CallingCommunicationError({defaultError:D.CALL.STREAM_IS_NOT_LVS});if(this.tsCall.isVideoOn)throw new CallingCommunicationError({defaultError:D.CALL.VIDEO_ALREADY_ON});"RawMedia"===g?.mediaStreamType&&await this._setRawStream(g,1),this.setLocalVideoStream(g)}catch(m){const C=new CallingCommunicationError({defaultError:D.CALL.START_VIDEO,originalError:m});throw this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_start_video_failure,timestampInfo:{attemptTimestamp:S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},C),C}try{m.info("start video"),await this.tsCall.startVideo();const C=+new Date;this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_start_video_success,timestampInfo:{deltaTimeInMs:C-S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),m.info("video started")}catch(C){const _=+new Date,E=handleVideoOperationFailure(m,C);throw this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:_-S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},E),this.removeLocalVideoStream(g),E}}async stopVideo(g){const m=this.logger.createFnLogger($h.StopVideo),S=+new Date,v=generateGuid();if(this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_stop_video_attempt,timestampInfo:{attemptTimestamp:S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),!this.tsCall.isVideoOn){const m=new CallingCommunicationError({defaultError:D.CALL.VIDEO_ALREADY_OFF});throw this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_stop_video_failure,timestampInfo:{attemptTimestamp:S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},m),m}if(this.localVideoStream!==g){const m=new CallingCommunicationError({defaultError:D.CALL.STOP_WRONG_STREAM});throw this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_stop_video_failure,timestampInfo:{attemptTimestamp:S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},m),m}const unsetRawVideoStream=()=>{try{if(getAcsEcsConfig().calling.allowAccessRawMediaStream&&"RawMedia"===g.mediaStreamType){const g=this._callAgent.tsStack?.getDeviceManager();g&&g.unsetRawMediaStream&&g.unsetRawMediaStream(1)}}catch(g){this.logger.info(`Unset raw video stream: ${g?.message??"Unkown error"}`)}};try{m.info("stop video"),await this.tsCall.stopVideo(),unsetRawVideoStream();const C=+new Date;this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_stop_video_success,timestampInfo:{deltaTimeInMs:C-S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),m.info("video stopped"),this.removeLocalVideoStream(g)}catch(C){unsetRawVideoStream();const _=+new Date,E=handleVideoOperationFailure(m,C);throw this.sendVideoEvent({correlationId:v,eventName:Ah.acs_calling_stop_video_failure,timestampInfo:{deltaTimeInMs:_-S},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},E),E}}startAudio(g){return this.startAudioInternal(g)}stopAudio(){return this.stopAudioInternal()}async hold(){const g=+new Date,m=generateGuid();return this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Hold,kindOfEvent:Rh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:au.Standard}}),this.tsCall.hold().then((()=>{const S=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Hold,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{holdType:au.Standard}})})).catch((S=>{const v=+new Date,C=new CallingCommunicationError({defaultError:D.CALL.HOLD_CALL});throw this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Hold,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:v-g},additionalDetails:{failureReason:C.message,code:C.code,subCode:C.subCode,holdType:au.Standard,...extractCommunicationServicesErrorForTelemetry(C)}}),C}))}async resume(){const g=+new Date,m=generateGuid();return this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Resume,kindOfEvent:Rh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:au.Standard}}),this.tsCall.unhold().then((()=>{const S=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Resume,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{holdType:au.Standard}})})).catch((S=>{const v=+new Date,C=new CallingCommunicationError({defaultError:D.CALL.RESUME_CALL});throw this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Resume,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:v-g},additionalDetails:{failureReason:C.message,code:C.code,subCode:C.subCode,holdType:au.Standard,...extractCommunicationServicesErrorForTelemetry(C)}}),C}))}async startScreenSharing(g){const m=this.logger.createFnLogger($h.StartScreenShare),S=+new Date,v=generateGuid();try{if(this.sendScreenShareEvent({eventName:Ah.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:v,kindOfEvent:Rh.attempt,timestampInfo:"",additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:g}),3!==this.tsCall.state)throw new CallingCommunicationError({defaultError:D.CALL.START_SS_CALL_NOT_CONNECTED});if(this.tsCall.isScreenSharingOn)throw new CallingCommunicationError({defaultError:D.CALL.SS_ALREADY_ON});if(g){if(!(g instanceof LocalVideoStream))throw new CallingCommunicationError({defaultError:D.CALL.SS_RAW_STREAM_IS_NOT_LVS});if("RawMedia"!==g.mediaStreamType)throw new CallingCommunicationError({defaultError:D.CALL.SS_RAW_STREAM_LVS_IS_NOT_RAW_MEDIA});await this._setRawStream(g,2),this.localScreenSharingStream=g}else this.localScreenSharingStream=new LocalVideoStream(new VideoDeviceInfoImpl(nl.ScreenSharing,generateGuid(),nl.ScreenSharing,this._callAgent.deviceManager))}catch(g){const m=+new Date;this.removeScreenSharingStream();const C=new CallingCommunicationError({defaultError:D.CALL.START_SS,originalError:g});throw this.sendScreenShareEvent({eventName:Ah.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:v,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:m-S},additionalDetails:{failureReason:C.message,code:C.code,subCode:C.subCode,...extractCommunicationServicesErrorForTelemetry(C)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),C}return this.tsCall.startScreenSharing().then((()=>{const g=+new Date;this.localScreenSharingStream&&-1===this._localVideoStreams.indexOf(this.localScreenSharingStream)&&(this.localScreenSharingStream.addCall(this),this._localVideoStreams.push(this.localScreenSharingStream),this._eventEmitter.emit("localVideoStreamsUpdated",{added:[this.localScreenSharingStream],removed:[]})),this.sendScreenShareEvent({eventName:Ah.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:v,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:g-S},additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream})})).catch((g=>{const C=+new Date;this.removeScreenSharingStream();const _=handleVideoOperationFailure(m,g);throw this.sendScreenShareEvent({eventName:Ah.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:v,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:C-S},additionalDetails:{failureReason:_.message,code:_.code,subCode:_.subCode,...extractCommunicationServicesErrorForTelemetry(_)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),_}))}async stopScreenSharing(){const g=this.logger.createFnLogger($h.StopScreenShare),m=+new Date,S=generateGuid();if(this.sendScreenShareEvent({eventName:Ah.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Rh.attempt,timestampInfo:"",additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),3!==this.tsCall.state)throw new CallingCommunicationError({defaultError:D.CALL.STOP_SS_CALL_NOT_CONNECTED});if(!this.tsCall.isScreenSharingOn){const g=+new Date,v=new CallingCommunicationError({defaultError:D.CALL.SS_ALREADY_OFF});throw this.sendScreenShareEvent({eventName:Ah.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:g-m},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),v}return this.tsCall.stopScreenSharing().then((()=>{const g=+new Date,v=P.cloneDeep(this.localScreenSharingStream);this.removeScreenSharingStream(),this.sendScreenShareEvent({eventName:Ah.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:g-m},additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:v})})).catch((v=>{const C=+new Date,_=handleVideoOperationFailure(g,v);let E="string"==typeof _?.message?_?.message:void 0;throw this.sendScreenShareEvent({eventName:Ah.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:C-m},additionalDetails:{failureReason:E||"",code:_.code,subCode:_.subCode,...extractCommunicationServicesErrorForTelemetry(_)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),_}))}async setConstraints(g){const m=+new Date,S=generateGuid();try{let v=await this._mediaConstraintsManager.setVideoConstraints(g?.video,"mid-call",S,m);this.logger.info(`Video constraints set - ${JSON.stringify(v)}`)}catch(g){throw new CallingCommunicationError({defaultError:D.CALL.SET_VIDEO_CONSTRAINTS,originalError:g})}}on(g,m){if("stateChanged"!==g&&"idChanged"!==g&&"isMutedChanged"!==g&&"isIncomingAudioMutedChanged"!==g&&"isScreenSharingOnChanged"!==g&&"isLocalVideoStartedChanged"!==g&&"remoteParticipantsUpdated"!==g&&"localVideoStreamsUpdated"!==g&&"localAudioStreamsUpdated"!==g&&"remoteAudioStreamsUpdated"!==g&&"totalParticipantCountChanged"!==g&&"roleChanged"!=g)throw new CallingCommunicationError({defaultError:D.CALL.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("stateChanged"!==g&&"idChanged"!==g&&"isMutedChanged"!==g&&"isIncomingAudioMutedChanged"!=g&&"isScreenSharingOnChanged"!==g&&"isLocalVideoStartedChanged"!==g&&"remoteParticipantsUpdated"!==g&&"localVideoStreamsUpdated"!==g&&"localAudioStreamsUpdated"!==g&&"remoteAudioStreamsUpdated"!==g&&"totalParticipantCountChanged"!=g&&"roleChanged"!=g)throw new CallingCommunicationError({defaultError:D.CALL.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}onMeetingCapabilitiesChanged(g,m){if("meetingCapabilitiesChanged"!==g)throw new CallingCommunicationError({defaultError:D.CALL.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}offMeetingCapabilitiesChanged(g,m){if("meetingCapabilitiesChanged"!=g)throw new CallingCommunicationError({defaultError:D.CALL.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}onParticipantCapabilitiesChanged(g,m){this.logger.log("participant capabilities change event listener registered"),this._eventEmitter.on(g,m)}offParticipantCapabilitiesChanged(g,m){this.logger.log("participant capabilities change event listener unregistered"),this._eventEmitter.off(g,m)}getOrCreateRemoteParticipant(g,m){let S=this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));return S||(S=new RemoteParticipantImpl(g,this.logger,this,this._callAgent,this._telemetryLogManager),this._remoteParticipants.push(S),this._mriToRemoteParticipantMap.set(getMriFromIdentifier(S.identifier),S)),m&&S.observeParticipant(m),S}deleteRemoteParticipant(g){let m=!0;return 1!==this._remoteParticipants.splice(this._remoteParticipants.indexOf(g),1).length&&(this.logger.warn("Deleted remote participant array is not 1"),m=!1),this._mriToRemoteParticipantMap.delete(getMriFromIdentifier(g.identifier))||(this.logger.warn("Deleted remote participant was not found in mri-to-remoteparticipant map"),m=!1),m}sendCallOnHoldAndResumedEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send call hold or resume telemetry")}}sendVideoEvent(g,m){try{let S,v;try{S=g.localVideoStream?.getStreamMetadata()}catch(g){this.logger.error("Unable to get stream meta data on send video event")}m&&(v="string"==typeof m?.message?m?.message:void 0,g.additionalDetails={...extractCommunicationServicesErrorForTelemetry(m)}),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:{...S,callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:g.timestampInfo,correlationId:g.correlationId,step:g.step||"",failureReason:v||"",isScreenSharingOnFlag:g.isScreenSharingOnFlag,additionalDetails:g.additionalDetails||{}}})}catch(g){this.logger.debug("Unable to send video telemetry")}}sendScreenShareEvent(g){let m;try{m=g.localVideoStream?.getStreamMetadata()}catch(g){this.logger.error("Unable to get stream meta data on send video event")}try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:{...m,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:g.correlationId,kindOfEvent:g.kindOfEvent,timestampInfo:g.timestampInfo,additionalDetails:g.additionalDetails,isVideoOn:g.isVideoOn}})}catch(g){this.logger.debug("Unable to send screen share telemetry")}}sendRawMediaEvent(g){const m={...g};m.localAudioStream=g.localAudioStream?.source instanceof MediaStream?"MediaStream":"Device";try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:m})}catch(g){this.logger.debug("Unable to send raw media telemetry")}}sendAudioEvent(g,m){try{let S;m&&(S="string"==typeof m?.message?m?.message:void 0,g.additionalDetails={...extractCommunicationServicesErrorForTelemetry(m)});const v={callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:g.timestampInfo,correlationId:g.correlationId,step:g.step||"",failureReason:S||"",additionalDetails:g.additionalDetails||{}};void 0!==g.eventType&&(v.eventType=g.eventType),g.initiatedBySdk&&(v.initiatedBySdk=!0),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:v})}catch(g){this.logger.debug("Unable to send audio telemetry")}}sendCallStageEvent(m,S,v){try{let C,_="";S&&(C=this?.tsCall?.callEndDiagnosticsInfo||v||{},_=S.message);const E=this._joinContextDescription===Wo.RoomCall||this.kind===g.CallKind.Call&&"Incoming"===this._direction&&!this.tsCall.groupId&&!!this.tsCall.meetingData?.meetingCode&&!this.tsCall.threadId,T=!E&&this._joinContextDescription===Wo.TeamsMeetingLink||this._joinContextDescription===Wo.TeamsMeetingId||this._joinContextDescription===Wo.TeamsCoordinates||"Incoming"==this._direction&&!this.tsCall.groupId&&!!this.tsCall.meetingData&&!!this.tsCall.threadId,I={localParticipantId:this?.tsCall?.participantId||"",callId:this?.tsCall?.callId||"",callType:this?.tsCall?.callType||"",callDirection:this._direction,failureReason:_,callEndDiagnosticsInfo:C,calleeIdentityType:this.getParticipantIdentityType(),groupJoin:!!this?.tsCall?.groupId,roomJoin:E,meetingJoin:T,correlationId:m.correlationId,timestampInfo:m.timestampInfo,...m.additionalPayload};this._telemetryLogManager.sendEvent({name:m.eventName,tenant:Qa,properties:I})}catch(g){}}getParticipantIdentityType(){if(this.tsCall?.participants.length>1)return rl.group;if(0===this.tsCall?.participants.length)return rl.unknown;const g=this.tsCall?.participants[0];return constructIdentifierKindFromMri(g.id).kind}optimalVideoCountChanged(){const g=this._optimalVideoCount,m=this.tsCall.optimalVideoCount;if(m&&g!==m)try{sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"optimalVideoCount-changed",previousOptimalVideoCount:g,newOptimalVideoCount:m,currentNumberOfVideosRendered:this.activeRemoteVideoStreamViews?.size||0})}catch(g){this.logger.error("Failed to send optimal video count change telemetry")}finally{this._optimalVideoCount=this.tsCall.optimalVideoCount||1}}_sendNetworkChangedTelemetry(){try{const recordNetworkChangedTelemetry=(g,m,S)=>{sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"network-changed",trouterState:g,onLine:m,rdpState:S})};this._trouterStateChangedListener=g=>{recordNetworkChangedTelemetry(g,navigator.onLine,this._mmrRdpConnectionManager.state)},this._callAgent.onTrouterStateChanged(this._trouterStateChangedListener),this._onlineListener=g=>{recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),!0,this._mmrRdpConnectionManager.state)},window.addEventListener("online",this._onlineListener),this._offlineListener=g=>{recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),!1,this._mmrRdpConnectionManager.state)},window.addEventListener("offline",this._offlineListener),this._mmrRdpConnectionManager.on("stateChange",(g=>{recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),!1,g)})),recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),navigator.onLine,this._mmrRdpConnectionManager.state)}catch(g){this.logger.warn("Failed to subscribe to network changed")}}_setupSelectedDeviceChangedTelemetry(){try{const recordTelemetry=g=>{sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"selectedDevice-changed",selectedDeviceType:g.selectedDeviceType,oldDevice:g.oldDevice,newDevice:g.newDevice})};if(this._selectedDeviceManager){this._selectedDeviceManager.on("selectedDeviceChanged",recordTelemetry);const g=this._selectedDeviceManager.selectedDevice("Speaker"),m=this._selectedDeviceManager.selectedDevice("Microphone");recordTelemetry({selectedDeviceType:"Speaker",oldDevice:void 0,newDevice:g}),recordTelemetry({selectedDeviceType:"Microphone",oldDevice:void 0,newDevice:m})}}catch(g){this.logger.warn("Failed to subscribe to selectedDevice changed")}}setLocalVideoStream(g){if(!this._callAgent.tsStack)throw new CallingCommunicationError({defaultError:D.CALL.VIDEO_UNDEFINED_STACK});if(!this.localVideoStream&&g&&!this._localVideoStreams.find((m=>m===g))){this.localVideoStream=g,this._localVideoStreams.push(this.localVideoStream),"RawMedia"!==this.localVideoStream.mediaStreamType&&this._callAgent.tsStack.getDeviceManager().selectDevices({camera:g.source.id}),this.localVideoStream.addCall(this);try{this._eventEmitter.emit("localVideoStreamsUpdated",{added:[this.localVideoStream],removed:[]})}catch(g){this.logger.warn("Application threw on emit localVideoStreamsUpdated added")}this.logger.log("isLocalVideoStarted changed=true"),this._isLocalVideoStarted=!0,this._eventEmitter.emit("isLocalVideoStartedChanged")}}removeLocalVideoStream(g){if(this.localVideoStream&&g===this.localVideoStream&&this.localVideoStreams.find((g=>g===this.localVideoStream))){this.logger.log("Attempting to remove local video stream");if(0===this._localVideoStreams.splice(this._localVideoStreams.indexOf(this.localVideoStream),1).length)return void this.logger.warn("Stream not found, failed to remove stream from localVideoStreams collection");this.logger.log("Local video stream removed successfully"),this.localVideoStream.removeCall(this),this.localVideoStream.dispose();const g=this.localVideoStream;this.localVideoStream=void 0;try{this._eventEmitter.emit("localVideoStreamsUpdated",{added:[],removed:[g]})}catch(g){this.logger.warn("Application threw on emit localVideoStreamsUpdated removed")}this.logger.log("isLocalVideoStarted changed=false"),this._isLocalVideoStarted=!1,this._eventEmitter.emit("isLocalVideoStartedChanged")}}setLocalAudioStream(g){if(!this._callAgent.tsStack)throw new CallingCommunicationError({defaultError:D.CALL.LOCAL_AUDIO_UNDEFINED_STACK});getAcsEcsConfig().calling.allowAccessRawMediaStream&&g&&(g.on("audioSourceChanged",this.audioSourceChanged),this._localAudioStreams.push(g),this._eventEmitter.emit("localAudioStreamsUpdated",{added:[g],removed:[]}))}removeLocalAudioStream(g){if(g){this.logger.log("Attempting to remove local audio stream"),g.off("audioSourceChanged",this.audioSourceChanged),g.dispose();if(0===this._localAudioStreams.splice(this._localAudioStreams.indexOf(g),1).length)return void this.logger.warn("Stream not found, failed to remove stream from localAudioStreams collection");this.logger.log("Local audio stream removed successfully"),this._eventEmitter.emit("localAudioStreamsUpdated",{added:[],removed:[g]})}}removeScreenSharingStream(){if(this.localScreenSharingStream&&this.localVideoStreams.find((g=>g===this.localScreenSharingStream))){if(getAcsEcsConfig()?.calling?.allowAccessRawMediaStream&&"RawMedia"===this.localScreenSharingStream?.mediaStreamType){const g=this._callAgent.tsStack?.getDeviceManager();g?.unsetRawMediaStream&&g.unsetRawMediaStream(2)}this.localScreenSharingStream.dispose(),this.localScreenSharingStream.removeCall(this);const g=this._localVideoStreams.indexOf(this.localScreenSharingStream);this._localVideoStreams.splice(g,1);const m=this.localScreenSharingStream;this.localScreenSharingStream=void 0,this._eventEmitter.emit("localVideoStreamsUpdated",{added:[],removed:[m]})}}mapTsCallState(g){let m=Ru[g];switch(m){case"Unknown":case void 0:this.logger.log(`Ignored tsCall state \`${g}\``);break;case"Disconnected":{this._callEndReason=getCallEndReason(this).callEndReason,this._remoteParticipants.forEach((g=>{g.setCallEndReason(getRemoteParticipantCallEndReason(this,g.tsRemoteParticipant).callEndReason),g.setParticipantState("Disconnected")}));const S=this._remoteParticipants.map((g=>g));this._remoteParticipants=[],this._mriToRemoteParticipantMap.clear(),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:S}),this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream),getAcsEcsConfig().calling.allowAccessRawMediaStream&&this.localAudioStreams[0]&&this.removeLocalAudioStream(this.localAudioStreams[0]),getAcsEcsConfig().calling.allowAccessRawMediaStream&&this.remoteAudioStreams[0]&&this.removeRemoteAudioStream(this.remoteAudioStreams[0]),this.logger.log(`Mapped tsCall state:${g} to ${m}`),this._setCallState(m),this._telemetryLogManager.flushAllEvents(this.id).then((()=>{this.logger.log("Telemetry flushed")})).catch((g=>{this.logger.warn("Failed to flush telemetry log manager events")}));break}case"Connected":this.logger.log(`Mapped tsCall state:${g} to ${m}`),this._remoteParticipantsChangedListeners.forEach((g=>{g.dispose()})),this._setCallState(m),this.setOrUpdateMediaMetricsDeviceEvents(),getAcsEcsConfig().calling.allowAccessRawMediaStream&&this.subscribeToGetRemoteAudioStream();break;case"Incoming Call":{this.logger.log(`state changed from ${this._state} to 'Incoming Call'`);const g=new CallInfoImpl(this.tsCall,{config:this._config});sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"state-changed",oldState:this._state,newState:"Incoming Call",callTypeInfo:{initiatorKind:g.initiatorKind,targetKind:g.targetKind,transferor:g.transferorKind,context:g.context,callScenario:g.callScenario,direction:g.direction},teamsMeetingTenantId:this._teamsMeetingTenantId||"",teamsMeetingThreadId:this._teamsMeetingThreadId||"",callDurationInSeconds:this.tsCall.callStartedAt?Math.floor((Date.now()-this.tsCall.callStartedAt?.getTime())/1e3):-1});break}default:this.logger.log(`Mapped tsCall state:${g} to ${m}`),this._setCallState(m)}}shallStopVideo(g){const m=getAcsEcsConfig()?.calling?.deviceNotFunctioningMuted,S=getAcsEcsConfig()?.calling?.deviceCaptureMutedVideo,v=getAcsEcsConfig()?.calling?.preventStopVideo,C=25===g.type&&3===g.value,_=C&&1===g.mediaType,E=33===g.type&&3===g.value,T=getBrowserInfo(),I="ios"===getOS()&&"Safari"===T.engine,b="android"===getOS(),A=3===this.tsCall.state;return v?A&&this.tsCall.isVideoOn&&E:m&&A&&this.tsCall.isVideoOn&&(E||I&&C||S&&b&&_)}shallRemoveLocalVideoStreamOnBadUfd(g){const m=this.tsCall.localMediaStreams.find((g=>1===g.mediaType)),S=1===g.mediaType&&3===g.value&&25===g.type,v=4==this.tsCall.state||5===this.tsCall.state;if("Mobile"===getBrowserInfo().formFactor&&(S||"hidden"==document.visibilityState)&&this.localVideoStream&&v&&!m)return!1;if(!getAcsEcsConfig()?.calling?.removeLvsCheckOnCallStartAndCallAccept)return!1;const C=3===this.tsCall.state;return 1===g.mediaType&&3===g.value&&(33===g.type||25===g.type||34===g.type)&&!!this.localVideoStream&&!C&&!m}shallStopAudio(g){const m=getAcsEcsConfig()?.calling?.deviceNotFunctioningMuted,S=getAcsEcsConfig()?.calling?.osAutoRecoverAudio,v=25===g.type&&3===g.value&&0===g.mediaType,C=9===g.type&&3===g.value,_=getBrowserInfo(),E="ios"===getOS()&&"Safari"===_.engine,T=3===this.tsCall.state;return S?m&&T&&C:m&&!this._isDeviceNotFunctioningMuted&&T&&(C||E&&v)}markCallMuted(){this._isDeviceNotFunctioningMuted=!0,this._handleMuteChanges()}audioDidAutoRecover(g){const m=getAcsEcsConfig()?.calling?.deviceCaptureMuteRecover&&!getAcsEcsConfig()?.calling?.preventFakeMute,S=25===g.type&&1===g.value&&0===g.mediaType,v=3===this.tsCall.state,C=getBrowserInfo(),_="ios"===getOS()&&"Safari"===C.engine,E=9===g.type&&1===g.value;return m&&this._isDeviceNotFunctioningMuted&&v&&(E||_&&S)}sendParticipantAddedOrRemovedEvent(g){try{this._telemetryLogManager.sendEvent({name:Ah.acs_calling_participant_added_or_removed,tenant:Qa,properties:{callId:this.id,remotePerticipantId:Array.isArray(g?.remoteParticipantIds)?g?.remoteParticipantIds.slice(0,getAcsEcsConfig().telemetry.maxExistingReportedParticipants):[],participantAddedOrRemoved:g.participantAddedOrRemoved,localParticipantId:this.tsCall.participantId,kindOfEvent:g.kindOfEvent,correlationId:g.correlationId||"",timestampInfo:g.timestampInfo||"",additionalDetails:g.additionalDetails||{}}})}catch(g){this.logger.debug("Unable to send participant added telemtery")}}_handleLocalRingingCallState(g){"Connected"===this._state||"Outgoing"!==this._direction||this._localRingingStateSet||this._remoteParticipantsChangedListeners.push(g.changed((()=>{2!==g.state||"Connected"===this._state||this._localRingingStateSet||(this._setCallState("Ringing"),this._localRingingStateSet=!0,this._remoteParticipantsChangedListeners.forEach((g=>{g.dispose()})))})))}_setCallState(g){if(g!==this._state){const m=this._state,S=g,v=new CallInfoImpl(this.tsCall,{config:this._config});this.logger.log(`state changed from ${m} to ${S}`),this._state=S,this._eventEmitter.emit("stateChanged"),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"state-changed",oldState:m,newState:S,callTypeInfo:{initiatorKind:v.initiatorKind,targetKind:v.targetKind,transferor:v.transferorKind,context:v.context,callScenario:v.callScenario,direction:v.direction},teamsMeetingTenantId:this._teamsMeetingTenantId||"",teamsMeetingThreadId:this._teamsMeetingThreadId||"",callDurationInSeconds:this.tsCall.callStartedAt?Math.floor((Date.now()-this.tsCall.callStartedAt?.getTime())/1e3):-1,additionalDetails:"Disconnected"===this._state&&this._callEndReason?{...extractCallEndReasonForTelemetry(this._callEndReason)}:void 0})}}_setCallRole(g){if(g!==this._lastTsCallAdvancedMeetingRole){let m=advancedMeetingRoleToParticipantRole(getAcsEcsConfig(),g);m===Oo?this.logger.log(`tsParticipant advancedMeetingRole=${this._role} had no mapping`):this.logger.log(`mapped tsParticipant advancedMeetingRole=${g}=>${m}`),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"role-changed",oldAcsRole:this._role,newAcsRole:m,serviceRole:g||""}),this._role!=m&&(this.logger.log(`self-role changed ${this._role}=>${g}`),this._role=m,this._lastTsCallAdvancedMeetingRole=g,this._capabilityResolver.resolveCapabilitiesBasedOnRole(),this._eventEmitter.emit("roleChanged"))}}_setMeetingCapabilities(g){hasCoreMeetingCapabilitiesChanged(g,this._lastTsCallMeetingDetails)&&(sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"meetingCapabilities-changed",oldMeetingDetails:this._lastTsCallMeetingDetails,newMeetingDetails:g}),this.logger.log(`Core Meeting Capabilities has changed to: ${JSON.stringify(g)}`),this._capabilityResolver.resolveCapabilitiesBasedOnMeetingCapabilities(),this._eventEmitter.emit("meetingCapabilitiesChanged")),Object.assign(this._lastTsCallMeetingDetails,g)}async audioSourceChanged(g){this._telemetryLogManager.sendEvent({name:Ah.acs_calling_local_audio_source_changed,tenant:Qa,properties:{callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:+new Date,correlationId:generateGuid(),localAudioStream:g.source?.source instanceof MediaStream?"MediaStream":"Device"}}),g.source instanceof AudioDeviceInfoImpl?(this.localAudioStreams[0]&&this.stopAudioInternal(!0),this._callAgent.tsStack?.getDeviceManager().selectDevices({microphone:g.source.id})):await this.startAudioInternal(g.source,!0)}removeRemoteAudioStream(g){if(g){this.logger.log("Attempting to remove remote audio stream");if(0===this._remoteAudioStreams.splice(this._remoteAudioStreams.indexOf(g),1).length)return void this.logger.warn("Stream not found, failed to remove stream from remoteAudioStreams collection");this.logger.log("remote audio stream removed successfully"),this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:[],removed:[g]})}}async setOrUpdateMediaMetricsDeviceEvents(){if(getAcsEcsConfig().calling.mediaMetricsDeviceEventsEnabled)try{const g=this.tsCall.getMediaSessionStats();if(void 0!==g?.metrics?.DeviceEvents){const m=JSON.parse(g.metrics.DeviceEvents),S=getSafeObjectDiff(this._mediaMetricsDeviceEvents||{},m);S.length>0&&(this._mediaMetricsDeviceEvents=m,this.stats.recordEvent({name:bh.media_metrics_device_events,callId:this.id,localParticipantId:this.tsCall.participantId,data:{metricsDeviceEvents:S||{},metricsDevicesChangeCount:m?.metrics_DevicesChangeCount||0,metricsDevicesCount:m?.metrics_DevicesCount||{}}}))}else this.logger.error("Failed to set media metrics device events telemetry: no valid events data")}catch(g){this.logger.error("Failed to set media metrics device events telemetry")}}setClientEndpointCapabilities(g){const m={};let S=0;return g?.firstPartyOptions?.isImmersiveMode&&(S|=32768),getAcsEcsConfig()?.calling?.supportLiveStreaming&&(S|=32),S>0&&(m.clientEndpointCapabilities=S),m}getLocalVideoStreamFromCallOptions(g){let m;if(Array.isArray(g?.videoOptions?.localVideoStreams)){if(1!==g?.videoOptions?.localVideoStreams.length)throw new CallingCommunicationError({defaultError:D.CALL.ONLY_SINGLE_VIDEO_STREAM});if(m=g?.videoOptions?.localVideoStreams[0],!(m instanceof LocalVideoStream))throw new CallingCommunicationError({defaultError:D.CALL.NOT_INSTANCE_OF_LVS})}return m}getLocalAudioStreamFromCallOptions(g){let m;if(Array.isArray(g?.audioOptions?.localAudioStreams)){if(1!==g?.audioOptions?.localAudioStreams.length)throw new CallingCommunicationError({defaultError:D.CALL.ONLY_SINGLE_AUDIO_STREAM});if(m=g?.audioOptions?.localAudioStreams[0],!(m instanceof LocalAudioStream))throw new CallingCommunicationError({defaultError:D.CALL.NOT_INSTANCE_OF_LAS})}return m}async _setRawStream(g,m){if(!getAcsEcsConfig().calling.allowAccessRawMediaStream)throw new CallingCommunicationError({defaultError:D.CALL.ACCESS_RAW_MEDIA_STREAM_DISABLED});const S=this._callAgent.tsStack?.getDeviceManager();if(!S?.setRawMediaStream)throw new CallingCommunicationError({defaultError:D.CALL.ACCESS_RAW_MEDIA_STREAM_UNDEFINED_FUNC});try{const v=await g.getMediaStream();if(!v)throw new CallingCommunicationError({defaultError:D.CALL.SS_RAW_STREAM_UNDEFINED});S.setRawMediaStream(v,m)}catch(g){if(1===m)throw new CallingCommunicationError({defaultError:D.CALL.VIDEO_SET_MEDIA_STREAM,originalError:g});if(2===m)throw new CallingCommunicationError({defaultError:D.CALL.SS_RAW_STREAM_SET,originalError:g})}}shallRemoveLvsAfterConnectedSuccessfully(g,m,S,v,C){if(this.tsCall.localMediaStreams.find((g=>1===g.mediaType)))this.sendVideoEvent({correlationId:S,eventName:Ah.acs_calling_start_video_success,timestampInfo:{deltaTimeInMs:v-C},localVideoStream:g,step:m,isScreenSharingOnFlag:this._isScreenSharingOn});else{if(!getAcsEcsConfig()?.calling?.removeLvsCheckOnCallStartAndCallAccept)return;this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream);const v=+new Date,_=new CallingCommunicationError({defaultError:D.CALL.VIDEO_FAILED_TO_START,defaultErrorMessageArgs:[m]});this.logger.error(_.message),this.sendVideoEvent({correlationId:S,eventName:Ah.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:v-C},localVideoStream:g,step:m,isScreenSharingOnFlag:this._isScreenSharingOn},_)}}shallRemoveLasAfterConnectedSuccessfully(g,m,S,v,C){if(this.tsCall.localMediaStreams.find((g=>0===g.mediaType)))this.sendRawMediaEvent({eventName:Ah.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Rh.success,localAudioStream:g,timestampInfo:{deltaTimeInMs:v-C},additionalDetails:""});else{if(!getAcsEcsConfig().calling.removeLocalAudioStreamCheckOnCallStartAndCallAccept)return;this.removeLocalAudioStream(this.localAudioStreams[0]);const v=+new Date;this.logger.error(`Removing local audio stream because audio failed to start during call-${m} process.`);const _=new CallingCommunicationError({defaultError:D.CALL.AUDIO_FAILED_TO_START,defaultErrorMessageArgs:[m]});this.sendRawMediaEvent({eventName:Ah.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,localAudioStream:g,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:v-C},additionalDetails:{failureReason:_.message||"",code:_.code,subCode:_.subCode,...extractCommunicationServicesErrorForTelemetry(_)}})}}_enableOrDisable_largeMeeting_videoRendering(){try{!this._isHandlingLargeMeetingVideoRendering&&this._totalParticipantCount-1>=getAcsEcsConfig().rendering.remoteVideo.largeMeeting.participantCountThreshold?(this._isHandlingLargeMeetingVideoRendering=!0,this._internalDominantSpeakersListener=new DominantSpeakersCallImplOverTsCall(new CallingEventEmitter(this.logger.createChild((()=>`DominanSpeakersFeatureInternal:: Call(id=${this.tsCall.callId})`)))),this._internalDominantSpeakersListener.initialize(this.tsCall,this._callAgent,this._telemetryLogManager,this.logger,!0),this.logger.info("Initialized internal dominant speakers listener"),this._internalDominantSpeakersListener.on("dominantSpeakersChanged",(()=>{this.handleDominantSpeakersVideos()})),this.handleDominantSpeakersVideos(),this.logger.info("Initialized large meeting video rendering handler")):this._isHandlingLargeMeetingVideoRendering&&(this._totalParticipantCount-1>=getAcsEcsConfig().rendering.remoteVideo.largeMeeting.participantCountThreshold?this.handleDominantSpeakersVideos():(this._isHandlingLargeMeetingVideoRendering=!1,this._internalDominantSpeakersListener?.dispose(),this._internalDominantSpeakersListener=void 0,this.logger.info("Disposed of internal dominant speakers listener"),this.remoteParticipants.forEach((g=>{g.videoStreams.forEach((g=>{g.setIsAvailable(g.tsStream.isAvailable)}))})),this.logger.info("All remote streams isAvailable flags were reset"),this.logger.info("Disposed large meeting video rendering handler")))}catch(g){this.logger.error("Failed to handle large meeting video rendering",g)}}isHiddenBot(g){if(isCallingApplication(g.id)){if(isGlobalCallingApplication(g.id))return!0;if(getAcsEcsConfig()?.calling?.blacklistedBots?.includes(g.id))return!0;if(g.endpoints?.endpointDetails&&g.endpoints?.endpointDetails.length>0)return g.endpoints?.endpointDetails[0].endpointMetadata?.__platform?.ui?.hidden}return!1}handleDominantSpeakersVideos(){this.logger.info("Dominant speakers changed during large meeting");const g=this.getTopNDominantSpeakersWithVideoOn();this.logger.info(`There are currently ${g.length} top-n speakers with video on in the large meeting`),g.forEach((g=>{g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).forEach((g=>{g.setIsAvailable(g.tsStream.isAvailable)}))})),this._remoteParticipants.filter((m=>!g.includes(m))).forEach((g=>{g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).forEach((g=>{try{g.setIsAvailable(!1)}catch(g){const m=new CallingCommunicationError({defaultError:D.CALL.LARGE_MEETING_FORCE_ISAVAILABLE,originalError:g});this.logger.warn(m.message)}const m=this.activeRemoteVideoStreamViews.get(g.id);m&&m.forEach((g=>{try{g.disposed||(g.dispose(uu.Internal_LargeMeetingVideoRendering),this.logger.info("Successfully disposed of view during large meeting"))}catch(g){const m=new CallingCommunicationError({defaultError:D.CALL.LARGE_MEETING_DISPOSE_VIEW,originalError:g});this.logger.warn(m.message)}}))}))}))}}__decorate$i([loggerProperty,__metadata$i("design:type",Object)],CallCommonImpl.prototype,"logger",void 0),__decorate$i([syncOperation($h.BindToCall),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",void 0)],CallCommonImpl.prototype,"bindTsCall",null),__decorate$i([syncOperation($h.Feature),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[Object]),__metadata$i("design:returntype","function"==typeof(Em="undefined"!=typeof TFeature&&TFeature)?Em:Object)],CallCommonImpl.prototype,"feature",null),__decorate$i([asyncOperation($h.HangUp),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[Object]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"hangUp",null),__decorate$i([asyncOperation($h.Mute),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"mute",null),__decorate$i([asyncOperation($h.Unmute),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"unmute",null),__decorate$i([asyncOperation($h.MuteAllRemoteParticipants),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"muteAllRemoteParticipants",null),__decorate$i([asyncOperation($h.MuteIncomingAudio),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"muteIncomingAudio",null),__decorate$i([asyncOperation($h.UnmuteIncomingAudio),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"unmuteIncomingAudio",null),__decorate$i([asyncOperation($h.SendDtmf),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[String]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"sendDtmf",null),__decorate$i([asyncOperation($h.StartVideo),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalVideoStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"startVideo",null),__decorate$i([asyncOperation($h.StopVideo),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalVideoStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"stopVideo",null),__decorate$i([asyncOperation($h.startAudio),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalAudioStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"startAudio",null),__decorate$i([validateEmergencyCallOperation($h.Hold),asyncOperation($h.Hold),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"hold",null),__decorate$i([validateEmergencyCallOperation($h.Resume),asyncOperation($h.Resume),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"resume",null),__decorate$i([asyncOperation($h.StartScreenShare),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalVideoStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"startScreenSharing",null),__decorate$i([asyncOperation($h.StopScreenShare),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"stopScreenSharing",null),__decorate$i([asyncOperation($h.SetConstraints),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[Object]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"setConstraints",null);var __decorate$j=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$j=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallImpl extends CallCommonImpl{get info(){return this._info}constructor(m,S,v,C){super(m,S,v,C,g.CallKind.Call),this._info=new CallInfoImpl(v,{roomId:m.roomId}),this._info.initialize(this._eventEmitter,this.logger,this._telemetryLogManager)}dispose(){super.dispose(),this._extensibleApi.dispose()}addParticipant(g,m){let v,C;const _=m,E=m,T=m,I=+new Date,b=generateGuid();if(this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.attempt,participantAddedOrRemoved:"add",correlationId:b,timestampInfo:{attemptTimestamp:I}}),this._callAgent.isCteUser()){this.validateThreadId(g,m);switch(S.getIdentifierKind(g).kind){case"communicationUser":C=_.threadId;break;case"microsoftTeamsUser":C=T.threadId;break;case"phoneNumber":C=E.threadId;break;default:{const g=new CallingCommunicationError({defaultError:D.CALL.ADD_UNKNOWN});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:b,timestampInfo:{deltaTimeInMs:+new Date-I},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g)}}),g}}}let A;E?.alternateCallerId&&(validateIdentifier(E.alternateCallerId),v=getMriFromIdentifier(E.alternateCallerId));try{if(A=validateIdentifier(g),!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!1,A))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN})}catch(g){throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:b,timestampInfo:{deltaTimeInMs:+new Date-I},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g)}}),g}if(this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))){const m=new CallingCommunicationError({defaultError:D.CALL.PARTICIPANT_ALREADY_IN_CALL,defaultErrorMessageArgs:[S.getIdentifierKind(g).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:b,timestampInfo:{deltaTimeInMs:+new Date-I},additionalDetails:{code:m.code,failureReason:m.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}getAcsEcsConfig().calling.enableSmePassFakeConversation&&!C&&g&&IsAdhocInteropCall([g])&&(C=this.tsCall.threadId||`${x}${generateGuid()}`);const R=this.getOrCreateRemoteParticipant(constructIdentifierKindFromMri(getMriFromIdentifier(g)));return this.tsCall.addParticipant(getMriFromIdentifier(g),{alternateId:v,threadId:C}).then((()=>{this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.success,participantAddedOrRemoved:"add",correlationId:b,timestampInfo:{deltaTimeInMs:+new Date-I}})})).catch((m=>{const{callEndReason:S}=getRemoteParticipantCallEndReason(this,R.tsRemoteParticipant,m);R.callEndReason||R.setCallEndReason(S);const v=extractCallEndReasonForTelemetry(S);this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:b,timestampInfo:{deltaTimeInMs:+new Date-I},additionalDetails:{code:v?.callEndReason.code,subCode:v?.callEndReason.subCode,failureReason:v?.callEndReason.message,...v}}),this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))&&(this.deleteRemoteParticipant(R),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[R]}))})),R}async removeParticipant(g,m){const v=+new Date,C=generateGuid();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.attempt,participantAddedOrRemoved:"remove",correlationId:C,timestampInfo:{attemptTimestamp:v}});try{validateIdentifier(g)}catch(g){const m=new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_INVALID_IDENTIFIER,originalError:g});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"remove",correlationId:C,timestampInfo:{deltaTimeInMs:+new Date-v},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}let _=this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));if(!_){const m=new CallingCommunicationError({defaultError:D.CALL.PARTICIPANT_NOT_IN_CALL,defaultErrorMessageArgs:[S.getIdentifierKind(g).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"remove",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date},additionalDetails:{code:m.code,subCode:m.subCode,failureReason:m.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}try{await this.tsCall.removeParticipant(getMriFromIdentifier(g)),this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.success,participantAddedOrRemoved:"remove",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date}})}catch(g){const m=getRemoteParticipantCallEndReason(this,_.tsRemoteParticipant,g).callEndReason;_.callEndReason||_.setCallEndReason(m);const S=extractCallEndReasonForTelemetry(m);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"remove",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date},additionalDetails:{code:S?.callEndReason.code,subCode:S?.callEndReason.subCode,failureReason:S?.callEndReason.message,...S}}),new CallingCommunicationError({defaultError:{message:m.message,code:m.code,subCode:m.subCode||0,resultCategories:m.resultCategories},originalError:g})}}validateThreadId(g,m){if(!m?.threadId)throw new CallingCommunicationError({defaultError:D.CALL.CTE_ADDPARTICIPANT_NO_THREAD_ID})}}__decorate$j([syncOperation($h.AddParticipant),__metadata$j("design:type",Function),__metadata$j("design:paramtypes",[Object,Object]),__metadata$j("design:returntype",Object)],CallImpl.prototype,"addParticipant",null),__decorate$j([asyncOperation($h.RemoveParticipant),__metadata$j("design:type",Function),__metadata$j("design:paramtypes",[Object,Object]),__metadata$j("design:returntype",Promise)],CallImpl.prototype,"removeParticipant",null);var __decorate$k=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$k=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class IncomingCallCommonImpl{get kind(){return this._kind}get id(){return this._callCommon.id}get callerInfo(){return this._callCommon.callerInfo}get callEndReason(){return this._callCommon.callEndReason}constructor(g,m){this._callCommon=g,this._eventEmitter=new Su.EventEmitter,this._kind=m,this._callConnected="Connected"===this._callCommon.state,this._callCommon.on("stateChanged",(()=>{"Connected"===this._callCommon.state?this._callConnected=!0:"Disconnected"!==this._callCommon.state||this._callConnected||this._eventEmitter.emit("callEnded",{callEndReason:this._callCommon.callEndReason})}))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}reject(){return this._callCommon.reject()}}__decorate$k([asyncOperation(),__metadata$k("design:type",Function),__metadata$k("design:paramtypes",[]),__metadata$k("design:returntype",Promise)],IncomingCallCommonImpl.prototype,"reject",null);var __decorate$l=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$l=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class IncomingCallImpl extends IncomingCallCommonImpl{get info(){return this._call.info}constructor(m){super(m,g.IncomingCallKind.IncomingCall),this._call=m}async accept(g){if("microsoftTeamsUser"===this.info?.initiatorKind&&!isProxyAndCustomTurnAllowed(this._call.acsProxy,this._call.acsCustomRelayManager,!0))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});return await this._call.accept(g),this._call}}__decorate$l([asyncOperation($h.Accept),__metadata$l("design:type",Function),__metadata$l("design:paramtypes",[Object]),__metadata$l("design:returntype",Promise)],IncomingCallImpl.prototype,"accept",null);class HttpRequestHelper{constructor(g,m){this.logger=g,this.proxy=m}async sendRequestWithRetry(g,m,S,v,C,_=1,E){if(_>C)throw new Error("Max retry reached");v.timeout||(v.timeout=2e4),v.maxRedirects=0,this.proxy&&(m=this.proxy.proxyfyUrl(m));try{switch(g){case"post":default:return await jp.post(m,S,v);case"get":return await jp.get(m,v);case"put":return await jp.put(m,S,v);case"delete":return await jp.delete(m,v)}}catch(T){let I=T?.response?.status;this.logger.error(`Found error for request ${g} ${m} ${I||""}`);const b=_+1;if(b<=C){let _=m;if(T&&T.response)if(301===T.response.status||302===T.response.status||303===T.response.status||307===T.response.status||404===T.response.status)_=T.response.headers&&T.response.headers.location?T.response.headers.location:_;else if(T.response.status<500)throw T;return this.logger.error(`Retrying, attempt #${b} url=${_}`),await new Promise((g=>setTimeout(g,E))),this.sendRequestWithRetry(g,_,S,v,C,b,E)}throw T}}}const Tm={callNotification:"callNotification",conversationInvitation:"conversationInvitation",debugContent:"debugContent",groupContext:"groupContext"};class IncomingCallPushNotificationHandler{get callId(){return this._callId}get localParticipantId(){return this._localParticipantId}constructor(g,m,S){if(this._callId="",this._localParticipantId="",this._logger=S.createChild("IncomingCallPushNotificationHandler"),!g.incomingCallContext)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD_NO_CONTEXT_PROVIDED});if(Object.keys(g).length>1)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_NO_PAYLOAD});if(this._payload=g,this._incomingCallContext=this._payload.incomingCallContext,this._tsCallRegistry=m,this._gp=JSON.parse(Eh.inflate(atob(this._incomingCallContext),{to:"string"})),!(this._gp.hasOwnProperty(Tm.callNotification)&&this._gp.hasOwnProperty(Tm.conversationInvitation)&&this._gp.hasOwnProperty(Tm.debugContent)&&this._gp.hasOwnProperty(Tm.groupContext)))throw this._logger.error(`Missing incoming call context data. Found: ${Object.keys(this._gp)}`),new CallingCommunicationError({defaultError:D.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD});this._callId=this._gp.debugContent.callId,this._localParticipantId=this._gp.debugContent.participantId}async process(){try{if(this._tsCallRegistry.calls.some((g=>g.callId==this._callId)))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_ALREADY_PROCESSED});const g=defer$1(),callAddedListener=m=>{const checkNotified=()=>{m.callId===this._callId&&m.participantId===this._localParticipantId&&1===m.state&&g.resolve()};this._tsCallStateSub=m.on("callStateChanged",checkNotified),checkNotified()};this._tsCallRegistrySub=this._tsCallRegistry.on("callAdded",callAddedListener);const m={eventId:Io,body:{gp:this._gp}};if(!this._tsCallRegistry.incomingCallMessageHandler.handleMessage(m))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_FAILED_TO_PROCESS});setTimeout((()=>{g.isPending()&&g.reject(new CallingCommunicationError({defaultError:D.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_CALL_MISSED}))}),5e3),await g.promise}catch(g){throw g}finally{this._tsCallRegistrySub?.dispose(),this._tsCallStateSub?.dispose()}}}const Im=0,bm=220004,Am=220005;class AcsMiddleTierPolicyService{constructor(g){this._httpRequestHelper=g,this._isPolicyFetchApplicable=!1,this._policySettingData={};const S=m.createClientLogger("ACS");this._logger=new DefaultLogger(S)}initialize(g){this._localParticipant=g.localParticipant,this._skypeToken=g.skypeToken,this._userDialedPstnNumber=g.pstnNumber,this._emergencyNumber=this._userDialedPstnNumber,this._telemetryLogManager=g.telemetryLogManager}async fetchUserPoliciesFromAcsMiddleTier(g,m,S){this._callId=g,this._participantId=m;let v="",C={};const _=+new Date;if(this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.attempt,timestampInfo:"",additionalDetails:""}),!this._localParticipant){const g=+new Date,m=new CallingCommunicationError({defaultError:D.CTE_MID_TIER_POLICY_SERVICE.TEAMS_USER_ID_NOT_PROVIDED});throw this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:g-_},additionalDetails:{failureReason:m.message,code:m.code,subCode:m.subCode,...extractCommunicationServicesErrorForTelemetry(m)}}),m}if(S){let g=S.policyUrlSuffix;v=0==g.indexOf("/")?getAcsEcsConfig().MiddleTier.baseServiceUrl+g:getAcsEcsConfig().MiddleTier.baseServiceUrl+"/"+g,C={id:this._localParticipant,userPolicies:S.userPolicies,userProperties:S.userProperties}}else v=getAcsEcsConfig().MiddleTier.baseServiceUrl+getAcsEcsConfig().MiddleTier.policyUrlSuffix,C={id:this._localParticipant};const E=this.getAmtRequestHeader();try{let g=await this._httpRequestHelper.sendRequestWithRetry("post",v,C,{headers:E},getAcsEcsConfig().MiddleTier.maxRetry);this._policySettingData=g?.data;const m=+new Date;this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:m-_},additionalDetails:{phrase:"Teams user policy was fetched successfully from ACS MiddleTier Service",code:Im,subCode:bm}})}catch(g){const m=+new Date,S=handleFetchPoliciesFromAcsMiddleTierFailure(g,D.CTE_MID_TIER_POLICY_SERVICE.FETCH_POLICY);throw this._logger.error(S.message),this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:m-_},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)}}),S}}isEvEnabled(){let g=this._policySettingData?.userAggregatedPolicySettingData?.userProperties;return g?.evEnabled||!1}isMoHEnabled(){let g=this._policySettingData?.userAggregatedPolicySettingData?.userPolicies?.teamsCallingPolicy,m=g?.musicOnHoldEnabledType;return this._logger.info("Checking Music on Hold Policy, Enabled Type is: "+m),m===(su.Enabled||su.UserOverride)}getTeamsUserCaptionsPoliciesData(){const g=+new Date;let m="";this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.attempt,timestampInfo:"",additionalDetails:""});let S=this._policySettingData.userAggregatedPolicySettingData,v=S?.userPolicies,C=S?.userProperties;if(!v?.teamsCallingPolicy){const m=+new Date,S=new CallingCommunicationError({defaultError:D.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_CALLINGPOLICY_FETCHING_FAILED});this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:m-g},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)}})}if(!v?.teamsMeetingPolicy){const m=+new Date,S=new CallingCommunicationError({defaultError:D.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_MEETINGPOLICY_FETCHING_FAILED});this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:m-g},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)}})}if(!C?.featureTypes){const m=+new Date,S=new CallingCommunicationError({defaultError:D.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_FEATURETYPE_TEAMSPROMGMT_FETCHING_FAILED});this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:m-g},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)}})}if(v?.teamsCallingPolicy||v?.teamsMeetingPolicy||C?.featureTypes?.includes(tl.TeamsProMgmt)){m=JSON.stringify({isLiveCaptionsEnabledForCalling:v?.teamsCallingPolicy?.liveCaptionsEnabledTypeForCalling===il.DisabledUserOverride,isLiveCaptionsEnabledForMeeting:v?.teamsMeetingPolicy?.liveCaptionsEnabledType===il.DisabledUserOverride,isTeamsProMgmtSkuAvailable:C?.featureTypes?.includes(tl.TeamsProMgmt)??!1});const S=+new Date;this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{phrase:"Fetching Captions policy from ACS MiddleTier Service response was successful",code:Im}}),this._logger.info(`Fetching user's captions policy content = ${m}`)}return m}getEmergencyContent(){const g=+new Date;this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.attempt,timestampInfo:"",additionalDetails:""});let m="";try{let S=this._policySettingData.userAggregatedPolicySettingData,v=S?.userPolicies,C=!1,_="";if(v?.locationPolicy?.emergencyNumbers){let g=v.locationPolicy.emergencyNumbers||[];this.isPhoneNumberInLocationPolicy(g)&&(C=!0,m=JSON.stringify({enableSecurityMemberNotifications:this.isSecurityDeskEnabled(),callerLocation:S?.userProperties.region,locationPolicyTag:v?.locationPolicy?.policyDocument,teamsEmergencyCallingPolicyTag:v?.teamsEmergencyCallingPolicy?.policyDocument}),_="LocationPolicy")}if(!C&&v?.teamsEmergencyCallRoutingPolicy){let g=v?.teamsEmergencyCallRoutingPolicy?.emergencyNumbers||[];this.isPhoneNumberInTeamsEmergenencyRoutingPolicy(g)&&(C=!0,m=JSON.stringify({enableSecurityMemberNotifications:this.isSecurityDeskEnabled(),callerLocation:S?.userProperties.region,teamsEmergencyCallRoutingPolicyTag:v?.teamsEmergencyCallRoutingPolicy?.policyDocument,teamsEmergencyCallingPolicyTag:v?.teamsEmergencyCallingPolicy?.policyDocument}),_="TeamsEmergencyCallingRoutingPolicy")}const E=C?`Created Emergency policy using ${_}`:"This is NOT an emergency call",T=+new Date;return this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:T-g},additionalDetails:{phrase:"Deriving Emergency policy from ACS MiddleTier Service response was successful",code:Im,subCode:Am}}),this._logger.info(`Deriving emergency policy message = ${E}. Emergency Content = ${m}`),m}catch(m){const S=+new Date,v=new CallingCommunicationError({defaultError:D.CTE_MID_TIER_POLICY_SERVICE.DERIVE_EMERGENCY_POLICY,originalError:m});throw this.sendMiddleTierPolicyEvent({eventName:Ah.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)}}),v}}isFetchUserPoliciesAndSettingsApplicable(g,m){return isNullOrUndefined$2(g)||isNullOrUndefined$2(m)||(this._isPolicyFetchApplicable=this.verifyFetchUserPoliciesSettings(g,m)),this._isPolicyFetchApplicable}getEmergencyNumber(){return this._emergencyNumber}getUserDialedPstnNumber(){return this._userDialedPstnNumber}getUserPolicy(){return this._policySettingData.userAggregatedPolicySettingData?.userPolicies}isPhoneNumberInLocationPolicy(g){if(!isNullOrUndefined$2(g))for(let m of g)if(m.dialString===this._userDialedPstnNumber||!isNullOrUndefined$2(m.dialMask?.split(";").find((g=>g===this._userDialedPstnNumber))))return this._emergencyNumber=m.dialString,!0;return!1}isPhoneNumberInTeamsEmergenencyRoutingPolicy(g){if(!isNullOrUndefined$2(g))for(let m of g)if(m.emergencyDialString===this._userDialedPstnNumber||!isNullOrUndefined$2(m.emergencyDialMask?.split(";").find((g=>g===this._userDialedPstnNumber))))return this._emergencyNumber=m.emergencyDialString,!0;return!1}verifyFetchUserPoliciesSettings(g,m){let v=getAcsEcsConfig().MiddleTier;return v.enabled?v.userPolicySettingsApi?g?Array.isArray(m)&&(m.length>1||!S.isPhoneNumberIdentifier(m[0]))?(this._logger.info("Target particpant (Callee) is not a PSTN Number"),!1):Array.isArray(m)||S.isPhoneNumberIdentifier(m)?(this._logger.info("Teams user is eligible to fetch policies and settings from MiddleTier Service "),!0):(this._logger.info("Target particpant (Callee) is not a PSTN Number"),!1):(this._logger.info("Originator (Caller) is not a Teams User"),!1):(this._logger.info("ACS MiddleTier Policy API is disabled"),v.userPolicySettingsApi):(this._logger.info("ACS MiddleTier service is disabled"),v.enabled)}isSecurityDeskEnabled(){let g=this._policySettingData.userAggregatedPolicySettingData?.userPolicies?.teamsEmergencyCallingPolicy;return!(isNullOrUndefined$2(g?.notificationGroup)&&isNullOrUndefined$2(g?.notificationDialOutNumber)||0==g?.notificationGroup?.trim().length&&0==g?.notificationDialOutNumber?.trim().length)}getAmtRequestHeader(){return{"Content-Type":"application/json","X-Skypetoken":this._skypeToken||"","Access-Control-Allow-Origin":"*","X-Microsoft-Skype-Chain-ID":this._callId}}sendMiddleTierPolicyEvent(g){try{this._telemetryLogManager?.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this._logger.debug("Unable to send AcsMiddleTierPolicyService telemetry")}}}var Rm,__decorate$m=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$m=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let Pm=1;class CallAgentCommonImpl{get kind(){return this._kind}get connectionState(){return this._connectionState}constructor(g,m,S,v,C,_,E){this._callClient=g,this._disposed=!1,this.tokenProvider=async g=>{const m=+new Date;let S;try{if(this.sendTokenChangedEvent({kindOfEvent:"attempt",timestampInfo:{attemptTimestamp:m},oldTokenExpiration:this._oldTokenExpiration}),!this._communicationTokenCredential)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.GET_TOKEN_BEFORE_INIT});S=await parseTokenCredential(this._communicationTokenCredential,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal}),S.acsResourceId===this._parsedTokenCredential?.acsResourceId&&S.identityMri===this._parsedTokenCredential?.identityMri||logErrorAndThrow(D.CALL_AGENT.REFRESHED_TOKEN_INVALID_USERID,this.logger),g?this._tokenFetchTries+=1:this._tokenFetchTries=0,this._tokenFetchTries>this._maxNmberOfRetries&&(this.updateConnectionState("invalidToken"),this._disposed||await this.dispose(),logErrorAndThrow(D.CALL_AGENT.REFRESHED_TOKEN_RETRIES,this.logger));const v=+new Date;return this.sendTokenChangedEvent({kindOfEvent:"success",timestampInfo:{deltaTimeInMs:v-m},oldTokenExpiration:this._oldTokenExpiration,newTokenExpiration:S.exp,isTokenChanged:this._oldToken!==S.jwtToken}),this._oldToken=S.jwtToken,this._oldTokenExpiration=S.exp,S.jwtToken}catch(g){const v={kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-m},oldTokenExpiration:this._oldTokenExpiration};throw S&&(v.newTokenExpiration=S.exp,v.isTokenChanged=this._oldToken!==S.jwtToken,this._oldToken=S.jwtToken,this._oldTokenExpiration=S.exp),this.sendTokenChangedEvent(v,g),g}},this.sendTokenChangedEvent=(g,m)=>{try{let S={kindOfEvent:g.kindOfEvent,timestampInfo:g.timestampInfo,oldTokenExpiration:g.oldTokenExpiration};void 0!==g.newTokenExpiration&&(S.newTokenExpiration=g.newTokenExpiration),void 0!==g.isTokenChanged&&(S.isTokenChanged=g.isTokenChanged),m&&(S={...S,...extractCommunicationServicesErrorForTelemetry(m)}),this._telemetryLogManager.sendEvent({name:Ah.acs_calling_token_expiration_changed,tenant:Qa,properties:S})}catch(g){this.logger.debug("Unable to send token change telemetry")}},this.logger=m.createChild("CallAgent"+Pm++),this._telemetryLogManager=v,this._kind=_,this._connectionState="Connected",this._eventEmitter=new CallingEventEmitter(this.logger),this.clientId=S,this._abortController=new AbortController,this._maxDisplayNameLength=getAcsEcsConfig()?.calling?.maxDisplayNameLength||Co,this._oldToken="",this._oldTokenExpiration=0,this._tokenFetchTries=0,this._maxNmberOfRetries=getAcsEcsConfig()?.calling?.maxNumberOfTokenFetchRetries||uo,this._callStack=C,this.acsProxy=this._callClient.acsProxy,this.acsCustomRelayManager=this._callClient.acsCustomRelayManager,this._httpRequestHelper=new HttpRequestHelper(this.logger,this.acsProxy),this.mtPolicyService=new AcsMiddleTierPolicyService(this._httpRequestHelper),this._parsedTokenCredential={jwtToken:"",acsResourceId:void 0,identityMri:"",cloudType:ta.Public,isCte:!1,region:"",rgnClaimExists:!1,exp:0},this._caConfigBag={clientId:"",acsResourceId:this._parsedTokenCredential.acsResourceId,identityMri:this._parsedTokenCredential.identityMri,cloudType:this._parsedTokenCredential.cloudType,identityType:this._parsedTokenCredential.isCte?la.Enterprise:la.Consumer,region:this._parsedTokenCredential.region,emergencyCountryCode:void 0,IsUserEmergencyCountryCode:!1},this.deviceManager=E,this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{callClient:this._callClient,callAgent:this},{tsStack:this.tsStack,callAgent:this,telemetryLogManager:this._telemetryLogManager});const T=getRegisteredFeatures(Cu.CallAgentFeature);for(const g of T)"OnExtendedObjectConstructor"===g.activationOptions.activationEvent&&this.feature(g);this._trouterStateChangeCallback=g=>{this.logger.log(`Callback Trouter state changed to ${g}`),this.updateConnectionState("trouterChanged")},this._registrarStateChangeCallback=g=>{this.logger.log(`Callback Registrar state changed to ${g}`),this.updateConnectionState("registrarChanged")}}getHttpRequestHelper(){return this._httpRequestHelper}getTrouterState(){return this._callStack?this._callStack.getTrouterState():"Unknown"}onTrouterStateChanged(g){return this._callStack.onTrouterStateChanged(g)}offTrouterStateChanged(g){return this._callStack.offTrouterStateChanged(g)}getAcsResourceId(){return this._parsedTokenCredential?.acsResourceId||""}getUserMri(){return`8:${this._parsedTokenCredential?.identityMri}`||""}getUserPolicy(){return this._userPolicies}async initialize(m,S,v){const C=+new Date;try{if(this.sendCallAgentInitializiedEvent(Ah.acs_calling_call_agent_init_attempt,{attemptTimestamp:C}),this._communicationTokenCredential=m,this._parsedTokenCredential=await parseTokenCredential(m,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal}),this._kind!==g.CallAgentKind.TeamsCallAgent||this._parsedTokenCredential.isCte?this._kind===g.CallAgentKind.CallAgent&&this._parsedTokenCredential.isCte&&logErrorAndThrow(D.CALL_AGENT.ACS_CALLAGENT_TOKEN_ONLY,this.logger):logErrorAndThrow(D.CALL_AGENT.TEAMS_CALLAGENT_TOKEN_ONLY,this.logger),v?.displayName){if(this._parsedTokenCredential.isCte)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.CTE_DISPLAY_NAME});if(v?.displayName.length>this._maxDisplayNameLength)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.DISPLAY_NAME_TOO_LONG})}if(this._parsedTokenCredential.cloudType===ta.Public&&(!this._parsedTokenCredential.region||""===this._parsedTokenCredential.region)){try{const g=+new Date-C;this._telemetryLogManager.sendEvent({name:Ah.acs_calling_token_has_no_data_location,tenant:Qa,properties:{deltaTimeInMs:g}})}catch(g){this.logger.debug("Unable to send token has no data location assigned")}this._parsedTokenCredential.region=this._parsedTokenCredential.rgnClaimExists?da[0]:ca[0],this.logger.info("Used default data location because token has no data location assigned")}this._caConfigBag={clientId:this.clientId,acsResourceId:this._parsedTokenCredential.acsResourceId,identityMri:this._parsedTokenCredential.identityMri,cloudType:this._parsedTokenCredential.cloudType,identityType:this._parsedTokenCredential.isCte?la.Enterprise:la.Consumer,emergencyCountryCode:v?.emergencyCallOptions?.countryCode,region:this._parsedTokenCredential.region,IsUserEmergencyCountryCode:!!v?.emergencyCallOptions?.countryCode},this.addToCallAgentsMap(this._parsedTokenCredential),this.onDisposedCallback=S,this._disposed=!1;try{this.runningEnvironmentInfo=await this._callClient.getEnvironmentInfoInternal()}catch(g){this.logger.debug("Unable to get the running environment info")}if(this.tsStack=await this._callStack.initializeStackForUser(this.tokenProvider,this._caConfigBag),this._parsedTokenCredential.rgnClaimExists)try{await this.updateParsedTokenCredentials(m)}catch(g){this.logger.debug(`Failed to update parsed token credentials. Error message = ${g?.message||""}`)}this._telemetryLogManager.initialize(this._caConfigBag),this._tsCallRegistry=await this.initializeCallRegistry(this.tsStack,v),this.registerConnectionStateEventHandlers();const _=+new Date;this.sendCallAgentInitializiedEvent(Ah.acs_calling_call_agent_init_success,{deltaTimeInMs:_-C})}catch(g){this._caConfigBag&&!this._telemetryLogManager.isInitialized()&&this._telemetryLogManager.initialize(this._caConfigBag);const m=new CallingCommunicationError({defaultError:D.CALL_AGENT.INIT_FAIL,originalError:g});this.removeFromCallAgentsMap(this._parsedTokenCredential);const S=+new Date;throw this.sendCallAgentInitializiedEvent(Ah.acs_calling_call_agent_init_failure,{deltaTimeInMs:S-C},m),this._telemetryLogManager.clearTelemetryLoggers(),m}}isCteUser(){return void 0!==this._parsedTokenCredential?.isCte&&this._parsedTokenCredential?.isCte}getClientId(){return this.clientId}getCallByCallId(g,m){return m?this._tsCallRegistry.getCall(g,m):this._tsCallRegistry.calls.filter((m=>m.callId===g))?.[0]}createTransferTargetCall(g){const m=M.generateCauseId(),S=generateGuid(),v=generateGuid(),C=this._tsCallRegistry.createCall("",S,v,void 0,m),_=this.createNewCall(S,C);return this.addToCallArray(_),this.handleCallState(_),C.addParticipant(g.targetMri).catch((()=>{this.logger.error("Failed to add participant for transer call")})),_.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[_],removed:[]}),_}getEcsConfigIds(){return this._callStack.getEcsConfigIds()}feature(g){return this._extensibleApi.getApiObjectInstance(g.callAgentApiCtor)}async handlePushNotification(g){const m=generateGuid(),S=+new Date;let v;try{if(this.sendHandlePushNotificationEvent({eventName:Ah.acs_calling_handle_push_notification,correlationId:m,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:"",localParticipantId:"",kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),!g.incomingCallContext)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INVALID_PUSH_NOTIFICAITON_DATA});v=new IncomingCallPushNotificationHandler(g,this._tsCallRegistry,this.logger),await v.process(),this.sendHandlePushNotificationEvent({eventName:Ah.acs_calling_handle_push_notification,correlationId:m,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:v.callId,localParticipantId:v.localParticipantId,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-S},additionalDetails:""})}catch(g){const C=new CallingCommunicationError({defaultError:D.CALL_AGENT.PUSH_NOTIFICAITON_FAIL,originalError:g});throw this.sendHandlePushNotificationEvent({eventName:Ah.acs_calling_handle_push_notification,correlationId:m,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:v?.callId||"",localParticipantId:v?.localParticipantId||"",kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-S},additionalDetails:{failureReason:C.message,code:C.code,...extractCommunicationServicesErrorForTelemetry(C)}}),C}}getDeviceType(){const g=this._callClient?.firstPartyOptions?.acsDeviceType;return g?Ko[g]:"default"}trackCallEndTimeToStopTelemetry(g){0===g.length?TelemetryLogManager.callEndTimestamp=Date.now():TelemetryLogManager.callEndTimestamp=Number.MAX_SAFE_INTEGER}updateConnectionState(g){const m=this.getCallAgentConnectionState(),S=this.getTrouterState(),v=this._callStack?.isRegistered()?"Connected":"Disconnected",C="Connected"===m?void 0:"invalidToken"==g?"invalidToken":"connectionIssue";if(this.sendCallAgentInfoEvent({eventName:Ah.acs_calling_call_agent,additionalDetails:{step:"connectionState-changed",oldState:this._connectionState,newState:m,trouterState:S,registrarState:v,reason:C,connectionStateSource:g}}),m!==this._connectionState||C!==this._connectionStateReason){const g={oldValue:this._connectionState,newValue:m,reason:C};this._connectionState=m,this._connectionStateReason=C,this._eventEmitter.emit("connectionStateChanged",g)}}sendCallAgentInfoEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:{...g.additionalDetails}})}catch(g){this.logger.debug("Failed to send connection state changed event",g)}}sendCallAgentInitializiedEvent(g,m,S){try{let v="string"==typeof S?.message?S?.message:void 0;g!==Ah.acs_calling_call_agent_init_failure&&(v=void 0);const C=S?extractCommunicationServicesErrorForTelemetry(S):void 0;this._telemetryLogManager.sendEvent({name:g,tenant:Qa,properties:{...m,isSupportedEnvironment:this.runningEnvironmentInfo?.isSupportedEnvironment,failureReason:v,additionalInformation:{trouterState:this.getTrouterState()},additionalDetails:{...C}}})}catch(g){this.logger.debug("Unable to send telemtery")}}sendHandlePushNotificationEvent(g){try{this._telemetryLogManager?.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send handle push notification telemetry")}}async initializeCallRegistry(g,m){const S=m?.displayName,v=await this.getCallRegistry(g,this._parsedTokenCredential,this.tokenProvider,S);return this.logger.info(`registry created for version number=${getSdkVersion()}`),v}async getCallRegistry(g,m,S,v){const C={id:m.identityMri,displayName:v||"",tokenProvider:S},_=await g.createCallRegistry(C);await _.login(C);const E=getAcsEcsConfig()?.tsCalling?.accountConfiguration?.ring||void 0,T=m.isCte?la.Enterprise:la.Consumer,I=m.acsResourceId,b=m.region;let A={acsResourceId:I,clientType:T,ring:E};getAcsEcsConfig().calling.setDeviceType&&(A.deviceType=this.getDeviceType());const R=getAcsEcsConfig().calling.eudb;return R.isEnabled&&R.sendRegionToNgc&&(R.isRgnClaimEnabledForACS||m.isCte)&&(A={...A,region:b}),getAcsEcsConfig()?.calling.supportLiveStreaming&&(A.clientSupportsUms=!0),_.setConfiguration(A),_.on("callAdded",this.handleCallAdded),_.on("callRemoved",this.handleCallRemoved),v&&_.updateDisplayName(v),_}async updateParsedTokenCredentials(g){this._parsedTokenCredential=await parseTokenCredential(g,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal}),this._caConfigBag.region=this._parsedTokenCredential.region}registerConnectionStateEventHandlers(){this._callStack.onRegisteredChanged(this._registrarStateChangeCallback),this.onTrouterStateChanged(this._trouterStateChangeCallback)}getCallAgentConnectionState(){return this._callStack?.isRegistered()&&"Connected"===this.getTrouterState()?"Connected":"Disconnected"}}__decorate$m([loggerProperty,__metadata$m("design:type",Object)],CallAgentCommonImpl.prototype,"logger",void 0),__decorate$m([asyncOperation(Hh.Initialize),__metadata$m("design:type",Function),__metadata$m("design:paramtypes",[Object,Function,Object]),__metadata$m("design:returntype",Promise)],CallAgentCommonImpl.prototype,"initialize",null),__decorate$m([syncOperation(Hh.Feature),__metadata$m("design:type",Function),__metadata$m("design:paramtypes",[Object]),__metadata$m("design:returntype","function"==typeof(Rm="undefined"!=typeof TFeature&&TFeature)?Rm:Object)],CallAgentCommonImpl.prototype,"feature",null),__decorate$m([asyncOperation(Hh.HandlePushNotification),__metadata$m("design:type",Function),__metadata$m("design:paramtypes",[Object]),__metadata$m("design:returntype",Promise)],CallAgentCommonImpl.prototype,"handlePushNotification",null);var __decorate$n=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$n=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};const Mm=new Map;class CallAgentImpl extends CallAgentCommonImpl{get calls(){return this._calls}constructor(m,S,v,C,_,E,T){super(m,S,C,_,v,g.CallAgentKind.CallAgent,E),this._calls=[],this.handleCallRemoved=g=>{this.logger.info(`removing callId=${g.callId}`);const m=this._calls.find((m=>m.id===g.callId));if(m){const g=this._calls.indexOf(m);-1!==g&&this._calls.splice(g,1),m.dispose(),this.trackCallEndTimeToStopTelemetry(this._calls),this._eventEmitter.emit("callsUpdated",{added:[],removed:[m]}),this.logger.info("call removed")}},this.handleCallAdded=g=>{if(!this._calls.find((m=>m.id===g.callId))){const m=g.on("callStateChanged",(()=>{if(1===g.state){const S=g.callId;m.dispose();const v=new CallImpl({callId:S,isIncoming:!0},this,g,this._telemetryLogManager),C=new IncomingCallImpl(v);this.handleCallState(v),v.bindTsCall(),this._eventEmitter.emit("incomingCall",{incomingCall:C})}}))}},this.handleCallState=g=>{g.on("stateChanged",(()=>{try{if("Disconnected"===g.state){this.tsStack?(this._tsCallRegistry.deleteCall(g.tsCall)||this.logger.error(`Failed to remove call from registry, call id: ${g.id}`),g.stats.flushEvents(),this._telemetryLogManager.flushAllEvents(g.id).catch((()=>{this.logger.error("Failed to flush telemetry log manager events")}))):this.logger.info("Unable to remove call from registry")}else"Connecting"===g.state&&"Incoming"==g.direction&&(this.addToCallArray(g),this._eventEmitter.emit("callsUpdated",{added:[g],removed:[]}))}catch(g){this.logger.error("Failed to handle call state changed event")}}))},this.displayName=T?.displayName}addToCallAgentsMap(g){Mm.get(g?.identityMri)&&logErrorAndThrow(D.CALL_AGENT.ACS_CALLAGENT_ALREADY_EXSISTS,this.logger),Mm.set(g?.identityMri,this)}removeFromCallAgentsMap(g){g?.identityMri&&Mm.get(g?.identityMri)===this&&Mm.delete(g?.identityMri)}async getExistingCallAgentWithToken(g){try{const m=await parseTokenCredential(g,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS);return Mm.get(m.identityMri)}catch(g){throw new CallingCommunicationError({defaultError:D.CALL_AGENT.PARSE_ACCESSTOKEN,originalError:g})}}createNewCall(g,m){return new CallImpl({callId:g},this,m,this._telemetryLogManager)}addToCallArray(g){this._calls.push(g),this.trackCallEndTimeToStopTelemetry(this._calls)}startCall(g,m){if(this.assertCallUserIds(g),m?.alternateCallerId&&validateIdentifier(m.alternateCallerId),g.find((g=>getMriFromIdentifier(g)===this.getUserMri())))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.CANT_CALL_YOURSELF});let S=m?.audioOptions?.muted;return void 0===S&&(S=!1),this.logger.info(`startCall with video=${!!m?.videoOptions},muted=${S}`),this.createCall({participants:g,startCallOptions:m})}join(g,m){if(!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!1,void 0,g))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});this.assertCallContext(g);let S=m?.audioOptions?.muted;return void 0===S&&(S=!1),this.logger.info(`join with video=${!!m?.videoOptions},muted=${S}`),this.createCall({callContext:g,startCallOptions:m})}async dispose(){if(this._disposed)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.ACS_ALREADY_DISPOSED});this._disposed=!0,this._abortController.abort(),this._extensibleApi.dispose(),this._parsedTokenCredential?.identityMri&&Mm.delete(this._parsedTokenCredential?.identityMri);try{const g=this._tokenFetchTries>this._maxNmberOfRetries;await(this._callStack?.dispose(g))}catch(g){this.logger.error("Call Agent failed to dispose to Call Stack")}this.offTrouterStateChanged(this._trouterStateChangeCallback),this._callStack.offRegisteredChanged(this._registrarStateChangeCallback),delete this._callStack,this._telemetryLogManager.clearTelemetryLoggers(),this.onDisposedCallback&&this.onDisposedCallback()}on(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}createCall(g){if(g?.startCallOptions?.firstPartyOptions?.isImmersiveMode&&"meshV2"!==this.getDeviceType())throw new CallingCommunicationError({defaultError:D.CALL_AGENT.MESH_DEVICETYPE_V2});let m,S,v,C,_=g?.callContext?.threadId||g?.startCallOptions?.threadId,E=g?.callContext?.groupId;const T=g?.callContext?.roomId,I=g?.callContext?.meetingLink,b=g?.callContext?.meetingId,A=g?.callContext?.passcode||"";if(E&&E.startsWith("19:")&&(_=E,E=""),I){getAcsEcsConfig().calling.tfl.isEnabled&&this.isTflMeetingLink(I.trim().toLocaleLowerCase())?v=parseTflMeetingLink(I):S=parseMeetingUrl(I)}if(g?.callContext?.threadId&&g?.callContext?.organizerId&&g?.callContext?.tenantId&&(S={threadId:g?.callContext?.threadId,messageId:g?.callContext?.messageId?g?.callContext?.messageId.toString():"0",organizerId:g?.callContext?.organizerId,tenantId:g?.callContext?.tenantId}),S&&(C={meetingType:"0"===S.messageId?1:2,tenantId:S.tenantId,organizerId:S.organizerId,replyChainMessageId:S.messageId}||void 0,_=S.threadId,m=S.messageId),this.tsStack){const S=M.generateCauseId(),I=generateGuid(),R=generateGuid();let P;if(E)P=this._tsCallRegistry.createCallWithGroupId(E,I,R,S);else if(b)P=this._tsCallRegistry.createCallWithMeetingData({meetingCode:b,passcode:A,threadId:_},I,R,S);else if(T)P=this._tsCallRegistry.createCallWithMeetingData({meetingCode:T},I,R,S);else if(v)P=this._tsCallRegistry.createCallWithMeetingData(v,I,R,S);else{const v=!!g?.participants&&g.participants.length>=2&&IsAdhocInteropCall(g.participants);getAcsEcsConfig().calling.enableSmePassFakeConversation&&!_&&v&&(_=`${x}${generateGuid()}`),P=this._tsCallRegistry.createCall(_||"",I,R,m,S)}const w=new CallImpl({callId:I,roomId:T},this,P,this._telemetryLogManager);this.addToCallArray(w),this.handleCallState(w);const D={threadId:_||"",messageId:m||"",meetingInfo:C,mediaPeerType:2};return g?.participants&&g?.participants.forEach((g=>{P.addParticipant(getMriFromIdentifier(g)).catch((()=>{this.logger.error("Failed to add participant during call start")}))})),w.startCallInternal(g?.startCallOptions,!!b||!!T,g?.callContext,D).catch(noop),w.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[w],removed:[]}),w}throw new CallingCommunicationError({defaultError:D.CALL_AGENT.STACK_NOT_INIT})}assertCallContext(g){if(!g||this.checkForAtLeastOneValidCallConfig(g)||this.checkIfMultiplesConfigsWereSpecified(g)||this.checkForInvalidTeamsMeetingCoordinates(g))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INVALID_CALL_CONFIG})}checkForAtLeastOneValidCallConfig(g){return!(g.threadId||g.meetingLink||g.groupId||g.meetingId||g.roomId)}checkIfMultiplesConfigsWereSpecified(g){return g.threadId&&g.groupId||g.groupId&&g.meetingLink}checkForInvalidTeamsMeetingCoordinates(g){return!g.threadId&&g.tenantId&&g.organizerId||g.threadId&&(g.organizerId&&!g.tenantId||!g.organizerId&&g.tenantId)}isTflMeetingLink(g){return getAcsEcsConfig().calling.tfl.hosts.some((m=>g.includes(m.trim().toLocaleLowerCase())))}assertCallUserIds(g){assertIsObject(g,D.CALL_AGENT.USERIDS_MUST_BE_OBJECTS),assertNotNull(g,D.CALL_AGENT.USERIDS_CANNOT_BE_NULL),assertIsArrayOfIdentifiers(g),g.forEach((g=>{const m=validateIdentifier(g);if(!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!1,m))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN})}))}}__decorate$n([syncOperation(Hh.StartCall),__metadata$n("design:type",Function),__metadata$n("design:paramtypes",[Array,Object]),__metadata$n("design:returntype",Object)],CallAgentImpl.prototype,"startCall",null),__decorate$n([syncOperation(Hh.Join),__metadata$n("design:type",Function),__metadata$n("design:paramtypes",[Object,Object]),__metadata$n("design:returntype",Object)],CallAgentImpl.prototype,"join",null),__decorate$n([asyncOperation(Hh.Dispose),__metadata$n("design:type",Function),__metadata$n("design:paramtypes",[]),__metadata$n("design:returntype",Promise)],CallAgentImpl.prototype,"dispose",null);class EcsProvider{constructor(g,m,S){this._configIds={AcsCallingSDKWeb:"",SkypeWebMedia:""},this.setConfigOrDefault=(g,m)=>{g&&Object.keys(g).forEach((S=>{void 0!==g[S]&&(m[S]=g[S])}))},this._logger=g,this.sdkDiagnosticInformation=m,this._acsProxy=S;const v=getAcsEcsConfig().calling.applicationSettingsUrls;this._trouterSettings={version:`${getPlatformId()}/${getSdkInternalVersion()}`,productName:"AcsWeb",trouterServiceUrl:v.Public_TrouterServiceUrl,registrarServiceUrl:v.Public_RegistrarServiceUrl,maxRegistrationTimeInMs:36e5,pnhAppId:"AcsWeb",pnhTemplate:"AcsWeb_2.0",environment:"Prod",platform:getPlatformName()},this._JsCsaConfig={languageCode:"en",emergencyCallCountry:"",autoResolveConflictedCall:!1,handleRosterFromCreateAndJoin:!0,conversationServiceUrl:S.proxyfyUrl(v.Public_ConversationServiceUrl),useInternalHttpDispatcher:!S.hasProxyUrl(),supportsHostlessGroupCalls:!0,doHostlessCalling:!0,shouldServiceSendCallEventMessages:!0,shouldServiceSendNGCUpgradeMessages:!0,supportsCompressedServicePayload:!0,handleNewOfferRequest:!0,handleMediaOfferFromPushNotification:!0,isWebRtcEnabled:!0,supportsSynchronousTrouterResponse:!0,autoJoinOnConflict:!0,brokerEnabledOutgoing:!0,brokerEnabledIncoming:!0,brokerExclusively:!1,brokerRequestBatching:!0,isGVCOutgoingEnabled:!0,isGVCJoiningEnabled:!0,enableTokenCache:!1},this._JamaSettingsMobile={webrtcCameraOpenFs:900,webrtcMultipartyMaxScalingFs:900,webrtcMaxScalingFs:900},this._JamaSettings={debug:!1,numVideoChannelsGvc:6,webcv:null},this._MDNTrapSettings={Service:{url:S.proxyfyUrl(v.Public_MdnTrapServiceUrl),tokenUrl:S.proxyfyUrl(v.Public_MdnTrapServiceTokenUrl)},Relay:{Skype:{addresses:[],fqdns:[v.Public_MdnTrapRelaySkypeFqdns],tcpPort:443,udpPort:3478},Turn:{addresses:[],fqdns:[v.Public_MdnTrapRelayTurnFqdns],tcpPort:443,udpPort:3478,url:v.Public_MdnTrapRelayTurnUrl}},Http:{connectionTimeout:30,requestTimeout:60},Token:{earlyRefreshMinutes:1080,earlyRefreshPercentage:25}},this._TrouterJScriptClient={TelemetryEnabled:!1,ClientTelemetryEventEnabled:{trouter_js_client_connected:!1,trouter_js_client_disconnected:!1,trouter_js_client_error:!1,trouter_js_client_progress:!1,trouter_js_client_response:!1,trouter_js_client_check_connection:!1,trouter_js_client_registration:!1,trouter_js_client_unregistration:!1,logHealthCheckError:!1,logSendPingError:!1,numberOfStepsToMaintain:0,sendProgressTimeoutSecs:0}}}getTrouterTelemetryConfig(){return{enabled:this._TrouterJScriptClient.TelemetryEnabled,...this._TrouterJScriptClient.ClientTelemetryEventEnabled}}getJamaSettings(){const g=getBrowserInfo();let m=this._JamaSettings;return"Mobile"==g.formFactor&&(m={...m,...this._JamaSettingsMobile}),m}getClientInformation(){const g=getAcsEcsConfig().telemetry.reportSdkUaToService,m=getAcsEcsConfig().telemetry.reportEnvToService;return`ACSWeb(${getPlatformId()}/${getSdkInternalVersion()})`+(m?`/${getInternalEnvInfo()}`:"")+(g?`/(${this.sdkDiagnosticInformation})`:"")}getJsCsaConfig(){return{...this._JsCsaConfig,clientInformation:this.getClientInformation()}}getMdnTrapSettings(){return this._MDNTrapSettings}getTrouterSettings(){return this._trouterSettings}setConfig(g,m){this._logger.info("Update ECS settings");const S=getAcsEcsConfig().calling.applicationSettingsUrls,v=getAcsEcsConfig().calling.applicationSettingsEudbUrls,C=g&&isEudbConfigurationsApplicable(g.identityType,g.region);if(g?.identityType==la.Enterprise)C?(this._trouterSettings.trouterServiceUrl=v.Enterprise_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(v.Enterprise_RegistrarServiceUrl_EUDB)):(this._trouterSettings.trouterServiceUrl=S.Enterprise_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.Enterprise_RegistrarServiceUrl));else switch(g?.cloudType){case ta.Public:C&&(this._trouterSettings.trouterServiceUrl=v.Public_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(v.Public_RegistrarServiceUrl_EUDB),this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(v.Public_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(v.Public_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(v.Public_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[v.Public_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[v.Public_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=v.Public_MdnTrapRelayTurnUrl_EUDB);break;case ta.GccHigh:this._trouterSettings.trouterServiceUrl=S.GccHigh_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.GccHigh_RegistrarServiceUrl);break;case ta.Dod:this._trouterSettings.trouterServiceUrl=S.Dod_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.Dod_RegistrarServiceUrl);break;case ta.AirGap08:this._trouterSettings.trouterServiceUrl=S.AirGap08_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.AirGap08_RegistrarServiceUrl);break;case ta.AirGap09:this._trouterSettings.trouterServiceUrl=S.AirGap09_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.AirGap09_RegistrarServiceUrl)}if(m)this._configIds={AcsCallingSDKWeb:m?.ConfigIDs?.AcsCallingSDKWeb||"",SkypeWebMedia:m?.ConfigIDs?.SkypeWebMedia||""},this.setConfigOrDefault(m?.SkypeCalling,this._JsCsaConfig),this.setConfigOrDefault(m?.MDN_TRAP,this._MDNTrapSettings),this.setConfigOrDefault(m?.SkypeWebMedia?.mediaAgent,this._JamaSettings),this.setConfigOrDefault(m?.TrouterJScriptClient,this._TrouterJScriptClient);else if(g?.identityType===la.Enterprise)C?(this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(v.Enterprise_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(v.Enterprise_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(v.Enterprise_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[v.Enterprise_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[v.Enterprise_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=v.Enterprise_MdnTrapRelayTurnUrl_EUDB):(this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.Enterprise_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(S.Enterprise_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(S.Enterprise_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[S.Enterprise_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[S.Enterprise_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=S.Enterprise_MdnTrapRelayTurnUrl);else switch(g?.cloudType){case ta.Public:C&&(this._trouterSettings.trouterServiceUrl=v.Public_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(v.Public_RegistrarServiceUrl_EUDB),this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(v.Public_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(v.Public_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(v.Public_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[v.Public_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[v.Public_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=v.Public_MdnTrapRelayTurnUrl_EUDB);break;case ta.GccHigh:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.GccHigh_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(S.GccHigh_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(S.GccHigh_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[S.GccHigh_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[S.GccHigh_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=S.GccHigh_MdnTrapRelayTurnUrl;break;case ta.Dod:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.Dod_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(S.Dod_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(S.Dod_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[S.Dod_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[S.Dod_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=S.Dod_MdnTrapRelayTurnUrl;break;case ta.AirGap08:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.AirGap08_ConversationServiceUrl);break;case ta.AirGap09:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.AirGap09_ConversationServiceUrl)}}getConfigIds(){return this._configIds}assertConfigs(g){const m="SkypeCalling",S="MDN_TRAP",v="SkypeWebMedia",C="SkypeWebMedia.mediaAgent",_="TrouterJScriptClient";let E=[];if(g?.SkypeCalling||E.push(m),g?.MDN_TRAP||E.push(S),g?.SkypeWebMedia?g?.SkypeWebMedia?.mediaAgent||E.push(C):E.push(v),g?.TrouterJScriptClient||E.push(_),E.length>0){const g=new CallingCommunicationError({defaultError:D.CALL_STACK.FOUND_UNDEFINED_CONFIGS,defaultErrorMessageArgs:[E.join(", ")]});throw this._logger.error(g.message),g}}}var wm,Dm=createCommonjsModule((function(g,m){var S;S=function(){return function(g){function e(S){if(m[S])return m[S].exports;var v=m[S]={i:S,l:!1,exports:{}};return g[S].call(v.exports,v,v.exports,e),v.l=!0,v.exports}var m={};return e.m=g,e.c=m,e.i=function(g){return g},e.d=function(g,m,S){e.o(g,m)||Object.defineProperty(g,m,{configurable:!1,enumerable:!0,get:S})},e.n=function(g){var m=g&&g.__esModule?function(){return g.default}:function(){return g};return e.d(m,"a",m),m},e.o=function(g,m){return Object.prototype.hasOwnProperty.call(g,m)},e.p="",e(e.s=1)}([function(g,m,S){function n(g,m){var S,v=new Promise((function(m,v){fetch(g).then((function(g){clearTimeout(S),m(g)})).catch((function(g){clearTimeout(S),v(g)}))}));if(0!==m){var C=new Promise((function(v,C){S=setTimeout(C,m,new Error("Fetch for '".concat(g.url,"' timed out")))}));return Promise.race([v,C])}return v}function o(g){try{return JSON.stringify(g)}catch(m){return"Unable to serialize object of type ".concat(typeof g)}}Object.defineProperty(m,"__esModule",{value:!0}),m.Timespan=m.toJson=m.fetchWithTimeout=void 0,m.fetchWithTimeout=n,m.toJson=o;var v=function(){function t(){this.start=Date.now()}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.start=Date.now()},t}();m.Timespan=v},function(g,m,S){function n(g,m,S){return new R(g,m,S)}var v=this&&this.__extends||function(){var t=function(g,m){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)Object.prototype.hasOwnProperty.call(m,S)&&(g[S]=m[S])})(g,m)};return function(g,m){function n(){this.constructor=g}if("function"!=typeof m&&null!==m)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");t(g,m),g.prototype=null===m?Object.create(m):(n.prototype=m.prototype,new n)}}(),C=this&&this.__assign||function(){return C=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},C.apply(this,arguments)},_=this&&this.__awaiter||function(g,m,S,v){function o(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function s(g){try{c(v.next(g))}catch(g){C(g)}}function a(g){try{c(v.throw(g))}catch(g){C(g)}}function c(g){g.done?S(g.value):o(g.value).then(s,a)}c((v=v.apply(g,m||[])).next())}))},E=this&&this.__generator||function(g,m){function r(g){return function(m){return n([g,m])}}function n(T){if(S)throw new TypeError("Generator is already executing.");for(;_&&(_=0,T[0]&&(E=0)),E;)try{if(S=1,v&&(C=2&T[0]?v.return:T[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,T[1])).done)return C;switch(v=0,C&&(T=[2&T[0],C.value]),T[0]){case 0:case 1:C=T;break;case 4:return E.label++,{value:T[1],done:!1};case 5:E.label++,v=T[1],T=[0];continue;case 7:T=E.ops.pop(),E.trys.pop();continue;default:if(!(C=(C=E.trys).length>0&&C[C.length-1])&&(6===T[0]||2===T[0])){E=0;continue}if(3===T[0]&&(!C||T[1]>C[0]&&T[1]<C[3])){E.label=T[1];break}if(6===T[0]&&E.label<C[1]){E.label=C[1],C=T;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(T);break}C[2]&&E.ops.pop(),E.trys.pop();continue}T=m.call(g,E)}catch(g){T=[6,g],v=0}finally{S=C=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_};Object.defineProperty(m,"__esModule",{value:!0}),m.createRegistrarClient=m.RegistrarClient=void 0;var T=S(0),I=["skype","aad","cae"],b=function(g){function e(m){var S=g.call(this,m)||this;return S.name="CancelationError",S}return v(e,g),e}(Error),A=function(){function t(g,m,S){this.logger=g,this.maxBackoffInMs=m,this.initialDelay=S,this.backoffCount=0,this.id=++t.idCounter}return t.prototype.delay=function(g){var m=this;if(void 0!==this.timerHandle)throw new Error("Retry sequence logical failure");if(-1===this.backoffCount)return new Promise((function(g,m){m(new b("Cancelled"))}));var S=this.calculateNextBackoffMs();return this.backoffCount++,this.logger.info("[RegistrarClient] Backing off ".concat(g," for ").concat(S," milliseconds with ID ").concat(this.id)),new Promise((function(v,C){m.cancelFunc=C,m.timerHandle=setTimeout((function(){m.logger.info("[RegistrarClient] Back off for ".concat(g," with ID ").concat(m.id," complete")),m.timerHandle=void 0,v()}),S)}))},t.prototype.cancel=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off"),clearTimeout(this.timerHandle),void 0!==this.cancelFunc&&this.cancelFunc(new b("Cancelled"))),this.backoffCount=-1},t.prototype.calculateNextBackoffMs=function(){var g=1+.4*(Math.random()-.5),m=this.initialDelay*Math.pow(2,this.backoffCount)*g;return m=Math.round(m),Math.min(this.maxBackoffInMs,m)},t.idCounter=0,t}(),R=function(){function t(g,m,S){var v;this.logger=g,this.tokenProvider=m,this.options=S,this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN=15,this.DEFAULT_MAX_BACKOFF_TIME_IN_MS=3e5,this.backoffs={},this.maxBackOffTime=this.options.maxRetryDelayMs>0?this.options.maxRetryDelayMs:this.DEFAULT_MAX_BACKOFF_TIME_IN_MS,this.maxRetriesForGetToken=void 0===S.maxRetriesForGetToken||null===S.maxRetriesForGetToken?this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN:S.maxRetriesForGetToken,this.proxyUrlRewrite=null!==(v=S.proxyUrlRewrite)&&void 0!==v?v:function(g){return g}}return t.prototype.setTelemetryLogger=function(g){this.eventLogger=g},t.prototype.register=function(g,m){return _(this,void 0,void 0,(function(){return E(this,(function(S){switch(S.label){case 0:return[4,this.performRegistration(g,m,"pr_set_registration")];case 1:return S.sent(),this.cachedRegistrationParams=[g,m],[2]}}))}))},t.prototype.unregister=function(){return _(this,void 0,void 0,(function(){var g;return E(this,(function(m){switch(m.label){case 0:return this.logger.info("[RegistrarClient] sending unregister request"),g=new Request(this.proxyUrlRewrite("".concat(this.options.registrarUrl,"/").concat(this.options.registrationId)),{method:"DELETE",mode:"cors",headers:new Headers(C(C({},this.options.extraRegistrationHeaders),{accept:"application/json, text/javascript"}))}),[4,this.callRegistrar(g,"pr_delete_registration")];case 1:return m.sent(),[2]}}))}))},t.prototype.cancelPendingRequests=function(){var g=this;Object.keys(this.backoffs).forEach((function(m){g.backoffs[m].cancel()})),this.backoffs={}},t.prototype.resendRegistration=function(){return _(this,void 0,void 0,(function(){return E(this,(function(g){switch(g.label){case 0:if(!this.cachedRegistrationParams)throw new Error("Re-registration failed because there is no registration parameters cached");return[4,this.performRegistration(this.cachedRegistrationParams[0],this.cachedRegistrationParams[1],"pr_resend_registration")];case 1:return g.sent(),[2]}}))}))},t.prototype.performRegistration=function(g,m,S){return _(this,void 0,void 0,(function(){var v,_;return E(this,(function(E){switch(E.label){case 0:return this.logger.info("[RegistrarClient] Sending register request"),v={clientDescription:g,registrationId:this.options.registrationId,nodeId:"",transports:m},_=new Request(this.proxyUrlRewrite(this.options.registrarUrl),{method:"POST",mode:"cors",headers:new Headers(C(C({},this.options.extraRegistrationHeaders),{"content-type":"application/json",accept:"application/json, text/javascript"})),body:(0,T.toJson)(v)}),[4,this.callRegistrar(_,S)];case 1:return E.sent(),[2]}}))}))},t.prototype.startBackoff=function(){var g=new A(this.logger,this.maxBackOffTime,this.options.initialRetryDelayMs);return this.backoffs[g.id]=g,g},t.prototype.stopBackoff=function(g){g.cancel(),delete this.backoffs[g.id]},t.prototype.getToken=function(g){return _(this,void 0,void 0,(function(){var m,S,v,C,_,T,b;return E(this,(function(E){switch(E.label){case 0:m=this.startBackoff(),S=0,E.label=1;case 1:return E.trys.push([1,3,,8]),this.logger.info("[RegistrarClient] Asking for a new token"),[4,this.tokenProvider({needFresh:!0,supportedTokenTypes:I,wwwAuthenticateHeader:g,purpose:"registrar"})];case 2:return v=E.sent(),this.stopBackoff(m),[2,v];case 3:C=E.sent(),E.label=4;case 4:return E.trys.push([4,6,,7]),S++,_=JSON.stringify(C),S>this.maxRetriesForGetToken?(T="[RegistrarClient] getToken retry limit hit. Will not retry now. Error: ".concat(_),this.logger.error(T),this.stopBackoff(m),[2,Promise.reject(T)]):(this.logger.warn("[RegistrarClient] Retrying for a new token. Retry Count: ".concat(S," Error: ").concat(_)),[4,m.delay("Fetching a new token")]);case 5:return E.sent(),[3,8];case 6:throw b=E.sent(),this.stopBackoff(m),b;case 7:return[3,8];case 8:return[3,1];case 9:return[2]}}))}))},t.prototype.callRegistrar=function(g,m){var S,v,C;return _(this,void 0,void 0,(function(){var _,b,A,R,P,M,w,D,O,N,k,L,F,x,U,V;return E(this,(function(E){switch(E.label){case 0:return _=this.startBackoff(),[4,this.tokenProvider({needFresh:!1,supportedTokenTypes:I,wwwAuthenticateHeader:void 0,purpose:"registrar"})];case 1:b=E.sent(),this.setTokenHeader(g,b),A=new T.Timespan,R=0,E.label=2;case 2:P=void 0,E.label=3;case 3:return E.trys.push([3,10,15,16]),M=g.clone(),[4,(0,T.fetchWithTimeout)(M,this.options.requestTimeoutMs)];case 4:return 401!==(P=E.sent()).status?[3,8]:++R>this.maxRetriesForGetToken?(w="[RegistrarClient] getSkypeToken retry limit hit. Will not retry now. Request '".concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText),this.logger.error(w),this.stopBackoff(_),[2,Promise.reject(w)]):(this.logger.warn("[RegistrarClient] Retry Count ".concat(R,". Request '").concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText)),D=null!==(v=null===(S=P.headers)||void 0===S?void 0:S.get("www-authenticate"))&&void 0!==v?v:void 0,O=this.setTokenHeader,N=[g],[4,this.getToken(D)]);case 5:return O.apply(this,N.concat([E.sent()])),R>1?[4,_.delay("Registrar call retry after 401")]:[3,7];case 6:E.sent(),E.label=7;case 7:return[3,22];case 8:if(P.status>=500&&P.status<600)throw new Error("Fetch for '".concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText));E.label=9;case 9:return[3,16];case 10:k=E.sent(),this.logger.error("[RegistrarClient] Request failed with ".concat(k)),E.label=11;case 11:return E.trys.push([11,13,,14]),[4,_.delay("Registrar call retry")];case 12:return E.sent(),[3,22];case 13:throw L=E.sent(),this.logger.error("[RegistrarClient] Request cancelled"),this.stopBackoff(_),L;case 14:return[3,16];case 15:return this.sendTelemetryEvent(m,g,P,A),[7];case 16:return this.stopBackoff(_),P.ok?[2,P]:[3,17];case 17:F=void 0,E.label=18;case 18:return E.trys.push([18,20,,21]),U=(x=JSON).stringify,[4,P.json()];case 19:return F=U.apply(x,[E.sent()]),[3,21];case 20:return E.sent(),F="no details",[3,21];case 21:throw V="Fetch for '".concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText," (").concat(F,", MS-CV: ").concat(null===(C=P.headers)||void 0===C?void 0:C.get("MS-CV"),")"),this.logger.error("[RegistrarClient] ".concat(V)),new Error(V);case 22:return[3,2];case 23:return[2]}}))}))},t.prototype.setTokenHeader=function(g,m){switch(g.headers.delete("X-Skypetoken"),g.headers.delete("Authorization"),g.headers.delete("X-MS-Migration"),m.tokenType.toLowerCase()){case"skype":g.headers.set("X-Skypetoken",m.token);break;case"aad":case"cae":g.headers.set("Authorization","Bearer ".concat(m.token));break;default:throw new Error("unsupported token type: ".concat(m.tokenType))}!1===this.options.usingLegacyTokenApi&&g.headers.set("X-MS-Migration","True")},t.prototype.sendTelemetryEvent=function(g,m,S,v){if(void 0!==this.eventLogger){var C={name:g,properties:{url:{value:m.url},result_code:{value:void 0!==S?S.status:0},begin_timestamp:{value:v.startTime},elapsed:{value:v.duration}}};this.eventLogger.logEvent(C)}},t}();m.RegistrarClient=R,m.createRegistrarClient=n}])},g.exports=S()})),Om=createCommonjsModule((function(g,m){var S;S=function(g){return function(g){function e(S){if(m[S])return m[S].exports;var v=m[S]={i:S,l:!1,exports:{}};return g[S].call(v.exports,v,v.exports,e),v.l=!0,v.exports}var m={};return e.m=g,e.c=m,e.i=function(g){return g},e.d=function(g,m,S){e.o(g,m)||Object.defineProperty(g,m,{configurable:!1,enumerable:!0,get:S})},e.n=function(g){var m=g&&g.__esModule?function(){return g.default}:function(){return g};return e.d(m,"a",m),m},e.o=function(g,m){return Object.prototype.hasOwnProperty.call(g,m)},e.p="",e(e.s=20)}([function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.Logger=void 0;var v=function(){function t(g,m){this.name=g,this.logger=m}return t.prototype.debug=function(g){this.logger.debug("["+this.name+"] "+g)},t.prototype.info=function(g){this.logger.info("["+this.name+"] "+g)},t.prototype.warn=function(g){this.logger.warn("["+this.name+"] "+g)},t.prototype.error=function(g){this.logger.error("["+this.name+"] "+g)},t}();m.Logger=v},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.USER_AUTHENTICATE_EVENT_NAME=m.SUPPORTED_TOKEN_TYPES=m.FAILED_MESSAGE_ACK=m.UNHANDLED_MESSAGE_ACK=m.HANDLED_MESSAGE_ACK=m.CLIENT_VERSION=m.constants=void 0,m.constants={TROUTER_INIT:"trouterinit",TROUTER_READY_EVENT:"trouterReadyEvent",TROUTER_READY_TIMEOUT:"trouterReadyTimeout",TROUTER_TOKEN_REQUEST:"trouterTokenRequest",TROUTER_TOKEN_GET_SUCCEEDED:"trouterTokenGetSucceeded",TROUTER_TOKEN_GET_FAILED:"trouterTokenGetFailed",TROUTER_RECONNECTING:"trouterReconnecting",RENEWAL:"renewal",NEW_CONNECTION:"newConnection",ENDPOINT_REGISTRATION_FAILED:"endpointRegistrationFailed"},m.CLIENT_VERSION="2024.08.01.23",m.HANDLED_MESSAGE_ACK=200,m.UNHANDLED_MESSAGE_ACK=404,m.FAILED_MESSAGE_ACK=500,m.SUPPORTED_TOKEN_TYPES=["skype","aad","cae"],m.USER_AUTHENTICATE_EVENT_NAME="user.authenticate"},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterState=m.UserActivityState=void 0,function(g){g[g.Unknown=0]="Unknown",g[g.Active=1]="Active",g[g.Inactive=2]="Inactive"}(m.UserActivityState||(m.UserActivityState={})),function(g){g[g.Unknown=0]="Unknown",g[g.Connected=2]="Connected",g[g.Disconnected=3]="Disconnected",g[g.Switching=9]="Switching"}(m.TrouterState||(m.TrouterState={}))},function(g,m,S){function o(g){try{return JSON.stringify(g)}catch(m){return"Unable to serialize object of type "+typeof g}}function i(g){var m=Math.round((new Date).getTime()/1e3);return void 0!==g&&g>m?g-m:0}function r(g){return Math.round((new Date).getTime()/1e3)+g}function s(g,m){return v(this,void 0,void 0,(function(){var S,v,_;return C(this,(function(C){return v=new Promise((function(m,v){fetch(g).then((function(g){clearTimeout(S),m(g)})).catch((function(g){clearTimeout(S),v(g)}))})),0!==m?(_=new Promise((function(v,C){var _=new URL(g.url),E=new Error(g.method+" "+_.origin+_.pathname+" timed out");S=setTimeout(C,m,E)})),[2,Promise.race([v,_])]):[2,v]}))}))}var v=this&&this.__awaiter||function(g,m,S,v){function i(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function s(g){try{a(v.next(g))}catch(g){C(g)}}function c(g){try{a(v.throw(g))}catch(g){C(g)}}function a(g){g.done?S(g.value):i(g.value).then(s,c)}a((v=v.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=(C=E.trys).length>0&&C[C.length-1])&&(6===_[0]||2===_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_};Object.defineProperty(m,"__esModule",{value:!0}),m.Timespan=m.CorrelationVector=m.fetchWithTimeout=m.calculateExpireTsInSec=m.calculateTtlInSec=m.toJson=void 0,m.toJson=o,m.calculateTtlInSec=i,m.calculateExpireTsInSec=r,m.fetchWithTimeout=s;var _=function(){function t(g){this.base=void 0!==g?g:this.createCorrelationVectorBase(),this.extension=0}return t.extend=function(g){return new t(g)},t.prototype.increase=function(){this.extension++},t.prototype.value=function(){return this.base+"."+this.extension},t.prototype.createCorrelationVectorBase=function(){for(var g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0987654321/+",m="AQgw",S="",v=0;v<21;v++)S+=g.charAt(Math.floor(Math.random()*g.length));return S+m.charAt(Math.floor(Math.random()*m.length))},t}();m.CorrelationVector=_;var E=function(){function t(){this.start=Date.now()}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.start=Date.now()},t}();m.Timespan=E},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterManagerState=m.UserActivityEventReason=m.ServerState=void 0;var v=S(3),C=function(){function t(g,m,S,v,C,_,E){this.connectionId=g,this.connectedClientId=m,this.domId=S,this.unsecureUrl=v,this.url=C,this.c2cUrlBase=_,this.expirationTsSec=E}return t.prototype.getRemainingTtlInSec=function(){return(0,v.calculateTtlInSec)(this.expirationTsSec)},t}();m.ServerState=C,function(g){g[g.Unknown=0]="Unknown",g[g.Modified=1]="Modified",g[g.Snapshot=2]="Snapshot",g[g.Connected=3]="Connected"}(m.UserActivityEventReason||(m.UserActivityEventReason={})),function(g){g[g.Unknown=0]="Unknown",g[g.Connected=2]="Connected",g[g.Disconnected=3]="Disconnected",g[g.Switching=9]="Switching",g[g.TerminalError=10]="TerminalError"}(m.TrouterManagerState||(m.TrouterManagerState={}))},function(g,m,S){function o(g,m){return"skype"===g&&"1"!==i(null==m?void 0:m.scae)?"v4a":"v4c"}function i(g){return"string"==typeof g?g:"number"==typeof g?g.toString():void 0}function r(g,m){return"v4c-websocket-failure"===(null==m?void 0:m.kind)?"v4a":g}function s(g){return Object.prototype.hasOwnProperty.call(g,"connectparams")}function c(g,m){return"v4a"===m?g.replace(/\/v4\/c\b/,"/v4/a").replace("wss://","https://").replace("ws://","http://"):g.replace(/\/v4\/a\b/,"/v4/c").replace("https://","wss://").replace("http://","ws://")}function a(g){if(void 0!==g)return v(v({},g),{reconnectUrl:void 0,serviceUrl:void 0})}function u(g){return"string"==typeof g?parseInt(g,10):g}function h(g){if("redirect"===(null==g?void 0:g.kind)&&void 0!==g.host){var m=g.host;return m.endsWith("/")&&(m=m.substring(0,m.length-1)),m.endsWith("/v4/c")||m.endsWith("/v4/a")||(m+="/v4/c"),m}}var v=this&&this.__assign||function(){return v=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},v.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.redirectUrlIfPresent=m.ensureNumber=m.reconnectParamsWithoutUrls=m.adaptUrl=m.isV4ConnectEvent=m.usedProtocolAfterFallback=m.usedProtocol=void 0,m.usedProtocol=o,m.usedProtocolAfterFallback=r,m.isV4ConnectEvent=s,m.adaptUrl=c,m.reconnectParamsWithoutUrls=a,m.ensureNumber=u,m.redirectUrlIfPresent=h},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterFsm=m.State=void 0;var v,C,_=S(4),E=S(0),T=S(5);!function(g){g[g.Initial=0]="Initial",g[g.RetrievingToken=1]="RetrievingToken",g[g.Allocating=2]="Allocating",g[g.Handshaking=3]="Handshaking",g[g.Connecting=4]="Connecting",g[g.AnonymousConnecting=5]="AnonymousConnecting",g[g.WebsocketAuthenticating=6]="WebsocketAuthenticating",g[g.Connected=7]="Connected",g[g.Unregistering=8]="Unregistering",g[g.TerminalError=9]="TerminalError"}(v=m.State||(m.State={})),function(g){g[g.Initial=0]="Initial",g[g.Registering=1]="Registering",g[g.RegisteringButResendPending=2]="RegisteringButResendPending",g[g.Retrying=3]="Retrying",g[g.Registered=4]="Registered",g[g.RegistrationDisabled=5]="RegistrationDisabled"}(C||(C={}));var I=function(){function t(g,m,S,_){this.worker=m,this.incallModeEnabled=S,this.protocolSelector=_,this.state=v.Initial,this.autoReconnect=!0,this.logger=new E.Logger("ConnectionFsm",g),this.registrationState=C.Initial}return t.prototype.getState=function(){return this.state},t.prototype.isActive=function(){return this.state===v.Allocating||this.state===v.Connected||this.state===v.Handshaking||this.state===v.Connecting||this.state===v.RetrievingToken||this.state===v.AnonymousConnecting||this.state===v.WebsocketAuthenticating},t.prototype.isConnecting=function(){return this.state===v.Allocating||this.state===v.Handshaking||this.state===v.Connecting||this.state===v.AnonymousConnecting},t.prototype.start=function(){return this.state===v.Initial?(this.setState(v.RetrievingToken),this.worker.getToken(!0,!1,void 0),!0):(this.showIgnored("start"),!1)},t.prototype.stop=function(g,m){g&&(this.registrationState=C.Initial),this.worker.isIncallMode()&&this.worker.exitIncallMode(),this.worker.resetTokenBackoff(),this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.state===v.Connected&&this.worker.sendDisconnectTelemetryEvent("connection stopped"),this.registrationState!==C.Registered&&this.registrationState!==C.Registering&&this.registrationState!==C.RegisteringButResendPending||this.state===v.Unregistering?m?(this.setState(v.TerminalError),this.worker.dispatchTerminalError()):(this.setState(v.Initial),this.worker.dispatchDisconnected()):(this.registrationState=C.Initial,this.setState(v.Unregistering),this.worker.sendUnregisterRequest())},t.prototype.onTokenReceived=function(g,m,S){this.state===v.RetrievingToken?"v4c"===(0,T.usedProtocolAfterFallback)(this.protocolSelector(g.tokenType,S),m)?(this.setState(v.AnonymousConnecting),this.worker.startConnectionTimer(),this.worker.connectV4c(g,m)):(this.setState(v.Allocating),this.worker.startConnectionTimer(),this.worker.sendAllocateRequest(g)):this.showIgnored("onTokenReceived")},t.prototype.checkConnection=function(g){g&&this.onPingInterval()},t.prototype.onAllocationSucceed=function(g){return this.state===v.Allocating&&this.registrationState===C.Registered&&this.worker.dispatchUnregistered(),this.state===v.Allocating?(this.setState(v.Handshaking),this.registrationState=C.Initial,this.worker.startSocketIo(g),!0):(this.showIgnored("onAllocationSucceed"),!1)},t.prototype.onAllocationFailed=function(g,m){this.state===v.Allocating?this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!g,claimsChallenge:m}):this.showIgnored("onAllocationFailed")},t.prototype.onV4cException=function(){this.state!==v.AnonymousConnecting&&this.state!==v.WebsocketAuthenticating||(this.logger.error("v4c exception, falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}}))},t.prototype.onConnectingTimeout=function(){this.state===v.Allocating||this.state===v.Connecting||this.state===v.Handshaking||this.state===v.AnonymousConnecting||this.state===v.WebsocketAuthenticating?this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0}):this.showIgnored("onConnectingTimeout")},t.prototype.onConnecting=function(){this.state===v.Handshaking?this.setState(v.Connecting):this.showIgnored("onConnecting")},t.prototype.onSocketConnect=function(g){this.state===v.AnonymousConnecting?(this.setState(v.WebsocketAuthenticating),this.worker.sendV4cAuthenticationEvent(g)):this.showIgnored("onSocketConnect")},t.prototype.onConnectingFailed=function(){this.state===v.Connecting?this.onConnectingTimeout():this.state===v.Handshaking?(this.logger.error("Unexpected error in Socket.io - no valid transports"),this.onConnectingTimeout()):this.state===v.AnonymousConnecting||this.state===v.WebsocketAuthenticating?(this.logger.info("/v4/c falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}})):this.showIgnored("onConnectingFailed")},t.prototype.onSocketDisconnect=function(g){this.state===v.Handshaking||this.state===v.Connected||this.state===v.WebsocketAuthenticating?(this.state===v.Connected&&this.worker.sendDisconnectTelemetryEvent(null==g?void 0:g.toTelemetryString()),this.state===v.WebsocketAuthenticating&&this.worker.countDisconnectBeforeConnectionEstablishment(),"skypetoken-deprecated"===(null==g?void 0:g.reason)?(this.logger.error("Skypetoken deprecated response, not retrying any further"),this.onTerminalError()):this.cleanUpAndInitiateReconnect({backoff:this.state!==v.Connected&&"dup"!==(null==g?void 0:g.reason),allowCachedToken:"unauthorized"!==(null==g?void 0:g.reason),claimsChallenge:null==g?void 0:g.claims})):this.showIgnored("onSocketDisconnect")},t.prototype.onTrouterConnected=function(){this.state===v.Connecting||this.state===v.WebsocketAuthenticating?(this.setState(v.Connected),this.worker.resetTokenBackoff(),this.worker.stopConnectionTimer(),this.worker.sendUserActivityState(_.UserActivityEventReason.Connected,!0),this.worker.startPingTimer(),this.worker.dispatchConnected(),this.worker.shouldSkipRegistration()?(this.registrationState=C.RegistrationDisabled,this.worker.dispatchRegistered()):(this.registrationState=C.Registering,this.worker.sendRegisterRequest())):this.showIgnored("onTrouterConnected")},t.prototype.onReconnectRequired=function(g,m,S){this.state===v.AnonymousConnecting||this.state===v.WebsocketAuthenticating?void 0===S||"host"!==S.target||void 0===S.url||""===S.url?(this.logger.error("unexpected reconnect arguments: "+(null==S?void 0:S.target)+" "+(null==S?void 0:S.url)+", reconnecting without cache"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect-no-host"}})):this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect",host:S.url}}):this.worker.dispatchReconnectIsRequired(g,m)},t.prototype.disableAutoReconnect=function(){this.autoReconnect=!1},t.prototype.onDownstreamRequest=function(g){this.state===v.Connected?(this.switchToIncallModeIfEnabled(),this.worker.dispatchDownstreamRequest(g)):this.showIgnored("onDownstreamRequest")},t.prototype.onTrouterMessageLost=function(g){this.state===v.Connected?this.worker.dispatchTrouterMessageLost(g):this.showIgnored("onTrouterMessageLost")},t.prototype.onPingInterval=function(){this.state===v.Connected?this.worker.sendPingRequest():this.showIgnored("onPingInterval")},t.prototype.onPingResponseTimeout=function(){this.onMissedResponse("onPingResponseTimeout")},t.prototype.onPingResponse=function(){this.state===v.Connected||this.showIgnored("onPingResponse")},t.prototype.onRegistrationFailed=function(){this.state===v.Connected&&this.registrationState===C.Registering?(this.worker.dispatchUnregistered(),this.registrationState=C.Retrying,this.worker.startRegistrationRetryTimer()):this.state===v.Connected&&this.registrationState===C.RegisteringButResendPending?(this.registrationState=C.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationFailed")},t.prototype.onRetryRegistration=function(){this.state===v.Connected&&this.registrationState===C.Retrying?(this.registrationState=C.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRetryRegistration")},t.prototype.onRegistrationSucceeded=function(){this.state===v.Connected&&this.registrationState===C.Registering?(this.registrationState=C.Registered,this.worker.dispatchRegistered(),this.worker.startRegistrationTimer()):this.state===v.Connected&&this.registrationState===C.RegisteringButResendPending?(this.registrationState=C.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationSucceeded")},t.prototype.onRegistrationNearExpiry=function(){this.state===v.Connected&&this.registrationState===C.Registered?(this.registrationState=C.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationNearExpiry")},t.prototype.onUnregistrationDone=function(){this.state===v.Unregistering?(this.setState(v.Initial),this.worker.dispatchUnregistered(),this.worker.dispatchDisconnected()):this.showIgnored("onUnregistrationDone")},t.prototype.onResendRegistration=function(){this.worker.dispatchUnregistered(),this.state===v.Connected&&this.registrationState===C.Registered?(this.registrationState=C.Registering,this.worker.stopRegistrationTimer(),this.worker.sendRegisterRequest()):this.state===v.Connected&&this.registrationState===C.Registering&&(this.registrationState=C.RegisteringButResendPending)},t.prototype.onIncallModeTimer=function(){this.worker.exitIncallMode(),this.state===v.Connected?(this.worker.stopPingTimer(),this.worker.startPingTimer()):this.showIgnored("onIncallModeTimer")},t.prototype.onSetNewUserActivityState=function(){this.worker.sendUserActivityState(_.UserActivityEventReason.Modified,this.state===v.Connected)},t.prototype.onActivityStateResponseTimeout=function(){this.onMissedResponse("onActivityStateResponseTimeout")},t.prototype.forceReconnect=function(g){this.state===v.Connected&&this.worker.sendDisconnectTelemetryEvent(g),this.worker.resetTokenBackoff(),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0})},t.prototype.onTerminalError=function(){this.logger.error("Cannot proceed, reached terminal state. Switching from state '"+v[this.state]+"' to "+v[v.TerminalError]),this.stop(!0,!0),this.setState(v.TerminalError)},t.prototype.onMissedResponse=function(g){this.state===v.Connected?(this.worker.sendDisconnectTelemetryEvent(g),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0})):this.showIgnored(g)},t.prototype.showIgnored=function(g){this.logger.debug("Ignoring event '"+g+"' in state '"+v[this.state]+"'")},t.prototype.setState=function(g){this.logger.info("Switching from state '"+v[this.state]+"' to state '"+v[g]+"'"),this.state!==g?this.state=g:this.logger.error("Attempt to switch to the current state '"+v[g]+"'")},t.prototype.switchToIncallModeIfEnabled=function(){this.incallModeEnabled&&(this.worker.isIncallMode()||(this.worker.enterIncallMode(),this.worker.stopPingTimer(),this.worker.startPingTimer()),this.worker.restartIncallModeTimer())},t.prototype.cleanUpAndInitiateReconnect=function(g){if(!this.autoReconnect)return this.logger.info("Automatic reconnect is disabled, stopping this connection"),void this.stop(!0);this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.setState(v.RetrievingToken),this.worker.dispatchReconnecting(),this.worker.getToken(g.allowCachedToken,g.backoff,g.claimsChallenge,g.fallbackReason)},t}();m.TrouterFsm=I},function(g,m,S){function o(g,m){var S=m?void 0:{"X-MS-Migration":"True"};switch(g.tokenType.toLowerCase()){case"skype":return v({"X-Skypetoken":g.token},S);case"aad":case"cae":return v({Authorization:"Bearer "+g.token},S);default:throw new Error("unsupported token type: "+g.tokenType)}}function i(g){return null!=g&&"function"==typeof g.toString?g.toString():"["+typeof g+"]"}function r(g){return"object"==typeof g&&null!==g&&void 0!==g.stack?(0,I.toJson)(g.stack):'"(no error.stack)"'}function s(g){return"object"==typeof g&&null!==g&&"string"==typeof g.message?g.message:"(no error.message)"}var v=this&&this.__assign||function(){return v=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},v.apply(this,arguments)},C=this&&this.__awaiter||function(g,m,S,v){function i(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function s(g){try{a(v.next(g))}catch(g){C(g)}}function c(g){try{a(v.throw(g))}catch(g){C(g)}}function a(g){g.done?S(g.value):i(g.value).then(s,c)}a((v=v.apply(g,m||[])).next())}))},_=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=(C=E.trys).length>0&&C[C.length-1])&&(6===_[0]||2===_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_};Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterConnection=m.ReconnectReason=void 0;var E,T=S(21),I=S(3),b=S(15),A=S(1),R=S(16),P=S(17),M=S(2),w=S(4),D=S(0),O=S(5),N=S(6),k=S(12),L=function(){function t(){this.cv=A.CLIENT_VERSION,this.ua="",this.hr="",this.v=""}return t}(),F=function(){function t(){this["force new connection"]=!0,this.reconnect=!1,this.query="",this.ackTimeoutMs=5e3}return t.prototype.rewriteUrlForProxy=function(g){return g},t}(),x="MS-CV",U=function(){function t(g,m){this.logger=m,this.cvCounter=0;var S=JSON.parse(g);this.startTS=this.safeJsonNumber(S,"startTS",0),this.url=this.safeJsonString(S,"url",""),this.shortUrl=this.safeJsonString(S,"shortUrl",""),this.body=this.safeJsonString(S,"body",""),this.headers=this.safeJsonRecord(S,"headers",{}),this.id=this.safeJsonNumber(S,"id",-1),this.method=this.safeJsonString(S,"method",""),this.replied=!1,this.timedout=!1,this.receivedCv=this.headers[x],this.updateCvHeader()}return Object.defineProperty(t.prototype,"correlationVector",{get:function(){return this.receivedCv?this.receivedCv+"."+this.cvCounter:""},enumerable:!1,configurable:!0}),t.prototype.on=function(g,m){"data"===g?this.dataCallback=m:"end"===g&&("function"==typeof this.dataCallback&&this.dataCallback(this.body),m())},t.prototype.incrementCorrelationVector=function(){++this.cvCounter,this.updateCvHeader()},t.prototype.updateCvHeader=function(){var g=this.correlationVector;g&&(this.headers[x]=g)},t.prototype.safeJsonNumber=function(g,m,S){var v;if(null!=g&&Object.prototype.hasOwnProperty.call(g,m)){var C=g;if("number"==typeof C[m])return C[m];if("string"==typeof C[m])return parseFloat(C[m]);null===(v=this.logger)||void 0===v||v.warn("unexpected type of '"+m+"': "+typeof C[m])}return S},t.prototype.safeJsonString=function(g,m,S){var v;if(null!=g&&Object.prototype.hasOwnProperty.call(g,m)){var C=g;if("string"==typeof C[m])return C[m];null===(v=this.logger)||void 0===v||v.warn("unexpected type of '"+m+"': "+typeof C[m])}return S},t.prototype.safeJsonRecord=function(g,m,S){var v;if(null!=g&&Object.prototype.hasOwnProperty.call(g,m)){var C=g;if("object"==typeof C[m])return C[m];null===(v=this.logger)||void 0===v||v.warn("unexpected type of '"+m+"': "+typeof C[m])}return S},t}(),V=function(){function t(g,m,S){this.request=g,this.responseData=m,this.sendResponse=S}return t.prototype.writeHead=function(g,m){this.responseData.status=g,this.responseData.headers=m},t.prototype.write=function(g){this.responseData.body+=g},t.prototype.end=function(g){return g&&(this.responseData.body+=g),this.sendResponse(this.request,this.responseData)},t}(),B=function(){function t(g){this.name=g,this.args={},this.timeoutTimerId=0}return t}();!function(g){g[g.Configuration=0]="Configuration",g[g.ServerInitiated=1]="ServerInitiated"}(E=m.ReconnectReason||(m.ReconnectReason={}));var H=function(){function t(g,m,S,v,C,_,E,I){var R,M=this;this.options=m,this.manager=S,this.tokenProvider=v,this.usingLegacyTokenApi=C,this.protocolSelector=E,this.audienceSubscriptionState=I,this.WEBSOCKET_TRANSPORT_NAME="websocket",this.XHR_POLLING_TRANSPORT_NAME="xhr-polling",this.AUDIENCE_SUBSCRIPTION_RESULT_ERROR="Error",this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED="Unsubscribed",this.AUDIENCE_SUBSCRIPTION_RESULT_TIMEOUT="Timeout",this.AUDIENCE_SUBSCRIPTION_RESULT_BAD_REQUEST="BadRequest",this.AUDIENCE_SUBSCRIPTION_STATE_QUERY_PARAM_REGEX=/&audienceSubscriptionState=[^&]*|^audienceSubscriptionState=[^&]*&?/,this.connectionId="",this.inIncallMode=!1,this.connectionAttempt=0,this.connectedClientId="",this.isNavigatorOnline=!0,this.onNavigatorOnlineStatusUpdateBound=this.onNavigatorOnlineStatusUpdate.bind(this),this.c2cUrlBase="",this.connectingErrorsInRow=0,this.unauthorizedErrorCount=0,this.pendingSentEventTimers={},this.lastDisconnectReason="",this.UNKNOWN_TRANSPORT="unknown_transport",this.connectingErrorsThreshold=3,this.pendingAudienceSubscription=void 0,this.logger=new D.Logger("Connection",g),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff=new P.ExponentialBackoff(this.logger,this.timeoutOptions.maxBackoffMs),this.clientID=Date.now(),"undefined"!=typeof window&&window.location&&(this.domId=window.location.hostname);var w=new L;w.cv=A.CLIENT_VERSION,w.ua="",(null===(R=this.options)||void 0===R?void 0:R.clientInfo)&&(w.ua=this.safeString(this.options.clientInfo.ua),w.v=this.safeString(this.options.clientInfo.v)),this.clientInfo=w,this.connectionTracker=new b.ConnectionTracker(g,this.clientID,this.clientInfo,(function(){return M.getServerState()}),this.options.endpointId,this.options.clientCorrelationID,this.options.environment),this.applyConnectionTrackerOptions(m);var O=this.options.incallModeTimeoutMs>0;if(this.fsm=new N.TrouterFsm(g,this,O,this.protocolSelector),m.registration){var k={registrarUrl:m.registration.registrarUrl,proxyUrlRewrite:m.rewriteUrlForProxy,registrationId:m.registration.registrationId,requestTimeoutMs:m.timeoutOptions.fetchTimeoutMs,initialRetryDelayMs:1e3,maxRetryDelayMs:m.timeoutOptions.maxBackoffMs,usingLegacyTokenApi:this.usingLegacyTokenApi,maxRetriesForGetToken:m.retryLimitOnTokenFetch,extraRegistrationHeaders:m.extraConnectionHeaders};this.registrarClient=(0,T.createRegistrarClient)(g,this.tokenProvider,k)}this.userActivityState=_}return t.prototype.start=function(g){this.logger.info("Starting"),this.reconnectParams=g,"undefined"!=typeof window&&window.navigator?(this.isNavigatorOnline=window.navigator.onLine,window.addEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.addEventListener("offline",this.onNavigatorOnlineStatusUpdateBound),this.logger.debug("Registered for browser online notifications - current state: "+this.isNavigatorOnline)):this.isNavigatorOnline=!0,this.fsm.start()},t.prototype.stop=function(g){this.logger.info("Stopping"),"undefined"!=typeof window&&window.navigator&&(window.removeEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.removeEventListener("offline",this.onNavigatorOnlineStatusUpdateBound)),this.fsm.stop(g),this.connectionTracker.close()},t.prototype.configure=function(g){var m=this.options.trouterUrl!==g.trouterUrl;this.options=g,this.applyConnectionTrackerOptions(g),m&&(this.logger.info("Configuration changed. Reconnection required."),this.fsm.onReconnectRequired(!1,E.Configuration))},t.prototype.checkConnection=function(g){this.logger.info("checkConnection called with "+g),this.fsm.checkConnection(g),g&&this.connectionTracker.sendTelemetry(b.ClientEventName.CheckConnection,{disconnectDetected:g},[])},t.prototype.disableRegistrationsAndAutoReconnect=function(){this.stopRegistrationTimer(),this.cancelPendingRegistrationRequests(),this.fsm.disableAutoReconnect()},t.prototype.getServerState=function(){return new w.ServerState(this.connectionId,this.connectedClientId,this.domId?this.domId:"",this.allocateResult?this.allocateResult.url:"",this.allocateResult?this.allocateResult.surl:"",this.c2cUrlBase,this.connectionExpireTimestampInSecs)},t.prototype.getState=function(){return this.fsm.getState()},t.prototype.getToken=function(g,m,S,v,C){var _=this;void 0===C&&(C=0),this.logger.info("Getting token "+(m?"with backoff":"without backoff"));var s=function(){_.connectionTracker.trackStart("token");var m={needFresh:!g,wwwAuthenticateHeader:S,supportedTokenTypes:A.SUPPORTED_TOKEN_TYPES,purpose:"trouter"};_.logger.info("Requesting token: needFresh="+m.needFresh+" types=["+A.SUPPORTED_TOKEN_TYPES+"], wwwAuthenticateHeader is "+(m.wwwAuthenticateHeader?"non empty":"empty")),_.tokenProvider(m).then((function(g){_.logger.debug(g.tokenType+" token is received"),_.connectionTracker.trackEnd("token"),_.fsm.onTokenReceived(g,v,_.reconnectParams)})).catch((function(m){var E=(0,I.toJson)(m.stack);if(_.logger.error("Getting token failed, will retry after timeout. Error: "+E),_.connectionTracker.trackError("token",E),!_.canRetryTokenFetchRequest(C+_.unauthorizedErrorCount))return _.connectionTracker.trackError("token","getToken retry limit hit, reached terminal error state"),_.resetTokenBackoff(),void _.fsm.onTerminalError();_.getToken(g,!0,S,v,C+1)}))};m?this.tokenBackoff.backoff("getting token",s):(this.resetTokenBackoff(),s())},t.prototype.startConnectionTimer=function(){var g=this;this.stopConnectionTimer(),this.logger.debug("Starting connection timeout for "+this.timeoutOptions.connectionTimeoutMs+" ms"),this.connectionTimeoutId=setTimeout((function(){g.logger.info("Connection timeout is fired"),g.fsm.onConnectingTimeout()}),this.timeoutOptions.connectionTimeoutMs)},t.prototype.stopConnectionTimer=function(){this.connectionTimeoutId&&(this.logger.debug("Stopping connection timeout"),clearTimeout(this.connectionTimeoutId),this.connectionTimeoutId=void 0)},t.prototype.startPingTimer=function(){var g=this;"websocket"===this.transportTypeName?(this.logger.debug("Starting ping timeout for "+this.timeoutOptions.pingTimeoutMs+" ms"),this.pingTimerId=setInterval((function(){g.logger.info("Ping interval fired"),g.fsm.onPingInterval()}),this.timeoutOptions.pingTimeoutMs)):this.logger.debug("Not starting ping for transport "+this.transportTypeName)},t.prototype.stopPingTimer=function(){this.pingTimerId&&(this.logger.debug("Stopping ping timeout"),this.clearPingResponseTimer(),clearInterval(this.pingTimerId),this.pingTimerId=void 0)},t.prototype.shouldSkipRegistration=function(){return void 0===this.options.registration},t.prototype.hasCustomRegistrationTtl=function(){var g,m;return void 0!==(null===(g=this.options.registration)||void 0===g?void 0:g.registrarTtlSec)&&0!==(null===(m=this.options.registration)||void 0===m?void 0:m.registrarTtlSec)},t.prototype.startRegistrationTimer=function(){var g=this;this.stopRegistrationTimer();var m=this.getRegistrationTtl(),S=m[0],v=m[1];if(S<=30||!v)return this.logger.debug("Starting registration expiration timer (TTL "+S+" sec)"),void(this.registrationTimerId=setTimeout((function(){g.registrationTimerId=void 0,g.logger.warn("Registration expired but the connection is still alive. Should never happen"),g.dispatchUnregistered()}),1e3*S));var C=S-30;this.logger.debug("Starting registration extension timer for "+C+" sec"),this.registrationTimerId=setTimeout((function(){g.logger.info("Registration extension timer fired"),g.registrationTimerId=setTimeout((function(){g.registrationTimerId=void 0,g.logger.debug("Registration extension did not happen in time"),g.dispatchUnregistered()}),3e4),g.fsm.onRegistrationNearExpiry()}),1e3*C)},t.prototype.startRegistrationRetryTimer=function(){var g=this;this.stopRegistrationTimer(),this.registrationTimerId=setTimeout((function(){g.registrationTimerId=void 0,g.fsm.onRetryRegistration()}),123e3)},t.prototype.stopRegistrationTimer=function(){this.registrationTimerId&&(this.logger.debug("Stopping registration timeout"),clearTimeout(this.registrationTimerId),this.registrationTimerId=void 0)},t.prototype.resendRegistration=function(){if(!this.registrarClient)throw new Error("Trouter Client not configured to handle registrations");return this.fsm.onResendRegistration(),Promise.resolve()},t.prototype.buildSocketIoUrlParams=function(g,m){if(!this.allocateResult)throw new Error("Allocate result is undefined in buildSocketIoUrlParams()");for(var S={},v=this.allocateResult.connectparams,C=0,_=Object.keys(v);C<_.length;C++){var E=_[C];if(void 0!==v[E]){var T=v[E];"string"==typeof T||"number"==typeof T?S[E]=T:this.logger.error("signatureData["+E+"] has unsupported type "+typeof T)}}return S.v="v4",S.tc=encodeURI((0,I.toJson)(this.clientInfo)),S.timeout=this.timeoutOptions.pingTimeoutMs/1e3,S.auth="true",this.options.endpointId&&(S.epid=this.options.endpointId),g&&(S.userActivity=encodeURI((0,I.toJson)(g))),m&&(S.audienceSubscriptionState=encodeURIComponent((0,I.toJson)(m))),this.appendConnectedClientIds(this.buildQuery(S),!0)},t.prototype.startSocketIo=function(g){var m,S;if(this.logger.debug("Starting socket io"),this.connectionTracker.trackStart("connectSocket"),!this.allocateResult)throw new Error("Allocate result is undefined in startSocketIo()");var C=this.options.ioOptions?v({},this.options.ioOptions):new F,_=this.userActivityState.state!==M.UserActivityState.Unknown?this.userActivityState.increaseCvAndGetEventObject():void 0,E=null===(m=this.audienceSubscriptionState)||void 0===m?void 0:m.increaseCvAndGetEventObject();if(C["force new connection"]=!0,C.reconnect=!1,C.rewriteUrlForProxy=this.options.rewriteUrlForProxy,C.requestHeaders=v(v({},this.options.extraConnectionHeaders),o(g,this.usingLegacyTokenApi)),C.query=this.buildSocketIoUrlParams(_,E),this.logger.info("connecting to "+this.allocateResult.socketio+"?"+C.query),this.stopSocketIo(),this.socket=(null!==(S=this.options.io)&&void 0!==S?S:k).connect(this.allocateResult.socketio,C),void 0===this.socket)throw new Error("Can't create Socket.io object");this.attachSocketIoHandlers(this.socket,g,_,E)},t.prototype.stopSocketIo=function(){if(this.socket){this.logger.debug("clearing socket.io");try{for(var g=0,m=["connecting","connect","connect_failed","close_during_connecting","disconnect","reconnect","reconnect_failed","reconnecting","error","message","trouter.connected","trouter.reconnect","trouter.message_loss"];g<m.length;g++){var S=m[g];this.socket.removeAllListeners(S)}this.socket.disconnect(),this.logger.debug("cleared socket"),this.socket=void 0}catch(g){this.logger.error("exception in disconnecting previous socket. Error: "+r(g))}}},t.prototype.dispatchConnected=function(){this.logger.info("dispatching connected"),this.manager.onConnected(this)},t.prototype.dispatchRegistered=function(){this.logger.info("dispatching registered"),this.manager.onRegistered(this)},t.prototype.dispatchUnregistered=function(){this.logger.info("dispatching unregistered"),this.manager.onUnregistered(this)},t.prototype.dispatchDownstreamRequest=function(g){var m=this;this.logger.debug("dispatching downstream request");try{var S=new V(g,new b.ResponseData(g.id),(function(g,S){return m.logger.debug("sending response to downstream"),m.sendResponse(g,S)}));this.manager.onDownstreamRequest(this,g,S)}catch(g){this.logger.error("exception in socket.on message. Error : "+r(g))}},t.prototype.dispatchReconnecting=function(){this.logger.info("dispatching reconnecting"),this.manager.onReconnecting(this)},t.prototype.dispatchReconnectIsRequired=function(g,m){this.logger.info("dispatching reconnect is required by server"),this.manager.onReconnectIsRequired(this,g,m)},t.prototype.dispatchDisconnected=function(){this.logger.info("dispatching disconnected"),this.manager.onDisconnected(this)},t.prototype.dispatchTerminalError=function(){this.logger.info("dispatching terminal error"),this.manager.onTerminalError(this)},t.prototype.dispatchTrouterMessageLost=function(g){this.logger.info("dispatching trouter message lost"),this.manager.onTrouterMessageLost(g)},t.prototype.countDisconnectBeforeConnectionEstablishment=function(){this.logger.warn("counting disconnect before connection was fully established as a connection failure"),++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold()},t.prototype.sendProcessedDroppedIndicators=function(g){var m=this;try{this.logger.debug("emitting processed flow tags to the server");var S=new B("trouter.processed_message_loss");S.args={droppedIndicators:g},this.sendDownstreamEvent(S,(function(){m.logger.info("emitted processed flow tags to the server")}))}catch(g){var v=r(g);this.logger.error("unable to send processed message loss event. Error: "+v),this.connectionTracker.trackError("trouter.processed_message_loss",v,!1)}},t.prototype.sendAllocateRequest=function(g){var m=this;this.connectionAttempt++,this.connectionTracker.trackNewConnection();var S,C=this.options.trouterUrl,_=this.reconnectParams,E="string"==typeof(null==_?void 0:_.se)?parseInt(_.se,10):"number"==typeof(null==_?void 0:_.se)?_.se:void 0;E&&E<=Date.now()+36e5&&(this.logger.warn("Dropping expired cached connection parameters: "+new Date(E)),this.reconnectParams=_=void 0),_&&_.serviceUrl!==C&&(this.logger.warn("Dropping cached connection parameters for a different environment ("+_.serviceUrl+", now "+C+")"),this.reconnectParams=_=void 0),(null==_?void 0:_.reconnectUrl)&&(C=_.reconnectUrl),S=_?v(v({},_),{serviceUrl:void 0,reconnectUrl:void 0}):null,C=(0,O.adaptUrl)(C,"v4a"),C=this.appendCorrelationIds(C,!1),C=this.appendEndpointId(C,!1),S&&(C+="&"+this.buildQuery(S),S.v||(C+="&v=v4")),C=this.options.rewriteUrlForProxy(C);var T=new Request(C,{method:"POST",mode:"cors",headers:new Headers(v(v({"Content-Type":"text/plain"},this.options.extraConnectionHeaders),o(g,this.usingLegacyTokenApi)))});this.logger.info("sendAllocateRequest: POST "+C),this.connectionTracker.trackStart("allocation");var b,A=Date.now(),R=-1,P=!1;(0,I.fetchWithTimeout)(T,this.timeoutOptions.fetchTimeoutMs).then((function(g){var S;if(R=g.status,!g.ok)throw b=null!==(S=g.headers.get("www-authenticate"))&&void 0!==S?S:void 0,P="1"===g.headers.get("x-trouter-skypetoken-deprecated"),m.logger.warn("Allocation request got response status "+g.status+", www-authenticate header was "+(b?"not empty":"empty")),new Error(g.statusText);var v=g.headers.get("content-type");if(!v||"application/json"!==v&&!v.startsWith("application/json;"))throw new Error("Content-type '"+v+"' is unexpected");return m.connectionTracker.trackEnd("allocation"),g.json()})).then((function(S){m.unauthorizedErrorCount=0,m.onAllocationResponse(S,g)})).catch((function(g){m.connectingErrorsInRow++;var S=g+(R>=0?", status code "+R:"");if(m.logger.error(m.connectingErrorsInRow+" failed connecting attempt(s) in a row. "+S),m.connectionTracker.trackError("allocation",S),P){var v="Skypetoken deprecated response, not retrying any further";return m.logger.error(v),m.connectionTracker.trackError("allocation",v),void m.fsm.onTerminalError()}if(401===R&&m.unauthorizedErrorCount++,!m.canRetryTokenFetchRequest(m.unauthorizedErrorCount))return v="getToken retry limit hit, reached terminal error state",m.connectionTracker.trackError("allocation",v),void m.fsm.onTerminalError();if(-1!==R||m.isNavigatorOnline){if(m.reconnectParams&&m.connectingErrorsInRow>=m.connectingErrorsThreshold)if(R>=400&&R<=599)m.resetReconnectParamsOnErrorThreshold();else if(m.reconnectParams.reconnectUrl&&m.connectingErrorsInRow%3==0){m.logger.warn(m.connectingErrorsInRow+" connection attempts, testing nominal service URL");var C=Math.min(m.timeoutOptions.connectionTimeoutMs-(Date.now()-A)-500,m.timeoutOptions.fetchTimeoutMs);return void m.testNominalUrlConnectivity(C).then((function(g){m.connectionTracker.trackProgress("nomcheck",g?"ok":"failed"),g?(m.logger.warn("Nominal service URL is reachable, erasing cached reconnect URL"),m.reconnectParams&&delete m.reconnectParams.reconnectUrl):m.logger.warn("Nominal service URL is not reachable either, keeping cached reconnect URL"),m.fsm.onAllocationFailed(!1,void 0)}),(function(){m.fsm.onAllocationFailed(!1,void 0)}))}}else m.logger.info("Expected failure, the browser says it is not online at the moment");m.fsm.onAllocationFailed(401===R,b)}))},t.prototype.testNominalUrlConnectivity=function(g){var m,S=this;if(g<1e3)return this.logger.warn("There is no time left to reasonably perform the nominal service URL connectivity check ("+g+" ms), falling back to assuming that the connectivity is fine"),Promise.resolve(!0);try{var v=new URL(this.options.trouterUrl);v.pathname="/",v.search="?"+this.buildQuery({check:Date.now(),cor_id:encodeURIComponent(this.options.clientCorrelationID),epid:encodeURIComponent(this.options.endpointId?this.options.endpointId:""),tc:encodeURIComponent((0,I.toJson)(this.clientInfo))}),m=new Request(this.options.rewriteUrlForProxy(v.toString()),{method:"GET",headers:{Accept:"text/plain"}})}catch(g){return this.logger.warn("Nominal service URL connectivity test request could not be created ("+g+"), falling back to assuming that the connectivity is fine"),Promise.resolve(!0)}return(0,I.fetchWithTimeout)(m,g).then((function(g){if(200!==g.status)throw new Error("Not 200 OK: "+g.status+" "+g.statusText);return g.text()})).then((function(g){if("Trouter"!==g)throw new Error('Not "Trouter": '+g.substring(0,16)+(g.length>16?"...":""));return!0})).catch((function(g){return S.logger.error("Nominal service URL connectivity test failed: "+g),!1}))},t.prototype.sendPingRequest=function(){var g=this;if(this.socket&&void 0===this.pingResponseTimerId)try{this.logger.debug("emitting ping event");var m=!1;this.socket.emit("ping",(function(){!0!==m&&g.onPingResponse()})),this.pingResponseTimerId=setTimeout((function(){g.logger.error("Ping response timeout is fired"),m=!0,g.clearPingResponseTimer(),g.fsm.onPingResponseTimeout()}),this.timeoutOptions.pongTimeoutMs)}catch(g){var S=r(g);this.logger.error("unable to send ping. Error: "+S),this.connectionTracker.trackError("ping",S,!1)}},t.prototype.connectV4c=function(g,m){var S,C,_,E,T,I,b=this.options.ioOptions?v({},this.options.ioOptions):new F;b["force new connection"]=!0,b.reconnect=!1,(null===(S=this.reconnectParams)||void 0===S?void 0:S.serviceUrl)&&(0,O.adaptUrl)(this.reconnectParams.serviceUrl,"v4c")!==(0,O.adaptUrl)(this.options.trouterUrl,"v4c")&&(this.logger.warn("Dropping cached connection parameters for a different environment ("+this.reconnectParams.serviceUrl+", now "+this.options.trouterUrl+")"),this.reconnectParams=void 0);var A=null!==(E=null!==(C=(0,O.redirectUrlIfPresent)(m))&&void 0!==C?C:"redirect-no-host"!==(null==m?void 0:m.kind)?null===(_=this.reconnectParams)||void 0===_?void 0:_.reconnectUrl:void 0)&&void 0!==E?E:this.options.trouterUrl,R=(0,O.adaptUrl)(A,"v4c");b["skipped handshake data"]={timeout:70,websocketUrl:R},b.query=this.buildV4cUrlParams(),b.rewriteUrlForProxy=this.options.rewriteUrlForProxy;try{if(this.stopSocketIo(),this.transportTypeName="websocket",this.socket=(null!==(T=this.options.io)&&void 0!==T?T:k).connect(this.options.trouterUrl,b),void 0===this.socket)throw new Error("failed to create Socket.io object");var P=null===(I=this.audienceSubscriptionState)||void 0===I?void 0:I.increaseCvAndGetEventObject();this.attachSocketIoHandlers(this.socket,g,void 0,P)}catch(g){this.logger.error(""+g),this.connectionTracker.trackError("v4c",""+g),this.fsm.onV4cException()}},t.prototype.sendV4cAuthenticationEvent=function(g){var m,S={headers:v(v({},this.options.extraConnectionHeaders),o(g,this.usingLegacyTokenApi)),connectparams:(0,O.reconnectParamsWithoutUrls)(this.reconnectParams)};null===(m=this.socket)||void 0===m||m.emit(A.USER_AUTHENTICATE_EVENT_NAME,S)},t.prototype.setUserActivityState=function(g){var m=g.state!==this.userActivityState.state;this.userActivityState=g,m?(this.logger.info("Changing user activity state to '"+g.toEventJSON()+"'"),this.fsm.onSetNewUserActivityState()):(this.logger.debug("Not changing the same user activity state '"+g.toEventJSON()+"'"),this.manager.onUserActivityStateAccepted(g.correlationVector.value()))},t.prototype.sendUserActivityState=function(g,m){this.userActivityState.state!==M.UserActivityState.Unknown&&("websocket"===this.transportTypeName&&m?g===w.UserActivityEventReason.Connected?this.sendUserActivityStateMultiple(2):this.sendUserActivityStateMultiple(1):"xhr-polling"===this.transportTypeName&&g===w.UserActivityEventReason.Modified&&this.fsm.forceReconnect("user activity/force reconnect"))},t.prototype.setAudienceSubscriptionsAsync=function(g,m){var S=this.audienceSubscriptionState;if(this.audienceSubscriptionState=g,this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME)return this.setAudienceSubscriptionsInternalAsync(g.increaseCvAndGetEventObject(),m);if(this.transportTypeName===this.XHR_POLLING_TRANSPORT_NAME){var v=this.setAudienceSubscriptionsLongpollInternalAsync(g.increaseCvAndGetEventObject(),m,S);return this.fsm.forceReconnect("set audience subscription force reconnect"),v}throw new Error("set audience subscription executed on an unknown transport")},t.prototype.setAudienceSubscriptionsUnsafeAsync=function(g){if(g)return this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME?this.setAudienceSubscriptionsInternalAsync(g,15e3):void 0},t.prototype.setAudienceSubscriptionsInternalAsync=function(g,m){return C(this,void 0,void 0,(function(){var S,v,C=this;return _(this,(function(_){switch(_.label){case 0:return this.logger.info("[WebSocket] Audience subscription set requested."),(S=new B("audience.subscribe")).args=g,[4,new Promise((function(v){var _=!1,E=setTimeout((function(){return _=!0,v(C.buildAudienceSubscriptionsTimeoutResponse(g))}),m);C.sendDownstreamEvent(S,(function(g,m){_||(clearTimeout(E),C.logger.debug("[Websocket] Audience subscription response: "+m),C.pendingAudienceSubscription&&C.onAudienceSubscriptionResult(m),v(m))}))}))];case 1:return v=_.sent(),this.manager.onAudiencesSetResolved(v,g.cv),[2,v]}}))}))},t.prototype.setAudienceSubscriptionsLongpollInternalAsync=function(g,m,S){var v;return C(this,void 0,void 0,(function(){var C,E,T,I,b,A,R=this;return _(this,(function(_){switch(_.label){case 0:return this.logger.info("[XHR Polling] Audience subscription set requested."),this.pendingAudienceSubscription&&(this.logger.error("Racing audience subscriptions occured. This situation resolves into undefined scenario and/or nasal demons."),clearTimeout(this.pendingAudienceSubscription.timeoutId)),0===g.audiences.length?[2,this.handleAudienceUnsubscribeLongpoll(g.cv,S)]:[4,new Promise((function(S){var v=setTimeout((function(){return R.pendingAudienceSubscription=void 0,S(R.buildAudienceSubscriptionsTimeoutResponse(g))}),m);R.pendingAudienceSubscription={audienceSetResolve:S,timeoutId:v}}))];case 1:return C=_.sent(),this.manager.getState()===M.TrouterState.Unknown||this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME?[2,C]:(null==(E=C.responses[0])?void 0:E.result.audienceSubscriptionState)===this.AUDIENCE_SUBSCRIPTION_RESULT_BAD_REQUEST?(this.clearAudienceSubscriptionStateQueryParam(),this.manager.onAudiencesSetResolved(C,g.cv),[2,C]):(T=C.responses.find((function(m){return m.audienceId===g.audiences[0].id})),(null==T?void 0:T.result.audienceSubscriptionState)===this.AUDIENCE_SUBSCRIPTION_RESULT_ERROR?(this.clearAudienceSubscriptionStateQueryParam(),this.manager.onAudiencesSetResolved(C,g.cv),[2,C]):(I=(null===(v=null==S?void 0:S.audienceSubscriptionModel.audienceSubscriptions[0])||void 0===v?void 0:v.id)!==(null==E?void 0:E.audienceId),S&&I&&(b=this.mapToSyntheticAudienceSubscriptionResponses(S.audienceSubscriptionModel.audienceSubscriptions,this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED,200),(A=C.responses).push.apply(A,b)),this.manager.onAudiencesSetResolved(C,g.cv),[2,C]))}}))}))},t.prototype.clearAudienceSubscriptionStateQueryParam=function(){var g,m,S;(null===(S=null===(m=null===(g=this.socket)||void 0===g?void 0:g.socket)||void 0===m?void 0:m.options)||void 0===S?void 0:S.query)&&(this.socket.socket.options.query=this.socket.socket.options.query.replace(this.AUDIENCE_SUBSCRIPTION_STATE_QUERY_PARAM_REGEX,""))},t.prototype.handleAudienceUnsubscribeLongpoll=function(g,m){var S;this.audienceSubscriptionState=void 0;var v={responses:[]};if(m){var C=this.mapToSyntheticAudienceSubscriptionResponses(m.audienceSubscriptionModel.audienceSubscriptions,this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED,200);(S=v.responses).push.apply(S,C)}return this.manager.onAudiencesSetResolved(v,g),v},t.prototype.buildAudienceSubscriptionsTimeoutResponse=function(g){return this.logger.error("Audience subscription attempt has timed out."),{responses:this.mapToSyntheticAudienceSubscriptionResponses(g.audiences,this.AUDIENCE_SUBSCRIPTION_RESULT_TIMEOUT)}},t.prototype.mapToSyntheticAudienceSubscriptionResponses=function(g,m,S){return g.map((function(g){return{audienceId:g.id,result:{audienceSubscriptionState:m,responseStatus:S}}}))},t.prototype.sendRegisterRequest=function(){var g=this;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");if(!this.allocateResult)throw new Error("Allocate result is undefined in sendRegisterRequest()");this.logger.info("sending register request");var m=new I.Timespan;this.connectionTracker.trackStart("registration");var S=this.getRegistrationTtl()[0];this.registrarClient.register({appId:this.options.registration.pnhAppId,aesKey:"",languageId:"en-US",platform:this.options.registration.platform,templateKey:this.options.registration.pnhTemplateKey,platformUIVersion:this.options.registration.platformUIVersion,productContext:this.options.registration.productContext},{TROUTER:[{context:this.options.registration.context,path:this.allocateResult.surl,ttl:S}]}).then((function(){g.logger.info("Register request successful"),g.connectionTracker.trackEnd("registration"),g.fsm.onRegistrationSucceeded(),g.connectionTracker.sendTelemetry(b.ClientEventName.Registration,{duration:m.duration},[])})).catch((function(S){g.logger.error("Register request failed. Error: "+S),g.connectionTracker.trackError("registration",s(S)),g.fsm.onRegistrationFailed(),g.connectionTracker.sendTelemetry(b.ClientEventName.Registration,{duration:m.duration},[])}))},t.prototype.sendUnregisterRequest=function(){var g=this;this.logger.info("sending unregister request");var m=new I.Timespan;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");this.connectionTracker.trackStart("unregistration"),this.registrarClient.unregister().then((function(){g.logger.info("Unregister request successful"),g.connectionTracker.trackEnd("unregistration"),g.fsm.onUnregistrationDone(),g.connectionTracker.sendTelemetry(b.ClientEventName.Unregistration,{duration:m.duration},[])})).catch((function(S){g.logger.error("Unregister request failed. Error: "+S),g.connectionTracker.trackError("unregistration",s(S)),g.fsm.onUnregistrationDone(),g.connectionTracker.sendTelemetry(b.ClientEventName.Unregistration,{duration:m.duration},[])}))},t.prototype.resetTokenBackoff=function(){this.tokenBackoff.reset()},t.prototype.cancelPendingRegistrationRequests=function(){this.registrarClient&&this.registrarClient.cancelPendingRequests()},t.prototype.clearSentEventTimers=function(){var g=Object.keys(this.pendingSentEventTimers);if(g.length>0){this.logger.debug("Clearing all pending downstream events related timers");for(var m=0,S=g;m<S.length;m++){var v=S[m];this.clearSentEventTimer(Number(v))}}},t.prototype.restartIncallModeTimer=function(){var g=this;this.clearIncallModeTimerId(),this.logger.debug("Restarting incall mode timer"),this.incallModeTimerId=setTimeout((function(){g.logger.info("Call mode timer fired"),g.fsm.onIncallModeTimer()}),this.options.incallModeTimeoutMs)},t.prototype.enterIncallMode=function(){this.logger.info("Entering incall mode"),this.timeoutOptions=this.options.incallTimeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!0},t.prototype.exitIncallMode=function(){this.logger.info("Exiting incall mode"),this.clearIncallModeTimerId(),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!1},t.prototype.isIncallMode=function(){return this.inIncallMode},t.prototype.sendDisconnectTelemetryEvent=function(g){var m={reason:g,serverClosed:!this.fsm.isActive()};this.connectionTracker.trackDisconnected(m),this.connectionTracker.clearConnectedInfo()},t.prototype.forceReconnectDueToNoRegistration=function(){this.fsm.forceReconnect("force reconnect due to no registration")},t.prototype.resetReconnectParamsOnErrorThreshold=function(){this.logger.warn(this.connectingErrorsInRow+" connection attempts, server-side failure: erasing cached connection parameters"),this.reconnectParams=void 0},t.prototype.onSocketConnecting=function(g){this.logger.info("onSocketConnecting("+g+")"),this.transportTypeName=g,this.connectionTracker.trackProgress("connecting",this.transportTypeName),this.fsm.onConnecting()},t.prototype.onSocketConnect=function(g){this.logger.info("onSocketConnect"),this.fsm.onSocketConnect(g)},t.prototype.onSocketConnectFailed=function(g){this.logger.error("onSocketConnectFailed"),this.connectionTracker.trackError("connect_failed",g,!0,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),this.fsm.onConnectingFailed()},t.prototype.onSocketDisconnect=function(g){var m=this.connectionTracker.getSessionLength()||0,S=R.DisconnectReason.fromRawReason(g);this.logger.error("onSocketDisconnect, reason: "+S.reason),"dup"===S.reason&&"dup"===this.lastDisconnectReason&&m<this.options.duplicateDisconnectThresholdMs&&(this.logger.warn("Socket was closed by server as Duplicate for the second time in a row after "+m+" ms which is below the threshold of "+this.options.duplicateDisconnectThresholdMs+" ms. Resetting cached connection parameters and making a new allocation."),this.reconnectParams=void 0),this.lastDisconnectReason=S.reason,this.fsm.onSocketDisconnect(S),this.connectionExpireTimestampInSecs=void 0},t.prototype.onSocketReconnect=function(){this.logger.error("onSocketReconnect"),this.fsm.onTrouterConnected()},t.prototype.onSocketReconnectFailed=function(g){this.logger.error("onSocketReconnectFailed with '"+g+"'"),this.fsm.onSocketDisconnect(R.DisconnectReason.fromSocketIoEventData("reconnecterror",g))},t.prototype.onSocketReconnecting=function(){this.logger.error("onSocketReconnecting")},t.prototype.onSocketError=function(g){this.logger.error("onSocketError with '"+(0,I.toJson)(g)+"'"),this.fsm.isConnecting()&&++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold(),this.connectionTracker.trackError("connectSocket",i(g)),this.fsm.onSocketDisconnect(R.DisconnectReason.fromSocketIoEventData("socketerror",g))},t.prototype.onSocketMessage=function(g){var m,S,v=this;this.logger.debug("onSocketMessage");try{var C=null===(m=(S=new U(g,this.logger)).headers)||void 0===m?void 0:m["X-Microsoft-Skype-Chain-ID"],_=C?" Chain-Id "+C:"";this.logger.info("Received request N "+S.id+_+" CV "+S.correlationVector+" to '"+S.url+"'"),S.startTS=Date.now(),S.url&&this.urlPath&&S.url.startsWith(this.urlPath)&&(S.shortUrl=S.url.substring(this.urlPath.length))}catch(g){var E=r(g);return this.logger.error("unable to parse request. Error: "+E),this.connectionTracker.trackRequest(void 0,E),void this.connectionTracker.sendResponseError("unable to parse request, error: "+g)}S.timeoutTimerId=setTimeout((function(){if(!S.replied){v.logger.error("Request "+S.id+" timed out");var g=new b.ResponseData(S.id);g.status=504,g.headers={"Trouter-Responder":"ClientLib"},v.sendResponse(S,g),S.timedout=!0}}),this.timeoutOptions.requestTimeoutMs);try{this.connectionTracker.trackRequest(S),this.fsm.onDownstreamRequest(S)}catch(g){this.logger.error("exception in socket.on message. Error: "+r(g)),this.connectionTracker.sendResponseError(s(g),S,void 0)}},t.prototype.onTrouterConnected=function(g,m,S){var C,_,E,T,b=this;if((0,O.isV4ConnectEvent)(g)){var A=g;this.allocateResult=v(v({},A),{ttl:g.ttl.toString()}),this.populateAndCacheReconnectParams(A,A.reconnectUrl),this.populateConnectionStateFields(A)}else if(!this.allocateResult)return void this.logger.error("Invalid internal state - received onTrouterConnected while allocateResult is not set");this.connectingErrorsInRow=0,this.logger.info("onTrouterConnected: "+this.allocateResult.url),"xhr-polling"===this.transportTypeName&&m&&this.manager.onUserActivityStateAccepted(m.cv),(null===(E=null===(_=null===(C=this.socket)||void 0===C?void 0:C.socket)||void 0===_?void 0:_.options)||void 0===E?void 0:E.query)&&(this.socket.socket.options.query+="&connected=true"),this.urlPath=this.allocateResult.url.replace(/https?:\/\/([A-z0-9\:\$\-\_\.\+\!\*\"\(\)\,]*)\//,"/");var R=this.connectedUrl!==this.allocateResult.url;this.connectedUrl=this.allocateResult.url,this.connectionExpireTimestampInSecs=(0,I.calculateExpireTsInSec)((0,O.ensureNumber)(g.ttl)),this.connectionTracker.trackEnd("connectSocket"),this.connectionTracker.trackConnected(R,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),null===(T=this.setAudienceSubscriptionsUnsafeAsync(S))||void 0===T||T.catch((function(g){return b.logger.error("Re-subscribe to audiences has failed with "+g)})),this.fsm.onTrouterConnected()},t.prototype.onTrouterReconnect=function(g){var m=g.target;this.logger.info("onTrouterReconnect target: "+m),"self"===m?this.fsm.onReconnectRequired(!0,E.ServerInitiated):this.fsm.onReconnectRequired(!1,E.ServerInitiated,g)},t.prototype.onTrouterMessageLoss=function(g){this.logger.debug("onTrouterMessageLoss"),this.fsm.onTrouterMessageLost(g.droppedIndicators)},t.prototype.onAudienceSubscriptionResult=function(g){this.logger.info("onAudienceSubscriptionResult"),this.pendingAudienceSubscription&&(clearTimeout(this.pendingAudienceSubscription.timeoutId),this.pendingAudienceSubscription.audienceSetResolve(g),this.pendingAudienceSubscription=void 0)},t.prototype.buildV4cUrlParams=function(){var g={};return g.tc=encodeURI((0,I.toJson)(this.clientInfo)),g.timeout=Math.floor(this.timeoutOptions.pingTimeoutMs/1e3),this.options.endpointId&&(g.epid=this.options.endpointId),this.appendConnectedClientIds(this.buildQuery(g),!0)},t.prototype.attachSocketIoHandlers=function(g,m,S,v){var C=this;g.on("connecting",(function(g){C.onSocketConnecting(g)})),g.on("connect",(function(){C.onSocketConnect(m)})),g.on("connect_failed",(function(g){C.onSocketConnectFailed(g)})),g.on("close_during_connecting",(function(g){C.onSocketConnectFailed(g)})),g.on("disconnect",(function(g){C.onSocketDisconnect(g)})),g.on("reconnect",(function(){C.onSocketReconnect()})),g.on("reconnect_failed",(function(g){C.onSocketReconnectFailed(g)})),g.on("reconnecting",(function(){C.onSocketReconnecting()})),g.on("error",(function(g){C.onSocketError(g)})),g.on("message",(function(g){C.onSocketMessage(g)})),g.on("trouter.connected",(function(g){C.onTrouterConnected(g,S,v)})),g.on("trouter.reconnect",(function(g){C.onTrouterReconnect(g)})),g.on("trouter.message_loss",(function(g){C.onTrouterMessageLoss(g)})),g.on("audience.subscriptionresult",(function(g,m){C.onAudienceSubscriptionResult(m)}))},t.prototype.onNavigatorOnlineStatusUpdate=function(){var g=window.navigator.onLine;this.logger.debug("Browser online status update - new state: "+g+", previously: "+this.isNavigatorOnline),g&&!this.isNavigatorOnline?(this.isNavigatorOnline=!0,this.tokenBackoff.expediteIfPending(),this.connectionTracker.trackProgress("browserNet","online")):!g&&this.isNavigatorOnline&&(this.isNavigatorOnline=!1,this.connectionTracker.trackProgress("browserNet","offline"))},t.prototype.onAllocationResponse=function(g,m){this.logger.info("Received allocation response "+JSON.stringify(g)),this.allocateResult=g,this.populateAndCacheReconnectParams(this.allocateResult,this.allocateResult.socketio+"v4/a"),this.populateConnectionStateFields(this.allocateResult),this.fsm.onAllocationSucceed(m)},t.prototype.populateAndCacheReconnectParams=function(g,m){this.reconnectParams=v({serviceUrl:this.options.trouterUrl,reconnectUrl:m},g.connectparams),this.manager.onConnectionParametersUpdated(this.reconnectParams)},t.prototype.populateConnectionStateFields=function(g){var m,S,v="string"==typeof g.ttl?parseInt(g.ttl,10):g.ttl;if(this.connectionExpireTimestampInSecs=(0,I.calculateExpireTsInSec)(v),this.connectionId=null!==(m=g.id)&&void 0!==m?m:"",this.connectedClientId=g.ccid,this.logger.debug("connected client id set {connectedClientId:"+this.connectedClientId+"}"),this.c2cUrlBase=null!==(S=g.curlb)&&void 0!==S?S:"",""===this.c2cUrlBase){var C=g.surl.indexOf("://");C>=0&&(C=g.surl.indexOf("/",C+3))>=5&&":3443"===g.surl.substr(C-5,5)&&(this.c2cUrlBase=g.surl.substr(0,C-5))}},t.prototype.onPingResponse=function(){this.logger.debug("onPingResponse"),this.connectionTracker.increasePingResponseCount(),this.clearPingResponseTimer(),this.fsm.onPingResponse()},t.prototype.clearPingResponseTimer=function(){void 0!==this.pingResponseTimerId&&(clearTimeout(this.pingResponseTimerId),this.pingResponseTimerId=void 0)},t.prototype.buildQuery=function(g){for(var m=[],S=0,v=Object.keys(g);S<v.length;S++){var C=v[S];void 0!==g[C]&&m.push(C+"="+g[C])}return m.join("&")},t.prototype.appendConnectedClientIds=function(g,m){var S="";g.includes("ccid=")||(S="ccid="+this.connectedClientId+"&"),this.domId&&(S+="dom="+this.domId+"&"),S.length>0&&(S=S.slice(0,-1));var v=m||g.includes("?")?"&":"?";return this.appendCorrelationIds(g+v+S,m)},t.prototype.appendEndpointId=function(g,m){var S=m||g.includes("?")?"&":"?";return!g.includes("epid")&&this.options.endpointId?""+g+S+"epid="+this.options.endpointId:g},t.prototype.appendCorrelationIds=function(g,m){var S=m||g.includes("?")?"&":"?";return g.includes("cor_id")?g:""+g+S+"cor_id="+this.options.clientCorrelationID+"&con_num="+this.clientID+"_"+this.connectionAttempt},t.prototype.safeString=function(g){return"string"==typeof g?g:""},t.prototype.sendResponse=function(g,m){var S,v,C;if(g.timedout)return this.logger.error("Request "+g.id+" already timed out"),1;if(g.replied)return this.logger.error("Response for request "+g.id+" already sent"),2;clearTimeout(g.timeoutTimerId),g.timeoutTimerId=void 0,g.replied=!0,m.headers=null!==(S=m.headers)&&void 0!==S?S:{};var _=g.correlationVector;this.logger.info("Sending response N "+g.id+" CV "+_+" with status "+m.status),_&&(m.headers[x]=_),(null===(v=g.headers)||void 0===v?void 0:v["trouter-request"])&&(m.headers["trouter-request"]=g.headers["trouter-request"]);var E=Date.now()-g.startTS;if(m.headers["trouter-client"]=(0,I.toJson)({cd:E}),(null===(C=g.headers)||void 0===C?void 0:C["trouter-is-broadcast"])&&(m.headers["trouter-is-broadcast"]=g.headers["trouter-is-broadcast"]),this.logger.debug("response: "+(0,I.toJson)(m)),!this.socket)return this.connectionTracker.sendResponseError("no socket",g,m),4;try{return this.socket.send((0,I.toJson)(m)),m.sentTS=Date.now(),g.incrementCorrelationVector(),this.connectionTracker.trackResponse(g,E,m),"websocket"===this.transportTypeName&&this.sendPingRequest(),0}catch(S){var T="unable to send data on response.end. Error: "+r(S);return this.logger.error(T),this.connectionTracker.sendResponseError(T,g,m),4}},t.prototype.sendUserActivityStateMultiple=function(g){var m=this,S=new B("user.activity"),v=this.userActivityState.increaseCvAndGetEventObject();S.args=v,this.logger.debug("Sending user activity '"+this.userActivityState.toEventJSON()+"', remaining "+(g-1));var C=!1;this.sendDownstreamEvent(S,(function(){if(!0!==C&&(m.logger.info("User activity state: "+v.state+", cv: "+v.cv+" accepted"),m.manager.onUserActivityStateAccepted(v.cv),m.clearSentEventTimer(S.timeoutTimerId),g>1)){var _=setTimeout((function(){m.clearSentEventTimer(_),m.sendUserActivityStateMultiple(g-1)}),m.options.userActivitySecondResendDelayMs);m.registerSentEventTimer(_,"user.activity/resend")}})),S.timeoutTimerId=setTimeout((function(){m.logger.error("Activity state response timeout is fired"),C=!0,m.fsm.onActivityStateResponseTimeout(),m.clearSentEventTimer(S.timeoutTimerId)}),this.timeoutOptions.userActivityResponseTimeoutMs),this.registerSentEventTimer(S.timeoutTimerId,"user.activity/response")},t.prototype.sendDownstreamEvent=function(g,m){this.logger.debug("Sending downstream event "+g.name),this.socket&&this.socket.emit(g.name,g.args,m)},t.prototype.registerSentEventTimer=function(g,m){this.logger.debug("registering timer "+g+" -> "+m),this.pendingSentEventTimers[g]=m},t.prototype.clearSentEventTimer=function(g){var m=this.pendingSentEventTimers[g];this.logger.debug("clearing timer "+g+" -> "+m),delete this.pendingSentEventTimers[g],clearTimeout(g)},t.prototype.getRegistrationTtl=function(){var g,m,S=(0,I.calculateTtlInSec)(this.connectionExpireTimestampInSecs);if(this.logger.debug("Current connectionID will expire in "+S+" seconds"),(null===(g=this.options.registration)||void 0===g?void 0:g.registrarTtlSec)&&S>0){var v=this.options.registration.registrarTtlSec<S;return[Math.min(this.options.registration.registrarTtlSec,S),v]}return(null===(m=this.options.registration)||void 0===m?void 0:m.registrarTtlSec)?[this.options.registration.registrarTtlSec,!1]:S>0?[S,!1]:[3600,!1]},t.prototype.clearIncallModeTimerId=function(){void 0!==this.incallModeTimerId&&(this.logger.debug("Clearing in-call mode timer"),clearTimeout(this.incallModeTimerId),this.incallModeTimerId=void 0)},t.prototype.applyConnectionTrackerOptions=function(g){try{g.eventLogger&&"function"==typeof g.eventLogger.logEvent?(this.connectionTracker.mergeSettings(g.telemetrySettings),this.connectionTracker.enable(g.eventLogger)):this.logger.warn("Trouter client event logging disabled due to invalid configuration.")}catch(g){this.logger.warn("Trouter client event logging disabled. Error: "+r(g)),this.connectionTracker.disable()}},t.prototype.canRetryTokenFetchRequest=function(g){var m=this.options.retryLimitOnTokenFetch;return null==m||g<m||(this.logger.warn("Reached limit on maximum number of token fetch request. Current count: "+g+", retry limit: "+m),!1)},t}();m.TrouterConnection=H},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.MessageHandlerRegistry=void 0;var v=S(1),C=S(0),_=function(){function t(g){this.messageHandlers=[],this.logger=new C.Logger("MessageHandlers",g)}return t.prototype.register=function(g){if(this.messageHandlers.some((function(m){return m===g})))throw new Error("Registering the same handler twice is not allowed");this.messageHandlers.push(g)},t.prototype.clear=function(){this.logger.debug("Clearing message handlers"),this.messageHandlers=[]},t.prototype.active=function(){return this.messageHandlers.length>0},t.prototype.handleMessage=function(g){for(var m={resultCode:v.UNHANDLED_MESSAGE_ACK,isHandled:!1},S=0,C=this.messageHandlers;S<C.length;S++){var _=C[S],E=this.safeExecuteHandle(_,g);if(void 0!==E&&(void 0===E.isHandled||E.isHandled))return void 0===E.resultCode&&(E.resultCode=v.HANDLED_MESSAGE_ACK),E}return m},t.prototype.safeExecuteHandle=function(g,m){try{return g.handleMessage(m)}catch(g){return void this.logger.warn("Trouter message handler threw an exception: "+g)}},t}();m.MessageHandlerRegistry=_},function(g,m,S){function o(g){var m,S=this;return function(_){return v(S,void 0,void 0,(function(){return C(this,(function(S){return _&&(m=void 0),[2,new Promise((function(S,v){g(_).then((function(g){m=g,S(g)})).catch((function(g){void 0!==m&&m.length>0&&S(m),v(g)}))}))]}))}))}}var v=this&&this.__awaiter||function(g,m,S,v){function i(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function s(g){try{a(v.next(g))}catch(g){C(g)}}function c(g){try{a(v.throw(g))}catch(g){C(g)}}function a(g){g.done?S(g.value):i(g.value).then(s,c)}a((v=v.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=(C=E.trys).length>0&&C[C.length-1])&&(6===_[0]||2===_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_};Object.defineProperty(m,"__esModule",{value:!0}),m.addCacheAsBackupTo=void 0,m.addCacheAsBackupTo=o},function(g,m,S){var v=this&&this.__awaiter||function(g,m,S,v){function i(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function s(g){try{a(v.next(g))}catch(g){C(g)}}function c(g){try{a(v.throw(g))}catch(g){C(g)}}function a(g){g.done?S(g.value):i(g.value).then(s,c)}a((v=v.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=(C=E.trys).length>0&&C[C.length-1])&&(6===_[0]||2===_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_};Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterManager=m.AudienceSubscriptionState=m.UserActivityObject=void 0;var _=S(3),E=S(2),T=S(4),I=S(0),b=S(5),A=S(18),R=S(7),P=S(6),M=S(19),w=function(){function t(g,m){this.state=g,this.correlationVector=void 0!==m?m:_.CorrelationVector.extend()}return t.prototype.getStateString=function(){switch(this.state){case E.UserActivityState.Active:return"active";case E.UserActivityState.Inactive:return"inactive";case E.UserActivityState.Unknown:return"unknown";default:return"undefined"}},t.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},t.prototype.toEventObject=function(){return{state:this.getStateString(),cv:this.correlationVector.value()}},t.prototype.toEventJSON=function(){return(0,_.toJson)(this.toEventObject())},t}();m.UserActivityObject=w;var D=function(){function t(g,m){void 0===m&&(m=_.CorrelationVector.extend()),this.audienceSubscriptionModel=g,this.correlationVector=m}return t.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},t.prototype.toEventObject=function(){return{audiences:this.audienceSubscriptionModel.audienceSubscriptions,cv:this.correlationVector.value()}},t.prototype.toEventJSON=function(){return(0,_.toJson)(this.toEventObject())},t}();m.AudienceSubscriptionState=D;var O=function(){function t(g,m,S,v,C,T){var A=this;this.logFunc=g,this.options=m,this.tokenProvider=S,this.usingLegacyTokenApi=v,this.listener=C,this.tokenTypeProtocolSelector=function(g,m){return A.options.forceV4aProtocol?"v4a":(0,b.usedProtocol)(g,m)},this.logger=new I.Logger("Manager",g),this.logger.info("Created TrouterManager with options "+(0,_.toJson)(this.options)),this.fsm=new M.TrouterManagerFsm(g,this),this.baseEndpointUrl="",this.processedMessageLoss={},this.userActivityObject=new w(E.UserActivityState.Unknown),this.protocolSelector=null!=T?T:this.tokenTypeProtocolSelector.bind(this)}return t.prototype.start=function(){this.fsm.start()},t.prototype.stop=function(g){this.fsm.stop(g)},t.prototype.configure=function(g){this.options=g,void 0!==this.firstConnection&&this.firstConnection.configure(g),void 0!==this.secondConnection&&this.secondConnection.configure(g),this.logger.info("Reconfigured TrouterManager with options "+(0,_.toJson)(this.options))},t.prototype.checkConnection=function(g){void 0!==this.firstConnection&&this.firstConnection.checkConnection(g),void 0!==this.secondConnection&&this.secondConnection.checkConnection(g)},t.prototype.resendRegistration=function(){return v(this,void 0,void 0,(function(){return C(this,(function(g){return void 0!==this.secondConnection?(this.logger.info("Resending registration on the second/new connection"),[2,this.secondConnection.resendRegistration()]):void 0!==this.firstConnection?(this.logger.info("Resending registration on the first/current connection"),[2,this.firstConnection.resendRegistration()]):(this.logger.info("No connection to resend registration on, will be done upon (re)connect"),[2])}))}))},t.prototype.getServerState=function(){if(void 0!==this.firstConnection)return this.firstConnection.getServerState()},t.prototype.getState=function(){return this.fsm.getState()},t.prototype.isInTerminalState=function(){return this.fsm.getInternalState()===T.TrouterManagerState.TerminalError},t.prototype.reportStateInfo=function(){var g=this.firstConnection?P.State[this.firstConnection.getState()]:"Unknown",m=T.TrouterManagerState[this.fsm.getInternalState()];return this.secondConnection?"Manager "+m+"; 1st "+g+"; 2nd "+P.State[this.secondConnection.getState()]:"Manager "+m+"; Connection "+g},t.prototype.startFirstConnection=function(){var g=new R.TrouterConnection(this.logFunc,this.options,this.configuredTrouterManager(),this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.firstConnection=g,this.getConnectionCache().then((function(m){g.start(m)})).catch((function(){}))},t.prototype.startSecondConnection=function(g){var m=new R.TrouterConnection(this.logFunc,this.options,this.configuredTrouterManager(),this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.secondConnection=m,void 0!==this.firstConnection&&this.firstConnection.disableRegistrationsAndAutoReconnect(),g?this.getConnectionCache().then((function(g){m.start(g)})).catch((function(){})):m.start()},t.prototype.stopFirstConnection=function(g){void 0!==this.firstConnection&&(this.storedFirstConnection=this.firstConnection,this.firstConnection.stop(g),this.firstConnection=void 0)},t.prototype.stopSecondConnection=function(g){void 0!==this.secondConnection&&(this.secondConnection.stop(g),this.secondConnection=void 0)},t.prototype.stopSecondConnectionDelayed=function(){if(void 0!==this.secondConnection){var g=this.secondConnection;this.secondConnection=void 0,this.logger.info("Closing an inactive connection in "+Math.round(this.options.lingeringConnectionDelayMs/1e3)+"s"),setTimeout((function(){g.stop(!0)}),this.options.lingeringConnectionDelayMs)}},t.prototype.forceStopLingeringConnection=function(){this.storedFirstConnection&&(this.storedFirstConnection.stop(!1),this.storedFirstConnection=void 0)},t.prototype.switchConnections=function(){var g=this.firstConnection;this.firstConnection=this.secondConnection,this.secondConnection=g},t.prototype.doesSecondConnectionExist=function(){return void 0!==this.secondConnection},t.prototype.dispatchConnected=function(){if(void 0!==this.firstConnection){var g=this.firstConnection.getServerState(),m=g.url.endsWith("/")?g.url.slice(0,-1):g.url,S={baseEndpointUrl:m,newEndpointUrl:m!==this.baseEndpointUrl,c2cUrlBase:g.c2cUrlBase,clientId:g.connectedClientId,connectionId:g.connectionId,connectionTtlSec:g.getRemainingTtlInSec()};this.baseEndpointUrl=m,this.listener.onTrouterConnected(g.url,S)}},t.prototype.dispatchDisconnected=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected()},t.prototype.dispatchTerminalError=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected()},t.prototype.dispatchRegistrationState=function(g){this.options.registrationStateCallback&&this.options.registrationStateCallback(g)},t.prototype.onDownstreamRequest=function(g,m,S){var v={id:m.id,method:m.method,path:"/"+m.shortUrl,body:m.body,headers:m.headers},C={id:m.id,status:0,headers:{},body:"",send:function(){return C.status<=100||C.status>=999?3:(S.writeHead(C.status,C.headers),S.end(C.body))}};this.listener.onTrouterRequest(v,C)},t.prototype.onConnected=function(g){this.fsm.onConnected(g===this.firstConnection)},t.prototype.onRegistered=function(g){this.fsm.onRegistered(g===this.firstConnection)},t.prototype.onUnregistered=function(g){this.fsm.onUnregistered(g===this.firstConnection||g===this.storedFirstConnection)},t.prototype.onReconnecting=function(g){this.fsm.onReconnecting(g===this.firstConnection)},t.prototype.onReconnectIsRequired=function(g,m,S){this.fsm.onReconnectionRequired(g===this.firstConnection,m,S)},t.prototype.onDisconnected=function(g){this.fsm.onDisconnected(g===this.firstConnection||g==this.storedFirstConnection),this.storedFirstConnection=void 0},t.prototype.onTerminalError=function(g){this.fsm.onTerminalError(g===this.firstConnection||g==this.storedFirstConnection),this.storedFirstConnection=void 0},t.prototype.onUserActivityStateAccepted=function(g){this.listener.onTrouterUserActivityStateAccepted&&this.listener.onTrouterUserActivityStateAccepted(g)},t.prototype.onAudiencesSetResolved=function(g,m){var S,v;null===(v=(S=this.listener).onAudiencesSetResolved)||void 0===v||v.call(S,g,m)},t.prototype.onConnectionParametersUpdated=function(g){this.setConnectionCache(g)},t.prototype.setUserActivityState=function(g,m){return this.userActivityObject=new w(g,_.CorrelationVector.extend(m)),void 0!==this.secondConnection?(this.logger.info("Setting user activity "+this.userActivityObject.toEventJSON()+" on the second/new connection"),void this.secondConnection.setUserActivityState(this.userActivityObject)):void 0!==this.firstConnection?(this.logger.info("Setting user activity "+this.userActivityObject.toEventJSON()+" on the first/current connection"),void this.firstConnection.setUserActivityState(this.userActivityObject)):void 0},t.prototype.setAudienceSubscriptionsAsync=function(g,m,S){if(this.audienceSubscriptionState=new D(g,_.CorrelationVector.extend(S)),this.secondConnection)return this.logger.info("Setting audience subscriptions "+this.audienceSubscriptionState.toEventJSON()+" on second/new connection"),this.secondConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,m);if(this.firstConnection)return this.logger.info("Setting audience subscriptions "+this.audienceSubscriptionState.toEventJSON()+" on first/current connection"),this.firstConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,m);throw new Error("No connection found")},t.prototype.onTrouterMessageLost=function(g){var m=this;if(this.listener.onTrouterMessageLoss)if(null==g?void 0:g.length){var S=g.filter((function(g){return void 0!==m.processedMessageLoss[g.tag+"-"+g.etag]}));if(S.length&&(this.logger.info("onTrouterMessageLoss - immediately acknowledging "+S.length+" seen dropped indicators"),this.sendProcessedDroppedIndicators(S),!(g=g.filter((function(g){return void 0===m.processedMessageLoss[g.tag+"-"+g.etag]}))).length))return void this.logger.info("onTrouterMessageLoss - all declared dropped indicators have been seen before");if(!this.listener.onTrouterMessageLoss(g.map((function(g){return g.tag}))))return void this.logger.warn("onTrouterMessageLoss - some flow tag(s) have not been processed by listeners");g.forEach((function(g){m.processedMessageLoss[g.tag+"-"+g.etag]=""})),this.sendProcessedDroppedIndicators(g)}else this.logger.warn("onTrouterMessageLoss - no flow tags have been provided")},t.prototype.getConnectionCache=function(){var g=this;return this.options.connectionCache?(this.logger.debug("Querying host's connection cache"),this.options.connectionCache.onGetTrouterConnectionCache().then((function(g){var m=g?JSON.parse(g):void 0;return"object"==typeof m?m:void 0})).catch((function(m){return g.logger.warn("Invalid connection cache content provided: "+m),g.connectionCache}))):Promise.resolve(this.connectionCache)},t.prototype.setConnectionCache=function(g){if(this.connectionCache=g,this.options.connectionCache)try{this.options.connectionCache.onSetTrouterConnectionCache(JSON.stringify(g))}catch(g){this.logger.warn("Error setting external connection cache: "+g)}},t.prototype.sendProcessedDroppedIndicators=function(g){return void 0!==this.firstConnection?void this.firstConnection.sendProcessedDroppedIndicators(g):void 0!==this.secondConnection?void this.secondConnection.sendProcessedDroppedIndicators(g):void 0},t.prototype.configuredTrouterManager=function(){return this.options.connectionDependsOnRegistration?new A.RegistrationEnforcer(this,this.options.delayEventsUntilRegistered):this},t}();m.TrouterManager=O},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterUrlPromise=void 0;var v=S(0),C=function(){function t(g){this.logger=new v.Logger("UrlPromise",g)}return t.prototype.getPromise=function(){var g=this;return void 0!==this.url?(this.logger.debug("returning previously resolved url: "+this.url),Promise.resolve(this.url)):(void 0===this.pendingPromise?(this.logger.debug("creating and returning promise"),this.pendingPromise=new Promise((function(m,S){g.pendingPromiseResolveRef=m,g.pendingPromiseRejectRef=S}))):this.logger.debug("returning existing promise"),this.pendingPromise)},t.prototype.resolveUrl=function(g){this.url=g,this.logger.debug("got url: "+this.url);var m=this.pendingPromiseResolveRef;this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==m&&(this.logger.debug("resolving promise"),m(g))},t.prototype.rejectUrl=function(g){this.logger.debug("aborting");var m=this.pendingPromiseRejectRef;this.url=void 0,this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==m&&(this.logger.debug("rejecting promise"),m(g))},t.prototype.resetUrl=function(){this.logger.debug("resetting url"),this.url=void 0},t}();m.TrouterUrlPromise=C},function(g,m,S){(function(g,S){!function(g,m){var S=g;S.version="0.9.6",S.protocol=1,S.transports=[],S.j=[],S.sockets={},S.connect=function(g,v){var C,_,E=S.util.parseUri(g);m&&m.location&&(E.protocol=E.protocol||m.location.protocol.slice(0,-1),E.host=E.host||(m.document?m.document.domain:m.location.hostname),E.port=E.port||m.location.port),C=S.util.uniqueUri(E);var T={host:E.host,secure:"https"==E.protocol,port:E.port||("https"==E.protocol?443:80),query:E.query||""};return S.util.merge(T,v),!T["force new connection"]&&S.sockets[C]||(_=new S.Socket(T)),!T["force new connection"]&&_&&(S.sockets[C]=_),_=_||S.sockets[C],T["skipped handshake data"]?_.of(""):_.of(E.path.length>1?E.path:"")}}(S.exports,void 0===g?window:g);var v=S.exports;!function(g,m){var S=g.util={},v=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,C=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];S.parseUri=function(g){for(var m=v.exec(g||""),S={},_=14;_--;)S[C[_]]=m[_]||"";return S},S.uniqueUri=function(g){var S=g.protocol,v=g.host,C=g.port;return"document"in m?(v=v||document.domain,C=C||("https"==S&&"https:"!==document.location.protocol?443:document.location.port)):(v=v||"localhost",C||"https"!=S||(C=443)),(S||"http")+"://"+v+":"+(C||80)},S.query=function(g,m){var v=S.chunkQuery(g||""),C=[];for(var _ in S.merge(v,S.chunkQuery(m||"")),v)v.hasOwnProperty(_)&&C.push(_+"="+v[_]);return C.length?"?"+C.join("&"):""},S.chunkQuery=function(g){for(var m,S={},v=g.split("&"),C=0,_=v.length;C<_;++C)(m=v[C].split("="))[0]&&(S[m[0]]=m[1]);return S};var _=!1;S.load=function(g){if("document"in m&&"complete"===document.readyState||_)return g();S.on(m,"load",g,!1)},S.on=function(g,m,S,v){g.attachEvent?g.attachEvent("on"+m,S):g.addEventListener&&g.addEventListener(m,S,v)},S.request=function(g){if(g&&"undefined"!=typeof XDomainRequest)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!g||S.ua.hasCORS))return new XMLHttpRequest;if(!g)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(g){}return null},"undefined"!=typeof window&&S.load((function(){_=!0})),S.defer=function(g){if(!S.ua.webkit||"undefined"!=typeof importScripts)return g();S.load((function(){setTimeout(g,100)}))},S.merge=function(g,m,v,C){var _,E=C||[],T=void 0===v?2:v;for(_ in m)m.hasOwnProperty(_)&&S.indexOf(E,_)<0&&("object"==typeof g[_]&&T?S.merge(g[_],m[_],T-1,E):(g[_]=m[_],E.push(m[_])));return g},S.mixin=function(g,m){S.merge(g.prototype,m.prototype)},S.inherit=function(g,m){function n(){}n.prototype=m.prototype,g.prototype=new n},S.isArray=Array.isArray||function(g){return"[object Array]"===Object.prototype.toString.call(g)},S.intersect=function(g,m){for(var v=[],C=g.length>m.length?g:m,_=g.length>m.length?m:g,E=0,T=_.length;E<T;E++)~S.indexOf(C,_[E])&&v.push(_[E]);return v},S.indexOf=function(g,m,S){var v=g.length;for(S=S<0?S+v<0?0:S+v:S||0;S<v&&g[S]!==m;S++);return v<=S?-1:S},S.toArray=function(g){for(var m=[],S=0,v=g.length;S<v;S++)m.push(g[S]);return m},S.ua={},S.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var g=new XMLHttpRequest}catch(g){return!1}return null!=g.withCredentials}(),S.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent)}(void 0!==v?v:S.exports,void 0===g?window:g),function(g,m){function n(){}g.EventEmitter=n,n.prototype.on=function(g,S){return this.$events||(this.$events={}),this.$events[g]?m.util.isArray(this.$events[g])?this.$events[g].push(S):this.$events[g]=[this.$events[g],S]:this.$events[g]=S,this},n.prototype.addListener=n.prototype.on,n.prototype.once=function(g,m){function n(){S.removeListener(g,n),m.apply(this,arguments)}var S=this;return n.listener=m,this.on(g,n),this},n.prototype.removeListener=function(g,S){if(this.$events&&this.$events[g]){var v=this.$events[g];if(m.util.isArray(v)){for(var C=-1,_=0,E=v.length;_<E;_++)if(v[_]===S||v[_].listener&&v[_].listener===S){C=_;break}if(C<0)return this;v.splice(C,1),v.length||delete this.$events[g]}else(v===S||v.listener&&v.listener===S)&&delete this.$events[g]}return this},n.prototype.removeAllListeners=function(g){return this.$events&&this.$events[g]&&(this.$events[g]=null),this},n.prototype.listeners=function(g){return this.$events||(this.$events={}),this.$events[g]||(this.$events[g]=[]),m.util.isArray(this.$events[g])||(this.$events[g]=[this.$events[g]]),this.$events[g]},n.prototype.emit=function(g){if(!this.$events)return!1;var S=this.$events[g];if(!S)return!1;var v=Array.prototype.slice.call(arguments,1);if("function"==typeof S)S.apply(this,v);else{if(!m.util.isArray(S))return!1;for(var C=S.slice(),_=0,E=C.length;_<E;_++)C[_].apply(this,v)}return!0}}(void 0!==v?v:S.exports,void 0!==v?v:S.parent.exports),function(g,m){if(m&&m.parse)return g.JSON={parse:m.parse,stringify:m.stringify};throw new Error("JSON not available")}(void 0!==v?v:S.exports,"undefined"!=typeof JSON?JSON:void 0),function(g,m){var S=g.parser={},v=S.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],C=S.reasons=["transport not supported","client not handshaken","unauthorized"],_=S.advice=["reconnect"],E=m.JSON,T=m.util.indexOf;S.encodePacket=function(g){var m=T(v,g.type),S=g.id||"",I=g.endpoint||"",b=g.ack,A=null;switch(g.type){case"error":var R=g.reason?T(C,g.reason):"",P=g.advice?T(_,g.advice):"";""===R&&""===P||(A=R+(""!==P?"+"+P:""));break;case"message":""!==g.data&&(A=g.data);break;case"event":var M={name:g.name};g.args&&g.args.length&&(M.args=g.args),A=E.stringify(M);break;case"json":A=E.stringify(g.data);break;case"connect":g.qs&&(A=g.qs);break;case"ack":A=g.ackId+(g.args&&g.args.length?"+"+E.stringify(g.args):"")}var w=[m,S+("data"==b?"+":""),I];return null!=A&&w.push(A),w.join(":")},S.encodePayload=function(g){var m="";if(1==g.length)return g[0];for(var S=0,v=g.length;S<v;S++)m+="�"+g[S].length+"�"+g[S];return m};var I=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;S.decodePacket=function(g){if(!(T=g.match(I)))return{};var m=T[2]||"",S=(g=T[5]||"",{type:v[T[1]],endpoint:T[4]||""});switch(m&&(S.id=m,T[3]?S.ack="data":S.ack=!0),S.type){case"error":var T=g.split("+");S.reason=C[T[0]]||"",S.advice=_[T[1]]||"";break;case"message":S.data=g||"";break;case"event":try{var b=E.parse(g);S.name=b.name,S.args=b.args}catch(g){}S.args=S.args||[];break;case"json":try{S.data=E.parse(g)}catch(g){}break;case"connect":S.qs=g||"";break;case"ack":if((T=g.match(/^([0-9]+)(\+)?(.*)/))&&(S.ackId=T[1],S.args=[],T[3]))try{S.args=T[3]?E.parse(T[3]):[]}catch(g){}break;case"disconnect":S.reason=g}return S},S.decodePayload=function(g){if("�"==g.charAt(0)){for(var m=[],v=1,C="";v<g.length;v++)"�"==g.charAt(v)?(m.push(S.decodePacket(g.substr(v+1).substr(0,C))),v+=Number(C)+1,C=""):C+=g.charAt(v);return m}return[S.decodePacket(g)]}}(void 0!==v?v:S.exports,void 0!==v?v:S.parent.exports),function(g,m){function n(g,m){this.socket=g,this.sessid=m,this.connectErrorCallback=void 0,this.isOpened=!1}g.Transport=n,m.util.mixin(n,m.EventEmitter),n.prototype.onData=function(g){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==g){var S=m.parser.decodePayload(g);if(S&&S.length)for(var v=0,C=S.length;v<C;v++)this.onPacket(S[v])}return this},n.prototype.onPacket=function(g){return this.socket.setHeartbeatTimeout(),"heartbeat"==g.type?this.onHeartbeat():("connect"==g.type&&""==g.endpoint&&this.onConnect(),"error"==g.type&&"reconnect"==g.advice&&(this.isOpened=!1),this.socket.onPacket(g),this)},n.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var g=this;this.closeTimeout=setTimeout((function(){g.onDisconnect()}),this.socket.closeTimeout)}},n.prototype.onDisconnect=function(){return this.close&&this.isOpened&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},n.prototype.onConnect=function(){return this.socket.onConnect(),this.connectErrorCallback=void 0,this},n.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},n.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},n.prototype.packet=function(g){this.send(m.parser.encodePacket(g))},n.prototype.onHeartbeat=function(g){this.packet({type:"heartbeat"})},n.prototype.onOpen=function(){this.isOpened=!0,this.clearCloseTimeout(),this.socket.onOpen()},n.prototype.onClose=function(){this.isOpened=!1,this.socket.onClose(),this.onDisconnect()},n.prototype.prepareUrl=function(g){var S=this.socket.options;if(S["skipped handshake data"])return S.rewriteUrlForProxy(S["skipped handshake data"].websocketUrl+(g||""));var v=this.scheme()+"://"+S.host+":"+S.port+"/"+S.resource+"/"+m.protocol+"/"+this.name+"/"+this.sessid+(g||"");return S.rewriteUrlForProxy(v)},n.prototype.ready=function(g,m){m.call(this)},n.prototype.clearEventHandlers=function(){return this}}(void 0!==v?v:S.exports,void 0!==v?v:S.parent.exports),function(g,m,S){function o(g){if(this.options={port:80,secure:!1,document:"document"in S&&document,resource:"socket.io",transports:m.transports.slice(),"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!0,"auto connect":!0,"flash policy port":10843},m.util.merge(this.options,g),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.disconnected=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||m.util.ua.hasCORS)){var v=this;m.util.on(S,"unload",(function(){v.disconnectSync()}),!1)}this.options["auto connect"]&&this.connect()}function i(){}g.Socket=o,m.util.mixin(o,m.EventEmitter),o.prototype.of=function(g){return this.namespaces[g]||(this.namespaces[g]=new m.SocketNamespace(this,g),""!==g&&this.namespaces[g].packet({type:"connect"})),this.namespaces[g]},o.prototype.publish=function(){var g;for(var m in this.emit.apply(this,arguments),this.namespaces)this.namespaces.hasOwnProperty(m)&&(g=this.of(m)).$emit.apply(g,arguments)},o.prototype.handshake=function(g){function n(m){m instanceof Error?S.onError(m.message):g.apply(null,m.split(":"))}var S=this,v=this.options;if(!S.disconnected){var C=v.rewriteUrlForProxy(["http"+(v.secure?"s":"")+":/",v.host+":"+v.port,v.resource,m.protocol,m.util.query(this.options.query,"t="+ +new Date)].join("/"));if(this.isXDomain()&&!m.util.ua.hasCORS){var _=document.getElementsByTagName("script")[0],E=document.createElement("script");E.src=C+"&jsonp="+m.j.length,_.parentNode.insertBefore(E,_),m.j.push((function(g){n(g),E.parentNode.removeChild(E)}))}else{var T=m.util.request();T.open("GET",C,!0);var I=this.options.requestHeaders;void 0!==I&&Object.keys(I).forEach((function(g){T.setRequestHeader(g,I[g])})),T.onreadystatechange=function(){4==T.readyState&&(T.onreadystatechange=i,200==T.status?n(T.responseText):!S.reconnecting&&S.onError(T.responseText))},T.send(null)}}},o.prototype.getTransport=function(g){for(var S,v=g||this.transports,C=0;S=v[C];C++)if(m.Transport[S]&&m.Transport[S].check(this)&&(!this.isXDomain()||m.Transport[S].xdomainCheck()))return new m.Transport[S](this,this.sessionid);return null},o.prototype.connect=function(g){if(this.connecting||this.disconnected)return this;var S=this,o=function(v,C,_,E){function c(){if(!S.connected&&!S.disconnected)if(S.connecting=!1,clearTimeout(S.connectTimeoutTimer),S.options["try multiple transports"]){for(;S.remainingTransports.length>0&&S.remainingTransports.splice(0,1)[0]!=S.transport.name;);S.remainingTransports.length?a(S.remainingTransports):S.publish("connect_failed")}else S.publish("connect_failed")}function a(g){if(S.transport&&(S.transport.clearTimeouts(),S.transport.clearEventHandlers()),S.transport=S.getTransport(g),!S.transport||S.disconnected)return S.publish("connect_failed");S.transport.ready(S,(function(){S.connecting=!0,S.publish("connecting",S.transport.name),S.transport.open(c),S.options["connect timeout"]&&(S.connectTimeoutTimer=setTimeout((function(){c()}),S.options["connect timeout"]))}))}S.sessionid=v,S.closeTimeout=1e3*_+2e3,S.heartbeatTimeout=1e3*C+2e3,S.transports=E?m.util.intersect(E.split(","),S.options.transports):S.options.transports,S.setHeartbeatTimeout(),S.remainingTransports=S.transports.slice(0),a(S.transports),S.once("connect",(function(){clearTimeout(S.connectTimeoutTimer),g&&"function"==typeof g&&g()}))};if(this.options["skipped handshake data"]){var v=this.options["skipped handshake data"];o("v4c-"+(new Date).getTime(),v.timeout,v.timeout,"websocket")}else this.handshake(o);return this},o.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);var g=this;this.heartbeatTimeoutTimer=setTimeout((function(){g.transport.onClose()}),this.heartbeatTimeout)},o.prototype.packet=function(g){return this.connected&&!this.doBuffer?this.transport.packet(g):this.buffer.push(g),this},o.prototype.setBuffer=function(g){this.doBuffer=g,!g&&this.connected&&this.buffer.length&&(this.transport.payload(this.buffer),this.buffer=[])},o.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this.disconnected=!0,this},o.prototype.disconnectSync=function(){var g=m.util.request(),S=this.resource+"/"+m.protocol+"/"+this.sessionid;g.open("GET",S,!0),this.onDisconnect("booted")},o.prototype.isXDomain=function(){var g=S.location.port||("https:"==S.location.protocol?443:80);return this.options.host!==S.location.hostname||this.options.port!=g},o.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},o.prototype.onOpen=function(){this.open=!0},o.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},o.prototype.onPacket=function(g){this.of(g.endpoint).onPacket(g)},o.prototype.onError=function(g){g&&g.advice&&"reconnect"===g.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",g&&g.reason?g.reason:g)},o.prototype.onDisconnect=function(g){var m=this.connected,S=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(m||S)&&(this.transport.close(),this.transport.clearTimeouts(),m?(this.publish("disconnect",g),"booted"!=g&&this.options.reconnect&&!this.reconnecting&&this.reconnect()):this.publish("close_during_connecting",g))},o.prototype.reconnect=function(){function t(){if(g.connected){for(var m in g.namespaces)g.namespaces.hasOwnProperty(m)&&""!==m&&g.namespaces[m].packet({type:"connect"});g.publish("reconnect",g.transport.name,g.reconnectionAttempts)}clearTimeout(g.reconnectionTimer),g.removeListener("connect_failed",e),g.removeListener("connect",e),g.reconnecting=!1,delete g.reconnectionAttempts,delete g.reconnectionDelay,delete g.reconnectionTimer,delete g.redoTransports,g.options["try multiple transports"]=S}function e(){if(g.reconnecting)return g.connected?t():g.connecting&&g.reconnecting?g.reconnectionTimer=setTimeout(e,1e3):void(g.reconnectionAttempts++>=m?g.redoTransports?(g.publish("reconnect_failed"),t()):(g.on("connect_failed",e),g.options["try multiple transports"]=!0,g.transport=g.getTransport(),g.redoTransports=!0,g.connect()):(g.reconnectionDelay<v&&(g.reconnectionDelay*=2),g.connect(),g.publish("reconnecting",g.reconnectionDelay,g.reconnectionAttempts),g.reconnectionTimer=setTimeout(e,g.reconnectionDelay)))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var g=this,m=this.options["max reconnection attempts"],S=this.options["try multiple transports"],v=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(e,this.reconnectionDelay),this.on("connect",e)}}(void 0!==v?v:S.exports,void 0!==v?v:S.parent.exports,void 0===g?window:g),function(g,m){function n(g,m){this.socket=g,this.name=m||"",this.flags={},this.json=new o(this,"json"),this.ackPackets=0,this.acks={}}function o(g,m){this.namespace=g,this.name=m}g.SocketNamespace=n,m.util.mixin(n,m.EventEmitter),n.prototype.$emit=m.EventEmitter.prototype.emit,n.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},n.prototype.packet=function(g){return g.endpoint=this.name,this.socket.packet(g),this.flags={},this},n.prototype.send=function(g,m){var S={type:this.flags.json?"json":"message",data:g};return"function"==typeof m&&(S.id=++this.ackPackets,S.ack=!0,this.acks[S.id]=m),this.packet(S)},n.prototype.emit=function(g){var m=Array.prototype.slice.call(arguments,1),S=m[m.length-1],v={type:"event",name:g};return"function"==typeof S&&(v.id=++this.ackPackets,v.ack="data",this.acks[v.id]=S,m=m.slice(0,m.length-1)),v.args=m,this.packet(v)},n.prototype.disconnect=function(){return""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},n.prototype.onPacket=function(g){function n(){S.packet({type:"ack",args:m.util.toArray(arguments),ackId:g.id})}var S=this;switch(g.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(g.reason||"booted"):this.$emit("disconnect",g.reason||"");break;case"message":case"json":var v=["message",g.data];"data"==g.ack?v.push(n):g.ack&&this.packet({type:"ack",ackId:g.id}),this.$emit.apply(this,v);break;case"event":v=[g.name].concat(g.args),"data"==g.ack&&v.push(n),this.$emit.apply(this,v);break;case"ack":this.acks[g.ackId]&&(this.acks[g.ackId].apply(this,g.args),delete this.acks[g.ackId]);break;case"error":g.advice?this.socket.onError(g):"unauthorized"==g.reason?this.$emit("connect_failed",g.reason):this.$emit("error",g.reason)}},o.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},o.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}(void 0!==v?v:S.exports,void 0!==v?v:S.parent.exports),function(g,m,S){function o(g){m.Transport.apply(this,arguments)}function i(){}g.websocket=o,m.util.inherit(o,m.Transport),o.prototype.name="websocket",o.prototype.open=function(g){var v,C=m.util.query(this.socket.options.query),_=this;return this.connectErrorCallback=g,v||(v=S.MozWebSocket||S.WebSocket),this.websocket=new v(this.prepareUrl(C)),this.websocket.onopen=function(){_.onOpen(),_.socket.setBuffer(!1)},this.websocket.onmessage=function(g){_.onData(g.data)},this.websocket.onclose=function(){_.onClose(),_.socket.setBuffer(!0)},this.websocket.onerror=function(g){_.onError(g)},this},o.prototype.send=function(g){return this.websocket.send(g),this},o.prototype.payload=function(g){for(var m=0,S=g.length;m<S;m++)this.packet(g[m]);return this},o.prototype.close=function(){return this.websocket.close(),this},o.prototype.onError=function(g){void 0!==this.connectErrorCallback&&(this.connectErrorCallback(),this.connectErrorCallback=void 0),this.socket.onError(g)},o.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},o.check=function(){return"WebSocket"in S&&!("__addTask"in WebSocket)||"MozWebSocket"in S},o.xdomainCheck=function(){return!0},o.prototype.clearEventHandlers=function(){return this.websocket&&(this.websocket.onopen=this.websocket.onmessage=this.websocket.onclose=this.websocket.onerror=i),this},m.transports.push("websocket")}(void 0!==v?v.Transport:S.exports,void 0!==v?v:S.parent.exports,void 0===g?window:g),function(g,m,S){function o(g){g&&(m.Transport.apply(this,arguments),this.sendBuffer=[])}function i(){}g.XHR=o,m.util.inherit(o,m.Transport),o.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},o.prototype.payload=function(g){for(var S=[],v=0,C=g.length;v<C;v++)S.push(m.parser.encodePacket(g[v]));this.send(m.parser.encodePayload(S))},o.prototype.send=function(g){return this.post(g),this},o.prototype.post=function(g){function e(){4==this.readyState&&(this.onreadystatechange=i,m.posting=!1,200==this.status?(m.socket.setBuffer(!1),clearTimeout(m.sendXHR.ackTimeoutTimer)):m.onClose())}function o(){this.onload=i,m.socket.setBuffer(!1)}var m=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),S.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=o:this.sendXHR.onreadystatechange=e,this.sendXHR.send(g),m.sendXHR.ackTimeoutTimer=setTimeout((function(){m.onClose()}),m.socket.options.ackTimeoutMs)},o.prototype.close=function(){return this.onClose(),this},o.prototype.request=function(g){var S=m.util.request(this.socket.isXDomain()),v=m.util.query(this.socket.options.query,"t="+ +new Date);S.open(g||"GET",this.prepareUrl(v),!0);var C=this.socket.options.requestHeaders;if(void 0!==C&&Object.keys(C).forEach((function(g){S.setRequestHeader(g,C[g])})),"POST"==g)try{S.setRequestHeader?S.setRequestHeader("Content-type","text/plain;charset=UTF-8"):S.contentType="text/plain"}catch(g){}return S},o.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},o.check=function(g,v){try{var C=m.util.request(v),_=S.XDomainRequest&&C instanceof XDomainRequest,E=(g&&g.options&&g.options.secure?"https:":"http:")!=S.location.protocol;if(C&&(!_||!E))return!0}catch(g){}return!1},o.xdomainCheck=function(){return o.check(null,!0)},o.prototype.clearEventHandlers=function(){return this.sendXHR&&(this.sendXHR.onreadystatechange=this.sendXHR.onload=i),this}}(void 0!==v?v.Transport:S.exports,void 0!==v?v:S.parent.exports,void 0===g?window:g),function(g,m,S){function o(){m.Transport.XHR.apply(this,arguments)}function i(){}g["xhr-polling"]=o,m.util.inherit(o,m.Transport.XHR),m.util.merge(o,m.Transport.XHR),o.prototype.name="xhr-polling",o.prototype.open=function(g){var S=this;return S.connectErrorCallback=g,m.Transport.XHR.prototype.open.call(S),!1},o.prototype.get=function(){function t(){4==this.readyState&&(this.onreadystatechange=i,200==this.status?(g.connectErrorCallback=void 0,g.onData(this.responseText),g.get()):(g.onClose(),void 0!==g.connectErrorCallback&&(g.connectErrorCallback(),g.connectErrorCallback=void 0)))}function e(){g.connectErrorCallback=void 0,this.onload=i,this.onerror=i,g.onData(this.responseText),g.get()}function o(){g.onClose(),void 0!==g.connectErrorCallback&&(g.connectErrorCallback(),g.connectErrorCallback=void 0)}if(this.isOpened){var g=this;this.xhr=this.request(),S.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=e,this.xhr.onerror=o):this.xhr.onreadystatechange=t,this.xhr.send(null)}},o.prototype.onClose=function(){if(m.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i;try{this.xhr.abort()}catch(g){}this.xhr=null}},o.prototype.ready=function(g,S){var v=this;m.util.defer((function(){S.call(v)}))},o.prototype.clearEventHandlers=function(){return m.Transport.XHR.prototype.clearEventHandlers.call(this),this.xhr&&(this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i),this},m.transports.push("xhr-polling")}(void 0!==v?v.Transport:S.exports,void 0!==v?v:S.parent.exports,void 0===g?window:g),m.io=v}).call(m,S(13),S(14)(g))},function(g,m){var S;S=function(){return this}();try{S=S||Function("return this")()||(0,eval)("this")}catch(g){"object"==typeof window&&(S=window)}g.exports=S},function(g,m){g.exports=function(g){return g.webpackPolyfill||(g.deprecate=function(){},g.paths=[],g.children||(g.children=[]),Object.defineProperty(g,"loaded",{enumerable:!0,get:function(){return g.l}}),Object.defineProperty(g,"id",{enumerable:!0,get:function(){return g.i}}),g.webpackPolyfill=1),g}},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.ConnectionTracker=m.Properties=m.TrackerStep=m.ClientEventName=m.ResponseData=void 0;var v,C=S(3),_=S(1),E=S(0),T=function(){function t(g){this.id=g,this.status=200,this.headers={},this.body=""}return t}();m.ResponseData=T,function(g){g.Connected="trouter_js_client_connected",g.Disconnected="trouter_js_client_disconnected",g.Error="trouter_js_client_error",g.Progress="trouter_js_client_progress",g.Response="trouter_js_client_response",g.Request="trouter_js_client_request",g.CheckConnection="trouter_js_client_check_connection",g.Registration="trouter_js_client_registration",g.Unregistration="trouter_js_client_unregistration"}(v=m.ClientEventName||(m.ClientEventName={}));var I=function(){function t(g,m,S,v,C){this.stepName=g,this.operation=m,this.delta=S,this.ts=v,this.error=C}return t}();m.TrackerStep=I;var b=function(){function t(){}return t}();m.Properties=b;var A=function(){function t(){this.numberOfPingReplies=0,this.connectedTimestamp=0,this.isNewUrl=!1,this.transportType="",this.connectionNumber=0}return t}(),R=function(){function t(){this.enabled=!1,this.numberOfStepsToMaintain=40,this.logHealthCheckError=!1,this.sendProgressTimeoutSecs=55,this.logSendPingError=!1,this.maxBackoffInMs=12e4,this.trouter_js_client_connected=!1,this.trouter_js_client_disconnected=!1,this.trouter_js_client_error=!1,this.trouter_js_client_progress=!1,this.trouter_js_client_response=!1,this.trouter_js_client_request=!1,this.trouter_js_client_registration=!1,this.trouter_js_client_unregistration=!1,this.trouter_js_client_check_connection=!0}return t}(),P=function(){function t(g,m,S,v,_,T,I){this.clientId=m,this.clientInfo=S,this.getServerState=v,this.endpointId=_,this.clientCorrelationID=T,this.environment=I,this.logger=new E.Logger("ConnectionTracker",g),this.clientCorrelationID=void 0!==T?T:"",this.steps=[],this.connectionAttempt=0,this.totalStepCount=0,this.beginTimestamp=new C.Timespan,this.eventLogSettings=new R,this.connectedInfo=new A}return t.prototype.enable=function(g){this.eventLogSettings.enabled=!0,this.eventLogger=g},t.prototype.disable=function(){this.eventLogSettings.enabled=!1},t.prototype.sendProgress=function(g){this.steps.length>0&&this.sendTelemetry(v.Progress,g,this.steps)},t.prototype.cancelProgressTimer=function(){void 0!==this.progressTimeout&&(clearTimeout(this.progressTimeout),this.progressTimeout=void 0)},t.prototype.resetProgressSendTimer=function(){var g=this;this.cancelProgressTimer(),void 0!==this.eventLogSettings.sendProgressTimeoutSecs&&this.eventLogSettings.sendProgressTimeoutSecs>0&&(this.progressTimeout=setTimeout((function(){g.sendProgress({reason:"timeout",timeoutSecs:g.eventLogSettings.sendProgressTimeoutSecs})}),1e3*this.eventLogSettings.sendProgressTimeoutSecs))},t.prototype.setConnectedInfo=function(g,m){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=Date.now(),this.connectedInfo.isNewUrl=g,this.connectedInfo.transportType=m,++this.connectedInfo.connectionNumber},t.prototype.clearConnectedInfo=function(){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=0,this.connectedInfo.isNewUrl=!0,this.connectedInfo.transportType=""},t.prototype.copyProperties=function(g,m){for(var S=0,v=Object.keys(m);S<v.length;S++){var C=v[S];void 0!==m[C]&&(g[C.replace(/-/g,"_")]={value:m[C]})}},t.prototype.increasePingResponseCount=function(){++this.connectedInfo.numberOfPingReplies},t.prototype.sendTelemetry=function(g,m,S){try{if(!0===this.eventLogSettings.enabled&&!0===this.eventLogSettings[g]&&void 0!==this.eventLogger){var v=this.getServerState(),E={name:g,properties:{connectionAttempt:{value:this.connectionAttempt},epid:{value:this.endpointId},clientCorrelationID:{value:this.clientCorrelationID},steps:{value:(0,C.toJson)(S)},clientID:{value:this.clientId},eventVersion:{value:3},environment:{value:this.environment},cv:{value:_.CLIENT_VERSION},ua:{value:this.clientInfo.ua},connectionId:{value:v.connectionId},connectedClientId:{value:v.connectedClientId},domId:{value:v.domId},url:{value:v.unsecureUrl},surl:{value:v.url},ttlInSecs:{value:v.getRemainingTtlInSec()},numberOfPingReplies:{value:this.connectedInfo.numberOfPingReplies},connectedTimestamp:{value:this.connectedInfo.connectedTimestamp},isNewUrl:{value:this.connectedInfo.isNewUrl},transportType:{value:this.connectedInfo.transportType},connectionNumber:{value:this.connectedInfo.connectionNumber}}};this.copyProperties(E.properties,m),this.eventLogger.logEvent(E)}}catch(m){this.logger.warn("error in sending event "+g+": "+(0,C.toJson)(m))}},t.prototype.createStep=function(g,m,S){return new I(g,m,this.beginTimestamp.duration,Date.now(),S)},t.prototype.addStep=function(g,m,S){if(!1!==this.eventLogSettings.enabled&&(0===this.steps.length&&this.beginTimestamp.reset(),this.steps.push(this.createStep(g,m,S)),++this.totalStepCount,void 0!==this.eventLogSettings.numberOfStepsToMaintain&&this.steps.length>this.eventLogSettings.numberOfStepsToMaintain)){var C=this.steps.slice(0);this.steps.length=0,this.sendTelemetry(v.Progress,{reason:"flush"},C)}},t.prototype.trackStart=function(g){this.addStep(g,"start")},t.prototype.trackEnd=function(g){this.addStep(g,"end")},t.prototype.trackError=function(g,m,S,C){void 0===S&&(S=!0),"health"===g&&!0!==this.eventLogSettings.logHealthCheckError||"ping"===g&&!1===this.eventLogSettings.logSendPingError||(void 0===C&&(C="error"),!0===S&&this.addStep(g,C,m),this.sendTelemetry(v.Error,{},[this.createStep(g,C,m)]))},t.prototype.trackProgress=function(g,m){this.addStep(g,m)},t.prototype.trackConnected=function(g,m){this.setConnectedInfo(g,m);var S=this.steps.slice(0),C=this.totalStepCount,_=this.beginTimestamp.duration;this.steps.length=0,this.totalStepCount=0,this.sendTelemetry(v.Connected,{stepCount:S.length,totalStepCount:C,connectionEstablishmentMs_Total:_},S),this.cancelProgressTimer()},t.prototype.getSessionLength=function(){return Date.now()-this.connectedInfo.connectedTimestamp},t.prototype.trackDisconnected=function(g){g.sessionLengthMS=this.getSessionLength(),this.sendTelemetry(v.Disconnected,g,[]),this.resetProgressSendTimer()},t.prototype.trackNewConnection=function(){++this.connectionAttempt},t.prototype.trackRequest=function(g,m){var S={};void 0!==m&&(S.hasError=!0,S.error=m);try{if(g){S.requestID=g.id,S.httpMethod=g.method,S.url=g.url,S.bodyLength=g.body.length,S.shortUrl=g.shortUrl,S.requestTimeStamp=g.startTS,S.correlationVector=g.correlationVector;for(var _=g.headers,E=0,T=Object.keys(_);E<T.length;E++){var I=T[E];S[I]=_[I]}}}catch(g){S.hasError=!0,S.error=S.error+" error creating request context "+(0,C.toJson)(g)}this.sendTelemetry(v.Request,S,[])},t.prototype.trackResponse=function(g,m,S,_){var E={};void 0!==_&&(E.hasError=!0,E.error=_);try{if(E.responseTimestamp=void 0!==S?S.sentTS:Date.now(),g){E.requestID=g.id,E.httpMethod=g.method,E.shortUrl=g.shortUrl,E.correlationVector=g.correlationVector;for(var T=g.headers,I=0,b=Object.keys(T);I<b.length;I++){var A=b[I];E[A]=T[A]}}S&&(E.latencyMS=m,E.responseCode=S.status,E.responseLength=S.body.length)}catch(g){E.hasError=!0,E.error=E.error+" error creating response context "+(0,C.toJson)(g)}this.sendTelemetry(v.Response,E,[])},t.prototype.sendResponseError=function(g,m,S){this.trackResponse(m,void 0,S,g)},t.prototype.close=function(){this.sendProgress({reason:"closed"}),this.steps.length=0,this.cancelProgressTimer()},t.prototype.mergeSettings=function(g){if(g){this.eventLogSettings.numberOfStepsToMaintain=Math.min(40,Math.max(10,void 0!==g.numberOfStepsToMaintain?g.numberOfStepsToMaintain:0));var m=Math.min(3600,Math.max(55,void 0!==g.sendProgressTimeoutSecs?g.sendProgressTimeoutSecs:0));this.eventLogSettings.logHealthCheckError=g.logHealthCheckError,this.eventLogSettings.logSendPingError=g.logSendPingError;for(var S=0,C=Object.keys(v).map((function(g){return v[g]}));S<C.length;S++){var _=C[S];void 0!==g[_]&&(this.eventLogSettings[_]=g[_])}this.eventLogSettings.sendProgressTimeoutSecs!==m&&(this.eventLogSettings.sendProgressTimeoutSecs=m,this.resetProgressSendTimer())}},t}();m.ConnectionTracker=P},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.DisconnectReason=void 0;var v=function(){function t(g,m,S){this.reason=g,this.claims=m,this.details=S}return t.fromRawReason=function(g,m){if(""===g||"dup"===g)return new t(g);try{var S=JSON.parse(g);return"object"!=typeof S||void 0===S.reason?(null==m||m.error("invalid disconnect reason format"),new t("unknown",void 0,g)):new t(S.reason,S.claims,S.details)}catch(m){return new t("disconnect",void 0,g)}},t.fromSocketIoEventData=function(g,m){return"string"==typeof m?new t(g,void 0,m):void 0},t.prototype.toTelemetryString=function(){return"socketerror"===this.reason||"reconnecterror"===this.reason||"disconnect"===this.reason?this.details:this.reason},t}();m.DisconnectReason=v},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.ExponentialBackoff=void 0;var v=function(){function t(g,m){this.logger=g,this.maxBackoffInMs=m,this.backoffId=0,this.backoffCount=0}return t.calculateNextBackoffMs=function(g,m){var S=1+.4*(Math.random()-.5),v=1e3*Math.pow(2,g)*S;return v=Math.round(v),Math.min(m,v)},t.prototype.setMaxBackoffMs=function(g){this.maxBackoffInMs=g},t.prototype.backoff=function(g,m){var S=this;void 0!==this.timerHandle&&(this.logger.debug("Clearing current back off"),clearTimeout(this.timerHandle),this.timerHandle=void 0);var v=t.calculateNextBackoffMs(this.backoffCount,this.maxBackoffInMs);this.backoffId++,this.backoffCount++,this.logger.info("Backing off "+g+" for "+v+" milliseconds with ID "+this.backoffId),this.callback=function(){S.logger.info("Back off for "+g+" with ID "+S.backoffId+" complete, invoking handler"),S.timerHandle=void 0,S.callback=void 0,m()},this.timerHandle=setTimeout(this.callback,v)},t.prototype.reset=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off with ID "+this.backoffId),clearTimeout(this.timerHandle),this.timerHandle=void 0,this.callback=void 0),this.backoffCount=0},t.prototype.expediteIfPending=function(){if(this.backoffCount=0,void 0!==this.timerHandle){this.logger.debug("Expediting back off with ID "+this.backoffId),clearTimeout(this.timerHandle),this.timerHandle=void 0;var g=this.callback;this.callback=void 0,g&&g()}},t}();m.ExponentialBackoff=v},function(g,m,S){var v=this&&this.__spreadArray||function(g,m,S){if(S||2===arguments.length)for(var v,C=0,_=m.length;C<_;C++)!v&&C in m||(v||(v=Array.prototype.slice.call(m,0,C)),v[C]=m[C]);return g.concat(v||Array.prototype.slice.call(m))};Object.defineProperty(m,"__esModule",{value:!0}),m.LoggingManagerConsumer=m.RegistrationEnforcer=void 0;var C=S(6),_=function(){function t(g,m){this.wrapped=g,this.holdBackEvents=m,this.isRegistered=!1,this.heldBackEvents=[]}return t.prototype.onDownstreamRequest=function(g,m,S){this.passIfRegistered("onDownstreamRequest",g,m,S)},t.prototype.onConnected=function(g){this.passIfRegistered("onConnected",g)},t.prototype.onRegistered=function(g){this.isRegistered=!0,this.wrapped.onRegistered(g),this.fireHeldBackEvents()},t.prototype.onUnregistered=function(g){this.isRegistered=!1,this.wrapped.onUnregistered(g),g.getState()===C.State.Connected&&g.forceReconnectDueToNoRegistration()},t.prototype.onReconnecting=function(g){this.wrapped.onReconnecting(g)},t.prototype.onReconnectIsRequired=function(g,m,S){this.wrapped.onReconnectIsRequired(g,m,S)},t.prototype.onDisconnected=function(g){this.isRegistered=!1,this.dropHeldBackEvents(),this.wrapped.onDisconnected(g)},t.prototype.onTerminalError=function(g){this.wrapped.onTerminalError(g)},t.prototype.onConnectionParametersUpdated=function(g){this.wrapped.onConnectionParametersUpdated(g)},t.prototype.onTrouterMessageLost=function(g){this.passIfRegistered("onTrouterMessageLost",g)},t.prototype.onUserActivityStateAccepted=function(g){this.passIfRegistered("onUserActivityStateAccepted",g)},t.prototype.onAudiencesSetResolved=function(g,m){this.passIfRegistered("onAudiencesSetResolved",g,m)},t.prototype.getState=function(){return this.wrapped.getState()},t.prototype.holdBackEvent=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];this.heldBackEvents.push({kind:g,args:m})},t.prototype.passIfRegistered=function(g){for(var m,S=[],C=1;C<arguments.length;C++)S[C-1]=arguments[C];this.isRegistered||!1===this.holdBackEvents&&"onConnected"!==g?(m=this.wrapped)[g].apply(m,S):this.holdBackEvent.apply(this,v([g],S,!1))},t.prototype.fireHeldBackEvents=function(){for(var g,m=0,S=this.heldBackEvents;m<S.length;m++){var v=S[m];(g=this.wrapped)[v.kind].apply(g,v.args)}this.heldBackEvents=[]},t.prototype.dropHeldBackEvents=function(){this.heldBackEvents=[]},t}();m.RegistrationEnforcer=_;var E=function(){function t(g,m,S,v){this.wrapped=g,this.prefix=m,this.logger=S,this.onEventAction=v}return t.prototype.onEvent=function(g,m){var S;void 0!==this.onEventAction?this.onEventAction(g,m):(null!==(S=this.logger)&&void 0!==S?S:console).log(this.prefix+" TracingEnforcer: "+g+"("+m+")")},t.prototype.onDownstreamRequest=function(g,m,S){this.onEvent("onDownstreamRequest",JSON.stringify({request:m,response:S})),this.wrapped.onDownstreamRequest(g,m,S)},t.prototype.onConnected=function(g){this.onEvent("onConnected",g.getState().toString()),this.wrapped.onConnected(g)},t.prototype.onRegistered=function(g){this.onEvent("onRegistered",g.getState().toString()),this.wrapped.onRegistered(g)},t.prototype.onUnregistered=function(g){this.onEvent("onUnregistered",g.getState().toString()),this.wrapped.onUnregistered(g)},t.prototype.onReconnecting=function(g){this.onEvent("onReconnecting",g.getState().toString()),this.wrapped.onReconnecting(g)},t.prototype.onReconnectIsRequired=function(g,m,S){this.onEvent("onReconnectIsRequired",JSON.stringify({connection:g.getState().toString(),useConnectParamsFromCache:m,reason:S})),this.wrapped.onReconnectIsRequired(g,m,S)},t.prototype.onDisconnected=function(g){this.onEvent("onDisconnected",g.getState().toString()),this.wrapped.onDisconnected(g)},t.prototype.onTerminalError=function(g){this.onEvent("onTerminalError",JSON.stringify({connection:g})),this.wrapped.onTerminalError(g)},t.prototype.onConnectionParametersUpdated=function(g){this.onEvent("onConnectionParametersUpdated",JSON.stringify({connectParams:g})),this.wrapped.onConnectionParametersUpdated(g)},t.prototype.onTrouterMessageLost=function(g){this.onEvent("onTrouterMessageLost",JSON.stringify({flowTags:g})),this.wrapped.onTrouterMessageLost(g)},t.prototype.onUserActivityStateAccepted=function(g){this.onEvent("onUserActivityStateAccepted",JSON.stringify({cv:g})),this.wrapped.onUserActivityStateAccepted(g)},t.prototype.onAudiencesSetResolved=function(g,m){this.onEvent("onAudiencesSetResolved",JSON.stringify({audienceSubscriptionsResponse:g,cv:m})),this.wrapped.onAudiencesSetResolved(g,m)},t.prototype.getState=function(){return this.wrapped.getState()},t}();m.LoggingManagerConsumer=E},function(g,m,S){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterManagerFsm=void 0;var v=S(2),C=S(4),_=S(0),E=S(7),T=function(){function t(g,m){this.worker=m,this.state=C.TrouterManagerState.Unknown,this.logger=new _.Logger("ManagerFsm",g)}return t.prototype.start=function(){this.state===C.TrouterManagerState.Unknown?(this.setState(C.TrouterManagerState.Disconnected),this.worker.forceStopLingeringConnection(),this.worker.startFirstConnection()):this.showIgnored("start")},t.prototype.stop=function(g){this.state!==C.TrouterManagerState.Unknown?(this.setState(C.TrouterManagerState.Unknown),this.worker.stopFirstConnection(!0===g),this.worker.stopSecondConnection(!0===g)):this.showIgnored("stop")},t.prototype.getState=function(){switch(this.state){case C.TrouterManagerState.Unknown:case C.TrouterManagerState.Connected:case C.TrouterManagerState.Disconnected:case C.TrouterManagerState.Switching:return this.state;case C.TrouterManagerState.TerminalError:return v.TrouterState.Disconnected}},t.prototype.getInternalState=function(){return this.state},t.prototype.onConnected=function(g){this.state===C.TrouterManagerState.Disconnected&&g?this.worker.doesSecondConnectionExist()?this.setState(C.TrouterManagerState.Switching):(this.setState(C.TrouterManagerState.Connected),this.worker.dispatchConnected()):this.showIgnored("onConnected("+g+")")},t.prototype.onRegistered=function(g){this.state!==C.TrouterManagerState.Disconnected||g?this.state!==C.TrouterManagerState.Switching||g?this.state===C.TrouterManagerState.Disconnected&&g&&(this.setState(C.TrouterManagerState.Connected),this.worker.dispatchConnected()):(this.setState(C.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnectionDelayed(),this.worker.dispatchConnected()):(this.setState(C.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnection(!0),this.worker.dispatchConnected()),this.worker.dispatchRegistrationState(!0)},t.prototype.onUnregistered=function(g){g&&this.worker.dispatchRegistrationState(!1)},t.prototype.onReconnecting=function(g){this.state!==C.TrouterManagerState.Connected&&this.state!==C.TrouterManagerState.Switching||!g?this.showIgnored("onReconnecting("+g+")"):(this.setState(C.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected())},t.prototype.onReconnectionRequired=function(g,m,S){this.state===C.TrouterManagerState.Connected&&g?(this.setState(C.TrouterManagerState.Switching),this.worker.startSecondConnection(m)):this.state===C.TrouterManagerState.Disconnected&&g?this.worker.startSecondConnection(m):this.state===C.TrouterManagerState.Switching&&g&&S===E.ReconnectReason.Configuration?(this.logger.debug("onReconnectionRequired: switch requested while already in Switching state"),this.worker.stopSecondConnection(!0),this.worker.startSecondConnection(m)):this.showIgnored("onReconnectionRequired("+g+")")},t.prototype.onDisconnected=function(g){this.state==C.TrouterManagerState.Unknown&&g?this.worker.dispatchDisconnected():this.state==C.TrouterManagerState.Switching&&g?(this.worker.switchConnections(),this.worker.stopSecondConnection(!1),this.setState(C.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected()):this.showIgnored("onDisconnected("+g+")")},t.prototype.onTerminalError=function(g){this.setState(C.TrouterManagerState.TerminalError),this.worker.dispatchTerminalError()},t.prototype.showIgnored=function(g){this.logger.info("Ignoring event '"+g+"' in state '"+C.TrouterManagerState[this.state]+"'")},t.prototype.setState=function(g){this.logger.info("Switching from state '"+C.TrouterManagerState[this.state]+"' to state '"+C.TrouterManagerState[g]+"'"),this.state!==g?this.state=g:this.logger.error("Attempt to switch to the current state '"+C.TrouterManagerState[g]+"'")},t}();m.TrouterManagerFsm=T},function(g,m,S){function o(g,m){if(!m)return g;var S=v(v({},g),{enabled:m.TelemetryEnabled});return void 0!==m.ClientTelemetryEventEnabled&&(S=v(v({},S),m.ClientTelemetryEventEnabled)),S}function i(g,m,S){var C,_,E,T,I,b,A,R,P,M,f=function(S){return g.proxyUrlRewrite?(m.info("Using rewritten URL for proxy"),g.proxyUrlRewrite(S)):S};return{clientInfo:{ua:g.trouterSettings.productName,v:g.trouterSettings.version},ioOptions:{ackTimeoutMs:5e3,rewriteUrlForProxy:f},clientCorrelationID:g.trouterSettings.sessionId,environment:g.trouterSettings.environment,telemetrySettings:o(g.telemetryConfig.settings,S),eventLogger:g.telemetryConfig.eventLogger,endpointId:g.trouterSettings.registrationId,trouterUrl:(null==S?void 0:S.TrouterConnectionUrl)||g.trouterSettings.trouterServiceUrl,registration:g.trouterSettings.registrarServiceUrl?{registrarUrl:g.trouterSettings.registrarServiceUrl,registrationId:null!==(C=g.trouterSettings.registrationId)&&void 0!==C?C:"",pnhAppId:null!==(_=g.trouterSettings.pnhAppId)&&void 0!==_?_:"",platform:null!==(E=g.trouterSettings.platform)&&void 0!==E?E:"",pnhTemplateKey:null!==(T=g.trouterSettings.pnhTemplate)&&void 0!==T?T:"",platformUIVersion:null!==(I=g.trouterSettings.platformUIVersion)&&void 0!==I?I:"",productContext:g.trouterSettings.pnhProductContext||void 0,context:null!==(b=g.trouterSettings.pnhContext)&&void 0!==b?b:"",registrarTtlSec:(null!==(A=g.trouterSettings.maxRegistrationTimeInMs)&&void 0!==A?A:0)/1e3}:void 0,connectionDependsOnRegistration:void 0!==g.trouterSettings.registrarServiceUrl&&null!==(R=g.trouterSettings.connectionDependsOnRegistration)&&void 0!==R&&R,delayEventsUntilRegistered:null!==(P=g.trouterSettings.delayEventsUntilRegistered)&&void 0!==P&&P,timeoutOptions:v({connectionTimeoutMs:g.trouterSettings.trouterConnectTimeoutInMs||3e4,fetchTimeoutMs:1e4,pingTimeoutMs:4e4,pongTimeoutMs:5e3,maxBackoffMs:"TeamsCDL"===g.trouterSettings.productName?3e5:3e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},g.trouterSettings.timeoutOptions),incallTimeoutOptions:v({connectionTimeoutMs:1e4,fetchTimeoutMs:5e3,pingTimeoutMs:5e3,pongTimeoutMs:2e3,maxBackoffMs:"TeamsCDL"===g.trouterSettings.productName?3e5:1e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},g.trouterSettings.incallTimeoutOptions),incallModeTimeoutMs:null!==(M=g.trouterSettings.incallModeTimeoutMs)&&void 0!==M?M:0,lingeringConnectionDelayMs:6e4,userActivitySecondResendDelayMs:g.trouterSettings.userActivitySecondResendDelayMs||1e4,duplicateDisconnectThresholdMs:1e4,connectionCache:g.connectionCache,registrationStateCallback:g.registrationStateCallbackForAcsDoNotUse,rewriteUrlForProxy:f,retryLimitOnTokenFetch:g.trouterSettings.retryLimitOnTokenFetch,extraConnectionHeaders:g.trouterSettings.extraConnectionHeaders,toJSON:function(){return v(v({},this),{connectionCache:this.connectionCache?{}:this.connectionCache})}}}function r(g){return new M(g)}function s(){return E.CLIENT_VERSION}function c(g,m){var S=g.indexOf("://");if(S>=0){var v=g.indexOf("/",S+3);if(v>=0)return m+g.substr(v)}return""}function a(g){var m=this;return function(S){return C(m,void 0,void 0,(function(){var m;return _(this,(function(v){switch(v.label){case 0:return m={},[4,g(S.needFresh)];case 1:return[2,(m.token=v.sent(),m.tokenType="skype",m)]}}))}))}}function u(g,m){var S,v=this;return function(E){return C(v,void 0,void 0,(function(){var v,C,T;return _(this,(function(_){switch(_.label){case 0:v=new Date,C=setInterval((function(){var m=Math.round((Date.now()-v.getTime())/6e4);g.warn("Note: Trouter auth token request promise from "+v.toISOString()+" has not been resolved for "+m+" minutes. The client is blocked from operating properly")}),3e5),_.label=1;case 1:return _.trys.push([1,,3,4]),[4,m(E)];case 2:return T=_.sent(),E.needFresh&&T.token===S&&g.error("API violation: Trouter auth token provider got a request with needRefresh=true, but returned the same token as last time anyway. Please fix the host app"),S=T.token,[2,T];case 3:return clearInterval(C),[7];case 4:return[2]}}))}))}}var v=this&&this.__assign||function(){return v=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},v.apply(this,arguments)},C=this&&this.__awaiter||function(g,m,S,v){function i(g){return g instanceof S?g:new S((function(m){m(g)}))}return new(S||(S=Promise))((function(S,C){function s(g){try{a(v.next(g))}catch(g){C(g)}}function c(g){try{a(v.throw(g))}catch(g){C(g)}}function a(g){g.done?S(g.value):i(g.value).then(s,c)}a((v=v.apply(g,m||[])).next())}))},_=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(_){if(S)throw new TypeError("Generator is already executing.");for(;E;)try{if(S=1,v&&(C=2&_[0]?v.return:_[0]?v.throw||((C=v.return)&&C.call(v),0):v.next)&&!(C=C.call(v,_[1])).done)return C;switch(v=0,C&&(_=[2&_[0],C.value]),_[0]){case 0:case 1:C=_;break;case 4:return E.label++,{value:_[1],done:!1};case 5:E.label++,v=_[1],_=[0];continue;case 7:_=E.ops.pop(),E.trys.pop();continue;default:if(!(C=(C=E.trys).length>0&&C[C.length-1])&&(6===_[0]||2===_[0])){E=0;continue}if(3===_[0]&&(!C||_[1]>C[0]&&_[1]<C[3])){E.label=_[1];break}if(6===_[0]&&E.label<C[1]){E.label=C[1],C=_;break}if(C&&E.label<C[2]){E.label=C[2],E.ops.push(_);break}C[2]&&E.ops.pop(),E.trys.pop();continue}_=m.call(g,E)}catch(g){_=[6,g],v=0}finally{S=C=0}if(5&_[0])throw _[1];return{value:_[0]?_[1]:void 0,done:!0}}var S,v,C,_,E={label:0,sent:function(){if(1&C[0])throw C[1];return C[1]},trys:[],ops:[]};return _={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(_[Symbol.iterator]=function(){return this}),_};Object.defineProperty(m,"__esModule",{value:!0}),m.replaceTrouterUrlBase=m.getTrouterServiceVersion=m.createTrouterService=m.TrouterService=m.UserActivityState=m.TrouterState=void 0;var E=S(1),T=S(2);Object.defineProperty(m,"TrouterState",{enumerable:!0,get:function(){return T.TrouterState}}),Object.defineProperty(m,"UserActivityState",{enumerable:!0,get:function(){return T.UserActivityState}});var I=S(0),b=S(8),A=S(9),R=S(10),P=S(11),M=function(){function t(g){this.logProvider=g,this.stateChangedListeners=[],this.logger=new I.Logger("Trouter",g),this.trouterUrlPromise=new P.TrouterUrlPromise(g),this.messageHandlers=new b.MessageHandlerRegistry(g),this.listeners={},this.connectionInfo=null,this.logger.info("Created TrouterService version "+E.CLIENT_VERSION)}return t.prototype.start=function(g){var m;if(this.logger.info("Start"),!g.skypeTokenProvider&&!g.authTokenProvider)throw new Error("no token provider has been configured, either skypeTokenProvider or authTokenProvider must be populated");g.skypeTokenProvider&&!g.trouterSettings.disableInternalSkypeTokenCache&&(g.skypeTokenProvider=(0,A.addCacheAsBackupTo)(g.skypeTokenProvider)),this.trouterCfg=g;var S=i(g,this.logger,this.ecsCfg);!1===g.internalEnableV4cProtocol&&(S.forceV4aProtocol=!0);var v=u(this.logger,null!==(m=g.authTokenProvider)&&void 0!==m?m:a(g.skypeTokenProvider));void 0===this.trouterServer&&(this.trouterServer=new R.TrouterManager(this.logProvider,S,v,void 0===g.authTokenProvider,this)),void 0!==this.pendingActivityState&&(this.trouterServer.setUserActivityState(this.pendingActivityState[0],this.pendingActivityState[1]),this.pendingActivityState=void 0),this.trouterServer.start()},t.prototype.stop=function(g){this.logger.info("close connection"),this.trouterUrlPromise.rejectUrl(new Error("TrouterService is stopped")),void 0!==this.trouterServer&&this.trouterServer.stop(g)},t.prototype.setEcsConfig=function(g){return C(this,void 0,void 0,(function(){var m=this;return _(this,(function(S){return[2,new Promise((function(S){if(m.ecsCfg=g.TrouterJScriptClient,m.logger.info("Setting ECS configuration to "+JSON.stringify(m.ecsCfg)),void 0!==m.trouterServer&&void 0!==m.trouterCfg){var v=i(m.trouterCfg,m.logger,m.ecsCfg);m.trouterServer.configure(v)}S()}))]}))}))},t.prototype.checkConnection=function(g){void 0!==this.trouterServer&&this.trouterServer.checkConnection(null!=g&&g)},t.prototype.resendRegistration=function(){return C(this,void 0,void 0,(function(){return _(this,(function(g){if(!this.trouterServer)throw new Error("resendRegistration called too early");return[2,this.trouterServer.resendRegistration()]}))}))},t.prototype.registerListener=function(g,m){return""===m||!m.startsWith("/")||m.includes("?")||m.includes("#")?(this.logger.error("Listener path '"+m+"' is not valid"),!1):this.listeners[m]?(this.logger.error("Another listener is already registered for path '"+m+"'"),!1):(this.listeners[m]=g,this.logger.debug("Listener for path '"+m+"' registered"),this.connectionInfo&&g.onTrouterConnected(this.connectionInfo.baseEndpointUrl+m,this.connectionInfo),!0)},t.prototype.unregisterListener=function(g){for(var m=[],S=0,v=Object.keys(this.listeners);S<v.length;S++){var C=v[S];this.listeners[C]===g&&m.push(C)}if(0===m.length)return!1;for(var _=0,E=m;_<E.length;_++)C=E[_],delete this.listeners[C];return this.logger.debug("Listener for path(s) '"+m.join("', '")+"' unregistered"),!0},t.prototype.onTrouterConnected=function(g,m){this.logger.debug("Trouter is now connected");for(var S=0,v=Object.keys(this.listeners);S<v.length;S++){var C=v[S];try{this.listeners[C].onTrouterConnected(m.baseEndpointUrl+C,m)}catch(g){this.logger.error("Listener '"+C+"' threw an exception from onTrouterConnected(): "+g)}}this.connectionInfo=m,this.trouterUrlPromise.resolveUrl(g),this.notifyStateChanged(T.TrouterState.Connected,{url:g,getRemainingTtlInSec:function(){return m.connectionTtlSec}})},t.prototype.onTrouterDisconnected=function(){this.logger.debug("Trouter is now disconnected"),this.connectionInfo=null;for(var g=0,m=Object.keys(this.listeners);g<m.length;g++){var S=m[g],v=this.listeners[S];if(v.onTrouterDisconnected)try{v.onTrouterDisconnected()}catch(g){this.logger.error("Listener '"+S+"' threw an exception from onTrouterDisconnected(): "+g)}}this.notifyStateChanged(T.TrouterState.Disconnected)},t.prototype.onTrouterRequest=function(g,m){for(var S="",v=0,C=Object.keys(this.listeners);v<C.length;v++){var _=C[v];g.path.startsWith(_)&&_.length>S.length&&(S=_)}if(""===S)this.tryMessageHandlers(g,m)||(m.status=404,m.headers={"Trouter-Responder":"ClientLib"},m.send());else try{this.listeners[S].onTrouterRequest(g,m)}catch(g){this.logger.error("Listener '"+S+"' threw an exception from onTrouterRequest(): "+g),m.status=500,m.headers={"Trouter-Responder":"ClientLib"},m.send()}},t.prototype.onTrouterMessageLoss=function(g){this.logger.info("onTrouterMessageLoss called with tags ["+g+"]");for(var m=!0,S=0,v=Object.keys(this.listeners);S<v.length;S++){var C=v[S],_=this.listeners[C];if(_.onTrouterMessageLoss)try{void 0===(m=_.onTrouterMessageLoss(g)&&m)&&(this.logger.error("Listener '"+C+"' did not return a boolean value from onTrouterMessageLoss()"),m=!1)}catch(g){this.logger.error("Listener '"+C+"' threw an exception from onTrouterMessageLoss(): "+g),m=!1}}return m},t.prototype.onTrouterUserActivityStateAccepted=function(g){this.logger.debug("onTrouterUserActivityStateAccepted cv: "+g);for(var m=0,S=Object.keys(this.listeners);m<S.length;m++){var v=S[m],C=this.listeners[v];if(C.onTrouterUserActivityStateAccepted)try{C.onTrouterUserActivityStateAccepted(g)}catch(g){this.logger.error("Listener '"+v+"' threw an exception from onTrouterUserActivityStateAccepted(): "+g)}}},t.prototype.onAudiencesSetResolved=function(g,m){this.logger.debug("onAudiencesSetResolved cv: "+m);for(var S=0,v=Object.keys(this.listeners);S<v.length;S++){var C=v[S],_=this.listeners[C];if(_.onAudiencesSetResolved)try{_.onAudiencesSetResolved(g,m)}catch(g){this.logger.error("Listener '"+C+"' threw an exception from onAudienceSubscribed(): "+g)}}},t.prototype.setUserActivityState=function(g,m){if(g!==T.UserActivityState.Active&&g!==T.UserActivityState.Inactive)throw new Error("setUserActivityState called with unsupported value "+g);this.logger.info("setUserActivityState called with value "+T.UserActivityState[g]),this.trouterServer&&this.state()!==T.TrouterState.Unknown?this.trouterServer.setUserActivityState(g,m):(this.pendingActivityState=[g,m],this.logger.warn("setUserActivityState called before start() or after stop()"))},t.prototype.setAudienceSubscriptions=function(g,m){if(g.audienceSubscriptions.length>1)throw new Error("Only singular audience subscription is supported");if(this.trouterServer&&this.state()!==T.TrouterState.Unknown)return this.trouterServer.setAudienceSubscriptionsAsync(g,15e3,m);throw new Error("audience subscribe called before start() or after stop()")},t.prototype.state=function(){return void 0!==this.trouterServer?this.trouterServer.getState():T.TrouterState.Unknown},t.prototype.isInTerminalState=function(){return void 0!==this.trouterServer&&this.trouterServer.isInTerminalState()},t.prototype.reportStateInfo=function(){return void 0===this.trouterServer?"":this.trouterServer.reportStateInfo()},t.prototype.getServerState=function(){if(void 0!==this.trouterServer)return this.trouterServer.getServerState()},t.prototype.getTrouterUrlAsync=function(){return void 0!==this.trouterServer?this.trouterUrlPromise.getPromise():Promise.reject(new Error("TrouterService has not been started"))},t.prototype.onStateChanged=function(g){if(this.logger.info("onStateChanged called"),void 0===g)this.stateChangedListeners=this.stateChangedListeners.filter((function(g){return void 0===g.wrappedCallback}));else{this.offStateChanged(g);var e=function(m,S){g(m,S?S.url:"")};e.wrappedCallback=g,this.stateChangedListeners.push(e)}},t.prototype.offStateChanged=function(g){this.logger.info("offStateChanged called");var m=this.stateChangedListeners.length;return this.stateChangedListeners=this.stateChangedListeners.filter((function(m){return m.wrappedCallback!==g})),m>this.stateChangedListeners.length},t.prototype.addCallback=function(g){this.logger.info("addListener called"),-1===this.stateChangedListeners.indexOf(g,0)&&void 0!==g&&this.stateChangedListeners.push(g)},t.prototype.removeCallback=function(g){this.logger.info("removeListener called");var m=this.stateChangedListeners.indexOf(g,0);return m>-1&&(this.stateChangedListeners.splice(m,1),!0)},t.prototype.registerMessageHandler=function(g){this.logger.info("registerMessageHandler is called"),this.messageHandlers.register(g)},t.prototype.clearMessageHandlers=function(){this.logger.info("clearMessageHandlers is called"),this.messageHandlers.clear()},t.prototype.notifyStateChanged=function(g,m){var S=this;this.logger.info("notifyStateChanged called, will forward to "+this.stateChangedListeners.length+" listeners"),this.stateChangedListeners.forEach((function(v){try{v(g,m)}catch(g){S.logger.error("Error in callback "+g)}}))},t.prototype.tryMessageHandlers=function(g,m){if(!this.messageHandlers.active())return!1;var S,v=null;try{v=(S=JSON.parse(g.body))&&(S.evt||S.eventId)||null}catch(g){}var C={eventId:v,url:(this.connectionInfo?this.connectionInfo.baseEndpointUrl:"")+g.path,body:S,rawBody:g.body,headers:g.headers},_=this.messageHandlers.handleMessage(C);return!!_.isHandled&&(m.status=_.resultCode,_.responseHeaders&&(m.headers=_.responseHeaders),_.responseBody&&(m.body=_.responseBody),m.send(),!0)},t}();m.TrouterService=M,m.createTrouterService=r,m.getTrouterServiceVersion=s,m.replaceTrouterUrlBase=c},function(m,S){m.exports=g}])},g.exports=S(Dm)}));class TelemetrySender{constructor(g,m){this.logEvent=g=>{this._logger.debug(g),this._telemetryLogManager.sendEvent({name:g.name,tenant:to,properties:{...g.properties}})},this._logger=g.createChild("TelemetrySender"),this._telemetryLogManager=m}}class Trouter{constructor(g,m,S,v,C){this._ecsProvider=m,this._tokenProvider=S,this._isRegistered=!1,this._registeredChangedListeners=[],this._logger=g.createChild("Trouter"),this._logger.info("init"),this._initialRegistrationCompleteDefer=defer$1(),this._telemetryLogManager=v,this._acsProxy=C}async start(g){let m;if(this._trouterService)throw this._logger.error("Trouterservice already initialized"),new CallingCommunicationError({defaultError:D.CALL_STACK.SIGNALING_SERVICE_ALREADY_INITIALIZED});{const S=new Promise((async(m,S)=>{try{if(this._logger.info("Trouterservice start"),this._trouterService=Om.createTrouterService(this._logger),!this._trouterService)throw this._logger.error("Failed to create trouter service"),new CallingCommunicationError({defaultError:D.CALL_STACK.SIGNALING_SERVICE_CREATE_FAIL});this._options=this._getTrouterConfig(this._logger,this._tokenProvider),g&&(this._options.trouterSettings.environment=g.environment||"",this._options.trouterSettings.sessionId=g.sessionId);let S,v,C=+new Date;this._trouterService.start(this._options),this._trouterService.onStateChanged(((g,m)=>{g===Om.TrouterState.Connected&&(S=+new Date)})),await this._initialRegistrationCompleteDefer.promise;const _=+new Date;S=S??+new Date,v=S,m({trouterRequestCompletionTimeDeltaMs:Math.max(0,S-C),registrarRequestCompletionTimeDeltaMs:Math.max(0,_-v)})}catch(g){S(g)}}));try{const g=wait((()=>S),Ta);m=await g}catch(g){throw 408===g.code?(this._logger.error("Signaling init timeout"),new CallingCommunicationError({defaultError:D.CALL_STACK.SIGNALING_SERVICE_CREATE_TIMEOUT,defaultErrorMessageArgs:[Ta]})):(this._logger.error("Signaling init failed"),new CallingCommunicationError({defaultError:D.CALL_STACK.SIGNALING_INIT_FAIL}))}}return m}isRegistered(){return this._isRegistered}onRegisteredChanged(g){this._logger.info("TrouterService onRegisteredChanged"),this._registeredChangedListeners.push(g)}offRegisteredChanged(g){const m=this._registeredChangedListeners.indexOf(g);this._logger.info(`TrouterService offRegisteredChanged: ${m}`),m>-1&&this._registeredChangedListeners.splice(m,1)}stop(g){this._logger.info("Trouterservice stop"),this._trouterService?(this._trouterService.onStateChanged(void 0),this._trouterService.stop(g),this._trouterService=void 0):this._logger.error("Trouterservice not inited")}registerMessageHandler(g){this._logger.info("Trouterservice registerMessageHandler"),this._trouterService&&this._trouterService.registerMessageHandler(g)}clearMessageHandlers(){this._trouterService&&this._trouterService.clearMessageHandlers()}checkConnection(){this._trouterService&&this._trouterService.checkConnection()}state(){return this._logger.info("Trouterservice state"),this._trouterService?this._trouterService.state():Om.TrouterState.Unknown}onStateChanged(g){this._logger.info("Trouterservice onStateChanged"),this._trouterService&&this._trouterService.onStateChanged(g)}offStateChanged(g){this._logger.info("Trouterservice offStateChanged"),this._trouterService&&this._trouterService.offStateChanged(g)}getTrouterUrlAsync(){return this._trouterService?(this._logger.info("getTrouterUrlAsync called"),this._trouterService.getTrouterUrlAsync()):Promise.reject("Trouterservice not started yet")}_getSettings(){return{registrationId:generateGuid(),registrarServiceUrl:this._ecsProvider.getTrouterSettings().registrarServiceUrl,registrarTtlInSeconds:this._ecsProvider.getTrouterSettings().registrarTtlInSeconds,maxRegistrationTimeInMs:this._ecsProvider.getTrouterSettings().maxRegistrationTimeInMs,registrarRefreshTimeoutInMs:this._ecsProvider.getTrouterSettings().registrarRefreshTimeoutInMs,pnhAppId:this._ecsProvider.getTrouterSettings().pnhAppId,pnhTemplate:this._ecsProvider.getTrouterSettings().pnhTemplate,platform:this._ecsProvider.getTrouterSettings().platform,platformUIVersion:this._ecsProvider.getTrouterSettings().version,trouterServiceUrl:this._ecsProvider.getTrouterSettings().trouterServiceUrl,version:this._ecsProvider.getTrouterSettings().version,trouterConnectTimeoutInMs:this._ecsProvider.getTrouterSettings().trouterConnectTimeoutInMs,productName:this._ecsProvider.getTrouterSettings().productName,sessionId:generateGuid(),environment:this._ecsProvider.getTrouterSettings().environment,timeoutOptions:this._ecsProvider.getTrouterSettings().timeoutOptions}}_createTrouterTelemetryConfig(g){return{eventLogger:new TelemetrySender(g.createChild("TrouterTelemetry"),this._telemetryLogManager),settings:{enabled:this._ecsProvider.getTrouterTelemetryConfig().enabled,logHealthCheckError:this._ecsProvider.getTrouterTelemetryConfig().logHealthCheckError,trouter_js_client_connected:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_connected,trouter_js_client_disconnected:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_disconnected,trouter_js_client_error:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_error,trouter_js_client_progress:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_progress,trouter_js_client_response:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_response,numberOfStepsToMaintain:this._ecsProvider.getTrouterTelemetryConfig().numberOfStepsToMaintain,sendProgressTimeoutSecs:this._ecsProvider.getTrouterTelemetryConfig().sendProgressTimeoutSecs}}}_getTrouterConfig(g,m){return{trouterSettings:this._getSettings(),proxyUrlRewrite:this._acsProxy.hasProxyUrl()?g=>this._acsProxy.proxyfyUrl(g):void 0,skypeTokenProvider:m,telemetryConfig:this._createTrouterTelemetryConfig(g),registrationStateCallbackForAcsDoNotUse:g=>{this._logger.info(`TrouterService registrationStateCallbackForAcs: ${g}`),this._isRegistered=g,this._initialRegistrationCompleteDefer.isPending()&&this._isRegistered?this._initialRegistrationCompleteDefer.resolve():this._isRegistered?this._logger.info("Signaling service is currently registered"):this._logger.error("Signaling service is currently not registered. Unable to receive incoming calls"),this._onRegisteredChanged(g)}}}_onRegisteredChanged(g){this._logger.info(`TrouterService onRegisteredChanged: ${g}`),this._registeredChangedListeners.forEach((m=>{m(g)}))}}class TelemetryService{constructor(g){this._eventToTenantId={skypecosi_concore_web_csa_conversation_httprequest:Xa,skypecosi_concore_web_ts_calling_in_call_session:Xa,skypecosi_concore_web_ts_calling_call_setup_session:Xa,skypecosi_concore_native_ts_calling_in_call_session:Xa,skypecosi_concore_native_ts_calling_call_setup_session:Xa,skypecosi_concore_web_pluginless_call_session:Xa,skypecosi_concore_web_pluginless_modality_session:Xa,skypecosi_concore_web_csa_conversation_callmodality:Xa,skypecosi_concore_web_ts_calling_registry:Xa,mdsc_webrtc_session:Za,mdsc_webrtc_session_initial:Za,live_events:eo,mdsc_ortc_reports:Za,mdsc_ortc_reports_initial:Za,mdsc_rt_log:Za},this.getTenant=g=>this._eventToTenantId[g]?this._eventToTenantId[g]:"",this.getCallingAdapter=()=>({sendEvent:(g,m)=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g),name:g,properties:m})}}),this.getGenericTelemetryLogger=g=>({sendEvent:g=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g.eventName),name:g.eventName,properties:g.props})}}),this.getMediaAdapter=()=>({sendEvent:(g,m)=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g),name:g,properties:m})}}),this.sendEvents=g=>(g.forEach((g=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g.eventName),name:g.eventName,properties:g.props})})),Promise.resolve()),this._telemetryLogManager=g}}class EcsConfigObj{constructor(g,m,S,v,C,_=!0,E,T,I,b){this.configType=g,this.caConfigBag=m,this.queryParameters=S,this.ecsConfigReceiver=v,this.platformId=C,this.isAppInitiallyInForeground=_,this.userRawSkypeToken=E,this.userSkypeTokenExpiration=T,this.projectName=I,this.ecsHosts=b}}class WebCVProvider{constructor(){this._timedVideoEffectProviderPromise=timedDefer(V),this._timedModelConfigPromise=timedDefer(V)}get videoEffectProviderDeferredPromise(){return this._timedVideoEffectProviderPromise.deferredPromise}get modelConfigDeferredPromise(){return this._timedModelConfigPromise.deferredPromise}async getVideoEffectProvider(){return this._timedVideoEffectProviderPromise.timerStart(),this._timedVideoEffectProviderPromise.deferredPromise.promise}async getModelConfig(){return this._timedModelConfigPromise.deferredPromise.resolve({modelUrl:"",weightPathPrefix:""}),this._timedModelConfigPromise.deferredPromise.promise}}class EncodedStreamsWorkerProvider{constructor(g){this._encodedStreamsJsPath=g}async getWorkerUrl(){return this._encodedStreamsJsPath}}class HttpRequestDispatcher{constructor(g,m){this.logger=g,this.proxy=m}getRequestOptions(g,m,S,v,C){return{headers:m||{},timeout:v,payload:S||null,responseType:C}}getAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"GET")}postAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"POST")}putAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"PUT")}removeAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"DELETE")}async sendRequest(g,m={headers:{}},S){const v=this.logger.createChild(`[${m.causeId||generateGuid()}][Request]`);v.info(`sending, ${S}-${g}`);const C=Date.now();let _;m.headers=m.headers||{},m.headers["content-type"]||(m.headers["content-type"]=m.contentType||"application/json");try{const E=jp.request({url:g,method:S,headers:m.headers||{},timeout:"number"==typeof m.timeout?m.timeout:45e3,data:m.payload||"",responseType:m.responseType||m.dataType||"json",withCredentials:valueOrDefault(m.withCredentials,!1),cancelToken:new jp.CancelToken((g=>{_=g}))});isPromiseLike(m.timeout)&&m.timeout.then((()=>{v.info("Aborting pending request"),_()}),(()=>{v.info("Timeout promise rejected, ignoring")}));const T=await E;return v.info(`success, status=${T.status}`),{response:T.data,request:T.request,duration:Date.now()-C}}catch(g){if(v.info("failed"),jp.isCancel(g))throw v.info(`response=${safeJsonStringify(g.response)}`),{aborted:!0};throw g.response?v.info(`response=${safeJsonStringify(g.response)}`):g.request?v.info(`no response, request=${safeJsonStringify(g.request)}`):v.info(`request not made, error=${safeJsonStringify(g)}`),g||new Error("Request failed")}}}class VideoEffectsStatusManager{constructor(){this._activeEffects=[],this.eventEmitter=new Su.EventEmitter}on(g,m){if("statusChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.on(g,m)}off(g,m){if("statusChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.VIDEO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.off(g,m)}getActiveEffects(){return this._activeEffects}setActiveEffects(g){const m=this._activeEffects;this._activeEffects=g,this.eventEmitter.emit("statusChanged",m,this._activeEffects)}}!function(g){g[g.Default=0]="Default",g[g.User=1]="User"}(wm||(wm={}));class AudioEffectsStatusManager{constructor(){this._activeEffects={echoCancellation:[],noiseSuppression:[],autoGainControl:[]},this.eventEmitter=new Su.EventEmitter}on(g,m){if("statusChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.on(g,m)}off(g,m){if("statusChanged"!==g)throw new CallingCommunicationError({defaultError:D.FEATURES.AUDIO_EFFECTS.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this.eventEmitter.off(g,m)}getActiveEffects(){return this._activeEffects}setActiveEffects(g,m){const S={...this._activeEffects};this._activeEffects={...g},this.eventEmitter.emit("statusChanged",S,this._activeEffects,m)}}class WasmVqeProvider{get providerValue(){return this._providerValue}set providerValue(g){this._providerValue=g}async getAudioEffectProvider(){return this.providerValue}}var Nm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function AllowBackgroundFetchData(){this._isAllowed=!1}return AllowBackgroundFetchData.prototype.putBackgroundFetchAllowed=function(g){if(this._isAllowed=g,this.isBackgroundFetchAllowed()&&this._isAllowedDeferral){var m=this._isAllowedDeferral;this._isAllowedDeferral=void 0,m.resolve(void 0)}},AllowBackgroundFetchData.prototype.isBackgroundFetchAllowed=function(){return this._isAllowed},AllowBackgroundFetchData.prototype.waitForBackgroundFetchAllowed=function(){return this.isBackgroundFetchAllowed()?T.Resolved():(this._isAllowedDeferral||(this._isAllowedDeferral=T.Defer()),this._isAllowedDeferral.promise())},AllowBackgroundFetchData}();m.default=S})),km=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function AppActiveData(){this._isActive=!1}return AppActiveData.prototype.putAppActive=function(g){if(this._isActive=g,this.isAppActive()&&this._appActiveDeferral){var m=this._appActiveDeferral;this._appActiveDeferral=void 0,m.resolve(void 0)}},AppActiveData.prototype.isAppActive=function(){return this._isActive},AppActiveData.prototype.waitForAppActive=function(){return this.isAppActive()?T.Resolved():(this._appActiveDeferral||(this._appActiveDeferral=T.Defer()),this._appActiveDeferral.promise())},AppActiveData}();m.default=S})),Lm=function(){function SubscriptionToken(g,m){this._event=g,this._callback=m}return SubscriptionToken.prototype.unsubscribe=function(){this._event.unsubscribe(this._callback)},SubscriptionToken}(),Fm=function(){function SubscribableEvent(g){void 0===g&&(g=!1);var m=this;this._allowStopPropagation=g,this.fire=function(){for(var g=[],S=0;S<arguments.length;S++)g[S]=arguments[S];for(var v=m._subscribers,C=v.length-1;C>=0;C--){var _=v[C].apply(null,g);if(m._allowStopPropagation&&_)return!0}return!1},this._subscribers=[]}return SubscribableEvent.prototype.dispose=function(){this._subscribers=[]},SubscribableEvent.prototype.subscribe=function(g){return this._subscribers=this._subscribers.concat(g),new Lm(this,g)},SubscribableEvent.prototype.unsubscribe=function(g){this._subscribers=this._subscribers.filter((function(m){return m!==g}))},SubscribableEvent}(),xm=Object.freeze({__proto__:null,SubscriptionToken:Lm,default:Fm}),Um=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.Default=0]="Default",g[g.User=1]="User"}(m.EcsConfigType||(m.EcsConfigType={}))})),Vm=getAugmentedNamespace(xm),Bm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function Cache(g){this._config=g,this.configUpdated=new Vm.default,this._cachedConfigs={}}return Cache.prototype.initialize=function(){return this.updateConfigsToFetch()},Cache.prototype.updateConfigsToFetch=function(){var g=this,m=this._config.getConfig(),S=m.databaseInterface,v=m.configsToFetch;if(!S)return T.Resolved();for(var C=[],_loop_1=function(m){if(_._cachedConfigs[m])return"continue";C.push(S.getData(m).then((function(S){S&&(g._cachedConfigs[m]=S)})).catch((function(){return T.Resolved()})))},_=this,E=0,I=v;E<I.length;E++){_loop_1(I[E])}return T.all(C).then((function(){C.length>0&&g.configUpdated.fire()}))},Cache.prototype.getEcsConfig=function(){return this._cachedConfigs[Um.EcsConfigType.User]||this._cachedConfigs[Um.EcsConfigType.Default]},Cache.prototype.getEcsConfigByType=function(g){return this._cachedConfigs[g]},Cache.prototype.putConfig=function(g){var m=this.getEcsConfig();this._cachedConfigs[g.configType]=g;var S=this.getEcsConfig();(S&&S.configType===g.configType||m&&S&&m.configType!==S.configType)&&this.configUpdated.fire();var v=this._config.getConfig().databaseInterface;return v?v.putData(g.configType,g):T.Resolved()},Cache}();m.default=S})),Hm=createCommonjsModule((function(g,m){var S=C&&C.__assign||function(){return S=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},S.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0});var v=function(){function Config(){}return Config.prototype.initialize=function(g){if(this._config)throw"ECS Configuration already initialized";this._config=g},Config.prototype.getConfig=function(){if(!this._config)throw"ECS Configuration not yet initialized";return this._config},Config.prototype.setConfigsToFetch=function(g){if(!this._config)throw"ECS Configuration not yet initialized";this._config=S({},this._config,{configsToFetch:g})},Config.prototype.setFetchTimeout=function(g){if(!this._config)throw"ECS Configuration not yet initialized";this._config=S({},this._config,{fetchTimeout:g})},Config}();m.default=v})),$m=createCommonjsModule((function(g,m){var S=C&&C.__assign||function(){return S=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},S.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.assert=function(g,m){if(!g)throw new Error(m)},m.isObject=function(g){return null!==g&&"object"==typeof g},m.isString=function(g){return"string"==typeof g},m.attempt=function(g){for(var m=[],S=1;S<arguments.length;S++)m[S-1]=arguments[S];try{return g.apply(void 0,m)}catch(g){return new Error(g)}},m.remove=function(g,m){for(var S=g.length-1;S>=0;S--)g[S]===m&&g.splice(S,1)},m.clone=function(g){return Array.isArray(g)?g.map(m.clone):m.isObject(g)?Object.keys(g).reduce((function(v,C){var _;return S(S({},v),((_={})[C]=m.clone(g[C]),_))}),{}):g}})),Gm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.DEFAULT_TIME_GROW_FACTOR=2.718281828459045,m.DEFAULT_TIME_JITTER=.11962656472;var S=function(){function ExponentialTime(g,S,v,C){void 0===v&&(v=m.DEFAULT_TIME_GROW_FACTOR),void 0===C&&(C=m.DEFAULT_TIME_JITTER),this._initialTime=g,this._maxTime=S,this._growFactor=v,this._jitterFactor=C,$m.assert(this._initialTime>0,"Initial delay must be positive"),$m.assert(this._maxTime>0,"Delay upper bound must be positive"),$m.assert(this._growFactor>=0,"Ratio must be non-negative"),$m.assert(this._jitterFactor>=0,"Jitter factor must be non-negative"),this.reset()}return ExponentialTime.prototype.reset=function(){this._incrementCount=0,this._currentTime=Math.round(this._initialTime*(1+Math.random()*this._jitterFactor))},ExponentialTime.prototype.getTime=function(){return this._currentTime},ExponentialTime.prototype.getIncrementCount=function(){return this._incrementCount},ExponentialTime.prototype.calculateNext=function(){var g=this._currentTime*this._growFactor;return g>this._maxTime&&(g=this._maxTime),this._jitterFactor<1e-5?this._currentTime=g:this._currentTime=Math.round(Math.random()*g*this._jitterFactor+g),this._currentTime<this._initialTime&&(this._currentTime=this._initialTime),this._currentTime>this._maxTime&&(this._currentTime=this._maxTime),this._incrementCount++,this._currentTime},ExponentialTime.prototype.getTimeAndCalculateNext=function(){var g=this.getTime();return this.calculateNext(),g},ExponentialTime}();m.ExponentialTime=S})),jm=createCommonjsModule((function(g,m){var S,v,_,E=C&&C.__extends||(S=function(g,m){return S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m.hasOwnProperty(S)&&(g[S]=m[S])},S(g,m)},function(g,m){function __(){this.constructor=g}S(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}),I=C&&C.__assign||function(){return I=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},I.apply(this,arguments)};function isJsonContentType(g){return!!g&&0===g.indexOf("application/json")}function isFormContentType(g){return!!g&&0===g.indexOf("application/x-www-form-urlencoded")}function isFormDataContentType(g){return!!g&&0===g.indexOf("multipart/form-data")}function DefaultErrorHandler(g,m){return m.canceled||!m.statusCode||m.statusCode>=400&&m.statusCode<600?_.DoNotRetry:_.RetryCountedWithBackoff}Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.DontCare=0]="DontCare",g[g.Low=1]="Low",g[g.Normal=2]="Normal",g[g.High=3]="High",g[g.Critical=4]="Critical"}(v=m.WebRequestPriority||(m.WebRequestPriority={})),function(g){g[g.DoNotRetry=0]="DoNotRetry",g[g.RetryUncountedImmediately=1]="RetryUncountedImmediately",g[g.RetryUncountedWithBackoff=2]="RetryUncountedWithBackoff",g[g.RetryCountedWithBackoff=3]="RetryCountedWithBackoff",g[g.PauseUntilResumed=4]="PauseUntilResumed"}(_=m.ErrorHandlingType||(m.ErrorHandlingType={})),m.DefaultOptions={priority:v.Normal},m.SimpleWebRequestOptions={MaxSimultaneousRequests:5,HungRequestCleanupIntervalMs:1e4,setTimeout:function(g,m){return setTimeout(g,m)},clearTimeout:function(g){return clearTimeout(g)}},m.DefaultErrorHandler=DefaultErrorHandler;var b,A=[],R=[],P=[],M=0,w=0,D=function(){function SimpleWebRequestBase(g,S,v,C,_){this._action=g,this._url=S,this.options=v,this._getHeaders=C,this._blockRequestUntil=_,this._aborted=!1,this._timedOut=!1,this._paused=!1,this._created=Date.now(),this._finishHandled=!1,this._retryExponentialTime=new Gm.ExponentialTime(1e3,3e5),this._options=I(I({},m.DefaultOptions),v)}return SimpleWebRequestBase.prototype.getPriority=function(){return this._options.priority||v.DontCare},SimpleWebRequestBase.checkQueueProcessing=function(){for(var _loop_1=function(){var g=A.shift();R.push(g),(g._blockRequestUntil&&g._blockRequestUntil()||T.Resolved()).finally((function(){$m.remove(R,g)})).then((function(){P.length<m.SimpleWebRequestOptions.MaxSimultaneousRequests&&!g._aborted?(P.push(g),O._scheduleHungRequestCleanupIfNeeded(),g._fire()):g._enqueue()}),(function(m){g._respond("_blockRequestUntil rejected: "+m)}))};A.length>0&&P.length<m.SimpleWebRequestOptions.MaxSimultaneousRequests;)_loop_1()},SimpleWebRequestBase._scheduleHungRequestCleanupIfNeeded=function(){P.length>0&&void 0===b?b=m.SimpleWebRequestOptions.setTimeout(this._hungRequestCleanupTimerCallback,m.SimpleWebRequestOptions.HungRequestCleanupIntervalMs):0===P.length&&b&&(m.SimpleWebRequestOptions.clearTimeout(b),b=void 0)},SimpleWebRequestBase.prototype._removeFromQueue=function(){$m.remove(P,this),$m.remove(A,this)},SimpleWebRequestBase.prototype._assertAndClean=function(g,m){g||(this._removeFromQueue(),console.error(m),$m.assert(g,m))},SimpleWebRequestBase.prototype._fire=function(){var g=this;this._xhr=new XMLHttpRequest,this._xhrRequestHeaders={};var S=$m.attempt((function(){g._xhr.open(g._action,g._url,!0)}));if(S)this._respond(S.toString());else{if(this._options.timeout){var v=w;3!==v&&(this._assertAndClean(!this._requestTimeoutTimer,"Double-fired requestTimeoutTimer"),this._requestTimeoutTimer=m.SimpleWebRequestOptions.setTimeout((function(){g._requestTimeoutTimer=void 0,g._timedOut=!0,g.abort()}),this._options.timeout)),(3===v||v<=1)&&(this._xhr.timeout=this._options.timeout,this._xhr.ontimeout=function(){w=3,3===v&&(g._timedOut=!0,g._aborted=!0,g._respond("TimedOut"))})}var C=M;3!==C?(0===C&&(M=1),this._xhr.onreadystatechange=function(){g._xhr&&(3!==g._xhr.readyState||!g._options.streamingDownloadProgress||g._aborted?4===g._xhr.readyState&&(0===C&&1===M&&m.SimpleWebRequestOptions.setTimeout((function(){3!==M&&(M=2)}),1e4),g._respond()):g._options.streamingDownloadProgress(g._xhr.responseText))}):this._options.streamingDownloadProgress&&(this._xhr.onreadystatechange=function(){g._xhr&&3===g._xhr.readyState&&g._options.streamingDownloadProgress&&!g._aborted&&g._options.streamingDownloadProgress(g._xhr.responseText)}),2!==C&&(this._xhr.onload=function(){M=3,3===C&&g._respond()},this._xhr.onerror=function(){M=3,3===C&&g._respond()}),this._xhr.onabort=function(){g._aborted=!0,g._respond("Aborted")},this._xhr.upload&&this._options.onProgress&&(this._xhr.upload.onprogress=this._options.onProgress);var _=this._options.acceptType||"json",E=this._options.customResponseType||SimpleWebRequestBase._getResponseType(_),T=$m.attempt((function(){g._xhr.responseType=E}));if(T&&"json"!==E)throw T;O._setRequestHeader(this._xhr,this._xhrRequestHeaders,"Accept",SimpleWebRequestBase.mapContentType(_)),this._xhr.withCredentials=!!this._options.withCredentials;var I=this.getRequestHeaders(),b={};if(Object.keys(I).forEach((function(m){var S=I[m],v=m.toLowerCase();"content-type"!==v?"accept"!==v?(g._assertAndClean(!b[v],"Setting duplicate header key: "+b[v]+" and "+m),null!=S?(b[v]=!0,O._setRequestHeader(g._xhr,g._xhrRequestHeaders,m,S)):console.warn('Tried to set header "'+m+'" on request with "'+S+'" value, header will be dropped')):g._assertAndClean(!1,"Don't set Accept with options.headers -- use it with the options.acceptType property"):g._assertAndClean(!1,"Don't set Content-Type with options.headers -- use it with the options.contentType property")})),this._options.sendData){var A=SimpleWebRequestBase.mapContentType(this._options.contentType||"json");O._setRequestHeader(this._xhr,this._xhrRequestHeaders,"Content-Type",A);var R=SimpleWebRequestBase.mapBody(this._options.sendData,A);this._xhr.send(R)}else this._xhr.send()}},SimpleWebRequestBase._setRequestHeader=function(g,m,S,v){g.setRequestHeader(S,v),m[S]=v},SimpleWebRequestBase.mapContentType=function(g){return"json"===g?"application/json":"form"===g?"application/x-www-form-urlencoded":g},SimpleWebRequestBase.mapBody=function(g,m){if(isJsonContentType(m)){if(!$m.isString(g))return JSON.stringify(g)}else if(isFormContentType(m)){if(!$m.isString(g)&&$m.isObject(g)){var S=g;return Object.keys(S).map((function(g){return encodeURIComponent(g)+(S[g]?"="+encodeURIComponent(S[g].toString()):"")})).join("&")}}else if(isFormDataContentType(m)){if($m.isObject(g)){var v=new FormData,C=g;return Object.keys(C).forEach((function(g){return v.append(g,C[g])})),v}$m.assert(!1,"contentType multipart/form-data must include an object as sendData")}return g},SimpleWebRequestBase.prototype.setUrl=function(g){this._url=g},SimpleWebRequestBase.prototype.setHeader=function(g,m){this._options.augmentHeaders||(this._options.augmentHeaders={}),m?this._options.augmentHeaders[g]=m:delete this._options.augmentHeaders[g]},SimpleWebRequestBase.prototype.getRequestHeaders=function(){var g={};return!this._getHeaders||this._options.overrideGetHeaders||this._options.headers||(g=I(I({},g),this._getHeaders())),this._options.overrideGetHeaders&&(g=I(I({},g),this._options.overrideGetHeaders)),this._options.headers&&(g=I(I({},g),this._options.headers)),this._options.augmentHeaders&&(g=I(I({},g),this._options.augmentHeaders)),g},SimpleWebRequestBase.prototype.getOptions=function(){return $m.clone(this._options)},SimpleWebRequestBase.prototype.setPriority=function(g){this._options.priority!==g&&(this._options.priority=g,this._paused||this._xhr||($m.remove(A,this),this._enqueue()))},SimpleWebRequestBase.prototype.resumeRetrying=function(){this._paused?(this._paused=!1,this._enqueue()):$m.assert(!1,"resumeRetrying() called but not paused!")},SimpleWebRequestBase.prototype._enqueue=function(){var g=this;if(!this._aborted&&!(P.indexOf(this)>=0||R.indexOf(this)>=0||A.indexOf(this)>=0)){var m=A.findIndex((function(m){return m.getPriority()===g.getPriority()&&m._created>g._created||m.getPriority()<g.getPriority()}));m>-1?A.splice(m,0,this):A.push(this),SimpleWebRequestBase.checkQueueProcessing()}},SimpleWebRequestBase._getResponseType=function(g){return"blob"===g?"arraybuffer":"text/xml"===g||"application/xml"===g?"document":"text/plain"===g?"text":"json"},SimpleWebRequestBase._hungRequestCleanupTimerCallback=function(){b=void 0,P.filter((function(g){return!(!g._xhr||4!==g._xhr.readyState)&&(console.warn("SimpleWebRequests found a completed XHR that hasn't invoked it's callback functions, manually responding"),!0)})).forEach((function(g){g._respond()})),O._scheduleHungRequestCleanupIfNeeded()},SimpleWebRequestBase}();m.SimpleWebRequestBase=D;var O=function(g){function SimpleWebRequest(m,S,v,C,_){return g.call(this,m,S,v,C,_)||this}return E(SimpleWebRequest,g),SimpleWebRequest.prototype.abort=function(){this._aborted?$m.assert(!1,"Already aborted "+this._action+" request to "+this._url):(this._aborted=!0,this._retryTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._retryTimer),this._retryTimer=void 0),this._requestTimeoutTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0),this._deferred?(this._respond("Aborted"),this._xhr&&this._xhr.abort()):$m.assert(!1,"Haven't even fired start() yet -- can't abort"))},SimpleWebRequest.prototype.start=function(){var g=this;return this._deferred?($m.assert(!1,"WebRequest already started"),T.Rejected("WebRequest already started")):(this._deferred=T.Defer(),this._deferred.onCancel((function(){g.abort()})),this._enqueue(),this._deferred.promise())},SimpleWebRequest.prototype._respond=function(g){var S=this;if(!this._finishHandled){this._finishHandled=!0,this._removeFromQueue(),this._retryTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._retryTimer),this._retryTimer=void 0),this._requestTimeoutTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0);var v,C=0;if(this._xhr)try{C=this._xhr.status,v=this._xhr.statusText||g}catch(g){}else v=g||"Browser Error - Possible CORS or Connectivity Issue";var E,T,I={};if(this._xhr){if((this._xhr.getAllResponseHeaders()||"").split(/\r?\n/).forEach((function(g){if(0!==g.length){var m=g.indexOf(":");-1===m?I[g]="":I[g.substr(0,m).toLowerCase()]=g.substr(m+1).trim()}})),!I["content-type"]){var b=this._xhr.getResponseHeader("content-type");b&&(I["content-type"]=b)}if(E=this._xhr.response,I["content-type"]&&isJsonContentType(I["content-type"])&&(!E||!$m.isObject(E))&&("text"===this._xhr.responseType||""===this._xhr.responseType)&&this._xhr.responseText)try{E=JSON.parse(this._xhr.responseText)}catch(g){T=g,console.warn("Failed to parse XHR JSON response")}}if(this._xhr&&4===this._xhr.readyState&&(C>=200&&C<300||304===C)){var A={url:this._xhr.responseURL||this._url,method:this._action,requestOptions:this._options,requestHeaders:this._xhrRequestHeaders||{},statusCode:C,statusText:v,headers:I,body:E,responseParsingException:T};this._deferred.resolve(A)}else{var R={url:(this._xhr?this._xhr.responseURL:void 0)||this._url,method:this._action,requestOptions:this._options,requestHeaders:this._xhrRequestHeaders||{},statusCode:C,statusText:v,headers:I,body:E,canceled:this._aborted,timedOut:this._timedOut,responseParsingException:T};this._options.augmentErrorResponse&&this._options.augmentErrorResponse(R);var P=this._options.customErrorHandler?this._options.customErrorHandler(this,R):DefaultErrorHandler(this,R);P!==_.DoNotRetry&&(this._options.retries&&this._options.retries>0||P===_.PauseUntilResumed||P===_.RetryUncountedImmediately||P===_.RetryUncountedWithBackoff)?(P===_.RetryCountedWithBackoff&&this._options.retries--,this._requestTimeoutTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0),this._aborted=!1,this._timedOut=!1,this._finishHandled=!1,this._xhr&&(this._xhr.onabort=null,this._xhr.onerror=null,this._xhr.onload=null,this._xhr.onprogress=null,this._xhr.onreadystatechange=null,this._xhr.ontimeout=null,this._xhr=void 0,this._xhrRequestHeaders=void 0),P===_.PauseUntilResumed?this._paused=!0:P===_.RetryUncountedImmediately?this._enqueue():this._retryTimer=m.SimpleWebRequestOptions.setTimeout((function(){S._retryTimer=void 0,S._enqueue()}),this._retryExponentialTime.getTimeAndCalculateNext())):this._deferred.reject(R)}D.checkQueueProcessing()}},SimpleWebRequest}(D);m.SimpleWebRequest=O})),qm=createCommonjsModule((function(g,m){var S=C&&C.__assign||function(){return S=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},S.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0});var v=function(){function GenericRestClient(g){this._defaultOptions={excludeEndpointUrl:!1,withCredentials:!1,retries:0},this._endpointUrl=g}return GenericRestClient.prototype._performApiCall=function(g,m,v,C){var _=this;void 0===C&&(C={});var E=S(S({},this._defaultOptions),C);v&&(E.sendData=v),E.eTag&&(E.augmentHeaders||(E.augmentHeaders={}),E.augmentHeaders["If-None-Match"]=E.eTag),E.contentType||(E.contentType=$m.isString(E.sendData)?"form":"json");var T=E.excludeEndpointUrl?g:this._endpointUrl+g;return new jm.SimpleWebRequest(m,T,E,(function(){return _._getHeaders(E)}),(function(){return _._blockRequestUntil(E)})).start().then((function(g){return _._processSuccessResponse(g),g}))},GenericRestClient.prototype._getHeaders=function(g){return{}},GenericRestClient.prototype._blockRequestUntil=function(g){},GenericRestClient.prototype._processSuccessResponse=function(g){},GenericRestClient.prototype.performApiGet=function(g,m){return this.performApiGetDetailed(g,m).then((function(g){return g.body}))},GenericRestClient.prototype.performApiGetDetailed=function(g,m){return this._performApiCall(g,"GET",void 0,m)},GenericRestClient.prototype.performApiPost=function(g,m,S){return this.performApiPostDetailed(g,m,S).then((function(g){return g.body}))},GenericRestClient.prototype.performApiPostDetailed=function(g,m,S){return this._performApiCall(g,"POST",m,S)},GenericRestClient.prototype.performApiPatch=function(g,m,S){return this.performApiPatchDetailed(g,m,S).then((function(g){return g.body}))},GenericRestClient.prototype.performApiPatchDetailed=function(g,m,S){return this._performApiCall(g,"PATCH",m,S)},GenericRestClient.prototype.performApiPut=function(g,m,S){return this.performApiPutDetailed(g,m,S).then((function(g){return g.body}))},GenericRestClient.prototype.performApiPutDetailed=function(g,m,S){return this._performApiCall(g,"PUT",m,S)},GenericRestClient.prototype.performApiDelete=function(g,m,S){return this.performApiDeleteDetailed(g,m,S).then((function(g){return g.body}))},GenericRestClient.prototype.performApiDeleteDetailed=function(g,m,S){return this._performApiCall(g,"DELETE",m,S)},GenericRestClient}();m.GenericRestClient=v})),Wm=createCommonjsModule((function(g,m){function __export(g){for(var S in g)m.hasOwnProperty(S)||(m[S]=g[S])}Object.defineProperty(m,"__esModule",{value:!0}),__export(Gm),__export(qm),__export(jm)})),zm=Wm,Km=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function TelemetryEventBase(){}return TelemetryEventBase.prototype.getAttributes=function(){return{Source:"ecs_client"}},TelemetryEventBase}();m.TelemetryEventBase=S})),Jm=createCommonjsModule((function(g,m){var S,v=C&&C.__extends||(S=function(g,m){return S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m.hasOwnProperty(S)&&(g[S]=m[S])},S(g,m)},function(g,m){function __(){this.constructor=g}S(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});Object.defineProperty(m,"__esModule",{value:!0});var _=function(g){function EcsConfigFetchResponse(m,S,v,C,_,E,T,I,b,A,R,P,M){var w=g.call(this)||this;return w._responseTime=m,w._responseCode=S,w._fetchAttempts=v,w._hasValidToken=C,w._serverEndpoint=_,w._etag=E,w._fetchDurationValid=T,w._cacheAvailable=I,w._responseSize=b,w._configAge=A,w._configExpired=R,w._fetchStart=P,w._fetchEnd=M,w}return v(EcsConfigFetchResponse,g),EcsConfigFetchResponse.prototype.getEventName=function(){return"ecs_tsclient_fetch_config"},EcsConfigFetchResponse.prototype.getAttributes=function(){var m=g.prototype.getAttributes.call(this);return m.fetch_delay_ms=this._responseTime,m.fetch_response_code=this._responseCode,m.fetch_attempts=this._fetchAttempts,m.authenticated_user=this._hasValidToken,m.url=this._serverEndpoint,m.fetched_etag=this._etag,m.fetch_duration_valid=this._fetchDurationValid,m.cache_available=this._cacheAvailable,m.response_size=this._responseSize,m.config_age=this._configAge,m.config_expired=this._configExpired,m.fetch_start=this._fetchStart,m.fetch_end=this._fetchEnd,m},EcsConfigFetchResponse}(Km.TelemetryEventBase);m.EcsConfigFetchResponse=_})),Ym=createCommonjsModule((function(g,m){var S,v=C&&C.__extends||(S=function(g,m){return S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var S in m)m.hasOwnProperty(S)&&(g[S]=m[S])},S(g,m)},function(g,m){function __(){this.constructor=g}S(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}),_=C&&C.__assign||function(){return _=Object.assign||function(g){for(var m,S=1,v=arguments.length;S<v;S++)for(var C in m=arguments[S])Object.prototype.hasOwnProperty.call(m,C)&&(g[C]=m[C]);return g},_.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0});var E,I,b=1728e5,A=18e5,R=31536e6,P=3e4,M=function(g){function EcsFetcher(m,S,v,C,_,E,T,I){var b=g.call(this,m)||this;if(b._config=S,b._skypeTokenData=v,b._appActiveData=C,b._allowBackgroundFetchData=_,b._etag=E,b._getUserConfig=T,b._apiPath="/config/v1/"+b._config.getConfig().clientName+"/"+b._config.getConfig().clientVersion,I){var A=Object.keys(I).map((function(g){return encodeURIComponent(g)+"="+encodeURIComponent(I[g].toString())}));A&&(b._apiPath+="?"+A.join("&"))}return b}return v(EcsFetcher,g),EcsFetcher.prototype._blockRequestUntil=function(g){var m=this;if(this._getUserConfig&&!this._skypeTokenData.isSkypeTokenValid()&&console.log("ECS - Delaying User config fetch until we have a valid SkypeToken"),!this._appActiveData.isAppActive()&&!this._allowBackgroundFetchData.isBackgroundFetchAllowed()){var S=this._getUserConfig?"User config":"config";console.log("ECS - Delaying "+S+" fetch until the app is active (or background fetch is allowed)")}return T.race([this._appActiveData.waitForAppActive(),this._allowBackgroundFetchData.waitForBackgroundFetchAllowed()]).then((function(){if(m._getUserConfig)return m._skypeTokenData.waitForValidSkypeToken()})).then((function(){I=Date.now()}))},EcsFetcher.prototype._getHeaders=function(){var g={};return this._etag&&(g["If-None-Match"]=this._etag),this._getUserConfig&&(g.Authorization=this._skypeTokenData.getSkypeToken()),g},EcsFetcher.prototype.getConfig=function(){var m=this._config.getConfig().fetchTimeout;return void 0!==m&&(m<0?m=0:m>0&&m<P&&(m=P)),g.prototype.performApiGetDetailed.call(this,this._apiPath,{timeout:m})},EcsFetcher}(zm.GenericRestClient),w=function(){function EcsClient(g,m,S,v,C){this._config=g,this._skypeTokenData=m,this._appActiveData=S,this._allowBackgroundFetchData=v,this._telemetryManager=C,this._ecsFailureBackoffTimer=new zm.ExponentialTime(1e3,3e5),this._cacheMaxAgeRegex=/.*max-age=(\d+).*/gi,this._serverIndex=NaN}return EcsClient.prototype.getConfig=function(g,m,S){var v=this,C=this._config.getConfig().hosts;if((isNaN(this._serverIndex)||this._serverIndex>C.length-1)&&(this._serverIndex=Math.floor(Math.random()*C.length)),!C||!C.length)return T.Rejected(new Error("no configuration service endpoint"));var b=T.Defer(),A=0,callConfigServer=function(){var P=g&&g.eTag?g.eTag:void 0,w=new M(C[v._serverIndex],v._config,v._skypeTokenData,v._appActiveData,v._allowBackgroundFetchData,P,m,S);A++,w.getConfig().then((function(S){var M=S.headers.etag,w=S.headers.expires;if(S.body&&S.body.Headers&&(M||(M=S.body.Headers.ETag),w||(w=S.body.Headers.Expires)),E=Date.now(),!M||!w)return console.warn("ECS - Service returned an empty ETag or Expiration header: "+JSON.stringify(S)),T.Rejected();var D,O=new Date(v._calculateExpirationDate(S.headers)).getTime();if(304===S.statusCode&&g)(D=_({},g)).eTag=M,D.expiration=O,D.cacheUpdateTime=E,D.lastFetchTokenHash=v._skypeTokenData.getSkypeTokenHash(S.requestHeaders.Authorization);else{if("object"!=typeof S.body)return console.warn("ECS - Service returned invalid response "+JSON.stringify(S)),T.Rejected();D={config:S.body,configType:m?Um.EcsConfigType.User:Um.EcsConfigType.Default,eTag:M,expiration:O,cacheUpdateTime:I,lastFetchTokenHash:v._skypeTokenData.getSkypeTokenHash(S.requestHeaders.Authorization),appVersion:v._config.getConfig().clientVersion}}var N=E-I,k=!(N<0||N>R),L=g?Date.now()-g.cacheUpdateTime:0;v._telemetryManager.sendTelemetryEvent(new Jm.EcsConfigFetchResponse(N,S.statusCode,A,v._skypeTokenData.isSkypeTokenValid(),C[v._serverIndex],M,k,!!P,JSON.stringify(S).length,L,!(g&&g.expiration-Date.now()>0),I,E)),v._ecsFailureBackoffTimer.reset(),b.resolve(D)})).catch((function(){v._serverIndex=(v._serverIndex+1)%C.length,setTimeout((function(){callConfigServer()}),v._ecsFailureBackoffTimer.getTimeAndCalculateNext())}))};return callConfigServer(),b.promise()},EcsClient.prototype._calculateExpirationDate=function(g){var m=Date.now()+b;if(g.date&&g.expires){var S=new Date(g.date).getTime(),v=Date.now()-S,C=new Date(g.expires).getTime();return isNaN(C)?m:Math.min(m,C+v)}var _=this._cacheMaxAgeRegex.exec(g["cache-control"]);return this._cacheMaxAgeRegex.lastIndex=0,_&&2===_.length?Math.min(m,Date.now()+1e3*Number(_[1])):Date.now()+A},EcsClient}();m.default=w})),Qm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function Scheduler(g,m,S,v,C,_){var E=this;this._config=g,this._skypeTokenData=m,this._cache=S,this._isFetchingSettings={},this._pendingFetch={},this._paused=!1,this._fetchEcsSettingsIfNeeded=function(g){var m=E._config.getConfig(),S=E._cache.getEcsConfigByType(g);if(-1!==m.configsToFetch.indexOf(g)&&!E._isFetchingSettings[g])if(S||!E._pendingFetch[g]){var v=S?S.expiration-Date.now():-1;v<=0||S&&g===Um.EcsConfigType.User&&E._skypeTokenData.isSkypeTokenValid()&&S.lastFetchTokenHash!==E._skypeTokenData.getSkypeTokenHash(E._skypeTokenData.getSkypeToken())?E._fetchSkypeEcsSettings(g):setTimeout((function(){return E._fetchEcsSettingsIfNeeded(g)}),v)}else E._fetchSkypeEcsSettings(g)},this._fetchSkypeEcsSettings=function(g,m){(void 0===m&&(m=!1),E._isFetchingSettings[g]||E._paused&&!m)?E._pendingFetch[g]=!0:(E._pendingFetch[g]=!1,E._isFetchingSettings[g]=!0,E._config.getConfig().getEcsParameters().catch((function(){return console.warn("ECS - Failed to fetch ECS fetching parameters"),{}})).then((function(m){return E._ecsClient.getConfig(E._cache.getEcsConfig(),g===Um.EcsConfigType.User,m)})).then((function(m){console.log("ECS - Config fetch complete"),E._isFetchingSettings[g]=!1,E._cache.putConfig(m),E._fetchEcsSettingsIfNeeded(g)})))},this._ecsClient=new Ym.default(this._config,this._skypeTokenData,v,C,_)}return Scheduler.prototype.initialize=function(){var g=this;this.updateConfigsToFetch(),this._skypeTokenData.skypeTokenChanged.subscribe((function(){return g._fetchEcsSettingsIfNeeded(Um.EcsConfigType.User)}))},Scheduler.prototype.updateConfigsToFetch=function(){for(var g=this._config.getConfig(),m=0,S=g.configsToFetch;m<S.length;m++){(_=S[m])in this._isFetchingSettings||(this._isFetchingSettings[_]=!1),_ in this._isFetchingSettings||(this._pendingFetch[_]=!1)}for(var v=0,C=g.configsToFetch;v<C.length;v++){var _=C[v],E=this._cache.getEcsConfigByType(_);!E||E.appVersion&&E.appVersion!==g.clientVersion?this._fetchSkypeEcsSettings(_,!0):this._fetchEcsSettingsIfNeeded(_)}},Scheduler.prototype.requestUpdate=function(){for(var g=0,m=this._config.getConfig().configsToFetch;g<m.length;g++){var S=m[g];this._fetchSkypeEcsSettings(S)}},Scheduler.prototype.pause=function(){this._paused=!0},Scheduler.prototype.resume=function(){this._paused=!1;for(var g=0,m=this._config.getConfig().configsToFetch;g<m.length;g++){var S=m[g];this._fetchEcsSettingsIfNeeded(S)}},Scheduler}();m.default=S})),Xm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function SkypeTokenData(){this.skypeTokenChanged=new Vm.default}return SkypeTokenData.prototype.putSkypeTokenData=function(g){if(this._data=g,this.isSkypeTokenValid()&&this.skypeTokenChanged.fire(),this.isSkypeTokenValid()&&this._validSkypeTokenDeferral){var m=this._validSkypeTokenDeferral;this._validSkypeTokenDeferral=void 0,m.resolve(void 0)}},SkypeTokenData.prototype.isSkypeTokenValid=function(){var g=this._data;return!!g&&!!g.skypeToken&&g.skypeTokenExpiration>Date.now()},SkypeTokenData.prototype.getSkypeToken=function(){var g=this._data;if(!g||!g.skypeToken)throw"No Skype Token provided";return g.skypeToken},SkypeTokenData.prototype.getSkypeTokenHash=function(g){return void 0===g?0:g.split("").reduce((function(g,m){return(101*g+m.charCodeAt(0))%999727999}),g.length)},SkypeTokenData.prototype.waitForValidSkypeToken=function(){return this.isSkypeTokenValid()?T.Resolved():(this._validSkypeTokenDeferral||(this._validSkypeTokenDeferral=T.Defer()),this._validSkypeTokenDeferral.promise())},SkypeTokenData}();m.default=S})),Zm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function TelemetryManager(g){this._cache=g,this.telemetryEventAdded=new Vm.default}return TelemetryManager.prototype.sendTelemetryEvent=function(g){var m=g.getEventName(),S=g.getAttributes(),v=!1,C=this._cache.getEcsConfig();if(C&&TelemetryManager._containsEcsClientTelemetryConfig(C.config)){var _=C.config.ECSCONFIG;_&&_.ecsClientTelemetry&&(v=!!_.ecsClientTelemetry[m])}v&&this.telemetryEventAdded.fire(m,S)},TelemetryManager._containsEcsClientTelemetryConfig=function(g){return!!g&&!!g.ECSCONFIG&&!!g.ECSCONFIG.ecsClientTelemetry},TelemetryManager}();m.default=S})),ef=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.Models=Um;var S=function(){function EcsClient(){this._allowBackgroundFetchData=new Nm.default,this._appActiveData=new km.default,this._config=new Hm.default,this._cache=new Bm.default(this._config),this._skypeTokenData=new Xm.default,this._telemetryManager=new Zm.default(this._cache),this._scheduler=new Qm.default(this._config,this._skypeTokenData,this._cache,this._appActiveData,this._allowBackgroundFetchData,this._telemetryManager),this.telemetryEventAdded=this._telemetryManager.telemetryEventAdded,this.configUpdated=this._cache.configUpdated}return EcsClient.prototype.initialize=function(g){var m=this;return this._config.initialize(g),this._skypeTokenData.putSkypeTokenData(g.initialSkypeTokenData),this._appActiveData.putAppActive(g.initialAppActiveState),this._cache.initialize().then((function(){m._scheduler.initialize()}))},EcsClient.prototype.getConfig=function(){return this._cache.getEcsConfig()},EcsClient.prototype.getConfigType=function(){var g=this._cache.getEcsConfig();if(g)return g.configType},EcsClient.prototype.requestUpdate=function(){this._scheduler.requestUpdate()},EcsClient.prototype.pause=function(){this._scheduler.pause()},EcsClient.prototype.resume=function(){this._scheduler.resume()},EcsClient.prototype.setAllowBackgroundFetch=function(g){this._allowBackgroundFetchData.putBackgroundFetchAllowed(g)},EcsClient.prototype.useSkypeToken=function(g,m){this._skypeTokenData.putSkypeTokenData({skypeToken:g,skypeTokenExpiration:m})},EcsClient.prototype.setAppActive=function(g){this._appActiveData.putAppActive(g)},EcsClient.prototype.setConfigsToFetch=function(g){var m=this;return this._config.setConfigsToFetch(g),this._cache.updateConfigsToFetch().then((function(){m._scheduler.updateConfigsToFetch()}))},EcsClient.prototype.setFetchTimeout=function(g){this._config.setFetchTimeout(g)},EcsClient}();m.default=S})),tf=getDefaultExportFromCjs(ef);class EcsSkypeToken{constructor(g,m){this.skypeToken=g,this.skypeTokenExpiration=m}}class EcsConfigFetcher{constructor(g,m,S){this._logger=g,this._acsProxy=m,this._counter=0,this._resumeCounter=3e3,this._disposed=!1,this._ecsClient=S||new tf,this._isSubscribed=this._initialized=!1}subscribeEcsConfig(g){return g.configType!==wm.Default&&g.configType!==wm.User?Promise.reject(Qs):(this._resetConfigCache(g),this._initialized||this._isSubscribed?Promise.reject(Zs):Promise.resolve(this._initializeEcsConfig(g).then((()=>{this._ecsClient.configUpdated.subscribe((()=>{if(this._isSubscribed=!0,this._config=this._ecsClient.getConfig(),g.ecsConfigReceiver&&this._config){if(g.ecsConfigReceiver(this._config.config)?this._counter=0:this._counter+=1,this._counter>3)try{this._ecsClient.pause(),this._counter=0,this._resumeCounter*=2,window.setTimeout((()=>{this._disposed||this._ecsClient.resume()}),this._resumeCounter)}catch(g){this._logger.warn("Failed to retry fetch ECS")}}}))})).catch((g=>{this._logger.warn("Failed to initialize ECS config because: "+g)}))))}setConfigsToFetch(g){return this._ecsClient.setConfigsToFetch(g)}dispose(){try{this._ecsClient.configUpdated.dispose(),this._disposed=!0}catch(g){this._logger.warn(`Failed to dispose ECS config update, e=${g}`)}}getConfigType(){if(void 0!==this._configDefCache)return this._ecsClient.getConfigType()}getETag(){return void 0===this._config?"":this._config.eTag}getConfigId(g){return void 0===this._config?Promise.reject(Xs):Promise.resolve(this._config.config[Ys][g])}setAllowBackgroundFetch(g){return this._ecsClient.setAllowBackgroundFetch(g),Promise.resolve()}setSkypeToken(g,m){return this._ecsClient.useSkypeToken(g,m),Promise.resolve()}setAppActiveState(g){return this._ecsClient.setAppActive(g),Promise.resolve()}_resetConfigCache(g){void 0===g||void 0===this._configDefCache||g.queryParameters===this._configDefCache.queryParameters&&g.configType===this._configDefCache.configType||(this._isSubscribed=!1,this._initialized=!1,this._config=void 0),this._configDefCache=g}_initializeEcsConfig(g){this._initialized=!0;const m={hosts:g.ecsHosts?g.ecsHosts:this._getHostUrls(g.caConfigBag),clientName:Js,clientVersion:this._getClientVersion(g.platformId),configsToFetch:this._getLibConfigType(g.configType),getEcsParameters:()=>this._getQueryParameterPromise(g.queryParameters),initialAppActiveState:g.isAppInitiallyInForeground,initialSkypeTokenData:new EcsSkypeToken(g.userRawSkypeToken,g.userSkypeTokenExpiration)};return new Promise(((g,S)=>{this._ecsClient.initialize(m).then(g,S)}))}_getHostUrls(g){let m;if(g)if(g.identityType===la.Enterprise)m=aa.Enterprise_Ecs_ServerUrl;else switch(g.cloudType){case ta.Public:m=aa.Public_EcsServer_Url;break;case ta.Dod:m=aa.Dod_EcsServer_Url;break;case ta.GccHigh:m=aa.GccHigh_EcsServer_Url;break;case ta.AirGap08:m=aa.AirGap08_EcsServer_Url;break;case ta.AirGap09:m=aa.AirGap09_EcsServer_Url;break;default:m=aa.Public_EcsServer_Url}else m=aa.Public_EcsServer_Url;return[this._acsProxy.proxyfyUrl(m)]}_getClientVersion(g){let m="";return m+=g||getPlatformId(),m+="_",m+=getSdkInternalVersion(),m}_getLibConfigType(g){return[g===wm.Default?ef.Models.EcsConfigType.Default:ef.Models.EcsConfigType.User]}_getQueryParameterPromise(g={}){return T.Resolved(g)}}var nf,__decorate$o=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$o=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallStack{constructor(g,m,S,v,C,_,E){if(this._ECS_FETCH_TYPE_USER="User",this._ECS_FETCH_TYPE_DEFAULT="Default",this._disposed=!1,this._trouterStateChangedListenersRegistered=new Map,this.clientId=m,this.sdkDiagnosticInformation=v,this.logger=g.createChild("CallStack"),this._telemetryLogManager=S,this._acsProxy=C,this._acsCustomRelayManager=_,this._webcvProvider=new WebCVProvider,this._wasmvqeProvider=new WasmVqeProvider,"https:"!==location.protocol&&"file:"!==location.protocol&&"localhost"!==location.hostname)throw new CallingCommunicationError({defaultError:D.CALL_STACK.BAD_PROTOCOL});this._telemetryService=new TelemetryService(this._telemetryLogManager),this._ecsProvider=new EcsProvider(this.logger,this.sdkDiagnosticInformation,this._acsProxy),this._ecsFetcher=new EcsConfigFetcher(this.logger,this._acsProxy),this._videoEffectsStatusManager=new VideoEffectsStatusManager,this._audioEffectsStatusManager=new AudioEffectsStatusManager,void 0!==E&&(this._encodedStreamsWorkerProvider=new EncodedStreamsWorkerProvider(E))}getClientId(){return this.clientId}getTrouterState(){const g=this?._trouterService?.state();return this.mapTsTrouterState(g)}getEcsConfigIds(){return this._ecsProvider.getConfigIds()}isRegistered(){return this._trouterService?.isRegistered()??!1}onRegisteredChanged(g){this._trouterService?.onRegisteredChanged(g)}offRegisteredChanged(g){this._trouterService?.offRegisteredChanged(g)}onTrouterStateChanged(g){const tsTrouterStateChangedListener=(m,S)=>{g(this.mapTsTrouterState(m))};return this._trouterService?.onStateChanged(tsTrouterStateChangedListener),this._trouterStateChangedListenersRegistered.set(g,tsTrouterStateChangedListener),{listener:g,tsTrouterStateChangedListener:tsTrouterStateChangedListener}}offTrouterStateChanged(g){const m=this._trouterStateChangedListenersRegistered.get(g);if(m)return this._trouterService?.offStateChanged(m),this._trouterStateChangedListenersRegistered.delete(g),{listener:g,tsTrouterStateChangedListener:m}}mapTsTrouterState(g){let m="Uninitialized";if(void 0!==g)switch(g){case 0:m="Unknown";break;case 2:m="Connected";break;case 3:m="Disconnected";break;case 9:m="Switching"}return m}get webcvProvider(){return this._webcvProvider}get wasmvqeProvider(){return this._wasmvqeProvider}get videoEffectsStatusManager(){return this._videoEffectsStatusManager}get audioEffectsStatusManager(){return this._audioEffectsStatusManager}async createStackBase(g){if(this._createStackBaseWaitPromise)return this._createStackBaseWaitPromise;const m=new Promise((async(m,S)=>{try{const S=this._getBaseStackConfig();this._tsStack=await M.pluginlessStackFactory.buildBaseStack(S),await this.initializeEcsBase(g),m(this._tsStack)}catch(g){S(g)}}));try{this._createStackBaseWaitPromise=wait((()=>m),ya);const g=await this._createStackBaseWaitPromise;return this.logger.log("Base stack init success"),g}catch(g){throw await this.dispose(),g.code===N?new CallingCommunicationError({defaultError:D.CALL_STACK.BASE_STACK_INIT_TIMEOUT}):new CallingCommunicationError({defaultError:D.CALL_STACK.BASE_STACK_INIT_FAILED,originalError:g})}}async initializeStackForUser(g,m){if(this.caConfigBag=m,this._initializeStackForUserWaitPromise)return this._initializeStackForUserWaitPromise;this._tsStack=await this.createStackBase(m),this._disposed=!1;const S=new Promise((async(S,v)=>{try{this._tsStack?(this._telemetryService=new TelemetryService(this._telemetryLogManager),this._ecsProvider=new EcsProvider(this.logger,this.sdkDiagnosticInformation,this._acsProxy),this._ecsFetcher=new EcsConfigFetcher(this.logger,this._acsProxy),await this.initializeEcsBase(m),await this.initializeEcsForUser(g),DefaultLogger.overrideDefaultLogDump(),getAcsEcsConfig().calling.doNotWaitForTrouter?this._initTrouter(g).catch((()=>{this.logger.warn(D.CALL_STACK.SIGNALING_UNINITIALIZED.message)})):await this._initTrouter(g),this.logger.log("Signaling initialized successfully."),await this._tsStack.initializeMediaAgent({httpRequestDispatcher:this.getRequestDispatcher(),tokenProvider:g,relayManager:this.getCustomRelayManager(),configProvider:{getSkypeConfig:()=>Promise.resolve({}),getRelayConfig:()=>{const g=this._ecsProvider.getMdnTrapSettings();return Promise.resolve(g)}},appStateProvider:this._getAppStateProvider(),clientInformation:this._ecsProvider.getJsCsaConfig().clientInformation}),await this._tsStack.initializeSignalingAgentProvider({signalingAgentConfig:this._getSignalingConfig(g),trouterService:this._trouterService}),await this._tsStack.init(),S(this._tsStack)):(this.logger.error("Base stack failed to create"),v(new CallingCommunicationError({defaultError:D.CALL_STACK.BASE_STACK_CREATE_FAILED})))}catch(g){v(g)}}));try{this._initializeStackForUserWaitPromise=wait((()=>S),Ea);const g=await this._initializeStackForUserWaitPromise;return this.sendStackInitEvent(!0),this.logger.log("User stack init success"),g}catch(g){if(await this.dispose(),g.code===N)throw this.sendStackInitEvent(!1,"User stack init timeout",g),new CallingCommunicationError({defaultError:D.CALL_STACK.USER_STACK_INIT_TIMEOUT});if("Uninitialized"===this.getTrouterState())throw new CallingCommunicationError({defaultError:D.CALL_STACK.SIGNALING_UNINITIALIZED});throw this.sendStackInitEvent(!1,"User stack init failed",g),new CallingCommunicationError({defaultError:D.CALL_STACK.USER_STACK_INIT_FAILED,originalError:g})}}getRequestDispatcher(){return this._acsProxy.hasProxyUrl()?(this.logger.info("Using custom proxy for network requests (non media)"),new HttpRequestDispatcher(this.logger,this._acsProxy)):new M.HttpRequestDispatcherImplementation}async initializeEcsBase(g){const m=defer(),S=this.getEcsQueryParameters(g),v=generateGuid(),C=g?this._ECS_FETCH_TYPE_USER:this._ECS_FETCH_TYPE_DEFAULT,_=new EcsConfigObj(wm.Default,g,S,(S=>{if(S?.Headers?.CountryCode&&this.updateEmergencyCallCountry(S?.Headers?.CountryCode),m.resolve(),this._ecsFetcher.getConfigType()===wm.User&&this._ecsSetupCompleteForUser.resolve(),this._ecsFetcher&&this._tsStack&&void 0!==S){let m;const _=+new Date;try{return setAcsEcsConfig(S),this._ecsProvider.setConfig(g,S),setMediaConfig(this._ecsProvider.getJamaSettings()),m=JSON.stringify(S),this._tsStack.getEcsProvider().setEcsConfig({ecsBlob:m,userIdentity:"",etag:this._ecsFetcher.getETag()}),this._ecsProvider.assertConfigs(S),!0}catch(g){const m=+new Date;this.sendEcsSettingsFetchedDataEvent(Ah.acs_calling_config_fetched_failure,{deltaTimeInMs:m-_},C,v,this._ecsProvider.getConfigIds(),new CallingCommunicationError({defaultError:D.CALL_STACK.PARSE_CONFIG,originalError:g})),this.logger.error("Unable to parse configuration")}}return!1}),getPlatformId()),E=+new Date;try{await this._ecsFetcher.subscribeEcsConfig(_),this.sendEcsSettingsFetchedDataEvent(Ah.acs_calling_config_fetched_attempt,{attemptTimestamp:E},C,v);const g=wait((()=>m.promise),io);await g;const S=+new Date;this.sendEcsSettingsFetchedDataEvent(Ah.acs_calling_config_fetched_success,{deltaTimeInMs:S-E},C,v,this._ecsProvider.getConfigIds())}catch(m){const S=new CallingCommunicationError({defaultError:D.CALL_STACK.PARSE_CONFIG,originalError:m}),_=+new Date;this.sendEcsSettingsFetchedDataEvent(Ah.acs_calling_config_fetched_failure,{deltaTimeInMs:_-E},C,v,this._ecsProvider.getConfigIds(),S),this.logger.warn("Failed to fetch base settings. Stack will initialize without default settings",m),this._ecsProvider.setConfig(g,void 0)}}async initializeEcsForUser(g){const m=await g();this._ecsSetupCompleteForUser=defer();try{await this._ecsFetcher.setConfigsToFetch([wm.User]),await this._ecsFetcher.setSkypeToken(m,1e3*parseJWT(m).exp)}catch(g){throw this.logger.error("Unable to set skype token for user ecs config"),new CallingCommunicationError({defaultError:D.CALL_STACK.SET_STACK_CONFIG})}const S=generateGuid(),v=this.caConfigBag?"User":"Default",C=+new Date;try{this.sendEcsSettingsFetchedDataEvent(Ah.acs_calling_config_fetched_attempt,{attemptTimestamp:C},v,S);const g=wait((()=>this._ecsSetupCompleteForUser.promise),io);await g;const m=+new Date;this.sendEcsSettingsFetchedDataEvent(Ah.acs_calling_config_fetched_success,{deltaTimeInMs:m-C},v,S,this._ecsProvider.getConfigIds())}catch(g){const m=+new Date;this.sendEcsSettingsFetchedDataEvent(Ah.acs_calling_config_fetched_failure,{deltaTimeInMs:m-C},v,S,this._ecsProvider.getConfigIds(),g),this.logger.warn("Failed to fetch user settings. Stack will initialize without user settings",g)}}async getDeviceManager(){if(!this._createStackBaseWaitPromise)throw new CallingCommunicationError({defaultError:D.CALL_STACK.GET_DM});return(await this._createStackBaseWaitPromise).getDeviceManager()}async dispose(g){if(!this._disposed){if(this._disposed=!0,this._trouterService)try{this._trouterService.clearMessageHandlers(),this._trouterService.stop(g),this._trouterService=void 0}catch(g){this.logger.error("Failed to dispose signaling")}if(this._tsStack)try{await this._tsStack.dispose(),this._tsStack=void 0}catch(g){this.logger.error("Failed to dispose calling stack")}this._ecsFetcher.dispose(),this._createStackBaseWaitPromise=void 0,this._initializeStackForUserWaitPromise=void 0,this._tsStack=void 0,this.logger.info("Calling stack disposed")}}getEcsQueryParameters(g){const m={};try{m.CLRelease=M.getVersion();const S=getBrowserInfo();m.BrowserName=S.name,m.BrowserEngine=S.engine,m.BrowserVersion=S.version,m.FormFactor=S.formFactor,m.IdentityType=la.Consumer,m.Cloud=ta.Public,m.OSVer=`${getOS()}-${getOSVersion()}`,g&&(m.Cloud=g.cloudType,m.IdentityType=g.identityType);const v="_TS_BUILC_VERSION_".replace("C","D");m.CLRelease===v?m.CLRelease="9999.99":m.CLRelease.match(/^\d+\.\d+\.\d+\.\d+$/)||delete m.CLRelease}catch(g){throw this.logger.error(g),new CallingCommunicationError({defaultError:D.CALL_STACK.SET_STACK_PARAMS,originalError:g})}return m}sendEcsSettingsFetchedDataEvent(g,m,S,v,C,_){let E,T;_&&(E=_.message,T=extractCommunicationServicesErrorForTelemetry(_)),this._telemetryLogManager.sendEvent({name:g,tenant:Qa,properties:{...m,ecsFetchType:S,correlationId:v,failureReason:E,ecsConfigIds_AcsCallingSDKWeb:C?.AcsCallingSDKWeb||"",ecsConfigIds_SkypeWebMedia:C?.SkypeWebMedia||"",additionalDetails:{...T}}})}updateEmergencyCallCountry(g){this.caConfigBag&&!this.caConfigBag.emergencyCountryCode&&!this.caConfigBag.IsUserEmergencyCountryCode&&g&&(this.caConfigBag.emergencyCountryCode=g)}async _initTrouter(g){let m=+new Date;try{this._trouterService=new Trouter(this.logger,this._ecsProvider,(m=>g(m)),this._telemetryLogManager,this._acsProxy),m=+new Date;let S=await this._trouterService.start();return void this.sendSignalingInitEvent(!0,+new Date-m,S.trouterRequestCompletionTimeDeltaMs,S.registrarRequestCompletionTimeDeltaMs)}catch(g){throw this.sendSignalingInitEvent(!1,+new Date-m,void 0,void 0,g),g}}_getBaseStackConfig(){const g=this._getMediaProviderConfig(),m={clientInformation:this._ecsProvider.getClientInformation(),logger:this.logger,mediaSettings:g.mediaSettings,platformType:getPlatformName(),callSettings:{useLwjForAllCalls:!1},usePlatformSupportApi:!0,telemetryTenants:{media:"mediaAgent",signaling:"signalingAgent",tlePlayer:vo},telemetryService:this._telemetryService,webcvProvider:this._webcvProvider,wasmVqeProvider:this._wasmvqeProvider};return void 0!==this._encodedStreamsWorkerProvider&&(m.encodedStreamsWorkerProvider=this._encodedStreamsWorkerProvider),m}_getSignalingConfig(g){const m={...this._ecsProvider.getJsCsaConfig(),httpRequestDispatcher:this.getRequestDispatcher(),telemetryManager:this._telemetryService.getCallingAdapter(),logger:this.logger,skypeToken:()=>g(),trouterServiceProvider:this._trouterService,ecsEtag:this._ecsFetcher.getETag()};return this.caConfigBag?.emergencyCountryCode&&(m.emergencyCallCountry=this.caConfigBag?.emergencyCountryCode),m}_getMediaProviderConfig(){return{logger:this.logger,mediaSettings:this._getMediaAgentConfig()}}_getMediaAgentConfig(){return{...this._ecsProvider.getJamaSettings()}}_getAppStateProvider(){return{isOnline:()=>!0}}sendStackInitEvent(g,m,S){try{let v,C;S&&(v=S.message,C=extractCommunicationServicesErrorForTelemetry(S)),this._telemetryLogManager.sendEvent({name:Ah.acs_calling_stack_init,tenant:Qa,properties:{success:g,reason:m,failureReason:v||"unknown",additionalDetails:{...C}}})}catch(g){}}sendSignalingInitEvent(g,m,S,v,C){try{let _,E;C&&(_=C.message,E=extractCommunicationServicesErrorForTelemetry(C)),this._telemetryLogManager.sendEvent({name:Ah.acs_calling_signaling_init,tenant:Qa,properties:{success:g,failureReason:_||"unknown",timestampInfo:{deltaTimeInMs:m,deltaTimeInMsTrouterRequest:S,deltaTimeInMsRegistrarRequest:v},additionalDetails:{...E}}})}catch(g){}}getCustomRelayManager(){if(this._tsCustomRelayManager=this._acsCustomRelayManager.getTsRelayManager(),this._tsCustomRelayManager&&getAcsEcsConfig().calling.enableCustomTurnUsage)return this.logger.info("Using custom relays for media traffic"),this._acsCustomRelayManager.customRelayManagerInUse=!0,this._tsCustomRelayManager}}__decorate$o([loggerProperty,__metadata$o("design:type",Object)],CallStack.prototype,"logger",void 0),__decorate$o([asyncOperation(qh.CreateStackBase),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Object]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"createStackBase",null),__decorate$o([asyncOperation(qh.InitializeStackForUser),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Function,Object]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"initializeStackForUser",null),__decorate$o([asyncOperation(qh.InitializeEcsBase),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Object]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"initializeEcsBase",null),__decorate$o([asyncOperation(qh.InitializeEcsForUser),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Function]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"initializeEcsForUser",null),__decorate$o([asyncOperation(qh.GetDeviceManager),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"getDeviceManager",null),__decorate$o([asyncOperation(qh.Dispose),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Boolean]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"dispose",null);class ObservableSubjects{constructor(){this._eventEmitter=new Su.EventEmitter}notifyAll(g){this._eventEmitter.emit(g)}waitFor(g,m){return new Promise(((S,v)=>{let C=0;const listener=()=>{S(),clearTimeout(C)};this._eventEmitter.once(g,listener),C=window.setTimeout((()=>{this._eventEmitter.off(g,listener),v(new Error("timeout"))}),m)}))}}class DeviceInfoMapper{constructor(){this._deviceIdMapping=new Map,this._deviceId=1,this._keywords=getAcsEcsConfig().telemetry.deviceChangedEvents.piiSafeWords}getDeviceId(g){let m=this._deviceIdMapping.get(g);if(void 0!==m)return m;++this._deviceId;return m=`${g.split(":")[0]??""}:${this._deviceId}`,this._deviceIdMapping.set(g,m),m}scrubDeviceLabel(g){return scrubDeviceLabelPii(g,this._keywords)}}function scrubDeviceLabelPii(g,m){if(!g)return"";if(g.length<3)return g;const S=[],v=g.match(/\(([0-9a-zA-Z]+:[0-9a-zA-Z]+)\)/);v&&S.push(v[1]);try{if(!m?.length)return"no_keywords";{const v=new RegExp(`(${m.join("|")})`,"gi");let C=v.exec(g);for(;C;)S.push(C[1]),C=v.exec(g)}}catch(g){const stringifyError=g=>P.isString(g)?g:g?.message??"";S.push(`Error: ${stringifyError(g)}`)}return 0===S.length?"unknown":S.join(" ")}!function(g){g.deviceSelection="deviceSelection"}(nf||(nf={}));var __decorate$p=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$p=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class DeviceManagerImpl{constructor(g,m,S){this._callStack=m,this._videoDevices=[],this._audioDevices=[],this._tsDeviceTypeToAudioDeviceType={2:"Microphone",3:"Speaker",4:"CompositeAudioDevice"},this.logger=g.createChild("DeviceManager"),this._telemetryLogManager=S,this._eventEmitter=new CallingEventEmitter(this.logger),this._browserInfo=getBrowserInfo(),this._safariVideoPermissionState="unknown",this._combinedDevicePermission=new Map,this._deviceInfoMapper=new DeviceInfoMapper,this._deviceSelectionNotifications=new ObservableSubjects}get telemetryLogManager(){return this._telemetryLogManager}getRawDeviceMediaStream(g){const m=generateGuid(),S=+new Date;if(this.sendRawMediaEvent({eventName:Ah.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"attempt",mediaType:g,timestampInfo:"",additionalDetails:""}),!this._tsDeviceManager?.getRawDeviceMediaStream){const v=new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.GET_MEDIA_STREAM_TRACK});this.logger.error("Failed to get raw device stream track");const C=+new Date;throw this.sendRawMediaEvent({eventName:Ah.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"failure",mediaType:g,timestampInfo:{deltaTimeInMs:C-S},additionalDetails:{failureReason:v.message||"",code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)}}),v}let v;try{v=this._tsDeviceManager?.getRawDeviceMediaStream(g);const C=+new Date;return this.sendRawMediaEvent({eventName:Ah.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"success",mediaType:g,timestampInfo:{deltaTimeInMs:C-S},additionalDetails:""}),v}catch(v){const C=new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.GET_MEDIA_STREAM_DEVICE_UNAVAILABLE,originalError:v});this.logger.error("Failed to get raw device stream track");const _=+new Date;throw this.sendRawMediaEvent({eventName:Ah.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"failure",mediaType:g,timestampInfo:{deltaTimeInMs:_-S},additionalDetails:{failureReason:C.message||"",code:C.code,subCode:C.subCode,...extractCommunicationServicesErrorForTelemetry(C)}}),C}}getClientId(){return this._callStack.getClientId()}async getDeviceManager(){if(this._tsDeviceManager)return this._tsDeviceManager;const g=+new Date;try{this.sendGetDeviceManagerEvent({eventName:Ah.acs_calling_get_device_manager,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),await this._callStack.createStackBase(),this._tsDeviceManager=await this._callStack.getDeviceManager();const m=await this._tsDeviceManager.enumerateDevicesAsync();this.logger.info(`tsDevicesList:${JSON.stringify(m)}`),m.forEach((g=>{if(1===g.kind){const m=g;this._videoDevices.push(new VideoDeviceInfoImpl(m.label,m.id,"UsbCamera",this))}else if(2===g.kind||3===g.kind){const m=g,S=new AudioDeviceInfoImpl(m.label,m.id,m.isSystemDefault,this._tsDeviceTypeToAudioDeviceType[m.kind],this);this._audioDevices.push(S)}}));const S=this._tsDeviceManager.getSelectedDevices();this._selectedMicrophone=this._audioDevices.find((g=>g.id===S.microphone)),this._selectedSpeaker=this._audioDevices.find((g=>g.id===S.speaker)),this._dmDevicesChangedSub=this._tsDeviceManager.on("devicesChanged",(async()=>{try{await this.syncDeviceList(await(this._tsDeviceManager?.enumerateDevicesAsync())),this.checkForSelectedDevicesChanges()}catch(m){this.logger.warn(`Unable to handle devicesChanged, error=${m?.message}, code=${m?.code}`);const S=+new Date;this.sendGetDeviceManagerEvent({eventName:Ah.acs_calling_get_device_manager,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{failureReason:m?.message,code:m?.code,...extractCommunicationServicesErrorForTelemetry(m),context:"devicesChanged"}})}})),getAcsEcsConfig().calling.devicePermissions.getCurrentState&&(this._audioDevicePermission=permissionStateToBool(this._tsDeviceManager?.getPermissionState("microphone"),this.logger),this._videoDevicePermission=permissionStateToBool(this._tsDeviceManager?.getPermissionState("camera"),this.logger)),this.logger.info("Initial permission state audio:",this._audioDevicePermission,"video:",this._videoDevicePermission),this._dmDevicesPermissionChangedSub=this._tsDeviceManager.on("onPermissionStateChanged",this.permissionsChanged.bind(this));const v=+new Date;this.sendGetDeviceManagerEvent({eventName:Ah.acs_calling_get_device_manager,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:v-g},additionalDetails:""})}catch(m){const S=new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.GET_DM,originalError:m});this.logger.error(S.message);const v=+new Date;this.sendGetDeviceManagerEvent({eventName:Ah.acs_calling_get_device_manager,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:v-g},additionalDetails:{failureReason:S.message,code:S.code,...extractCommunicationServicesErrorForTelemetry(S)}})}return this._tsDeviceManager}on(g,m){if("videoDevicesUpdated"!==g&&"audioDevicesUpdated"!==g&&"selectedMicrophoneChanged"!==g&&"selectedSpeakerChanged"!==g)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("videoDevicesUpdated"!==g&&"audioDevicesUpdated"!==g&&"selectedMicrophoneChanged"!==g&&"selectedSpeakerChanged"!==g)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}getTsDeviceManager(){if(!this._tsDeviceManager)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ACCESS_DM});return this._tsDeviceManager}getSafariPermissionState(){return"Safari"===this._browserInfo.engine?this._safariVideoPermissionState:"unknown"}getAcsResourceId(){return this._callStack?.caConfigBag?.acsResourceId}getAudioDevicePermission(){return this._audioDevicePermission}getVideoDevicePermission(){return this._videoDevicePermission}get callStackWebCvProvider(){return this._callStack.webcvProvider}get callStackWasmVqeProvider(){return this._callStack.wasmvqeProvider}get callStackVideoEffectsStatusManager(){return this._callStack.videoEffectsStatusManager}get callStackAudioEffectsStatusManager(){return this._callStack.audioEffectsStatusManager}get deviceInfoMapper(){return this._deviceInfoMapper}getEnvironmentInfoInternal(){return this._environmentInfo||(this._environmentInfo=getEnvironmentInfos()),this._environmentInfo}sendRawMediaEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send raw media telemetry")}}sendGetDeviceManagerEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send get_device_manager telemetry")}}permissionsChanged(g,m){const S=this._audioDevicePermission,v=this._videoDevicePermission;let C,_;getAcsEcsConfig().calling.devicePermissions.getCurrentState?(C=permissionStateToBool(this._tsDeviceManager?.getPermissionState("microphone"),this.logger),_=permissionStateToBool(this._tsDeviceManager?.getPermissionState("camera"),this.logger)):(C=S,_=v),this._audioDevicePermission=C||!!g?.audio,this._videoDevicePermission=_||!!g?.video,m&&(m.audio&&(this._audioDevicePermission=g?.audio??!1),m.video&&(this._videoDevicePermission=g?.video??!1)),S===this._audioDevicePermission&&v===this._videoDevicePermission||(this.logger.info(`permission state changed from audio: ${S}, video: ${v}\n                          to audio: ${this._audioDevicePermission}, video: ${this._videoDevicePermission}`),this._telemetryLogManager.sendEvent({name:Ah.acs_calling_device_permission_changed,tenant:Qa,properties:{previousAudioDevicePermission:this.nullHandler(S),previousVideoDevicePermission:this.nullHandler(v),newAudioDevicePermission:this.nullHandler(this._audioDevicePermission),newVideoDevicePermission:this.nullHandler(this._videoDevicePermission)}}))}checkForSelectedDevicesChanges(){if(this.logger.info("checkForSelectedDevicesChanges"),this._tsDeviceManager){const g=this._tsDeviceManager.getSelectedDevices();g.microphone!==this._selectedMicrophone?.id&&(this._selectedMicrophone=this._audioDevices.find((m=>m.id===g.microphone)),this._eventEmitter.emit("selectedMicrophoneChanged"),void 0!==g.microphone&&this._deviceSelectionNotifications.notifyAll(g.microphone)),g.speaker!==this._selectedSpeaker?.id&&(this._selectedSpeaker=this._audioDevices.find((m=>m.id===g.speaker)),this._eventEmitter.emit("selectedSpeakerChanged"),void 0!==g.speaker&&this._deviceSelectionNotifications.notifyAll(g.speaker))}else this.logger.warn("DeviceManager is undefined, Unable to check selected devices")}isACSDeviceEqualToTSDevice(g,m){return g.id===m.id}async syncDeviceList(g){if(!this._tsDeviceManager)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ACCESS_DM});this.logger.info("syncDeviceList"),void 0===g&&(g=await this._tsDeviceManager.enumerateDevicesAsync());const m=[];let S=[];const v=[];let C=[];g.map((g=>{if(1===g.kind){const S=this._videoDevices.find((m=>this.isACSDeviceEqualToTSDevice(m,g)));if(S)S.setName(g.label),S.setId(g.id),S.setDeviceType("UsbCamera");else{const S=new VideoDeviceInfoImpl(g.label,g.id,"UsbCamera",this);m.push(S),this._videoDevices.push(S)}}else if(2===g.kind||3===g.kind){const m=this._audioDevices.find((m=>this.isACSDeviceEqualToTSDevice(m,g)));if(m){const S=g;m.setName(S.label),m.setId(S.id),m.setIsSystemDefault(S.isSystemDefault),m.setDeviceType(this._tsDeviceTypeToAudioDeviceType[S.kind])}else{const m=new AudioDeviceInfoImpl(g.label,g.id,g.isSystemDefault,this._tsDeviceTypeToAudioDeviceType[g.kind],this);v.push(m),this._audioDevices.push(m)}}}));const calculateRemovedDiffs=m=>{const S=m.filter((m=>!g.find((g=>this.isACSDeviceEqualToTSDevice(m,g)))));return S.map((g=>{m.splice(m.indexOf(g),1)})),S};S=calculateRemovedDiffs(this._videoDevices),C=calculateRemovedDiffs(this._audioDevices),(m.length>0||S.length>0)&&this._eventEmitter.emit("videoDevicesUpdated",{added:m,removed:S}),(v.length>0||C.length>0)&&this._eventEmitter.emit("audioDevicesUpdated",{added:v,removed:C})}get isSpeakerSelectionAvailable(){if(!this._tsDeviceManager)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ACCESS_DM});return this._tsDeviceManager.isAudioOutputSelectionSupported}get selectedMicrophone(){return this._selectedMicrophone}get selectedSpeaker(){return this._selectedSpeaker}async getCameras(){return await this.syncDeviceList(),this._videoDevices}async getMicrophones(){return await this.syncDeviceList(),this._audioDevices.filter((g=>"Microphone"===g.deviceType))}async getSpeakers(){if(this.isSpeakerSelectionAvailable)return await this.syncDeviceList(),this._audioDevices.filter((g=>"Speaker"===g.deviceType));throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.SPEAKER_ENUMERATION_UNSUPPORTED})}async selectMicrophone(g){if(!this._tsDeviceManager)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ACCESS_DM});if(!g||!g.id)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.INVALID_DEVICE});if("microphone:"===g.id)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.DEVICE_NOT_SELECTABLE});if(this.logger.info("selectMicrophone called"),this._selectedMicrophone?.id!==g.id){const m=getAcsEcsConfig().calling.deviceSelectionTimeoutInMs,S=this._deviceSelectionNotifications.waitFor(g.id,m),v="Microphone",C=this._deviceInfoMapper.getDeviceId(g.id),_=this._deviceInfoMapper.scrubDeviceLabel(g.name),E=generateGuid(),sendEvent=(g,m,S)=>{this.sendDeviceSelectionEvent({eventName:Ah.acs_calling_client_operations,operation:nf.deviceSelection,kindOfEvent:g,correlationId:E,timestampInfo:void 0!==m?{deltaTimeInMs:m}:{},additionalDetails:void 0!==S?{failureReason:S.message,code:S.code,...extractCommunicationServicesErrorForTelemetry(S)}:"",deviceSelection:{deviceId:C,deviceName:_,deviceType:v}})};sendEvent("attempt");const T=Date.now();try{this._tsDeviceManager.selectDevices({microphone:g.id}),await S.catch((m=>{if(this._selectedMicrophone?.id!==g.id)throw m})),sendEvent("success",Date.now()-T)}catch(g){let m;throw m=new CallingCommunicationError("timeout"===g?.message?{defaultError:D.DEVICE_MANAGER.SELECT_MICROPHONE_TIMEOUT}:{defaultError:D.DEVICE_MANAGER.SELECT_MICROPHONE_FAIL,originalError:g}),sendEvent("failure",Date.now()-T,m),m}}else this.logger.warn("microphoneDevice is already active")}async selectSpeaker(g){const m=this.logger.createFnLogger(Wh.SelectSpeaker);if(!this._tsDeviceManager)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ACCESS_DM});if(!this.isSpeakerSelectionAvailable)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.SPEAKER_SELECTION_UNSUPPORTED});if(!g||!g.id)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.INVALID_DEVICE});if("speaker:"===g.id)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.DEVICE_NOT_SELECTABLE});if(m.info("selectSpeaker called"),this._selectedSpeaker?.id!==g.id){const m=getAcsEcsConfig().calling.deviceSelectionTimeoutInMs,S=this._deviceSelectionNotifications.waitFor(g.id,m),v="Speaker",C=this._deviceInfoMapper.getDeviceId(g.id),_=this._deviceInfoMapper.scrubDeviceLabel(g.name),E=generateGuid(),sendEvent=(g,m,S)=>{this.sendDeviceSelectionEvent({eventName:Ah.acs_calling_client_operations,operation:nf.deviceSelection,kindOfEvent:g,correlationId:E,timestampInfo:void 0!==m?{deltaTimeInMs:m}:{},additionalDetails:void 0!==S?{failureReason:S.message,code:S.code,...extractCommunicationServicesErrorForTelemetry(S)}:"",deviceSelection:{deviceId:C,deviceName:_,deviceType:v}})};sendEvent("attempt");const T=Date.now();try{this._tsDeviceManager.selectDevices({speaker:g.id}),await S.catch((m=>{if(this._selectedSpeaker?.id!==g.id)throw m})),sendEvent("success",Date.now()-T)}catch(g){let m;throw m=new CallingCommunicationError("timeout"===g?.message?{defaultError:D.DEVICE_MANAGER.SELECT_SPEAKER_TIMEOUT}:{defaultError:D.DEVICE_MANAGER.SELECT_SPEAKER_FAIL,originalError:g}),sendEvent("failure",Date.now()-T,m),m}}else m.warn("device is already selected")}async askDevicePermission(g){const m={audio:!!g.audio,video:!!g.video};if(!g.audio&&!g.video)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ONE_PERMISSION_ATLEAST});const S=this.getKeyForConstrains(m);let v=this._combinedDevicePermission.get(S);return v?this.logger.info(`askDevicePermission attempt: audio:${m.audio}, video:${m.video} on pending existing request ${getPrintableObject(v)}`):(v=this.askDevicePermissionInternal(m),this._combinedDevicePermission.set(S,v),v.finally((()=>{this._combinedDevicePermission.delete(S)}))),v}getKeyForConstrains(g){return Object.keys(g).filter((m=>g[m])).toString()}async askDevicePermissionInternal(g){this.logger.info(`askDevicePermission attempt: audio:${g.audio}, video:${g.video}`);const m=generateGuid(),S=+new Date;this.sendAudioVideoPermissionEvent({eventName:Ah.acs_calling_adp_attempt,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video});try{if(!this._tsDeviceManager)throw new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ACCESS_DM});const v=[];if(getAcsEcsConfig().calling.devicePermissions.splitAskAudioVideo){this.logger.info("askDevicePermission, split permission check");const m=[];if(g.audio&&(this.logger.info("askDevicePermission, split permission audio"),m.push(this._tsDeviceManager.askDevicePermission({audio:g.audio,video:!1}))),g.video){const askDevicePermissionVideoWithDelay=async m=>new Promise(((S,v)=>{const askDevicePermissionVideo=async()=>{if(this.logger.info("askDevicePermission, split permission video"),!this._tsDeviceManager){const g="askDevicePermission, split permission video failed device manager not found";return this.logger.error(g),void v(g)}try{const m=await this._tsDeviceManager.askDevicePermission({audio:!1,video:g.video});S(m)}catch(g){v(g)}};m?window.setTimeout(askDevicePermissionVideo,m):askDevicePermissionVideo()}));m.push(askDevicePermissionVideoWithDelay(getAcsEcsConfig().calling.devicePermissions.timeoutInBetween))}const S=await Promise.allSettled(m);let C={audio:!1,video:!1};S.forEach((g=>{"fulfilled"===g.status&&g?.value&&(C={audio:C.audio||!!g?.value?.audio,video:C.video||!!g?.value?.video}),"rejected"===g.status&&g?.reason&&v.push(g.reason)})),this.permissionsChanged(C,g),this._safariVideoPermissionState=this._videoDevicePermission?"granted":"denied"}else{const m=await this._tsDeviceManager.askDevicePermission({audio:g.audio,video:g.video});this.permissionsChanged(m,g)}if(g?.audio&&!this._audioDevicePermission||g?.video&&!this._videoDevicePermission)this.sendAudioVideoPermissionEvent({eventName:Ah.acs_calling_adp_failure,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission},new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.PERMISSION_NOT_GRANTED_OR_FAILED,defaultErrorMessageArgs:[getPrintableObject(v)]}));else{const v=+new Date;this.sendAudioVideoPermissionEvent({eventName:Ah.acs_calling_adp_success,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission,deltaTimeInMs:v-S})}}catch(v){const C=new CallingCommunicationError({defaultError:D.DEVICE_MANAGER.ADP_FAIL,originalError:v}),_=+new Date;this.sendAudioVideoPermissionEvent({eventName:Ah.acs_calling_adp_failure,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission,deltaTimeInMs:_-S},C)}return{audio:!!this._audioDevicePermission,video:!!this._videoDevicePermission}}sendAudioVideoPermissionEvent(g,m){try{let S,v,C;m&&(S="string"==typeof m?.message?m?.message:void 0,v=extractCommunicationServicesErrorForTelemetry(m)),g.deltaTimeInMs&&(C=g.deltaTimeInMs>25e3),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:{audioPermissionGranted:this.nullHandler(g.audioPermissionGranted),videoPermissionGranted:this.nullHandler(g.videoPermissionGranted),audioPermissionRequested:g.audioPermissionRequested,videoPermissionRequested:g.videoPermissionRequested,correlationId:g.correlationId||"",failureReason:S||"",deltaTimeInMs:g.deltaTimeInMs||"",deltaTimeGreaterThanJAMATimeout:this.nullHandler(C),additionalDetails:{...v}}})}catch(g){this.logger.debug("Unable to send audio video permission failure success telemtery")}}sendDeviceSelectionEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send device selection telemetry")}}nullHandler(g){return void 0===g?"":g}dispose(){this._dmDevicesChangedSub&&this._dmDevicesChangedSub.dispose(),this._dmDevicesPermissionChangedSub&&this._dmDevicesPermissionChangedSub.dispose(),this._dmDevicesPermissionChangedSub=void 0,this._dmDevicesChangedSub=void 0}}__decorate$p([loggerProperty,__metadata$p("design:type",Object)],DeviceManagerImpl.prototype,"logger",void 0),__decorate$p([asyncOperation(Wh.GetDeviceManager),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getDeviceManager",null),__decorate$p([asyncOperation(Wh.GetCameras),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getCameras",null),__decorate$p([asyncOperation(Wh.GetMicrophones),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getMicrophones",null),__decorate$p([syncOperation(Wh.GetSpeakers),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getSpeakers",null),__decorate$p([asyncOperation(Wh.SelectMicrophone),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[Object]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"selectMicrophone",null),__decorate$p([asyncOperation(Wh.SelectSpeaker),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[Object]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"selectSpeaker",null),__decorate$p([asyncOperation(Wh.AskDevicePermission),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[Object]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"askDevicePermission",null);var __decorate$q=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$q=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class TeamsIncomingCallImpl extends IncomingCallCommonImpl{get info(){return this._teamsCall.info}constructor(m){super(m,g.IncomingCallKind.TeamsIncomingCall),this._teamsCall=m}async accept(g){if(!isProxyAndCustomTurnAllowed(this._teamsCall.acsProxy,this._teamsCall.acsCustomRelayManager,!0))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});return await this._teamsCall.accept(g),this._teamsCall}}__decorate$q([asyncOperation($h.Accept),__metadata$q("design:type",Function),__metadata$q("design:paramtypes",[Object]),__metadata$q("design:returntype",Promise)],TeamsIncomingCallImpl.prototype,"accept",null);class TeamsCallInfoImpl extends CallInfoCommonImpl{constructor(g){super(g)}}var __decorate$r=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$r=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class TeamsCallImpl extends CallCommonImpl{get info(){return this._info}constructor(m,S,v,C){super(m,S,v,C,g.CallKind.TeamsCall),this._isEmergencyCall=!1,this._musicOnHoldEnabled=!1,this._info=new TeamsCallInfoImpl(v),this._info.initialize(this._eventEmitter,this.logger,this._telemetryLogManager),this._mtPolicyService=S.mtPolicyService}async startCallInternal(g,m,S,v,C){if(this._mtPolicyService&&this._mtPolicyService.isFetchUserPoliciesAndSettingsApplicable()){let g="",m=!0;this._isEmergencyCall=!1;try{this.logger.info("Fetching Teams User policy from MiddleTier Service"),await this._mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(this.tsCall.callId,this.tsCall.participantId)}catch(g){m=!1,this.logger.warn(`Fetching Teams user policy from ACS MiddleTier Service failed.\n                    Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}.\n                    Proceeding as normal pstn call`)}if(m){try{this.enforcePolicyAndLicenseRestrictions()}catch(g){return void this.handlePolicyAndLicenseRestrictionsFailure(g)}try{this.logger.info("Deriving emergency content from fetched policies and settings"),g=this._mtPolicyService.getEmergencyContent()}catch(g){this.logger.warn(`Error deriving emergency content from fetched policies and settings. \n                    Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}. Proceeding as normal pstn call`)}v&&(v.emergencyContent=g||"",v.isEmergency=g?.trim().length>0||!1,this._isEmergencyCall=v.isEmergency)}}if(C){let g=[];Array.isArray(C)?g=C:g.push(C),this._isEmergencyCall&&1==g.length&&(this.logger.info(`user dialed number (${g[0].phoneNumber}) resolved to actual emergency number (${this._mtPolicyService.getEmergencyNumber()} during startCall`),g[0]={phoneNumber:this._mtPolicyService.getEmergencyNumber()}),g.forEach((g=>{this.tsCall.addParticipant(getMriFromIdentifier(g)).catch((()=>{this.logger.error("Failed to add participant during call start")}))})),this.logger.info("Paticipant added during startCall")}super.startCallInternal(g,m,S,v)}isEmergencyCallInProgress(){return this._isEmergencyCall}dispose(){super.dispose(),this._extensibleApi.dispose()}addParticipant(g,m){const v=+new Date,C=generateGuid();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.attempt,participantAddedOrRemoved:"add",correlationId:C,timestampInfo:{attemptTimestamp:v}});let _="";try{this.validateThreadId(g,m),_=m.threadId,validateIdentifier(g)}catch(g){const m=new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_INVALID_IDENTIFIER,originalError:g});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}if(!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!0)){const g=new CallingCommunicationError({defaultError:D.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g)}}),g}if(this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))){const m=new CallingCommunicationError({defaultError:D.CALL.PARTICIPANT_ALREADY_IN_CALL,defaultErrorMessageArgs:[S.getIdentifierKind(g).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date},additionalDetails:{code:m.code,failureReason:m.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}const E=this.getOrCreateRemoteParticipant(constructIdentifierKindFromMri(getMriFromIdentifier(g)));if(getAcsEcsConfig().calling.enableSmePassFakeConversation&&(S.isPhoneNumberIdentifier(g)||S.isCommunicationUserIdentifier(g)||"communicationUser"===E.identifier.kind))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.ACTION_BLOCKED});return this.tsCall.addParticipant(getMriFromIdentifier(g),{threadId:_}).then((()=>{this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.success,participantAddedOrRemoved:"add",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date}})})).catch((m=>{const{callEndReason:S}=getRemoteParticipantCallEndReason(this,E.tsRemoteParticipant,m);E.callEndReason||E.setCallEndReason(S);const _=extractCallEndReasonForTelemetry(S);this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"add",correlationId:C,timestampInfo:{deltaTimeInMs:v-+new Date},additionalDetails:{code:_?.callEndReason.code,subCode:_?.callEndReason.subCode,failureReason:_?.callEndReason.message,..._}}),this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))&&(this.deleteRemoteParticipant(E),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[E]}))})),E}async removeParticipant(g){const m=+new Date,v=generateGuid();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.attempt,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{attemptTimestamp:m}});try{validateIdentifier(g)}catch(g){const S=new CallingCommunicationError({defaultError:D.IDENTIFIER.PARSE_INVALID_IDENTIFIER,originalError:g});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:m-+new Date},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(S)}}),S}let C=this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));if(!C){const C=new CallingCommunicationError({defaultError:D.CALL.PARTICIPANT_NOT_IN_CALL,originalError:[S.getIdentifierKind(g).kind]});throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:+new Date-m},additionalDetails:{code:C.code,subCode:C.subCode,failureReason:C.message,...extractCommunicationServicesErrorForTelemetry(C)}}),C}try{await this.tsCall.removeParticipant(getMriFromIdentifier(g)),this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.success,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:m-+new Date}})}catch(g){const{callEndReason:S}=getRemoteParticipantCallEndReason(this,C.tsRemoteParticipant,g);C.callEndReason||C.setCallEndReason(S);const _=extractCallEndReasonForTelemetry(S);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Rh.failure,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:m-+new Date},additionalDetails:{code:_?.callEndReason.code,subCode:_?.callEndReason.subCode,failureReason:_?.callEndReason.message,..._}}),new CallingCommunicationError({defaultError:{message:S.message,code:S.code,subCode:S.subCode||0,resultCategories:S.resultCategories},originalError:g})}}async mute(){super.mute()}async unmute(){super.unmute()}async hold(){if(4===this.tsCall.state)return void this.logger.info("Call already on hold");if(!getAcsEcsConfig().calling.musicOnHoldEnabled)return this.logger.warn("Music on Hold is not enabled"),super.hold();this._musicOnHoldEnabled=!1;const g=+new Date,m=generateGuid();this._causeId=M.generateCauseId(),this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Hold,kindOfEvent:Rh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:au.MusicOnHold}});try{this.logger.info("Fetching Teams Calling Policy from Azure Communication Services"),await this._mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(this.tsCall.callId,this.tsCall.participantId,{policyUrlSuffix:getAcsEcsConfig().MiddleTier.policyUrlSuffixV2,userPolicies:["TeamsCallingPolicy"]}),this._musicOnHoldEnabled=this._mtPolicyService.isMoHEnabled()}catch(g){this.logger.warn(`Fetching Teams Calling Policy from Azure Communication Services failed.\n                Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}.`)}return this._musicOnHoldEnabled?await this.tsCall.hold(void 0,this._causeId,{isLocal:!0},1).then((async()=>{this.logger.info("Successfully detached devices as part of Hold"),await this.tsCall.park(3,this._causeId).then((()=>{const S=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Hold,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{holdType:au.MusicOnHold}}),this.logger.info("Successful park() as part of hold, Music on Hold completed successfully")}))})).catch((()=>{const S=+new Date,v=new CallingCommunicationError({defaultError:D.CALL.HOLD_CALL});throw this.logger.warn(`Attempting to perform Music on Hold failed.\n                    Error message = ${v.message}, code = ${v.code}, subcode = ${v.subCode}`),this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Hold,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,holdType:au.MusicOnHold,...extractCommunicationServicesErrorForTelemetry(v)}}),v})):(this.logger.info("Fetching  of Teams Calling Policy failed or Music on Hold Disabled, proceeding with standard hold"),super.hold())}async resume(){if(this._musicOnHoldEnabled){const g=+new Date,m=generateGuid();return this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Resume,kindOfEvent:Rh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:au.MusicOnHold}}),await this.tsCall.unpark(3,this._causeId).then((async()=>{this.logger.info("Successful unpark() as part of resume"),await this.tsCall.unhold(void 0,this._causeId).then((()=>{const S=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Resume,kindOfEvent:Rh.success,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{holdType:au.MusicOnHold}}),this.logger.info("Successful unhold() as part of resume, resume completed successfully")}))})).catch((()=>{const S=+new Date,v=new CallingCommunicationError({defaultError:D.CALL.RESUME_CALL});throw this.logger.warn(`Attempting to perform resume from Music on Hold failed.\n                    Error message = ${v.message}, code = ${v.code}, subcode = ${v.subCode}`),this.sendCallOnHoldAndResumedEvent({eventName:Ah.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:$h.Resume,kindOfEvent:Rh.failure,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,holdType:au.MusicOnHold,...extractCommunicationServicesErrorForTelemetry(v)}}),v}))}return this.logger.info("Music on Hold Disabled, proceeding with standard resume"),super.resume()}validateThreadId(g,m){if(!m?.threadId)throw new CallingCommunicationError({defaultError:D.CALL.CTE_ADDPARTICIPANT_NO_THREAD_ID})}enforcePolicyAndLicenseRestrictions(){const g=+new Date;if(!this._mtPolicyService.isEvEnabled()){const m=+new Date,S=new CallingCommunicationError({defaultError:D.CALL.CTE_VOICE_NOT_ENABLED});this.logger.error(`Error Message = ${S.message}, code = ${S.code}, subcode = ${S.subCode}`);const v=this._callAgent.getEcsConfigIds();throw this.sendCallStageEvent({eventName:Ah.acs_calling_call_failed,correlationId:generateGuid(),timestampInfo:{deltaTimeInMs:m-g},additionalPayload:{additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:v.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:v.SkypeWebMedia},additionalDetails:{...extractCommunicationServicesErrorForTelemetry(S)}}},S,{code:S.code,subCode:S.subCode,phrase:S.message}),S}}handlePolicyAndLicenseRestrictionsFailure(g){this._callEndReason={message:"Unknown",code:g?.code,subCode:g?.subCode,resultCategories:g?.resultCategories},this._state="Disconnected",this._eventEmitter.emit("stateChanged"),this._callAgent.handleCallRemoved(this.tsCall)}}__decorate$r([validateEmergencyCallOperation($h.AddParticipant),syncOperation($h.AddParticipant),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[Object,Object]),__metadata$r("design:returntype",Object)],TeamsCallImpl.prototype,"addParticipant",null),__decorate$r([validateEmergencyCallOperation($h.RemoveParticipant),asyncOperation($h.RemoveParticipant),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[Object]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"removeParticipant",null),__decorate$r([validateEmergencyCallOperation($h.Mute),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"mute",null),__decorate$r([validateEmergencyCallOperation($h.Unmute),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"unmute",null),__decorate$r([validateEmergencyCallOperation($h.Hold),asyncOperation($h.Hold),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"hold",null),__decorate$r([validateEmergencyCallOperation($h.Resume),asyncOperation($h.Resume),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"resume",null);var __decorate$s=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$s=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};const rf=new Map;class TeamsCallAgentImpl extends CallAgentCommonImpl{get calls(){return this._calls}constructor(m,S,v,C,_,E){super(m,S,C,_,v,g.CallAgentKind.TeamsCallAgent,E),this._calls=[],this.handleCallAdded=g=>{if(!this._calls.find((m=>m.id===g.callId))){const m=g.on("callStateChanged",(()=>{if(1===g.state){const S=g.callId;m.dispose();const v=new TeamsCallImpl({callId:S,isIncoming:!0},this,g,this._telemetryLogManager),C=new TeamsIncomingCallImpl(v);this.handleCallState(v),v.bindTsCall(),this._eventEmitter.emit("incomingCall",{incomingCall:C})}}))}},this.handleCallRemoved=g=>{this.logger.info(`removing callId=${g.callId}`);const m=this._calls.find((m=>m.id===g.callId));if(m){const g=this._calls.indexOf(m);-1!==g&&this._calls.splice(g,1),m.dispose(),this.trackCallEndTimeToStopTelemetry(this._calls),this._eventEmitter.emit("callsUpdated",{added:[],removed:[m]}),this.logger.info("call removed")}},this.handleCallState=g=>{g.on("stateChanged",(()=>{try{if("Disconnected"===g.state){this.tsStack?(this._tsCallRegistry.deleteCall(g.tsCall)||this.logger.error(`Failed to remove call from registry, call id: ${g.id}`),g.stats.flushEvents(),this._telemetryLogManager.flushAllEvents(g.id).catch((()=>{this.logger.error("Failed to flush telemetry log manager events")}))):this.logger.info("Unable to remove call from registry")}else"Connecting"===g.state&&"Incoming"==g.direction&&(this.addToCallArray(g),this._eventEmitter.emit("callsUpdated",{added:[g],removed:[]}))}catch(g){this.logger.error("Failed to handle call state changed event")}}))},this.logger=S}createNewCall(g,m){return new TeamsCallImpl({callId:g},this,m,this._telemetryLogManager)}addToCallArray(g){this._calls.push(g),this.trackCallEndTimeToStopTelemetry(this._calls)}addToCallAgentsMap(g){rf.get(g?.identityMri)&&logErrorAndThrow(D.CALL_AGENT.TEAMS_CALLAGENT_ALREADY_EXSISTS,this.logger),rf.set(g?.identityMri,this)}removeFromCallAgentsMap(g){g?.identityMri&&rf.get(g?.identityMri)===this&&rf.delete(g?.identityMri)}getMiddleTierServiceInstance(){return this.mtPolicyService}async setUserPoliciesOnAgentInitialization(){try{if(this.isCteUser()){this.mtPolicyService.initialize({localParticipant:this.getUserMri(),skypeToken:this._parsedTokenCredential.jwtToken,telemetryLogManager:this._telemetryLogManager});const g=generateGuid();this.logger.info(`ACS MiddleTier service called on Teams Call Agent initialization with call Id=${g}`),await this.mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(g,this.getUserMri(),{policyUrlSuffix:getAcsEcsConfig().MiddleTier.policyUrlSuffixV2,userPolicies:["EmergencyPolicies","TeamsCallingPolicy","TeamsMeetingPolicy"],userProperties:["FeatureTypes","PoliciesMetadata","phoneNumber","sipUri","hostType","accountEnabled","useTeamsCalling","evEnabled","region","routingType","preferredDataLocation","featureTypes"]}),this._userPolicies=this.mtPolicyService.getUserPolicy(),this.logger.info(`****User policy initialized to ${JSON.stringify(this._userPolicies)}`)}}catch(g){this.logger.warn(`Fetching Teams user policy from ACS MiddleTier Service failed.\n            Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}.`)}}startCall(g,m){let S;if(this.assertParticipants(g),this.isCteUser()&&Array.isArray(g)){if(S=m,g.length>1&&!S?.threadId)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.GROUPCALL_THREADID});if(1==g.length&&S?.threadId)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.ONE_TO_ONE_THREADID})}else S=m;this.mtPolicyService.isFetchUserPoliciesAndSettingsApplicable(this.isCteUser(),g)&&this.mtPolicyService.initialize({localParticipant:this.getUserMri(),pstnNumber:Array.isArray(g)?g[0].phoneNumber:g.phoneNumber,skypeToken:this._parsedTokenCredential.jwtToken,telemetryLogManager:this._telemetryLogManager});let v=S?.audioOptions?.muted;return void 0===v&&(v=!1),this.logger.info(`startCall with video=${!!S?.videoOptions},muted=${v}`),this.createCall({participants:g,startCallOptions:S})}join(g,m){this.assertCallContext(g);const S=!!m?.audioOptions?.muted;return this.logger.info(`join with video=${!!m?.videoOptions},muted=${S}`),this.createCall({teamsCallContext:g,startCallOptions:m})}async dispose(){if(this._disposed)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.CTE_ALREADY_DISPOSED});this._disposed=!0,this._abortController.abort(),this._extensibleApi.dispose(),this._parsedTokenCredential?.identityMri&&rf.delete(this._parsedTokenCredential?.identityMri);try{const g=this._tokenFetchTries>this._maxNmberOfRetries;await(this._callStack?.dispose(g))}catch(g){this.logger.error("Call Agent failed to dispose to Call Stack")}this.offTrouterStateChanged(this._trouterStateChangeCallback),this._callStack.offRegisteredChanged(this._registrarStateChangeCallback),delete this._callStack,this._telemetryLogManager.clearTelemetryLoggers(),this.onDisposedCallback&&this.onDisposedCallback()}on(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.EVENT_SUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.on(g,m)}off(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError({defaultError:D.CALL_AGENT.EVENT_UNSUBSCRIBE,defaultErrorMessageArgs:[g]});this._eventEmitter.off(g,m)}createCall(g){let m,S,v,C=g?.teamsCallContext?.threadId;const _=g?.teamsCallContext?.meetingLink,E=g?.teamsCallContext?.meetingId,T=g?.teamsCallContext?.passcode||"",I=!!g?.participants&&(Array.isArray(g?.participants)&&g?.participants.length>1);if(this.isCteUser()&&I&&(C=(g?.startCallOptions).threadId),!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!0))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN});if(_&&(S=parseMeetingUrl(_)),g?.teamsCallContext?.threadId&&g?.teamsCallContext?.organizerId&&g?.teamsCallContext?.tenantId&&(S={threadId:g?.teamsCallContext?.threadId,messageId:g?.teamsCallContext?.messageId?g?.teamsCallContext?.messageId.toString():"0",organizerId:g?.teamsCallContext?.organizerId,tenantId:g?.teamsCallContext?.tenantId}),S&&(v={meetingType:"0"===S.messageId?1:2,tenantId:S.tenantId,organizerId:S.organizerId,replyChainMessageId:S.messageId}||void 0,C=S.threadId,m=S.messageId),this.tsStack){const S=M.generateCauseId(),_=generateGuid(),I=generateGuid();let b;b=E?this._tsCallRegistry.createCallWithMeetingData({meetingCode:E,passcode:T,threadId:C},_,I,S):this._tsCallRegistry.createCall(C||"",_,I,m,S);const A=new TeamsCallImpl({callId:_},this,b,this._telemetryLogManager);this.addToCallArray(A),this.handleCallState(A);const R={threadId:C||"",messageId:m||"",meetingInfo:v,mediaPeerType:2};return A.startCallInternal(g?.startCallOptions,!!E,g?.teamsCallContext,R,g?.participants).catch(noop),A.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[A],removed:[]}),A}throw new CallingCommunicationError({defaultError:D.CALL_AGENT.STACK_NOT_INIT})}assertParticipants(g){assertIsObject(g,D.CALL_AGENT.USERIDS_MUST_BE_OBJECTS),assertNotNull(g,D.CALL_AGENT.USERIDS_CANNOT_BE_NULL)}assertCallContext(g){if(!g||this.checkForAtLeastOneValidCallConfig(g)||this.checkForInvalidTeamsMeetingCoordinates(g))throw new CallingCommunicationError({defaultError:D.CALL_AGENT.INVALID_CALL_CONFIG})}checkForAtLeastOneValidCallConfig(g){return!g.threadId&&!g.meetingLink&&!g.meetingId}checkForInvalidTeamsMeetingCoordinates(g){return!g.threadId&&g.tenantId&&g.organizerId||g.threadId&&(g.organizerId&&!g.tenantId||!g.organizerId&&g.tenantId)}}__decorate$s([syncOperation(Hh.StartCall),__metadata$s("design:type",Function),__metadata$s("design:paramtypes",[Object,Object]),__metadata$s("design:returntype",Object)],TeamsCallAgentImpl.prototype,"startCall",null),__decorate$s([syncOperation(Hh.Join),__metadata$s("design:type",Function),__metadata$s("design:paramtypes",[Object,Object]),__metadata$s("design:returntype",Object)],TeamsCallAgentImpl.prototype,"join",null),__decorate$s([asyncOperation(Hh.Dispose),__metadata$s("design:type",Function),__metadata$s("design:paramtypes",[]),__metadata$s("design:returntype",Promise)],TeamsCallAgentImpl.prototype,"dispose",null);class AcsProxy{constructor(){this._proxyInUse=!1;const g=m.createClientLogger("ACS-calling");this.logger=new DefaultLogger(g,[()=>"AcsProxy"])}get proxyInUse(){return this._proxyInUse}set proxyInUse(g){this._proxyInUse=g}get proxyUrl(){return this._proxyUrl?.toString()||""}set proxyUrl(g){if(g.length<4)throw new CallingCommunicationError({defaultError:D.CALL_CLIENT.PROXY_SHORT_URL});"/"!==g.slice(-1)&&(g=g.concat("","/"));try{const m=new URL(g);if("https:"!==m.protocol&&"http:"!==m.protocol)throw new CallingCommunicationError({defaultError:D.CALL_CLIENT.PROXY_PROTOCOL});this._proxyUrl=m}catch(g){const m=new CallingCommunicationError({defaultError:D.CALL_CLIENT.SETUP_PROXY,defaultErrorMessageArgs:[JSON.stringify(g)],originalError:g});throw this.logger.error(m.message),m}}hasProxyUrl(){return!!this._proxyUrl}proxyfyUrl(g){let m=g;if(!this._proxyUrl)return this.logger.info(`Proxy url not defined, return original ${m}`),m;try{const g=new URL(m);m=`${`${g.protocol}//${this._proxyUrl.host}${this._proxyUrl.pathname}`}${g.host}${g.pathname}${g.search}`,this.logger.info(`Proxyfing url from ${g} to ${m}`)}catch(g){const m=`Failed proxyfy url with error: ${JSON.stringify(g)}, returning original`;this.logger.error(m)}return this._proxyInUse=!0,m}}class AcsCustomRelayManager{constructor(){this._hasCustomRelay=!1,this._customRelayManagerInUse=!1;const g=m.createClientLogger("ACS-calling");this._logger=new DefaultLogger(g,[()=>"AcsCustomRelayManager"])}getRelayConfig(){return this._relayConfig}setRelayConfig(g){this._relayConfig={...g},this._logger.info("Custom relay config provided"),this._hasCustomRelay=!0,this._createTsRelayManager()}get hasRelayConfig(){return this._hasCustomRelay}get customRelayManagerInUse(){return this._customRelayManagerInUse}set customRelayManagerInUse(g){this._customRelayManagerInUse=g}getTsRelayManager(){return this._tsRelayManager}_createTsRelayManager(){if(!this._hasCustomRelay||!this._relayConfig||this._relayConfig.iceServers.length<1)return void this._logger.warn("No relay config provided. No op.");const g=[];this._relayConfig.iceServers.forEach((m=>{m.urls.forEach((S=>{const v=this._getIndividualRelay(S,m?.username,m?.credential);g.push(v)}))})),this._tsRelayManager={initialize(){},queryRelaysAsync:m=>Promise.resolve(g)}}_getIndividualRelay(g,m,S){const v=3478,C=[],_=[],E=[du.turn,du.turns,du.stun],T=[hu.tcp,hu.tls,hu.udp];let I;try{I=new URL(g)}catch(g){throw new CallingCommunicationError({defaultError:D.CALL_CLIENT.RELAY_INFO,defaultErrorMessageArgs:[JSON.stringify(g)],originalError:g})}const b=I.protocol.replace(":","");if(!E.includes(b))throw new CallingCommunicationError({defaultError:D.CALL_CLIENT.RELAY_UNRECOGNIZED_SCHEMA});let A;try{const g=I.href.replace(/((turn)s?|stun):/,"https:");A=new URL(g)}catch(g){throw new CallingCommunicationError({defaultError:D.CALL_CLIENT.RELAY_INFO,defaultErrorMessageArgs:[JSON.stringify(g)],originalError:g})}let R=A.searchParams.get("transport")??"";T.includes(R)||(this._logger.warn(`Unknown transport protocol detected for the provided turn, defaulting to ${hu.udp}`),R=hu.udp);let P=""===A.port?this._extractPortFromUrl(I):Number(A.port);P||(this._logger.warn(`Could not read port from relay url, defaulting to ${v}`),P=v);let M=A.hostname;return isIpv4Address(M)?C.push(M):_.push(M),{addresses:C,udpPort:R===hu.udp?P:void 0,tcpPort:R===hu.tcp?P:void 0,tlsPort:R===hu.tls?P:void 0,username:m??"",password:S??"",type:"turn",fqdns:_}}_extractPortFromUrl(g){const m=g.href.match(el)?.[0];return Number(m?.replace(":",""))}}var sf,__decorate$t=function(g,m,S,v){var C,_=arguments.length,E=_<3?m:null===v?v=Object.getOwnPropertyDescriptor(m,S):v;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)E=Reflect.decorate(g,m,S,v);else for(var T=g.length-1;T>=0;T--)(C=g[T])&&(E=(_<3?C(E):_>3?C(m,S,E):C(m,S))||E);return _>3&&E&&Object.defineProperty(m,S,E),E},__metadata$t=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let af=1;class CallClient{get callAgent(){return this._callAgent}get teamsCallAgent(){return this._teamsCallAgent}get sdkDiagnosticInformation(){return this._sdkDiagnosticInformation}get telemetryLogManager(){return this._telemetryLogManager}setCallAgent(g){this._callAgent=g}setTeamsCallAgent(g){this._teamsCallAgent=g}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}constructor(g){this._customProxyAndTurnInformation={proxy:null,turn:null},this.sendTelemetry=()=>{try{if(getAcsEcsConfig().telemetry.telemetryBeforeUnload&&this._callAgent&&this._callAgent._calls)for(const g of this._callAgent._calls){g.tsCall.sendLastKnownStats()}}catch(g){this.logger.debug("Error logging telemetry",g)}},this.handleVisibilityChange=()=>{"hidden"===document.visibilityState?(this.logger.debug("Visibility changed to hidden"),this.sendPageVisibilityInfoEvent("visibilityChange",!0),this.hangupCalls()):(this.logger.debug("Visibility changed to visible"),this.sendPageVisibilityInfoEvent("visibilityChange",!1))},this.handlePageShow=()=>{this.logger.debug("Page show"),this.sendPageVisibilityInfoEvent("pageShow",!0)},this.handlePageHide=()=>{this.logger.debug("Page hide"),this.sendPageVisibilityInfoEvent("pageHide",!1)},this.handleOrientationChange=()=>{this.logger.debug(`Orientation changed to ${screen.orientation.type}`),this.sendOrientationChangeEvent(screen.orientation.type)},this.getOrientationBasedOnWindowSize=()=>window.innerHeight>window.innerWidth?"portrait-primary":"landscape-primary",this.handleResize=()=>{const g=this.getOrientationBasedOnWindowSize();this._previousOrientation!==g&&(this._previousOrientation=g,this.sendOrientationChangeEvent(g))};const S=+new Date;this.clientId=generateGuid();const v=g?.logger||m.createClientLogger("ACS-calling"),C=af++;if(this._acsProxy=new AcsProxy,this._acsCustomRelayManager=new AcsCustomRelayManager,g?.networkConfiguration){g.networkConfiguration.proxy?.url&&(this._customProxyAndTurnInformation.proxy={...g.networkConfiguration.proxy},this._acsProxy.proxyUrl=this._customProxyAndTurnInformation.proxy.url),g.networkConfiguration.turn&&(this._customProxyAndTurnInformation.turn={...g.networkConfiguration.turn},this._acsCustomRelayManager.setRelayConfig(this._customProxyAndTurnInformation.turn));const m=this.getTelemetryTag();g.diagnostics?g.diagnostics.tags?g.diagnostics.tags.push(m):g.diagnostics.tags=[m]:g.diagnostics={tags:[m]}}this.logger=new DefaultLogger(v,[()=>`CallClient${C}`]),this._eventEmitter=new CallingEventEmitter(this.logger),this._sdkDiagnosticInformation=buildCallingUserAgent(getSdkVersion(),this.logger,g),this.diagnosticOptions=g?.diagnostics,this.firstPartyOptions=g?.firstPartyOptions,this._telemetryLogManager=new TelemetryLogManager(this.logger,this._sdkDiagnosticInformation,this._acsProxy,this._acsCustomRelayManager);try{this.sendCallClientInitEvent({eventName:Ah.acs_calling_call_client_init,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),Object.defineProperty(globalThis,To,{value:C,writable:!0,enumerable:!1}),1===C&&Object.defineProperty(globalThis,Eo,{value:this._telemetryLogManager,writable:!1,enumerable:!1}),this.logger.info("created"),this._callStack=new CallStack(this.logger,this.clientId,this._telemetryLogManager,this._sdkDiagnosticInformation,this._acsProxy,this._acsCustomRelayManager,this.firstPartyOptions?.encodedStreamsJsPath),this._deviceManager=new DeviceManagerImpl(this.logger,this._callStack,this._telemetryLogManager),this._previousOrientation="",this.sendInitialOrientation(),window.addEventListener("beforeunload",this.sendTelemetry),window.addEventListener("visibilitychange",this.handleVisibilityChange,!1),window.addEventListener("pageshow",this.handlePageShow,!1),window.addEventListener("pagehide",this.handlePageHide,!1),screen.orientation?screen.orientation.addEventListener("change",this.handleOrientationChange):window.addEventListener("resize",this.handleResize,!1),this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{callClient:this},{callClient:this,telemetryLogManager:this._telemetryLogManager});const g=getRegisteredFeatures(Cu.CallClientFeature);for(const m of g)"OnExtendedObjectConstructor"===m.activationOptions.activationEvent&&this.feature(m);this.sendCallClientInitEvent({eventName:Ah.acs_calling_call_client_init,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-S},additionalDetails:""})}catch(g){const m=new CallingCommunicationError({defaultError:D.CALL_CLIENT.INIT_CALL_CLIENT,originalError:g});throw this.sendCallClientInitEvent({eventName:Ah.acs_calling_call_client_init,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-S},additionalDetails:{failureReason:m.message,code:m.code,subCode:m.subCode,...extractCommunicationServicesErrorForTelemetry(m)}}),m}}createInstance(g){return new CallClient(g)}get acsProxy(){return this._acsProxy}get acsCustomRelayManager(){return this._acsCustomRelayManager}getSDKVersion(){return getSdkVersion()}feature(g){return this._extensibleApi.getApiObjectInstance(g.callClientApiCtor)}async createCallAgent(g,m){(this._callAgent||this._teamsCallAgent)&&logErrorAndThrow(D.CALL_CLIENT.ONE_CALL_AGENT_PER_CALL_CLIENT,this.logger),this.validateEmergencyCountryCode(m);try{const onDisposedCallback=()=>{this._callAgent=void 0};return this._callAgent=new CallAgentImpl(this,this.logger,this._callStack,this.clientId,this._telemetryLogManager,this._deviceManager,m),await this._callAgent.initialize(g,onDisposedCallback,m),this._eventEmitter.emit("callAgentCreated"),this._callAgent}catch(g){throw this._callAgent=void 0,new CallingCommunicationError({defaultError:D.CALL_CLIENT.CREATE_CALL_AGENT,originalError:g})}}async createTeamsCallAgent(g,m){(this._callAgent||this._teamsCallAgent)&&logErrorAndThrow(D.CALL_CLIENT.ONE_CALL_AGENT_PER_CALL_CLIENT,this.logger);try{const onDisposedCallback=()=>{this._teamsCallAgent=void 0};return this._teamsCallAgent=new TeamsCallAgentImpl(this,this.logger,this._callStack,this.clientId,this._telemetryLogManager,this._deviceManager),await this._teamsCallAgent.initialize(g,onDisposedCallback,m),this._teamsCallAgent.setUserPoliciesOnAgentInitialization(),this._eventEmitter.emit("teamsCallAgentCreated"),this._teamsCallAgent}catch(g){throw this._teamsCallAgent=void 0,new CallingCommunicationError({defaultError:D.CALL_CLIENT.CREATE_TEAMS_CALL_AGENT,originalError:g})}}async getDeviceManager(){return await this._deviceManager.getDeviceManager(),this._deviceManager}async getEnvironmentInfoInternal(){return this._environmentInfos||(await this._callStack.createStackBase(),this._environmentInfos=getEnvironmentInfos()),this._environmentInfos}validateEmergencyCountryCode(g){g?.emergencyCallOptions?.countryCode&&g.emergencyCallOptions?.countryCode.length>no&&logErrorAndThrow(D.CALL_CLIENT.EMERGENCY_CODE_TOO_LONG,this.logger)}sendOrientationChangeEvent(g,m=!1){if(this._callAgent?._calls?.length)try{this._telemetryLogManager.sendEvent({name:Ah.acs_calling_orientation_changed,tenant:Qa,properties:{orientation:g,isInitial:m}})}catch(g){this.logger.debug("Unable to send orientation change telemetry")}}sendInitialOrientation(){let g=screen.orientation&&screen.orientation.type;g||(g=this.getOrientationBasedOnWindowSize()),this.sendOrientationChangeEvent(g,!0)}sendCallClientInitEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:Qa,properties:g})}catch(g){this.logger.debug("Unable to send CallClient initialized telemetry event")}}hangupCalls(){try{"Mobile"===getBrowserInfo().formFactor&&getAcsEcsConfig().calling.hangUpCallOnPageHide&&this._callAgent?.calls.forEach((g=>g.hangUp()))}catch(g){try{this.logger.error(`Unable to hangup call on page hide due to ${JSON.stringify(g)}`)}catch(g){this.logger.error("Unable to hangup call on page hide due to unknown error")}}}sendPageVisibilityInfoEvent(g,m){if(this._callAgent?._calls?.length)try{this._telemetryLogManager.sendEvent({name:Ah.acs_calling_page_hidden,tenant:Qa,properties:{eventName:g,pageHidden:m}})}catch(g){this.logger.debug("Unable to send page hide telemetry")}}getTelemetryTag(){return this._customProxyAndTurnInformation.proxy&&this._customProxyAndTurnInformation.turn?Jo.usedProxyAndNonMsftTurn:this._customProxyAndTurnInformation.proxy?Jo.onlyUsedProxy:this._customProxyAndTurnInformation.turn?Jo.onlyUsedNonMsftTurn:""}}__decorate$t([loggerProperty,__metadata$t("design:type",Object)],CallClient.prototype,"logger",void 0),__decorate$t([syncOperation(Bh.GetSDKVersion),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[]),__metadata$t("design:returntype",String)],CallClient.prototype,"getSDKVersion",null),__decorate$t([syncOperation(Bh.Feature),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[Object]),__metadata$t("design:returntype","function"==typeof(sf="undefined"!=typeof TFeature&&TFeature)?sf:Object)],CallClient.prototype,"feature",null),__decorate$t([asyncOperation(Bh.CreateCallAgent),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[Object,Object]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"createCallAgent",null),__decorate$t([asyncOperation(Bh.CreateTeamsCallAgent),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[Object,Object]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"createTeamsCallAgent",null),__decorate$t([asyncOperation(Bh.GetDeviceManager),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"getDeviceManager",null),__decorate$t([asyncOperation(Bh.GetEnvironmentInfo),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"getEnvironmentInfoInternal",null),g.CallClient=CallClient,g.Features=pm,g.LocalAudioStream=LocalAudioStream,g.LocalVideoStream=LocalVideoStream,g.VideoStreamRenderer=VideoStreamRenderer,Object.defineProperty(g,"__esModule",{value:!0})}));
